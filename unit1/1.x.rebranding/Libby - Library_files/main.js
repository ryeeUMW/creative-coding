/**
 * @license almond 0.3.3 Copyright jQuery Foundation and other contributors.
 * Released under MIT license, http://github.com/requirejs/almond/LICENSE
 */

/*!
 * PEP v0.4.3 | https://github.com/jquery/PEP
 * Copyright jQuery Foundation and other contributors | http://jquery.org/license
 */

/**
 * @license text 2.0.15 Copyright jQuery Foundation and other contributors.
 * Released under MIT license, http://github.com/requirejs/text/LICENSE
 */

!function(){var requirejs,require,define;!function(e){function t(e,t){return v.call(e,t)}function i(e,t){var i,s,n,r,o,a,l,c,h,u,p,d,m=t&&t.split("/"),f=g.map,b=f&&f["*"]||{};if(e){for(e=e.split("/"),o=e.length-1,g.nodeIdCompat&&_.test(e[o])&&(e[o]=e[o].replace(_,"")),"."===e[0].charAt(0)&&m&&(d=m.slice(0,m.length-1),e=d.concat(e)),h=0;h<e.length;h++)if(p=e[h],"."===p)e.splice(h,1),h-=1;else if(".."===p){if(0===h||1===h&&".."===e[2]||".."===e[h-1])continue;h>0&&(e.splice(h-1,2),h-=2)}e=e.join("/")}if((m||b)&&f){for(i=e.split("/"),h=i.length;h>0;h-=1){if(s=i.slice(0,h).join("/"),m)for(u=m.length;u>0;u-=1)if(n=f[m.slice(0,u).join("/")],n&&(n=n[s])){r=n,a=h;break}if(r)break;!l&&b&&b[s]&&(l=b[s],c=h)}!r&&l&&(r=l,a=c),r&&(i.splice(0,a,r),e=i.join("/"))}return e}function s(t,i){return function(){var s=y.call(arguments,0);return"string"!=typeof s[0]&&1===s.length&&s.push(null),u.apply(e,s.concat([t,i]))}}function n(e){return function(t){return i(t,e)}}function r(e){return function(t){m[e]=t}}function o(i){if(t(f,i)){var s=f[i];delete f[i],b[i]=!0,h.apply(e,s)}if(!t(m,i)&&!t(b,i))throw new Error("No "+i);return m[i]}function a(e){var t,i=e?e.indexOf("!"):-1;return i>-1&&(t=e.substring(0,i),e=e.substring(i+1,e.length)),[t,e]}function l(e){return e?a(e):[]}function c(e){return function(){return g&&g.config&&g.config[e]||{}}}var h,u,p,d,m={},f={},g={},b={},v=Object.prototype.hasOwnProperty,y=[].slice,_=/\.js$/;p=function(e,t){var s,r=a(e),l=r[0],c=t[1];return e=r[1],l&&(l=i(l,c),s=o(l)),l?e=s&&s.normalize?s.normalize(e,n(c)):i(e,c):(e=i(e,c),r=a(e),l=r[0],e=r[1],l&&(s=o(l))),{f:l?l+"!"+e:e,n:e,pr:l,p:s}},d={require:function(e){return s(e)},exports:function(e){var t=m[e];return"undefined"!=typeof t?t:m[e]={}},module:function(e){return{id:e,uri:"",exports:m[e],config:c(e)}}},h=function(i,n,a,c){var h,u,g,v,y,_,w,P=[],A=typeof a;if(c=c||i,_=l(c),"undefined"===A||"function"===A){for(n=!n.length&&a.length?["require","exports","module"]:n,y=0;y<n.length;y+=1)if(v=p(n[y],_),u=v.f,"require"===u)P[y]=d.require(i);else if("exports"===u)P[y]=d.exports(i),w=!0;else if("module"===u)h=P[y]=d.module(i);else if(t(m,u)||t(f,u)||t(b,u))P[y]=o(u);else{if(!v.p)throw new Error(i+" missing "+u);v.p.load(v.n,s(c,!0),r(u),{}),P[y]=m[u]}g=a?a.apply(m[i],P):void 0,i&&(h&&h.exports!==e&&h.exports!==m[i]?m[i]=h.exports:g===e&&w||(m[i]=g))}else i&&(m[i]=a)},requirejs=require=u=function(t,i,s,n,r){if("string"==typeof t)return d[t]?d[t](i):o(p(t,l(i)).f);if(!t.splice){if(g=t,g.deps&&u(g.deps,g.callback),!i)return;i.splice?(t=i,i=s,s=null):t=e}return i=i||function(){},"function"==typeof s&&(s=n,n=r),n?h(e,t,i,s):setTimeout(function(){h(e,t,i,s)},4),u},u.config=function(e){return u(e)},requirejs._defined=m,define=function(e,i,s){if("string"!=typeof e)throw new Error("See almond README: incorrect module build, no module name");i.splice||(s=i,i=[]),t(m,e)||t(f,e)||(f[e]=[e,i,s])},define.amd={jQuery:!0}}(),define("ext/requirejs/almond",function(){}),define("common/src/_",["require"],function(e){return{}}),define("common/src/object",["require","./_"],function(e){var t=e("./_");return t.try=function(e,i){var s=[],n=Array.prototype.slice.call(arguments,2);for(t.each(i.split(/[\.\[\]]+/),function(e){e&&s.push(e)});s.length;){if(!e)return e;var r=s.shift();if("()"==r.substr(-2)){var o=r.slice(0,-2);if("function"!=typeof e[o])return;var a=t.isList(n[0])?n.shift():void 0;a||(a=n.splice(0)),e=e[o].apply(e,a)}else e=r.match(/^\d+$/)?e[parseFloat(r)]:e[r]}return e},t.absorb=function(e,i){return"string"==typeof e?console.warn('[C] absorbing from string? "%s"',e):"string"==typeof i?console.warn('[C] absorbing into string? "%s"',i):i||(console.warn("[C] absorbing into nothing?",e),i={}),t.each(e,function(e,t){i[e]=t}),i},t.clone=function(e){try{return JSON.parse(JSON.stringify(e))}catch(i){return t.absorb(e,{})}},t.mixin=function(e,i){return i.__SHADOWS={},t.each(e,function(e,t){"undefined"!=typeof i[e]&&(i.__SHADOWS[e]=i[e]),i[e]=t}),i},t.unmix=function(e,i){return t.each(e,function(e){i[e]=i.__SHADOWS[e],delete i.__SHADOWS[e]}),i},t.isNullish=function(e){return null===e||"undefined"==typeof e},t}),define("common/src/iterable",["require","./_"],function(e){var t=e("./_");return t.each=function(e,i,s){try{if(!e)return;if(t.isList(e))Array.prototype.forEach.call(e,i,s);else if("function"==typeof e.forEach){var n=0;e.forEach(function(e,t){"undefined"==typeof t?i.call(s,e,n++):i.call(s,t,e,n++)})}else{var r=[];try{r=Object.getOwnPropertyNames(e)}catch(e){}t.each(r,function(t,n){i.call(s,t,e[t],n,r)})}}catch(e){if(e!==t.BreakException)throw console.warn("[ITERABLE] re-throwing exception",e.message),console.warn(e.stack),e}},t.select=function(e,i,s){var n=[];return t.each(e,function(){var e=i.apply(s,arguments);"undefined"!=typeof e&&n.push(e)},s),n},t.breakIteration=function(){throw t.BreakException},t.BreakException=new Error("Break out of iteration loop"),t.excise=function(e,i){if(t.isArray(e)){for(var s=[],n=0;n<e.length;)e[n]===i?s=s.concat(e.splice(n,1)):n+=1;return 1==s.length?s[0]:s}var r=e[i];return delete e[i],r},t.flatten=function(e,i){return i=i||[],t.isList(e)?t.each(e,function(e){t.flatten(e,i)}):i.push(e),i},t.unique=function(e){for(var t=[],i=0,s=e.length;i<s;++i)t.indexOf(e[i])<0&&t.push(e[i]);return t},t.compact=function(e){for(var t=[],i=0,s=e.length;i<s;++i){var n=e[i];void 0!==n&&null!==n&&t.push(n)}return t},t.last=function(e){return e[e.length-1]},t.shuffle=function(e){for(var t,i,s=e.length;0!==s;)t=Math.floor(Math.random()*s),s-=1,i=e[s],e[s]=e[t],e[t]=i;return e},t.invertObject=function(e){var t={};for(var i in e)e.hasOwnProperty(i)&&(t[e[i]]=i);return t},t.isArray=function(e){return Array.isArray?Array.isArray(e):"[object Array]"==Object.prototype.toString.call(e)},t.isList=function(e){if(t.isArray(e))return!0;var i=Object.prototype.toString.call(e);return!!i.match(/^\[object (HTMLCollection|NodeList)]$/)},t.isEmpty=function(e){if(t.isList(e))return!e.length;var i=!0;return t.each(e,function(e,s){i=!1,t.breakIteration()}),i},t.among=function(e,i){return t.isArray(i)||(i=Array.prototype.slice.call(arguments,1)),i.indexOf(e)>=0},t}),define("common/src/arithmetic",["require","./_"],function(e){var t=e("./_");return t.smoothFloat=function(e,t){var i=Math.pow(10,t||5);return Math.round(e*i)/i},t}),define("common/src/time",["require","./_"],function(e){var t=e("./_");return t.deltaMilliseconds=function(){return window.performance?performance.now():t.epochMilliseconds()},t.epochMilliseconds=function(){return(new Date).getTime()},t.epochSeconds=function(){return Math.floor(t.epochMilliseconds()/1e3)},t.secondsToUnits=function(e){for(var t=[{label:"seconds",mod:60},{label:"minutes",mod:60},{label:"hours",mod:24},{label:"days",mod:7},{label:"weeks",mod:52}],i={},s=e,n=0,r=t.length;n<r;++n){var o=s%t[n].mod;i[t[n].label]=o,s=(s-o)/t[n].mod}return i.years=s,i},t.timestampToUnits=function(e){var t=new Date,i=new Date(e),s={hours:i.getHours(),minutes:i.getMinutes(),date:i.getDate(),month:i.getMonth(),year:i.getFullYear()},n="Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" ");return s.monthName=n[s.month],t.getFullYear()==s.year&&(s.thisYear=!0),t>i&&t-i<31536e6&&(s.thisPastYear=!0),t.getMonth()==s.month&&s.thisYear&&(s.thisMonth=!0),t.getDate()==s.date&&s.thisMonth&&s.thisYear&&(s.thisDay=!0),s},t.timestampAsMS=function(e){if("number"==typeof e)return e>0&&e<99999999999?1e3*e:e},t}),define("common/src/uuid",["require","./_"],function(e){function t(e){var t=16*Math.random()|0,i="x"==e?t:3&t|8;return i.toString(16)}var i=e("./_");return i.generateUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t)},i}),define("common/src/href",["require","./_"],function(e){var t=e("./_");return t.absoluteURL=function(e,t){t=t||document;var i=t.createElement("a");i.setAttribute("href",e);var s=i.href;return s.match(/%/)?s:encodeURI(s)},t.relativeURL=function(e){return e.replace(/^[^\:]+:\/\/[^\/]+/,"")},t.resolvePath=function(e){for(var t=e.split("/"),i=1;i<t.length;)"."==t[i]?t.splice(i,1):".."==t[i]&&i>0&&".."!=t[i-1]&&(t.splice(i-1,2),i-=2),i+=1;return t.join("/")},t.expandPath=function(e,i){var s=i.split("/");return s.pop(),t.resolvePath(s.join("/")+"/"+e)},t.parameterizeURL=function(e,t){var i=[];for(var s in t){var n=t[s];if("undefined"!=typeof n&&null!==n&&""!==n){n=n instanceof Array?n:[n];for(var r=0,o=n.length;r<o;++r){var a=n[r];i.push(encodeURIComponent(s)+"="+encodeURIComponent(a))}}}return e=e.replace(/#.*/,""),i.length&&(e+=e.match(/\?/)?"&":"?",e+=i.join("&")),e},t.queryStringToObject=function(e){e=e.replace(/^\?/,""),e=e.replace(/#.*/,""),e=e.replace(/=/g,'":"'),e=e.replace(/&/g,'","');var t=function(e,t){return""===e?t:decodeURIComponent(t)};try{return JSON.parse('{ "'+e+'" }',t)}catch(e){}},t}),define("common/src/string",["require","./_"],function(e){var t=e("./_");return t.safe=function(e){if(t.isNullish(e))return"";var i=document.createElement("div");return i.appendChild(document.createTextNode(e)),i.innerHTML},t.decodeEntitiesInString=function(e){var t=document.createElement("div");return t.innerHTML=e,t.firstChild.nodeValue},t.base64EncodeSafely=function(e){return btoa(e.replace(/[^\x00-\x7F]/g,escape))},t.regExpEscape=function(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")},t.regExpPunctuation=function(){return"\\u2000-\\u206F\\u2E00-\\u2E7F"+t.regExpEscape("\\'!\"#$%&()*+,-./:;<=>?@[]^_`{|}~")},t.listToSentence=function(e,t){var i=[];if("function"==typeof t)for(var s=0,n=e.length;s<n;++s){var r=t(e[s],s);"undefined"!=typeof r&&i.push(r)}else i=e;return 1==i.length?i[0]:2==i.length?i.join(" and "):i.slice(0,-1).join(", ")+", and&nbsp;"+i[i.length-1]},t.capitalize=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},t.titleize=function(e){var i=["a","an","the","and","but","or","for","nor","as","at","by","for","from","in","into","near","of","on","onto","to"],s=/^\w+[A-Z]/,n=new RegExp("^("+i.join("|")+")*$","i"),r=/^[-–—:.]$/,o=new RegExp("([^\\w\\s]*)(\\w+)","g");return t.capitalize(e.replace(o,function(e,t,i){return t&&!t.match(r)?t+i:i.match(s)?t+i:i.match(n)?t+i.toLowerCase():t+i.charAt(0).toUpperCase()+i.substr(1).toLowerCase()}))},t.camelize=function(e){return e.replace(/([_-]\w)/g,function(e){return e[1].toUpperCase()})},t.snakerize=function(e){return e.replace(/([a-z][A-Z])/g,function(e){return e[0]+"_"+e[1].toLowerCase()})},t.dasherize=function(e){return e.replace(/([A-Z]*)([A-Z\s])([^A-Z]*)/g,function(e,t,i,s,n){return"-"+t.toLowerCase()+(s?"-":"")+i.toLowerCase()+s}).replace(/[0-9]+/g,function(e){return"-"+e}).replace(/\s+/g,"").replace(/^-+/,"").replace(/-+$/,"").replace(/-+/g,"-")},t.hashStringToFloat=function(e){for(var t=5381,i=0,s=e.length;i<s;++i)t=(t<<5)+t+e.charCodeAt(i)&4294967295;return(t>>>0)/4294967295},t}),function(){function e(e){var t=[],i=Math.pow(e+16,3)/1560896;i=i>I?i:e/S;for(var s=0;3>s;){var n=s++,r=C[n][0],o=C[n][1];n=C[n][2];for(var a=0;2>a;){var l=a++,c=(632260*n-126452*o)*i+126452*l;t.push({b:(284517*r-94839*n)*i/c,a:((838422*n+769860*o+731718*r)*e*i-769860*l*e)/c})}}return t}function t(t){t=e(t);for(var i=1/0,s=0;s<t.length;){var n=t[s];++s,i=Math.min(i,Math.abs(n.a)/Math.sqrt(Math.pow(n.b,2)+1))}return i}function i(t,i){i=i/360*Math.PI*2,t=e(t);for(var s=1/0,n=0;n<t.length;){var r=t[n];++n,r=r.a/(Math.sin(i)-r.b*Math.cos(i)),0<=r&&(s=Math.min(s,r))}return s}function s(e,t){for(var i=0,s=0,n=e.length;s<n;){var r=s++;i+=e[r]*t[r]}return i}function n(e){return.0031308>=e?12.92*e:1.055*Math.pow(e,.4166666666666667)-.055}function r(e){return.04045<e?Math.pow((e+.055)/1.055,2.4):e/12.92}function o(e){return[n(s(C[0],e)),n(s(C[1],e)),n(s(C[2],e))]}function a(e){return e=[r(e[0]),r(e[1]),r(e[2])],[s(k[0],e),s(k[1],e),s(k[2],e)]}function l(e){var t=e[0],i=e[1];return e=t+15*i+3*e[2],0!=e?(t=4*t/e,e=9*i/e):e=t=NaN,i=i<=I?i/L*S:116*Math.pow(i/L,.3333333333333333)-16,0==i?[0,0,0]:[i,13*i*(t-x),13*i*(e-T)]}function c(e){var t=e[0];if(0==t)return[0,0,0];var i=e[1]/(13*t)+x;return e=e[2]/(13*t)+T,t=8>=t?L*t/S:L*Math.pow((t+16)/116,3),i=0-9*t*i/((i-4)*e-i*e),[i,t,(9*t-15*e*t-e*i)/(3*e)]}function h(e){var t=e[0],i=e[1],s=e[2];return e=Math.sqrt(i*i+s*s),1e-8>e?i=0:(i=180*Math.atan2(s,i)/Math.PI,0>i&&(i=360+i)),[t,e,i]}function u(e){var t=e[1],i=e[2]/360*2*Math.PI;return[e[0],Math.cos(i)*t,Math.sin(i)*t]}function p(e){var t=e[0],s=e[1];return e=e[2],99.9999999<e?[100,0,t]:1e-8>e?[0,0,t]:(s=i(e,t)/100*s,[e,s,t])}function d(e){var t=e[0],s=e[1];if(e=e[2],99.9999999<t)return[e,0,100];if(1e-8>t)return[e,0,0];var n=i(t,e);return[e,s/n*100,t]}function m(e){var i=e[0],s=e[1];return e=e[2],99.9999999<e?[100,0,i]:1e-8>e?[0,0,i]:(s=t(e)/100*s,[e,s,i])}function f(e){var i=e[0],s=e[1];if(e=e[2],99.9999999<i)return[e,0,100];if(1e-8>i)return[e,0,0];var n=t(i);return[e,s/n*100,i]}function g(e){for(var t="#",i=0;3>i;){var s=i++;s=Math.round(255*e[s]);var n=s%16;t+=E.charAt((s-n)/16|0)+E.charAt(n)}return t}function b(e){e=e.toLowerCase();for(var t=[],i=0;3>i;){var s=i++;t.push((16*E.indexOf(e.charAt(2*s+1))+E.indexOf(e.charAt(2*s+2)))/255)}return t}function v(e){return o(c(u(e)))}function y(e){return h(l(a(e)))}function _(e){return v(p(e))}function w(e){return d(y(e))}function P(e){return v(m(e))}function A(e){return f(y(e))}var C=[[3.240969941904521,-1.537383177570093,-.498610760293],[-.96924363628087,1.87596750150772,.041555057407175],[.055630079696993,-.20397695888897,1.056971514242878]],k=[[.41239079926595,.35758433938387,.18048078840183],[.21263900587151,.71516867876775,.072192315360733],[.019330818715591,.11919477979462,.95053215224966]],L=1,x=.19783000664283,T=.46831999493879,S=903.2962962,I=.0088564516,E="0123456789abcdef";window.hsluv={hsluvToRgb:_,rgbToHsluv:w,hpluvToRgb:P,rgbToHpluv:A,hsluvToHex:function(e){return g(_(e))},hexToHsluv:function(e){return w(b(e))},hpluvToHex:function(e){return g(P(e))},hexToHpluv:function(e){return A(b(e))},lchToHpluv:f,hpluvToLch:m,lchToHsluv:d,hsluvToLch:p,lchToLuv:u,luvToLch:h,xyzToLuv:l,luvToXyz:c,xyzToRgb:o,rgbToXyz:a,lchToRgb:v,rgbToLch:y}}(),define("hsluv",["hsluv/hsluv-0.1.0.min"],function(e){return e}),define("hsluv/hsluv-0.1.0.min",function(){}),define("common/src/color",["require","./_","hsluv"],function(e){var t=e("./_");e("hsluv");var i=window.hsluv;return delete window.hsluv,t.hexToRGB=function(e){var t=/^#?([A-F\d])([A-F\d])([A-F\d])([A-F\d])?$/i;e=e.replace(t,function(e,t,i,s,n){return"string"!=typeof n&&(n="F"),t+t+i+i+s+s+n+n});var i=/^#?([A-F\d]{2})([A-F\d]{2})([A-F\d]{2})([A-F\d]{2})?$/i.exec(e),s="string"==typeof i[4]?i[4]:"FF";return i?[parseInt(i[1],16),parseInt(i[2],16),parseInt(i[3],16),parseInt(s,16)/255]:null},t.rgbToHex=function(e,t){var i=function(e){var t=parseInt(e,10).toString(16).toUpperCase();return 1==t.length?"0"+t:t},s="#"+i(e[0])+i(e[1])+i(e[2]);if(t&&"number"==typeof e[3]){var n=s+i(255*Math.max(0,Math.min(1,e[3])));return n}return s},t.rgbStringToHex=function(e,i){var s=e.match(/rgba\((\d+),\s?(\d+),\s?(\d+),\s?(([0-9]*[.])?[0-9]+)?\)/)||e.match(/rgb\((\d+),\s?(\d+),\s?(\d+)\)/);if(s)return t.rgbToHex([s[1],s[2],s[3],parseFloat(s[4]||"1")],i)},t.rgbToString=function(e){if(e.length>=4){var t=e.slice(0,4);return"rgba("+t.join(",")+")"}return e=[e[0]||0,e[1]||0,e[2]||0],"rgb("+e.join(",")+")"},t.rgbToHSLA=function(e){var t,i,s=e[0]/255,n=e[1]/255,r=e[2]/255,o=Math.max(s,n,r),a=Math.min(s,n,r),l=(o+a)/2;if(o==a)t=i=0;else{var c=o-a;switch(i=l>.5?c/(2-o-a):c/(o+a),o){case s:t=(n-r)/c+(n<r?6:0);break;case n:t=(r-s)/c+2;break;case r:t=(s-n)/c+4}t/=6}var h=[Math.floor(360*t),Math.floor(100*i),Math.floor(100*l),e[3]||1];return h},t.hslaToRGBA=function(e){var t,i,s,n=e[0]/360,r=e[1]/100,o=e[2]/100;if(0==r)t=i=s=o;else{var a=function(e,t,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?e+6*(t-e)*i:i<.5?t:i<2/3?e+(t-e)*(2/3-i)*6:e},l=o<.5?o*(1+r):o+r-o*r,c=2*o-l;t=a(c,l,n+1/3),i=a(c,l,n),s=a(c,l,n-1/3)}return[Math.round(255*t),Math.round(255*i),Math.round(255*s),e[3]||1]},t.rgbToHSLuv=function(e){var t=i.rgbToHsluv([e[0]/255,e[1]/255,e[2]/255]);return"number"==typeof e[3]&&(t[3]=e[3]),t},t.hsluvToRGB=function(e){var t=i.hsluvToRgb(e),s=function(e){return Math.min(255,Math.max(0,Math.round(255*e)))};return t=[s(t[0]),s(t[1]),s(t[2])],"number"==typeof e[3]&&(t[3]=e[3]),t},t.hsluvToHex=function(e,i){return t.rgbToHex(t.hsluvToRGB(e),i)},t.adjustRGB=function(e,i){var i=i||{},s=t.rgbToHSLuv(e),n=s[2];if("number"==typeof i.shift&&(s[2]>50?i.down=i.shift:i.up=i.shift),"number"==typeof i.shade){var r=i.shade<0?0:100;s[2]=Math.round((r-s[2])*Math.abs(i.shade))+s[2]}if("number"==typeof i.down){var o=i.down/100;s[2]=Math.max(0,s[2]-s[2]*o)}if("number"==typeof i.up){var o=i.up/100;s[2]=Math.min(100,s[2]+(100-s[2])*o)}"number"==typeof i.min&&s[2]<i.min&&(s[2]=i.min),"number"==typeof i.max&&i.max&&s[2]>i.max&&(s[2]=i.max),!i.allowBlooms&&Math.abs(s[2]-n)>5&&(s=t.debloomHSLuv(s,n));var a=t.hsluvToRGB(s);return"number"==typeof e[3]&&(a[3]=e[3]),a},t.debloomHSLuv=function(e,i,s){"number"!=typeof i&&(i=e[2]),s=t.absorb(s,{black:25,white:4});var n=i/s.black;n<1&&(e[1]*=n*n);var r=(100-i)/s.white;return r<1&&(e[1]*=r*r),e},t.colorYIQ=function(e){return(299*e[0]+587*e[1]+114*e[2])/1e3},t}),define("common/src/callback",["require","./_"],function(e){var t=e("./_");return t.MAX_TIMEOUT=2147483647,t.defer=function(e,i,s,n){return"string"==typeof arguments[1]?(e._=e._||{},e._.timers=e._.timers||{},clearTimeout(e._.timers[i]),delete e._.timers[i],"function"==typeof s?e._.timers[i]=t.defer(function(){clearTimeout(e._.timers[i]),delete e._.timers[i],s()},n||0):void 0):(s=null,n=null,t.each(Array.prototype.slice.call(arguments,0),function(e){"function"==typeof e&&null===n?s=e:s&&"number"==typeof e&&(n=e)}),s?setTimeout(s,n||0):void console.trace("[C] unrecognized arguments to defer()",arguments))},t.staggerInvocation=function(e,i,s){var n,r=1/0,o=function(){r=1/0,e()};return s=Math.max(i,s||0),function(e){clearTimeout(n);var a=t.epochMilliseconds();r=Math.min(r,a);var l=e?0:r+s;if(a>=l)o();else{var c=Math.min(i,l-a);n=setTimeout(o,c)}}},t}),define("common/src/dom-factory",["require","./_"],function(e){var t=e("./_");return t.element=function(e){e=e||{},!e.link||e.tag&&"a"!=e.tag||("string"!=typeof e.link?e.link="#":e.link.match(/^#/)||(e.link="/"+e.link.replace(/^\//,"")),e.tag="a",e.attributes=t.absorb(e.attributes,{href:e.link,role:"link"}));var i=document;"object"==typeof e.parentNode&&e.parentNode&&(i=e.parentNode.ownerDocument);var s;return s="svg"==e.tag||"svg"==e.namespace?i.createElementNS("http://www.w3.org/2000/svg",e.tag):i.createElement(e.tag||"div"),t.applyElementOptions(s,e)},t.applyElementOptions=function(e,i){return i?(i.tag&&i.tag.toLowerCase()!==e.tagName.toLowerCase()&&console.warn("[C] cannot change tagName of existing element",i.tag,e),"string"==typeof i.id&&i.id&&(e.id=i.id),"string"==typeof i.className&&i.className?e.setAttribute("class",i.className):"string"==typeof i.classes&&i.classes&&e.setAttribute("class",i.classes),"string"==typeof i.html&&i.html&&(e.innerHTML=i.html),t.each(i.attributes,function(t,i){"undefined"!=typeof i&&null!==i&&e.setAttribute(t,i)}),"object"==typeof i.parentNode&&i.parentNode&&("prepend"==i.pos&&i.parentNode.firstChild?i.parentNode.insertBefore(e,i.parentNode.firstChild):i.parentNode.appendChild(e)),e):e},t.iframe=function(e,i){e=e||{},e.tag="iframe",e.attributes=t.absorb({frameborder:"no",scrolling:e.scrolling||"no",width:e.width||0,height:e.height||0},e.attributes||{});var s=t.element(e);return"function"==typeof i&&this._iframeAddHandler(s,"load",i),"string"==typeof e.src&&s.setAttribute("src",e.src),s},t._iframeAddHandler=function(e,i,s){var n=function(){t._iframeRemoveHandler(e,i,n),s(e)};e._handlers=e._handlers||{},e._handlers[i]=e._handlers[i]||[],e._handlers[i].push(n),e.addEventListener?e.addEventListener(i,n,!1):e.attachEvent&&e.attachEvent("on"+i,n)},t._iframeRemoveHandler=function(e,t,i){e.removeEventListener?e.removeEventListener(t,i,!1):e.detachEvent&&e.detachEvent("on"+t,i)},t._iframeRemoveAllHandlers=function(e,i){if(e._handlers)for(var s in e._handlers)if(!i||s==i)for(var n=e._handlers[s];n&&n.length;)t._iframeRemoveHandler(e,s,n.shift())},t.removeElement=function(e){e&&e.parentNode&&e.parentNode.removeChild(e)},t}),define("common/src/dom-classname",["require","./_"],function(e){var t=e("./_");return t.batonClass=function(e,i,s){s=s||t.try(e,"ownerDocument.documentElement");for(var n=s.querySelectorAll("."+i),r=0,o=n.length;r<o;++r)n[r]!=e&&n[r].classList.remove(i);e&&e.classList.add(i)},t}),define("common/src/dom-css-prefixing",["require","./_"],function(e){var t=e("./_");return t.prefixProperty=function(e,i,s){var n=["-webkit-","-moz-","-ms-",""];if(t.isNullish(s))for(;n.length;)e.removeProperty(n.shift()+i);else for(;n.length;)e.setProperty(n.shift()+i,s)},t}),define("common/src/dom-traversal",["require","./_"],function(e){var t=e("./_");return t.isElement=function(e){try{return e instanceof Element}catch(t){return"object"==typeof e&&"object"==typeof e.style&&"object"==typeof e.ownerDocument&&1===e.nodeType}},t.isInDOM=function(e,t){return(t||document.body).contains(e)},t.elementClosest=function(e,t){if("function"==typeof e.closest)return e.closest(t);for(var i=e;i.parentNode;)i=i.parentNode;for(var s=i.querySelectorAll(t);e&&1===e.nodeType;){for(var n=0,r=s.length;n<r;++n)if(s[n]==e)return e;e=e.parentNode}},t.walk=function(e,i,s){for(var n=[],r=e;r&&(n.push(r),r=r.firstChild||t._nextInWalk(r),!s||r!==s););for(var o=0,a=n.length;o<a;++o)try{i(n[o])}catch(e){if(e!==t.BreakException)throw e;return}},t._nextInWalk=function(e){return e?e.nextSibling||t._nextInWalk(e.parentNode):null},t.getRangeRects=function(e){var i=[],s=e.startOffset,n=t._nextInWalk(e.endContainer);return t.walk(e.startContainer,function(t){if(!t.childNodes.length)try{var n=t.ownerDocument.createRange();n.selectNodeContents(t),s&&(n.setStart(t,s),s=0),n.collapsed?Array.prototype.push.apply(i,n.startContainer.getClientRects()):(t===e.endContainer&&n.setEnd(t,e.endOffset),Array.prototype.push.apply(i,n.getClientRects()))}catch(e){console.warn("[DOM] unexpected result in range:",e)}},n),i.length||i.push(e.getBoundingClientRect()),i},t}),define("common/src/class",["require","./_"],function(e){var t=e("./_"),i=function(){},s=i.prototype,n="__I_AM_METACLASS__";return i.new=function(){var e=function(t){t!==n&&(this._={},this.__class=e,this.$init.apply(this,Array.prototype.slice.call(arguments,0)))};return e.new=this.new,e.prototype=new this(n),e},s.$init=function(){},t.Class=i}),define("common/src/data-class",["require","./_"],function(e){var t=e("./_"),i={};return i.set=function(e,t,i){if(this.get(e,t)!=i){this.clear(e,t);var s="undefined"!=typeof i?"_"+i:"";e.classList.add("data-"+t+s)}},i.get=function(e,t){for(var i=this._pattern(t),s=0,n=e.classList.length;s<n;++s){var r=e.classList[s].match(i);if(r)return r[2]}},i.clear=function(e,t){for(var i=this._pattern(t),s=[],n=0,r=e.classList.length;n<r;++n)e.classList[n].match(i)&&s.push(e.classList[n]);for(;s.length;)e.classList.remove(s.shift())},i.semaphore=function(e){return{set:i.set.bind(i,e),get:i.get.bind(i,e),clear:i.clear.bind(i,e)}},i._pattern=function(e){return new RegExp("^data-"+e+"(_(.*))?$")},t.DataClass=i}),define("common/common",["require","./src/object","./src/iterable","./src/arithmetic","./src/time","./src/uuid","./src/href","./src/string","./src/color","./src/callback","./src/dom-factory","./src/dom-classname","./src/dom-css-prefixing","./src/dom-traversal","./src/class","./src/data-class","./src/_"],function(e){return e("./src/object"),e("./src/iterable"),e("./src/arithmetic"),e("./src/time"),e("./src/uuid"),e("./src/href"),e("./src/string"),e("./src/color"),e("./src/callback"),e("./src/dom-factory"),e("./src/dom-classname"),e("./src/dom-css-prefixing"),e("./src/dom-traversal"),e("./src/class"),e("./src/data-class"),e("./src/_")}),define("common",["common/common"],function(e){return e}),define("app/base/version",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.assign=function(e){return this.value=e,this},s.isOlderThan=function(e){return"string"!=typeof e&&(e=t.try(e,"value")),!!e&&this.compareVersionStrings(e,this.value)>0},s.isNewerThan=function(e){return"string"!=typeof e&&(e=t.try(e,"value")),!!e&&this.compareVersionStrings(this.value,e)>0},s.isSameAs=function(e){return"string"!=typeof e&&(e=t.try(e,"value")),!!e&&0===this.compareVersionStrings(this.value,e)},s.isNotSameAs=function(e){return!this.isSameAs(e)},s.compareVersionStrings=function(e,t){var i=this._versionParts(e),s=this._versionParts(t);return i[0]!=s[0]?i[0]-s[0]:i[1]!=s[1]?i[1]-s[1]:i[2]!=s[2]?i[2]-s[2]:i[3]!=s[3]?i[3]||0===i[3]?(s[3]||0===s[3])&&i[3]>s[3]?1:-1:1:0},s.toJSON=function(){return this.value},s._versionParts=function(e){if(!e)return[0,0,0,0];var t=e.match(/(\d+)\.(\d+)\.(\d+)-?(.*)?/);return t?[parseInt(t[1],10),parseInt(t[2],10),parseInt(t[3],10),t[4]]:(APP.journal.warn("[VERSION] invalid version string:",e),[0,0,0,0])},i}),function(){"use strict";var Quirks=function(e){return!!Quirks._.registry[e]};Quirks.has=Quirks,Quirks.add=function(e){for(var t=[],i=1,s=arguments.length;i<s;++i)t.push(arguments[i]);return this._.registry[e]=this.ask(t)},Quirks.set=function(e,t){"undefined"!=typeof t&&null!==t||(t=!1),t instanceof Array&&(t=t[1]||!0),"function"==typeof t&&(t=t()),this._.survey[e]=t},Quirks.ask=function(){var e=arguments[0];e instanceof Array||(e=Array.prototype.slice.call(arguments,0));for(var t=0,i=e.length;t<i;++t){for(var s=this._tokenize(""+e[t]),n=!0,r=0,o=s.length;r<o;++r){var a=s[r];n=n&&this._evaluate(a[0],a[1],a[2],a[3])}if(n)return!0}return!1},Quirks.dump=function(){var e=[];e.push("Query types:");for(var t in this._.survey)e.push("  "+t+": "+this._.survey[t]);e.push("Quirks:");for(var t in this._.registry)e.push("  "+t+": "+this._.registry[t]);console.log(e.join("\n"))},Quirks._reset=function(){this._={survey:{true:!0,false:!1},registry:{}}},Quirks._tokenize=function(e){for(var t=e.split(/\s+/),i=[],s=0,n=t.length;s<n;++s){var r=t[s].match(/(!?)([^:=<>]+)([:=<>]*)([^:=<>]*)/);r?i.push([r[2],r[3],r[4],r[1]]):console.warn('No match for sequence: "'+e+'"')}return i},Quirks._evaluate=function(key,op,operand,modifier){var val=this._.survey[key],pass;if(op){if("="==op)pass=""+val==""+operand;else if(">="==op)pass=this._operate(val,operand,function(e,t){return e>=t});else if("<="==op)pass=this._operate(val,operand,function(e,t){return e<=t});else if(">"==op)pass=this._operate(val,operand,function(e,t){return e>t});else if("<"==op)pass=this._operate(val,operand,function(e,t){return e<t});else if(":"==op)if("quirk"==key)pass=Quirks(operand);else if("function"==key)try{pass="function"==typeof eval(operand)}catch(e){pass=!1}}else pass="undefined"!=typeof val&&val!==!1;return"undefined"==typeof pass?(console.warn("No test for %s %s %s",key,op,operand),!1):"!"==modifier?!pass:pass},Quirks._operate=function(e,t,i){if(!e||!t)return!1;for(var s=!1,n=e.split("."),r=t.split(".");;){var e=n.shift(),t=r.shift();if("undefined"==typeof e||"undefined"==typeof t)break;if(e.match(/\d+/)&&t.match(/^\d+$/)&&(e=parseFloat(e),t=parseFloat(t)),s=i(e,t),e!==t)break}return s},Quirks._survey=function(e){this._reset(),this.set("kindle3",e.match(/Kindle\/3/)),this.set("nook",e.match(/NOOK/)),this.set("sony-reader",e.match(/Linux;.*EBRD/)),this.set("nintendo",e.match(/NintendoBrowser/)),this.set("webkit",e.match(/WebKit\/([\d\.]+)/)),this.set("gecko",e.match(/Gecko\/([\d\.]+)/)),this.set("trident",e.match(/Trident\/([\d\.]+)/)),this.set("edge",e.match(/Edge\/([\d\.]+)/)),this.set("firefox",e.match(/Firefox\/([\d\.]+)/)),this.set("chrome",e.match(/Chrom(?:e|ium)\/([\d\.]+)/)||e.match(/Cr(?:Mo|iOS)\/([\d\.]+)/)),this.set("blink",this.ask("chrome>=28")),this.set("iexplore",!!this.ask("trident")&&e.match(/(?:rv:|MSIE )([\d\.]+)/)),this.set("safari-build",!!this.ask("!chrome")&&e.match(/Safari\/([\d\.]+)/)),this.set("safari",!!this.ask("safari-build")&&e.match(/Version\/([\d\.]+)/)),this.set("silk",e.match(/Silk/)),this.set("chromeframe",e.match(/chromeframe/)&&window.externalHost);var t=e.match(/Android\s?([\d\.]+)?/);this.set("android",t||this.ask("sony-reader","silk"));var i=e.match(/(OS) ([\d_]+).*AppleWebKit.*Mobile/)||e.match(/(iPhone|iPad|iPod).* OS ([\d_]+)/);this.set("ios",!!i&&i[2].replace(/_/g,".")),this.ask("ios")&&!this.ask("safari")&&this.set("safari",this._.survey.ios),this.set("macosx",!i&&e.match(/Mac OS X/)),this.set("windows",e.match(/Windows/)),this.set("blackberry",e.match(/BlackBerry/)),this.set("mobile",e.match(/mobi|tablet|ip(?:ad|hone|od)|android|silk/i)),this.set("ipad",i&&e.match(/iPad/)),this.set("iphone",i&&e.match(/(iPhone|iPod)/)),this.set("android-chrome",this.ask("android chrome")||t&&e.match(/CrMo/)),this.set("android-stock",this.ask("android !android-chrome !firefox")),this.set("ios-standalone",i&&navigator.standalone),this.set("ios-webview",this.ask("ios !safari !ios-standalone")),this.set("ios-uiwebview",this.ask("ios-standalone")),this.set("eink",this.ask("kindle3","sony-reader"))},Quirks._survey(navigator.userAgent),"function"==typeof define&&define.amd?define("quirkbase/quirkbase",[],function(){return Quirks}):"undefined"!=typeof exports?exports.Quirkbase=Quirks:window.Quirkbase=Quirks}(),define("quirkbase",["quirkbase/quirkbase"],function(e){return e}),define("app/base/quirks",["require","quirkbase"],function(e){var t=e("quirkbase");return t.shellInfo=function(){var e=navigator.userAgent;window.BRIDGE&&(e=window.BRIDGE.userAgent||e);var t={},i=e.match(/\((\w+; V\d+; \w+; .*?)\)/);if(i){var s=function(e){var t=(e||"").match(/^V(\d+)/);return t?parseFloat(t[1]):null},n=i[1].split("; ");t.name=n.shift(),t.spec=s(n.shift()),t.platform=n.shift();var r=n.shift().split("-");t.version=r[0],t.build=r[1],t.mode=n.shift()||"RELEASE"}return t}(),t.add("incompatible","iexplore","chrome<43"),t.set("ms-local-stream",location.origin.match(/^ms-local-stream:/)),t.add("send-nautilus-origin-for-cors","ms-local-stream"),t.add("map-requires-absolute-url","ms-local-stream"),t.set("webgl-unavailable",function(){try{var e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");return!t}catch(e){return!0}}),t.add("cannot-download-files","iOS"==t.shellInfo.platform&&t.shellInfo.build<65),t.add("cellular-access-control-ignores-priority","iOS"==t.shellInfo.platform&&t.shellInfo.build<91),t.add("color-inversion-filter-is-slow","firefox"),t.add("color-inversion-is-rotated","android"),t.add("override-accept-language",!SPARK.locale.isUserAgentDefault||"iOS"==t.shellInfo.platform),t.add("discontinued-uwp","ms-local-stream"),t.add("discontinued-kitkat",navigator.userAgent.match(/Chrome\/30\..*Dewey/)),t.add("discontinued-dst-root","false"),t}),define("shibui/src/illustrator",["require","common"],function(e){var t=e("common"),i=t.Class.new();i.prototype;return i.REGISTRY={},i.add=function(e,t){this.REGISTRY[e]=t},i.graphic=function(e,i){i=t.absorb(i,{});var s=this.REGISTRY[e];if(!s)throw"[SHIBUI] unknown graphic: "+e;s=this.substituteUniqueIds(s);var n=t.element({html:s}),r=n.querySelector("svg");r.parentNode.removeChild(r),i.parentNode&&("prepend"==i.pos&&i.parentNode.firstChild?i.parentNode.insertBefore(r,i.parentNode.firstChild):i.parentNode.appendChild(r));var o=t.flatten([i.classes]).concat(["shibui-graphic"]);return r.setAttribute("class",o.join(" ")),r},i.pattern=function(e,i){i=t.absorb(i,{});var s=this.REGISTRY[e];if(!s)throw"[SHIBUI] unknown graphic: "+e;var n=t.element({html:s});i.color&&(t.each(n.querySelectorAll(".pattern-solid"),function(e){e.style.fill=i.color}),t.each(n.querySelectorAll(".pattern-hollow"),function(e){e.style.stroke=i.color}));var r="data:image/svg+xml;base64,"+btoa(n.innerHTML),o=t.element({parentNode:i.parentNode,classes:"shibui-pattern",pos:"prepend"});return o.style.setProperty("background-image","url("+r+")"),o},i.substituteUniqueIds=function(e){var i={};return e=e.replace(/\bid="([^"]+)"/g,function(e,s){return i[s]=t.generateUUID(),'id="'+i[s]+'"'}),t.each(i,function(t,i){e=e.replace(new RegExp("#"+t,"g"),"#"+i)}),e},i}),define("shibui/src/phrasebook",["require","common"],function(e){
var t=e("common"),i=t.Class.new();i.prototype;return"function"==typeof Intl.__disableRegExpRestore&&Intl.__disableRegExpRestore(),i.LOCALE="en-NONE",i.TEMPLATES={},i.initialize=function(e,i){this.LOCALE=e,this.TEMPLATES=i,document.documentElement.lang=e,t.DataClass.set(document.documentElement,"lang",e)},i.text=function(e,i,s){var n=this.TEMPLATES[this._normalizeLabel(e)];return"string"!=typeof n?t.try(s,"okIfMissing")?void 0:"⩻"+e+"⩼":this._parseTemplate(n,i,s)},i.number=function(e,i){var s=this._toFormatterOptions(i);if(t.excise(s,"nth"))return this.numberToNth(e,s);if("megabytes"==s.unit)return this.numberOfBytesToMegabytes(e);"string"==typeof e&&(e=parseFloat(e));var n=t.excise(s,"_miss");return"number"!=typeof e||isNaN(e)?n||"[?]":this._intl("NumberFormat",s).format(e)},i.numberToNth=function(e,t){if("number"!=typeof e)return"";if(e=e<0?Math.ceil(e):Math.floor(e),!e)return"#0";if(!this._isEnglish())return"#"+e;var i=this.number(e,t),s=i[i.length-1],n=i.length>1&&"1"==i[i.length-2];return"1"!=s||n?"2"!=s||n?"3"!=s||n?i+"th":i+"rd":i+"nd":i+"st"},i.numberOfBytesToMegabytes=function(e){var t=(e||0)/1048576;return t>=100?t=Math.round(t):t&&(t=t.toFixed(1)),t?this.text("units.megabytes",{N:t}):"--"},i.list=function(e,i){var s=t.absorb(this._toFormatterOptions(i),{style:"long",type:"conjunction"});try{return this._intl("ListFormat",s).format(e)}catch(t){return s.type="unit",this._intl("ListFormat",s).format(e)}},i.date=function(e,i){if("number"==typeof e&&(e=new Date(e)),i=this._toFormatterOptions(i),t.excise(i,"relative"))return this.relativeDate(e,i);if(t.excise(i,"time"))return this.dateAndTime(e,i);var s={day:"numeric",month:"short",year:"numeric"};t.absorb(i,s);var n=!!t.excise(s,"idiom");return s.locale||(s.locale=this.LOCALE,this._isEnglish()&&!n&&(s.locale="en-GB")),this._intl("DateTimeFormat",s).format(e)},i.time=function(e){"number"==typeof e&&(e=new Date(e));var i={hour:"numeric",minute:"numeric"},s=!!t.excise(i,"idiom");if(this._isEnglish()&&!s){var n=this._intl("DateTimeFormat",i).format(e);return n.replace(" ","").toLowerCase()}return e.toLocaleString(this.LOCALE,i)},i.dateAndTime=function(e,i){"number"==typeof e&&(e=new Date(e));var s={day:"numeric",month:"short",year:this._dateIsLessThanAYearAgo(e)?void 0:"numeric"};t.absorb(this._toFormatterOptions(i),s);var n=!!t.excise(s,"idiom");return this._isEnglish()&&!n?this.date(e,s)+", "+this.time(e):(s=t.absorb(s,{hour:"numeric",minute:"numeric"}),this.date(e,s))},i.relativeDate=function(e,i){if("number"==typeof e&&(e=new Date(e)),!(e instanceof Date))return"";i=this._toFormatterOptions(i);var s=new Date;return i.today!==!1&&e.getFullYear()==s.getFullYear()&&e.getMonth()==s.getMonth()&&e.getDate()==s.getDate()?this.text("units.days.today"):!i.year&&this._dateIsLessThanAYearAgo(e)?this.date(e,t.absorb({year:void 0},i)):this.date(e,i)},i.relativeTime=function(e,t){var i={numeric:"always"};return this._intl("RelativeTimeFormat",i).format(e,t)},i._isEnglish=function(e){return"en"==(e||this.LOCALE).split("-").shift()},i._isMissingValue=function(e){return t.isNullish(e)},i._dateIsLessThanAYearAgo=function(e){var t=new Date;return e.getFullYear()==t.getFullYear()||e.getTime()+28512e6>t.getTime()},i._normalizeLabel=function(e){try{return e.toLowerCase().replace(/[^a-z0-9\.\-]+/g," ").trim().replace(/\s/g,"-")}catch(t){console.warn("[PHRASEBOOK] could not normalize label:",e)}},i._intl=function(e,i){var s=t.excise(i||{},"locale")||this.LOCALE,n=e+"?"+s;t.each(i,function(e,t){n+="&"+e+"="+t});var r=this.intlCache=this.intlCache||{};return r[n]=r[n]||new Intl[e](s,i)},i._toFormatterOptions=function(e){if("string"==typeof e){var i={true:!0,false:!1,null:null,undefined:void 0},s={},n=e.split(";");return t.each(n,function(e){var t=e.split(":");if(1==t.length)s[t.shift()]=!0;else if(t.length){var n=t.shift(),r=t.join(":");i.hasOwnProperty(r)&&(r=i[r]),s[n]=r}}),s}return t.absorb(e,{})},i._parseTemplate=function(e,i,s){for(var n=!0;n;)n=!1,e=this._replaceNextSequence(e,function(e){n=e.split(",");var r={};r.identifier=n.shift().trim(),r.argument=(n.shift()||"").trim(),r.options=n.join(",").trim(),r.substitutions=i||{},r.value=r.substitutions[r.identifier],r.templateOptions=s;var o=this._processInstruction(r);if(t.try(s,"substitutionTags")){var a="default"==r.argument&&o==r.options;o=["<span ",'data-sub="'+r.identifier+'" ','class="data-'+(a?"un":"")+'subbed"',">"+o+"</span>"].join("")}return o}.bind(this));return e.replace(/\\\{/g,"{").replace(/\\\}/g,"}")},i._replaceNextSequence=function(e,t){for(var i,s,n=0,r=0,o=!1;n<e.length;){if(o)o=!1;else if("\\"==e[n])o=!0;else if("{"==e[n])r||(i=n),r+=1;else if("}"==e[n]&&(r-=1,!r)){s=n;break}n+=1}return"number"==typeof s?[e.substring(0,i),t(e.substring(i+1,s))||"",e.substring(s+1)].join(""):e},i._processInstruction=function(e){switch(e.argument){case"number":return this.number(e.value,e.options);case"list":return this.list(e.value,e.options);case"date":return this.date(e.value,e.options);case"time":return this.time(e.value,e.options);case"plural":return this._handlePluralArgument(e);case"select":return this._handleSelectArgument(e);case"default":return this._handleDefaultArgument(e);default:return e.options="",this._handleDefaultArgument(e)}},i._handlePluralArgument=function(e){var i=[];return this._isMissingValue(e.value)||(i.push("="+e.value),t.each(e.substitutions,function(t,s){s==e.value&&t!=e.identifier&&i.push("="+t)}),i.push(this._intl("PluralRules").select(e.value))),this._handleSelectArgument(e,i)},i._handleSelectArgument=function(e,i){for(var s,n={},r=e.options;r&&r!==s;){s=r;var o;r=this._replaceNextSequence(r,function(e){return o=e," }"});var a=r.split(/ }/);n[a.shift().trim()]=o,r=a.join(" }")}i=t.isList(i)?i:[e.value];for(var l,c=0,h=i.length;c<h&&(this._isMissingValue(i[c])||(l=n[i[c]],this._isMissingValue(l)));++c);return this._isMissingValue(l)&&(this._isMissingValue(e.value)||(l=n._pass),this._isMissingValue(l)&&(l=n._miss||"")),this._parseTemplate(l,e.substitutions,e.templateOptions)},i._handleDefaultArgument=function(e){return this._isMissingValue(e.value)?e.options||"":""+e.value},i}),define("gala/src/quirks",["require","quirkbase"],function(e){var t=e("quirkbase");return t.add("has-touch-pointers","ontouchstart"in window),t.add("active-pseudoclass-needs-touchstart","ios"),t.add("legacy-ontap","ios-uiwebview"),t.add("pointer-events-capture-randomly-cancels","ios>=13 ios<13.1"),t.add("forgets-how-to-scroll","ios<13"),function(){var e=!1;try{var i=Object.defineProperty({},"passive",{get:function(){e=!0}});window.addEventListener("test",null,i),window.removeEventListener("test",null,i)}catch(e){}t.add("no-options-for-event-listeners",!e)}(),t}),define("gala/src/events",["require","./quirks"],function(e){var t={},i=e("./quirks");return t.DEFAULT_DISPATCHER=document.documentElement,t.listen=function(e,i,s,n){return t._listen.apply(t,t._addDispatcher(arguments))},t._listen=function(e,t,i,s){console.assert("function"==typeof i,"Event listener is not callable"),e.addEventListener(t,i,this._listenerOptions(s))},t.deafen=function(e,i,s,n){return t._deafen.apply(t,t._addDispatcher(arguments))},t._deafen=function(e,t,i,s){e.removeEventListener(t,i,this._listenerOptions(s))},t._listenerOptions=function(e){return"boolean"==typeof e&&(e={capture:e}),i("no-options-for-event-listeners")?e?e.capture:null:e},t.dispatch=function(e,i,s,n){return t._dispatch.apply(t,t._addDispatcher(arguments))},t._dispatch=function(e,t,i,s){var n=document.createEvent("Events");return n.initEvent(t,!1,s||!1),n.m="undefined"!=typeof i?i:{},e.dispatchEvent(n)},t.stop=function(e){return e=e||window.event,e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),e.stopImmediatePropagation&&e.stopImmediatePropagation(),e.cancelBubble=!0,e._gala_prevented=!0,!1},t._addDispatcher=function(e){return e=Array.prototype.slice.call(e,0),"string"==typeof e[0]&&e.unshift(t.DEFAULT_DISPATCHER),e},t}),define("gala/src/constants",["require","./quirks"],function(e){var t=(e("./quirks"),{});return t.DEFAULT_TOUCH_ACTION="none",t}),define("gala/src/handler",["require","./events"],function(e){var t=e("./events"),i=function(e,i,s,n){var r=t._addDispatcher(arguments);this.element=r[0],this.evtType=r[1],this.callback=r[2],this.useCapture=r[3]},s=i.prototype;return s.listen=function(){if(!this.listening)return t._listen(this.element,this.evtType,this.callback,this.useCapture),this.listening=!0,this},s.deafen=function(){if(this.listening)return t._deafen(this.element,this.evtType,this.callback,this.useCapture),this.listening=!1,this},s.fire=function(){return this.callback.apply(this,arguments),this},i}),function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define("pep/pep",t):e.PointerEventsPolyfill=t()}(this,function(){"use strict";function e(e,t){t=t||Object.create(null);var i=document.createEvent("Event");i.initEvent(e,t.bubbles||!1,t.cancelable||!1);for(var s,n=2;n<p.length;n++)s=p[n],i[s]=t[s]||d[n];i.buttons=t.buttons||0;var r=0;return r=t.pressure&&i.buttons?t.pressure:i.buttons?.5:0,i.x=i.clientX,i.y=i.clientY,i.pointerId=t.pointerId||0,i.width=t.width||0,i.height=t.height||0,i.pressure=r,i.tiltX=t.tiltX||0,i.tiltY=t.tiltY||0,i.twist=t.twist||0,i.tangentialPressure=t.tangentialPressure||0,i.pointerType=t.pointerType||"",i.hwTimestamp=t.hwTimestamp||0,i.isPrimary=t.isPrimary||!1,i}function t(){this.array=[],this.size=0}function i(e,t,i,s){this.addCallback=e.bind(s),this.removeCallback=t.bind(s),this.changedCallback=i.bind(s),L&&(this.observer=new L(this.mutationWatcher.bind(this)))}function s(e){return"body /shadow-deep/ "+n(e)}function n(e){return'[touch-action="'+e+'"]'}function r(e){return"{ -ms-touch-action: "+e+"; touch-action: "+e+"; }"}function o(){if(E){S.forEach(function(e){String(e)===e?(I+=n(e)+r(e)+"\n",R&&(I+=s(e)+r(e)+"\n")):(I+=e.selectors.map(n)+r(e.rule)+"\n",R&&(I+=e.selectors.map(s)+r(e.rule)+"\n"))});var e=document.createElement("style");e.textContent=I,document.head.appendChild(e)}}function a(){if(!window.PointerEvent){if(window.PointerEvent=e,window.navigator.msPointerEnabled){var t=window.navigator.msMaxTouchPoints;Object.defineProperty(window.navigator,"maxTouchPoints",{value:t,enumerable:!0}),_.registerSource("ms",$)}else Object.defineProperty(window.navigator,"maxTouchPoints",{value:0,enumerable:!0}),_.registerSource("mouse",B),void 0!==window.ontouchstart&&_.registerSource("touch",G);_.register(document)}}function l(e){if(!_.pointermap.has(e)){var t=new Error("InvalidPointerId");throw t.name="InvalidPointerId",t}}function c(e){for(var t=e.parentNode;t&&t!==e.ownerDocument;)t=t.parentNode;if(!t){var i=new Error("InvalidStateError");throw i.name="InvalidStateError",i}}function h(e){var t=_.pointermap.get(e);return 0!==t.buttons}function u(){window.Element&&!Element.prototype.setPointerCapture&&Object.defineProperties(Element.prototype,{setPointerCapture:{value:W},releasePointerCapture:{value:V},hasPointerCapture:{value:Z}})}var p=["bubbles","cancelable","view","detail","screenX","screenY","clientX","clientY","ctrlKey","altKey","shiftKey","metaKey","button","relatedTarget","pageX","pageY"],d=[!1,!1,null,null,0,0,0,0,!1,!1,!1,!1,0,null,0,0],m=window.Map&&window.Map.prototype.forEach,f=m?Map:t;t.prototype={set:function(e,t){return void 0===t?this.delete(e):(this.has(e)||this.size++,void(this.array[e]=t))},has:function(e){return void 0!==this.array[e]},delete:function(e){this.has(e)&&(delete this.array[e],this.size--)},get:function(e){return this.array[e]},clear:function(){this.array.length=0,this.size=0},forEach:function(e,t){return this.array.forEach(function(i,s){e.call(t,i,s,this)},this)}};var g=["bubbles","cancelable","view","detail","screenX","screenY","clientX","clientY","ctrlKey","altKey","shiftKey","metaKey","button","relatedTarget","buttons","pointerId","width","height","pressure","tiltX","tiltY","pointerType","hwTimestamp","isPrimary","type","target","currentTarget","which","pageX","pageY","timeStamp"],b=[!1,!1,null,null,0,0,0,0,!1,!1,!1,!1,0,null,0,0,0,0,0,0,0,"",0,!1,"",null,null,0,0,0,0],v={pointerover:1,pointerout:1,pointerenter:1,pointerleave:1},y="undefined"!=typeof SVGElementInstance,_={pointermap:new f,eventMap:Object.create(null),captureInfo:Object.create(null),eventSources:Object.create(null),eventSourceList:[],registerSource:function(e,t){var i=t,s=i.events;s&&(s.forEach(function(e){i[e]&&(this.eventMap[e]=i[e].bind(i))},this),this.eventSources[e]=i,this.eventSourceList.push(i))},register:function(e){for(var t,i=this.eventSourceList.length,s=0;s<i&&(t=this.eventSourceList[s]);s++)t.register.call(t,e)},unregister:function(e){for(var t,i=this.eventSourceList.length,s=0;s<i&&(t=this.eventSourceList[s]);s++)t.unregister.call(t,e)},contains:function(e,t){try{return e.contains(t)}catch(e){return!1}},down:function(e){e.bubbles=!0,this.fireEvent("pointerdown",e)},move:function(e){e.bubbles=!0,this.fireEvent("pointermove",e)},up:function(e){e.bubbles=!0,this.fireEvent("pointerup",e)},enter:function(e){e.bubbles=!1,this.fireEvent("pointerenter",e)},leave:function(e){e.bubbles=!1,this.fireEvent("pointerleave",e)},over:function(e){e.bubbles=!0,this.fireEvent("pointerover",e)},out:function(e){e.bubbles=!0,this.fireEvent("pointerout",e)},cancel:function(e){e.bubbles=!0,this.fireEvent("pointercancel",e)},leaveOut:function(e){this.out(e),this.propagate(e,this.leave,!1)},enterOver:function(e){this.over(e),this.propagate(e,this.enter,!0)},eventHandler:function(e){if(!e._handledByPE){var t=e.type,i=this.eventMap&&this.eventMap[t];i&&i(e),e._handledByPE=!0}},listen:function(e,t){t.forEach(function(t){this.addEvent(e,t)},this)},unlisten:function(e,t){t.forEach(function(t){this.removeEvent(e,t)},this)},addEvent:function(e,t){e.addEventListener(t,this.boundHandler)},removeEvent:function(e,t){e.removeEventListener(t,this.boundHandler)},makeEvent:function(t,i){this.captureInfo[i.pointerId]&&(i.relatedTarget=null);var s=new e(t,i);return i.preventDefault&&(s.preventDefault=i.preventDefault),s._target=s._target||i.target,s},fireEvent:function(e,t){var i=this.makeEvent(e,t);return this.dispatchEvent(i)},cloneEvent:function(e){for(var t,i=Object.create(null),s=0;s<g.length;s++)t=g[s],i[t]=e[t]||b[s],!y||"target"!==t&&"relatedTarget"!==t||i[t]instanceof SVGElementInstance&&(i[t]=i[t].correspondingUseElement);return e.preventDefault&&(i.preventDefault=function(){e.preventDefault()}),i},getTarget:function(e){var t=this.captureInfo[e.pointerId];return t?e._target!==t&&e.type in v?void 0:t:e._target},propagate:function(e,t,i){var s=e.target,n=[];if(s){for(;s!==document&&!s.contains(e.relatedTarget);)if(n.push(s),s=s.parentNode,!s)return;i&&n.reverse(),n.forEach(function(i){e.target=i,t.call(this,e)},this)}},setCapture:function(t,i,s){this.captureInfo[t]&&this.releaseCapture(t,s),this.captureInfo[t]=i,this.implicitRelease=this.releaseCapture.bind(this,t,s),document.addEventListener("pointerup",this.implicitRelease),document.addEventListener("pointercancel",this.implicitRelease);var n=new e("gotpointercapture");n.pointerId=t,n._target=i,s||this.asyncDispatchEvent(n)},releaseCapture:function(t,i){var s=this.captureInfo[t];if(s){this.captureInfo[t]=void 0,document.removeEventListener("pointerup",this.implicitRelease),document.removeEventListener("pointercancel",this.implicitRelease);var n=new e("lostpointercapture");n.pointerId=t,n._target=s,i||this.asyncDispatchEvent(n)}},dispatchEvent:function(e){var t=this.getTarget(e);if(t)return t.dispatchEvent(e)},asyncDispatchEvent:function(e){requestAnimationFrame(this.dispatchEvent.bind(this,e))}};_.boundHandler=_.eventHandler.bind(_);var w={shadow:function(e){if(e)return e.shadowRoot||e.webkitShadowRoot},canTarget:function(e){return e&&Boolean(e.elementFromPoint)},targetingShadow:function(e){var t=this.shadow(e);if(this.canTarget(t))return t},olderShadow:function(e){var t=e.olderShadowRoot;if(!t){var i=e.querySelector("shadow");i&&(t=i.olderShadowRoot)}return t},allShadows:function(e){for(var t=[],i=this.shadow(e);i;)t.push(i),i=this.olderShadow(i);return t},searchRoot:function(e,t,i){if(e){var s,n,r=e.elementFromPoint(t,i);for(n=this.targetingShadow(r);n;){if(s=n.elementFromPoint(t,i)){var o=this.targetingShadow(s);return this.searchRoot(o,t,i)||s}n=this.olderShadow(n)}return r}},owner:function(e){for(var t=e;t.parentNode;)t=t.parentNode;return t.nodeType!==Node.DOCUMENT_NODE&&t.nodeType!==Node.DOCUMENT_FRAGMENT_NODE&&(t=document),t},findTarget:function(e){var t=e.clientX,i=e.clientY,s=this.owner(e.target);return s.elementFromPoint(t,i)||(s=document),this.searchRoot(s,t,i)}},P=Array.prototype.forEach.call.bind(Array.prototype.forEach),A=Array.prototype.map.call.bind(Array.prototype.map),C=Array.prototype.slice.call.bind(Array.prototype.slice),k=Array.prototype.filter.call.bind(Array.prototype.filter),L=window.MutationObserver||window.WebKitMutationObserver,x="[touch-action]",T={subtree:!0,childList:!0,attributes:!0,attributeOldValue:!0,attributeFilter:["touch-action"]};i.prototype={watchSubtree:function(e){this.observer&&w.canTarget(e)&&this.observer.observe(e,T)},enableOnSubtree:function(e){this.watchSubtree(e),e===document&&"complete"!==document.readyState?this.installOnLoad():this.installNewSubtree(e)},installNewSubtree:function(e){P(this.findElements(e),this.addElement,this)},findElements:function(e){return e.querySelectorAll?e.querySelectorAll(x):[]},removeElement:function(e){this.removeCallback(e)},addElement:function(e){this.addCallback(e)},elementChanged:function(e,t){this.changedCallback(e,t)},concatLists:function(e,t){return e.concat(C(t))},installOnLoad:function(){document.addEventListener("readystatechange",function(){"complete"===document.readyState&&this.installNewSubtree(document)}.bind(this))},isElement:function(e){return e.nodeType===Node.ELEMENT_NODE},flattenMutationTree:function(e){var t=A(e,this.findElements,this);return t.push(k(e,this.isElement)),t.reduce(this.concatLists,[])},mutationWatcher:function(e){e.forEach(this.mutationHandler,this)},mutationHandler:function(e){if("childList"===e.type){var t=this.flattenMutationTree(e.addedNodes);t.forEach(this.addElement,this);var i=this.flattenMutationTree(e.removedNodes);i.forEach(this.removeElement,this)}else"attributes"===e.type&&this.elementChanged(e.target,e.oldValue)}};var S=["none","auto","pan-x","pan-y",{rule:"pan-x pan-y",selectors:["pan-x pan-y","pan-y pan-x"]}],I="",E=window.PointerEvent||window.MSPointerEvent,R=!window.ShadowDOMPolyfill&&document.head.createShadowRoot,F=_.pointermap,N=25,M=[1,4,2,8,16],O=!1;try{O=1===new MouseEvent("test",{buttons:1}).buttons}catch(e){}var D,B={POINTER_ID:1,POINTER_TYPE:"mouse",events:["mousedown","mousemove","mouseup","mouseover","mouseout"],register:function(e){_.listen(e,this.events)},unregister:function(e){_.unlisten(e,this.events)},lastTouches:[],isEventSimulatedFromTouch:function(e){for(var t,i=this.lastTouches,s=e.clientX,n=e.clientY,r=0,o=i.length;r<o&&(t=i[r]);r++){var a=Math.abs(s-t.x),l=Math.abs(n-t.y);if(a<=N&&l<=N)return!0}},prepareEvent:function(e){var t=_.cloneEvent(e),i=t.preventDefault;return t.preventDefault=function(){e.preventDefault(),i()},t.pointerId=this.POINTER_ID,t.isPrimary=!0,t.pointerType=this.POINTER_TYPE,t},prepareButtonsForMove:function(e,t){var i=F.get(this.POINTER_ID);0!==t.which&&i?e.buttons=i.buttons:e.buttons=0,t.buttons=e.buttons},mousedown:function(e){if(!this.isEventSimulatedFromTouch(e)){var t=F.get(this.POINTER_ID),i=this.prepareEvent(e);O||(i.buttons=M[i.button],t&&(i.buttons|=t.buttons),e.buttons=i.buttons),F.set(this.POINTER_ID,e),!t||0===t.buttons,_.down(i)}},mousemove:function(e){if(!this.isEventSimulatedFromTouch(e)){var t=this.prepareEvent(e);O||this.prepareButtonsForMove(t,e),t.button=-1,F.set(this.POINTER_ID,e),_.move(t)}},mouseup:function(e){if(!this.isEventSimulatedFromTouch(e)){var t=F.get(this.POINTER_ID),i=this.prepareEvent(e);if(!O){var s=M[i.button];i.buttons=t?t.buttons&~s:0,e.buttons=i.buttons}F.set(this.POINTER_ID,e),i.buttons&=~M[i.button],0===i.buttons?_.up(i):_.move(i)}},mouseover:function(e){if(!this.isEventSimulatedFromTouch(e)){var t=this.prepareEvent(e);O||this.prepareButtonsForMove(t,e),t.button=-1,F.set(this.POINTER_ID,e),_.enterOver(t)}},mouseout:function(e){if(!this.isEventSimulatedFromTouch(e)){var t=this.prepareEvent(e);O||this.prepareButtonsForMove(t,e),t.button=-1,_.leaveOut(t)}},cancel:function(e){var t=this.prepareEvent(e);_.cancel(t),this.deactivateMouse()},deactivateMouse:function(){F.delete(this.POINTER_ID)}},z=_.captureInfo,q=w.findTarget.bind(w),U=w.allShadows.bind(w),j=_.pointermap,H=2500,K=200,Y="touch-action",G={events:["touchstart","touchmove","touchend","touchcancel"],register:function(e){D.enableOnSubtree(e)},unregister:function(){},elementAdded:function(e){var t=e.getAttribute(Y),i=this.touchActionToScrollType(t);i&&(e._scrollType=i,_.listen(e,this.events),U(e).forEach(function(e){e._scrollType=i,_.listen(e,this.events)},this))},elementRemoved:function(e){e._scrollType=void 0,_.unlisten(e,this.events),U(e).forEach(function(e){e._scrollType=void 0,_.unlisten(e,this.events)},this)},elementChanged:function(e,t){var i=e.getAttribute(Y),s=this.touchActionToScrollType(i),n=this.touchActionToScrollType(t);s&&n?(e._scrollType=s,U(e).forEach(function(e){e._scrollType=s},this)):n?this.elementRemoved(e):s&&this.elementAdded(e)},scrollTypes:{EMITTER:"none",XSCROLLER:"pan-x",YSCROLLER:"pan-y",SCROLLER:/^(?:pan-x pan-y)|(?:pan-y pan-x)|auto$/},touchActionToScrollType:function(e){var t=e,i=this.scrollTypes;return"none"===t?"none":t===i.XSCROLLER?"X":t===i.YSCROLLER?"Y":i.SCROLLER.exec(t)?"XY":void 0},POINTER_TYPE:"touch",firstTouch:null,isPrimaryTouch:function(e){return this.firstTouch===e.identifier},setPrimaryTouch:function(e){(0===j.size||1===j.size&&j.has(1))&&(this.firstTouch=e.identifier,this.firstXY={X:e.clientX,Y:e.clientY},this.scrolling=!1,this.cancelResetClickCount())},removePrimaryPointer:function(e){e.isPrimary&&(this.firstTouch=null,this.firstXY=null,this.resetClickCount())},clickCount:0,resetId:null,resetClickCount:function(){var e=function(){this.clickCount=0,this.resetId=null}.bind(this);this.resetId=setTimeout(e,K)},cancelResetClickCount:function(){this.resetId&&clearTimeout(this.resetId)},typeToButtons:function(e){var t=0;return"touchstart"!==e&&"touchmove"!==e||(t=1),t},touchToPointer:function(e){var t=this.currentTouchEvent,i=_.cloneEvent(e),s=i.pointerId=e.identifier+2;i.target=z[s]||q(i),i.bubbles=!0,i.cancelable=!0,i.detail=this.clickCount,i.button=0,i.buttons=this.typeToButtons(t.type),i.width=2*(e.radiusX||e.webkitRadiusX||0),i.height=2*(e.radiusY||e.webkitRadiusY||0),i.pressure=e.force||e.webkitForce||.5,i.isPrimary=this.isPrimaryTouch(e),i.pointerType=this.POINTER_TYPE,i.altKey=t.altKey,i.ctrlKey=t.ctrlKey,i.metaKey=t.metaKey,i.shiftKey=t.shiftKey;var n=this;return i.preventDefault=function(){n.scrolling=!1,n.firstXY=null,t.preventDefault()},i},processTouches:function(e,t){var i=e.changedTouches;this.currentTouchEvent=e;for(var s,n=0;n<i.length;n++)s=i[n],t.call(this,this.touchToPointer(s))},shouldScroll:function(e){if(this.firstXY){var t,i=e.currentTarget._scrollType;if("none"===i)t=!1;else if("XY"===i)t=!0;else{var s=e.changedTouches[0],n=i,r="Y"===i?"X":"Y",o=Math.abs(s["client"+n]-this.firstXY[n]),a=Math.abs(s["client"+r]-this.firstXY[r]);t=o>=a}return this.firstXY=null,t}},findTouch:function(e,t){for(var i,s=0,n=e.length;s<n&&(i=e[s]);s++)if(i.identifier===t)return!0},vacuumTouches:function(e){var t=e.touches;if(j.size>=t.length){var i=[];j.forEach(function(e,s){if(1!==s&&!this.findTouch(t,s-2)){var n=e.out;i.push(n)}},this),i.forEach(this.cancelOut,this)}},touchstart:function(e){this.vacuumTouches(e),this.setPrimaryTouch(e.changedTouches[0]),this.dedupSynthMouse(e),this.scrolling||(this.clickCount++,this.processTouches(e,this.overDown))},overDown:function(e){j.set(e.pointerId,{target:e.target,out:e,outTarget:e.target}),_.enterOver(e),_.down(e)},touchmove:function(e){this.scrolling||(this.shouldScroll(e)?(this.scrolling=!0,this.touchcancel(e)):(e.preventDefault(),this.processTouches(e,this.moveOverOut)))},moveOverOut:function(e){var t=e,i=j.get(t.pointerId);if(i){var s=i.out,n=i.outTarget;_.move(t),s&&n!==t.target&&(s.relatedTarget=t.target,t.relatedTarget=n,s.target=n,t.target?(_.leaveOut(s),_.enterOver(t)):(t.target=n,t.relatedTarget=null,this.cancelOut(t))),i.out=t,i.outTarget=t.target}},touchend:function(e){this.dedupSynthMouse(e),this.processTouches(e,this.upOut)},upOut:function(e){this.scrolling||(_.up(e),_.leaveOut(e)),this.cleanUpPointer(e)},touchcancel:function(e){this.processTouches(e,this.cancelOut)},cancelOut:function(e){_.cancel(e),_.leaveOut(e),this.cleanUpPointer(e)},cleanUpPointer:function(e){j.delete(e.pointerId),this.removePrimaryPointer(e)},dedupSynthMouse:function(e){var t=B.lastTouches,i=e.changedTouches[0];if(this.isPrimaryTouch(i)){var s={x:i.clientX,y:i.clientY};t.push(s);var n=function(e,t){var i=e.indexOf(t);i>-1&&e.splice(i,1)}.bind(null,t,s);setTimeout(n,H)}}};D=new i(G.elementAdded,G.elementRemoved,G.elementChanged,G);var W,V,Z,Q=_.pointermap,J=window.MSPointerEvent&&"number"==typeof window.MSPointerEvent.MSPOINTER_TYPE_MOUSE,$={events:["MSPointerDown","MSPointerMove","MSPointerUp","MSPointerOut","MSPointerOver","MSPointerCancel","MSGotPointerCapture","MSLostPointerCapture"],register:function(e){_.listen(e,this.events)},unregister:function(e){_.unlisten(e,this.events)},POINTER_TYPES:["","unavailable","touch","pen","mouse"],prepareEvent:function(e){var t=e;return J&&(t=_.cloneEvent(e),t.pointerType=this.POINTER_TYPES[e.pointerType]),t},cleanup:function(e){Q.delete(e)},MSPointerDown:function(e){Q.set(e.pointerId,e);var t=this.prepareEvent(e);_.down(t)},MSPointerMove:function(e){var t=this.prepareEvent(e);_.move(t)},MSPointerUp:function(e){var t=this.prepareEvent(e);_.up(t),this.cleanup(e.pointerId)},MSPointerOut:function(e){var t=this.prepareEvent(e);_.leaveOut(t)},MSPointerOver:function(e){var t=this.prepareEvent(e);_.enterOver(t)},MSPointerCancel:function(e){var t=this.prepareEvent(e);_.cancel(t),this.cleanup(e.pointerId)},MSLostPointerCapture:function(e){var t=_.makeEvent("lostpointercapture",e);_.dispatchEvent(t)},MSGotPointerCapture:function(e){var t=_.makeEvent("gotpointercapture",e);_.dispatchEvent(t)}},X=window.navigator;X.msPointerEnabled?(W=function(e){l(e),c(this),h(e)&&(_.setCapture(e,this,!0),this.msSetPointerCapture(e))},V=function(e){l(e),_.releaseCapture(e,!0),this.msReleasePointerCapture(e)}):(W=function(e){l(e),c(this),h(e)&&_.setCapture(e,this)},V=function(e){l(e),_.releaseCapture(e)}),Z=function(e){return!!_.captureInfo[e]},o(),a(),u();var ee={dispatcher:_,Installer:i,PointerEvent:e,PointerMap:f,targetFinding:w};return ee}),define("pep",["pep/pep"],function(e){return e}),define("gala/src/touch-action",["require","./events"],function(e){var t=e("./events");return t.setTouchAction=function(e,t,i){i&&i.override===!1&&e.getAttribute("touch-action")||(t?(e.setAttribute("touch-action",t),e.style.setProperty("-ms-touch-action",t),e.style.setProperty("touch-action",t)):(e.removeAttribute("touch-action"),e.style.removeProperty("-ms-touch-action"),e.style.removeProperty("touch-action")))},t}),define("gala/src/contact-handler",["require","pep","./constants","./events","./handler","./quirks","./touch-action"],function(e){var t=function(e,t,i){var s=n._addDispatcher(arguments);this.element=s.shift(),this.callbacks=s.shift(),this.options=s.shift()||{},this._={},this._.handlers={start:[],move:[],end:[],cancel:[]},this._.pointers=[],this._setAppropriateTouchAction(this.element)},i=t.prototype,s=(e("pep"),e("./constants")),n=e("./events"),r=(e("./handler"),e("./quirks"));e("./touch-action");return i.listen=function(){return this._listenOnCategory(this.element,"start",["pointerdown"]),this},i.deafen=function(){for(this._deafenHandlers(this._.handlers.start);this._.pointers.length;)this._removePointer(this._.pointers[0]);return this},i.capture=function(){if(!r("pointer-events-capture-randomly-cancels"))for(var e=0,t=this._.pointers.length;e<t;++e)this._capturePointer(this._.pointers[e],this.element);this._.handlers.cancel&&n.off(this._.handlers.cancel[1])},i.release=function(){for(var e=0,t=this._.pointers.length;e<t;++e)this._releasePointer(this._.pointers[e])},i._setAppropriateTouchAction=function(e){for(var t=s.DEFAULT_TOUCH_ACTION;e&&e.getAttribute;){var i=e.getAttribute("touch-action")||(e._scrollableAxis?"pan-"+e._scrollableAxis:null);if(i){t=i;break}e=e.parentNode}n.setTouchAction(this.element,t,{override:!1})},i._listenContinue=function(){var e={move:["pointermove"],end:["pointerup"],cancel:["pointercancel","pointerleave"]};this._listenOnCategory(this.element,"move",e.move),this._listenOnCategory(this.element,"end",e.end),this._listenOnCategory(this.element,"cancel",e.cancel),this._.continued=!0},i._deafenContinue=function(){this._deafenHandlers(this._.handlers.move),this._deafenHandlers(this._.handlers.end),this._deafenHandlers(this._.handlers.cancel),this._.continued=!1},i._listenOnCategory=function(e,t,i){if(!this._.handlers[t].length)for(var s=this["_"+t].bind(this);i.length;){var r=i.shift(),o=n.on(e,r,s,this.options.capture);this._.handlers[t].push(o)}},i._start=function(e){e.button>0||(this._addPointer(e),this._invokeCallback("start",e))},i._move=function(e){this._updatePointer(e)&&this._invokeCallback("move",e)},i._end=function(e){this._updatePointer(e)&&(this._invokeCallback("end",e),this._removePointer(e))},i._cancel=function(e){this._updatePointer(e)&&(this._invokeCallback("cancel",e),this._removePointer(e))},i._deafenHandlers=function(e){for(;e.length;)e.shift().deafen()},i._invokeCallback=function(e,t){t.contactType=e,t.contactPointers=this._.pointers.slice(0),t.contactScale=this._computeScaleOfPointers(),"function"==typeof this.callbacks[e]&&this.callbacks[e](t)},i._addPointer=function(e){this.options.multitouch||this._.pointers.splice(0),e.contactIndex=this._.pointers.length,this._.pointers.push(e),this._.continued||this._listenContinue(),delete this._.initialPointerDistance},i._updatePointer=function(e){for(var t=0,i=this._.pointers.length;t<i;++t){var s=this._.pointers[t];if(s.pointerId==e.pointerId)return this._.pointers[t]=e,e.contactIndex=s.contactIndex,!0}return!1},i._removePointer=function(e){this._releasePointer(e);for(var t=[],i=0,s=this._.pointers.length;i<s;++i){var n=this._.pointers[i];n.pointerId!=e.pointerId&&t.push(n)}this._.pointers=t,this._.continued&&!this._.pointers.length&&this._deafenContinue()},i._capturePointer=function(e,t){t=e.target,this._.captureTargets=this._.captureTargets||{};var i=this._.captureTargets[e.pointerId];i!=t&&(i&&i!=t&&this._releasePointer(e),this._.captureTargets[e.pointerId]=t,t.setPointerCapture(e.pointerId))},i._releasePointer=function(e){this._.captureTargets=this._.captureTargets||{};var t=this._.captureTargets[e.pointerId];if(t)try{t.releasePointerCapture(e.pointerId),delete this._.captureTargets[e.pointerId]}catch(e){}},i._computeScaleOfPointers=function(){if(2!=this._.pointers.length)return 1;var e=function(e){var t=e[1].pageX-e[0].pageX,i=e[1].pageY-e[0].pageY;return Math.sqrt(t*t+i*i)},t=e(this._.pointers),i=this._.initialPointerDistance||t;return this._.initialPointerDistance=i,t/i},t}),define("gala/src/scroll-manager",["require","./events","./quirks","./touch-action"],function(e){var t={},i=e("./events"),s=e("./quirks");e("./touch-action");return t.scrollable=function(e,n){n=n||"y",e._scrollableAxis!=n&&(e._scrollableAxis=n,e.classList.add("native-scrollable"),e.classList.add("native-scrollable-"+n),i.setTouchAction(e,"pan-"+n),s("legacy-ontap")&&i.on(e,"scroll",function(){t.lastScrollTimestamp=(new Date).getTime()}))},t.unscrollable=function(e){i.on(e,"scroll",function(t){i.stop(t),e.scrollLeft=0,e.scrollTop=0})},t.jiggle=function(e){e.style.setProperty("-webkit-overflow-scrolling","initial"),setTimeout(function(){e.style.removeProperty("-webkit-overflow-scrolling")},500)},t}),define("gala/src/velocity",["require"],function(e){var t=function(e){this._={points:[],target:{x:0,
y:0},pointer:{curr:{x:0,y:0},prev:{x:0,y:0}},decel:{x:0,y:0},awaitingTick:!1,decelerating:!1},this.configure(e||{})},i=t.prototype;return i.BOUNCE_ACCELERATION=.11,i.BOUNCE_DECELERATION=.04,i.BOUNDARY_FRICTION_BASE=.55,i.MULTIPLIER=1,i.FRICTION=.92,i.DECAY_THRESHOLD=.3,i.FRAME_MS=15,i.TRACKING_WINDOW_MS=100,i.configure=function(e){this.options=e,this.options.position&&(this._.target.x=this.options.position.x,this._.target.y=this.options.position.y),"number"!=typeof this.options.multiplier&&(this.options.multiplier=this.MULTIPLIER),"number"!=typeof this.options.friction&&(this.options.friction=this.FRICTION),"undefined"==typeof this.options.bounce&&(this.options.bounce=!0),"undefined"==typeof this.options.bounceAcceleration&&(this.options.bounceAcceleration=this.BOUNCE_ACCELERATION),"undefined"==typeof this.options.bounceDeceleration&&(this.options.bounceDeceleration=this.BOUNCE_DECELERATION),"undefined"==typeof this.options.boundaryFrictionBase&&(this.options.boundaryFrictionBase={x:this.BOUNDARY_FRICTION_BASE,y:this.BOUNDARY_FRICTION_BASE}),"number"!=typeof this.options.decayThreshold&&(this.options.decayThreshold=this.DECAY_THRESHOLD*this.options.multiplier)},i.onUpdate=function(e,t,i){console.log("[GALA] Velocity: %s (%s, %s)",i.phase,e,t)},i.trackFirst=function(e,t,i){this._.decelerating=!1,this._.pointer.prev.x=this._.pointer.curr.x=e,this._.pointer.prev.y=this._.pointer.curr.y=t,this._.points.splice(0),this._addTrackingPoint(e,t,i)},i.trackNext=function(e,t,i){this._.pointer.curr.x=e,this._.pointer.curr.y=t,this._addTrackingPoint(this._.pointer.prev.x,this._.pointer.prev.y,i),this._.awaitingTick||(requestAnimationFrame(this._performUpdate.bind(this)),this._.awaitingTick=!0)},i.trackLast=function(e,t,i){this._addTrackingPoint("number"==typeof e?e:this._.pointer.prev.x,"number"==typeof t?t:this._.pointer.prev.y,i),this._decelerateStart()},i._addTrackingPoint=function(e,t,i){for(i=i||(new Date).getTime();this._.points.length>0&&!(i-this._.points[0].timestamp<=this.TRACKING_WINDOW_MS);)this._.points.shift();this._.points.push({x:e,y:t,timestamp:i})},i._boundaryEnforcement=function(e){var t={x:0,y:0},i=this.options.boundary;return i?(this._.target.x<i.left?t.x=i.left-this._.target.x:this._.target.x>i.right&&(t.x=i.right-this._.target.x),this._.target.y<i.top?t.y=i.top-this._.target.y:this._.target.y>i.bottom&&(t.y=i.bottom-this._.target.y),e&&(t.x&&(this._.target.x=t.x>0?i.left:i.right),t.y&&(this._.target.y=t.y>0?i.top:i.bottom)),t.x||t.y?t:null):null},i._boundaryFriction=function(e,t){var i=function(e,t){return 5e-6*Math.pow(e,2)+1e-4*e+t};return{x:i(e,this.options.boundaryFrictionBase.x),y:i(t,this.options.boundaryFrictionBase.y)}},i._decelerateStart=function(){var e=this._.points[0],t=this._.points[this._.points.length-1],i={x:t.x-e.x,y:t.y-e.y,ms:t.timestamp-e.timestamp},s=i.ms/this.FRAME_MS/this.options.multiplier;this._.decay={x:i.x/s||0,y:i.y/s||0};var n=this._boundaryEnforcement();n||Math.abs(this._.decay.x)>1||Math.abs(this._.decay.y)>1?(this._.decelerating=!0,requestAnimationFrame(this._decelerateContinue.bind(this))):this.onUpdate(this._.target.x,this._.target.y,{phase:"resting"})},i._decelerateContinue=function(){if(this._.decelerating){this._.decay.x*=this.options.friction,this._.decay.y*=this.options.friction,this._.target.x+=this._.decay.x,this._.target.y+=this._.decay.y;var e=this.options.decayThreshold,t=this._boundaryEnforcement();t&&this.options.bounce?(t.x&&(Math.abs(t.x)<e?this._.decay.x=t.x:t.x*this._.decay.x<=0?this._.decay.x+=t.x*this.options.bounceDeceleration:this._.decay.x=t.x*this.options.bounceAcceleration),t.y&&(Math.abs(t.y)<e?this._.decay.y=t.y:t.y*this._.decay.y<=0?this._.decay.y+=t.y*this.options.bounceDeceleration:this._.decay.y=t.y*this.options.bounceAcceleration)):t&&this.options.boundary&&(t.x&&(this._.target.x=this.options.boundary[t.x>0?"left":"right"],this._.decay.x=0),t.y&&(this._.target.y=this.options.boundary[t.y>0?"top":"bottom"],this._.decay.y=0)),t&&Math.abs(t.x)>e||t&&Math.abs(t.y)>e||Math.abs(this._.decay.x)>e||Math.abs(this._.decay.y)>e?(this.onUpdate(this._.target.x,this._.target.y,{phase:"decelerating"}),requestAnimationFrame(this._decelerateContinue.bind(this))):(this.onUpdate(this._.target.x,this._.target.y,{phase:"resting"}),this._.decelerating=!1)}},i._performUpdate=function(){var e={x:this._.pointer.curr.x-this._.pointer.prev.x,y:this._.pointer.curr.y-this._.pointer.prev.y};this._.target.x+=e.x*this.options.multiplier,this._.target.y+=e.y*this.options.multiplier;var t=this._boundaryEnforcement(!this.options.bounce);if(t){var i=this._boundaryFriction(t.x,t.y);t.x&&(this._.target.x-=e.x*i.x*this.options.multiplier),t.y&&(this._.target.y-=e.y*i.y*this.options.multiplier)}this.onUpdate(this._.target.x,this._.target.y,{phase:"dragging"}),this._.pointer.prev.x=this._.pointer.curr.x,this._.pointer.prev.y=this._.pointer.curr.y,this._.awaitingTick=!1},t}),define("gala/src/ontap",["require","./events","./constants","./quirks","./contact-handler"],function(e){var t=e("./events");e("./constants"),e("./quirks"),e("./contact-handler");return t.onTap=function(e,i,s){s=s||{},"undefined"!=typeof s.ariaRole||e.getAttribute("role")||(s.ariaRole="button"),s.ariaRole&&e.setAttribute("role",s.ariaRole);var n=function(s){s.tappedElement=e,t.tappedElement=e,i(s)},r={};return r.listen=function(){t.listen(e,"click",n)},r.deafen=function(){t.deafen(e,"click",n)},r.listen(),r},t}),define("gala/src/legacy-ontap",["require","./events","./quirks","./constants","./contact-handler","./scroll-manager"],function(e){var t=e("./events"),i=e("./quirks"),s=e("./constants"),n=(e("./contact-handler"),e("./scroll-manager"));if(!i("legacy-ontap"))return t;s.TAP_MAX_CONTACT_DISTANCE=10;var r=null,o={};return o.isTapValid=function(e){if(!r)return!1;if(n.lastScrollTimestamp){var i=r.time-n.lastScrollTimestamp,a=(new Date).getTime()-r.time;if(i<a)return console.log("Ignoring tap due to recent scroll.\nsinceScrollMS: %s is less than tapLengthMS: %s",i,a),t.__LAST_SCROLL=0,!1}if(o.getScrollSignature(r.elem)!=r.scrollSig)return console.log("Ignoring tap because scroll signature differs"),!1;var l=Math.abs(e.pageX-r.coords.x),c=Math.abs(e.pageY-r.coords.y),h=Math.max(l,c);return!(s.TAP_MAX_CONTACT_DISTANCE<h)||(console.log("Ignoring tap because pointer moved too much"),!1)},o.handleTap=function(e,t,i){if(r&&r.time==t){var s=o.isTapValid(e);o.cancelTap(),s&&i(e)}},o.cancelTap=function(){r&&(r.endTimer&&clearTimeout(r.endTimer),r=null)},o.throttleInvocation=function(e,t){var i=0;return function(){var s=new Date,n=t-(s-i);n<=0&&(i=s,e.apply(this,arguments))}},o.getScrollSignature=function(e){for(var t=0;e&&e.style;)t+=e.scrollTop+e.scrollLeft,e=e.parentNode;return t},t.onTap=function(e,i,s){i=o.throttleInvocation(i,100),s=s||{},null!==s.ariaRole&&e.setAttribute("role",s.ariaRole||"link"),"undefined"==typeof s.propagate&&(s.propagate=!0);var n={start:function(t){s.propagate||t.stopPropagation(),r&&r.elem!=e&&o.cancelTap(),r={elem:e,time:(new Date).getTime(),scrollSig:o.getScrollSignature(e),coords:{x:t.pageX,y:t.pageY},options:s}},move:function(t){r&&r.elem!=e||o.isTapValid(t)||o.cancelTap()},end:function(n){if(s.propagate||n.stopPropagation(),!r||r.elem==e){if(t.stop(n),!o.isTapValid(n))return o.cancelTap();n.tappedElement=e;var a=o.handleTap.bind(o,n,r.time,i);if(s.propagate){var l="mouse"==n.pointerType?0:50;r.endTimer=setTimeout(a,l)}else a()}},cancel:function(t){r&&r.elem!=e||o.cancelTap()}};return t.onContact(e,n)},t}),define("gala/src/sugar",["require","./events","./handler","./contact-handler","./scroll-manager"],function(e){function t(e,t){if(e&&"function"==typeof e[t])e[t]();else if(Array.isArray(e))for(var i=0,s=e.length;i<s;++i)e[i][t]();else if(e)for(var n=Object.getOwnPropertyNames(e),i=0,s=n.length;i<s;++i)e[n[i]][t]();return e}var i=e("./events"),s=e("./handler"),n=e("./contact-handler"),r=e("./scroll-manager");return i.on=function(e,n,r,o){if(arguments.length<=1)return t(arguments[0],"listen");var a=i._addDispatcher(arguments);return new s(a[0],a[1],a[2],a[3]).listen()},i.off=function(e){t(e,"deafen")},i.once=function(e,t,n,r){var o=i._addDispatcher(arguments),a=new s(o[0],o[1],function(){return a.deafen(),o[2].apply(window,arguments)},o[3]).listen();return a},i.onContact=function(e,t,i){return new n(e,t,i).listen()},i.scrollable=function(){r.scrollable.apply(r,arguments)},i.unscrollable=function(){r.unscrollable.apply(r,arguments)},i}),define("gala/gala",["require","./src/events","./src/constants","./src/handler","./src/contact-handler","./src/scroll-manager","./src/velocity","./src/ontap","./src/legacy-ontap","./src/sugar"],function(e){var t=e("./src/events");return t.Constants=e("./src/constants"),t.Handler=e("./src/handler"),t.ContactHandler=e("./src/contact-handler"),t.ScrollManager=e("./src/scroll-manager"),t.Velocity=e("./src/velocity"),e("./src/ontap"),e("./src/legacy-ontap"),e("./src/sugar"),t}),define("gala",["gala/gala"],function(e){return e}),define("shibui/src/keys",["require","common","gala"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("gala");return s.KEYS={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,SPACE:32,LEFT:37,UP:38,RIGHT:39,DOWN:40,DELETE:46,HOME:36,END:35,PAGEUP:33,PAGEDOWN:34,INSERT:45,"?":191,'"':222,$:52,"+":187,"-":189,PLUS:61,MINUS:173},s.$init=function(e,t,i){this._.shortcut=e,this._.definition=this._parseShortcut(this._.shortcut),this._.callback=t,this._.handlers=[],this.attach(i)},s.attach=function(e){e=e||document,this._.handlers.push({element:e,listener:n.on(e,this._.definition.keyEventType,this._onKeyEvent.bind(this,e))})},s.detach=function(e){var i=[];t.each(this._.handlers,function(t){t.element==e?t.listener.deafen():i.push(t)}),this._.handlers=i},s.on=function(){t.each(this._.handlers,function(e){e.listener.listen()})},s.off=function(){t.each(this._.handlers,function(e){e.listener.deafen()})},s._parseShortcut=function(e){var t={},i=e.split(" ");i[1]&&i[1].match(/\d+ms/)?(t.keyEventType="keydown",t.keyEventDelay=parseFloat(i[1])):t.keyEventType="key"+(i[1]||"up");var s=i[0].match(/^([\w\-]+-)?(.+)$/),n=s?s[2]:i[0];i=s&&s[1]?s[1].split("-"):[],["alt","ctrl","meta","cmd"].indexOf(n)>=0?i.push(n):(t.charCode=this.KEYS[n.toUpperCase()])?(t.keyCode=t.charCode,t.keyDesc=n):1==n.length?(t.charCode=n.charCodeAt(0),t.keyCode=n.toUpperCase().charCodeAt(0),t.keyDesc=n):"#"==n[0]?(t.charCode=parseInt(n.replace(/^#/,"")),t.keyCode=t.charCode,t.keyDesc=n):"blur"==n&&(t.keyEventType="blur",t.keyDesc=n);for(var r;r=i.shift();)r=r.toLowerCase(),"shift"==r?t.shiftKey=!0:"alt"==r?t.altKey=!0:"ctrl"==r?t.ctrlKey=!0:"meta"!=r&&"cmd"!=r||("keydown"!=t.keyEventType?console.warn('[KEYS] "%s" key cannot be registered with "%s"',r,t.keyEventType):t.metaKey=!0);return t},s._matchDefinition=function(e){var t=this._.definition;if("keypress"==e.type){var i=e.charCode||e.keyCode;if(t.charCode!=i)return!1}else if(t.keyCode&&t.keyCode!=e.keyCode)return!1;return!!t.shiftKey==!!e.shiftKey&&(!!t.altKey==!!e.altKey&&(!!t.ctrlKey==!!e.ctrlKey&&!!t.metaKey==!!e.metaKey))},s._onKeyEvent=function(e,t){if(this._.delaying&&!this._matchDefinition(t))return this._.delaying.cleanup();if(!t.defaultPrevented&&this._matchDefinition(t))if(t.m||(t.m={}),t.m.keyDef=this._.definition,this._.definition.keyEventDelay){var i=function(){this._.delaying&&(clearTimeout(this._.delaying.timer),n.off(this._.delaying.upHandler),n.off(this._.delaying.cancelHandler),delete this._.delaying)}.bind(this);this._.delaying={cleanup:i,upHandler:n.on(e,"keyup",i),cancelHandler:n.on("keystroke:cancel",i),timer:setTimeout(function(){i(),this._.callback(t)}.bind(this),this._.definition.keyEventDelay)}}else this._.callback(t)},i}),define("shibui/src/key-manager",["require","common","gala","./keys"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("gala"),r=e("./keys");return s.KEY_ENTRY_TAGNAMES=["INPUT","TEXTAREA","SELECT"],s.$init=function(e){this._.element=e||document,this._.document=this._.element.ownerDocument,!this._.document&&this._.element.documentElement?this._.document=this._.element:this._.document=document,this._.bindings=[],this._disableBindingsOnFieldFocus()},s.listen=function(){if(delete this._.deafenReason,clearTimeout(this._.listenTimer),this._.document.activeElement){var e=this._.document.activeElement.tagName.toLowerCase();if("input"==e||"textarea"==e||"select"==e)return}t.each(this._.bindings,function(e){e.on()})},s.deafen=function(e){this._.deafenReason=e||"intentional",clearTimeout(this._.listenTimer),t.each(this._.bindings,function(e){e.off()})},s.addBinding=function(e,t,i){var s=t;i&&(i.stop||i.global)&&(s=function(e){try{t()}catch(e){if("invalid"==e.key)return;throw e}i.stop&&n.stop(e),i.global&&document.activeElement.blur()}.bind(this));var o=new r(e,s,this._.element);return this._.bindings.push(o),o},s.removeBinding=function(e){e.off(),t.excise(this._.bindings,e)},s._disableBindingsOnFieldFocus=function(){n.on(document,"focus",function(e){var i=t.try(document.activeElement,"tagName");if(this.KEY_ENTRY_TAGNAMES.indexOf(i)>=0){if(this._.deafenReason)return;this.deafen("field-focus")}}.bind(this),!0),n.on(document,"blur",function(e){if("field-focus"==this._.deafenReason){var i=t.try(document.activeElement,"tagName");this.KEY_ENTRY_TAGNAMES.indexOf(i)<0&&(delete this._.deafenReason,clearTimeout(this._.listenTimer),this._.listenTimer=setTimeout(this.listen.bind(this),500))}}.bind(this),!0)},i}),define("shibui/shibui",["require","./src/illustrator","./src/phrasebook","./src/key-manager"],function(e){var t={Illustrator:e("./src/illustrator"),Phrasebook:e("./src/phrasebook"),KeyManager:e("./src/key-manager")};return t}),define("shibui",["shibui/shibui"],function(e){return e}),define("text",["module"],function(e){"use strict";function t(e,t){return void 0===e||""===e?t:e}function i(e,i,s,n){if(i===n)return!0;if(e===s){if("http"===e)return t(i,"80")===t(n,"80");if("https"===e)return t(i,"443")===t(n,"443")}return!1}var s,n,r,o,a,l=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],c=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,h=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,u="undefined"!=typeof location&&location.href,p=u&&location.protocol&&location.protocol.replace(/\:/,""),d=u&&location.hostname,m=u&&(location.port||void 0),f={},g=e.config&&e.config()||{};return s={version:"2.0.15",strip:function(e){if(e){e=e.replace(c,"");var t=e.match(h);t&&(e=t[1])}else e="";return e},jsEscape:function(e){return e.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:g.createXhr||function(){var e,t,i;if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;if("undefined"!=typeof ActiveXObject)for(t=0;t<3;t+=1){i=l[t];try{e=new ActiveXObject(i)}catch(e){}if(e){l=[i];break}}return e},parseName:function(e){var t,i,s,n=!1,r=e.lastIndexOf("."),o=0===e.indexOf("./")||0===e.indexOf("../");return r!==-1&&(!o||r>1)?(t=e.substring(0,r),i=e.substring(r+1)):t=e,s=i||t,r=s.indexOf("!"),r!==-1&&(n="strip"===s.substring(r+1),s=s.substring(0,r),i?i=s:t=s),{moduleName:t,ext:i,strip:n}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(e,t,n,r){var o,a,l,c=s.xdRegExp.exec(e);return!c||(o=c[2],a=c[3],a=a.split(":"),l=a[1],a=a[0],(!o||o===t)&&(!a||a.toLowerCase()===n.toLowerCase())&&(!l&&!a||i(o,l,t,r)))},finishLoad:function(e,t,i,n){i=t?s.strip(i):i,g.isBuild&&(f[e]=i),n(i)},load:function(e,t,i,n){if(n&&n.isBuild&&!n.inlineText)return void i();g.isBuild=n&&n.isBuild;var r=s.parseName(e),o=r.moduleName+(r.ext?"."+r.ext:""),a=t.toUrl(o),l=g.useXhr||s.useXhr;return 0===a.indexOf("empty:")?void i():void(!u||l(a,p,d,m)?s.get(a,function(t){s.finishLoad(e,r.strip,t,i)},function(e){i.error&&i.error(e)}):t([o],function(e){s.finishLoad(r.moduleName+"."+r.ext,r.strip,e,i)}))},write:function(e,t,i,n){if(f.hasOwnProperty(t)){var r=s.jsEscape(f[t]);i.asModule(e+"!"+t,"define(function () { return '"+r+"';});\n")}},writeFile:function(e,t,i,n,r){var o=s.parseName(t),a=o.ext?"."+o.ext:"",l=o.moduleName+a,c=i.toUrl(o.moduleName+a)+".js";s.load(l,i,function(t){var i=function(e){return n(c,e)};i.asModule=function(e,t){return n.asModule(e,c,t)},s.write(e,l,i,r)},r)}},"node"===g.env||!g.env&&"undefined"!=typeof process&&process.versions&&process.versions.node&&!process.versions["node-webkit"]&&!process.versions["atom-shell"]?(n=require.nodeRequire("fs"),s.get=function(e,t,i){try{var s=n.readFileSync(e,"utf8");"\ufeff"===s[0]&&(s=s.substring(1)),t(s)}catch(e){i&&i(e)}}):"xhr"===g.env||!g.env&&s.createXhr()?s.get=function(e,t,i,n){var r,o=s.createXhr();if(o.open("GET",e,!0),n)for(r in n)n.hasOwnProperty(r)&&o.setRequestHeader(r.toLowerCase(),n[r]);g.onXhr&&g.onXhr(o,e),o.onreadystatechange=function(s){var n,r;4===o.readyState&&(n=o.status||0,n>399&&n<600?(r=new Error(e+" HTTP status: "+n),r.xhr=o,i&&i(r)):t(o.responseText),g.onXhrComplete&&g.onXhrComplete(o,e))},o.send(null)}:"rhino"===g.env||!g.env&&"undefined"!=typeof Packages&&"undefined"!=typeof java?s.get=function(e,t){var i,s,n="utf-8",r=new java.io.File(e),o=java.lang.System.getProperty("line.separator"),a=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(r),n)),l="";try{for(i=new java.lang.StringBuffer,s=a.readLine(),s&&s.length()&&65279===s.charAt(0)&&(s=s.substring(1)),null!==s&&i.append(s);null!==(s=a.readLine());)i.append(o),i.append(s);l=String(i.toString())}finally{a.close()}t(l)}:("xpconnect"===g.env||!g.env&&"undefined"!=typeof Components&&Components.classes&&Components.interfaces)&&(r=Components.classes,o=Components.interfaces,Components.utils.import("resource://gre/modules/FileUtils.jsm"),a="@mozilla.org/windows-registry-key;1"in r,s.get=function(e,t){var i,s,n,l={};a&&(e=e.replace(/\//g,"\\")),n=new FileUtils.File(e);try{i=r["@mozilla.org/network/file-input-stream;1"].createInstance(o.nsIFileInputStream),i.init(n,1,0,!1),s=r["@mozilla.org/intl/converter-input-stream;1"].createInstance(o.nsIConverterInputStream),s.init(i,"utf-8",i.available(),o.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER),s.readString(i.available(),l),s.close(),i.close(),t(l.value)}catch(e){throw new Error((n&&n.path||"")+": "+e)}}),s}),define("text!res/icons/answer-code.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 78" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <rect class="icon-hollow" fill-rule="nonzero" height="32" rx="8" stroke="#000000" stroke-width="3" width="26" x="1.99768017" y="3" />\n    <rect class="icon-hollow" fill-rule="nonzero" height="32" rx="8" stroke="#000000" stroke-width="3" width="26" x="2.00695949" y="43" />\n    <rect class="icon-hollow" fill-rule="nonzero" height="32" rx="8" stroke="#000000" stroke-width="3" width="26" x="36.0069595" y="3" />\n    <rect class="icon-hollow" fill-rule="nonzero" height="32" rx="8" stroke="#000000" stroke-width="3" width="26" x="36.0069595" y="43" />\n    <path class="icon-solid" d="M9.99768017,4.5 L19.9976802,4.5 C23.587531,4.5 26.4976802,7.41014913 26.4976802,11 L26.4976802,27 C26.4976802,30.5898509 23.587531,33.5 19.9976802,33.5 L9.99768017,33.5 C6.40782929,33.5 3.49768017,30.5898509 3.49768017,27 L3.49768017,11 C3.49768017,7.41014913 6.40782929,4.5 9.99768017,4.5 Z" fill="#000000" fill-opacity="0.06" fill-rule="nonzero" />\n    <path class="icon-solid" d="M10.0069595,44.5 L20.0069595,44.5 C23.5968104,44.5 26.5069595,47.4101491 26.5069595,51 L26.5069595,67 C26.5069595,70.5898509 23.5968104,73.5 20.0069595,73.5 L10.0069595,73.5 C6.41710862,73.5 3.50695949,70.5898509 3.50695949,67 L3.50695949,51 C3.50695949,47.4101491 6.41710862,44.5 10.0069595,44.5 Z" fill="#000000" fill-opacity="0.06" fill-rule="nonzero" />\n    <path class="icon-solid" d="M44.0069595,4.5 L54.0069595,4.5 C57.5968104,4.5 60.5069595,7.41014913 60.5069595,11 L60.5069595,27 C60.5069595,30.5898509 57.5968104,33.5 54.0069595,33.5 L44.0069595,33.5 C40.4171086,33.5 37.5069595,30.5898509 37.5069595,27 L37.5069595,11 C37.5069595,7.41014913 40.4171086,4.5 44.0069595,4.5 Z" fill="#000000" fill-opacity="0.06" fill-rule="nonzero" />\n    <path class="icon-solid" d="M44.0069595,44.5 L54.0069595,44.5 C57.5968104,44.5 60.5069595,47.4101491 60.5069595,51 L60.5069595,67 C60.5069595,70.5898509 57.5968104,73.5 54.0069595,73.5 L44.0069595,73.5 C40.4171086,73.5 37.5069595,70.5898509 37.5069595,67 L37.5069595,51 C37.5069595,47.4101491 40.4171086,44.5 44.0069595,44.5 Z" fill="#000000" fill-opacity="0.06" fill-rule="nonzero" />\n    <g class="icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="2" transform="translate(9.509939, 14.000000)">\n      <line x1="3.9632236" x2="2.0122588" y1="0" y2="10" />\n      <line x1="8.9632236" x2="7.0122588" y1="0" y2="10" />\n      <line x1="10.9754824" x2="0.975482401" y1="2.5" y2="2.5" />\n      <line x1="10" x2="0" y1="7.5" y2="7.5" />\n    </g>\n    <g class="icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="2" transform="translate(43.519218, 14.000000)">\n      <line x1="3.9632236" x2="2.0122588" y1="0" y2="10" />\n      <line x1="8.9632236" x2="7.0122588" y1="0" y2="10" />\n      <line x1="10.9754824" x2="0.975482401" y1="2.5" y2="2.5" />\n      <line x1="10" x2="0" y1="7.5" y2="7.5" />\n    </g>\n    <g class="icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="2" transform="translate(9.519218, 54.000000)">\n      <line x1="3.9632236" x2="2.0122588" y1="0" y2="10" />\n      <line x1="8.9632236" x2="7.0122588" y1="0" y2="10" />\n      <line x1="10.9754824" x2="0.975482401" y1="2.5" y2="2.5" />\n      <line x1="10" x2="0" y1="7.5" y2="7.5" />\n    </g>\n    <g class="icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="2" transform="translate(43.519218, 54.000000)">\n      <line x1="3.9632236" x2="2.0122588" y1="0" y2="10" />\n      <line x1="8.9632236" x2="7.0122588" y1="0" y2="10" />\n      <line x1="10.9754824" x2="0.975482401" y1="2.5" y2="2.5" />\n      <line x1="10" x2="0" y1="7.5" y2="7.5" />\n    </g>\n  </g>\n</svg>\n'}),define("text!res/icons/answer-contact.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M59.7257,41.8419268 C59.7257,45.2919461 58.6977403,48.5837632 56.807097,51.3726244 L56.5662854,51.7185875 C56.1587895,52.2889165 56.1441955,52.6426918 56.3456185,53.4911404 L56.4446526,53.8871208 L56.558516,54.3031426 L56.6990873,54.7777601 L56.9387835,55.5414354 L57.6667835,57.7770846 L57.8447493,58.3350443 L58.0935066,59.1449905 L58.237041,59.6440304 L57.9017385,59.5230462 L57.3911237,59.3306534 L56.2962499,58.9005198 L53.8252835,57.9001069 L53.0842657,57.6074193 L52.6300556,57.4347297 L52.2186272,57.2863443 L51.8486862,57.1641394 C51.6113861,57.0911631 51.431386,57.044949 51.2645443,57.0160598 C50.8685383,56.9474898 50.5607518,56.9457969 50.1519562,57.1448401 C47.8558662,58.2628092 45.3294081,58.8516043 42.7160225,58.8516043 C36.837397,58.8516043 31.6552929,55.8694419 28.600002,51.3354091 C37.3824617,48.3036799 43.690145,39.9646876 43.690145,30.1524568 C43.690145,28.3199843 43.4701518,26.5388939 43.0551353,24.8341557 C52.2928672,25.0162761 59.7257,32.5610859 59.7257,41.8419268 Z" fill="#000000" fill-opacity="0.12" fill-rule="nonzero" />\n    <path class="icon-solid" d="M42.7160225,21.8349493 C53.7655711,21.8349493 62.723,30.7923783 62.723,41.8419268 C62.723,45.5964319 61.6850767,49.197984 59.7657905,52.3153836 L59.5213006,52.7025129 L59.3150699,53.0120046 L59.340976,53.1159938 L59.440518,53.4804202 L59.5655169,53.9020709 L59.793537,54.6282301 L60.5195296,56.8575386 L60.7050701,57.439436 L60.9656372,58.2882104 L61.1244091,58.8377857 L61.2606501,59.3451264 L61.3178693,59.5714179 L61.4186639,59.9907498 L61.4996395,60.3690588 C61.722622,61.5062797 61.6181301,62.0862302 60.9071865,62.6768336 C60.3184593,63.1659081 59.8155557,63.2234212 58.9081022,62.9964079 L58.7072771,62.9434608 L58.3193869,62.8297613 L57.8836981,62.6917054 L57.3887104,62.5240711 L56.8658424,62.3355658 L56.3152993,62.128145 L55.1860725,61.6845938 L52.7124661,60.6831412 L52.0015924,60.4022795 L51.5901245,60.2457202 L51.243002,60.1201036 L51.0215408,60.0466677 L50.4991789,60.2781556 C48.3744864,61.1762593 46.1012571,61.7016052 43.7596437,61.8221081 L43.2568519,61.8417219 L42.7160225,61.8489043 C35.4363984,61.8489043 29.064836,57.9610301 25.5644847,52.1484311 C26.6036046,51.9480854 27.6162721,51.6755728 28.598027,51.336737 C31.5940838,55.7864437 36.6334282,58.7416286 42.3543538,58.84885 L42.6762206,58.8518686 L43.1400168,58.8466999 L43.605602,58.8287691 C45.4237028,58.7352069 47.1979358,58.3548384 48.8402433,57.7179222 L49.2848083,57.5378799 L50.8658243,56.8372426 L52.2629345,57.301674 L52.6560176,57.4443492 L53.1029613,57.6146651 L53.8372542,57.9048938 L56.2818848,58.8947905 L57.3720399,59.3233087 L57.8823885,59.5159131 L58.237041,59.6440304 L58.1003174,59.167841 L57.8494211,58.3499721 L57.6695471,57.7856588 L56.9339048,55.5261785 L56.6918327,54.7539784 L56.5491398,54.2701919 L56.4325684,53.8405438 L56.086595,52.451776 L56.9870786,51.102036 L57.213439,50.74398 C58.8566665,48.0749686 59.7257,45.0133297 59.7257,41.8419268 C59.7257,32.5610859 52.2928672,25.0162761 43.0552692,24.8355649 C42.8054545,23.8083507 42.4847784,22.8092449 42.0988061,21.8432926 C42.3032001,21.8380862 42.509245,21.8349493 42.7160225,21.8349493 Z" fill="#000000" fill-rule="nonzero" />\n    <path class="icon-solid" d="M21.2853275,13.1427793 C30.679513,13.1427793 38.295005,20.7582714 38.295005,30.1524568 C38.295005,39.5466423 30.679513,47.1621343 21.2853275,47.1621343 C18.8352785,47.1621343 16.4616307,46.6446386 14.2825753,45.6587735 L13.8493938,45.4553701 C13.3711888,45.2225314 13.1003755,45.1765948 12.495963,45.3511397 L12.2149274,45.4395414 L11.8835796,45.5555282 L11.0900957,45.8513064 L10.2379321,46.1858516 L7.38105554,47.3401361 L6.59693436,47.6463392 L5.92548291,47.8975739 L5.7623108,47.9555595 L5.84316482,47.6748918 L6.05428496,46.9732763 L6.3166136,46.1434739 L7.07946729,43.7993048 L7.22624262,43.3350482 L7.40543077,42.7433458 L7.57973328,42.134503 L7.66856,41.7979167 L7.73466472,41.5077425 C7.86185202,40.878793 7.79772196,40.5656289 7.50199436,40.1255289 L7.43506462,40.0291175 C5.39105771,37.1683366 4.27565,33.7462269 4.27565,30.1524568 C4.27565,20.7582714 11.891142,13.1427793 21.2853275,13.1427793 Z" fill="#000000" fill-opacity="0.05" fill-rule="nonzero" />\n    <path class="icon-hollow" d="M21.2853275,48.6607843 C31.5071945,48.6607843 39.793655,40.3743239 39.793655,30.1524568 C39.793655,19.9305898 31.5071945,11.6441293 21.2853275,11.6441293 C11.0634605,11.6441293 2.777,19.9305898 2.777,30.1524568 C2.777,34.1602027 4.05082265,37.8704314 6.2156823,40.9003572 C6.59300671,41.4284584 3.32275269,49.2289485 4.05180479,49.8345953 C4.73611145,50.4030705 12.6602099,46.54321 13.1933339,46.8027888 C15.6378441,47.9930239 18.3836039,48.6607843 21.2853275,48.6607843 Z" stroke="#000000" stroke-linecap="round" stroke-width="2.9973" />\n    <circle class="icon-solid" cx="13.4923475" cy="31.1265793" fill="#000000" r="1.948245" />\n    <circle class="icon-solid" cx="21.2853275" cy="31.1265793" fill="#000000" r="1.948245" />\n    <circle class="icon-solid" cx="29.0783075" cy="31.1265793" fill="#000000" r="1.948245" />\n  </g>\n</svg>\n'}),define("text!res/icons/answer-email.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M49.1193192,11.0843535 L14.8806808,11.0843535 C9.16691307,11.0843535 4.5,15.381215 4.5,20.7221992 L4.5,43.2778008 C4.5,48.618785 9.16691306,52.9156465 14.8806808,52.9156465 L49.1193192,52.9156465 C54.8330869,52.9156465 59.5,48.618785 59.5,43.2778008 L59.5,20.7221992 C59.5,15.381215 54.8330869,11.0843535 49.1193192,11.0843535 Z M14.8806808,13.9889484 L49.1193192,13.9889484 C53.2800549,13.9889484 56.5954051,17.041416 56.5954051,20.7221992 L56.5954051,43.2778008 C56.5954051,46.9585841 53.2800549,50.0110516 49.1193192,50.0110516 L14.8806808,50.0110516 C10.7199451,50.0110516 7.40459488,46.9585841 7.40459488,43.2778008 L7.40459488,20.7221992 C7.40459488,17.0414159 10.7199451,13.9889484 14.8806808,13.9889484 Z" fill="#000000" fill-rule="nonzero" />\n    <path class="icon-solid" d="M49.1193192,13.9889484 C53.2800549,13.9889484 56.5954051,17.041416 56.5954051,20.7221992 L56.5954051,43.2778008 C56.5954051,46.9585841 53.2800549,50.0110516 49.1193192,50.0110516 L14.8806808,50.0110516 C10.7199451,50.0110516 7.40459488,46.9585841 7.40459488,43.2778008 L7.40459488,20.7221992 C7.40459488,17.0414159 10.7199451,13.9889484 14.8806808,13.9889484 L49.1193192,13.9889484 Z M51.2406489,20.5708889 L51.0953398,20.6564823 L32.8541311,32.2834551 C32.3801625,32.5855634 31.7857022,32.6132867 31.2893376,32.3656216 L31.1565618,32.291248 L12.5094484,20.6449199 C11.4039657,19.9544745 9.94807838,20.2909287 9.25763297,21.3964113 C8.59720694,22.4538295 8.87632607,23.8318448 9.86931342,24.5539195 L10.0091244,24.6482267 L28.6562378,36.2945548 C30.6458178,37.5371762 33.153305,37.5703706 35.1691919,36.3987725 L35.391105,36.2636371 L53.6323136,24.6366643 C54.7314105,23.9360984 55.0544837,22.4771833 54.3539177,21.3780864 C53.6838111,20.3267763 52.3198653,19.9854766 51.2406489,20.5708889 Z" fill="#000000" fill-opacity="0.07" fill-rule="nonzero" />\n    <path class="icon-hollow" d="M11.2592864,33.1366017 L29.9063998,21.4902735 C31.1980643,20.6835455 32.8384148,20.6910759 34.1226181,21.5096289 L52.3638267,33.1366017 L52.3638267,33.1366017" fill-rule="nonzero" stroke="#000000" stroke-linecap="round" stroke-width="3" transform="translate(31.811557, 27.013515) scale(-1, 1) rotate(-180.000000) translate(-31.811557, -27.013515) " />\n  </g>\n</svg>\n'}),define("text!res/icons/app-notice-dismiss.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M32,6.5 C46.0832611,6.5 57.5,17.9167389 57.5,32 C57.5,46.0832611 46.0832611,57.5 32,57.5 C17.9167389,57.5 6.5,46.0832611 6.5,32 C6.5,17.9167389 17.9167389,6.5 32,6.5 Z M25.9142136,23.0857864 C25.133165,22.3047379 23.866835,22.3047379 23.0857864,23.0857864 C22.3047379,23.866835 22.3047379,25.133165 23.0857864,25.9142136 L23.0857864,25.9142136 L29.096,31.924 L23.0857864,37.9350288 L22.9689537,38.0622436 C22.3069014,38.848031 22.3458457,40.0235152 23.0857864,40.763456 L23.0857864,40.763456 L23.2130012,40.8802887 C23.9987886,41.542341 25.1742728,41.5033967 25.9142136,40.763456 L25.9142136,40.763456 L31.924,34.753 L37.9350288,40.763456 C38.7160774,41.5445046 39.9824074,41.5445046 40.763456,40.763456 C41.5445046,39.9824074 41.5445046,38.7160774 40.763456,37.9350288 L40.763456,37.9350288 L34.753,31.924 L40.763456,25.9142136 L40.8802887,25.7869988 C41.542341,25.0012114 41.5033967,23.8257272 40.763456,23.0857864 L40.763456,23.0857864 L40.6362412,22.9689537 C39.8504538,22.3069014 38.6749696,22.3458457 37.9350288,23.0857864 L37.9350288,23.0857864 L31.924,29.096 L25.9142136,23.0857864 Z" fill="#000000" fill-rule="nonzero" />\n  </g>\n</svg>\n'}),define("text!res/icons/app-notice-launch.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M32,6.5 C46.0832611,6.5 57.5,17.9167389 57.5,32 C57.5,46.0832611 46.0832611,57.5 32,57.5 C17.9167389,57.5 6.5,46.0832611 6.5,32 C6.5,17.9167389 17.9167389,6.5 32,6.5 Z M21.1870482,40.3991506 C20.867478,40.0482926 20.3239886,40.0229288 19.9731306,40.342499 L19.9731306,40.342499 L18.0130015,42.1278332 L17.8748911,42.2725086 C17.6631479,42.5278711 17.5452172,42.8507788 17.5452172,43.1866409 L17.5452172,43.1866409 L17.5452172,46.4547828 L20.7010752,46.4547828 L20.9019514,46.4406338 C21.2326157,46.3938005 21.5389238,46.2323602 21.7652479,45.9810752 L21.7652479,45.9810752 L23.597269,43.9470032 L23.690353,43.8229661 C23.9045632,43.4764121 23.8472985,43.0157383 23.5338444,42.7334206 L23.5338444,42.7334206 L23.4098073,42.6403366 C23.0632533,42.4261265 22.6025795,42.4833912 22.3202618,42.7968452 L22.3202618,42.7968452 L20.571817,44.735281 L19.2630389,44.735281 L19.2630389,43.3122579 L21.1303966,41.6130683 L21.2352672,41.498823 C21.4826325,41.1751008 21.4711106,40.7110244 21.1870482,40.3991506 Z M45.2857142,18.7142858 C40.2894453,19.0636483 36.7364953,20.231787 34.6268642,22.218702 C33.1689943,23.5917685 30.8497694,26.173861 27.6691896,29.9649794 L27.6691896,29.9649794 L22.2878955,29.9645989 L22.1813246,29.971644 C21.9707398,29.9996245 21.7779316,30.1097478 21.6467141,30.2804322 L21.6467141,30.2804322 L19.8367972,32.6347247 L19.7757637,32.726229 C19.5776244,33.0718298 19.6604504,33.5192814 19.9850556,33.7688292 C20.0795426,33.8414683 20.1889162,33.8923267 20.3053511,33.9177658 L20.3053511,33.9177658 L23.7798292,34.6759989 C23.6402568,34.8473006 23.4995338,35.0202174 23.3576602,35.1947492 C23.1469474,35.4539664 23.122039,35.8069804 23.2724109,36.0872826 L23.2724109,36.0872826 L22.1824036,38.2677498 C22.0501429,38.5780798 22.124068,38.937958 22.3679212,39.1708772 L22.3679212,39.1708772 L25.0030303,41.6878316 C25.2411304,41.9152556 25.5931958,41.9755714 25.8933383,41.840359 L25.8933383,41.840359 L28.235,40.786 L28.3481295,40.817408 C28.5413697,40.8568795 28.7466804,40.825314 28.9223749,40.721164 L29.0239041,40.6499515 C29.324069,40.4032992 29.6195083,40.1598329 29.9102221,39.9195525 L29.9102221,39.9195525 L30.666194,43.4618025 C30.6913029,43.5794385 30.7423356,43.6899925 30.8155747,43.7854112 C31.087537,44.1397345 31.5952419,44.2065012 31.9495652,43.9345388 L31.9495652,43.9345388 L34.3011531,42.1295673 C34.500575,41.9765002 34.617478,41.7394016 34.617478,41.4880082 L34.617478,41.4880082 L34.6183735,35.9509651 C39.3976555,31.8251293 42.2090482,29.0260331 43.0525515,27.5536764 C44.2097418,25.5337712 44.9541293,22.5873077 45.2857142,18.7142858 Z M38.088339,23.8744505 C39.195693,23.8744505 40.0933808,24.7728945 40.0933808,25.8811812 C40.0933808,26.989468 39.195693,27.8879119 38.088339,27.8879119 C36.980985,27.8879119 36.0832972,26.989468 36.0832972,25.8811812 C36.0832972,24.7728945 36.980985,23.8744505 38.088339,23.8744505 Z" fill="#000000" fill-rule="nonzero" />\n  </g>\n</svg>\n';
}),define("text!res/icons/app-notice-pause.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M32,6.5 C46.0832611,6.5 57.5,17.9167389 57.5,32 C57.5,46.0832611 46.0832611,57.5 32,57.5 C17.9167389,57.5 6.5,46.0832611 6.5,32 C6.5,17.9167389 17.9167389,6.5 32,6.5 Z M41.2537165,21.6075032 L35.5885587,21.6075032 C34.88992,21.6075032 34.3271237,22.1756118 34.3271237,22.8764093 L34.3271237,22.8764093 L34.3271237,41.1235907 C34.3271237,41.8365485 34.8918874,42.3924968 35.5885587,42.3924968 L35.5885587,42.3924968 L41.2537165,42.3924968 C41.9523552,42.3924968 42.5151515,41.8243882 42.5151515,41.1235907 L42.5151515,41.1235907 L42.5151515,22.8764093 C42.5151515,22.1634515 41.9503878,21.6075032 41.2537165,21.6075032 L41.2537165,21.6075032 Z M28.4114413,21.6075032 L22.7462835,21.6075032 C22.0476448,21.6075032 21.4848485,22.1756118 21.4848485,22.8764093 L21.4848485,22.8764093 L21.4848485,41.1235907 C21.4848485,41.8365485 22.0496122,42.3924968 22.7462835,42.3924968 L22.7462835,42.3924968 L28.4114413,42.3924968 C29.11008,42.3924968 29.6728763,41.8243882 29.6728763,41.1235907 L29.6728763,41.1235907 L29.6728763,22.8764093 C29.6728763,22.1634515 29.1081126,21.6075032 28.4114413,21.6075032 L28.4114413,21.6075032 Z" fill="#000000" fill-rule="nonzero" />\n  </g>\n</svg>\n'}),define("text!res/icons/arrow-curl.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'>\n  <g stroke='none' stroke-width='1' fill='none' fill-rule='evenodd'>\n    <path d='M31.07859,1.36007788 C32.1397555,0.669470487 33,1.13181976 33,2.39064224 L33,21.6179193 C33,22.8776916 32.1429788,23.3411888 31.07859,22.6484836 L16.6444555,13.254736 C15.5832901,12.5641287 15.5800667,11.4465306 16.6444555,10.7538254 L31.07859,1.36007788 Z' fill='#000000' class='icon-solid' />\n    <path d='M52.1162397,57.0097367 C56.3967832,52.231765 59,45.9198894 59,39 C59,24.0883118 46.9116882,12 32,12' stroke='#000000' stroke-width='6' stroke-linecap='round' class='icon-hollow' />\n  </g>\n</svg>\n"}),define("text!res/icons/block-strap-dismiss.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M28.1963297,6 L35.8036703,6 C42.7729744,6 45.858278,6.8354305 48.7916113,8.40419433 C51.7249447,9.97295817 54.0270418,12.2750553 55.5958057,15.2083887 C57.1645695,18.141722 58,21.2270256 58,28.1963297 L58,35.8036703 C58,42.7729744 57.1645695,45.858278 55.5958057,48.7916113 C54.0270418,51.7249447 51.7249447,54.0270418 48.7916113,55.5958057 C45.858278,57.1645695 42.7729744,58 35.8036703,58 L28.1963297,58 C21.2270256,58 18.141722,57.1645695 15.2083887,55.5958057 C12.2750553,54.0270418 9.97295817,51.7249447 8.40419433,48.7916113 C6.8354305,45.858278 6,42.7729744 6,35.8036703 L6,28.1963297 C6,21.2270256 6.8354305,18.141722 8.40419433,15.2083887 C9.97295817,12.2750553 12.2750553,9.97295817 15.2083887,8.40419433 C18.141722,6.8354305 21.2270256,6 28.1963297,6 Z" fill="#000000" fill-opacity="0.15" />\n    <path d="M27.3431458,24.5147186 L32.9999322,30.1709322 L38.6568542,24.5147186 C39.4379028,23.73367 40.7042328,23.73367 41.4852814,24.5147186 C42.26633,25.2957672 42.26633,26.5620972 41.4852814,27.3431458 L35.8289322,32.9999322 L41.4852814,38.6568542 C42.26633,39.4379028 42.26633,40.7042328 41.4852814,41.4852814 C40.7042328,42.26633 39.4379028,42.26633 38.6568542,41.4852814 L32.9999322,35.8289322 L27.3431458,41.4852814 C26.5620972,42.26633 25.2957672,42.26633 24.5147186,41.4852814 C23.73367,40.7042328 23.73367,39.4379028 24.5147186,38.6568542 L30.1709322,32.9999322 L24.5147186,27.3431458 C23.73367,26.5620972 23.73367,25.2957672 24.5147186,24.5147186 C25.2957672,23.73367 26.5620972,23.73367 27.3431458,24.5147186 Z" fill="#FFFFFF" />\n    <path class="icon-solid" d="M26.3431458,23.5147186 L31.9999322,29.1709322 L37.6568542,23.5147186 C38.4379028,22.73367 39.7042328,22.73367 40.4852814,23.5147186 C41.26633,24.2957672 41.26633,25.5620972 40.4852814,26.3431458 L34.8289322,31.9999322 L40.4852814,37.6568542 C41.26633,38.4379028 41.26633,39.7042328 40.4852814,40.4852814 C39.7042328,41.26633 38.4379028,41.26633 37.6568542,40.4852814 L31.9999322,34.8289322 L26.3431458,40.4852814 C25.5620972,41.26633 24.2957672,41.26633 23.5147186,40.4852814 C22.73367,39.7042328 22.73367,38.4379028 23.5147186,37.6568542 L29.1709322,31.9999322 L23.5147186,26.3431458 C22.73367,25.5620972 22.73367,24.2957672 23.5147186,23.5147186 C24.2957672,22.73367 25.5620972,22.73367 26.3431458,23.5147186 Z" fill="#000000" />\n  </g>\n</svg>\n'}),define("text!res/icons/block-strap-chevron.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M28.1963297,6 L35.8036703,6 C42.7729744,6 45.858278,6.8354305 48.7916113,8.40419433 C51.7249447,9.97295817 54.0270418,12.2750553 55.5958057,15.2083887 C57.1645695,18.141722 58,21.2270256 58,28.1963297 L58,35.8036703 C58,42.7729744 57.1645695,45.858278 55.5958057,48.7916113 C54.0270418,51.7249447 51.7249447,54.0270418 48.7916113,55.5958057 C45.858278,57.1645695 42.7729744,58 35.8036703,58 L28.1963297,58 C21.2270256,58 18.141722,57.1645695 15.2083887,55.5958057 C12.2750553,54.0270418 9.97295817,51.7249447 8.40419433,48.7916113 C6.8354305,45.858278 6,42.7729744 6,35.8036703 L6,28.1963297 C6,21.2270256 6.8354305,18.141722 8.40419433,15.2083887 C9.97295817,12.2750553 12.2750553,9.97295817 15.2083887,8.40419433 C18.141722,6.8354305 21.2270256,6 28.1963297,6 Z" fill="#000000" fill-opacity="0.15" />\n    <path d="M30,24 L38.6320776,32.3359004 C39.029358,32.7195497 39.0404083,33.3526182 38.656759,33.7498986 L30.3208586,42.3819762" stroke="#FFFFFF" stroke-linecap="round" stroke-width="3" />\n    <path class="icon-hollow" d="M28.5465698,23.2966712 L37.1786474,31.6325716 C37.5759278,32.0162208 37.586978,32.6492894 37.2033288,33.0465698 L28.8674284,41.6786474" stroke="#000000" stroke-linecap="round" stroke-width="4" />\n  </g>\n</svg>\n'}),define("text!res/icons/block-strap-jump.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M28.1963297,6 L35.8036703,6 C42.7729744,6 45.858278,6.8354305 48.7916113,8.40419433 C51.7249447,9.97295817 54.0270418,12.2750553 55.5958057,15.2083887 C57.1645695,18.141722 58,21.2270256 58,28.1963297 L58,35.8036703 C58,42.7729744 57.1645695,45.858278 55.5958057,48.7916113 C54.0270418,51.7249447 51.7249447,54.0270418 48.7916113,55.5958057 C45.858278,57.1645695 42.7729744,58 35.8036703,58 L28.1963297,58 C21.2270256,58 18.141722,57.1645695 15.2083887,55.5958057 C12.2750553,54.0270418 9.97295817,51.7249447 8.40419433,48.7916113 C6.8354305,45.858278 6,42.7729744 6,35.8036703 L6,28.1963297 C6,21.2270256 6.8354305,18.141722 8.40419433,15.2083887 C9.97295817,12.2750553 12.2750553,9.97295817 15.2083887,8.40419433 C18.141722,6.8354305 21.2270256,6 28.1963297,6 Z" fill="#000000" fill-opacity="0.15" />\n    <path d="M42.0097123,37.6854801 C42.4332832,38.3400897 42.2819226,39.2012202 41.682788,39.6754692 L41.565234,39.7597123 L33.0058129,45.2964987 L32.9145138,45.3454657 L32.7884171,45.4008584 L32.6845149,45.4365053 L32.5107481,45.4779769 L32.4235968,45.4906055 L32.2996289,45.4997488 L32.1321512,45.4957695 L31.9894525,45.4774986 L31.8409905,45.4434364 L31.6835231,45.389465 L31.5603162,45.3324254 L31.4928483,45.2954062 L22.9353016,39.7597123 C22.2397789,39.3096682 22.0407792,38.3810028 22.4908233,37.6854801 C22.9143942,37.0308705 23.7619341,36.8160875 24.4400408,37.1682887 L24.5650554,37.2410018 L32.25,42.2131785 L39.9354801,37.2410018 C40.6310028,36.7909577 41.5596682,36.9899574 42.0097123,37.6854801 Z" fill="#FFFFFF" fill-rule="nonzero" />\n    <path class="icon-solid" d="M41.7595338,37.1853016 C42.1831047,37.8399112 42.031744,38.7010416 41.4326095,39.1752907 L41.3150554,39.2595338 L32.7556344,44.7963202 L32.6643352,44.8452871 L32.5382386,44.9006799 L32.4343364,44.9363268 L32.2605696,44.9777984 L32.1734183,44.990427 L32.0494503,44.9995703 L31.8819727,44.9955909 L31.739274,44.9773201 L31.590812,44.9432579 L31.4333446,44.8892865 L31.3101377,44.8322469 L31.2426698,44.7952277 L22.6851231,39.2595338 C21.9896004,38.8094897 21.7906007,37.8808243 22.2406448,37.1853016 C22.6642157,36.530692 41.3094897,36.4897789 41.7595338,37.1853016 Z" fill="#000000" fill-rule="nonzero" />\n    <path d="M42.2597123,28.8144472 C42.6832832,28.1598376 42.5319226,27.2987072 41.932788,26.8244581 L41.815234,26.740215 L33.2558129,21.2034286 L33.1645138,21.1544616 L33.0384171,21.0990689 L32.9345149,21.063422 L32.7607481,21.0219504 L32.6735968,21.0093218 L32.5496289,21.0001785 L32.3821512,21.0041578 L32.2394525,21.0224287 L32.0909905,21.0564909 L31.9335231,21.1104623 L31.8103162,21.1675019 L31.7428483,21.2045211 L23.1853016,26.740215 C22.4897789,27.1902591 22.2907792,28.1189245 22.7408233,28.8144472 C23.1643942,29.4690568 41.8096682,29.5099699 42.2597123,28.8144472 Z" fill="#FFFFFF" fill-rule="nonzero" />\n    <path class="icon-solid" d="M41.7595338,28.3142687 C42.1831047,27.6596591 42.031744,26.7985286 41.4326095,26.3242796 L41.3150554,26.2400365 L32.7556344,20.7032501 L32.6643352,20.6542831 L32.5382386,20.5988904 L32.4343364,20.5632434 L32.2605696,20.5217719 L32.1734183,20.5091432 L32.0494503,20.5 L31.8819727,20.5039793 L31.739274,20.5222502 L31.590812,20.5563124 L31.4333446,20.6102838 L31.3101377,20.6673234 L31.2426698,20.7043426 L22.6851231,26.2400365 C21.9896004,26.6900806 21.7906007,27.618746 22.2406448,28.3142687 C22.6642157,28.9688783 41.3094897,29.0097914 41.7595338,28.3142687 Z" fill="#000000" fill-rule="nonzero" />\n  </g>\n</svg>\n'}),define("text!res/icons/block-strap-add.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M28.1963297,6 L35.8036703,6 C42.7729744,6 45.858278,6.8354305 48.7916113,8.40419433 C51.7249447,9.97295817 54.0270418,12.2750553 55.5958057,15.2083887 C57.1645695,18.141722 58,21.2270256 58,28.1963297 L58,35.8036703 C58,42.7729744 57.1645695,45.858278 55.5958057,48.7916113 C54.0270418,51.7249447 51.7249447,54.0270418 48.7916113,55.5958057 C45.858278,57.1645695 42.7729744,58 35.8036703,58 L28.1963297,58 C21.2270256,58 18.141722,57.1645695 15.2083887,55.5958057 C12.2750553,54.0270418 9.97295817,51.7249447 8.40419433,48.7916113 C6.8354305,45.858278 6,42.7729744 6,35.8036703 L6,28.1963297 C6,21.2270256 6.8354305,18.141722 8.40419433,15.2083887 C9.97295817,12.2750553 12.2750553,9.97295817 15.2083887,8.40419433 C18.141722,6.8354305 21.2270256,6 28.1963297,6 Z" fill="#000000" fill-opacity="0.15" />\n    <line stroke="#FFFFFF" stroke-linecap="round" stroke-width="4" x1="22.75" x2="42.75" y1="32.75" y2="32.75" />\n    <line stroke="#FFFFFF" stroke-linecap="round" stroke-width="4" x1="32.75" x2="32.75" y1="22.75" y2="42.75" />\n    <line class="icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="4" x1="22" x2="42" y1="32" y2="32" />\n    <line class="icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="4" x1="32" x2="32" y1="22" y2="42" />\n  </g>\n</svg>\n'}),define("text!res/icons/block-strap-alert.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M35.8036703,6 C42.7729744,6 45.858278,6.8354305 48.7916113,8.40419433 C51.7249447,9.97295817 54.0270418,12.2750553 55.5958057,15.2083887 C57.1645695,18.141722 58,21.2270256 58,28.1963297 L58,35.8036703 C58,42.7729744 57.1645695,45.858278 55.5958057,48.7916113 C54.0270418,51.7249447 51.7249447,54.0270418 48.7916113,55.5958057 C45.858278,57.1645695 42.7729744,58 35.8036703,58 L28.1963297,58 C21.2270256,58 18.141722,57.1645695 15.2083887,55.5958057 C12.2750553,54.0270418 9.97295817,51.7249447 8.40419433,48.7916113 C6.8354305,45.858278 6,42.7729744 6,35.8036703 L6,28.1963297 C6,21.2270256 6.8354305,18.141722 8.40419433,15.2083887 C9.97295817,12.2750553 12.2750553,9.97295817 15.2083887,8.40419433 C18.141722,6.8354305 21.2270256,6 28.1963297,6 L35.8036703,6 Z M32,40.9833332 C30.3431458,40.9833332 29,42.22316 29,43.7525639 L29,43.7525639 L29,44.2141024 L29.0050927,44.3768157 C29.0963391,45.830484 30.4023191,46.9833332 32,46.9833332 C33.6568542,46.9833332 35,45.7435063 35,44.2141024 L35,44.2141024 L35,43.7525639 L34.9949073,43.5898506 C34.9036609,42.1361824 33.5976809,40.9833332 32,40.9833332 Z M32,17 C30.0670034,17 28.5,18.7519292 28.5,20.9130435 C28.5025397,31.6376812 29.6692064,37 32,37 C34.3307936,37 35.4974603,31.6376812 35.5,20.9130435 L35.5,20.9130435 L35.4961905,20.7288385 C35.4101582,18.6532491 33.8777681,17 32,17 Z" fill="#000000" />\n  </g>\n</svg>\n'}),define("text!res/icons/card-actions.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M32,1 C49.1208272,1 63,14.8791728 63,32 C63,49.1208272 49.1208272,63 32,63 C14.8791728,63 1,49.1208272 1,32 C1,14.8791728 14.8791728,1 32,1 Z M32,28.5 C30.0670034,28.5 28.5,30.0670034 28.5,32 C28.5,33.9329966 30.0670034,35.5 32,35.5 C33.9329966,35.5 35.5,33.9329966 35.5,32 C35.5,30.0670034 33.9329966,28.5 32,28.5 Z M20,28.5 C18.0670034,28.5 16.5,30.0670034 16.5,32 C16.5,33.9329966 18.0670034,35.5 20,35.5 C21.9329966,35.5 23.5,33.9329966 23.5,32 C23.5,30.0670034 21.9329966,28.5 20,28.5 Z M44,28.5 C42.0670034,28.5 40.5,30.0670034 40.5,32 C40.5,33.9329966 42.0670034,35.5 44,35.5 C45.9329966,35.5 47.5,33.9329966 47.5,32 C47.5,30.0670034 45.9329966,28.5 44,28.5 Z" fill="#000000" />\n  </g>\n</svg>\n'}),define("text!res/icons/card-expired.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M32,1 C49.1208272,1 63,14.8791728 63,32 C63,49.1208272 49.1208272,63 32,63 C14.8791728,63 1,49.1208272 1,32 C1,14.8791728 14.8791728,1 32,1 Z" fill="#000000" />\n    <path d="M32.0001524,44.013183 C30.3818685,44.013183 29.0699903,45.3250613 29.0699903,46.9433451 C29.0699903,48.5616289 30.3818685,49.8735071 32.0001524,49.8735071 C33.6184362,49.8735071 34.9303144,48.5616289 34.9303144,46.9433451 C34.9303144,45.3250613 33.6184362,44.013183 32.0001524,44.013183 Z" fill="#FFFFFF" />\n    <path d="M32.1965109,14.1313182 L31.9152296,14.1264929 L31.8343408,14.1293808 C30.0245462,14.2155615 28.6125478,15.7007385 28.59412,17.4895453 L28.5978579,17.6894955 L29.5445238,37.5694797 C29.6069427,38.8802762 30.6878706,39.9109561 32.0001524,39.9109561 C33.2527849,39.9109561 34.2946178,38.9718448 34.4410301,37.746418 L34.4557809,37.5694797 L35.4020689,17.6974318 L35.40588,17.5352459 C35.40588,15.7193666 33.9863926,14.2350264 32.1965109,14.1313182 L32.1965109,14.1313182 Z" fill="#FFFFFF" />\n  </g>\n</svg>\n'}),define("text!res/icons/chevron-left.svg",[],function(){return"<svg viewBox='0 0 32 64' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'>\n  <g stroke='#000000' stroke-width='4' stroke-linecap='round' fill='none' fill-rule='evenodd' class='icon-hollow'>\n    <polyline points='27.627417 54.254834 5 31.627417 27.627417 9 27.627417 9' />\n  </g>\n</svg>\n"}),define("text!res/icons/chevron-right.svg",[],function(){return"<svg viewBox='0 0 32 64' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'>\n  <g stroke='#000000' stroke-width='4' stroke-linecap='round' fill='none' fill-rule='evenodd' class='icon-hollow'>\n    <polyline points='4.627417 54.254834 27.254834 31.627417 4.627417 9 4.627417 9' />\n  </g>\n</svg>\n"}),define("text!res/icons/cog.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M48.6266364,4.16495783 C49.0198333,4.34830854 49.2515908,4.76269301 49.2019888,5.1936929 L48.1899875,14.017537 C49.3525383,15.0634716 50.3997142,16.2112169 51.324019,17.4401774 L60.2035531,17.1997935 C60.637236,17.1879444 61.0298446,17.454936 61.1782283,17.8626167 L63.4391544,24.0744603 C63.5875381,24.482141 63.4584013,24.9390324 63.1185645,25.2087214 L56.1620041,30.7336036 C56.2437945,32.2687261 56.1793412,33.8205982 55.9611544,35.3686425 L62.40825,41.4775973 C62.7232887,41.7758788 62.8121134,42.2422866 62.6287626,42.6354835 L59.8350422,48.6266364 C59.6516915,49.0198333 59.237307,49.2515908 58.8063071,49.2019888 L49.982463,48.1899875 C48.9365284,49.3525383 47.7887831,50.3997142 46.5598226,51.324019 L46.8002065,60.2035531 C46.8120556,60.637236 46.545064,61.0298446 46.1373833,61.1782283 L39.9255397,63.4391544 C39.517859,63.5875381 39.0609676,63.4584013 38.7912786,63.1185645 L33.2677688,56.1619309 C31.7321988,56.2438329 30.1798632,56.1794062 28.6313575,55.9611544 L22.5224027,62.40825 C22.2241212,62.7232887 21.7577134,62.8121134 21.3645165,62.6287626 L15.3733636,59.8350422 C14.9801667,59.6516915 14.7484092,59.237307 14.7980112,58.8063071 L15.8100125,49.982463 C14.647808,48.93684 13.6009097,47.7894669 12.6768072,46.5609209 L3.79644688,46.8002065 C3.36276398,46.8120556 2.97015536,46.545064 2.82177172,46.1373833 L0.560845575,39.9255397 C0.412461935,39.517859 0.541598679,39.0609676 0.881435522,38.7912786 L7.83806909,33.2677688 C7.75616705,31.7321988 7.82059383,30.1798632 8.03884562,28.6313575 L1.59174998,22.5224027 C1.27671127,22.2241212 1.18788664,21.7577134 1.37123735,21.3645165 L4.16495783,15.3733636 C4.34830854,14.9801667 4.76269301,14.7484092 5.1936929,14.7980112 L14.017537,15.8100125 C15.06316,14.647808 16.2105331,13.6009097 17.4390791,12.6768072 L17.1997935,3.79644688 C17.1879444,3.36276398 17.454936,2.97015536 17.8626167,2.82177172 L24.0744603,0.560845575 C24.482141,0.412461935 24.9390324,0.541598679 25.2087214,0.881435522 L30.7336036,7.83799593 C32.2687261,7.75620545 33.8205982,7.82065885 35.3686425,8.03884562 L41.4775973,1.59174998 C41.7758788,1.27671127 42.2422866,1.18788664 42.6354835,1.37123735 L48.6266364,4.16495783 Z M38.3001681,18.4891376 L33.9812979,17.8821136 C33.3806217,17.7974521 32.775979,17.7518897 32.170629,17.7452536 L31.2624808,17.7644725 L26.9033466,17.9970599 L23.4145518,20.6208851 C22.9301811,20.9852249 22.4700698,21.3799106 22.0368255,21.8029796 L21.4074353,22.4586253 L18.4891763,25.6997489 L17.8821136,30.0187021 C17.797427,30.6195565 17.7518627,31.2243797 17.7452477,31.8299094 L17.7645155,32.7383261 L17.9954959,37.092167 L20.6208851,40.5854482 C20.9852249,41.0698189 21.3799106,41.5299302 21.8029796,41.9631745 L22.4586253,42.5925647 L25.701188,45.5077376 L30.0187021,46.1178864 C30.6195565,46.202573 31.2243797,46.2481373 31.8299094,46.2547523 L32.7383261,46.2354845 L37.0966091,46.0028184 L40.5848024,43.3796006 C41.0693379,43.0151801 41.529601,42.6203946 41.9629818,42.1972086 L42.5925647,41.5413747 L45.5091767,38.295726 L46.1178864,33.9812979 C46.2025479,33.3806217 46.2481103,32.775979 46.2547464,32.170629 L46.2355275,31.2624808 L46.0012544,26.8989045 L43.3796006,23.4151976 C43.0151801,22.9306621 42.6203946,22.470399 42.1972086,22.0370182 L41.5413747,21.4074353 L38.3001681,18.4891376 Z" fill="#000000" fill-rule="nonzero" />\n  </g>\n</svg>\n'}),define("text!res/icons/download-ring.svg",[],function(){return'<svg version="1.1" viewBox="0 0 96 96" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="download-ring-track icon-hollow" d="M48,19 C63.463973,19 76,31.536027 76,47 C76,62.463973 63.463973,75 48,75 C32.536027,75 20,62.463973 20,47 C20,31.5615698 32.4946481,19.0414211 47.9233955,19" stroke="#000000" stroke-linecap="round" stroke-width="3" />\n    <path class="download-ring-circuit icon-solid icon-hollow" d="M48,19 C63.463973,19 76,31.536027 76,47 C76,62.463973 63.463973,75 48,75 C32.536027,75 20,62.463973 20,47 C20,31.5615698 32.4946481,19.0414211 47.9233955,19" fill="#000000" fill-opacity="0.1" stroke="#000000" stroke-linecap="round" stroke-width="3" />\n    <path class="download-ring-retry icon-hollow" d="M58.5474935,55.4712205 C56.3810587,51.8975672 52.4545878,49.5095932 47.9703757,49.5095932 C43.5267446,49.5095932 39.6308055,51.8545417 37.4525065,55.3744909" stroke="#000000" stroke-linecap="round" stroke-width="3" />\n    <g class="download-ring-complete icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="3" transform="translate(39.650000, 41.416054)">\n      <path d="M11.4284414,-2.13891776 C11.4250296,0.0692304459 11.4233237,2.71890172 11.4233237,5.81009606 C11.4233237,8.9012904 11.4250296,11.9925736 11.4284414,15.0839455" transform="translate(11.425883, 6.472514) rotate(-317.000000) translate(-11.425883, -6.472514) " />\n      <path d="M2.83736926,7.08394552 C2.84430259,7.98141751 2.84776926,9.05834059 2.84776926,10.3147148 C2.84776926,11.5710889 2.84430259,12.8274992 2.83736926,14.0839455" transform="translate(2.842569, 10.583946) scale(-1, 1) rotate(-315.000000) translate(-2.842569, -10.583946) " />\n    </g>\n    <path class="download-ring-stop icon-solid" d="M53.4227773,42.3440274 C53.9785662,42.9007433 54.0117116,53.0625132 53.4276802,53.6500726 C52.8436291,54.2375579 42.6949503,54.2429219 42.1088162,53.6574836 C41.5522322,53.1015612 41.5252893,43.0207664 42.0267908,42.4304505 L42.1299642,42.3196978 C42.6331998,41.8213084 52.8374773,41.7577541 53.4227773,42.3440274 Z" fill="#000000" fill-rule="nonzero" />\n    <g class="download-ring-pause icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="3" transform="translate(43.500000, 44.500000)">\n      <path d="M8.42504,0 C8.42365333,0.897471994 8.42296,1.97439507 8.42296,3.23076923 C8.42296,4.48714339 8.42365333,5.74355365 8.42504,7" />\n      <path d="M0.5148,0 C0.521733333,0.897471994 0.5252,1.97439507 0.5252,3.23076923 C0.5252,4.48714339 0.521733333,5.74355365 0.5148,7" transform="translate(0.520000, 3.500000) scale(-1, 1) translate(-0.520000, -3.500000) " />\n    </g>\n    <path class="download-ring-start icon-solid" d="M47.896,37.984 L48.0310893,37.9790866 C48.7435625,37.9793826 49.3558927,38.5185139 49.4545741,39.2491125 L49.4669876,39.4553947 L49.4638312,53.4621103 L53.9048302,48.6582771 C54.3714037,48.1922426 55.1120405,48.1102902 55.6900604,48.4680987 L55.8103039,48.5502238 L55.96585,48.6888674 C56.4552499,49.1795705 56.5109507,49.9843822 56.0743909,50.5717251 L55.9295585,50.7373375 L54.7124034,52.0012127 L53.9478506,52.7851549 L53.2275062,53.5148022 L52.4904716,54.2505136 L51.7540414,54.9725129 L51.0807848,55.617543 L50.667315,56.0043309 L50.2806544,56.3578021 L49.7504994,56.82563 L49.4329155,57.0935244 L49.1411903,57.3286878 L48.8047001,57.5822326 L48.5001684,57.7881734 L48.4410371,57.8244466 L48.2532255,57.9290078 L48.183349,57.9622542 L48.0678751,58.0061601 C48.0356211,58.0158428 48.0101657,58.0206174 47.9931929,58.0206174 C47.9328697,58.0206174 47.775949,57.9589518 47.5518559,57.8234331 L47.3625665,57.7023266 L47.1586908,57.5595614 L46.9317589,57.3896618 L46.5480256,57.0830031 L46.1176468,56.7178789 L45.8049202,56.4420753 L45.4695645,56.1385915 L45.1128648,55.8085155 L44.5371004,55.262906 L43.6947185,54.4425078 L43.0069997,53.7577941 L42.2697227,53.0121521 L41.2094269,51.9232541 L40.0605913,50.7262373 C39.4883954,50.1540455 39.4883954,49.235913 40.0548138,48.6696177 C40.5648924,48.1596501 41.3699292,48.1039557 41.9574236,48.5404382 L42.1320863,48.6945609 L46.5639016,53.4610383 L46.5652597,39.4295178 L46.5720133,39.2889013 C46.6345704,38.6407835 47.1250161,38.1130019 47.7630404,38.0012344 L47.896,37.984 Z" fill="#000000" fill-rule="nonzero" />\n  </g>\n</svg>\n'}),define("text!res/icons/filter-cloud-decal.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-linecap="round" stroke-width="1">\n    <path class="icon-solid icon-hollow" d="M23.6944645,2.23984185 C25.1401074,1.76768951 26.7658704,1.84703135 28.2290988,2.58977961 C29.5280782,3.41313081 30.7495172,3.80252733 31.936252,3.83513569 C33.1043176,3.86723108 34.2327677,3.55084414 35.2165835,2.90981509 C36.5914365,2.01399622 38.1992347,1.76025376 39.6872744,2.07417929 C41.175314,2.38810482 42.5435951,3.26969834 43.439414,4.64455142 C44.1526875,6.00708416 45.0157865,6.95503096 46.0272247,7.576638 C47.0227516,8.18846624 48.1582114,8.47869214 49.3307354,8.4154526 C50.9693026,8.32707724 52.4885679,8.91122892 53.6202852,9.92711623 C54.7520026,10.9430035 55.496172,12.3906265 55.5845474,14.0291936 C55.520994,15.5658183 55.7944863,16.8183138 56.359614,17.8623604 C56.9158514,18.8899826 57.7540755,19.7090556 58.8011309,20.2405505 C60.2643593,20.9832988 61.2880058,22.2488216 61.7601581,23.6944645 C62.2323105,25.1401074 62.1529687,26.7658704 61.4102204,28.2290988 C60.5868692,29.5280782 60.1974727,30.7495172 60.1648643,31.936252 C60.1327689,33.1043176 60.4491559,34.2327677 61.0901849,35.2165835 C61.9860038,36.5914365 62.2397462,38.1992347 61.9258207,39.6872744 C61.6118952,41.175314 60.7303017,42.5435951 59.3554486,43.439414 C57.9929158,44.1526875 57.044969,45.0157865 56.423362,46.0272247 C55.8115338,47.0227516 55.5213079,48.1582114 55.5845474,49.3307354 C55.6729228,50.9693026 55.0887711,52.4885679 54.0728838,53.6202852 C53.0569965,54.7520026 51.6093735,55.496172 49.9708064,55.5845474 C48.4341817,55.520994 47.1816862,55.7944863 46.1376396,56.359614 C45.1100174,56.9158514 44.2909444,57.7540755 43.7594495,58.8011309 C43.0167012,60.2643593 41.7511784,61.2880058 40.3055355,61.7601581 C38.8598926,62.2323105 37.2341296,62.1529687 35.7709012,61.4102204 C34.4719218,60.5868692 33.2504828,60.1974727 32.063748,60.1648643 C30.8956824,60.1327689 29.7672323,60.4491559 28.7834165,61.0901849 C27.4085635,61.9860038 25.8007653,62.2397462 24.3127256,61.9258207 C22.824686,61.6118952 21.4564049,60.7303017 20.560586,59.3554486 C19.8473125,57.9929158 18.9842135,57.044969 17.9727753,56.423362 C16.9772484,55.8115338 15.8417886,55.5213079 14.6692646,55.5845474 C13.0306974,55.6729228 11.5114321,55.0887711 10.3797148,54.0728838 C9.24799738,53.0569965 8.50382796,51.6093735 8.4154526,49.9708064 C8.47900598,48.4341817 8.20551372,47.1816862 7.64038603,46.1376396 C7.08414863,45.1100174 6.24592448,44.2909444 5.19886914,43.7594495 C3.7356407,43.0167012 2.71199419,41.7511784 2.23984185,40.3055355 C1.76768951,38.8598926 1.84703135,37.2341296 2.58977961,35.7709012 C3.41313081,34.4719218 3.80252733,33.2504828 3.83513569,32.063748 C3.86723108,30.8956824 3.55084414,29.7672323 2.90981509,28.7834165 C2.01399622,27.4085635 1.76025376,25.8007653 2.07417929,24.3127256 C2.38810482,22.824686 3.26969834,21.4564049 4.64455142,20.560586 C6.00708416,19.8473125 6.95503096,18.9842135 7.576638,17.9727753 C8.18846624,16.9772484 8.47869214,15.8417886 8.4154526,14.6692646 C8.32707724,13.0306974 8.91122892,11.5114321 9.92711623,10.3797148 C10.9430035,9.24799738 12.3906265,8.50382796 14.0291936,8.4154526 C15.5658183,8.47900598 16.8183138,8.20551372 17.8623604,7.64038603 C18.8899826,7.08414863 19.7090556,6.24592448 20.2405505,5.19886914 C20.9832988,3.7356407 22.2488216,2.71199419 23.6944645,2.23984185 Z" fill="#000000" stroke="#000000" stroke-width="3.15" />\n  </g>\n</svg>\n'}),define("text!res/icons/filter-cloud-editor.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <rect class="icon-solid" fill="#000000" height="5" rx="2.5" width="60.00448" x="1.99776001" y="13" />\n    <rect class="icon-solid" fill="#000000" height="5" rx="2.5" width="44.6841872" x="9.65790639" y="30" />\n    <rect class="icon-solid" fill="#000000" height="5" rx="2.5" width="29.3638945" x="17.3180528" y="47" />\n  </g>\n</svg>\n'}),define("text!res/icons/filter-cloud-filter.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <circle class="icon-solid" cx="10.3333333" cy="8" fill="#000000" r="6.5" />\n    <circle class="icon-solid" cx="32" cy="8" fill="#000000" r="6.5" />\n    <circle class="icon-solid" cx="21.1666667" cy="23" fill="#000000" r="6.5" />\n    <circle class="icon-solid" cx="42.8333333" cy="23" fill="#000000" r="6.5" />\n    <circle class="icon-solid" cx="32" cy="38.5" fill="#000000" r="6.5" />\n    <circle class="icon-solid" cx="32" cy="57.5" fill="#000000" r="6.5" />\n    <circle class="icon-solid" cx="53.6666667" cy="8" fill="#000000" r="6.5" />\n  </g>\n</svg>\n'}),define("text!res/icons/filter-cloud-lock.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <rect class="icon-solid" fill="#000000" height="31.5492958" rx="5.25821596" width="47.3239437" x="8.83802817" y="30.7757042" />\n    <path class="icon-hollow" d="M32.5,6.325 C39.7600812,6.325 45.6455399,12.2104587 45.6455399,19.4705399 L45.6455399,48.3907277 L45.6455399,48.3907277 L19.3544601,48.3907277 L19.3544601,19.4705399 C19.3544601,12.2104587 25.2399188,6.325 32.5,6.325 Z" opacity="0.7" stroke="#000000" stroke-linecap="round" stroke-width="7.88732394" />\n  </g>\n</svg>\n'}),define("text!res/icons/filter-cloud-pin.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g class="icon-solid" fill="#000000" fill-rule="evenodd" stroke="none" stroke-width="1" transform="translate(11.853702, 0.000000)">\n    <path d="M20.1462978,18.3834967 C31.2727908,18.3834967 40.2925956,25.3603913 40.2925956,33.966827 C40.2925956,35.0681016 40.2925956,36.1693763 40.2925956,37.2706509 C40.2925956,37.9660567 39.7288578,38.5297945 39.033452,38.5297945 L1.25914361,38.5297945 C0.563737797,38.5297945 -1.69119419e-15,37.9660567 0,37.2706509 C0,36.1693763 0,35.0681016 0,33.966827 C0,25.3603913 9.01980476,18.3834967 20.1462978,18.3834967 Z" />\n    <path d="M10.0731489,1.59891252 C13.2803468,0.532970841 16.5865594,0 19.9917868,0 C23.3970142,0 26.8062342,0.532970841 30.2194467,1.59891252 L30.2194467,25.1828722 L10.0731489,25.1828722 L10.0731489,1.59891252 Z" />\n    <rect height="34.4528042" opacity="0.7" rx="3.77743084" width="7.55486167" x="16.368867" y="29.5471958" />\n  </g>\n</svg>\n'}),define("text!res/icons/filter-cloud-asterisk.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M32,0.375 C33.9374505,0.375 35.519898,1.89494902 35.6199753,3.80748004 L35.625,4 L35.6246834,25.721 L54.4362113,14.8606579 C56.1700221,13.8596418 58.3870373,14.4536892 59.3880534,16.1875 C60.3557023,17.8635171 59.8328529,19.9910619 58.2307763,21.0352501 L58.0612113,21.1393421 L39.2506834,31.999 L58.0612113,42.8606579 C59.7950221,43.861674 60.3890695,46.0786892 59.3880534,47.8125 C58.4204045,49.4885171 56.316472,50.0994886 54.6111401,49.2341437 L54.4362113,49.1393421 L35.6246834,38.278 L35.625,60 C35.625,62.0020322 34.0020322,63.625 32,63.625 C30.0625495,63.625 28.480102,62.105051 28.3800247,60.19252 L28.375,60 L28.3746834,38.278 L9.56378869,49.1393421 C7.82997793,50.1403582 5.61296271,49.5463108 4.61194661,47.8125 C3.6442977,46.1364829 4.16714706,44.0089381 5.76922369,42.9647499 L5.93878869,42.8606579 L24.7486834,32 L5.93878869,21.1393421 C4.20497793,20.138326 3.6109305,17.9213108 4.61194661,16.1875 C5.57959551,14.5114829 7.68352803,13.9005114 9.38885987,14.7658563 L9.56378869,14.8606579 L28.3746834,25.721 L28.375,4 C28.375,1.99796778 29.9979678,0.375 32,0.375 Z" fill="#000000" fill-rule="nonzero" />\n  </g>\n</svg>\n';
}),define("text!res/icons/filter-cloud-remove.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M32,1 C49.1208272,1 63,14.8791728 63,32 C63,49.1208272 49.1208272,63 32,63 C14.8791728,63 1,49.1208272 1,32 C1,14.8791728 14.8791728,1 32,1 Z M21.1631129,21.1631129 C20.2567625,22.0694634 20.2155647,23.5133509 21.0395196,24.4685685 L21.1631129,24.601593 L28.4696471,31.9076078 L21.1631129,39.2151331 L21.021081,39.3697863 C20.2545592,40.2795682 20.2610006,41.6190544 21.040405,42.5216144 L21.1631129,42.6536132 L21.3177662,42.7956451 C22.227548,43.5621669 23.5670342,43.5557255 24.4695943,42.7763211 L24.601593,42.6536132 L31.9076078,35.3467843 L39.2151331,42.6536132 C40.1646431,43.6031232 41.7041031,43.6031232 42.6536132,42.6536132 C43.5599637,41.7472627 43.6011614,40.3033751 42.7772064,39.3481576 L42.6536132,39.2151331 L35.3467843,31.9076078 L42.6536132,24.601593 L42.7956451,24.4469397 C43.5621669,23.5371579 43.5557255,22.1976716 42.7763211,21.2951116 L42.6536132,21.1631129 L42.4989599,21.021081 C41.589178,20.2545592 40.2496918,20.2610006 39.3471318,21.040405 L39.2151331,21.1631129 L31.9076078,28.4696471 L24.601593,21.1631129 C23.6520829,20.2136029 22.1126229,20.2136029 21.1631129,21.1631129 Z" fill="#000000" fill-rule="nonzero" />\n  </g>\n</svg>\n'}),define("text!res/icons/filter-cloud-similar.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-linecap="round" stroke-width="1">\n    <path class="icon-hollow" d="M8,20.0020471 C11.3333333,15.8947921 15.6666667,13.8947921 21,14.0020471 C29,14.1629297 35,26.0020471 43,26.0020471 C48.3333333,26.0020471 52.6666667,24.0020471 56,20.0020471" stroke="#000000" stroke-width="10" />\n    <path class="icon-hollow" d="M8,44.0020471 C11.3333333,39.8947921 15.6666667,37.8947921 21,38.0020471 C29,38.1629297 35,50.0020471 43,50.0020471 C48.3333333,50.0020471 52.6666667,48.0020471 56,44.0020471" stroke="#000000" stroke-width="10" />\n  </g>\n</svg>\n'}),define("text!res/icons/filter-cloud-sort.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M45.6170213,5 L57.8129827,17.1959614 C59.8903937,19.2733724 59.2017377,20.9574468 56.2506005,20.9574468 L34.9834421,20.9574468 C32.0431512,20.9574468 31.3371405,19.2798808 33.4210598,17.1959614 L45.6170213,5 Z" fill="#000000" transform="translate(45.617021, 12.978723) scale(-1, 1) translate(-45.617021, -12.978723) " />\n    <path class="icon-solid" d="M30.1534082,45.9955279 C32.2308193,43.9181169 31.5421632,42.2340426 28.591026,42.2340426 L7.32386761,42.2340426 C4.38357672,42.2340426 3.67756599,43.9116085 5.76148537,45.9955279 L17.9574468,58.1914894 L30.1534082,45.9955279 Z" fill="#000000" transform="translate(17.957447, 50.212766) scale(-1, 1) translate(-17.957447, -50.212766) " />\n    <line class="icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="6.64893617" transform="translate(45.085106, 26.276596) scale(-1, 1) translate(-45.085106, -26.276596) " x1="45.0851064" x2="45.0851064" y1="15.6382979" y2="36.9148936" />\n    <line class="icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="6.64893617" transform="translate(18.489362, 36.914894) scale(-1, 1) translate(-18.489362, -36.914894) " x1="18.4893617" x2="18.4893617" y1="26.2765957" y2="47.5531915" />\n  </g>\n</svg>\n'}),define("text!res/icons/filter-cloud-spinner.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g class="icon-hollow" fill="none" fill-rule="evenodd" stroke="#000000" stroke-linecap="round" stroke-width="6.36932875" transform="translate(3.773460, 4.202285)">\n    <line x1="28.2265395" x2="28.2265395" y1="0" y2="6.36932875" />\n    <line x1="46.6501047" x2="42.5559791" y1="6.70562934" y2="11.5848182" />\n    <line x1="56.453079" x2="50.1805147" y1="23.6848789" y2="24.7909012" />\n    <line x1="53.0485418" x2="47.5325413" y1="42.9929691" y2="39.8083047" />\n    <line x1="38.0295138" x2="35.8510751" y1="55.5954299" y2="49.6102187" />\n    <line x1="18.4235652" x2="20.6020039" y1="55.5954299" y2="49.6102187" />\n    <line x1="3.40453724" x2="8.92053774" y1="42.9929691" y2="39.8083047" />\n    <line x1="0" x2="6.27256433" y1="23.6848789" y2="24.7909012" />\n    <line x1="9.80297429" x2="13.8970999" y1="6.70562934" y2="11.5848182" />\n  </g>\n</svg>\n'}),define("text!res/icons/fmt-book.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'>\n  <g stroke='none' stroke-width='1' fill='none' fill-rule='evenodd'>\n    <path d='M30.7270795,11.738923 L51.837302,16.84255 C52.4635913,16.9939623 52.8485552,17.624414 52.6971429,18.2507033 C52.6520009,18.4374247 52.5614502,18.6101101 52.4335311,18.7534258 L33.993425,39.4130222 C33.691357,39.7514478 33.2205059,39.8840973 32.786198,39.7531256 L11.9571437,33.4718311 C11.6486976,33.3788148 11.4740572,33.0533653 11.5670735,32.7449192 C11.5911032,32.6652357 11.6319059,32.5916168 11.6867412,32.529007 L29.5752766,12.1042541 C29.8613262,11.7776487 30.3050764,11.6368992 30.7270795,11.738923 Z' stroke='#000000' stroke-width='1.16666667' fill='#000000' fill-rule='nonzero' class='icon-solid icon-hollow' />\n    <path d='M52.8833333,22.9032258 C52.5722222,23.4919718 52.4166667,24.1986233 52.4166667,25.0231805 C52.4166667,25.8477376 52.5722222,26.8211194 52.8833333,27.943326 L35.5474211,46.4553959 C35.2483505,46.774757 34.7957323,46.8999362 34.3750646,46.7796308 L13.1994906,40.7237014 L13.1994906,40.7237014 C12.3249571,39.7681986 11.7903471,38.5701494 11.5956608,37.1295538 C11.3542648,35.343327 11.5313146,33.9542533 12.1268102,32.962333' stroke='#000000' stroke-width='2.33333333' stroke-linecap='round' fill-rule='nonzero' class='icon-hollow' />\n  </g>\n</svg>\n"}),define("text!res/icons/fmt-audiobook.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'>\n  <g stroke='none' stroke-width='1' fill='none' fill-rule='evenodd'>\n    <path d='M20.470622,18.9274655 C17.7802915,18.9274655 15.2425055,20.131459 13.6823912,22.148737 C13.5880909,22.2706604 13.5367805,22.4189081 13.5367805,22.5726979 L13.5367805,30.5226573 C13.5367805,30.6750615 13.5880909,30.8246948 13.6823912,30.9466182 C15.2425055,32.9638961 17.7802915,34.1678897 20.470622,34.1678897 C20.9393496,34.1678897 21.4025302,34.1304813 21.8573902,34.0598212 L21.8573902,32.7823966 C21.8573902,32.0176044 21.2347313,31.3969034 20.470622,31.3969034 C20.0878739,31.3969034 19.7772378,31.086553 19.7772378,30.7041569 C19.7772378,30.3217608 20.0878739,30.0114103 20.470622,30.0114103 C22.0002274,30.0114103 23.2441585,31.2555832 23.2441585,32.7823966 L23.2441585,43.6745457 C23.2441585,44.2268304 23.6918738,44.6745457 24.2441585,44.6745457 L27.7912317,44.6745457 C28.3435165,44.6745457 28.7912317,44.2268304 28.7912317,43.6745457 L28.7912317,26.5476776 L28.7912317,26.5476776 C28.7912317,22.3468625 25.0594382,18.9274655 20.470622,18.9274655 Z' fill='#000000' fill-rule='nonzero' class='icon-solid' />\n    <path d='M41.1426098,11.9274655 C38.4522793,11.9274655 35.9144933,13.131459 34.354379,15.148737 C34.2600787,15.2706604 34.2087683,15.4189081 34.2087683,15.5726979 L34.2087683,23.5226573 C34.2087683,23.6750615 34.2600787,23.8246948 34.354379,23.9466182 C35.9144933,25.9638961 38.4522793,27.1678897 41.1426098,27.1678897 C41.6113374,27.1678897 42.074518,27.1304813 42.529378,27.0598212 L42.529378,25.7823966 C42.529378,25.0176044 41.9067191,24.3969034 41.1426098,24.3969034 C40.7598617,24.3969034 40.4492256,24.086553 40.4492256,23.7041569 C40.4492256,23.3217608 40.7598617,23.0114103 41.1426098,23.0114103 C42.6722152,23.0114103 43.9161463,24.2555832 43.9161463,25.7823966 L43.9161463,36.6745457 C43.9161463,37.2268304 44.3638616,37.6745457 44.9161463,37.6745457 L48.4632195,37.6745457 C49.0155043,37.6745457 49.4632195,37.2268304 49.4632195,36.6745457 L49.4632195,19.5476776 L49.4632195,19.5476776 C49.4632195,15.3468625 45.731426,11.9274655 41.1426098,11.9274655 Z' fill='#000000' fill-rule='nonzero' transform='translate(41.835994, 24.801006) scale(-1, 1) translate(-41.835994, -24.801006) ' class='icon-solid' />\n  </g>\n</svg>\n"}),define("text!res/icons/fmt-magazine.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'>\n  <g stroke='none' stroke-width='1' fill='none' fill-rule='evenodd'>\n    <path d='M45.2304932,11.3561443 C41.8705621,12.9263593 38.6353913,13.8306517 35.5273948,14.078768 C31.9774152,14.3621685 28.8243953,14.4853753 25.9540272,14.5202038 L14.4674245,38.9468864 C18.3591938,40.0240219 21.636132,40.5692056 24.2991437,40.5692056 C27.077544,40.5692056 29.7613678,40.1939097 32.3504634,39.4423173 L45.2304932,11.3561443 Z' stroke='#000000' stroke-width='1.75' fill-rule='nonzero' class='icon-hollow' />\n    <path d='M15.2138896,39.0687024 C18.8485945,41.1729798 21.9069709,42.468456 24.3890189,42.955131 C26.7890036,43.4257152 30.5569525,43.3168918 35.6928657,42.628661 C36.0245204,42.5841969 36.311967,42.3768103 36.4587243,42.0760875 L49.0228886,16.330656 L49.0228886,16.330656' stroke='#000000' stroke-width='1.75' stroke-linecap='round' fill-rule='nonzero' class='icon-hollow' />\n    <path d='M14.8056232,39.3952306 C17.016907,41.7719369 20.5035158,43.7736438 25.2654498,45.4003514 C28.3203777,46.4439347 33.0565118,46.4710497 39.4738522,45.4816967 C39.7973157,45.4318068 40.0759064,45.2268037 40.2197324,44.9328109 L50.3559465,24.2135228 L50.3559465,24.2135228' stroke='#000000' stroke-width='1.75' stroke-linecap='round' fill-rule='nonzero' class='icon-hollow' />\n  </g>\n</svg>\n"}),define("text!res/icons/fmt-video.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'>\n  <g stroke='none' stroke-width='1' fill='none' fill-rule='evenodd'>\n    <path d='M50,16.5 L50,41.5 C50,42.8807119 48.6941639,44 47.0833333,44 L17.9166667,44 C16.3058361,44 15,42.8807119 15,41.5 L15,16.5 C15,15.1192881 16.3058361,14 17.9166667,14 L47.0833333,14 C48.6941639,14 50,15.1192881 50,16.5 Z' stroke='#000000' stroke-width='2.5' stroke-linecap='round' class='icon-hollow' />\n    <line x1='22' y1='44.5' x2='22' y2='37.5' stroke='#000000' stroke-width='2.5' class='icon-hollow' />\n    <line x1='29' y1='44.5' x2='29' y2='37.5' stroke='#000000' stroke-width='2.5' class='icon-hollow' />\n    <line x1='36' y1='44.5' x2='36' y2='37.5' stroke='#000000' stroke-width='2.5' class='icon-hollow' />\n    <line x1='43' y1='44.5' x2='43' y2='37.5' stroke='#000000' stroke-width='2.5' class='icon-hollow' />\n    <line x1='22' y1='21.5' x2='22' y2='14.5' stroke='#000000' stroke-width='2.5' class='icon-hollow' />\n    <line x1='29' y1='21.5' x2='29' y2='14.5' stroke='#000000' stroke-width='2.5' class='icon-hollow' />\n    <line x1='36' y1='21.5' x2='36' y2='14.5' stroke='#000000' stroke-width='2.5' class='icon-hollow' />\n    <line x1='43' y1='21.5' x2='43' y2='14.5' stroke='#000000' stroke-width='2.5' class='icon-hollow' />\n    <line x1='49.5' y1='21.5' x2='16.5' y2='21.5' stroke='#000000' stroke-width='2.5' stroke-linecap='round' class='icon-hollow' />\n    <line x1='49.5' y1='36.5' x2='16.5' y2='36.5' stroke='#000000' stroke-width='2.5' stroke-linecap='round' class='icon-hollow' />\n  </g>\n</svg>\n"}),define("text!res/icons/hourglass.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'>\n  <g stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' transform='translate(14.000000, 13.000000)'>\n    <path d='M8.57142857,5.14285714 L27.4285714,5.14285714 C27.4285714,5.14285714 27.4285714,6.85714286 27.4285714,9.42857143 C27.4285714,12 21.6846859,16.2857143 18,16.2857143 C14.3153141,16.2857143 8.57142857,12 8.57142857,9.42857143 C8.57142857,6.85714286 8.57142857,5.14285714 8.57142857,5.14285714 Z' fill='#000000' class='icon-solid' />\n    <path d='M0,0 L36,0 L31.7142857,0.00313895089 C31.7142857,3.62079148 31.7142857,6.47688802 31.7142857,8.57142857 C31.7142857,12 29.1428571,15.4285714 24,18.8571429 C29.1428571,22.2857143 31.7142857,25.7142857 31.7142857,29.1428571 C31.7142857,30.6683873 31.7142857,33.5255301 31.7142857,37.7142857 L36,37.7142857 L0,37.7142857 L4.28571429,37.7142857 C4.28571429,33.5252976 4.28571429,30.6681548 4.28571429,29.1428571 C4.28571429,25.7142857 6.57142857,22.2857143 11.1428571,18.8571429 C6.57142857,15.4285714 4.28571429,12 4.28571429,8.57142857 C4.28571429,6.46817966 4.28571429,3.6110368 4.28571429,0 L0,0 Z' stroke='#000000' stroke-width='3' class='icon-hollow' />\n  </g>\n</svg>\n"}),define("text!res/icons/library-card.svg",[],function(){return'<svg version="1.1" viewBox="0 0 80 60" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <defs>\n    <linearGradient id="linearGradient-1" x1="7.92190819%" x2="88.5996768%" y1="29.101783%" y2="69.8140899%">\n      <stop offset="0%" stop-color="#FFFFFF" stop-opacity="0" />\n      <stop offset="100%" stop-color="#FFFFFF" stop-opacity="0.2" />\n    </linearGradient>\n    <filter filterUnits="objectBoundingBox" height="200.0%" id="filter-2" width="124.8%" x="-12.4%" y="-50.0%">\n      <feOffset dx="1" dy="1" in="SourceAlpha" result="shadowOffsetOuter1" />\n      <feGaussianBlur in="shadowOffsetOuter1" result="shadowBlurOuter1" stdDeviation="1" />\n      <feColorMatrix in="shadowBlurOuter1" result="shadowMatrixOuter1" type="matrix" values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.3 0" />\n      <feMerge>\n        <feMergeNode in="shadowMatrixOuter1" />\n        <feMergeNode in="SourceGraphic" />\n      </feMerge>\n    </filter>\n  </defs>\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class=" library-card-field" d="M83.4042553,-1.70212766 L83.4042553,62.9787234 L-1.70212766,62.9787234 L-1.70212766,-1.70212766 L83.4042553,-1.70212766 Z M64.3259456,2 L15.6740544,2 C10.9192878,2 9.19509452,2.49506993 7.45682291,3.42470775 C5.71855131,4.35434558 4.35434558,5.71855131 3.42470775,7.45682291 C2.49506993,9.19509452 2,10.9192878 2,15.6740544 L2,15.6740544 L2,44.3259456 C2,49.0807122 2.49506993,50.8049055 3.42470775,52.5431771 C4.35434558,54.2814487 5.71855131,55.6456544 7.45682291,56.5752922 C9.19509452,57.5049301 10.9192878,58 15.6740544,58 L15.6740544,58 L64.3259456,58 C69.0807122,58 70.8049055,57.5049301 72.5431771,56.5752922 C74.2814487,55.6456544 75.6456544,54.2814487 76.5752922,52.5431771 C77.5049301,50.8049055 78,49.0807122 78,44.3259456 L78,44.3259456 L78,15.6740544 C78,10.9192878 77.5049301,9.19509452 76.5752922,7.45682291 C75.6456544,5.71855131 74.2814487,4.35434558 72.5431771,3.42470775 C70.8049055,2.49506993 69.0807122,2 64.3259456,2 L64.3259456,2 Z" fill="#FFFFFF" />\n    <path class=" color-highlight" d="M15.6740544,2 L64.3259456,2 L65.1341825,2.00512682 C65.2638521,2.00683371 65.3910549,2.00896578 65.5158685,2.01152149 L66.2366995,2.03192717 C66.3522662,2.0361713 66.4655985,2.04083599 66.5767741,2.04591971 L67.2185653,2.08143801 C69.378586,2.2232649 70.6557734,2.5485242 71.7675229,3.04296012 L72.0812837,3.18881866 L72.3897593,3.3438102 C72.440938,3.3703991 72.4920515,3.39736546 72.5431771,3.42470775 C74.2814487,4.35434558 75.6456544,5.71855131 76.5752922,7.45682291 L76.7348226,7.7640503 C76.760655,7.81543708 76.7861085,7.8669666 76.8111813,7.91871635 L76.9570399,8.23247708 C77.4279312,9.29128617 77.7453744,10.5001522 77.8970547,12.4787885 L77.9375736,13.0960923 C77.9494141,13.309971 77.9595846,13.5321672 77.9680728,13.7633005 L77.9884785,14.4841315 L77.9987168,15.2623035 C78,15.3969838 78,15.5342083 78,15.6740544 L78,44.3259456 L77.9948732,45.1341825 C77.9931663,45.2638521 77.9910342,45.3910549 77.9884785,45.5158685 L77.9680728,46.2366995 C77.9638287,46.3522662 77.959164,46.4655985 77.9540803,46.5767741 L77.918562,47.2185653 C77.7767351,49.378586 77.4514758,50.6557734 76.9570399,51.7675229 L76.8111813,52.0812837 L76.6561898,52.3897593 C76.6296009,52.440938 76.6026345,52.4920515 76.5752922,52.5431771 C75.6456544,54.2814487 74.2814487,55.6456544 72.5431771,56.5752922 L72.2359497,56.7348226 C72.1845629,56.760655 72.1330334,56.7861085 72.0812837,56.8111813 L71.7675229,56.9570399 C70.7087138,57.4279312 69.4998478,57.7453744 67.5212115,57.8970547 L66.9039077,57.9375736 C66.690029,57.9494141 66.4678328,57.9595846 66.2366995,57.9680728 L65.5158685,57.9884785 L64.7376965,57.9987168 C64.6030162,58 64.4657917,58 64.3259456,58 L15.6740544,58 L14.8658175,57.9948732 C14.7361479,57.9931663 14.6089451,57.9910342 14.4841315,57.9884785 L13.7633005,57.9680728 C13.6477338,57.9638287 13.5344015,57.959164 13.4232259,57.9540803 L12.7814347,57.918562 C10.621414,57.7767351 9.34422663,57.4514758 8.23247708,56.9570399 L7.91871635,56.8111813 L7.61024075,56.6561898 C7.55906201,56.6296009 7.50794855,56.6026345 7.45682291,56.5752922 C5.71855131,55.6456544 4.35434558,54.2814487 3.42470775,52.5431771 L3.26517742,52.2359497 C3.23934498,52.1845629 3.21389155,52.1330334 3.18881866,52.0812837 L3.04296012,51.7675229 C2.57206876,50.7087138 2.25462559,49.4998478 2.10294529,47.5212115 L2.0624264,46.9039077 C2.05058594,46.690029 2.04041543,46.4678328 2.03192717,46.2366995 L2.01152149,45.5158685 L2.00128324,44.7376965 C2,44.6030162 2,44.4657917 2,44.3259456 L2.00128324,15.2623035 L2.01152149,14.4841315 L2.03192717,13.7633005 C2.0361713,13.6477338 2.04083599,13.5344015 2.04591971,13.4232259 L2.08143801,12.7814347 C2.2232649,10.621414 2.5485242,9.34422663 3.04296012,8.23247708 L3.18881866,7.91871635 L3.3438102,7.61024075 C3.3703991,7.55906201 3.39736546,7.50794855 3.42470775,7.45682291 C4.35434558,5.71855131 5.71855131,4.35434558 7.45682291,3.42470775 L7.7640503,3.26517742 C7.81543708,3.23934498 7.8669666,3.21389155 7.91871635,3.18881866 L8.23247708,3.04296012 C9.29128617,2.57206876 10.5001522,2.25462559 12.4787885,2.10294529 L13.0960923,2.0624264 C13.309971,2.05058594 13.5321672,2.04041543 13.7633005,2.03192717 L14.4841315,2.01152149 L15.2623035,2.00128324 C15.3969838,2 15.5342083,2 15.6740544,2 Z" fill="url(#linearGradient-1)" transform="translate(40.000000, 30.000000) scale(-1, -1) translate(-40.000000, -30.000000) " />\n    <path class="icon-solid" d="M76.5752922,7.45682291 C77.5049301,9.19509452 78,10.9192878 78,15.6740544 L78,44.3259456 C78,49.0807122 77.5049301,50.8049055 76.5752922,52.5431771 C75.6456544,54.2814487 74.2814487,55.6456544 72.5431771,56.5752922 C70.8049055,57.5049301 69.0807122,58 64.3259456,58 L15.6740544,58 C10.9192878,58 9.19509452,57.5049301 7.45682291,56.5752922 C6.15843735,55.880908 5.06875069,54.9440696 4.21297615,53.7899902 C4.60385419,54.0787569 5.01844301,54.3408441 5.45682291,54.5752922 C7.19509452,55.5049301 8.91928779,56 13.6740544,56 L13.6740544,56 L64.8894037,56 C68.7528001,56 70.153761,55.5977402 71.566161,54.8423805 C72.9785609,54.0870207 74.0870207,52.9785609 74.8423805,51.566161 C75.5977402,50.153761 76,48.7528001 76,44.8894037 L76,44.8894037 L76,13.6740544 C76,8.91928779 75.5049301,7.19509452 74.5752922,5.45682291 C74.3408441,5.01844301 74.0787569,4.60385419 73.790001,4.21402688 C74.9440696,5.06875069 75.880908,6.15843735 76.5752922,7.45682291 Z" fill="#000000" opacity="0.203002" />\n    <g fill="#FFFFFF" fill-opacity="0.9" fill-rule="nonzero" filter="url(#filter-2)" transform="translate(13.750000, 33.833333)">\n      <path class=" library-card-bar" d="M1.5,0 C2.27969612,0 2.92044868,0.594888083 2.99313342,1.35553999 L3,1.5 L3,11.5 C3,12.3284271 2.32842712,13 1.5,13 C0.720303883,13 0.0795513218,12.4051119 0.00686657806,11.64446 L0,11.5 L0,1.5 C0,0.671572875 0.671572875,0 1.5,0 Z" />\n      <path class=" library-card-bar" d="M9.75,0 C10.5296961,0 11.1704487,0.594888083 11.2431334,1.35553999 L11.25,1.5 L11.25,11.5 C11.25,12.3284271 10.5784271,13 9.75,13 C8.97030388,13 8.32955132,12.4051119 8.25686658,11.64446 L8.25,11.5 L8.25,1.5 C8.25,0.671572875 8.92157288,0 9.75,0 Z" />\n      <path class=" library-card-bar" d="M18,0 C18.7796961,0 19.4204487,0.594888083 19.4931334,1.35553999 L19.5,1.5 L19.5,11.5 C19.5,12.3284271 18.8284271,13 18,13 C17.2203039,13 16.5795513,12.4051119 16.5068666,11.64446 L16.5,11.5 L16.5,1.5 C16.5,0.671572875 17.1715729,0 18,0 Z" />\n      <path class=" library-card-bar" d="M26.25,0 C27.0296961,0 27.6704487,0.594888083 27.7431334,1.35553999 L27.75,1.5 L27.75,11.5 C27.75,12.3284271 27.0784271,13 26.25,13 C25.4703039,13 24.8295513,12.4051119 24.7568666,11.64446 L24.75,11.5 L24.75,1.5 C24.75,0.671572875 25.4215729,0 26.25,0 Z" />\n      <path class=" library-card-bar" d="M34.5,0 C35.2796961,0 35.9204487,0.594888083 35.9931334,1.35553999 L36,1.5 L36,11.5 C36,12.3284271 35.3284271,13 34.5,13 C33.7203039,13 33.0795513,12.4051119 33.0068666,11.64446 L33,11.5 L33,1.5 C33,0.671572875 33.6715729,0 34.5,0 Z" />\n      <path class=" library-card-bar" d="M42.75,0 C43.5296961,0 44.1704487,0.594888083 44.2431334,1.35553999 L44.25,1.5 L44.25,11.5 C44.25,12.3284271 43.5784271,13 42.75,13 C41.9703039,13 41.3295513,12.4051119 41.2568666,11.64446 L41.25,11.5 L41.25,1.5 C41.25,0.671572875 41.9215729,0 42.75,0 Z" />\n      <path class=" library-card-bar" d="M51,0 C51.7796961,0 52.4204487,0.594888083 52.4931334,1.35553999 L52.5,1.5 L52.5,11.5 C52.5,12.3284271 51.8284271,13 51,13 C50.2203039,13 49.5795513,12.4051119 49.5068666,11.64446 L49.5,11.5 L49.5,1.5 C49.5,0.671572875 50.1715729,0 51,0 Z" />\n    </g>\n  </g>\n</svg>\n'}),define("text!res/icons/library-card-add.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M26.3569094,3 L37.6430906,3 C46.1125186,3 49.1837379,3.88184331 52.2800342,5.53776069 C55.3763305,7.19367807 57.8063219,9.62366952 59.4622393,12.7199658 C61.1181567,15.8162621 62,18.8874814 62,27.3569094 L62,38.6430906 C62,47.1125186 61.1181567,50.1837379 59.4622393,53.2800342 C57.8063219,56.3763305 55.3763305,58.8063219 52.2800342,60.4622393 C49.1837379,62.1181567 46.1125186,63 37.6430906,63 L26.3569094,63 C17.8874814,63 14.8162621,62.1181567 11.7199658,60.4622393 C8.62366952,58.8063219 6.19367807,56.3763305 4.53776069,53.2800342 C2.88184331,50.1837379 2,47.1125186 2,38.6430906 L2,27.3569094 C2,18.8874814 2.88184331,15.8162621 4.53776069,12.7199658 C6.19367807,9.62366952 8.62366952,7.19367807 11.7199658,5.53776069 C14.8162621,3.88184331 17.8874814,3 26.3569094,3 Z" fill="#000000" />\n    <line stroke="#FFFFFF" stroke-linecap="round" stroke-width="6" x1="32" x2="32" y1="23" y2="43" />\n    <line stroke="#FFFFFF" stroke-linecap="round" stroke-width="6" x1="22" x2="42" y1="33" y2="33" />\n  </g>\n</svg>\n'}),define("text!res/icons/library-personalize.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid icon-hollow" d="M32.0004946,7.66694809 C32.517078,8.12390238 33.0382881,8.5914099 33.5641176,9.06952232 C46.9210021,21.2143192 53.1833333,31.0409047 53.1833333,38.3519231 C53.1833333,44.2015391 50.812308,49.4973724 46.9788786,53.3308017 C43.1454493,57.1642311 37.849616,59.5352564 32,59.5352564 C26.150384,59.5352564 20.8545507,57.1642311 17.0211214,53.3308017 C13.187692,49.4973724 10.8166667,44.2015391 10.8166667,38.3519231 C10.8166667,31.0409047 17.0789979,21.2143192 30.4358824,9.06952232 C30.9625272,8.59066864 31.4845381,8.12245277 32.0004946,7.66694809 Z" fill="#000000" stroke="#000000" stroke-width="4.65" />\n    <path d="M43.3294385,22.502692 C48.3487017,28.6816296 50.8583333,33.9647066 50.8583333,38.3519231 C50.8583333,48.767093 42.4151699,57.2102564 32,57.2102564 C29.2375591,57.2102564 26.6138454,56.6162947 24.2496019,55.5491142 Z" fill="#FFFFFF" />\n  </g>\n</svg>\n'}),define("text!res/icons/link-anchor.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g class="icon-hollow" fill="none" fill-rule="evenodd" stroke="#000000" stroke-linecap="round" stroke-width="5.22171161" transform="translate(8.000000, 8.160000)">\n    <path d="M27.300842,2.50310997 L32.4757832,2.50310997 C38.2435266,2.50310997 42.9192064,7.17878982 42.9192064,12.9465332 C42.9192064,18.7142766 38.2435266,23.3899564 32.4757832,23.3899564 L27.1877272,23.3899564 L27.1877272,23.3899564" transform="translate(35.053467, 12.946533) rotate(-45.000000) translate(-35.053467, -12.946533) " />\n    <path d="M20.8256365,45.4913546 L15.521924,45.4913546 C9.75418059,45.4913546 5.07850075,40.8156748 5.07850075,35.0479314 C5.07850075,29.280188 9.75418059,24.6045081 15.521924,24.6045081 L20.7937923,24.6045081 L20.7937923,24.6045081" transform="translate(12.952069, 35.047931) rotate(-45.000000) translate(-12.952069, -35.047931) " />\n    <line transform="translate(24.000000, 24.000000) rotate(-45.000000) translate(-24.000000, -24.000000) " x1="17.0377178" x2="30.9622822" y1="24" y2="24" />\n  </g>\n</svg>\n'}),define("text!res/icons/map-find-me.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-hollow" d="M32,59 C32.0806761,59 32.2095347,58.9650292 32.3815557,58.8962707 L32.6083775,58.7976182 C32.6495271,58.7784983 32.6923228,58.7580459 32.7367246,58.7362703 L33.022086,58.5898154 L33.022086,58.5898154 L33.3440643,58.41206 L33.3440643,58.41206 L33.7007318,58.2034587 L33.7007318,58.2034587 L34.0901608,57.9644655 L34.0901608,57.9644655 L34.5104237,57.695535 L34.5104237,57.695535 L34.9595928,57.3971213 C35.036756,57.344954 35.1150434,57.2915772 35.1944147,57.2370003 L35.6833288,56.8952139 L35.6833288,56.8952139 L36.1963299,56.5250801 L36.1963299,56.5250801 L36.7314905,56.1270533 L36.7314905,56.1270533 L37.2868829,55.7015879 L37.2868829,55.7015879 L37.8605793,55.2491381 L37.8605793,55.2491381 L38.4506523,54.7701583 L38.4506523,54.7701583 L39.0551741,54.2651027 L39.0551741,54.2651027 L39.672217,53.7344258 L39.672217,53.7344258 L40.2998535,53.1785817 C40.510617,52.9891563 40.7228249,52.7956122 40.9361558,52.5980249 L41.5791963,51.9932097 L41.5791963,51.9932097 L42.2270474,51.3645903 C42.3353164,51.2578619 42.4437054,51.1501607 42.5521745,51.041496 L43.2036271,50.3780223 C48.8522966,44.529031 54.5,36.1260739 54.5,26.5 C54.5,14.0735931 44.4264069,4 32,4 C19.5735931,4 9.5,14.0735931 9.5,26.5 C9.5,37.6 17.0191318,47.08 23.3829581,52.888 L24.0151685,53.456484 C24.2244074,53.641848 24.4320414,53.823056 24.6377491,54.000032 L25.2487724,54.518188 L25.2487724,54.518188 L25.8463108,55.010496 L25.8463108,55.010496 L26.4284364,55.4765 L26.4284364,55.4765 L26.9932218,55.915744 C27.0858006,55.986696 27.1775765,56.056514 27.2685095,56.1251885 L27.8036701,56.5234375 L27.8036701,56.5234375 L28.3166712,56.8937865 L28.3166712,56.8937865 L28.8055853,57.2357795 C28.8849566,57.29039 28.963244,57.3438 29.0404072,57.396 L29.4895763,57.694604 L29.4895763,57.694604 L29.9098392,57.963712 C29.977367,58.00608 30.0436102,58.0472 30.1085284,58.0870625 L30.4818176,58.3110715 L30.4818176,58.3110715 L30.8213814,58.5044445 C30.8750579,58.534095 30.9272488,58.56245 30.977914,58.5895 L31.2632754,58.736064 C31.3076772,58.757856 31.3504729,58.778324 31.3916225,58.7974585 L31.6184443,58.8961875 C31.7904653,58.965 31.9193239,59 32,59 Z" stroke="#000000" stroke-linecap="round" stroke-width="3" />\n    <path class="icon-solid" d="M32,12 C39.7319865,12 46,18.2680135 46,26 C46,33.7319865 39.7319865,40 32,40 C24.2680135,40 18,33.7319865 18,26 C18,18.2680135 24.2680135,12 32,12 Z M31.9957516,31.3227163 C29.8695771,31.3062548 28.0481664,29.8909536 27.6756624,30.4303371 C26.7569965,31.7219298 29.6262269,33.6429025 31.9957516,33.6429025 C34.441343,33.6429025 37.0348427,31.7516364 36.404006,30.4303371 C36.0691249,29.7491158 34.2286312,31.2967186 31.9957516,31.3227163 Z M28,21 C27.1715729,21 26.5,21.8954305 26.5,23 C26.5,24.1045695 27.1715729,25 28,25 C28.8284271,25 29.5,24.1045695 29.5,23 C29.5,21.8954305 28.8284271,21 28,21 Z M36,21 C35.1715729,21 34.5,21.8954305 34.5,23 C34.5,24.1045695 35.1715729,25 36,25 C36.8284271,25 37.5,24.1045695 37.5,23 C37.5,21.8954305 36.8284271,21 36,21 Z" fill="#000000" />\n  </g>\n</svg>\n'}),define("text!res/icons/map-fit-branches.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-hollow" d="M32,59 C32.0806761,59 32.2095347,58.9650292 32.3815557,58.8962707 L32.6083775,58.7976182 C32.6495271,58.7784983 32.6923228,58.7580459 32.7367246,58.7362703 L33.022086,58.5898154 L33.022086,58.5898154 L33.3440643,58.41206 L33.3440643,58.41206 L33.7007318,58.2034587 L33.7007318,58.2034587 L34.0901608,57.9644655 L34.0901608,57.9644655 L34.5104237,57.695535 L34.5104237,57.695535 L34.9595928,57.3971213 C35.036756,57.344954 35.1150434,57.2915772 35.1944147,57.2370003 L35.6833288,56.8952139 L35.6833288,56.8952139 L36.1963299,56.5250801 L36.1963299,56.5250801 L36.7314905,56.1270533 L36.7314905,56.1270533 L37.2868829,55.7015879 L37.2868829,55.7015879 L37.8605793,55.2491381 L37.8605793,55.2491381 L38.4506523,54.7701583 L38.4506523,54.7701583 L39.0551741,54.2651027 L39.0551741,54.2651027 L39.672217,53.7344258 L39.672217,53.7344258 L40.2998535,53.1785817 C40.510617,52.9891563 40.7228249,52.7956122 40.9361558,52.5980249 L41.5791963,51.9932097 L41.5791963,51.9932097 L42.2270474,51.3645903 C42.3353164,51.2578619 42.4437054,51.1501607 42.5521745,51.041496 L43.2036271,50.3780223 C48.8522966,44.529031 54.5,36.1260739 54.5,26.5 C54.5,14.0735931 44.4264069,4 32,4 C19.5735931,4 9.5,14.0735931 9.5,26.5 C9.5,37.6 17.0191318,47.08 23.3829581,52.888 L24.0151685,53.456484 C24.2244074,53.641848 24.4320414,53.823056 24.6377491,54.000032 L25.2487724,54.518188 L25.2487724,54.518188 L25.8463108,55.010496 L25.8463108,55.010496 L26.4284364,55.4765 L26.4284364,55.4765 L26.9932218,55.915744 C27.0858006,55.986696 27.1775765,56.056514 27.2685095,56.1251885 L27.8036701,56.5234375 L27.8036701,56.5234375 L28.3166712,56.8937865 L28.3166712,56.8937865 L28.8055853,57.2357795 C28.8849566,57.29039 28.963244,57.3438 29.0404072,57.396 L29.4895763,57.694604 L29.4895763,57.694604 L29.9098392,57.963712 C29.977367,58.00608 30.0436102,58.0472 30.1085284,58.0870625 L30.4818176,58.3110715 L30.4818176,58.3110715 L30.8213814,58.5044445 C30.8750579,58.534095 30.9272488,58.56245 30.977914,58.5895 L31.2632754,58.736064 C31.3076772,58.757856 31.3504729,58.778324 31.3916225,58.7974585 L31.6184443,58.8961875 C31.7904653,58.965 31.9193239,59 32,59 Z" stroke="#000000" stroke-linecap="round" stroke-width="3" />\n    <path class="icon-solid" d="M28.5081967,44 C26.4710808,44 24.8196721,42.3664444 24.8196721,40.3513514 C24.8196721,38.3362583 26.4710808,36.7027027 28.5081967,36.7027027 C30.5453126,36.7027027 32.1967213,38.3362583 32.1967213,40.3513514 C32.1967213,42.3664444 30.5453126,44 28.5081967,44 Z" fill="#000000" fill-rule="nonzero" />\n    <path class="icon-solid" d="M41.3114754,37.7297297 C39.2743595,37.7297297 37.6229508,36.0961741 37.6229508,34.0810811 C37.6229508,32.0659881 39.2743595,30.4324324 41.3114754,30.4324324 C43.3485913,30.4324324 45,32.0659881 45,34.0810811 C45,36.0961741 43.3485913,37.7297297 41.3114754,37.7297297 Z" fill="#000000" fill-rule="nonzero" />\n    <path class="icon-solid" d="M31.6885246,31.2972973 C29.6514087,31.2972973 28,29.6637417 28,27.6486486 C28,25.6335556 29.6514087,24 31.6885246,24 C33.7256405,24 35.3770492,25.6335556 35.3770492,27.6486486 C35.3770492,29.6637417 33.7256405,31.2972973 31.6885246,31.2972973 Z" fill="#000000" fill-rule="nonzero" />\n    <path class="icon-solid" d="M20.6885246,32.2972973 C18.6514087,32.2972973 17,30.6637417 17,28.6486486 C17,26.6335556 18.6514087,25 20.6885246,25 C22.7256405,25 24.3770492,26.6335556 24.3770492,28.6486486 C24.3770492,30.6637417 22.7256405,32.2972973 20.6885246,32.2972973 Z" fill="#000000" fill-rule="nonzero" />\n    <path class="icon-solid" d="M41.0819672,25.5405405 C39.0448513,25.5405405 37.3934426,23.9069849 37.3934426,21.8918919 C37.3934426,19.8767989 39.0448513,18.2432432 41.0819672,18.2432432 C43.1190831,18.2432432 44.7704918,19.8767989 44.7704918,21.8918919 C44.7704918,23.9069849 43.1190831,25.5405405 41.0819672,25.5405405 Z" fill="#000000" fill-rule="nonzero" />\n    <path class="icon-solid" d="M27.6885246,21.2972973 C25.6514087,21.2972973 24,19.6637417 24,17.6486486 C24,15.6335556 25.6514087,14 27.6885246,14 C29.7256405,14 31.3770492,15.6335556 31.3770492,17.6486486 C31.3770492,19.6637417 29.7256405,21.2972973 27.6885246,21.2972973 Z" fill="#000000" fill-rule="nonzero" />\n  </g>\n</svg>\n';
}),define("text!res/icons/map-zoom-in.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M32.5,19 C33.3284271,19 34,19.6715729 34,20.5 L34,30.999 L44.5,31 C45.3284271,31 46,31.6715729 46,32.5 C46,33.3284271 45.3284271,34 44.5,34 L34,33.999 L34,44.5 C34,45.3284271 33.3284271,46 32.5,46 C31.6715729,46 31,45.3284271 31,44.5 L31,33.999 L20.5,34 C19.6715729,34 19,33.3284271 19,32.5 C19,31.6715729 19.6715729,31 20.5,31 L31,30.999 L31,20.5 C31,19.6715729 31.6715729,19 32.5,19 Z" fill="#000000" />\n  </g>\n</svg>\n'}),define("text!res/icons/map-zoom-out.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <rect class="icon-solid" fill="#000000" height="27" rx="1.5" transform="translate(32.500000, 32.500000) rotate(-270.000000) translate(-32.500000, -32.500000) " width="3" x="31" y="19" />\n  </g>\n</svg>\n'}),define("text!res/icons/play.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg'>\n  <g stroke='none' stroke-width='1' fill='#000000' fill-rule='evenodd' class='icon-solid'>\n    <path d='M19,41.208591 L19.0009242,23.6537521 C19.001376,15.0730538 23.9699612,10.8701338 31.9181813,16.6997342 L47.3490023,26.9532005 C54.5779877,31.6751866 54.1631317,34.4775281 47.2536712,38.6153226 L32.0602272,48.364467 C24.1930356,53.5062737 18.9995482,49.790995 19,41.208591 Z' />\n  </g>\n</svg>\n"}),define("text!res/icons/mini-player-jump.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1" transform="translate(12.000000, 5.390000)">\n    <path class="icon-hollow" d="M2.73453854,16.5009401 C0.996433206,19.4654122 0,22.9173748 0,26.6020669 C0,37.6477619 8.954305,46.6020669 20,46.6020669 C31.045695,46.6020669 40,37.6477619 40,26.6020669 C40,15.5563719 31.045695,6.60206689 20,6.60206689" stroke="#000000" stroke-linecap="round" stroke-width="3" />\n    <path class="icon-solid" d="M23.6278191,2.65151308 L23.6278191,10.4653527 C23.6278191,11.9295715 22.4408352,13.1165554 20.9766164,13.1165554 C20.463699,13.1165554 19.9617941,12.9677706 19.5317418,12.6882366 L12.0008626,7.79316519 C11.3189388,7.3499147 11.1254558,6.43778069 11.5687063,5.75585687 C11.6809532,5.58316942 11.8281752,5.4359474 12.0008626,5.32370055 L19.5317418,0.428629105 C20.7594067,-0.369353095 22.4015181,-0.0210264247 23.1995003,1.2066385 C23.4790343,1.63669077 23.6278191,2.13859574 23.6278191,2.65151308 Z" fill="#000000" />\n  </g>\n</svg>\n'}),define("text!res/icons/mini-player-toggle.svg",[],function(){return'<svg version="1.1" viewBox="0 0 80 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <rect class=" mini-player-rim icon-hollow" height="39.75" rx="19.875" stroke="#000000" stroke-linecap="round" stroke-width="3" width="64.5" x="7.75" y="12.125" />\n    <g class=" mini-player-pause icon-solid" fill="#000000" transform="translate(31.937500, 23.750000)">\n      <path d="M0,1.56715543 C0,0.701639383 0.682236671,0 1.51078601,0 L4.86421399,0 C5.69859806,0 6.375,0.708984375 6.375,1.56715543 L6.375,14.9328446 C6.375,15.7983606 5.69276333,16.5 4.86421399,16.5 L1.51078601,16.5 C0.676401937,16.5 0,15.7910156 0,14.9328446 L0,1.56715543 Z" />\n      <path d="M9.75,1.56715543 C9.75,0.701639383 10.4322367,0 11.260786,0 L14.614214,0 C15.4485981,0 16.125,0.708984375 16.125,1.56715543 L16.125,14.9328446 C16.125,15.7983606 15.4427633,16.5 14.614214,16.5 L11.260786,16.5 C10.4264019,16.5 9.75,15.7910156 9.75,14.9328446 L9.75,1.56715543 Z" />\n    </g>\n    <path class=" mini-player-play icon-solid" d="M34,36.0692317 L34.0004125,27.9999546 C34.0006142,24.0557411 36.2184039,22.1238222 39.7661908,24.8034629 L46.6539294,29.5165828 C49.8806769,31.6870963 49.6955008,32.9752237 46.6113772,34.877207 L39.8295947,39.3585097 C36.317976,41.7219984 33.9997983,40.0142292 34,36.0692317 Z" fill="#000000" />\n  </g>\n</svg>\n'}),define("text!res/icons/mini-player-failure.svg",[],function(){return'<svg version="1.1" viewBox="0 0 80 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <rect class=" mini-player-rim icon-hollow" height="39.75" rx="19.875" stroke="#000000" stroke-linecap="round" stroke-width="3" width="64.5" x="7.75" y="12.125" />\n    <path class="icon-solid" d="M40,20.825 C40.9181734,20.825 41.6711923,21.4864903 41.7441988,22.3278294 L41.75,22.4620968 L41.75,33.6879032 C41.75,34.5920468 40.9664983,35.325 40,35.325 C39.0818266,35.325 38.3288077,34.6635097 38.2558012,33.8221706 L38.25,33.6879032 L38.25,22.4620968 C38.25,21.5579532 39.0335017,20.825 40,20.825 Z" fill="#000000" fill-rule="nonzero" />\n    <path class="icon-solid" d="M40,38.5625 C41.3179522,38.5625 42.3977064,39.5823472 42.4931428,40.8759221 L42.5,41.0625 L42.5,41.1875 C42.5,42.5682119 41.3807119,43.6875 40,43.6875 C38.6820478,43.6875 37.6022936,42.6676528 37.5068572,41.3740779 L37.5,41.1875 L37.5,41.0625 C37.5,39.6817881 38.6192881,38.5625 40,38.5625 Z" fill="#000000" fill-rule="nonzero" />\n  </g>\n</svg>\n'}),define("text!res/icons/nav-close.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M43.2915492,20.7084508 C44.3309076,21.7478092 44.3309076,23.4329421 43.2915492,24.4723005 L35.763932,31.999932 L43.2915492,39.5276995 C44.3309076,40.5670579 44.3309076,42.2521908 43.2915492,43.2915492 C42.2521908,44.3309076 40.5670579,44.3309076 39.5276995,43.2915492 L31.999932,35.763932 L24.4723005,43.2915492 C23.4329421,44.3309076 21.7478092,44.3309076 20.7084508,43.2915492 C19.6690924,42.2521908 19.6690924,40.5670579 20.7084508,39.5276995 L28.235932,31.999932 L20.7084508,24.4723005 C19.6690924,23.4329421 19.6690924,21.7478092 20.7084508,20.7084508 C21.7478092,19.6690924 23.4329421,19.6690924 24.4723005,20.7084508 L31.999932,28.235932 L39.5276995,20.7084508 C40.5670579,19.6690924 42.2521908,19.6690924 43.2915492,20.7084508 Z" fill="#000000" />\n  </g>\n</svg>\n'}),define("text!res/icons/notify-me-bell.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M37.5523387,58.0372149 L38.3148365,56.726912 L24.7654837,56.7980218 L25.5380908,58.099045 C26.850637,60.3092928 29.0779042,61.6785715 31.5270408,61.6785715 C34.0000024,61.6785715 36.2457714,60.2824657 37.5523387,58.0372149 Z" fill="#000000" fill-rule="nonzero" />\n    <path class="icon-solid" d="M31.8743672,2.33256991 C29.5670155,2.49506245 27.7437085,4.41478296 27.7367459,6.76337571 L27.730342,8.47926272 L26.8486298,8.80886664 C20.7085556,11.1551166 17.0198328,13.8685127 15.8168826,17.0451073 C15.4002964,18.1451742 15.1324401,19.6099593 14.9609862,21.6206823 L14.8830505,22.6723776 L14.8197283,23.8200965 L14.7695661,25.0688728 L14.7311103,26.4237404 L14.6313113,32.326741 L14.5659824,34.3417122 L14.5141097,35.2980218 L14.4506882,36.0838116 L14.3740466,36.7146149 L14.3147825,37.0567175 L14.248405,37.3414432 C14.2133553,37.470229 14.1754524,37.5792243 14.1344178,37.6710181 L13.8887488,38.1270487 L13.3270974,39.0928467 L12.3359305,40.7229292 L11.0243428,42.821405 L9.02869489,45.9557083 L7.44335066,48.4174374 C7.24925432,48.7177388 7.14600248,49.0676997 7.14600248,49.4252669 C7.14600248,50.4505459 7.9770621,51.2821119 9.00231432,51.2821119 L54.9968991,51.2821119 C55.3413247,51.2821119 55.6789626,51.186315 55.9720665,51.0054308 C56.8447602,50.4668626 57.1156247,49.3228109 56.5770674,48.4501115 L52.3252584,41.6120691 L50.9862478,39.5011067 L49.9199993,37.8700208 C49.8819203,37.8136436 49.8456533,37.7603059 49.8111975,37.7100066 C49.7466254,37.615743 49.6884956,37.4890299 49.6362086,37.3243735 L49.5620854,37.0482447 C49.5504369,36.9972515 49.5391348,36.9437151 49.5281698,36.8875497 L49.4663499,36.518323 L49.4121704,36.0818806 L49.3442431,35.2921745 L49.2909775,34.3280564 L49.2508564,33.1756202 L49.2223624,31.82096 L49.1965891,29.0760365 L49.1851883,27.1255134 L49.1687852,25.7602803 L49.1425858,24.5020679 L49.1053182,23.3452498 L49.0557102,22.2841997 L48.9924902,21.3132914 C48.9572651,20.8494349 48.9164584,20.4172718 48.8693548,20.0136372 L48.7665394,19.2434683 C48.7293276,18.9987995 48.6891051,18.7658723 48.64566,18.5437491 L48.5054446,17.9088534 C48.4302909,17.6066737 48.3474093,17.3266929 48.2560841,17.0657463 L48.1146624,16.6956931 C46.843402,13.6304421 43.2540095,11.0271773 37.385294,8.80023122 L36.5255975,8.48330651 L36.5635858,6.69313313 C36.5635858,4.27870733 34.606307,2.3214285 32.1918812,2.3214285 L31.8743672,2.33256991 Z" fill="#000000" fill-rule="nonzero" />\n  </g>\n</svg>\n'}),define("text!res/icons/now-bar-dismiss.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <circle class="icon-hollow" cx="32" cy="32" r="20" stroke="#000000" stroke-linecap="round" stroke-width="3" />\n    <path class="icon-solid" d="M36.5078057,25.3708739 C37.0935922,24.7850875 38.0433396,24.7850875 38.6291261,25.3708739 C39.1783009,25.9200487 39.2126243,26.7891111 38.7320963,27.3782719 L38.6291261,27.4921943 L34.1205341,31.9995341 L38.6291261,36.5078057 C39.2149125,37.0935922 39.2149125,38.0433396 38.6291261,38.6291261 C38.0433396,39.2149125 37.0935922,39.2149125 36.5078057,38.6291261 L31.9995341,34.1205341 L27.4921943,38.6291261 C26.9430195,39.1783009 26.0739571,39.2126243 25.4847963,38.7320963 L25.3708739,38.6291261 C24.8216991,38.0799513 24.7873757,37.2108889 25.2679037,36.6217281 L25.3708739,36.5078057 L29.8785341,31.9995341 L25.3708739,27.4921943 C24.7850875,26.9064078 24.7850875,25.9566604 25.3708739,25.3708739 C25.9566604,24.7850875 26.9064078,24.7850875 27.4921943,25.3708739 L31.9995341,29.8785341 L36.5078057,25.3708739 Z" fill="#000000" fill-rule="nonzero" />\n  </g>\n</svg>\n'}),define("text!res/icons/now-bar-manage.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <circle class="icon-hollow" cx="32" cy="32" r="20" stroke="#000000" stroke-linecap="round" stroke-width="3" />\n    <circle class="icon-solid" cx="32" cy="32" fill="#000000" r="2.5" />\n    <circle class="icon-solid" cx="24" cy="32" fill="#000000" r="2.5" />\n    <circle class="icon-solid" cx="40" cy="32" fill="#000000" r="2.5" />\n  </g>\n</svg>\n'}),define("text!res/icons/search.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g class="icon-hollow" fill="none" fill-rule="evenodd" stroke="#000000" stroke-linecap="round" stroke-width="4.61538462" transform="translate(17.000000, 17.000000)">\n    <line class="color-secondary icon-hollow" x1="20.5" x2="28.5" y1="20.5" y2="28.5" />\n    <circle class="color-secondary icon-hollow" cx="11.5384615" cy="11.5384615" r="11.5384615" />\n  </g>\n</svg>\n'}),define("text!res/icons/shamrock.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'>\n  <defs>\n    <path d='M47.1061214,17.4121882 C55.1627474,25.7550686 54.9306923,39.0494954 46.5878118,47.1061214 C38.2449314,55.1627474 24.9505046,54.9306923 16.8938786,46.5878118 C8.83725262,38.2449314 9.0693077,24.9505046 17.4121882,16.8938786 C25.7550686,8.83725262 39.0494954,9.0693077 47.1061214,17.4121882 Z' id='path-1' />\n    <mask id='mask-2' maskContentUnits='userSpaceOnUse' maskUnits='objectBoundingBox' x='0' y='0' width='42' height='42' fill='white'>\n      <use xlink:href='#path-1' />\n    </mask>\n  </defs>\n  <g stroke='none' stroke-width='1' fill='none' fill-rule='evenodd'>\n    <path d='M25.8135596,23.2116354 L30.6751157,31.6310056 L22.2551172,36.4919233 C21.3287815,37.0264429 20.2500294,37.1682892 19.2172172,36.891548 C18.1840977,36.6147245 17.3204867,35.9524236 16.7855163,35.0263481 C15.6818434,33.1144263 16.339225,30.6610448 18.2509123,29.5574158 L19.7364463,28.7003274 L18.8785627,27.2149927 C17.7748074,25.3033782 18.4322714,22.8496893 20.3439587,21.7460603 C21.2702944,21.2115407 22.3494362,21.0694694 23.3825558,21.3462929 C24.4153679,21.6230341 25.2785891,22.28556 25.8135596,23.2116354 Z' fill='#000000' fill-rule='nonzero' class='icon-solid' />\n    <path d='M31.629596,33.2845379 L36.4911521,41.703908 C37.5949074,43.6155224 36.9374434,46.0692114 35.0257561,47.1728404 C34.0994204,47.70736 33.0205859,47.8495137 31.987159,47.5726078 C30.9543469,47.2958666 30.0911256,46.6333407 29.5561552,45.7072653 L28.6991114,44.222485 L27.2138848,45.0796558 C26.2875491,45.6141754 25.2084072,45.7562467 24.175595,45.4795056 C23.1427829,45.2027644 22.2795617,44.5402384 21.7445912,43.614163 C20.6405286,41.7024662 21.2979925,39.2487773 23.2099872,38.1452306 L31.629596,33.2845379 Z' fill='#000000' fill-rule='nonzero' class='icon-solid' />\n    <path d='M44.2217785,35.2611524 L45.079212,36.7457076 C45.6137928,37.672008 45.7556829,38.7507031 45.47896,39.783447 C45.2020723,40.8168057 44.5398444,41.680038 43.6137337,42.2149473 C42.687398,42.7494669 41.6086458,42.8913132 40.5755263,42.6144897 C39.5427142,42.3377485 38.6794106,41.67553 38.1444401,40.7494545 L33.2829664,32.329777 L41.7028825,27.4691667 C42.6292183,26.9346471 43.7080527,26.7924934 44.7408649,27.0692346 C45.7739844,27.3460581 46.6372056,28.0085841 47.1721761,28.9346595 C47.7067568,29.8609599 47.8486469,30.939655 47.571924,31.9723989 C47.2951187,33.0054502 46.6328908,33.8686826 45.7064727,34.4035095 L44.2217785,35.2611524 Z' fill='#000000' fill-rule='nonzero' class='icon-solid' />\n    <path d='M32.3284037,30.6765521 L27.467155,22.2572643 C26.363257,20.3449528 27.0205563,17.8918786 28.9326334,16.7880245 C29.8589691,16.253505 30.9378036,16.1113513 31.9706157,16.3880924 C33.0034278,16.6648336 33.8669564,17.3274419 34.4019269,18.2535173 L35.2595031,19.7387697 L36.7441973,18.8811268 C37.670533,18.3466072 38.7493675,18.2044535 39.7821797,18.4811947 C40.8156066,18.7581006 41.6788278,19.4206265 42.2137983,20.346702 C43.3174712,22.2586237 42.6601719,24.711698 40.7483199,25.8159417 L32.3284037,30.6765521 Z' fill='#000000' fill-rule='nonzero' class='icon-solid' />\n    <use stroke='#000000' mask='url(#mask-2)' stroke-width='7.00874319' stroke-dasharray='1.693829523889642,17.61582831332558' xlink:href='#path-1' class='icon-hollow sparks' />\n  </g>\n</svg>\n"}),define("text!res/icons/shamrock-badge.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="shamrock-leaf icon-solid" d="M18.5942749,20.4468397 C19.8675138,19.712148 21.3507831,19.516916 22.7707844,19.8974042 C24.1904246,20.2777956 25.3770587,21.1883602 26.1125556,22.4615625 L26.1125556,22.4615625 L31.7242515,32.1800444 L22.004801,37.7911439 C20.7314841,38.5258806 19.2486597,38.7208365 17.8289887,38.3404368 C16.4089566,37.9599403 15.2219721,37.0495454 14.4864265,35.7762586 C13.7278571,34.4621688 13.5737657,32.9619948 13.9385654,31.6005436 C14.3033855,30.2390168 15.1869598,29.0169306 16.5012961,28.2581562 C15.8208935,26.6511054 15.6667498,25.150872 16.031581,23.7893034 C16.3964122,22.4277348 17.2800213,21.2055664 18.5942749,20.4468397 Z" fill="#000000" fill-rule="nonzero" stroke="#FFFFFF" stroke-width="3" />\n    <path class="shamrock-leaf icon-solid" d="M32.1785859,32.2355848 L37.7901655,41.9538651 C38.5488212,43.2677953 38.702965,44.7680287 38.3381338,46.1295973 C37.9733026,47.4911659 37.0896935,48.7133343 35.7754399,49.4720611 C34.502201,50.2067527 33.0193542,50.402098 31.5989304,50.0214966 C30.1792902,49.6411051 28.9926561,48.7305405 28.2570434,47.4571376 C26.6902907,48.1135906 25.206976,48.3087775 23.7873665,47.9283943 C22.3677262,47.5480028 21.1810922,46.6374383 20.4456543,45.3643383 C19.6867662,44.0503151 19.5325394,42.5500119 19.897379,41.188412 C20.2622186,39.826812 21.1459345,38.6046248 22.4600301,37.8461677 L22.4600301,37.8461677 L32.1785859,32.2355848 Z" fill="#000000" fill-rule="nonzero" stroke="#FFFFFF" stroke-width="3" />\n    <path class="shamrock-leaf icon-solid" d="M41.9531987,26.1699461 C43.2265157,25.4352094 44.7094532,25.2399544 46.1290934,25.6203458 C47.5491255,26.0008423 48.7356977,26.9114232 49.4713472,28.1848899 C50.2061944,29.4582041 50.4011998,30.9410035 50.0208127,32.3606275 C49.6402981,33.7807276 48.7299397,34.9673671 47.4567707,35.7023755 C48.1132303,37.2692522 48.3082358,38.7520516 47.9278487,40.1716756 C47.5472517,41.592083 46.6369395,42.7785986 45.3634175,43.5141679 C44.0901396,44.2488821 42.6073605,44.4438831 41.1872978,44.0633784 C39.7676267,43.6829787 38.5809411,42.7727298 37.8454268,41.4994974 L37.8454268,41.4994974 L32.2338432,31.7806907 Z" fill="#000000" fill-rule="nonzero" stroke="#FFFFFF" stroke-width="3" />\n    <path class="shamrock-leaf icon-solid" d="M28.1829496,14.4888039 C29.4562665,13.7540673 30.939204,13.5588122 32.3588443,13.9392037 C33.7784538,14.3195869 34.9654485,15.2302811 35.7009403,16.5034745 C37.2678304,15.8471695 38.750768,15.6519145 40.1704082,16.032306 C41.590832,16.4129074 42.7773424,17.3235047 43.512888,18.5967915 C44.2714632,19.9108913 44.4255714,21.4109711 44.0607697,22.7724297 C43.6959882,24.1338126 42.812527,25.3559227 41.4982469,26.115022 L41.4982469,26.115022 L31.7793664,31.7254925 L26.1680652,22.0071748 C25.4093528,20.6928373 25.2552249,19.1926586 25.6200148,17.8312443 C25.9848249,16.4697544 26.8684332,15.2476824 28.1829496,14.4888039 Z" fill="#000000" fill-rule="nonzero" stroke="#FFFFFF" stroke-width="3" />\n  </g>\n</svg>\n'}),define("text!res/icons/share-android.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'>\n  <g stroke='none' stroke-width='1' fill='none' fill-rule='evenodd'>\n    <circle fill='#000000' cx='42' cy='17' r='6' class='icon-solid' />\n    <circle fill='#000000' cx='42' cy='47' r='6' class='icon-solid' />\n    <circle fill='#000000' cx='18' cy='32' r='6' class='icon-solid' />\n    <rect fill='#000000' transform='translate(29.895230, 39.454621) scale(1, -1) rotate(-32.000000) translate(-29.895230, -39.454621) ' x='15.8952305' y='37.9546207' width='28' height='3' rx='1.5' class='icon-solid' />\n    <rect fill='#000000' transform='translate(29.895230, 24.454621) rotate(-32.000000) translate(-29.895230, -24.454621) ' x='15.8952305' y='22.9546207' width='28' height='3' rx='1.5' class='icon-solid' />\n  </g>\n</svg>\n"}),define("text!res/icons/share-ios.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'>\n  <g stroke='none' stroke-width='1' fill='none' fill-rule='evenodd'>\n    <path d='M38.166196,24 L41.7058824,24 C44.6297428,24 47,26.3702572 47,29.2941176 L47,48.7058824 C47,51.6297428 44.6297428,54 41.7058824,54 L22.2941176,54 C19.3702572,54 17,51.6297428 17,48.7058824 L17,29.2941176 C17,26.3702572 19.3702572,24 22.2941176,24 L25.8687794,24' stroke='#000000' stroke-width='3' stroke-linecap='round' class='icon-hollow' />\n    <path d='M41.2307692,15.511432 C41.8026756,16.0746089 41.8026756,17.0132371 41.2307692,17.576414 C40.6588629,18.1395909 39.7056856,18.1395909 39.1337793,17.576414 L33.3979933,12.9434416 L33.3979933,36.8543923 C33.3979933,37.66787 32.7625418,38.2936221 31.9364548,38.2936221 C31.173913,38.2936221 30.4749164,37.66787 30.4749164,36.8543923 L30.4749164,12.9434416 L24.7391304,17.576414 C24.1672241,18.1395909 23.2140468,18.1395909 22.6421405,17.576414 C22.0702341,17.0132371 22.0702341,16.0746089 22.6421405,15.511432 L30.8561873,8.43802647 C31.1103679,8.12515042 31.4916388,8 31.8729097,8 C32.2541806,8 32.6354515,8.12515042 32.8896321,8.43802647 L41.2307692,15.511432 Z' fill='#000000' fill-rule='nonzero' class='icon-solid' />\n  </g>\n</svg>\n"}),define("text!res/icons/share-generic.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M26.3569094,3 L37.6430906,3 C46.1125186,3 49.1837379,3.88184331 52.2800342,5.53776069 C55.3763305,7.19367807 57.8063219,9.62366952 59.4622393,12.7199658 C61.1181567,15.8162621 62,18.8874814 62,27.3569094 L62,38.6430906 C62,47.1125186 61.1181567,50.1837379 59.4622393,53.2800342 C57.8063219,56.3763305 55.3763305,58.8063219 52.2800342,60.4622393 C49.1837379,62.1181567 46.1125186,63 37.6430906,63 L26.3569094,63 C17.8874814,63 14.8162621,62.1181567 11.7199658,60.4622393 C8.62366952,58.8063219 6.19367807,56.3763305 4.53776069,53.2800342 C2.88184331,50.1837379 2,47.1125186 2,38.6430906 L2,27.3569094 C2,18.8874814 2.88184331,15.8162621 4.53776069,12.7199658 C6.19367807,9.62366952 8.62366952,7.19367807 11.7199658,5.53776069 C14.8162621,3.88184331 17.8874814,3 26.3569094,3 Z" fill="#000000" />\n    <path d="M27.3147888,20 L22,46 M41.3147888,20 L36,46 M20.0882991,26 L46.0882991,26 M17.2264897,40 L43.2264897,40" stroke="#FFFFFF" stroke-linecap="round" stroke-width="5" />\n  </g>\n</svg>\n'}),define("text!res/icons/star-indicator.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class=" icon-outline" d="M28.0292527,5.40115059 L21.046,19.55 L5.43160417,21.8193033 C4.4679074,21.9593366 3.5772488,22.4131499 2.8975127,23.1104874 L2.74258663,23.2776796 C1.19442805,25.035832 1.28107111,27.7184579 2.97754735,29.3721136 L14.276,40.386 L11.609081,55.9372428 C11.444462,56.8970456 11.6008353,57.8843483 12.0539928,58.7463049 L12.1616306,58.9393988 C13.3537815,60.9595375 15.9348755,61.708651 18.0338852,60.6051362 L32,53.262 L45.9661148,60.6051362 C46.8280714,61.0582936 47.8153741,61.214667 48.7751768,61.050048 L48.9857667,61.0087483 C51.2789655,60.5018888 52.7921626,58.2766728 52.390919,55.9372428 L49.723,40.386 L61.0224527,29.3721135 C61.7197902,28.6923775 62.1736034,27.8017189 62.3136367,26.8380221 L62.3394342,26.624977 C62.5660196,24.2873871 60.9173171,22.1606215 58.5683958,21.8193033 L42.952,19.549 L35.9707474,5.40115059 C35.5397691,4.52789318 34.8329384,3.82106251 33.959681,3.39008421 C31.7666978,2.3077823 29.1115546,3.20816738 28.0292527,5.40115059 Z" fill="#FFFFFF" fill-rule="nonzero" />\n    <path class=" icon-solid" d="M32,47.7268005 L18.270192,54.9449879 C17.7813474,55.2019887 17.1767203,55.0140422 16.9197195,54.5251976 C16.8173804,54.3305371 16.7820657,54.107569 16.8192426,53.8908114 L19.4414026,38.6024454 L19.4414026,38.6024454 L8.33375455,27.7751645 C7.93827097,27.3896633 7.93017867,26.75655 8.31567988,26.3610664 C8.46918848,26.2035828 8.67033089,26.1010956 8.88796792,26.0694711 L24.23836,23.8389286 L24.23836,23.8389286 L31.103264,9.92911375 C31.3476863,9.43386009 31.9473121,9.23052109 32.4425658,9.47494339 C32.6397784,9.57227363 32.7994059,9.73190115 32.8967361,9.92911375 L39.7616401,23.8389286 L39.7616401,23.8389286 L55.1120321,26.0694711 C55.658577,26.1488887 56.0372584,26.6563316 55.9578408,27.2028764 C55.9262163,27.4205135 55.8237291,27.6216559 55.6662455,27.7751645 L44.5585976,38.6024454 L44.5585976,38.6024454 L47.1807575,53.8908114 C47.2741185,54.4351479 46.9085307,54.9521038 46.3641942,55.0454648 C46.1474366,55.0826416 45.9244685,55.0473269 45.729808,54.9449879 L32,47.7268005 L32,47.7268005 Z" fill="#000000" fill-rule="nonzero" />\n  </g>\n</svg>\n'}),define("text!res/icons/tag-button.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-hollow" d="M43.154899,15.3854386 C43.9184747,15.3854346 44.6567497,15.659174 45.2357499,16.1569753 C50.1384637,20.3721336 53.590535,24.7141683 55.5552281,29.2080925 L55.5552281,29.2080925 L55.5552281,37.9740282 C53.5905346,42.4679533 50.1384625,46.8099887 45.2357539,51.0251419 C44.6567485,51.5229415 43.9184707,51.796682 43.1548922,51.796682 L43.1548922,51.796682 L4.69181469,51.796682 C3.8104194,51.796682 3.01246573,51.439426 2.43486088,50.8618212 C1.85725603,50.2842163 1.5,49.4862626 1.5,48.6048673 L1.5,48.6048673 L1.5,18.5772533 C1.5,17.695858 1.85725603,16.8979044 2.43486088,16.3202995 C3.01246573,15.7426946 3.8104194,15.3854386 4.69181469,15.3854386 L4.69181469,15.3854386 Z" stroke="#000000" stroke-width="3" />\n    <path class="icon-solid" d="M42.6288363,19.9847977 L43.1546663,20.4514917 C46.5896009,23.5440603 49.0855887,26.6281793 50.6847358,29.6840808 L50.8882376,30.082515 L50.955869,30.2232757 L50.955869,36.9579066 L50.8882375,37.099606 C49.3008554,40.2857744 46.738944,43.5036032 43.1546626,46.7306323 L42.6278979,47.1973229 L6.0993591,47.1973229 L6.0993591,19.9847977 L42.6288363,19.9847977 Z M41.1030581,28.4300642 C38.2527186,28.4300642 35.942062,30.7407209 35.942062,33.5910603 C35.942062,36.4413998 38.2527186,38.7520565 41.1030581,38.7520565 C43.9533976,38.7520565 46.2640543,36.4413998 46.2640543,33.5910603 C46.2640543,30.7407209 43.9533976,28.4300642 41.1030581,28.4300642 Z" fill="#000000" fill-opacity="0.06" fill-rule="nonzero" />\n    <path class="icon-solid" d="M41.1030581,36.6407399 C39.4187666,36.6407399 38.0533786,35.2753518 38.0533786,33.5910603 C38.0533786,31.9067688 39.4187666,30.5413808 41.1030581,30.5413808 C42.7873496,30.5413808 44.1527377,31.9067688 44.1527377,33.5910603 C44.1527377,35.2753518 42.7873496,36.6407399 41.1030581,36.6407399 Z" fill="#000000" />\n    <line class=" color-tag" stroke="#D6B40F" stroke-linecap="round" stroke-width="3" x1="45.7340342" x2="46.220632" y1="3.5124065" y2="6.07145196" />\n    <line class=" color-tag" stroke="#D6B40F" stroke-linecap="round" stroke-width="3" x1="59.1216905" x2="54.5724942" y1="3.27401158" y2="8.67788407" />\n    <line class=" color-tag" stroke="#D6B40F" stroke-linecap="round" stroke-width="3" x1="62.2516585" x2="58.7954663" y1="15.2383018" y2="16.2269833" />\n  </g>\n</svg>\n'}),define("text!res/icons/tag-add.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M31.8507377,18.0054857 C30.8158778,18.0818349 30,18.9456382 30,20 L30,29.999 L19.9999524,30 C18.8954305,30 18,30.8954305 18,32 L18.0054857,32.1492623 C18.0818349,33.1841222 18.9456382,34 20,34 L30,33.998 L30,44 C30,45.1045695 30.8954305,46 32,46 L32.1492623,45.9945143 C33.1841222,45.9181651 34,45.0543618 34,44 L34,33.998 L43.9999524,34 C45.1045695,34 46,33.1045695 46,32 L45.9945143,31.8507377 C45.9181651,30.8158778 45.0543618,30 44,30 L34,29.999 L34,20 C34,18.8954305 33.1045695,18 32,18 L31.8507377,18.0054857 Z" fill="#000000" fill-rule="nonzero" />\n  </g>\n</svg>\n'}),define("text!res/icons/tag-list.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M35,31.962963 L35,32.037037 C35,33.6734363 33.6734363,35 32.037037,35 L31.962963,35 C30.3265637,35 29,33.6734363 29,32.037037 L29,31.962963 C29,30.3265637 30.3265637,29 31.962963,29 L32.037037,29 C33.6734363,29 35,30.3265637 35,31.962963 Z" fill="#000000" />\n    <path class="icon-solid" d="M22,31.962963 L22,32.037037 C22,33.6734363 20.6734363,35 19.037037,35 L18.962963,35 C17.3265637,35 16,33.6734363 16,32.037037 L16,31.962963 C16,30.3265637 17.3265637,29 18.962963,29 L19.037037,29 C20.6734363,29 22,30.3265637 22,31.962963 Z" fill="#000000" />\n    <path class="icon-solid" d="M48,31.962963 L48,32.037037 C48,33.6734363 46.6734363,35 45.037037,35 L44.962963,35 C43.3265637,35 42,33.6734363 42,32.037037 L42,31.962963 C42,30.3265637 43.3265637,29 44.962963,29 L45.037037,29 C46.6734363,29 48,30.3265637 48,31.962963 Z" fill="#000000" />\n  </g>\n</svg>\n'}),define("text!res/icons/tag-line-head.svg",[],function(){return'<svg version="1.1" viewBox="0 0 38 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="tag-line-head-fill" d="M0,0 L16.9161288,0 C19.2540921,-2.20583373e-15 21.4750591,1.02273501 22.9949561,2.79924437 L31.6773613,12.9475469 C34.4669956,16.2081702 36,20.3581256 36,24.6492471 L36,40.5716923 C36,44.0920219 34.8389989,47.5140862 32.696885,50.3076624 L24.5992307,60.867985 C23.0852564,62.842391 20.7388391,64 18.2507882,64 L0,64 L0,64 L0,0 Z" fill="#FBF2C7" />\n    <path class="tag-line-head-eye-1" d="M17,28 C18.3807119,28 19.6307119,28.5596441 20.5355339,29.4644661 C21.4403559,30.3692881 22,31.6192881 22,33 C22,34.3807119 21.4403559,35.6307119 20.5355339,36.5355339 C19.6307119,37.4403559 18.3807119,38 17,38 C15.6192881,38 14.3692881,37.4403559 13.4644661,36.5355339 C12.5596441,35.6307119 12,34.3807119 12,33 C12,31.6192881 12.5596441,30.3692881 13.4644661,29.4644661 C14.3692881,28.5596441 15.6192881,28 17,28 Z" fill="#010101" stroke="#FFFFFF" stroke-linecap="round" stroke-width="4" />\n    <path class="tag-line-head-eye-2" d="M17,28 C18.3807119,28 19.6307119,28.5596441 20.5355339,29.4644661 C21.4403559,30.3692881 22,31.6192881 22,33 C22,34.3807119 21.4403559,35.6307119 20.5355339,36.5355339 C19.6307119,37.4403559 18.3807119,38 17,38 C15.6192881,38 14.3692881,37.4403559 13.4644661,36.5355339 C12.5596441,35.6307119 12,34.3807119 12,33 C12,31.6192881 12.5596441,30.3692881 13.4644661,29.4644661 C14.3692881,28.5596441 15.6192881,28 17,28 Z" fill="#010101" stroke="#FFFFFF" stroke-linecap="round" stroke-width="4" />\n  </g>\n</svg>\n'}),define("text!res/icons/timeline-tag.svg",[],function(){return'<svg viewBox="0 0 64 64" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n  <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" stroke-linecap="round">\n    <circle stroke="#FFFFFF" stroke-width="6.66666667" fill="#000000" cx="32" cy="32" r="8" class="icon-solid timeline-tag-eye-1" />\n    <circle stroke="#FFFFFF" stroke-width="6.66666667" fill="#000000" cx="32" cy="32" r="8" class="icon-solid timeline-tag-eye-2" />\n  </g>\n</svg>\n'}),define("text!res/icons/timeline-marks.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'>\n  <g stroke='none' stroke-width='1' fill='none' fill-rule='evenodd'>\n    <path d='M15,31.9939817 C15,30.3404512 16.3433124,29 18.0023584,29 L45.9976416,29 C47.6557983,29 49,30.3387041 49,31.9939817 L49,50.8434578 C49,51.8354833 48.2871507,52.2701842 47.3969141,51.8112856 L33.9959649,45.3076284 C33.059198,45.0050633 31.5203865,44.9506664 30.5932357,45.2952078 L16.5918433,51.8480459 C15.7126925,52.2852527 15,51.8259475 15,50.8434578 L15,31.9939817 Z' stroke='#000000' stroke-width='3' fill='#000000' class='icon-solid icon-hollow' />\n    <path d='M18,25 L18,22 C18,20.3431458 19.3504982,19 20.9964905,19 L43.0035095,19 C44.6584255,19 46,20.3465171 46,22 L46,25' stroke='#000000' stroke-width='3' fill='#000000' class='icon-solid icon-hollow' />\n    <path d='M21,15 L21,13 C21,11.8954305 21.8896739,11 22.991155,11 L41.008845,11 C42.1085295,11 43,11.8877296 43,13 L43,15' stroke='#000000' stroke-width='3' fill='#000000' class='icon-solid icon-hollow' />\n  </g>\n</svg>\n";
}),define("text!res/icons/title-status-available.svg",[],function(){return'<svg version="1.1" viewBox="0 0 96 96" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class=" title-status-field" d="M97,-1 L97,97 L-1,97 L-1,-1 L97,-1 Z M70,24 L26,24 L25.6813802,24.0055332 C23.3548121,24.0864847 21.252633,25.0512245 19.6979287,26.6059288 C18.0948269,28.2090306 17.0718431,30.4422228 17.0000004,32.9854991 L17.0000004,32.9854991 L16.999444,55.1139911 L18.7684524,52.9863333 L18.9276383,52.803519 C19.8530959,51.7887633 21.1789611,51.1372381 23.0344128,51.0001094 C24.5110379,51.0092241 25.8494734,51.6011231 26.831089,52.5827387 C27.8182123,53.569862 28.4423921,54.9477651 28.5,56.5176814 L28.5,56.5176814 L28.5,60.5 L32.5,60.5 L32.7723074,60.5066565 C34.1255322,60.5730271 35.3502008,61.1328034 36.2721799,62.0547825 C37.250959,63.0335617 37.8852226,64.4138527 37.9998953,66.0326736 C37.9900717,67.7214658 37.2190395,69.2297671 36.0128147,70.2322558 L36.0128147,70.2322558 L33.8840878,72.0014324 L70.0000397,72 L70.3186545,71.9944668 C72.6451879,71.9135153 74.747367,70.9487755 76.3020713,69.3940712 C77.9051758,67.7909667 78.9281604,65.5577697 79,63.014488 L79,63.014488 L79,33 L78.9943189,32.6771989 C78.911229,30.320241 77.9218285,28.1939065 76.363961,26.636039 C74.7352814,25.0073593 72.4852814,24 70,24 L70,24 Z" fill="#FFFFFF" stroke="#FFFFFF" stroke-width="2" />\n    <path class=" title-status-shadow icon-hollow" d="M70,26 C71.8934851,26 73.6113955,26.7517777 74.8714713,27.9731865 C76.1321409,29.195171 76.934789,30.8871473 76.9961952,32.766679 L76.9961952,32.766679 L76.9999981,62.9847595 C76.9385332,64.9335841 76.1768352,66.6531089 74.9655042,67.9027878 C73.7494631,69.1573258 72.0821387,69.9357917 70.2333075,69.9961956 L70.2333075,69.9961956 L38.8447961,70.0009878 C39.5216124,68.9298369 39.9346401,67.6753998 39.9928939,66.3290454 C39.8574902,63.9832304 39.0431756,62.1375345 37.8228538,60.8156565 C36.5125359,59.3962928 34.7283514,58.5692864 32.7507942,58.5041246 L32.7507942,58.5041246 L30.5,58.5012682 L30.5,56.4834743 C30.4333958,54.4062162 29.6175782,52.5872511 28.3407439,51.2637531 C27.0370297,49.912393 25.2504468,49.0745982 23.2683653,49.0047238 C21.4834716,49.1096685 20.1930719,49.490635 19.1656618,50.0736725 L19.1656618,50.0736725 L19.0001498,33.0105942 C19.0626779,31.0636828 19.8241276,29.3458978 21.0344958,28.0972122 C22.2505298,26.8426815 23.9178419,26.0642173 25.7666603,26.0038055 L25.7666603,26.0038055 Z" stroke="#000000" stroke-opacity="0.15" stroke-width="2" />\n    <path class=" title-status-plus icon-solid" d="M23,55 C23.8284271,55 24.5,55.6715729 24.5,56.5 L24.5,64.5 L32.5,64.5 C33.3284271,64.5 34,65.1715729 34,66 C34,66.8284271 33.3284271,67.5 32.5,67.5 L24.5,67.5 L24.5,75.5 C24.5,76.3284271 23.8284271,77 23,77 C22.1715729,77 21.5,76.3284271 21.5,75.5 L21.5,67.499 L13.5,67.5 C12.6715729,67.5 12,66.8284271 12,66 C12,65.1715729 12.6715729,64.5 13.5,64.5 L21.5,64.499 L21.5,56.5 C21.5,55.6715729 22.1715729,55 23,55 Z" fill="#000000" />\n  </g>\n</svg>\n'}),define("text!res/icons/title-status-available-ld.svg",[],function(){return'<svg version="1.1" viewBox="0 0 96 96" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class=" title-status-field" d="M97,-1 L97,97 L-1,97 L-1,-1 L97,-1 Z M58.7308608,24.0007121 L26.0000218,24 L25.6813993,24.0055332 C23.3548121,24.0864847 21.252633,25.0512245 19.6979287,26.6059288 C18.0948269,28.2090306 17.0718431,30.4422228 17.0000004,32.9854991 L17.0000004,32.9854991 L16.999444,55.1139911 L18.7684524,52.9863333 L18.9276383,52.803519 C19.8530959,51.7887633 21.1789611,51.1372381 23.0344128,51.0001094 C24.5110379,51.0092241 25.8494734,51.6011231 26.831089,52.5827387 C27.8182123,53.569862 28.4423921,54.9477651 28.5,56.5176814 L28.5,56.5176814 L28.5,60.5 L32.5,60.5 L32.7723074,60.5066565 C34.1255322,60.5730271 35.3502008,61.1328034 36.2721799,62.0547825 C37.250959,63.0335617 37.8852226,64.4138527 37.9998953,66.0326736 C37.9900717,67.7214658 37.2190395,69.2297671 36.0128147,70.2322558 L36.0128147,70.2322558 L33.8840878,72.0014324 L70.0000397,72 L70.3186545,71.9944668 C72.6451879,71.9135153 74.747367,70.9487755 76.3020713,69.3940712 C77.9051704,67.790972 78.9281535,65.5577847 78.9999993,63.0145136 L78.9999993,63.0145136 L79.0006928,49.1365227 L78.6917674,49.2575569 C77.2402446,49.7897933 75.655304,49.865167 74.1373834,49.4584511 C73.1429924,49.1920111 72.2283583,48.7303509 70.2683228,47.770964 C69.4354977,47.8963828 68.5832105,47.8735279 67.1569858,47.5879262 C65.2261222,47.0628147 63.594268,45.8058827 62.5927109,44.0721509 C61.8209151,42.7358096 61.5037882,41.2606487 61.5937575,39.8265208 C61.6081941,39.5963986 61.6331624,39.3665382 61.6687646,39.1377013 C61.4530662,39.0565534 61.2406488,38.9653583 61.0323306,38.864259 C59.6864767,38.2111002 58.5595187,37.167745 57.7971201,35.8480048 C57.0188546,34.4998268 56.70438,33.009943 56.8289215,31.5208916 C56.9571254,29.9880518 57.5480399,28.4590546 58.7432196,26.3269692 C58.6176982,25.5504634 58.6161775,24.7656134 58.7308608,24.0007121 L58.7308608,24.0007121 Z" fill="#FFFFFF" stroke="#FFFFFF" stroke-width="2" />\n    <path class=" title-status-shadow icon-hollow" d="M56.602,26 L56.4645153,26.2334725 C55.5055902,27.9138049 54.9550446,29.6465467 54.8273169,31.3369754 C54.681481,33.2670595 55.08277,35.1463819 56.0653229,36.8484439 C56.9182389,38.3248731 58.1323667,39.5271217 59.579041,40.3572363 C59.588458,41.9615218 60.0017528,43.5849787 60.8609138,45.0725902 C62.0756348,47.1753167 64.0237436,48.7231169 66.3350808,49.4320257 C68.1581735,49.8315728 69.0706176,49.8875078 69.8822905,49.8265757 C71.6082005,50.6605275 72.5789816,51.1114376 73.6197568,51.3903058 C74.632994,51.6617955 75.6698266,51.7630912 76.6929687,51.6993614 L76.6929687,51.6993614 L76.999574,62.9978673 C76.9351146,64.9412941 76.1741186,66.6559115 74.9655042,67.9027878 C73.7494631,69.1573258 72.0821387,69.9357917 70.2333075,69.9961956 L70.2333075,69.9961956 L38.8447961,70.0009878 C39.5216124,68.9298369 39.9346401,67.6753998 39.9928939,66.3290454 C39.8574902,63.9832304 39.0431756,62.1375345 37.8228538,60.8156565 C36.5125359,59.3962928 34.7283514,58.5692864 32.7507942,58.5041246 L32.7507942,58.5041246 L30.5,58.5012682 L30.5,56.4834743 C30.4333958,54.4062162 29.6175782,52.5872511 28.3407439,51.2637531 C27.0370297,49.912393 25.2504468,49.0745982 23.2683653,49.0047238 C21.4834716,49.1096685 20.1930719,49.490635 19.1656618,50.0736725 L19.1656618,50.0736725 L19.0001498,33.0105942 C19.0626779,31.0636828 19.8241276,29.3458978 21.0344958,28.0972122 C22.2505311,26.8426802 23.9178453,26.0642157 25.766666,26.0038053 L25.766666,26.0038053 L56.602,26 Z" stroke="#000000" stroke-opacity="0.15" stroke-width="2" />\n    <path class=" title-status-plus icon-solid" d="M23,55 C23.8284271,55 24.5,55.6715729 24.5,56.5 L24.5,64.5 L32.5,64.5 C33.3284271,64.5 34,65.1715729 34,66 C34,66.8284271 33.3284271,67.5 32.5,67.5 L24.5,67.5 L24.5,75.5 C24.5,76.3284271 23.8284271,77 23,77 C22.1715729,77 21.5,76.3284271 21.5,75.5 L21.5,67.499 L13.5,67.5 C12.6715729,67.5 12,66.8284271 12,66 C12,65.1715729 12.6715729,64.5 13.5,64.5 L21.5,64.499 L21.5,56.5 C21.5,55.6715729 22.1715729,55 23,55 Z" fill="#000000" />\n    <g class=" title-status-badge" fill="#419305" fill-rule="nonzero" transform="translate(75.214026, 31.238489) rotate(-345.000000) translate(-75.214026, -31.238489) translate(57.235443, 13.225518)">\n      <path d="M11.3997926,12.2691372 L15.7266606,19.7623427 L8.23271802,24.0885399 C7.40826337,24.5642602 6.44815557,24.6905029 5.5289351,24.4442043 C4.60944105,24.1978325 3.84081253,23.6083873 3.36467967,22.7841839 C2.38239191,21.0825812 2.96747278,18.8990815 4.66890717,17.9168561 L5.99105781,17.1540509 L5.22752674,15.832109 C4.24516568,14.1307798 4.83031985,11.9470066 6.53175424,10.9647812 C7.35620888,10.4890609 8.31666358,10.362618 9.23615763,10.6089898 C10.1553781,10.8552884 10.9236597,11.4449338 11.3997926,12.2691372 Z" transform="translate(9.307361, 17.526597) rotate(-375.000000) translate(-9.307361, -17.526597) " />\n      <path d="M19.7908933,20.2975874 L24.1177613,27.790793 C25.1001224,29.4921221 24.5149682,31.6758954 22.8135338,32.6581208 C21.9890792,33.1338411 21.0288981,33.2603573 20.1091305,33.0139122 C19.18991,32.7676136 18.4216284,32.1779682 17.9454955,31.3537648 L17.1827119,30.0323164 L15.8608348,30.7951949 C15.0363802,31.2709152 14.0759255,31.3973581 13.156705,31.1510596 C12.2374845,30.904761 11.4692029,30.3151156 10.99307,29.4909122 C10.0104354,27.7895098 10.5955896,25.6057365 12.2972975,24.6235844 L19.7908933,20.2975874 Z" transform="translate(17.555325, 26.717252) rotate(-375.000000) translate(-17.555325, -26.717252) " />\n      <path d="M29.9637582,18.8699223 L30.7268887,20.1911704 C31.2026748,21.0155741 31.3289593,21.9756084 31.0826712,22.8947463 C30.8362365,23.8144314 30.2468423,24.5827047 29.4225879,25.0587718 C28.5981333,25.5344921 27.6380255,25.6607347 26.7185315,25.4143629 C25.799311,25.1680644 25.0309561,24.5786925 24.5548232,23.7544891 L20.2280284,16.26101 L27.7218978,11.9350864 C28.5463524,11.4593661 29.5065335,11.3328499 30.425754,11.5791484 C31.345248,11.8255202 32.1135297,12.4151656 32.5896625,13.239369 C33.0654485,14.0637727 33.1917331,15.023807 32.945445,15.9429449 C32.6990836,16.8623564 32.1096894,17.6306297 31.2851615,18.1066236 L29.9637582,18.8699223 Z" transform="translate(26.648213, 18.496817) rotate(-375.000000) translate(-26.648213, -18.496817) " />\n      <path d="M16.2834896,15.6971548 L11.9568952,8.20402258 C10.9744071,6.50207301 11.5594147,4.31884682 13.261196,3.33642119 C14.0856506,2.8607009 15.0458317,2.73418468 15.9650522,2.98048322 C16.8842727,3.22678175 17.6528279,3.81650049 18.1289607,4.64070387 L18.8922182,5.96257247 L20.2136214,5.19927376 C21.0380761,4.72355348 21.9982572,4.59703727 22.9174777,4.8433358 C23.8372453,5.08978094 24.6055269,5.67942637 25.0816598,6.50362976 C26.0639475,8.20523246 25.47894,10.3884586 23.777359,11.3712311 L16.2834896,15.6971548 Z" transform="translate(18.519211, 9.277368) rotate(-375.000000) translate(-18.519211, -9.277368) " />\n    </g>\n  </g>\n</svg>\n'}),define("text!res/icons/title-status-downloading.svg",[],function(){return'<svg version="1.1" viewBox="0 0 96 96" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <defs>\n    <path d="M100,0 L100,100 L0,100 L0,0 L100,0 Z M50,21 C34.536027,21 22,33.536027 22,49 C22,64.463973 34.536027,77 50,77 C65.463973,77 78,64.463973 78,49 C78,33.536027 65.463973,21 50,21 Z" id="path-1" />\n    <filter filterUnits="objectBoundingBox" height="115.0%" id="filter-2" width="115.0%" x="-7.5%" y="-7.5%">\n      <feOffset dx="0" dy="0" in="SourceAlpha" result="shadowOffsetOuter1" />\n      <feGaussianBlur in="shadowOffsetOuter1" result="shadowBlurOuter1" stdDeviation="2.5" />\n      <feComposite in="shadowBlurOuter1" in2="SourceAlpha" operator="out" result="shadowBlurOuter1" />\n      <feColorMatrix in="shadowBlurOuter1" type="matrix" values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.05 0" />\n    </filter>\n  </defs>\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <g class=" title-status-icon-group" transform="translate(-2.000000, -2.000000)">\n      <g class=" title-status-field">\n        <use fill="black" fill-opacity="1" filter="url(#filter-2)" xlink:href="#path-1" />\n        <path d="M99,1 L99,99 L1,99 L1,1 L99,1 Z M50,20 C41.9918711,20 34.7418711,23.2459356 29.4939033,28.4939033 C24.2459356,33.7418711 21,40.9918711 21,49 C21,57.0081289 24.2459356,64.2581289 29.4939033,69.5060967 C34.7418711,74.7540644 41.9918711,78 50,78 C58.0081289,78 65.2581289,74.7540644 70.5060967,69.5060967 C75.7540644,64.2581289 79,57.0081289 79,49 C79,40.9918711 75.7540644,33.7418711 70.5060967,28.4939033 C65.2581289,23.2459356 58.0081289,20 50,20 Z" fill="#FFFFFF" fill-rule="evenodd" stroke="#FFFFFF" stroke-linejoin="square" stroke-width="2" />\n      </g>\n      <path class=" title-status-ring icon-hollow" d="M50,21 C65.463973,21 78,33.536027 78,49 C78,64.463973 65.463973,77 50,77 C34.536027,77 22,64.463973 22,49 C22,33.5615698 34.4946481,21.0414211 49.9233955,21" stroke="#000000" stroke-linecap="round" stroke-width="3" />\n      <path class=" title-status-retry icon-hollow" d="M60.5474935,57.4712205 C58.3810587,53.8975672 54.4545878,51.5095932 49.9703757,51.5095932 C45.5267446,51.5095932 41.6308055,53.8545417 39.4525065,57.3744909" stroke="#000000" stroke-linecap="round" stroke-width="3" />\n      <path class=" title-status-stop icon-solid" d="M46.136,44.251 L46.2518521,44.3586529 L47.1600906,45.273881 L49.7636848,47.8793203 L53.3017146,44.3420045 C53.8877297,43.7569642 54.8374773,43.7577541 55.4227773,44.3440274 C55.9785662,44.9007433 56.0087312,45.791501 55.4976898,46.3829597 L55.4082517,46.4785639 L51.8830949,50.0027127 L55.4209428,53.5282634 C56.0088867,54.1127525 56.0117116,55.0625132 55.4276802,55.6500726 C54.8436291,56.2375579 53.8938772,56.2403712 53.3063614,55.6563269 L49.761141,52.1246667 L46.2303187,55.6560411 C45.6446977,56.2423577 44.6949503,56.2429219 44.1088162,55.6574836 C43.5522322,55.1015612 43.5207966,54.2108479 44.0309939,53.6186609 L44.1202939,53.5229325 L47.6402956,50.0027095 L44.1055585,46.455522 C43.5570561,45.9024357 43.5252893,45.0207664 44.0267908,44.4304505 L44.1299642,44.3196978 C44.6331998,43.8213084 45.4347932,43.760429 46.0193522,44.1622741 L46.136,44.251 Z" fill="#000000" fill-rule="nonzero" />\n      <g class=" title-status-pause icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="3" transform="translate(45.500000, 46.500000)">\n        <path d="M8.42504,0 C8.42365333,0.897471994 8.42296,1.97439507 8.42296,3.23076923 C8.42296,4.48714339 8.42365333,5.74355365 8.42504,7" />\n        <path d="M0.5148,0 C0.521733333,0.897471994 0.5252,1.97439507 0.5252,3.23076923 C0.5252,4.48714339 0.521733333,5.74355365 0.5148,7" transform="translate(0.520000, 3.500000) scale(-1, 1) translate(-0.520000, -3.500000) " />\n      </g>\n      <path class=" title-status-start icon-solid" d="M49.896,39.984 L50.0310893,39.9790866 C50.7435625,39.9793826 51.3558927,40.5185139 51.4545741,41.2491125 L51.4669876,41.4553947 L51.4638312,55.4621103 L55.9048302,50.6582771 C56.3714037,50.1922426 57.1120405,50.1102902 57.6900604,50.4680987 L57.8103039,50.5502238 L57.96585,50.6888674 C58.4552499,51.1795705 58.5109507,51.9843822 58.0743909,52.5717251 L57.9295585,52.7373375 L56.7124034,54.0012127 L55.9478506,54.7851549 L55.2275062,55.5148022 L54.4904716,56.2505136 L53.7540414,56.9725129 L53.0807848,57.617543 L52.667315,58.0043309 L52.2806544,58.3578021 L51.7504994,58.82563 L51.4329155,59.0935244 L51.1411903,59.3286878 L50.8047001,59.5822326 L50.5001684,59.7881734 L50.4410371,59.8244466 L50.2532255,59.9290078 L50.183349,59.9622542 L50.0678751,60.0061601 C50.0356211,60.0158428 50.0101657,60.0206174 49.9931929,60.0206174 C49.9328697,60.0206174 49.775949,59.9589518 49.5518559,59.8234331 L49.3625665,59.7023266 L49.1586908,59.5595614 L48.9317589,59.3896618 L48.5480256,59.0830031 L48.1176468,58.7178789 L47.8049202,58.4420753 L47.4695645,58.1385915 L47.1128648,57.8085155 L46.5371004,57.262906 L45.6947185,56.4425078 L45.0069997,55.7577941 L44.2697227,55.0121521 L43.2094269,53.9232541 L42.0605913,52.7262373 C41.4883954,52.1540455 41.4883954,51.235913 42.0548138,50.6696177 C42.5648924,50.1596501 43.3699292,50.1039557 43.9574236,50.5404382 L44.1320863,50.6945609 L48.5639016,55.4610383 L48.5652597,41.4295178 L48.5720133,41.2889013 C48.6345704,40.6407835 49.1250161,40.1130019 49.7630404,40.0012344 L49.896,39.984 Z" fill="#000000" fill-rule="nonzero" />\n    </g>\n  </g>\n</svg>\n'}),define("text!res/icons/title-status-downloaded.svg",[],function(){return'<svg version="1.1" viewBox="0 0 96 96" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class=" title-status-field" d="M97,-1 L97,97 L-1,97 L-1,-1 L97,-1 Z M70,24 L26,24 L25.6813802,24.0055332 C23.3548121,24.0864847 21.252633,25.0512245 19.6979287,26.6059288 C18.0948242,28.2090333 17.0718396,30.4422303 17,32.985512 L17,32.985512 L17,64.8608749 L30.8527246,50.2201664 L31.0524416,50.0194793 C32.070623,49.0469783 33.3766439,48.5386613 34.6957371,48.5021102 C36.1027698,48.4631225 37.5246758,48.9608996 38.6279522,50.0046827 C39.7083915,51.0268602 40.2822599,52.383837 40.3209897,53.7815619 C40.3596264,55.1759259 39.8665544,56.6066441 38.8301564,57.7938656 L38.8301564,57.7938656 L25.3880749,72 L70,72 L70.3186198,71.9944668 C72.6451879,71.9135153 74.747367,70.9487755 76.3020713,69.3940712 C77.9051758,67.7909667 78.9281604,65.5577697 79,63.014488 L79,63.014488 L79,33 L78.9943189,32.6771989 C78.911229,30.320241 77.9218285,28.1939065 76.363961,26.636039 C74.7352814,25.0073593 72.4852814,24 70,24 L70,24 Z" fill="#FFFFFF" stroke="#FFFFFF" stroke-width="2" />\n    <path class=" title-status-shadow icon-hollow" d="M70,26 C71.8934851,26 73.6113955,26.7517777 74.8714713,27.9731865 C76.1321409,29.195171 76.934789,30.8871473 76.9961952,32.766679 L76.9961952,32.766679 L76.9999981,62.9847595 C76.9385332,64.9335841 76.1768352,66.6531089 74.9655042,67.9027878 C73.7494698,69.1573189 72.0821571,69.9357832 70.233338,69.9961946 L70.233338,69.9961946 L30.0341218,69.9997921 L40.3086275,59.1412797 C41.7187262,57.5421339 42.3722993,55.605574 42.3202224,53.7261648 C42.2671749,51.8117303 41.4826401,49.9522107 40.0024514,48.55184 C38.5366857,47.1651145 36.6584895,46.4851626 34.788455,46.5002291 C32.9046258,46.5154067 31.0292259,47.23618 29.5918178,48.6499581 L29.5918178,48.6499581 L19,59.8381264 L19,33.0153015 C19.0614509,31.0664518 19.8231522,29.3469041 21.0344958,28.0972122 C22.2505298,26.8426815 23.9178419,26.0642173 25.7666603,26.0038055 L25.7666603,26.0038055 Z" stroke="#000000" stroke-opacity="0.15" stroke-width="2" />\n    <path class=" title-status-check icon-hollow" d="M34.8480792,54 L18.7968488,70.9661148 C18.622722,71.150192 18.3384256,71.1748999 18.135143,71.0236362 C14.8211031,68.5576401 12.5344194,66.6983209 11.2750921,65.4456785" stroke="#000000" stroke-linecap="round" stroke-width="3.35" />\n  </g>\n</svg>\n'}),define("text!res/icons/title-status-scanning.svg",[],function(){return'<svg version="1.1" viewBox="0 0 96 96" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class=" title-status-field" d="M97,-1 L97,97 L-1,97 L-1,-1 L97,-1 Z M70,24 L26,24 L25.6771989,24.0056811 C23.320241,24.088771 21.1939065,25.0781715 19.636039,26.636039 C18.0073593,28.2647186 17,30.5147186 17,33 L17,33 L17,63 L17.0056811,63.3228011 C17.088771,65.679759 18.0781715,67.8060935 19.636039,69.363961 C21.2647186,70.9926407 23.5147186,72 26,72 L26,72 L70,72 L70.3228011,71.9943189 C72.679759,71.911229 74.8060935,70.9218285 76.363961,69.363961 C77.9926407,67.7352814 79,65.4852814 79,63 L79,63 L79,33 L78.9943189,32.6771989 C78.911229,30.320241 77.9218285,28.1939065 76.363961,26.636039 C74.7352814,25.0073593 72.4852814,24 70,24 L70,24 Z" fill="#FFFFFF" stroke="#FFFFFF" stroke-width="2" />\n    <g class=" title-status-dots icon-solid" fill="#000000" transform="translate(34.152255, 46.380952)">\n      <ellipse cx="2.78514589" cy="2.61904762" rx="2.78514589" ry="2.61904762" />\n      <ellipse cx="13.8477454" cy="2.61904762" rx="2.78514589" ry="2.61904762" />\n      <ellipse cx="24.9103448" cy="2.61904762" rx="2.78514589" ry="2.61904762" />\n    </g>\n    <g class=" title-status-retry" transform="translate(33.673218, 32.000000)">\n      <path d="M1.57715976,16.6682776 L6.09687414,19.6524373 C6.56552938,19.9618688 6.69460572,20.5926327 6.3851742,21.061288 C6.2981942,21.1930251 6.1817369,21.3027019 6.04502497,21.3816326 L1.84981149,23.8037402 C1.36345853,24.0845362 0.741561416,23.9178994 0.460765405,23.4315464 C0.381834738,23.2948345 0.335818139,23.141623 0.326359836,22.9840452 L0.00185894393,17.5777779 C-0.0317889886,17.0171948 0.395376368,16.5354754 0.955959471,16.5018275 C1.17558075,16.4886451 1.39355333,16.5470507 1.57715976,16.6682776 Z" fill="#D0021B" />\n      <path d="M27.0764036,15.7718648 L22.5566892,12.7877051 C22.088034,12.4782736 21.9589577,11.8475097 22.2683892,11.3788544 C22.3553692,11.2471172 22.4718265,11.1374405 22.6085384,11.0585098 L26.8037519,8.63640217 C27.2901048,8.35560616 27.912002,8.52224299 28.192798,9.00859594 C28.2717286,9.14530787 28.3177452,9.29851939 28.3272035,9.45609712 L28.6517044,14.8623644 C28.6853524,15.4229475 28.258187,15.904667 27.6976039,15.9383149 C27.4779826,15.9514972 27.26001,15.8930917 27.0764036,15.7718648 Z" fill="#D0021B" />\n      <g stroke="#D0021B" stroke-linecap="round" stroke-width="3" transform="translate(3.008059, 0.000000)">\n        <path d="M1.89888616,30.1011138 C8.63799042,30.1011138 14.1011138,24.6379904 14.1011138,17.8988862" transform="translate(8.000000, 24.000000) rotate(-293.000000) translate(-8.000000, -24.000000) " />\n        <path d="M20.5655335,1.89888616 C13.8264292,1.89888616 8.36330577,7.36200958 8.36330577,14.1011138" transform="translate(14.464420, 8.000000) rotate(-293.000000) translate(-14.464420, -8.000000) " />\n      </g>\n    </g>\n    <path class=" title-status-shadow icon-hollow" d="M70,26 C71.9329966,26 73.6829966,26.7835017 74.9497475,28.0502525 C76.2164983,29.3170034 77,31.0670034 77,33 L77,33 L77,63 C77,64.9329966 76.2164983,66.6829966 74.9497475,67.9497475 C73.6829966,69.2164983 71.9329966,70 70,70 L70,70 L26,70 C24.0670034,70 22.3170034,69.2164983 21.0502525,67.9497475 C19.7835017,66.6829966 19,64.9329966 19,63 L19,63 L19,33 C19,31.0670034 19.7835017,29.3170034 21.0502525,28.0502525 C22.3170034,26.7835017 24.0670034,26 26,26 L26,26 Z" stroke="#000000" stroke-opacity="0.02" stroke-width="2" />\n  </g>\n</svg>\n'}),define("text!res/icons/title-status-notify.svg",[],function(){return'<svg version="1.1" viewBox="0 0 96 96" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <defs>\n    <linearGradient id="linearGradient-1" x1="50%" x2="50%" y1="0%" y2="100%">\n      <stop offset="0%" stop-color="#F5A623" />\n      <stop offset="100%" stop-color="#FBD249" />\n    </linearGradient>\n  </defs>\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class=" title-status-field" d="M97,-1 L97,97 L-1,97 L-1,-1 L97,-1 Z M70,24 L26,24 L25.6771989,24.0056811 C23.320241,24.088771 21.1939065,25.0781715 19.636039,26.636039 C18.0060388,28.2660392 16.9983669,30.5183676 17.000002,33.0060457 L17.000002,33.0060457 L17.1192074,43.1480242 L17.4261552,43.1079889 C18.9540611,42.9449444 20.3766101,43.3357159 21.5653252,44.1376944 C22.6296515,44.8557527 23.5059909,45.8999492 24.5582423,47.6222217 C26.9283027,48.8455648 28.6303284,50.3723738 29.8388206,53.0769025 C29.9261539,53.3344182 30.0068552,53.695166 30.4103604,56.2497046 L30.4103604,56.2497046 L30.4432183,56.7659655 L30.4698867,57.3473439 L30.4894267,57.9637437 L30.5029927,58.6244783 L30.5112408,59.3218992 L30.5166908,60.2628102 L30.528628,61.5710771 L30.5420545,62.2342643 L30.6622083,63.1319878 L31.4658682,64.399406 L33.5729399,67.7882667 L33.7085644,68.0219971 C34.3938991,69.280784 34.4729526,70.7276208 34.0251778,72.0002186 L34.0251778,72.0002186 L70.0000061,72 L70.3228064,71.9943189 C72.679759,71.911229 74.8060935,70.9218285 76.363961,69.363961 C77.9926407,67.7352814 79,65.4852814 79,63 L79,63 L79,33 L78.9943189,32.6771989 C78.911229,30.320241 77.9218285,28.1939065 76.363961,26.636039 C74.7352814,25.0073593 72.4852814,24 70,24 L70,24 Z" fill="#FFFFFF" stroke="#FFFFFF" stroke-width="2" />\n    <path class=" title-status-shadow icon-hollow" d="M70,26 C71.9329966,26 73.6829966,26.7835017 74.9497475,28.0502525 C76.2164983,29.3170034 77,31.0670034 77,33 L77,33 L77,63 C77,64.9329966 76.2164983,66.6829966 74.9497475,67.9497475 C73.6829966,69.2164983 71.9329966,70 69.9999939,70 L69.9999939,70 L36.295379,70.0002048 C36.2365896,68.8794405 35.9036051,67.7566627 35.2713918,66.7322074 L35.2713918,66.7322074 L33.1549268,63.3283873 L32.5863061,62.4316395 L32.5284432,61.5417065 L32.516657,60.2511868 L32.5110996,59.2981407 L32.5025713,58.5834234 L32.4887762,57.9115303 L32.4684342,57.269833 L32.4403055,56.6566167 L32.4004119,56.0298128 C31.9491441,53.1676854 31.8324584,52.7256561 31.7343866,52.4379981 L31.7149269,52.3818535 C30.3156923,49.2160927 28.4123549,47.4179334 25.7666547,45.9977353 C25.0034592,44.5319644 23.9426715,43.3289895 22.6838836,42.4797356 C21.613324,41.7574719 20.3990897,41.2889998 19.0956376,41.13096 L19.0956376,41.13096 L19.0000023,32.9943155 C19.0015367,31.0635726 19.7847435,29.3157615 21.0502525,28.0502525 C22.3170034,26.7835017 24.0670034,26 26,26 L26,26 Z" stroke="#000000" stroke-opacity="0.05" stroke-width="2" />\n    <path class=" nm-bell-cup" d="M17.949586,47.0770305 C16.8084048,47.1573968 15.9066248,48.1068615 15.9031812,49.2684399 L15.9000139,50.1170916 L15.4639325,50.2801087 C12.4271449,51.4405283 10.6027585,52.7825329 10.0077976,54.3536284 C9.80176036,54.8977048 9.66928272,55.6221653 9.58448421,56.6166384 L9.54593839,57.136791 L9.5146202,57.7044353 L9.48981072,58.3220611 L9.47079107,58.9921581 L9.42143201,61.9116927 L9.38912129,62.9082669 L9.36346588,63.3812431 L9.33209855,63.7698829 L9.29419279,64.0818686 L9.26488166,64.2510673 L9.23205233,64.3918884 C9.2147173,64.4555838 9.1959711,64.5094913 9.17567599,64.5548911 L9.05417185,64.7804369 L8.77638755,65.258106 L8.28617146,66.0643201 L7.63748004,67.1021944 L6.65046287,68.6523732 L5.86637565,69.8699072 C5.77037855,70.0184317 5.71931175,70.191517 5.71931175,70.3683643 C5.71931175,70.8754518 6.13034124,71.2867317 6.63741544,71.2867317 L29.3856396,71.2867317 C29.5559873,71.2867317 29.7229779,71.239352 29.8679427,71.1498894 C30.2995637,70.8835218 30.4335292,70.3176912 30.1671669,69.8860672 L28.0642867,66.5040752 L27.4020323,65.4600252 L26.874682,64.6533148 C26.8558487,64.6254315 26.8379116,64.5990515 26.8208702,64.5741742 C26.7889339,64.5275529 26.7601838,64.4648825 26.7343234,64.3834459 L26.6976632,64.2468769 C26.691902,64.2216564 26.6863122,64.1951781 26.680889,64.1673995 L26.6503139,63.9847856 L26.6235175,63.7689278 L26.5899217,63.3783512 L26.5635773,62.9015129 L26.543734,62.3315355 L26.5296413,61.6615411 L26.5168943,60.3039435 L26.5112556,59.3392444 L26.5031429,58.6640208 L26.4901851,58.041728 L26.471753,57.4695833 L26.4472177,56.944804 L26.41595,56.4646075 C26.3985282,56.2351912 26.3783459,56.0214498 26.3550491,55.8218183 L26.3041982,55.4409044 C26.2857938,55.3198949 26.2659004,55.2046927 26.2444131,55.0948339 L26.1750647,54.7808241 C26.1378948,54.6313706 26.0969028,54.4928964 26.0517348,54.3638361 L25.9817897,54.1808134 C25.3530436,52.6647867 23.5777845,51.3772515 20.6752068,50.2758377 L20.2500139,50.1190916 L20.2688024,49.2336989 C20.2688024,48.0395606 19.300762,47.0715201 18.1066236,47.0715201 L17.949586,47.0770305 Z" fill="url(#linearGradient-1)" fill-rule="nonzero" />\n    <path class=" nm-bell-ball icon-solid" d="M20.7578246,74.6277032 L21.1349444,73.9796473 L14.43364,74.0148171 L14.8157598,74.6582835 C15.4649252,75.7514385 16.5664978,76.428663 17.7778036,76.428663 C19.0008929,76.428663 20.1116162,75.7381702 20.7578246,74.6277032 Z" fill="#000000" fill-rule="nonzero" />\n  </g>\n</svg>\n'}),define("text!res/icons/title-status-streaming.svg",[],function(){return'<svg version="1.1" viewBox="0 0 96 96" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class=" title-status-field" d="M97,-1 L97,97 L-1,97 L-1,-1 L97,-1 Z M44.6139169,25.7244445 L43.6745991,25.7430238 L43.1997459,25.7680331 C38.6202852,26.0598249 34.3590712,27.7986629 30.8879372,30.6376293 C27.3365679,33.5422186 24.6116159,37.5997628 23.2284395,42.4376746 L23.2284395,42.4376746 L22.8467862,43.0528536 L22.4550866,43.2649136 C20.2591887,44.4984309 18.4691642,46.2692198 17.2076926,48.3690091 C15.8743522,50.588428 15.131612,53.1754321 15.131612,55.8791943 C15.131612,59.8028085 16.6758818,63.3659628 19.2240071,65.9666692 C21.7498321,68.5446151 25.263441,70.1791395 29.2445533,70.275249 L29.2445533,70.275249 L63.9755989,70.275249 L64.3964343,70.2700113 C68.8722987,70.1584594 72.9238161,68.2709007 75.8913743,65.1720427 C78.8768888,62.0544339 80.7675993,57.7059806 80.8633835,52.6597061 C80.7503686,48.0461399 78.8610223,43.8885556 75.8274392,40.8653948 C72.8141919,37.8624998 68.6708593,35.9769076 64.0110157,35.8801176 L64.0110157,35.8801176 L62.1670457,35.8978538 L61.7325456,35.9055378 C58.6980671,36.0124956 55.8091871,37.2221349 52.9488823,38.6591981 C54.9804392,36.6394797 57.5889908,35.3546485 60.4008127,34.9726178 C61.0071461,34.8902378 61.6155706,34.8508375 62.2220256,34.8537942 C61.8475775,34.3313699 61.4479701,33.8227687 61.0247133,33.3300832 C56.9958721,28.6403736 51.2184729,25.8515805 44.6139169,25.7244445 L44.6139169,25.7244445 Z" fill="#FFFFFF" stroke="#FFFFFF" stroke-width="2" />\n    <path class=" title-status-shadow icon-hollow" d="M44.6183056,27.7249405 C49.9800188,27.8384382 54.7450353,29.8743195 58.3072584,33.3544572 C55.7676038,34.0261941 53.435112,35.3556037 51.5388073,37.240858 C51.0448213,37.7319654 50.7966616,38.376807 50.7947751,39.0223683 C50.7928887,39.6679296 51.0372756,40.3142105 51.5283829,40.8081965 C52.0194903,41.3021824 52.6643319,41.5503422 53.3098932,41.5522287 C53.9554545,41.5541151 54.6017355,41.3097282 55.0957214,40.8186208 C56.9801987,38.945125 59.5052456,37.8978076 62.1862818,37.8977613 L62.1862818,37.8977613 L63.9989774,37.8803259 C68.0509192,37.971904 71.6602173,39.5885079 74.3075974,42.173881 C76.9778206,44.7815621 78.6684234,48.3728379 78.8520285,52.3705399 C78.766232,56.9029801 77.1576761,60.8046355 74.5758847,63.6118587 C71.9459444,66.471435 68.3091869,68.1883836 64.2848244,68.272038 L64.2848244,68.272038 L29.2694894,68.2752478 C25.8481052,68.1866496 22.8255061,66.7847271 20.6525885,64.5669709 C18.4580309,62.3271283 17.131612,59.2574086 17.131612,55.8791943 C17.131612,53.600126 17.7424691,51.4169112 18.8434104,49.5318051 C19.9422496,47.6502983 21.5293766,46.0657597 23.4842518,44.9806679 L23.4842518,44.9806679 L24.8126622,44.2902947 L25.1577828,42.9651396 C26.406878,38.6125677 28.835618,34.9486061 32.0089114,32.3040789 C35.1942588,29.6495061 39.1292401,28.0234268 43.3640718,27.7616556 L43.3640718,27.7616556 Z" stroke="#000000" stroke-opacity="0.15" stroke-width="2" />\n  </g>\n</svg>\n'}),define("text!res/icons/title-status-streaming-dl.svg",[],function(){return'<svg version="1.1" viewBox="0 0 96 96" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class=" title-status-field" d="M97,-1 L97,97 L-1,97 L-1,-1 L97,-1 Z M44.6139169,25.7244445 L43.6745991,25.7430238 L43.1997459,25.7680331 C38.6202852,26.0598249 34.3590712,27.7986629 30.8879372,30.6376293 C27.3365679,33.5422186 24.6116159,37.5997628 23.2284395,42.4376746 L23.2284395,42.4376746 L22.8467862,43.0528536 L22.4550866,43.2649136 C20.2591887,44.4984309 18.4691642,46.2692198 17.2076926,48.3690091 C15.8743522,50.588428 15.131612,53.1754321 15.131612,55.8791943 C15.131612,59.8028085 16.6758818,63.3659628 19.2240071,65.9666692 C21.7498321,68.5446151 25.263441,70.1791395 29.2445533,70.275249 L29.2445533,70.275249 L63.9755989,70.275249 L64.3599612,70.2707206 C65.8926101,70.2342839 67.3634767,69.975455 68.6221196,69.4037002 C69.0743548,69.1982666 69.51419,68.9456215 69.9401968,68.6537833 C69.5812194,68.423052 69.2457849,68.143584 68.9443348,67.8160433 C68.0216825,66.813535 67.5741926,65.5310519 67.6011495,64.2569169 C67.6279957,62.9880163 68.1257033,61.7272555 69.0941548,60.7590147 C70.4441772,59.4092859 72.3809315,58.9852728 74.5349275,59.5004593 L74.5349275,59.5004593 L74.5352597,54.100158 L74.5419268,53.8370748 C74.603902,52.6171866 75.0944371,51.5104768 75.8660615,50.6645257 C76.7001469,49.750097 77.8624022,49.13978 79.1668437,49.0211975 C79.5857873,48.9831127 79.9994513,48.9975627 80.4006546,49.0595448 C80.2952174,48.6100618 80.1710432,48.1627574 80.0282371,47.7189783 C78.9219791,44.2812117 76.7840872,41.3236595 73.9443374,39.2236615 C71.1934229,37.1893572 67.7832576,35.9581981 64.0109753,35.880118 L64.0109753,35.880118 L62.1670457,35.8978538 L61.7325456,35.9055378 C58.6980671,36.0124956 55.8091871,37.2221349 52.9488823,38.6591981 C54.9804392,36.6394797 57.5889908,35.3546485 60.4008127,34.9726178 C61.0071461,34.8902378 61.6155706,34.8508375 62.2220256,34.8537942 C61.8475775,34.3313699 61.4479701,33.8227687 61.0247133,33.3300832 C56.9958721,28.6403736 51.2184729,25.8515805 44.6139169,25.7244445 L44.6139169,25.7244445 Z" fill="#FFFFFF" stroke="#FFFFFF" stroke-width="2" />\n    <path class=" title-status-shadow icon-hollow" d="M44.6183056,27.7249405 C49.9800188,27.8384382 54.7450353,29.8743195 58.3072584,33.3544572 C55.7676038,34.0261941 53.435112,35.3556037 51.5388073,37.240858 C51.0448213,37.7319654 50.7966616,38.376807 50.7947751,39.0223683 C50.7928887,39.6679296 51.0372756,40.3142105 51.5283829,40.8081965 C52.0194903,41.3021824 52.6643319,41.5503422 53.3098932,41.5522287 C53.9554545,41.5541151 54.6017355,41.3097282 55.0957214,40.8186208 C56.9801987,38.945125 59.5052456,37.8978076 62.1862818,37.8977613 L62.1862818,37.8977613 L63.9990241,37.8803254 C67.3225863,37.955099 70.3293107,39.0378034 72.7551698,40.8317288 C74.9612106,42.4630983 76.6863748,44.6813258 77.7336157,47.2578163 C76.4738974,47.6072414 75.3548275,48.2949649 74.4807661,49.2173923 C73.3283326,50.4335954 72.6018444,52.0573343 72.5395969,53.8499093 L72.5395969,53.8499093 L72.5360586,57.2917365 C70.6344933,57.3519917 68.9663926,58.0586295 67.6800951,59.3446473 C66.3708718,60.6535858 65.6797494,62.3465472 65.606505,64.0609317 C65.5490901,65.404805 65.8716779,66.7617166 66.5736784,67.957365 C65.9380101,68.1786226 65.1992919,68.2435395 64.4564243,68.2674785 L64.4564243,68.2674785 L29.2695344,68.275249 C25.8481317,68.1866619 22.8255156,66.7847368 20.6525885,64.5669709 C18.4580309,62.3271283 17.131612,59.2574086 17.131612,55.8791943 C17.131612,53.600126 17.7424691,51.4169112 18.8434104,49.5318051 C19.9422496,47.6502983 21.5293766,46.0657597 23.4842518,44.9806679 L23.4842518,44.9806679 L24.8126622,44.2902947 L25.1577828,42.9651396 C26.406878,38.6125677 28.835618,34.9486061 32.0089114,32.3040789 C35.1942588,29.6495061 39.1292401,28.0234268 43.3640718,27.7616556 L43.3640718,27.7616556 Z" stroke="#000000" stroke-opacity="0.15" stroke-width="2" />\n    <path class=" title-status-arrow icon-solid" d="M80.0357042,52.75 C80.8459469,52.75 81.5155627,53.3519646 81.6215386,54.1329728 L81.6361488,54.3500965 L81.6348572,68 L85.8078703,63.4841576 C86.3760634,62.916088 87.2651929,62.8644453 87.8917381,63.3292295 L88.0712406,63.4841576 C88.6394338,64.0522271 88.6910877,64.9411632 88.2262024,65.5675722 L88.0712406,65.7470357 C83.3921977,70.6431684 80.7061818,73.0912348 80.0131929,73.0912348 C79.3202041,73.0912348 76.6387262,70.6431684 71.9687594,65.7470357 C71.3437469,65.1221591 71.3437469,64.1090341 71.9687594,63.4841576 C72.5369525,62.916088 73.426082,62.8644453 74.0526272,63.3292295 L74.2321297,63.4841576 L78.4344735,68 L78.4352597,54.3500965 C78.4352597,53.4663876 79.1518031,52.75 80.0357042,52.75 Z" fill="#000000" fill-rule="nonzero" />\n  </g>\n</svg>\n';
}),define("text!res/icons/title-status-wait-list.svg",[],function(){return'<svg version="1.1" viewBox="0 0 96 96" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class=" title-status-field" d="M97,-1 L97,97 L-1,97 L-1,-1 L97,-1 Z M71.25,23.0416667 L24.75,23.0416667 L24.4313802,23.0471999 C22.1048121,23.1281514 20.002633,24.0928912 18.4479287,25.6475954 C16.8448212,27.250703 15.8218358,29.4839054 15.7499996,32.0271931 L15.7499996,32.0271931 L15.7504711,48.8257293 L16.2040878,48.6856286 C17.7251011,48.2392354 19.3346054,48 21,48 C25.6944204,48 29.9444204,49.9027898 33.0208153,52.9791847 C36.0972102,56.0555796 38,60.3055796 38,65 C38,67.8755424 37.2865179,70.5844637 36.0258708,72.9588803 L36.0258708,72.9588803 L71.2500155,72.9583333 L71.5686334,72.9528001 C73.8951879,72.8718486 75.997367,71.9071088 77.5520713,70.3524046 C79.1551758,68.7493 80.1781604,66.516103 80.25,63.9728213 L80.25,63.9728213 L80.25,32.0416667 L80.2443189,31.7188656 C80.161229,29.3619076 79.1718285,27.2355731 77.613961,25.6777056 C75.9852814,24.049026 73.7352814,23.0416667 71.25,23.0416667 L71.25,23.0416667 Z" fill="#FFFFFF" stroke="#FFFFFF" stroke-width="2" />\n    <path class=" title-status-shadow icon-hollow" d="M71.25,25.0416667 C73.1434851,25.0416667 74.8613955,25.7934444 76.1214713,27.0148532 C77.3821401,28.2368369 78.184788,29.9288118 78.246195,31.8083421 L78.246195,31.8083421 L78.2499982,63.9430892 C78.1885341,65.8919153 77.4268359,67.6114415 76.2155042,68.8611211 C74.9994658,70.1156564 73.332146,70.8941217 71.4833196,70.9545285 L71.4833196,70.9545285 L39.0466106,70.9586717 C39.6651287,69.0845364 40,67.0813794 40,65 C40,59.7532949 37.8733526,55.0032949 34.4350288,51.5649712 C30.9967051,48.1266474 26.2467051,46 21,46 C20.0326224,46 19.0821419,46.0723645 18.1536614,46.2119104 L17.75,46.278 L17.7500004,32.0569546 C17.8080403,30.2163796 18.4906829,28.5803359 19.586812,27.3514696 L19.7844958,27.1388789 C21.0005293,25.8843487 22.6678406,25.1058846 24.5166581,25.0454722 L24.5166581,25.0454722 Z" stroke="#000000" stroke-opacity="0.15" stroke-width="2" />\n    <g class=" title-status-dates" fill="#FFFFFF" transform="translate(33.950000, 35.851938)">\n      <circle cx="12.9734375" cy="2.8203125" r="2.8203125" />\n      <circle cx="23.1265625" cy="2.8203125" r="2.8203125" />\n      <circle cx="33.2796875" cy="2.8203125" r="2.8203125" />\n      <circle cx="2.8203125" cy="12.8380625" r="2.8203125" />\n      <circle cx="12.9734375" cy="12.8380625" r="2.8203125" />\n      <circle cx="23.1265625" cy="12.8380625" r="2.8203125" />\n      <circle cx="33.2796875" cy="12.8380625" r="2.8203125" />\n      <circle cx="2.8203125" cy="22.8558125" opacity="0" r="2.8203125" />\n      <circle cx="12.9734375" cy="22.8558125" r="2.8203125" />\n      <circle cx="23.1265625" cy="22.8558125" r="2.8203125" />\n      <circle cx="33.2796875" cy="22.8558125" r="2.8203125" />\n    </g>\n    <g class=" title-status-pause" stroke="#FFFFFF" stroke-linecap="round" stroke-width="3" transform="translate(43.736000, 44.500000)">\n      <path d="M8.42504,0 C8.42365333,0.897471994 8.42296,1.97439507 8.42296,3.23076923 C8.42296,4.48714339 8.42365333,5.74355365 8.42504,7" />\n      <path d="M0.5148,0 C0.521733333,0.897471994 0.5252,1.97439507 0.5252,3.23076923 C0.5252,4.48714339 0.521733333,5.74355365 0.5148,7" transform="translate(0.520000, 3.500000) scale(-1, 1) translate(-0.520000, -3.500000) " />\n    </g>\n    <g class=" title-status-clock" transform="translate(8.000000, 52.000000)">\n      <circle class="icon-hollow" cx="13" cy="13" r="11.5" stroke="#000000" stroke-width="3" />\n      <line class="icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="2.5" transform="translate(12.526535, 10.750000) scale(-1, 1) translate(-12.526535, -10.750000) " x1="12.553071" x2="12.5" y1="7" y2="14.5" />\n      <path class="icon-solid" d="M18.5,13 L18.5,16 L12.79,16 C11.9615729,16 11.29,15.3284271 11.29,14.5 C11.29,13.7203039 11.8848881,13.0795513 12.64554,13.0068666 L12.79,13 L18.5,13 Z" fill="#000000" fill-rule="nonzero" transform="translate(14.895000, 14.500000) scale(-1, 1) translate(-14.895000, -14.500000) " />\n    </g>\n  </g>\n</svg>\n'}),define("text!res/icons/title-status-wait-list-acq.svg",[],function(){return'<svg version="1.1" viewBox="0 0 96 96" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class=" title-status-field" d="M97,-1.37983704 L97,96.620163 L-1,96.620163 L-1,-1.37983704 L97,-1.37983704 Z M65.9834227,22.6618584 L24.7500007,22.6618296 L24.4313808,22.6673628 C22.1048121,22.7483143 20.002633,23.7130541 18.4479287,25.2677584 C16.8448212,26.870866 15.8218358,29.1040684 15.7499996,31.6473561 L15.7499996,31.6473561 L15.7504711,48.4458922 L16.2040878,48.3057916 C17.7251011,47.8593984 19.3346054,47.620163 21,47.620163 C25.6944204,47.620163 29.9444204,49.5229528 33.0208153,52.5993477 C36.0972102,55.6757426 38,59.9257426 38,64.620163 C38,67.4957054 37.2865179,70.2046266 36.0258708,72.5790432 L36.0258708,72.5790432 L71.2500155,72.5784963 L71.5686334,72.5729631 C73.8951879,72.4920116 75.997367,71.5272718 77.5520713,69.9725675 C79.1551728,68.3694659 80.1781566,66.1362743 80.2499996,63.5929985 L80.2499996,63.5929985 L80.2507258,37.3907924 L80.0590171,37.4483975 C78.5972711,37.8732331 77.3034768,37.9022821 75.0373051,36.8936231 C74.2436161,36.4301336 73.5659425,35.7892933 72.8945964,34.8093685 L72.8945964,34.8093685 L71.1360076,32.0009118 L68.2567288,30.0283616 L68.008366,29.8491401 C67.1184673,29.1734326 66.4576855,28.2967179 66.0492296,27.3238193 C65.4377013,25.8672237 65.39068,24.195833 65.9834227,22.6618584 L65.9834227,22.6618584 Z" fill="#FFFFFF" stroke="#FFFFFF" stroke-width="2" />\n    <path class=" title-status-shadow icon-hollow" d="M63.5675197,25.0417985 C63.5335888,26.1665879 63.7305512,27.2850857 64.1429406,28.3253991 C64.6886357,29.7019954 65.6110607,30.9419534 66.8748277,31.8788084 L66.8748277,31.8788084 L69.6615472,33.7945401 L71.2203424,36.2839275 C72.0429215,37.4941102 72.8440557,38.2551921 73.7670686,38.8414211 C75.6895389,39.7527423 76.9165856,40.0598172 77.9653771,40.1062402 L77.9653771,40.1062402 L78.2498154,63.9488213 C78.18704,65.895287 77.4256482,67.6126669 76.2155042,68.8611211 C74.9994658,70.1156564 73.332146,70.8941217 71.4833196,70.9545285 L71.4833196,70.9545285 L39.0466106,70.9586717 C39.6651287,69.0845364 40,67.0813794 40,65 C40,59.7532949 37.8733526,55.0032949 34.4350288,51.5649712 C30.9967051,48.1266474 26.2467051,46 21,46 C20.0326224,46 19.0821419,46.0723645 18.1536614,46.2119104 L17.75,46.278 L17.7500004,32.0569546 C17.8080403,30.2163796 18.4906829,28.5803359 19.586812,27.3514696 L19.7844958,27.1388789 C21.0005307,25.8843473 22.6678442,25.1058829 24.5166642,25.045472 L24.5166642,25.045472 Z" stroke="#000000" stroke-opacity="0.15" stroke-width="2" />\n    <g class=" title-status-dates" fill="#FFFFFF" transform="translate(33.950000, 35.851938)">\n      <circle cx="12.9734375" cy="2.8203125" r="2.8203125" />\n      <circle cx="23.1265625" cy="2.8203125" r="2.8203125" />\n      <circle cx="33.2796875" cy="2.8203125" r="2.8203125" />\n      <circle cx="2.8203125" cy="12.8380625" r="2.8203125" />\n      <circle cx="12.9734375" cy="12.8380625" r="2.8203125" />\n      <circle cx="23.1265625" cy="12.8380625" r="2.8203125" />\n      <circle cx="33.2796875" cy="12.8380625" r="2.8203125" />\n      <circle cx="2.8203125" cy="22.8558125" opacity="0" r="2.8203125" />\n      <circle cx="12.9734375" cy="22.8558125" r="2.8203125" />\n      <circle cx="23.1265625" cy="22.8558125" r="2.8203125" />\n      <circle cx="33.2796875" cy="22.8558125" r="2.8203125" />\n    </g>\n    <g class=" title-status-pause" stroke="#FFFFFF" stroke-linecap="round" stroke-width="3" transform="translate(43.736000, 44.500000)">\n      <path d="M8.42504,0 C8.42365333,0.897471994 8.42296,1.97439507 8.42296,3.23076923 C8.42296,4.48714339 8.42365333,5.74355365 8.42504,7" />\n      <path d="M0.5148,0 C0.521733333,0.897471994 0.5252,1.97439507 0.5252,3.23076923 C0.5252,4.48714339 0.521733333,5.74355365 0.5148,7" transform="translate(0.520000, 3.500000) scale(-1, 1) translate(-0.520000, -3.500000) " />\n    </g>\n    <g class=" title-status-clock" transform="translate(8.000000, 52.000000)">\n      <circle class="icon-hollow" cx="13" cy="13" r="11.5" stroke="#000000" stroke-width="3" />\n      <line class="icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="2.5" transform="translate(12.526535, 10.750000) scale(-1, 1) translate(-12.526535, -10.750000) " x1="12.553071" x2="12.5" y1="7" y2="14.5" />\n      <path class="icon-solid" d="M18.5,13 L18.5,16 L12.79,16 C11.9615729,16 11.29,15.3284271 11.29,14.5 C11.29,13.7203039 11.8848881,13.0795513 12.64554,13.0068666 L12.79,13 L18.5,13 Z" fill="#000000" fill-rule="nonzero" transform="translate(14.895000, 14.500000) scale(-1, 1) translate(-14.895000, -14.500000) " />\n    </g>\n    <path class=" title-status-badge" d="M74.478508,21.6659904 L77.0179584,17.6717608 C77.3698318,17.1183091 78.1037428,16.9548976 78.6571945,17.306771 C78.8219637,17.4115279 78.9583602,17.555297 79.0543062,17.7253478 L81.2635614,21.6409381 C81.3729089,21.834741 81.5345103,21.9939206 81.729942,22.1003295 L85.6262331,24.221786 C86.2022261,24.5354032 86.4149237,25.2565747 86.1013064,25.8325677 C86.0077145,26.0044598 85.8730871,26.1505539 85.7094009,26.2578533 L81.668379,28.9068199 C81.5122524,29.0091638 81.382454,29.1468751 81.2895172,29.3087781 L79.008391,33.2826755 C78.6818904,33.8514646 77.9561147,34.0478783 77.3873256,33.7213777 C77.2181272,33.6242532 77.0754642,33.4869378 76.9719494,33.3215715 L74.4371186,29.2721434 C74.35056,29.1338648 74.2364384,29.0149042 74.1018715,28.9226811 L70.0097074,26.1181875 C69.4687225,25.7474329 69.3307235,25.0083219 69.7014782,24.467337 C69.8127383,24.3049923 69.9626041,24.1728463 70.1375986,24.0827823 L74.0198144,22.0847325 C74.2071528,21.9883156 74.3654655,21.8437916 74.478508,21.6659904 Z" fill="#F5A623" />\n  </g>\n</svg>\n'}),define("text!res/icons/title-status-ellipsis.svg",[],function(){return'<svg version="1.1" viewBox="0 0 96 96" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M48,17 C64.5685425,17 78,30.4314575 78,47 C78,63.5685425 64.5685425,77 48,77 C31.4314575,77 18,63.5685425 18,47 C18,30.6274356 31.1175109,17.3130613 47.4229562,17.0053406 L48,17 Z" fill="#000000" fill-rule="nonzero" opacity="0.15" />\n    <circle class="icon-solid" cx="47.5" cy="48" fill="#000000" r="3" />\n    <circle class="icon-solid" cx="35.5" cy="48" fill="#000000" r="3" />\n    <circle class="icon-solid" cx="59.5" cy="48" fill="#000000" r="3" />\n  </g>\n</svg>\n'}),define("text!res/icons/tick.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'>\n  <g stroke='#000000' stroke-width='5' fill='none' fill-rule='evenodd' stroke-linecap='round' class='icon-hollow'>\n    <path d='M15,38.0591818 L25.2922068,47.7559046 C25.6913541,48.1319581 26.2730601,48.0725291 26.5945962,47.6187735 L49,16' />\n  </g>\n</svg>\n"}),define("text!res/icons/wifi.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'>\n  <g stroke='none' stroke-width='1' fill='none' fill-rule='evenodd'>\n    <path d='M31.396313,44.8118039 C31.6950536,45.0342105 32.1573094,45.0602735 32.493155,44.885823 L32.6126053,44.8109968 C32.6126053,44.8109968 37.3315996,41.3345056 36.9814336,41.0161658 C34.021092,38.3248864 29.9760427,38.3279482 27.0181693,41.0253511 C26.6716564,41.34135 31.396313,44.8118039 31.396313,44.8118039 Z' fill='#000000' class='icon-solid' />\n    <path d='M43,34.9830213 C39.9394656,32.4821231 36.1341605,31 32.0103738,31 C27.8772635,31 24.0640765,32.4888326 21,35' stroke='#000000' stroke-width='4.5' stroke-linecap='round' class='icon-hollow' />\n    <path d='M51,28 C45.8477458,23.6308134 39.2055568,21 31.9558261,21 C24.7474652,21 18.1397322,23.6008741 13,27.9253731' stroke='#000000' stroke-width='4.5' stroke-linecap='round' class='icon-hollow' />\n  </g>\n</svg>\n"}),define("text!res/icons/wreath.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M12.5016981,23.6298512 C13.3066342,23.545249 15.7294592,21.71499 15.7294592,19.2382259 C15.7294592,16.7614618 13.4420481,11.3103822 12.5559386,11.3103822 C11.6698291,11.3103822 9.24877999,16.7287247 9.24877999,19.2382259 C9.24877999,21.7477271 11.696762,23.7144534 12.5016981,23.6298512 Z" fill="#000000" transform="translate(12.489120, 17.471432) rotate(6.000000) translate(-12.489120, -17.471432) " />\n    <path class="icon-solid" d="M6.73277055,31.7619674 C7.53770664,31.6773652 9.9605317,29.8471062 9.9605317,27.3703421 C9.9605317,24.893578 7.67312054,19.4424984 6.78701106,19.4424984 C5.90090159,19.4424984 3.47985247,24.8608409 3.47985247,27.3703421 C3.47985247,29.8798433 5.92783446,31.8465696 6.73277055,31.7619674 Z" fill="#000000" transform="translate(6.720192, 25.603548) rotate(-12.000000) translate(-6.720192, -25.603548) " />\n    <path class="icon-solid" d="M14.658428,36.5234172 C15.4633641,36.438815 17.8861891,34.608556 17.8861891,32.1317919 C17.8861891,29.6550278 15.598778,24.2039482 14.7126685,24.2039482 C13.826559,24.2039482 11.4055099,29.6222907 11.4055099,32.1317919 C11.4055099,34.6412931 13.8534919,36.6080194 14.658428,36.5234172 Z" fill="#000000" transform="translate(14.645850, 30.364998) rotate(1.000000) translate(-14.645850, -30.364998) " />\n    <path class="icon-solid" d="M7.07327961,42.1346595 C7.8782157,42.0500573 10.3010408,40.2197983 10.3010408,37.7430342 C10.3010408,35.2662701 8.01362959,29.8151906 7.12752012,29.8151906 C6.24141064,29.8151906 3.82036152,35.233533 3.82036152,37.7430342 C3.82036152,40.2525354 6.26834352,42.2192617 7.07327961,42.1346595 Z" fill="#000000" transform="translate(7.060701, 35.976240) rotate(-52.000000) translate(-7.060701, -35.976240) " />\n    <path class="icon-solid" d="M12.0320843,50.4239129 C12.8370204,50.3393107 15.2598454,48.5090517 15.2598454,46.0322876 C15.2598454,43.5555235 12.9724343,38.104444 12.0863248,38.104444 C11.2002153,38.104444 8.77916621,43.5227864 8.77916621,46.0322876 C8.77916621,48.5417888 11.2271482,50.5085151 12.0320843,50.4239129 Z" fill="#000000" transform="translate(12.019506, 44.265494) rotate(-88.000000) translate(-12.019506, -44.265494) " />\n    <path class="icon-solid" d="M20.7958146,46.5121423 C21.6007507,46.4275402 24.0235758,44.5972811 24.0235758,42.120517 C24.0235758,39.6437529 21.7361646,34.1926734 20.8500551,34.1926734 C19.9639456,34.1926734 17.5428965,39.6110158 17.5428965,42.120517 C17.5428965,44.6300182 19.9908785,46.5967445 20.7958146,46.5121423 Z" fill="#000000" transform="translate(20.783236, 40.353723) rotate(-67.000000) translate(-20.783236, -40.353723) " />\n    <path class="icon-solid" d="M23.0471192,54.9887478 C23.8520553,54.9041456 26.2748803,53.0738866 26.2748803,50.5971225 C26.2748803,48.1203584 23.9874691,42.6692788 23.1013597,42.6692788 C22.2152502,42.6692788 19.7942011,48.0876213 19.7942011,50.5971225 C19.7942011,53.1066237 22.2421831,55.07335 23.0471192,54.9887478 Z" fill="#000000" transform="translate(23.034541, 48.830328) rotate(-99.000000) translate(-23.034541, -48.830328) " />\n    <path class="icon-solid" d="M51.5234589,23.6298512 C52.3283949,23.545249 54.75122,21.71499 54.75122,19.2382259 C54.75122,16.7614618 52.4638088,11.3103822 51.5776994,11.3103822 C50.6915899,11.3103822 48.2705408,16.7287247 48.2705408,19.2382259 C48.2705408,21.7477271 50.7185228,23.7144534 51.5234589,23.6298512 Z" fill="#000000" transform="translate(51.510880, 17.471432) scale(-1, 1) rotate(6.000000) translate(-51.510880, -17.471432) " />\n    <path class="icon-solid" d="M57.2923864,31.7619674 C58.0973225,31.6773652 60.5201475,29.8471062 60.5201475,27.3703421 C60.5201475,24.893578 58.2327364,19.4424984 57.3466269,19.4424984 C56.4605174,19.4424984 54.0394683,24.8608409 54.0394683,27.3703421 C54.0394683,29.8798433 56.4874503,31.8465696 57.2923864,31.7619674 Z" fill="#000000" transform="translate(57.279808, 25.603548) scale(-1, 1) rotate(-12.000000) translate(-57.279808, -25.603548) " />\n    <path class="icon-solid" d="M49.3667289,36.5234172 C50.171665,36.438815 52.5944901,34.608556 52.5944901,32.1317919 C52.5944901,29.6550278 50.3070789,24.2039482 49.4209694,24.2039482 C48.53486,24.2039482 46.1138109,29.6222907 46.1138109,32.1317919 C46.1138109,34.6412931 48.5617928,36.6080194 49.3667289,36.5234172 Z" fill="#000000" transform="translate(49.354150, 30.364998) scale(-1, 1) rotate(1.000000) translate(-49.354150, -30.364998) " />\n    <path class="icon-solid" d="M56.9518773,42.1346595 C57.7568134,42.0500573 60.1796385,40.2197983 60.1796385,37.7430342 C60.1796385,35.2662701 57.8922273,29.8151906 57.0061178,29.8151906 C56.1200084,29.8151906 53.6989592,35.233533 53.6989592,37.7430342 C53.6989592,40.2525354 56.1469412,42.2192617 56.9518773,42.1346595 Z" fill="#000000" transform="translate(56.939299, 35.976240) scale(-1, 1) rotate(-52.000000) translate(-56.939299, -35.976240) " />\n    <path class="icon-solid" d="M51.9930726,50.4239129 C52.7980087,50.3393107 55.2208338,48.5090517 55.2208338,46.0322876 C55.2208338,43.5555235 52.9334226,38.104444 52.0473131,38.104444 C51.1612037,38.104444 48.7401546,43.5227864 48.7401546,46.0322876 C48.7401546,48.5417888 51.1881365,50.5085151 51.9930726,50.4239129 Z" fill="#000000" transform="translate(51.980494, 44.265494) scale(-1, 1) rotate(-88.000000) translate(-51.980494, -44.265494) " />\n    <path class="icon-solid" d="M43.2293423,46.5121423 C44.0342784,46.4275402 46.4571035,44.5972811 46.4571035,42.120517 C46.4571035,39.6437529 44.1696923,34.1926734 43.2835828,34.1926734 C42.3974734,34.1926734 39.9764242,39.6110158 39.9764242,42.120517 C39.9764242,44.6300182 42.4244062,46.5967445 43.2293423,46.5121423 Z" fill="#000000" transform="translate(43.216764, 40.353723) scale(-1, 1) rotate(-67.000000) translate(-43.216764, -40.353723) " />\n    <path class="icon-solid" d="M40.9780378,54.9887478 C41.7829739,54.9041456 44.2057989,53.0738866 44.2057989,50.5971225 C44.2057989,48.1203584 41.9183878,42.6692788 41.0322783,42.6692788 C40.1461688,42.6692788 37.7251197,48.0876213 37.7251197,50.5971225 C37.7251197,53.1066237 40.1731017,55.07335 40.9780378,54.9887478 Z" fill="#000000" transform="translate(40.965459, 48.830328) scale(-1, 1) rotate(-99.000000) translate(-40.965459, -48.830328) " />\n  </g>\n</svg>\n'}),define("text!res/icons/footer-search.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <defs>\n    <linearGradient id="linearGradient-1" x1="50%" x2="50%" y1="0%" y2="100%">\n      <stop offset="0%" stop-color="#EDEFF2" />\n      <stop offset="100%" stop-color="#FFFFFF" />\n    </linearGradient>\n  </defs>\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <line class="icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="4" x1="45.0791566" x2="56" y1="45.351477" y2="55.1830386" />\n    <path class="color-primary" d="M29.2192118,10.3326199 C40.1011841,10.3326199 48.9227656,19.1542014 48.9227656,30.0361737 C48.9227656,40.918146 40.1011841,49.7397275 29.2192118,49.7397275 C18.3372395,49.7397275 9.51565799,40.918146 9.51565799,30.0361737 C9.51565799,19.1542014 18.3372395,10.3326199 29.2192118,10.3326199 Z" fill="url(#linearGradient-1)" />\n    <path class="color-highlight" d="M29.2192118,10.4336639 C40.0453791,10.4336639 48.8217217,19.2100065 48.8217217,30.0361738 C48.8217217,40.8623411 40.0453791,49.6386838 29.2192118,49.6386838 C18.3930445,49.6386838 9.61670185,40.8623411 9.61670185,30.0361738 C9.61670185,19.2100065 18.3930445,10.4336639 29.2192118,10.4336639 Z M29.2192118,14.2461506 C20.4986228,14.2461506 13.4291886,21.3155848 13.4291886,30.0361738 C13.4291886,38.7567628 20.4986228,45.826197 29.2192118,45.826197 C37.9398008,45.826197 45.009235,38.7567628 45.009235,30.0361738 C45.009235,21.3155848 37.9398008,14.2461506 29.2192118,14.2461506 Z" fill="#FFFFFF" fill-rule="nonzero" />\n    <circle class="icon-hollow" cx="29.2192118" cy="30.0361732" r="21.2192118" stroke="#000000" stroke-linecap="round" stroke-width="3.8" />\n  </g>\n</svg>\n'}),define("text!res/icons/footer-library.svg",[],function(){return'<svg version="1.1" viewBox="0 0 128 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="color-shadow icon-solid" d="M76.2959332,34.139704 L95.6832885,28.0145196 C95.8131551,27.9689031 95.9564416,28.0343504 96.0033278,28.1607003 C96.0131569,28.187188 96.0181835,28.2151352 96.0181835,28.2432963 L96.1438575,42.8919912 C96.1438575,42.9850325 96.0893031,43.069922 96.0033278,43.110663 L76.4650567,51.4753865 C76.3409262,51.5342081 76.191287,51.4839897 76.1308282,51.3632206 C76.1142182,51.3300415 76.1055864,51.2936201 76.1055864,51.2567147 L76.1308282,34.368481 C76.1308282,34.265996 76.1968552,34.1745058 76.2959332,34.139704 Z" fill="#000000" fill-opacity="0.25" opacity="0.200000003" />\n    <path class="color-shadow icon-solid" d="M51.7817364,16.5598367 C50.5129711,18.1593403 48.0972294,18.294279 46.0553313,18.1944759 L45.5535253,18.1653463 L44.1943745,18.0619745 L43.8076821,18.0364235 C43.5632937,18.0227718 43.3468919,18.0168336 43.1655176,18.0243024 L42.9368284,18.0380831 L42.6707133,18.0621322 L42.2013668,18.1174587 L41.647812,18.1958888 L41.0100487,18.2974224 L39.7599801,18.5179865 L38.897661,18.6811297 L37.6169113,18.9345928 L35.8054532,19.3091807 L33.7600828,19.7479452 L31.9553696,20.145164 L28.0275536,20.0195465 L47.0834579,11.5135136 L52.3885155,12.6504564 L51.7817364,16.5598367 Z" fill="#000000" fill-opacity="0.25" opacity="0.35" />\n    <path class="color-shadow icon-solid" d="M51.7817364,16.5598367 C53.7961749,20.2278326 59.3149045,20.4312386 63.1711317,22.0701624 C64.9902211,22.8432883 68.6255369,25.1722452 74.0770792,29.0570331 L78.0876465,29.0570331 L59.759079,14.3264885 L52.3885155,12.6504564 L51.7817364,16.5598367 Z" fill="#000000" fill-opacity="0.25" opacity="0.35" />\n    <path class="color-primary" d="M105.464185,18.7646545 L80.1419907,26.8573685 L61.006444,11.5460091 L46.7629595,8.37502766 L80.3519478,3.78073883 L83.5829845,4.2365548 C83.732063,4.25758593 83.8744687,4.31200697 83.9995783,4.39575823 L105.464185,18.7646545 L105.464185,18.7646545 Z" fill="#DDDDDD" />\n    <path class="color-highlight" d="M79.8573448,6.74901358 C80.6765324,6.62563079 81.4406366,7.18969198 81.5640194,8.00887949 C81.6801443,8.77987951 81.1873224,9.502086 80.4459796,9.68724868 L80.3041534,9.715554 L61.9764463,12.3403846 L60.9069399,11.5135136 L55.316415,10.2576254 L79.8573448,6.74901358 Z" fill="#FFFFFF" fill-rule="nonzero" />\n    <g class="icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="3.3" transform="translate(24.225540, 5.245506)">\n      <path d="M23.300219,4.42308306 C30.1846465,3.62853189 41.1584897,2.15432344 56.2217484,0.00045772919 C56.3513243,-0.0144969916 58.8636981,0.341715363 58.9892273,0.377155269 L80.9429867,14.9425265" />\n      <path d="M0,14.8996576 C15.1407572,8.09914377 22.7111359,4.69888684 22.7111359,4.69888684 C31.6473694,6.68691606 36.1154861,7.68093068 36.1154861,7.68093068 L55.6173553,23.276474 L81.0672567,15.0086218" />\n    </g>\n    <path class="icon-hollow" d="M74.5,57.2249069 L99.4278959,46.1578547 C99.7892219,45.9974395 100.022125,45.6392145 100.022125,45.2438798 L100.022125,28.75 L100.022125,28.75" stroke="#000000" stroke-linecap="round" stroke-width="3.4" />\n    <line class="color-secondary icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="3.3" x1="30" x2="67.0446232" y1="44" y2="52.4673425" />\n    <line class="color-secondary icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="3.3" x1="24.150849" x2="67.0446232" y1="51.25" y2="61.0542913" />\n    <line class="color-secondary icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="3.1" x1="31.5" x2="31.5" y1="24.5" y2="35.5" />\n    <line class="color-secondary icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="3.2" x1="43.5" x2="43.5" y1="27" y2="38" />\n    <line class="color-secondary icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="3.3" x1="55.5" x2="55.5" y1="29.75" y2="40.75" />\n    <line class="color-secondary icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="3.4" x1="67.5" x2="67.5" y1="32.3" y2="43.3" />\n  </g>\n</svg>\n'}),define("text!res/icons/footer-menu-hamburger.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class=" color-field icon-solid" d="M32,0 L42.9446446,1.92983613 L52.5692035,7.48657782 L59.7128129,16 L63.5138481,26.4432583 L63.5138481,37.5567417 L59.7128129,48 L52.5692035,56.5134222 L42.9446446,62.0701639 L32,64 L21.0553554,62.0701639 L11.4307965,56.5134222 L4.28718708,48 L0.486151904,37.5567417 L0.486151904,26.4432583 L4.28718708,16 L11.4307965,7.48657782 L21.0553554,1.92983613 L32,0 Z M44.1194184,41.091062 L19.8425081,41.0917871 L19.6030898,41.1009092 C17.171573,41.3286345 15.3805816,43.2446877 15.3805816,45.591062 C15.3805816,48.0763434 17.3953002,50.091062 19.8805816,50.091062 L44.1194184,50.091062 L44.3962098,50.0812411 C46.828427,49.8534896 48.6194184,47.9374364 48.6194184,45.591062 C48.6194184,43.1057807 46.6046998,41.091062 44.1194184,41.091062 Z M50.1791276,27.5 L13.7827989,27.5007251 L13.5433806,27.5098472 C11.1118638,27.7375725 9.32087243,29.6536257 9.32087243,32 C9.32087243,34.4852814 11.3355911,36.5 13.8208724,36.5 L50.1791276,36.5 L50.455919,36.490179 C52.8881362,36.2624275 54.6791276,34.3463743 54.6791276,32 C54.6791276,29.5147186 52.6644089,27.5 50.1791276,27.5 Z M44.1194184,13.908938 L19.8805816,13.908938 L19.6037902,13.9187589 C17.171573,14.1465104 15.3805816,16.0625636 15.3805816,18.408938 C15.3805816,20.8942193 17.3953002,22.908938 19.8805816,22.908938 L44.1194184,22.908938 L44.3962098,22.899117 C46.828427,22.6713655 48.6194184,20.7553123 48.6194184,18.408938 C48.6194184,15.9236566 46.6046998,13.908938 44.1194184,13.908938 Z" fill="#000000" fill-opacity="0" />\n    <line class="icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="3" x1="19.8805816" x2="44.1194184" y1="45.591062" y2="45.591062" />\n    <line class="icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="3" x1="13.8208724" x2="50.1791276" y1="32" y2="32" />\n    <line class="icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="3" x1="19.8805816" x2="44.1194184" y1="18.408938" y2="18.408938" />\n  </g>\n</svg>\n'}),define("text!res/icons/footer-menu-spinner.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-linecap="round" stroke-width="1">\n    <line class="icon-hollow" stroke="#000000" stroke-width="3.2" x1="32" x2="32" y1="12.4444444" y2="17.4222222" />\n    <line class="icon-hollow" stroke="#000000" stroke-width="3.2" x1="44.5700688" x2="41.3704149" y1="17.0195753" y2="20.8327743" />\n    <line class="icon-hollow" stroke="#000000" stroke-width="3.2" x1="51.2584627" x2="46.3563086" y1="28.6042134" y2="29.4685955" />\n    <line class="icon-hollow" stroke="#000000" stroke-width="3.2" x1="48.9356079" x2="44.6247259" y1="41.7777778" y2="39.2888889" />\n    <line class="icon-hollow" stroke="#000000" stroke-width="3.2" x1="38.6883939" x2="36.9858936" y1="50.3762113" y2="45.6986302" />\n    <line class="icon-hollow" stroke="#000000" stroke-width="3.2" x1="25.3116061" x2="27.0141064" y1="50.3762113" y2="45.6986302" />\n    <line class="icon-hollow" stroke="#000000" stroke-width="3.2" x1="15.0643921" x2="19.3752741" y1="41.7777778" y2="39.2888889" />\n    <line class="icon-hollow" stroke="#000000" stroke-width="3.2" x1="12.7415373" x2="17.6436914" y1="28.6042134" y2="29.4685955" />\n    <line class="icon-hollow" stroke="#000000" stroke-width="3.2" x1="19.4299312" x2="22.6295851" y1="17.0195753" y2="20.8327743" />\n  </g>\n</svg>\n'}),define("text!res/icons/footer-shelf.svg",[],function(){return'<svg version="1.1" viewBox="0 0 128 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M25.5137899,38.2394281 C25.9180966,37.4381944 26.8953802,37.1164216 27.6966139,37.5207283 C28.4533346,37.9025735 28.7823881,38.7954999 28.4760175,39.5685116 L28.4153137,39.7035522 C27.9499944,40.6256975 27.7821556,41.1495086 27.7821556,43.0392354 C27.7821556,44.5808555 28.1305501,46.1982547 28.8306924,47.8937042 L29.013058,48.3191939 L29.0391463,48.4679662 L55.075275,57.5441006 C55.4092766,57.6605293 55.7640085,57.7005304 56.110815,57.6631582 L56.3177185,57.6314425 L56.4990911,57.5880178 L102.387075,44.7028955 C103.25112,44.4602757 104.14825,44.9640409 104.39087,45.8280866 C104.604401,46.588539 104.239445,47.3824573 103.542989,47.7255491 L103.408579,47.7844774 L103.265679,47.8318818 L57.3776952,60.717004 C56.4553984,60.9759805 55.4842121,60.9945971 54.5537836,60.7732434 L54.2759674,60.6996385 L54.0054991,60.6129896 L27.7683061,51.4670359 C27.103801,51.2353978 26.5601435,50.7466516 26.2592403,50.110383 C25.1098852,47.6795121 24.5321556,45.3204202 24.5321556,43.0392354 C24.5321556,40.6268279 24.8002644,39.6534553 25.5137899,38.2394281 Z M102.511061,29.2877001 C103.373661,29.0399877 104.273746,29.5384522 104.521459,30.4010518 C104.739472,31.1602314 104.379205,31.9562886 103.684785,32.3034826 L103.550725,32.3632028 L103.408107,32.4114493 L57.1100093,45.7068568 C56.3166995,45.9346713 55.4789583,45.9454831 54.6809724,45.7404333 L54.416565,45.66409 L54.1609556,45.5735288 L52.6460336,44.9859395 C51.8093058,44.6613998 51.3940954,43.7200065 51.7186351,42.8832788 C52.0042646,42.1468691 52.7726838,41.7308991 53.535668,41.8744891 L53.6785446,41.9080279 L53.8212957,41.9558803 L55.3362177,42.5434696 C55.5224206,42.6156917 55.7213949,42.6462137 55.9158363,42.6345288 L56.060547,42.6178435 L56.2129635,42.5831077 L102.511061,29.2877001 Z M70.8041352,4.95422516 C72.7388188,4.3939482 74.7824554,4.34689636 76.7349052,4.81260575 L77.126199,4.9131762 L77.5118715,5.02667156 L77.8922676,5.15301871 L103.493679,14.1505234 C104.392478,14.4664026 104.865029,15.4510944 104.54915,16.3498941 C104.401624,16.7696632 104.098687,17.1135494 103.703306,17.3151886 L103.550827,17.3840059 L103.398916,17.4356284 L57.4560559,30.6609124 C56.4436764,30.9523397 55.3721994,30.9529668 54.3610953,30.6656606 L54.0869263,30.5801677 L53.8205437,30.4819334 L29.385,20.759 L29.2508117,20.9373127 C28.3919482,22.1276897 27.9001848,23.5668999 27.7906637,25.2294837 L27.7730511,25.5891614 L27.7671728,25.9556213 C27.7671728,28.0771814 28.2955556,30.0687676 29.3600577,31.9536896 L29.5801086,32.3292588 L29.7261989,32.6104579 L38.1557528,35.8797217 C38.8921625,36.1653513 39.3081324,36.9337705 39.1645425,37.6967547 L39.1310037,37.8396313 L39.0831513,37.9823824 C38.7975217,38.7187922 38.0291025,39.1347621 37.2661184,38.9911721 L37.1232417,38.9576333 L36.9804906,38.9097809 L27.621212,35.2563916 L27.3591231,34.8760094 C25.4696123,32.1336718 24.5171728,29.1465641 24.5171728,25.9556213 C24.5171728,22.5725487 25.7496972,19.2482779 27.8767636,17.6537688 C28.0127314,17.5030815 28.1745537,17.3777118 28.3578033,17.2821856 L28.499189,17.2162074 L28.6748413,17.1547075 L70.8041352,4.95422516 Z" fill="#000000" fill-rule="nonzero" />\n    <path class="color-primary" d="M98.321,15.645 L56.5915863,27.6578611 L56.3903837,27.7068579 C55.9178051,27.8013968 55.4263339,27.7575672 54.9758025,27.5783146 L33.467,19.02 L71.6734059,7.95589026 C73.3739593,7.46341651 75.1858483,7.5142327 76.8561264,8.10124469 L98.321,15.645 Z" fill="#D6D6D6" fill-rule="nonzero" />\n    <path class="color-highlight" d="M72.0133175,7.85980316 C72.8090522,7.62937364 73.6409227,8.08764405 73.8713522,8.88337876 C74.0882271,9.63230555 73.6950425,10.4132419 72.9846258,10.6946359 L72.8477766,10.7414135 L38.0059443,20.8301406 L33.467,19.02 L72.0133175,7.85980316 Z" fill="#FFFFFF" fill-rule="nonzero" />\n    <path class="color-shadow icon-solid" d="M57,48 L102,35.0059433 C101.673913,36.2561552 101.51087,37.466363 101.51087,38.6365667 C101.51087,39.8067705 101.673913,40.929896 102,42.0059433 L57,55 L57,48 Z" fill="#000000" fill-opacity="0.25" opacity="0.35" />\n    <path class="color-shadow icon-solid" d="M57,33 L102,20.0059433 C101.673913,21.2561552 101.51087,22.466363 101.51087,23.6365667 C101.51087,24.8067705 101.673913,25.929896 102,27.0059433 L57,40 L57,33 Z" fill="#000000" fill-opacity="0.25" opacity="0.35" />\n    <path class="color-secondary icon-solid" d="M48.636964,38.2430307 L48.636964,46.5168337 C48.636964,46.9683265 48.2709568,47.3343337 47.819464,47.3343337 C47.517687,47.3343337 47.2404539,47.1680809 47.0983182,46.9018726 L44.428538,41.9015968 L43.0448625,44.0493447 C42.7188349,44.5554064 42.0442932,44.7013528 41.5382316,44.3753252 C41.2267652,44.1746646 41.0385568,43.8295273 41.0385568,43.4590195 L41.0385568,35.0860985 C41.0385568,34.6672648 41.2785431,34.2854747 41.6559618,34.1038796 L43.5984476,33.1692518 C43.8826191,33.0325225 44.2120804,33.0255681 44.5017686,33.150184 L51.4345512,36.1324765 L49.2261437,37.274899 C48.8642327,37.4621177 48.636964,37.8355624 48.636964,38.2430307 Z" fill="#000000" />\n    <path d="M41.3023433,34.7480277 C41.4002234,34.4990233 41.6610593,34.362458 41.9145587,34.4125216 L42.0089444,34.4401886 L48.5356021,37.0057249 C48.8157321,37.11584 48.9535563,37.432196 48.8434412,37.712326 C48.7455611,37.9613303 48.4847252,38.0978957 48.2312259,38.047832 L48.1368401,38.020165 L41.6101824,35.4546288 C41.3300525,35.3445137 41.1922282,35.0281576 41.3023433,34.7480277 Z" fill="#FFFFFF" fill-rule="nonzero" opacity="0.345527286" />\n  </g>\n</svg>\n';
}),define("text!res/icons/footer-tags.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <defs>\n    <linearGradient id="linearGradient-1" x1="30.0911043%" x2="72.3484935%" y1="25.1528628%" y2="70.684529%">\n      <stop offset="0%" stop-color="#EDEFF2" />\n      <stop offset="100%" stop-color="#FFFFFF" />\n    </linearGradient>\n  </defs>\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="color-highlight icon-hollow" d="M12.9416089,10.5587461 L48.0150811,10.5587461 C49.5655806,10.5587461 51.0384901,11.2370075 52.0464612,12.4151598 L57.8044922,19.1453502 C59.6545326,21.3077429 60.6711963,24.0599263 60.6711963,26.9057288 L60.6711963,33.2208607 C60.6711963,35.5554864 59.9012391,37.8249442 58.4806238,39.6775988 L53.1103902,46.6810342 C52.1063469,47.9904284 50.5502409,48.758136 48.9002057,48.758136 L12.9416089,48.758136 C10.9881885,48.758136 9.40462836,47.1745759 9.40462836,45.2211555 L9.40462836,14.0957267 C9.40462836,12.1423063 10.9881885,10.5587461 12.9416089,10.5587461 Z" fill="#FFFFFF" stroke="#000000" stroke-linecap="round" stroke-width="3.5" transform="translate(35.037912, 29.658441) rotate(-40.000000) translate(-35.037912, -29.658441) " />\n    <path class="color-primary" d="M36.1288085,10.6045824 L44.5163195,12.000839 C46.2530235,12.2899456 47.8293113,13.1899793 48.9610052,14.5386796 L52.8579222,19.1828444 C53.7223072,20.2129784 54.222827,21.4994309 54.2819297,22.8428758 L54.6542983,31.3070637 C54.6682223,31.6235644 54.5340962,31.9285264 54.2914081,32.1321658 L28.3675812,53.8848394 L10.0338573,32.0355581 L35.3067613,10.8290737 C35.5348096,10.6377185 35.8351536,10.5556981 36.1288085,10.6045824 Z M41.1103553,18.9243782 C39.0094001,20.6872889 38.7353609,23.8195712 40.4982717,25.9205264 C42.2611824,28.0214816 45.3934647,28.2955208 47.4944199,26.5326101 C49.5953751,24.7696993 49.8694143,21.6374171 48.1065036,19.5364618 C46.3435928,17.4355066 43.2113106,17.1614674 41.1103553,18.9243782 Z" fill="url(#linearGradient-1)" />\n    <path class="icon-solid" d="M45.9399782,24.6851131 C44.8823161,25.5725969 43.3054639,25.4346402 42.41798,24.3769782 C41.5304962,23.3193161 41.6684529,21.7424639 42.726115,20.85498 C43.783777,19.9674962 45.3606293,20.1054529 46.2481131,21.163115 C47.1355969,22.220777 46.9976402,23.7976293 45.9399782,24.6851131 Z" fill="#000000" />\n  </g>\n</svg>\n'}),define("text!res/symbols/footer-mantle.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 10" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <path class="color-empty icon-hollow" d="M66.9090909,14.5454545 L-2.90909091,14.5454545 L-2.90909091,9.09090909 L-0.692556646,9.09090909 C2.44384592,9.09091099 5.54338222,8.41470514 8.39479281,7.10838255 C16.622169,3.33915782 24.4905714,1.45454545 32,1.45454545 C39.5094278,1.45454545 47.3778294,3.33915743 55.6052046,7.10838137 C58.4566148,8.41470342 61.5561506,9.09090909 64.6925526,9.09090909 L66.9090909,9.09090909 L66.9090909,9.09090909 L66.9090909,14.5454545 Z" fill="#FFFFFF" stroke="#000000" stroke-width="2.18181818" />\n</svg>\n'}),define("text!res/icons/input-command.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M46.4190729,7.10290497e-16 C52.5323443,-4.12699233e-16 54.7491642,0.636518476 56.9840848,1.83176711 C59.2190055,3.02701575 60.9729843,4.78099454 62.1682329,7.01591518 C63.3634815,9.25083581 64,11.4676557 64,17.5809271 L64,46.4190729 C64,52.5323443 63.3634815,54.7491642 62.1682329,56.9840848 C60.9729843,59.2190055 59.2190055,60.9729843 56.9840848,62.1682329 C54.7491642,63.3634815 52.5323443,64 46.4190729,64 L17.5809271,64 C11.4676557,64 9.25083581,63.3634815 7.01591518,62.1682329 C4.78099454,60.9729843 3.02701575,59.2190055 1.83176711,56.9840848 C0.636518476,54.7491642 8.02029572e-16,52.5323443 -1.38036114e-15,46.4190729 L4.73526998e-16,17.5809271 C-2.75132822e-16,11.4676557 0.636518476,9.25083581 1.83176711,7.01591518 C3.02701575,4.78099454 4.78099454,3.02701575 7.01591518,1.83176711 C9.25083581,0.636518476 11.4676557,9.39595983e-16 17.5809271,-1.61712464e-15 L46.4190729,7.10290497e-16 Z M17.4998692,43.2161934 C17.0650992,42.7388567 16.3256906,42.7043497 15.848354,43.1391197 L15.848354,43.1391197 L13.1816301,45.568038 L12.9937331,45.7648665 C12.70566,46.1122831 12.5452171,46.5515938 12.5452171,47.0085287 L12.5452171,47.0085287 L12.5452171,51.4547829 L16.8387108,51.4547829 L17.1119997,51.4355334 C17.561863,51.3718175 17.9785902,51.1521805 18.2865005,50.8103113 L18.2865005,50.8103113 L20.7789356,48.0429894 L20.9055749,47.8742389 C21.1970043,47.4027578 21.1190967,46.7760185 20.6926475,46.3919299 L20.6926475,46.3919299 L20.523897,46.2652906 C20.052416,45.9738612 19.4256766,46.0517688 19.041588,46.478218 L19.041588,46.478218 L16.6628571,49.1154286 L14.8822857,49.1154286 L14.8822857,47.1794286 L17.4227956,44.8677086 L17.5654705,44.7122798 C17.902007,44.271861 17.8863315,43.6404926 17.4998692,43.2161934 Z M50.2857143,13.7142857 C43.4883713,14.1895876 38.6546404,15.7788215 35.7845215,18.4819872 C33.8012425,20.3499 30.6462572,23.8624582 26.3195655,29.0196618 L26.3195655,29.0196618 L18.9975542,29.0201546 L18.8705032,29.0275059 C18.577035,29.0615995 18.3074757,29.2127895 18.1252372,29.4498406 L18.1252372,29.4498406 L15.6628746,32.6528175 L15.5905356,32.7590598 C15.3074028,33.2316348 15.4172223,33.8518335 15.8645777,34.1957483 C15.9931258,34.2945727 16.1419267,34.3637647 16.3003346,34.3983742 L16.3003346,34.3983742 L21.0275943,35.4295839 C20.8376127,35.6627542 20.6460641,35.8981241 20.4529485,36.1356934 C20.1659713,36.4887305 20.132303,36.9696416 20.3376033,37.3511721 L20.3376033,37.3511721 L18.8540342,40.3164571 C18.6740956,40.7386559 18.7746695,41.2282644 19.1064278,41.5451472 L19.1064278,41.5451472 L22.6914512,44.969423 C23.0153824,45.2788296 23.4943618,45.3608883 23.9027008,45.176934 L23.9027008,45.176934 L27.09,43.742 L27.2082271,43.7776773 C27.4925997,43.8452395 27.7993299,43.7985022 28.0553699,43.6347537 L28.1617849,43.5574038 C28.5703132,43.2217069 28.9724075,42.8903477 29.3680678,42.5633263 L29.3680678,42.5633263 L30.3960937,47.3828816 C30.4302539,47.5429235 30.4996831,47.6933304 30.5993236,47.8231461 C30.9693241,48.3051972 31.6600483,48.3960322 32.1420994,48.0260318 L32.1420994,48.0260318 L35.3413967,45.5703973 C35.6127069,45.3621519 35.7717516,45.0395831 35.7717516,44.6975665 L35.7717516,44.6975665 L35.7717276,37.1655815 C42.2746185,31.5518612 46.0998869,27.7433785 47.2475326,25.7401335 C48.8218713,22.9920853 49.8345985,18.9834693 50.2857143,13.7142857 Z M40.4938019,20.7346063 C42.000339,20.7346063 43.2216287,21.9569247 43.2216287,23.4647309 C43.2216287,24.9725371 42.000339,26.1948556 40.4938019,26.1948556 C38.9872647,26.1948556 37.765975,24.9725371 37.765975,23.4647309 C37.765975,21.9569247 38.9872647,20.7346063 40.4938019,20.7346063 Z" fill="#000000" />\n  </g>\n</svg>\n'}),define("text!res/icons/shelf-nav-loans.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-linecap="round" stroke-width="1">\n    <path class="icon-hollow" d="M22.3539029,11.9037544 L41.6460971,11.9037544 C45.2463747,11.9037544 46.5519224,12.2786181 47.86813,12.9825337 C49.1843377,13.6864492 50.2173052,14.7194167 50.9212208,16.0356244 C51.6251364,17.3518321 52,18.6573797 52,22.2576573 L52,51.1979515 C52,51.7555332 51.5479907,52.2075426 50.9904089,52.2075426 C50.818908,52.2075426 50.6502339,52.163854 50.5002973,52.0805979 L32.6902603,42.1911276 C32.4161445,42.0389179 32.3099932,41.9995712 32.1852408,41.9736852 C32.0604884,41.9477992 31.9395116,41.9477992 31.8147592,41.9736852 C31.6900068,41.9995712 31.5838555,42.0389179 31.3097397,42.1911276 L13.4997027,52.0805979 C13.0122305,52.3512791 12.3976258,52.1755353 12.1269446,51.6880631 C12.0436886,51.5381265 12,51.3694524 12,51.1979515 L12,22.2576573 C12,18.6573797 12.3748636,17.3518321 13.0787792,16.0356244 C13.7826948,14.7194167 14.8156623,13.6864492 16.13187,12.9825337 C17.4480776,12.2786181 18.7536253,11.9037544 22.3539029,11.9037544 Z" stroke="#000000" stroke-width="3" />\n  </g>\n</svg>\n'}),define("text!res/icons/shelf-nav-holds.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-hollow" d="M27.8305692,11.9229574 C30.1037756,11.9229574 32.904551,11.9229574 36.2328955,11.9229574 M46.2421525,12.3285661 C49.5840313,13.4134887 52,16.5527498 52,20.2562907 L52,43.589624 C52,48.1919969 48.2690396,51.9229574 43.6666667,51.9229574 L20.3333333,51.9229574 C15.7309604,51.9229574 12,48.1919969 12,43.589624 L12,20.2562907 C12,16.6315753 14.3142211,13.5473752 17.5457364,12.4006174" stroke="#000000" stroke-linecap="round" stroke-width="3" />\n    <line class="icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="3" x1="22.3833333" x2="22.3833333" y1="9" y2="16.8333333" />\n    <line class="icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="3" x1="41.6166667" x2="41.6166667" y1="9" y2="16.8333333" />\n    <circle class="icon-solid" cx="28.3742374" cy="26.5606848" fill="#000000" r="2" />\n    <circle class="icon-solid" cx="35.6257626" cy="26.5606848" fill="#000000" r="2" />\n    <circle class="icon-solid" cx="42.8772879" cy="26.5606848" fill="#000000" r="2" />\n    <circle class="icon-solid" cx="21.1227121" cy="34.3940182" fill="#000000" r="2" />\n    <circle class="icon-solid" cx="28.3742374" cy="34.3940182" fill="#000000" r="2" />\n    <circle class="icon-solid" cx="35.6257626" cy="34.3940182" fill="#000000" r="2" />\n    <circle class="icon-solid" cx="42.8772879" cy="34.3940182" fill="#000000" r="2" />\n    <circle class="icon-solid" cx="21.1227121" cy="42.2273515" fill="#000000" r="2" />\n    <circle class="icon-solid" cx="28.3742374" cy="42.2273515" fill="#000000" r="2" />\n    <circle class="icon-solid" cx="35.6257626" cy="42.2273515" fill="#000000" r="2" />\n    <circle class="icon-solid" cx="42.8772879" cy="42.2273515" fill="#000000" r="2" />\n  </g>\n</svg>\n'}),define("text!res/icons/shelf-nav-timeline.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-hollow" d="M22.3539029,12 L41.6460971,12 C45.2463747,12 46.5519224,12.3748636 47.86813,13.0787792 C49.1843377,13.7826948 50.2173052,14.8156623 50.9212208,16.13187 C51.6251364,17.4480776 52,18.7536253 52,22.3539029 L52,41.6460971 C52,45.2463747 51.6251364,46.5519224 50.9212208,47.86813 C50.2173052,49.1843377 49.1843377,50.2173052 47.86813,50.9212208 C46.5519224,51.6251364 45.2463747,52 41.6460971,52 L22.3539029,52 C18.7536253,52 17.4480776,51.6251364 16.13187,50.9212208 C14.8156623,50.2173052 13.7826948,49.1843377 13.0787792,47.86813 C12.3748636,46.5519224 12,45.2463747 12,41.6460971 L12,22.3539029 C12,18.7536253 12.3748636,17.4480776 13.0787792,16.13187 C13.7826948,14.8156623 14.8156623,13.7826948 16.13187,13.0787792 C17.4480776,12.3748636 18.7536253,12 22.3539029,12 Z" stroke="#000000" stroke-linecap="round" stroke-width="3" />\n    <path class="icon-solid" d="M42.25,27.5257111 L52,35.1446686 L52,41.6460971 C52,45.2463747 51.6251364,46.5519224 50.9212208,47.86813 C50.2173052,49.1843377 49.1843377,50.2173052 47.86813,50.9212208 C46.5519224,51.6251364 45.2463747,52 41.6460971,52 L22.3539029,52 C18.7536253,52 17.4480776,51.6251364 16.13187,50.9212208 C14.8156623,50.2173052 13.7826948,49.1843377 13.0787792,47.86813 C12.6194764,47.0093085 12.3002682,46.1550254 12.1338813,44.6648385 L22.75,38.4700796 L32.5,40.293457 L42.25,27.5257111 Z" fill="#000000" fill-opacity="0.065" />\n    <polyline class="icon-hollow" points="12.1338813 44.6648385 22.75 38.4700796 32.5 40.293457 42.25 27.5257111 52 35.1446686" stroke="#000000" stroke-linecap="round" stroke-width="3" />\n  </g>\n</svg>\n'}),define("text!res/icons/shelf-nav-notifications.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-hollow" d="M22.3539029,12 L41.6460971,12 C45.2463747,12 46.5519224,12.3748636 47.86813,13.0787792 C49.1843377,13.7826948 50.2173052,14.8156623 50.9212208,16.13187 C51.6251364,17.4480776 52,18.7536253 52,22.3539029 L52,41.6460971 C52,45.2463747 51.6251364,46.5519224 50.9212208,47.86813 C50.2173052,49.1843377 49.1843377,50.2173052 47.86813,50.9212208 C46.5519224,51.6251364 45.2463747,52 41.6460971,52 L22.3539029,52 C18.7536253,52 17.4480776,51.6251364 16.13187,50.9212208 C14.8156623,50.2173052 13.7826948,49.1843377 13.0787792,47.86813 C12.3748636,46.5519224 12,45.2463747 12,41.6460971 L12,22.3539029 C12,18.7536253 12.3748636,17.4480776 13.0787792,16.13187 C13.7826948,14.8156623 14.8156623,13.7826948 16.13187,13.0787792 C17.4480776,12.3748636 18.7536253,12 22.3539029,12 Z" stroke="#000000" stroke-linecap="round" stroke-width="3" />\n    <path class="icon-solid" d="M43.5446783,21.3143423 L32.0921398,31.7572896 L32.0324798,31.807595 C31.9971342,31.8317865 31.965585,31.8303457 31.9434096,31.8081703 L20.4376082,21.3143585 L20.3220917,21.2187984 C19.6555706,20.7240706 18.7326605,20.8108672 18.1785897,21.4185038 C17.5835473,22.071073 17.630182,23.082462 18.2827512,23.6775044 L29.7352897,34.1204517 L29.855625,34.234032 C31.1165911,35.3541914 33.0822967,35.287534 34.3002597,34.069571 L45.6994993,23.6775208 L45.8052843,23.5712881 C46.3592485,22.9531217 46.3577496,22.0261404 45.8036788,21.4185038 C45.2086365,20.7659346 44.1972474,20.7192999 43.5446783,21.3143423 Z" fill="#000000" fill-rule="nonzero" />\n  </g>\n</svg>\n'}),define("text!res/icons/shelf-sync-failure.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M32,1 C49.1208272,1 63,14.8791728 63,32 C63,49.1208272 49.1208272,63 32,63 C14.8791728,63 1,49.1208272 1,32 C1,14.8791728 14.8791728,1 32,1 Z M32,43.5 C30.6192881,43.5 29.5,44.6192881 29.5,46 C29.5,47.3807119 30.6192881,48.5 32,48.5 C33.3807119,48.5 34.5,47.3807119 34.5,46 C34.5,44.6192881 33.3807119,43.5 32,43.5 Z M32.1675321,18.0049385 L31.9275443,18.0008215 L31.8585304,18.0032854 C30.3144224,18.0768144 29.1097123,19.3439602 29.0939898,20.8701615 L29.097179,21.040758 L29.9048697,38.0022637 C29.9581252,39.1206289 30.8803676,40 32,40 C33.06874,40 33.9576268,39.1987548 34.082545,38.1532266 L34.0951303,38.0022637 L34.9024986,21.0475292 L34.9057502,20.909153 C34.9057502,19.3598536 33.6946505,18.0934217 32.1675321,18.0049385 L32.1675321,18.0049385 Z" fill="#000000" />\n  </g>\n</svg>\n'}),define("text!res/icons/shelf-sync-offline.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M32,1 C49.1208272,1 63,14.8791728 63,32 C63,49.1208272 49.1208272,63 32,63 C14.8791728,63 1,49.1208272 1,32 C1,14.8791728 14.8791728,1 32,1 Z M32,43.5 C30.6192881,43.5 29.5,44.6192881 29.5,46 C29.5,47.3807119 30.6192881,48.5 32,48.5 C33.3807119,48.5 34.5,47.3807119 34.5,46 C34.5,44.6192881 33.3807119,43.5 32,43.5 Z M19.5737881,36.2597645 C18.6126825,37.0474396 18.4720894,38.4651064 19.2597645,39.4262119 C20.0474396,40.3873175 21.4651064,40.5279106 22.4262119,39.7402355 C23.515201,38.8477533 24.6942127,38.1153853 25.9381564,37.5560423 L25.9209172,37.3756695 L25.9209172,37.3756695 L25.9093972,37.1925243 L25.7002845,32.8128235 C23.496319,33.5772219 21.4273759,34.7406545 19.5737881,36.2597645 Z M38.300102,32.8057738 L38.0906028,37.1925243 C38.0849198,37.3118688 38.0758326,37.430277 38.0634379,37.5476569 C39.3069397,38.1044333 40.4865178,38.8348031 41.5762981,39.7253108 C42.538538,40.5115997 43.9560007,40.3689631 44.7422895,39.4067232 C45.5285784,38.4444832 45.3859419,37.0270206 44.4237019,36.2407317 C42.5702832,34.7262212 40.5024007,33.5668541 38.300102,32.8057738 Z M32.1675321,18.0049385 L31.9275443,18.0008215 L31.8585304,18.0032854 C30.3144224,18.0768144 29.1097123,19.3439602 29.0939898,20.8701615 L29.097179,21.040758 L29.9048697,38.0022637 C29.9581252,39.1206289 30.8803676,40 32,40 C33.06874,40 33.9576268,39.1987548 34.082545,38.1532266 L34.0951303,38.0022637 L34.9024986,21.0475292 L34.9057502,20.909153 C34.9057502,19.3598536 33.6946505,18.0934217 32.1675321,18.0049385 L32.1675321,18.0049385 Z M38.790898,22.4923076 L38.572642,27.0637076 C42.6020585,28.07405 46.3442014,30.0019148 49.54477,32.7160436 C50.4925147,33.5197449 51.9123423,33.4029747 52.7160436,32.45523 C53.5197449,31.5074853 53.4029747,30.0876577 52.45523,29.2839564 C48.4979819,25.9281524 43.8222361,23.6019786 38.790898,22.4923076 Z M11.5514192,29.203713 C10.6005725,30.0037421 10.4783108,31.4231073 11.2783399,32.3739539 C12.078369,33.3248005 13.4977342,33.4470623 14.4485808,32.6470332 C17.6545909,29.949541 21.3980086,28.0378313 25.4258003,27.0420831 L25.2080994,22.4731608 C20.1842907,23.5662162 15.51198,25.8713523 11.5514192,29.203713 Z" fill="#000000" />\n  </g>\n</svg>\n'}),define("text!res/icons/ghost-authentication.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 77" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-hollow" d="M32.0142404,12.6600013 C45.7827976,12.6600013 56.9748007,23.1683803 56.9748007,37.7032136 C56.9748007,40.7758351 56.478447,44.1172548 55.4857395,47.7274726 L55.2937902,48.4075385 C54.0308241,52.7706623 54.2061448,57.4244762 55.7938032,61.6802105 L58.6887653,69.4401858 C59.1200277,70.596189 58.5325092,71.8829219 57.376506,72.3141843 C57.028264,72.4441006 56.6531104,72.4850769 56.285034,72.4334008 L45.9578755,70.9835188 C44.7303627,70.8111821 43.4792465,70.9479857 42.3179833,71.3815238 L34.6861337,74.230746 C32.9414182,74.8821061 31.0159652,74.8560895 29.2894857,74.1578269 L22.5506687,71.4323594 C21.349796,70.9466748 20.0430017,70.78264 18.7593456,70.9564552 L7.68865928,72.4554959 C6.46598948,72.6210531 5.34060913,71.7640941 5.17505193,70.5414243 C5.12587382,70.1782351 5.16680506,69.8085247 5.29423695,69.4648883 L8.05234454,62.0272987 C9.70332149,57.5752278 9.89283508,52.7129176 8.59338822,48.145851 C7.51694501,44.3625582 6.9787234,40.8816791 6.9787234,37.7032136 C6.9787234,23.1692533 18.1707265,12.6600013 32.0142404,12.6600013 Z" stroke="#000000" stroke-linecap="round" stroke-width="3" />\n    <path class="icon-solid" d="M32.0142404,14.1600013 C45.2129405,14.1600013 55.4748007,24.2512763 55.4748007,37.7032136 C55.4748007,40.6341527 54.9980867,43.8433588 54.0394209,47.3297761 L53.850191,48.0000811 C52.5003974,52.6630451 52.6881525,57.6469334 54.3884166,62.2045086 L57.2833787,69.9644839 C57.4250792,70.3443136 57.2320374,70.7670973 56.8522078,70.9087978 C56.7377854,70.9514845 56.6145207,70.9649482 56.4935813,70.9479689 L46.1664228,69.4980869 C44.6916539,69.2910366 43.1885271,69.4553964 41.7933523,69.9762614 L34.1615027,72.8254836 C32.7682228,73.3456412 31.230611,73.3248651 29.8518938,72.7672526 L23.1130769,70.041785 C21.6703141,69.4582697 20.1002941,69.2611936 18.5580729,69.4700201 L7.48738658,70.9690608 C7.08565222,71.0234582 6.71588439,70.7418859 6.66148703,70.3401516 C6.64532851,70.220818 6.65877734,70.0993417 6.70064782,69.9864326 L9.45875541,62.548843 C11.1618561,57.9562138 11.4076063,52.9544999 10.1695005,48.2237488 L10.0361263,47.7353552 C8.99587096,44.0792491 8.4787234,40.7346637 8.4787234,37.7032136 C8.4787234,24.2411622 18.7513013,14.1600013 32.0142404,14.1600013 Z" fill="#000000" fill-opacity="0.07" fill-rule="nonzero" />\n    <path d="M50.8944505,5.15026579 C50.8944505,5.15026579 46.7460732,7.18086174 45.8407768,7.18086174 C44.9354803,7.18086174 40.7257568,5.15026579 40.7257568,5.15026579 L40.7257568,10.4685942 C44.5621406,11.5897882 48.0278071,13.6702119 50.8944505,16.2756932 L50.8944505,5.15026579 Z" fill="#21A69C" />\n    <path class="icon-solid" d="M39.5302246,50.7157737 C39.9804224,50.7035086 40.3447063,50.7558416 40.3447063,50.9185707 C40.3447063,52.5795682 38.8745385,53.9296799 36.6311603,54.7032267 L36.6308978,57.9050769 C36.6308978,59.2364036 35.9200778,60.4664284 34.7665743,61.1311541 C33.8527418,61.6577653 32.9355925,61.9210709 32.0151263,61.9210709 C31.0888169,61.9210709 30.1622556,61.6544117 29.2354423,61.1210933 C28.0808056,60.456671 27.3691022,59.2260112 27.3691022,57.8938539 L27.3684789,54.6676866 C25.2233082,53.8887158 23.8062491,52.5544137 23.8062491,50.9185707 C23.8062491,50.8084263 24.0877029,50.7695189 24.4110443,50.7735232 L24.4110443,50.7735232 L24.6742843,50.7845457 C24.7215436,50.7876595 24.7704609,50.7913816 24.820984,50.7956671 L24.820984,50.7956671 L25.142973,50.8277826 L25.6927219,50.8965939 L28.0018281,51.2172271 L28.5328037,51.2820293 L29.080971,51.3420251 L29.6438185,51.3950582 L29.6438185,51.3950582 L29.9299626,51.4182898 L30.5101217,51.4568356 C30.9974373,51.4841092 31.4935049,51.4985144 31.9917844,51.4944357 C32.4617317,51.4905888 32.9336928,51.469892 33.4010605,51.4375551 L33.4010605,51.4375551 L33.9592741,51.3934969 L34.5105411,51.3402648 L34.5105411,51.3402648 L34.7827767,51.3108336 L35.5820865,51.2142808 L36.0972908,51.1455301 L37.961786,50.878816 L38.5573137,50.8000973 L38.9160492,50.7594906 L39.2411986,50.7307159 Z" fill="#000000" />\n    <path class="icon-solid" d="M41.690314,38.2486843 C43.6493926,38.2486843 45.2375397,39.8348175 45.2375397,41.791412 C45.2375397,43.1443156 44.4782233,44.3200962 43.3619977,44.9168571 C42.9805671,43.3725498 41.5843218,42.2285431 39.9205402,42.2285431 C39.3155668,42.2285431 38.7459657,42.3797976 38.2475812,42.6465078 C38.1792593,42.3735364 38.1430884,42.0866929 38.1430884,41.791412 C38.1430884,39.8348175 39.7312354,38.2486843 41.690314,38.2486843 Z" fill="#000000" />\n  </g>\n</svg>\n'}),define("text!res/icons/sharing-social-twitter.svg",[],function(){return'<svg title="Twitter logo" viewBox="0 0 24 24">\n  <path class="icon-solid" clip-rule="evenodd" d="M21.999 6.275a8.703 8.703 0 01-2.356.597c.846-.469 1.497-1.212 1.804-2.095a8.632 8.632 0 01-2.606.918C18.093 4.96 17.027 4.5 15.847 4.5c-2.266 0-4.104 1.694-4.104 3.786 0 .297.038.586.106.863-3.41-.158-6.433-1.665-8.456-3.955a3.543 3.543 0 00-.556 1.903c0 1.314.725 2.474 1.826 3.152a4.357 4.357 0 01-1.86-.475v.048c0 1.835 1.414 3.365 3.291 3.713a4.472 4.472 0 01-1.852.066c.521 1.504 2.037 2.6 3.833 2.63-1.404 1.015-3.174 1.62-5.096 1.62A9.01 9.01 0 012 17.799 12.324 12.324 0 008.29 19.5c7.548 0 11.675-5.77 11.675-10.774 0-.163-.004-.327-.012-.49A8.062 8.062 0 0022 6.277l-.001-.001z" fill="#000" fill-rule="evenodd" />\n</svg>\n'}),define("text!res/icons/feature-accessibility.svg",[],function(){return'<svg version="1.1" viewBox="0 0 90 90" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <circle class="icon-hollow" cx="45" cy="45" r="33.92" stroke="#000000" stroke-width="3.84" />\n    <path class="icon-solid" d="M62.287397,30.3009328 L52.132776,32.4559099 C51.0148264,32.6931571 49.8751179,32.8127577 48.7322717,32.8127577 L41.2858156,32.8127577 C40.119172,32.8127577 38.9558666,32.6881244 37.8157015,32.4409794 L27.9803972,30.309054 C27.1485325,30.1287369 26.3279971,30.6569206 26.1476801,31.4887852 C26.1244269,31.59606 26.1127005,31.7055121 26.1127005,31.8152782 C26.1127005,32.9322727 26.8876061,33.8997804 27.977634,34.1437393 L35.2631843,35.7743166 C37.7575719,36.3325849 39.5308429,38.5466009 39.5308429,41.1026981 L39.5308429,48.7743449 L39.5308429,48.7743449 L35.5781402,67.5379395 C35.3819074,68.469462 35.9606827,69.388518 36.8855545,69.6140253 C37.8083874,69.8390354 38.7421377,69.2864444 38.9889957,68.3692142 L43.2712365,52.4580382 C43.480539,51.6803496 44.1856837,51.1398919 44.9910452,51.1398919 C45.8009643,51.1398919 46.5147024,51.6718834 46.7461042,52.448042 L51.5523441,68.568933 C51.7923663,69.3740055 52.6327449,69.8387292 53.4422265,69.6140253 C54.2602375,69.3869538 54.7586828,68.5607432 54.5781003,67.7312293 L50.4512476,48.7743449 L50.4512476,48.7743449 L50.4512476,41.1227862 C50.4512476,38.5575376 52.2369599,36.3381825 54.7427597,35.789122 L62.2900532,34.1353906 C63.3800613,33.8965525 64.1568356,32.9311461 64.1568356,31.8152782 C64.1568356,30.9603029 63.4637412,30.2672085 62.6087659,30.2672085 C62.5007598,30.2672085 62.3930503,30.2785115 62.287397,30.3009328 Z" fill="#000000" />\n    <circle class="icon-solid" cx="44.9910452" cy="26.4915809" fill="#000000" r="4.09515177" />\n  </g>\n</svg>\n'}),define("text!res/icons/feature-settings.svg",[],function(){return'<svg version="1.1" viewBox="0 0 90 90" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M45.0000094,27.4008197 C55.7545086,27.4008197 64.6112254,35.5261922 65.7660681,45.9728455 L47.3215184,45.9728921 C46.0393844,45.9728921 45.0000094,47.0122671 45.0000094,48.2944012 C45.0000094,49.5765352 46.0393844,50.6159102 47.3215184,50.6159102 L47.3215184,50.6159102 L65.7659576,50.6169558 C64.6106608,61.0631281 55.7541658,69.1879826 45.0000094,69.1879826 C33.460803,69.1879826 24.1064279,59.8336076 24.1064279,48.2944012 C24.1064279,36.7551947 33.460803,27.4008197 45.0000094,27.4008197 Z" fill="#000000" transform="translate(44.936248, 48.294401) rotate(40.000000) translate(-44.936248, -48.294401) " />\n    <circle class="icon-solid" cx="45" cy="15.7933002" fill="#000000" r="3.48226358" />\n    <circle class="icon-solid" cx="62.5714357" cy="20.9527392" fill="#000000" r="3.48226358" transform="translate(62.571436, 20.952739) rotate(33.000000) translate(-62.571436, -20.952739) " />\n    <circle class="icon-solid" cx="74.5640648" cy="34.7929709" fill="#000000" r="3.48226358" transform="translate(74.564065, 34.792971) rotate(65.000000) translate(-74.564065, -34.792971) " />\n    <circle class="icon-solid" cx="77.1703121" cy="52.9198195" fill="#000000" r="3.48226358" transform="translate(77.170312, 52.919820) rotate(98.000000) translate(-77.170312, -52.919820) " />\n    <circle class="icon-solid" cx="69.5627127" cy="69.5781386" fill="#000000" r="3.48226358" transform="translate(69.562713, 69.578139) rotate(131.000000) translate(-69.562713, -69.578139) " />\n    <circle class="icon-solid" cx="20.4372873" cy="69.5781386" fill="#000000" r="3.48226358" transform="translate(20.437287, 69.578139) rotate(229.000000) translate(-20.437287, -69.578139) " />\n    <circle class="icon-solid" cx="12.8296879" cy="52.9198195" fill="#000000" r="3.48226358" transform="translate(12.829688, 52.919820) rotate(262.000000) translate(-12.829688, -52.919820) " />\n    <circle class="icon-solid" cx="15.4359352" cy="34.7929709" fill="#000000" r="3.48226358" transform="translate(15.435935, 34.792971) rotate(295.000000) translate(-15.435935, -34.792971) " />\n    <circle class="icon-solid" cx="27.4285643" cy="20.9527392" fill="#000000" r="3.48226358" transform="translate(27.428564, 20.952739) rotate(327.000000) translate(-27.428564, -20.952739) " />\n  </g>\n</svg>\n'}),define("text!res/icons/feature-one-tap-magazines.svg",[],function(){return'<svg version="1.1" viewBox="0 0 90 90" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid icon-hollow" d="M73.8762163,10.5081816 L48.4081741,67.4369725 C42.3026899,69.0735824 36.5167962,69.8963958 31.0493561,69.8963958 C25.840952,69.8963958 19.4284018,68.7897359 11.8096347,66.6058595 L11.8096347,66.6058595 L34.3860522,17.3181349 C39.9018099,17.3084408 46.0622245,17.0595301 52.9975437,16.4873649 C59.2936482,15.967935 66.2555892,13.9850198 73.8762163,10.5081816 L73.8762163,10.5081816 Z" fill="#000000" fill-opacity="0.07" fill-rule="nonzero" stroke="#000000" stroke-width="3.6072979" />\n    <path class="icon-hollow" d="M13.3000696,66.90404 C20.4009627,71.1524554 26.3759193,73.7679476 31.2249395,74.7505165 C35.9286356,75.703638 43.2967566,75.0878042 53.3293027,72.9030151 C53.9194795,72.7744965 54.4164719,72.3791186 54.6743908,71.8329469 L79.2702141,19.748576 L79.2702141,19.748576" fill-rule="nonzero" stroke="#000000" stroke-linecap="round" stroke-width="3.6072979" />\n    <path class="icon-hollow" d="M12.5024654,67.5632817 C16.3781503,72.9934645 23.1897175,77.034796 32.937167,79.6872763 C38.1060906,81.0938461 46.988824,80.6501941 59.5853673,78.3563204 C60.2020807,78.2440364 60.7268819,77.8414283 60.9950933,77.2748546 L80.818381,35.399846 L80.818381,35.399846" fill-rule="nonzero" stroke="#000000" stroke-linecap="round" stroke-width="3.6072979" />\n  </g>\n</svg>\n'}),define("text!res/icons/feature-magazine-rack.svg",[],function(){return'<svg version="1.1" viewBox="0 0 90 90" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-linecap="round" stroke-width="1">\n    <path class="icon-solid icon-hollow" d="M13,45.9415205 L13,31.5789474 C13,31.3464064 13.1885117,31.1578947 13.4210526,31.1578947 L29.4210526,31.1578947 C29.6535936,31.1578947 29.8421053,31.3464064 29.8421053,31.5789474 L29.8421053,45.9415205" fill="#000000" fill-opacity="0.14" stroke="#000000" stroke-width="3.55555556" />\n    <path class="icon-solid icon-hollow" d="M13,25.6374261 L13,13.0019986 C13,12.7974215 13.1885117,12.6315789 13.4210526,12.6315789 L29.4210526,12.6315789 C29.6535936,12.6315789 29.8421053,12.7974215 29.8421053,13.0019986 L29.8421053,25.6374261" fill="#000000" fill-opacity="0.21" stroke="#000000" stroke-width="3.55555556" />\n    <path class="icon-solid icon-hollow" d="M36.5718432,25.6374261 L36.5718432,13.0019986 C36.5718432,12.7974215 36.7603549,12.6315789 36.9928958,12.6315789 L52.9928958,12.6315789 C53.2254368,12.6315789 53.4139485,12.7974215 53.4139485,13.0019986 L53.4139485,25.6374261" fill="#000000" fill-opacity="0.21" stroke="#000000" stroke-width="3.55555556" />\n    <path class="icon-solid icon-hollow" d="M60.1578947,25.6374261 L60.1578947,13.0019986 C60.1578947,12.7974215 60.3464064,12.6315789 60.5789474,12.6315789 L76.5789474,12.6315789 C76.8114883,12.6315789 77,12.7974215 77,13.0019986 L77,25.6374261" fill="#000000" fill-opacity="0.21" stroke="#000000" stroke-width="3.55555556" />\n    <path class="icon-solid icon-hollow" d="M36.5718432,45.9415205 L36.5718432,31.5789474 C36.5718432,31.3464064 36.7603549,31.1578947 36.9928958,31.1578947 L52.9928958,31.1578947 C53.2254368,31.1578947 53.4139485,31.3464064 53.4139485,31.5789474 L53.4139485,45.9415205" fill="#000000" fill-opacity="0.14" stroke="#000000" stroke-width="3.55555556" />\n    <path class="icon-solid icon-hollow" d="M60.1578947,45.9415205 L60.1578947,31.5789474 C60.1578947,31.3464064 60.3464064,31.1578947 60.5789474,31.1578947 L76.5789474,31.1578947 C76.8114883,31.1578947 77,31.3464064 77,31.5789474 L77,45.9415205" fill="#000000" fill-opacity="0.14" stroke="#000000" stroke-width="3.55555556" />\n    <rect class="icon-solid icon-hollow" fill="#000000" fill-opacity="0.07" height="26.9473684" rx="0.421052632" stroke="#000000" stroke-width="3.55555556" width="16.8421053" x="13" y="51.3684211" />\n    <rect class="icon-solid icon-hollow" fill="#000000" fill-opacity="0.07" height="26.9473684" rx="0.421052632" stroke="#000000" stroke-width="3.55555556" width="16.8421053" x="36.5789474" y="51.3684211" />\n    <rect class="icon-solid icon-hollow" fill="#000000" fill-opacity="0.07" height="26.9473684" rx="0.421052632" stroke="#000000" stroke-width="3.55555556" width="16.8421053" x="60.1578947" y="51.3684211" />\n  </g>\n</svg>\n';
}),define("text!res/icons/feature-newsstand.svg",[],function(){return'<svg version="1.1" viewBox="0 0 90 90" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path d="M76.8076923,7.42307692 C77.742328,7.42307692 78.5,8.18074888 78.5,9.11538462 L78.5,84.2307692 C78.5,85.165405 77.742328,85.9230769 76.8076923,85.9230769 L17.5769231,85.9230769 C16.6422873,85.9230769 15.8846154,85.165405 15.8846154,84.2307692 L15.8846154,82.3540769 L73.4230769,82.3548951 C74.3085213,82.3548951 75.0351395,81.6748793 75.1091728,80.8086062 L75.1153846,80.6625874 L75.1146154,7.42307692 L76.8076923,7.42307692 Z" fill="#05948A" fill-opacity="0.5" />\n    <path d="M73.4230769,4.03846154 C74.3577127,4.03846154 75.1153846,4.83722625 75.1153846,5.82255245 L75.1153846,80.7543706 C75.1153846,81.7396968 74.3577127,82.5384615 73.4230769,82.5384615 L14.1923077,82.5384615 C13.257672,82.5384615 12.5,81.7396968 12.5,80.7543706 L12.5,5.82255245 C12.5,4.83722625 13.257672,4.03846154 14.1923077,4.03846154 L73.4230769,4.03846154 Z" fill="#20A69D" fill-opacity="0.25" />\n    <path d="M43.8076923,31.75 C44.8073027,31.75 45.6287804,32.5126771 45.7219659,33.4878718 L45.7307692,33.673077 L45.7302885,41.3644231 L53.4230769,41.3653846 C54.3560466,41.3653846 55.1338429,42.0297611 55.3091658,42.911214 L55.3373505,43.1032564 L55.3461538,43.2884615 C55.3461538,44.2880719 54.5834768,45.1095496 53.6082248,45.2027351 L53.4230082,45.2115385 L45.7302885,45.2096154 L45.7307692,52.9038461 C45.7307692,53.8368158 45.0663928,54.6146121 44.1849398,54.7899351 L43.9928974,54.8181197 L43.8076923,54.826923 C42.8080819,54.826923 41.9866043,54.064246 41.8934187,53.0890513 L41.8846154,52.9038461 L41.8836539,45.2096154 L34.1923077,45.2115385 C33.259338,45.2115385 32.4815417,44.547162 32.3062188,43.665709 L32.2780341,43.4736667 L32.2692308,43.2884615 C32.2692308,42.2888511 33.0319078,41.4673735 34.0070453,41.3741879 L34.192239,41.3653846 L41.8836539,41.3644231 L41.8846154,33.673077 C41.8846154,32.7401072 42.5489918,31.962311 43.4304448,31.786988 L43.6224872,31.7588033 L43.8076923,31.75 Z" fill="#187B74" fill-rule="nonzero" />\n  </g>\n</svg>\n'}),define("text!res/icons/menu-libraries-add.svg",[],function(){return'<svg version="1.1" viewBox="0 0 176 143" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M56.7666224,28 L134.233378,28 C144.931602,28 148.811037,29.1139073 152.722148,31.2055924 C156.63326,33.2972776 159.702722,36.3667404 161.794408,40.2778516 C163.886093,44.1889627 165,48.0683975 165,58.7666224 L165,100.233378 C165,110.931602 163.886093,114.811037 161.794408,118.722148 C159.702722,122.63326 156.63326,125.702722 152.722148,127.794408 C148.811037,129.886093 144.931602,131 134.233378,131 L56.7666224,131 C46.0683975,131 42.1889627,129.886093 38.2778516,127.794408 C34.3667404,125.702722 31.2972776,122.63326 29.2055924,118.722148 C27.1139073,114.811037 26,110.931602 26,100.233378 L26,58.7666224 C26,48.0683975 27.1139073,44.1889627 29.2055924,40.2778516 C31.2972776,36.3667404 34.3667404,33.2972776 38.2778516,31.2055924 C42.1889627,29.1139073 46.0683975,28 56.7666224,28 Z" fill="#000000" opacity="0.2" />\n    <path d="M46.9207946,22 L132.079205,22 C141.440152,22 144.834658,22.9746689 148.25688,24.8048934 C151.679102,26.6351179 154.364882,29.3208979 156.195107,32.7431201 C158.025331,36.1653423 159,39.5598478 159,48.9207946 L159,98.0792054 C159,107.440152 158.025331,110.834658 156.195107,114.25688 C154.364882,117.679102 151.679102,120.364882 148.25688,122.195107 C144.834658,124.025331 141.440152,125 132.079205,125 L46.9207946,125 C37.5598478,125 34.1653423,124.025331 30.7431201,122.195107 C27.3208979,120.364882 24.6351179,117.679102 22.8048934,114.25688 C20.9746689,110.834658 20,107.440152 20,98.0792054 L20,48.9207946 C20,39.5598478 20.9746689,36.1653423 22.8048934,32.7431201 C24.6351179,29.3208979 27.3208979,26.6351179 30.7431201,24.8048934 C34.1653423,22.9746689 37.5598478,22 46.9207946,22 Z" fill="#FFFFFF" />\n    <path class="icon-solid" d="M45.0749668,24 L129.925033,24 C137.948702,24 140.858278,24.8354305 143.791611,26.4041943 C146.724945,27.9729582 149.027042,30.2750553 150.595806,33.2083887 C152.164569,36.141722 153,39.0512981 153,47.0749668 L153,95.9250332 C153,103.948702 152.164569,106.858278 150.595806,109.791611 C149.027042,112.724945 146.724945,115.027042 143.791611,116.595806 C140.858278,118.164569 137.948702,119 129.925033,119 L45.0749668,119 C37.0512981,119 34.141722,118.164569 31.2083887,116.595806 C28.2750553,115.027042 25.9729582,112.724945 24.4041943,109.791611 C22.8354305,106.858278 22,103.948702 22,95.9250332 L22,47.0749668 C22,39.0512981 22.8354305,36.141722 24.4041943,33.2083887 C25.9729582,30.2750553 28.2750553,27.9729582 31.2083887,26.4041943 C34.141722,24.8354305 37.0512981,24 45.0749668,24 Z" fill="#000000" opacity="0.33" />\n    <path class="icon-solid" d="M117.248587,66.5481415 C119.597191,66.4881469 121.028832,67.1741237 122.072583,68.1565477 C123.219397,69.2359786 123.904475,70.7399743 123.904475,72.4049983 L123.904475,72.4049983 L123.904193,79.0938308 L130.59488,79.0955246 C132.097895,79.0955247 133.474528,79.6574618 134.52312,80.6004475 C135.561145,81.5339304 136.280415,82.8450115 136.461011,84.3634654 C136.506937,86.6284942 135.843221,88.1144429 134.759657,89.1890016 C133.692769,90.2470224 132.220503,90.9044753 130.593772,90.9044751 L130.593772,90.9044751 L123.904193,90.902217 L123.904475,97.5951451 C123.904475,99.0980288 123.342528,100.474655 122.399461,101.523255 C121.465992,102.561183 120.154944,103.280421 118.636535,103.461011 C116.37162,103.506937 114.885718,102.843288 113.811171,101.759893 C112.753011,100.693018 112.095525,99.220783 112.095525,97.5953708 L112.095525,97.5953708 L112.094819,90.9022169 L105.404589,90.9044754 C103.901837,90.9044753 102.525218,90.3425174 101.47661,89.3993688 C100.43878,88.4659147 99.7195737,87.1548993 99.538989,85.6365345 C99.4930635,83.371684 100.156675,81.8858063 101.239977,80.8112665 C102.306845,79.7530289 103.779062,79.0955247 105.403989,79.0955248 L105.403989,79.0955248 L112.094819,79.0938308 L112.095525,72.4049877 C112.095525,70.9190228 112.647888,69.549972 113.566578,68.5051786 C114.488394,67.4568295 115.778782,66.7355982 117.248587,66.5481415 Z" fill="#000000" fill-rule="nonzero" stroke="#FFFFFF" stroke-width="5" />\n  </g>\n</svg>\n'}),define("text!res/icons/menu-libraries-cards.svg",[],function(){return'<svg version="1.1" viewBox="0 0 176 143" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M57.2666224,28 L134.733378,28 C145.431602,28 149.311037,29.1139073 153.222148,31.2055924 C157.13326,33.2972776 160.202722,36.3667404 162.294408,40.2778516 C164.386093,44.1889627 165.5,48.0683975 165.5,58.7666224 L165.5,100.233378 C165.5,110.931602 164.386093,114.811037 162.294408,118.722148 C160.202722,122.63326 157.13326,125.702722 153.222148,127.794408 C149.311037,129.886093 145.431602,131 134.733378,131 L57.2666224,131 C46.5683975,131 42.6889627,129.886093 38.7778516,127.794408 C34.8667404,125.702722 31.7972776,122.63326 29.7055924,118.722148 C27.6139073,114.811037 26.5,110.931602 26.5,100.233378 L26.5,58.7666224 C26.5,48.0683975 27.6139073,44.1889627 29.7055924,40.2778516 C31.7972776,36.3667404 34.8667404,33.2972776 38.7778516,31.2055924 C42.6889627,29.1139073 46.5683975,28 57.2666224,28 Z" fill="#000000" opacity="0.2" />\n    <path d="M47.4207946,22 L132.579205,22 C141.940152,22 145.334658,22.9746689 148.75688,24.8048934 C152.179102,26.6351179 154.864882,29.3208979 156.695107,32.7431201 C158.525331,36.1653423 159.5,39.5598478 159.5,48.9207946 L159.5,98.0792054 C159.5,107.440152 158.525331,110.834658 156.695107,114.25688 C154.864882,117.679102 152.179102,120.364882 148.75688,122.195107 C145.334658,124.025331 141.940152,125 132.579205,125 L47.4207946,125 C38.0598478,125 34.6653423,124.025331 31.2431201,122.195107 C27.8208979,120.364882 25.1351179,117.679102 23.3048934,114.25688 C21.4746689,110.834658 20.5,107.440152 20.5,98.0792054 L20.5,48.9207946 C20.5,39.5598478 21.4746689,36.1653423 23.3048934,32.7431201 C25.1351179,29.3208979 27.8208979,26.6351179 31.2431201,24.8048934 C34.6653423,22.9746689 38.0598478,22 47.4207946,22 Z" fill="#FFFFFF" />\n    <path class="icon-solid" d="M45.5749668,24 L130.425033,24 C138.448702,24 141.358278,24.8354305 144.291611,26.4041943 C147.224945,27.9729582 149.527042,30.2750553 151.095806,33.2083887 C152.664569,36.141722 153.5,39.0512981 153.5,47.0749668 L153.5,95.9250332 C153.5,103.948702 152.664569,106.858278 151.095806,109.791611 C149.527042,112.724945 147.224945,115.027042 144.291611,116.595806 C141.358278,118.164569 138.448702,119 130.425033,119 L45.5749668,119 C37.5512981,119 34.641722,118.164569 31.7083887,116.595806 C28.7750553,115.027042 26.4729582,112.724945 24.9041943,109.791611 C23.3354305,106.858278 22.5,103.948702 22.5,95.9250332 L22.5,47.0749668 C22.5,39.0512981 23.3354305,36.141722 24.9041943,33.2083887 C26.4729582,30.2750553 28.7750553,27.9729582 31.7083887,26.4041943 C34.641722,24.8354305 37.5512981,24 45.5749668,24 Z" fill="#000000" opacity="0.33" />\n    <circle class="icon-solid" cx="117.5" cy="84" fill="#000000" r="20.5" stroke="#FFFFFF" stroke-width="5" />\n    <path d="M108.766667,81.3666667 C107.109812,81.3666667 105.766667,82.7098124 105.766667,84.3666667 C105.766667,86.0235209 107.109812,87.3666667 108.766667,87.3666667 C110.423521,87.3666667 111.766667,86.0235209 111.766667,84.3666667 C111.766667,82.7098124 110.423521,81.3666667 108.766667,81.3666667 Z" fill="#FFFFFF" fill-rule="nonzero" />\n    <path d="M117.5,81.3666667 C115.843146,81.3666667 114.5,82.7098124 114.5,84.3666667 C114.5,86.0235209 115.843146,87.3666667 117.5,87.3666667 C119.156854,87.3666667 120.5,86.0235209 120.5,84.3666667 C120.5,82.7098124 119.156854,81.3666667 117.5,81.3666667 Z" fill="#FFFFFF" fill-rule="nonzero" />\n    <path d="M126.233333,81.3666667 C124.576479,81.3666667 123.233333,82.7098124 123.233333,84.3666667 C123.233333,86.0235209 124.576479,87.3666667 126.233333,87.3666667 C127.890188,87.3666667 129.233333,86.0235209 129.233333,84.3666667 C129.233333,82.7098124 127.890188,81.3666667 126.233333,81.3666667 Z" fill="#FFFFFF" fill-rule="nonzero" />\n  </g>\n</svg>\n'}),define("text!res/icons/menu-settings-notifications.svg",[],function(){return'<svg version="1.1" viewBox="0 0 176 143" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M65.2666224,28 L126.733378,28 C137.431602,28 141.311037,29.1139073 145.222148,31.2055924 C149.13326,33.2972776 152.202722,36.3667404 154.294408,40.2778516 C156.386093,44.1889627 157.5,48.0683975 157.5,58.7666224 L157.5,100.233378 C157.5,110.931602 156.386093,114.811037 154.294408,118.722148 C152.202722,122.63326 149.13326,125.702722 145.222148,127.794408 C141.311037,129.886093 137.431602,131 126.733378,131 L65.2666224,131 C54.5683975,131 50.6889627,129.886093 46.7778516,127.794408 C42.8667404,125.702722 39.7972776,122.63326 37.7055924,118.722148 C35.6139073,114.811037 34.5,110.931602 34.5,100.233378 L34.5,58.7666224 C34.5,48.0683975 35.6139073,44.1889627 37.7055924,40.2778516 C39.7972776,36.3667404 42.8667404,33.2972776 46.7778516,31.2055924 C50.6889627,29.1139073 54.5683975,28 65.2666224,28 Z" fill="#000000" opacity="0.2" />\n    <path d="M55.4207946,22 L124.579205,22 C133.940152,22 137.334658,22.9746689 140.75688,24.8048934 C144.179102,26.6351179 146.864882,29.3208979 148.695107,32.7431201 C150.525331,36.1653423 151.5,39.5598478 151.5,48.9207946 L151.5,98.0792054 C151.5,107.440152 150.525331,110.834658 148.695107,114.25688 C146.864882,117.679102 144.179102,120.364882 140.75688,122.195107 C137.334658,124.025331 133.940152,125 124.579205,125 L55.4207946,125 C46.0598478,125 42.6653423,124.025331 39.2431201,122.195107 C35.8208979,120.364882 33.1351179,117.679102 31.3048934,114.25688 C29.4746689,110.834658 28.5,107.440152 28.5,98.0792054 L28.5,48.9207946 C28.5,39.5598478 29.4746689,36.1653423 31.3048934,32.7431201 C33.1351179,29.3208979 35.8208979,26.6351179 39.2431201,24.8048934 C42.6653423,22.9746689 46.0598478,22 55.4207946,22 Z" fill="#FFFFFF" />\n    <path class="icon-solid" d="M53.5749668,24 L122.425033,24 C130.448702,24 133.358278,24.8354305 136.291611,26.4041943 C139.224945,27.9729582 141.527042,30.2750553 143.095806,33.2083887 C144.664569,36.141722 145.5,39.0512981 145.5,47.0749668 L145.5,95.9250332 C145.5,103.948702 144.664569,106.858278 143.095806,109.791611 C141.527042,112.724945 139.224945,115.027042 136.291611,116.595806 C133.358278,118.164569 130.448702,119 122.425033,119 L53.5749668,119 C45.5512981,119 42.641722,118.164569 39.7083887,116.595806 C36.7750553,115.027042 34.4729582,112.724945 32.9041943,109.791611 C31.3354305,106.858278 30.5,103.948702 30.5,95.9250332 L30.5,47.0749668 C30.5,39.0512981 31.3354305,36.141722 32.9041943,33.2083887 C34.4729582,30.2750553 36.7750553,27.9729582 39.7083887,26.4041943 C42.641722,24.8354305 45.5512981,24 53.5749668,24 Z" fill="#000000" opacity="0.6" />\n    <path d="M58.231691,77.0488588 L83.6780274,58.2057973 C86.0882899,56.7004324 89.149205,56.7144842 91.5455447,58.2419146 L116.768309,77.0496476" fill-rule="nonzero" stroke="#FFFFFF" stroke-linecap="round" stroke-width="6" transform="translate(87.500000, 67.068064) scale(-1, 1) rotate(-180.000000) translate(-87.500000, -67.068064) " />\n    <rect class="icon-solid" fill="#000000" height="40.0896" rx="19.1754" stroke="#FFFFFF" stroke-linecap="round" stroke-width="6" width="40.0896" x="125.957475" y="10" />\n  </g>\n</svg>\n'}),define("text!res/icons/menu-settings-accessibility.svg",[],function(){return'<svg version="1.1" viewBox="0 0 176 143" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M65.2666224,28 L126.733378,28 C137.431602,28 141.311037,29.1139073 145.222148,31.2055924 C149.13326,33.2972776 152.202722,36.3667404 154.294408,40.2778516 C156.386093,44.1889627 157.5,48.0683975 157.5,58.7666224 L157.5,100.233378 C157.5,110.931602 156.386093,114.811037 154.294408,118.722148 C152.202722,122.63326 149.13326,125.702722 145.222148,127.794408 C141.311037,129.886093 137.431602,131 126.733378,131 L65.2666224,131 C54.5683975,131 50.6889627,129.886093 46.7778516,127.794408 C42.8667404,125.702722 39.7972776,122.63326 37.7055924,118.722148 C35.6139073,114.811037 34.5,110.931602 34.5,100.233378 L34.5,58.7666224 C34.5,48.0683975 35.6139073,44.1889627 37.7055924,40.2778516 C39.7972776,36.3667404 42.8667404,33.2972776 46.7778516,31.2055924 C50.6889627,29.1139073 54.5683975,28 65.2666224,28 Z" fill="#000000" opacity="0.2" />\n    <path d="M55.4207946,22 L124.579205,22 C133.940152,22 137.334658,22.9746689 140.75688,24.8048934 C144.179102,26.6351179 146.864882,29.3208979 148.695107,32.7431201 C150.525331,36.1653423 151.5,39.5598478 151.5,48.9207946 L151.5,98.0792054 C151.5,107.440152 150.525331,110.834658 148.695107,114.25688 C146.864882,117.679102 144.179102,120.364882 140.75688,122.195107 C137.334658,124.025331 133.940152,125 124.579205,125 L55.4207946,125 C46.0598478,125 42.6653423,124.025331 39.2431201,122.195107 C35.8208979,120.364882 33.1351179,117.679102 31.3048934,114.25688 C29.4746689,110.834658 28.5,107.440152 28.5,98.0792054 L28.5,48.9207946 C28.5,39.5598478 29.4746689,36.1653423 31.3048934,32.7431201 C33.1351179,29.3208979 35.8208979,26.6351179 39.2431201,24.8048934 C42.6653423,22.9746689 46.0598478,22 55.4207946,22 Z" fill="#FFFFFF" />\n    <path class="icon-solid" d="M53.5749668,24 L122.425033,24 C130.448702,24 133.358278,24.8354305 136.291611,26.4041943 C139.224945,27.9729582 141.527042,30.2750553 143.095806,33.2083887 C144.664569,36.141722 145.5,39.0512981 145.5,47.0749668 L145.5,95.9250332 C145.5,103.948702 144.664569,106.858278 143.095806,109.791611 C141.527042,112.724945 139.224945,115.027042 136.291611,116.595806 C133.358278,118.164569 130.448702,119 122.425033,119 L53.5749668,119 C45.5512981,119 42.641722,118.164569 39.7083887,116.595806 C36.7750553,115.027042 34.4729582,112.724945 32.9041943,109.791611 C31.3354305,106.858278 30.5,103.948702 30.5,95.9250332 L30.5,47.0749668 C30.5,39.0512981 31.3354305,36.141722 32.9041943,33.2083887 C34.4729582,30.2750553 36.7750553,27.9729582 39.7083887,26.4041943 C42.641722,24.8354305 45.5512981,24 53.5749668,24 Z" fill="#000000" opacity="0.6" />\n    <path class="icon-solid" d="M123.22819,14.6425522 C124.906215,14.6425522 126.425382,15.3227063 127.525042,16.4223666 C128.624702,17.5220268 129.304857,19.0411934 129.304857,20.7192184 C129.304857,22.5327806 128.673631,24.2240742 127.599522,25.5590199 C126.525413,26.8939656 125.008421,27.8725636 123.236888,28.2607346 L123.236888,28.2607346 L108.237238,31.5473953 C106.435579,31.9421672 104.892791,32.9374062 103.800417,34.2950528 C102.708043,35.6526993 102.066083,37.3727533 102.066083,39.2171553 L102.066083,39.2171553 L102.066083,54.1012584 L110.19922,91.4611899 C110.547895,93.0628463 110.241025,94.6613138 109.452123,95.9689766 C108.663222,97.2766395 107.392291,98.2934978 105.812845,98.731936 C104.2209,99.1738436 102.598575,98.9378295 101.256227,98.1955202 C99.9138796,97.4532109 98.8515098,96.2046065 98.3794769,94.6213333 L98.3794769,94.6213333 L88.8274548,62.5823361 L79.1826804,94.146938 C78.7256842,95.8449617 77.6328828,97.2054661 76.2272314,98.037327 C74.8215801,98.8691879 73.1030788,99.1724053 71.3946831,98.7558549 C69.68867,98.3398855 68.3018607,97.2842582 67.4320472,95.903053 C66.5622338,94.5218478 66.209416,92.8150647 66.5713857,91.0967838 L66.5713857,91.0967838 L74.3626414,54.1114666 L74.3626414,39.1772318 C74.3626414,37.3394097 73.7251546,35.6245649 72.6393044,34.2688277 C71.5534543,32.9130904 70.0192408,31.9164606 68.2257876,31.5150682 L68.2257876,31.5150682 L53.746332,28.2744246 C51.9779138,27.8786354 50.4651167,26.8959177 49.3944241,25.5591054 C48.3237316,24.2222931 47.6951435,22.5313861 47.6951435,20.7192184 C47.6951435,20.2874039 47.7412745,19.8568249 47.8327513,19.434811 C48.1874307,17.7985534 49.1717569,16.4609624 50.4764778,15.6211056 C51.7811986,14.7812489 53.406314,14.4391263 55.0425716,14.7938056 L55.0425716,14.7938056 L74.5894618,19.0308389 C76.6466362,19.4767572 78.7455622,19.7016303 80.850511,19.7016303 L80.850511,19.7016303 L95.6497542,19.7016303 C97.711766,19.7016303 99.7681167,19.4858375 101.785208,19.0577776 L101.785208,19.0577776 L121.966715,14.7749311 C122.381438,14.6869202 122.804232,14.6425522 123.22819,14.6425522 Z" fill="#000000" stroke="#FFFFFF" stroke-width="6" />\n    <circle class="icon-solid" cx="88.2143622" cy="10.1387906" fill="#000000" r="8.13879062" />\n  </g>\n</svg>\n'}),define("text!res/icons/menu-settings-downloads.svg",[],function(){return'<svg version="1.1" viewBox="0 0 176 143" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M65.2666224,28 L126.733378,28 C137.431602,28 141.311037,29.1139073 145.222148,31.2055924 C149.13326,33.2972776 152.202722,36.3667404 154.294408,40.2778516 C156.386093,44.1889627 157.5,48.0683975 157.5,58.7666224 L157.5,100.233378 C157.5,110.931602 156.386093,114.811037 154.294408,118.722148 C152.202722,122.63326 149.13326,125.702722 145.222148,127.794408 C141.311037,129.886093 137.431602,131 126.733378,131 L65.2666224,131 C54.5683975,131 50.6889627,129.886093 46.7778516,127.794408 C42.8667404,125.702722 39.7972776,122.63326 37.7055924,118.722148 C35.6139073,114.811037 34.5,110.931602 34.5,100.233378 L34.5,58.7666224 C34.5,48.0683975 35.6139073,44.1889627 37.7055924,40.2778516 C39.7972776,36.3667404 42.8667404,33.2972776 46.7778516,31.2055924 C50.6889627,29.1139073 54.5683975,28 65.2666224,28 Z" fill="#000000" opacity="0.2" />\n    <path d="M55.4207946,22 L124.579205,22 C133.940152,22 137.334658,22.9746689 140.75688,24.8048934 C144.179102,26.6351179 146.864882,29.3208979 148.695107,32.7431201 C150.525331,36.1653423 151.5,39.5598478 151.5,48.9207946 L151.5,98.0792054 C151.5,107.440152 150.525331,110.834658 148.695107,114.25688 C146.864882,117.679102 144.179102,120.364882 140.75688,122.195107 C137.334658,124.025331 133.940152,125 124.579205,125 L55.4207946,125 C46.0598478,125 42.6653423,124.025331 39.2431201,122.195107 C35.8208979,120.364882 33.1351179,117.679102 31.3048934,114.25688 C29.4746689,110.834658 28.5,107.440152 28.5,98.0792054 L28.5,48.9207946 C28.5,39.5598478 29.4746689,36.1653423 31.3048934,32.7431201 C33.1351179,29.3208979 35.8208979,26.6351179 39.2431201,24.8048934 C42.6653423,22.9746689 46.0598478,22 55.4207946,22 Z" fill="#FFFFFF" />\n    <path class="icon-solid" d="M53.5749668,24 L122.425033,24 C130.448702,24 133.358278,24.8354305 136.291611,26.4041943 C139.224945,27.9729582 141.527042,30.2750553 143.095806,33.2083887 C144.664569,36.141722 145.5,39.0512981 145.5,47.0749668 L145.5,95.9250332 C145.5,103.948702 144.664569,106.858278 143.095806,109.791611 C141.527042,112.724945 139.224945,115.027042 136.291611,116.595806 C133.358278,118.164569 130.448702,119 122.425033,119 L53.5749668,119 C45.5512981,119 42.641722,118.164569 39.7083887,116.595806 C36.7750553,115.027042 34.4729582,112.724945 32.9041943,109.791611 C31.3354305,106.858278 30.5,103.948702 30.5,95.9250332 L30.5,47.0749668 C30.5,39.0512981 31.3354305,36.141722 32.9041943,33.2083887 C34.4729582,30.2750553 36.7750553,27.9729582 39.7083887,26.4041943 C42.641722,24.8354305 45.5512981,24 53.5749668,24 Z" fill="#000000" opacity="0.6" />\n    <path d="M56.0261285,45.9986475 C54.7069857,46.0750687 53.6607583,47.1688608 53.6607583,48.5070445 L53.6592724,60.5073852 L52.8390345,59.570178 L52.7555429,59.4872689 L52.5682324,59.3256018 C51.5250101,58.5488608 50.1306707,58.6457428 49.2469379,59.5292834 C48.3047133,60.471303 48.2670243,61.9752768 49.1338709,62.9622528 L50.1873464,64.0783253 L50.6296381,64.5393088 L51.2592026,65.1853548 L51.8492051,65.7774315 L52.2211642,66.1424692 L52.7479438,66.6459602 L53.2384181,67.0971179 L53.6938081,67.4965559 L53.9785134,67.7344176 L54.2485304,67.9497473 C54.2923293,67.983768 54.3355313,68.0168575 54.3781439,68.0490194 L54.6268068,68.2308919 C55.271369,68.6863674 55.7689051,68.9063487 56.1502932,68.9063487 C56.4361697,68.9063487 56.7877188,68.7826258 57.2183157,68.5282838 L57.4402633,68.3901959 L57.6757572,68.2301466 L57.9251687,68.0479444 L58.1888695,67.8433975 C58.2340311,67.8074337 58.2798035,67.7705309 58.3261945,67.7326851 L58.6120257,67.4942622 L58.913075,67.233016 L59.2297139,66.9487547 L59.562314,66.6412868 L59.9112466,66.3104208 L60.2768835,65.955965 L60.8574719,65.3796317 L61.2664947,64.9653636 L61.9139036,64.2984138 L62.8422987,63.3231193 C62.9228411,63.2377109 63.004188,63.1512637 63.0863469,63.0637738 L63.2715828,62.8503719 C64.0486003,61.8072321 63.9516777,60.412914 63.0678549,59.5292834 L62.8353244,59.3256018 L62.6973316,59.229235 C61.6718205,58.5587724 60.3593396,58.6841576 59.5140299,59.5292834 L58.6850286,60.4863111 L58.6868091,48.5071242 L58.6696615,48.2238816 C58.495776,46.9280498 57.4348657,45.9943823 56.1737837,45.9943823 L56.0261285,45.9986475 Z" fill="#FFFFFF" fill-rule="nonzero" />\n    <path d="M85.6102493,81.3986761 C84.2911065,81.4750973 83.2448791,82.5688893 83.2448791,83.907073 L83.2437217,95.9076008 L82.4231554,94.9702066 L82.3396637,94.8872975 L82.1523532,94.7256304 C81.1091309,93.9488894 79.7147916,94.0457713 78.8310587,94.929312 C77.8888342,95.8713316 77.8511452,97.3753054 78.7179918,98.3622813 L79.3106878,98.9929296 L79.9949014,99.7118894 L80.4280849,100.160721 L81.0443264,100.788709 L81.6214129,101.362932 L81.9849876,101.716181 L82.4995297,102.202159 L82.8225389,102.497147 L83.1299551,102.769147 L83.4221403,103.018343 L83.6994562,103.244916 L83.9622647,103.449048 C84.0048773,103.48121 84.0469004,103.512444 84.0883417,103.542755 L84.3300676,103.713566 L84.5581908,103.86239 C84.5950978,103.885372 84.6314532,103.907446 84.6672644,103.928614 L84.8756618,104.044799 C85.2123086,104.220447 85.4960465,104.306377 85.7344141,104.306377 C85.9488214,104.306377 86.2001696,104.236783 86.4941013,104.094686 L86.6964264,103.989181 L86.9117403,103.862002 C86.948729,103.838988 86.9862744,103.815064 87.0243842,103.790225 L87.259878,103.630175 L87.5092896,103.447973 L87.7729903,103.243426 L88.0513519,103.016343 L88.3447457,102.766533 L88.6535434,102.493803 L88.9781164,102.197962 L89.3188363,101.878819 L89.6760747,101.536182 L90.243717,100.977757 L90.8506156,100.365392 L91.277643,99.9268639 L91.9527553,99.2231646 L92.6704677,98.4638024 L92.8557036,98.2504005 C93.6327211,97.2072607 93.5357985,95.8129426 92.6519757,94.929312 L92.4194452,94.7256304 L92.2814524,94.6292636 C91.2559413,93.958801 89.9434605,94.0841862 89.0981508,94.929312 L88.2694779,95.8865267 L88.2709299,83.9071528 L88.2537823,83.6239102 C88.0798969,82.3280784 87.0189866,81.3944109 85.7579045,81.3944109 L85.6102493,81.3986761 Z" fill="#FFFFFF" fill-rule="nonzero" />\n    <path d="M119.19437,64.568168 C117.875227,64.6445891 116.829,65.7383812 116.829,67.0765649 L116.828171,79.0775647 L116.007276,78.1396985 L115.923785,78.0567894 L115.736474,77.8951223 C114.693252,77.1183813 113.298912,77.2152632 112.41518,78.0988039 C111.472955,79.0408235 111.435266,80.5447972 112.302113,81.5317732 L113.127532,82.4082001 L113.79788,83.1088292 L114.222046,83.5455535 L115.017447,84.3469519 L115.569108,84.8856727 L115.916186,85.2154807 L116.247127,85.5220294 L116.562294,85.8055007 L116.86205,86.0660763 L117.146755,86.3039381 L117.416772,86.5192678 L117.672463,86.7122472 C117.713904,86.742558 117.754763,86.7719451 117.795048,86.8004123 L118.029928,86.9602072 C118.067946,86.9850099 118.105405,87.0089004 118.142312,87.0318823 L118.357194,87.1589016 C118.739228,87.3718936 119.056331,87.4758691 119.318535,87.4758691 C119.604411,87.4758691 119.95596,87.3521463 120.386557,87.0978042 L120.608505,86.9597164 C120.646615,86.9348769 120.685289,86.9091224 120.724535,86.8824489 L120.966942,86.711347 L121.223451,86.5179964 L121.494436,86.3022055 L121.780267,86.0637827 L122.081317,85.8025364 L122.397956,85.5182751 L122.902957,85.048311 L123.260196,84.705674 L123.634324,84.3393516 L124.025714,83.9491521 L124.645976,83.3186644 L125.307167,82.6333758 L126.254589,81.6332943 L126.439824,81.4198924 C127.216842,80.3767526 127.119919,78.9824344 126.236097,78.0988039 L126.003566,77.8951223 L125.865573,77.7987555 C124.840062,77.1282929 123.527581,77.253678 122.682272,78.0988039 L121.853084,79.0556476 L121.855051,67.0766447 L121.837903,66.793402 C121.664018,65.4975703 120.603107,64.5639027 119.342025,64.5639027 L119.19437,64.568168 Z" fill="#FFFFFF" fill-rule="nonzero" />\n    <path class="icon-solid" d="M131.082665,2.78352186 L130.63258,2.77876245 L130.04594,2.78476875 L129.631253,2.79856831 C119.668903,3.21862854 111.058196,10.1517308 108.242729,19.9677144 L108.126606,20.3867611 L107.866352,21.3860565 L107.144901,21.7553023 C102.290242,24.2865264 99.2419258,29.3589943 99.2419258,34.9102427 C99.2419258,42.9203015 105.51095,49.4694946 113.360597,49.6694667 L113.707334,49.674147 L151.971185,49.674147 C161.500259,49.674147 169.279921,41.9083152 169.482953,32.2489963 L169.486918,31.8805517 L169.481577,31.3890071 C169.247857,21.8479537 161.70285,14.1812674 152.369237,13.97544 L152.003836,13.9713132 L150.21156,13.978786 L149.65381,13.1150999 C145.451647,6.78278513 138.541865,2.93816977 131.082665,2.78352186 Z" fill="#000000" stroke="#FFFFFF" stroke-linecap="round" stroke-width="6" />\n  </g>\n</svg>\n'}),define("text!res/icons/menu-settings-fulfiller.svg",[],function(){return'<svg version="1.1" viewBox="0 0 176 143" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M65.2666224,28 L126.733378,28 C137.431602,28 141.311037,29.1139073 145.222148,31.2055924 C149.13326,33.2972776 152.202722,36.3667404 154.294408,40.2778516 C156.386093,44.1889627 157.5,48.0683975 157.5,58.7666224 L157.5,100.233378 C157.5,110.931602 156.386093,114.811037 154.294408,118.722148 C152.202722,122.63326 149.13326,125.702722 145.222148,127.794408 C141.311037,129.886093 137.431602,131 126.733378,131 L65.2666224,131 C54.5683975,131 50.6889627,129.886093 46.7778516,127.794408 C42.8667404,125.702722 39.7972776,122.63326 37.7055924,118.722148 C35.6139073,114.811037 34.5,110.931602 34.5,100.233378 L34.5,58.7666224 C34.5,48.0683975 35.6139073,44.1889627 37.7055924,40.2778516 C39.7972776,36.3667404 42.8667404,33.2972776 46.7778516,31.2055924 C50.6889627,29.1139073 54.5683975,28 65.2666224,28 Z" fill="#000000" opacity="0.2" />\n    <path d="M55.4207946,18.000267 L124.579205,18.000267 C133.940152,18.000267 137.334658,18.9749359 140.75688,20.8051604 C144.179102,22.6353849 146.864882,25.3211649 148.695107,28.7433871 C150.525331,32.1656094 151.5,35.5601149 151.5,44.9210616 L151.5,98.0792054 C151.5,107.440152 150.525331,110.834658 148.695107,114.25688 C146.864882,117.679102 144.179102,120.364882 140.75688,122.195107 C137.334658,124.025331 133.940152,125 124.579205,125 L55.4207946,125 C46.0598478,125 42.6653423,124.025331 39.2431201,122.195107 C35.8208979,120.364882 33.1351179,117.679102 31.3048934,114.25688 C29.4746689,110.834658 28.5,107.440152 28.5,98.0792054 L28.5,44.9210616 C28.5,35.5601149 29.4746689,32.1656094 31.3048934,28.7433871 C33.1351179,25.3211649 35.8208979,22.6353849 39.2431201,20.8051604 C42.6653423,18.9749359 46.0598478,18.000267 55.4207946,18.000267 Z" fill="#FFFFFF" />\n    <path class="icon-solid" d="M53.5749668,24 L122.425033,24 C130.448702,24 133.358278,24.8354305 136.291611,26.4041943 C139.224945,27.9729582 141.527042,30.2750553 143.095806,33.2083887 C144.664569,36.141722 145.5,39.0512981 145.5,47.0749668 L145.5,95.9250332 C145.5,103.948702 144.664569,106.858278 143.095806,109.791611 C141.527042,112.724945 139.224945,115.027042 136.291611,116.595806 C133.358278,118.164569 130.448702,119 122.425033,119 L53.5749668,119 C45.5512981,119 42.641722,118.164569 39.7083887,116.595806 C36.7750553,115.027042 34.4729582,112.724945 32.9041943,109.791611 C31.3354305,106.858278 30.5,103.948702 30.5,95.9250332 L30.5,47.0749668 C30.5,39.0512981 31.3354305,36.141722 32.9041943,33.2083887 C34.4729582,30.2750553 36.7750553,27.9729582 39.7083887,26.4041943 C42.641722,24.8354305 45.5512981,24 53.5749668,24 Z" fill="#000000" opacity="0.6" />\n    <path class="icon-solid" d="M148.5,-4.89920201 L148.5,48.0319645 C137.045533,35.950962 122.226434,26.2523496 105.5,21.8137256 L105.5,21.8137256 L105.5,-4.86494336 C106.573138,-4.31327019 107.526221,-3.83264483 108.261785,-3.46508448 L108.585476,-3.30362252 C109.354317,-2.92080333 109.813598,-2.69712063 109.813598,-2.69712063 L109.83569,-2.68637879 C110.172154,-2.52291046 114.299544,-0.522331917 118.610922,1.34768194 L118.610922,1.34768194 L119.290428,1.64062606 L119.962939,1.92680894 C123.005148,3.21229345 125.932007,4.46023161 127.111608,4.46023161 C128.396549,4.46023161 131.698042,3.00867883 134.969881,1.58466498 L134.969881,1.58466498 L135.649745,1.28689205 L136.319968,0.989874291 C140.448424,-0.849833042 144.170767,-2.68944991 144.170767,-2.68944991 C144.170767,-2.68944991 146.019274,-3.60299924 148.5,-4.89920201 L148.5,-4.89920201 Z" fill="#000000" stroke="#FFFFFF" stroke-width="6" />\n    <path d="M91.1059884,86.559829 C98.7793399,86.559829 106.916773,80.6275665 104.937443,76.4830969 C103.886711,74.3463361 98.11193,79.200643 91.1059884,79.2821891 C84.4348475,79.2305549 78.7199415,74.7912334 77.551163,76.4830969 C74.6687328,80.534387 83.6713054,86.559829 91.1059884,86.559829 Z" fill="#FFFFFF" />\n    <path d="M105.646857,66.1477318 C108.163267,65.1710034 111.749511,65.2634997 113.240436,66.6673087 C114.664115,68.0078005 115.139605,70.7297196 114.713357,73.6040461 C114.287108,76.4783726 112.153645,82.0203014 110.874715,81.630329 C110.022095,81.3703474 109.884454,78.36229 110.461794,72.606157 C110.50317,71.3570642 110.300749,70.5498805 109.921209,70.1925177 C109.455021,69.7535694 108.283991,69.6979811 106.417312,70.2012213 C101.835718,71.1848805 99.3761448,71.313876 99.0385938,70.5882076 C98.5322673,69.4997051 103.130446,67.1244603 105.646857,66.1477318 Z" fill="#FFFFFF" fill-rule="nonzero" />\n  </g>\n</svg>\n';
}),define("text!res/icons/menu-settings-language.svg",[],function(){return'<svg version="1.1" viewBox="0 0 176 143" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M65.2666224,28 L126.733378,28 C137.431602,28 141.311037,29.1139073 145.222148,31.2055924 C149.13326,33.2972776 152.202722,36.3667404 154.294408,40.2778516 C156.386093,44.1889627 157.5,48.0683975 157.5,58.7666224 L157.5,100.233378 C157.5,110.931602 156.386093,114.811037 154.294408,118.722148 C152.202722,122.63326 149.13326,125.702722 145.222148,127.794408 C141.311037,129.886093 137.431602,131 126.733378,131 L65.2666224,131 C54.5683975,131 50.6889627,129.886093 46.7778516,127.794408 C42.8667404,125.702722 39.7972776,122.63326 37.7055924,118.722148 C35.6139073,114.811037 34.5,110.931602 34.5,100.233378 L34.5,58.7666224 C34.5,48.0683975 35.6139073,44.1889627 37.7055924,40.2778516 C39.7972776,36.3667404 42.8667404,33.2972776 46.7778516,31.2055924 C50.6889627,29.1139073 54.5683975,28 65.2666224,28 Z" fill="#000000" opacity="0.2" />\n    <path d="M55.4207946,22 L124.579205,22 C133.940152,22 137.334658,22.9746689 140.75688,24.8048934 C144.179102,26.6351179 146.864882,29.3208979 148.695107,32.7431201 C150.525331,36.1653423 151.5,39.5598478 151.5,48.9207946 L151.5,98.0792054 C151.5,107.440152 150.525331,110.834658 148.695107,114.25688 C146.864882,117.679102 144.179102,120.364882 140.75688,122.195107 C137.334658,124.025331 133.940152,125 124.579205,125 L55.4207946,125 C46.0598478,125 42.6653423,124.025331 39.2431201,122.195107 C35.8208979,120.364882 33.1351179,117.679102 31.3048934,114.25688 C29.4746689,110.834658 28.5,107.440152 28.5,98.0792054 L28.5,48.9207946 C28.5,39.5598478 29.4746689,36.1653423 31.3048934,32.7431201 C33.1351179,29.3208979 35.8208979,26.6351179 39.2431201,24.8048934 C42.6653423,22.9746689 46.0598478,22 55.4207946,22 Z" fill="#FFFFFF" />\n    <path class="icon-solid" d="M53.5749668,24 L122.425033,24 C130.448702,24 133.358278,24.8354305 136.291611,26.4041943 C139.224945,27.9729582 141.527042,30.2750553 143.095806,33.2083887 C144.664569,36.141722 145.5,39.0512981 145.5,47.0749668 L145.5,95.9250332 C145.5,103.948702 144.664569,106.858278 143.095806,109.791611 C141.527042,112.724945 139.224945,115.027042 136.291611,116.595806 C133.358278,118.164569 130.448702,119 122.425033,119 L53.5749668,119 C45.5512981,119 42.641722,118.164569 39.7083887,116.595806 C36.7750553,115.027042 34.4729582,112.724945 32.9041943,109.791611 C31.3354305,106.858278 30.5,103.948702 30.5,95.9250332 L30.5,47.0749668 C30.5,39.0512981 31.3354305,36.141722 32.9041943,33.2083887 C34.4729582,30.2750553 36.7750553,27.9729582 39.7083887,26.4041943 C42.641722,24.8354305 45.5512981,24 53.5749668,24 Z" fill="#000000" opacity="0.6" />\n    <path class="icon-solid" d="M92.2853275,12.8820043 C103.390414,12.8820043 113.512604,17.0902844 121.144162,23.9991088 L63.4260014,23.9995538 C71.0576162,17.0904651 81.1800025,12.8820043 92.2853275,12.8820043 Z" fill="#000000" fill-rule="nonzero" opacity="0.6" />\n    <path d="M92.2853275,18.8820043 C71.8427745,18.8820043 55.270811,35.4539678 55.270811,55.8965208 L55.2774126,56.6013742 C55.4093557,63.6412105 57.5164298,70.412609 61.3576939,76.2398371 L61.7422669,76.8112248 L61.6524096,77.156727 L61.3521964,78.2014344 L61.0366972,79.2412464 L60.7786108,80.0563559 L59.3564401,84.4259639 L58.8500463,86.0272067 L58.4323318,87.4137141 L55.5595107,97.3848433 L65.0706298,94.0049312 L66.4119462,93.5037929 L67.9538014,92.902238 L73.3825554,90.7091889 L74.9395485,90.0982027 L76.3512107,89.5727933 L76.6699651,89.4614551 L76.9798167,89.6072927 C81.8167957,91.7962256 86.9893151,92.9110373 92.2853275,92.9110373 C112.72788,92.9110373 129.299844,76.3390738 129.299844,55.8965208 C129.299844,35.4539678 112.72788,18.8820043 92.2853275,18.8820043 Z" fill="#FFFFFF" fill-rule="nonzero" />\n    <circle class="icon-solid" cx="74.6688387" cy="57.6915836" fill="#000000" fill-rule="nonzero" r="5.48068539" />\n    <circle class="icon-solid" cx="92.2853275" cy="57.6915836" fill="#000000" fill-rule="nonzero" r="5.48068539" />\n    <circle class="icon-solid" cx="109.901816" cy="57.6915836" fill="#000000" fill-rule="nonzero" r="5.48068539" />\n  </g>\n</svg>\n'}),define("text!res/icons/menu-settings-navigation.svg",[],function(){return'<svg version="1.1" viewBox="0 0 176 143" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M65.2666224,28 L126.733378,28 C137.431602,28 141.311037,29.1139073 145.222148,31.2055924 C149.13326,33.2972776 152.202722,36.3667404 154.294408,40.2778516 C156.386093,44.1889627 157.5,48.0683975 157.5,58.7666224 L157.5,100.233378 C157.5,110.931602 156.386093,114.811037 154.294408,118.722148 C152.202722,122.63326 149.13326,125.702722 145.222148,127.794408 C141.311037,129.886093 137.431602,131 126.733378,131 L65.2666224,131 C54.5683975,131 50.6889627,129.886093 46.7778516,127.794408 C42.8667404,125.702722 39.7972776,122.63326 37.7055924,118.722148 C35.6139073,114.811037 34.5,110.931602 34.5,100.233378 L34.5,58.7666224 C34.5,48.0683975 35.6139073,44.1889627 37.7055924,40.2778516 C39.7972776,36.3667404 42.8667404,33.2972776 46.7778516,31.2055924 C50.6889627,29.1139073 54.5683975,28 65.2666224,28 Z" fill="#000000" opacity="0.2" />\n    <path d="M55.4207946,22 L124.579205,22 C133.940152,22 137.334658,22.9746689 140.75688,24.8048934 C144.179102,26.6351179 146.864882,29.3208979 148.695107,32.7431201 C150.525331,36.1653423 151.5,39.5598478 151.5,48.9207946 L151.5,98.0792054 C151.5,107.440152 150.525331,110.834658 148.695107,114.25688 C146.864882,117.679102 144.179102,120.364882 140.75688,122.195107 C137.334658,124.025331 133.940152,125 124.579205,125 L55.4207946,125 C46.0598478,125 42.6653423,124.025331 39.2431201,122.195107 C35.8208979,120.364882 33.1351179,117.679102 31.3048934,114.25688 C29.4746689,110.834658 28.5,107.440152 28.5,98.0792054 L28.5,48.9207946 C28.5,39.5598478 29.4746689,36.1653423 31.3048934,32.7431201 C33.1351179,29.3208979 35.8208979,26.6351179 39.2431201,24.8048934 C42.6653423,22.9746689 46.0598478,22 55.4207946,22 Z" fill="#FFFFFF" />\n    <path class="icon-solid" d="M53.5749668,24 L122.425033,24 C130.448702,24 133.358278,24.8354305 136.291611,26.4041943 C139.224945,27.9729582 141.527042,30.2750553 143.095806,33.2083887 C144.664569,36.141722 145.5,39.0512981 145.5,47.0749668 L145.5,95.9250332 C145.5,103.948702 144.664569,106.858278 143.095806,109.791611 C141.527042,112.724945 139.224945,115.027042 136.291611,116.595806 C133.358278,118.164569 130.448702,119 122.425033,119 L53.5749668,119 C45.5512981,119 42.641722,118.164569 39.7083887,116.595806 C36.7750553,115.027042 34.4729582,112.724945 32.9041943,109.791611 C31.3354305,106.858278 30.5,103.948702 30.5,95.9250332 L30.5,47.0749668 C30.5,39.0512981 31.3354305,36.141722 32.9041943,33.2083887 C34.4729582,30.2750553 36.7750553,27.9729582 39.7083887,26.4041943 C42.641722,24.8354305 45.5512981,24 53.5749668,24 Z" fill="#000000" opacity="0.6" />\n    <ellipse cx="88.5" cy="71.5" fill="#FFFFFF" rx="26.963964" ry="18.9321449" stroke="#FFFFFF" stroke-linecap="round" stroke-width="6" />\n    <path class="icon-solid" d="M97.2207207,37.4515766 L97.2207207,72.4728784 C94.1552082,75.7307633 91.1546594,77.0945946 88.3831301,77.0945946 C85.5626054,77.0945946 82.6354057,75.7065408 79.7792793,72.4007441 L79.7792793,72.4007441 L79.7792793,37.4515766 L97.2207207,37.4515766 Z" fill="#000000" stroke="#FFFFFF" stroke-linecap="round" stroke-width="6" />\n    <circle class="icon-solid" cx="88" cy="23" fill="#000000" r="24" stroke="#FFFFFF" stroke-linecap="round" stroke-width="6" />\n    <path d="M84.5749499,9.28253253 C85.5754478,9.28253253 86.3865115,10.0935963 86.3865115,11.0940941 C86.3865115,12.0945919 85.5754478,12.9056557 84.5749499,12.9056557 C80.7537085,12.9056557 77.6306306,16.1364258 77.6306306,20.1519019 C77.6306306,21.1523997 76.8195669,21.9634635 75.8190691,21.9634635 C74.8185712,21.9634635 74.0075075,21.1523997 74.0075075,20.1519019 C74.0075075,14.1623997 78.7247125,9.28253253 84.5749499,9.28253253 Z" fill="#FFFFFF" />\n  </g>\n</svg>\n'}),define("text!res/icons/menu-data-back-up.svg",[],function(){return'<svg version="1.1" viewBox="0 0 176 143" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M65.2666224,28 L126.733378,28 C137.431602,28 141.311037,29.1139073 145.222148,31.2055924 C149.13326,33.2972776 152.202722,36.3667404 154.294408,40.2778516 C156.386093,44.1889627 157.5,48.0683975 157.5,58.7666224 L157.5,100.233378 C157.5,110.931602 156.386093,114.811037 154.294408,118.722148 C152.202722,122.63326 149.13326,125.702722 145.222148,127.794408 C141.311037,129.886093 137.431602,131 126.733378,131 L65.2666224,131 C54.5683975,131 50.6889627,129.886093 46.7778516,127.794408 C42.8667404,125.702722 39.7972776,122.63326 37.7055924,118.722148 C35.6139073,114.811037 34.5,110.931602 34.5,100.233378 L34.5,58.7666224 C34.5,48.0683975 35.6139073,44.1889627 37.7055924,40.2778516 C39.7972776,36.3667404 42.8667404,33.2972776 46.7778516,31.2055924 C50.6889627,29.1139073 54.5683975,28 65.2666224,28 Z" fill="#000000" opacity="0.2" />\n    <path d="M55.4207946,22 L124.579205,22 C133.940152,22 137.334658,22.9746689 140.75688,24.8048934 C144.179102,26.6351179 146.864882,29.3208979 148.695107,32.7431201 C150.525331,36.1653423 151.5,39.5598478 151.5,48.9207946 L151.5,98.0792054 C151.5,107.440152 150.525331,110.834658 148.695107,114.25688 C146.864882,117.679102 144.179102,120.364882 140.75688,122.195107 C137.334658,124.025331 133.940152,125 124.579205,125 L55.4207946,125 C46.0598478,125 42.6653423,124.025331 39.2431201,122.195107 C35.8208979,120.364882 33.1351179,117.679102 31.3048934,114.25688 C29.4746689,110.834658 28.5,107.440152 28.5,98.0792054 L28.5,48.9207946 C28.5,39.5598478 29.4746689,36.1653423 31.3048934,32.7431201 C33.1351179,29.3208979 35.8208979,26.6351179 39.2431201,24.8048934 C42.6653423,22.9746689 46.0598478,22 55.4207946,22 Z" fill="#FFFFFF" />\n    <path class="icon-solid" d="M53.5749668,24 L122.425033,24 C130.448702,24 133.358278,24.8354305 136.291611,26.4041943 C139.224945,27.9729582 141.527042,30.2750553 143.095806,33.2083887 C144.664569,36.141722 145.5,39.0512981 145.5,47.0749668 L145.5,95.9250332 C145.5,103.948702 144.664569,106.858278 143.095806,109.791611 C141.527042,112.724945 139.224945,115.027042 136.291611,116.595806 C133.358278,118.164569 130.448702,119 122.425033,119 L53.5749668,119 C45.5512981,119 42.641722,118.164569 39.7083887,116.595806 C36.7750553,115.027042 34.4729582,112.724945 32.9041943,109.791611 C31.3354305,106.858278 30.5,103.948702 30.5,95.9250332 L30.5,47.0749668 C30.5,39.0512981 31.3354305,36.141722 32.9041943,33.2083887 C34.4729582,30.2750553 36.7750553,27.9729582 39.7083887,26.4041943 C42.641722,24.8354305 45.5512981,24 53.5749668,24 Z" fill="#000000" opacity="0.6" />\n    <path class="icon-dark-flip icon-solid" d="M89,49.2160647 C92.8659932,49.2160647 96.3659932,50.7830681 98.8994949,53.3165698 C101.432997,55.8500715 103,59.3500715 103,63.2160647 C103,65.8304407 102.282491,68.2770584 101.035511,70.3710699 C100.162478,71.8371261 99.0289848,73.1299921 97.6989129,74.1859342 L97.6989129,74.1859342 L101.285645,87.3948748 C101.651965,88.7439976 101.436765,90.1138793 100.792704,91.2380603 C100.148644,92.3622413 99.0757226,93.2407215 97.7265998,93.607041 C97.2941896,93.7244509 96.8481059,93.7839353 96.4000393,93.7839353 L96.4000393,93.7839353 L81.5999607,93.7839353 C80.2019899,93.7839353 78.9363649,93.2172957 78.0202326,92.3011634 C77.1041003,91.3850311 76.5374607,90.1194061 76.5374607,88.7214353 C76.5374607,88.2733687 76.5969451,87.827285 76.7143652,87.3948372 L76.7143652,87.3948372 L80.3010871,74.1859342 C78.9710152,73.1299921 77.8375224,71.8371261 76.9644889,70.3710699 C75.7175093,68.2770584 75,65.8304407 75,63.2160647 C75,59.3500715 76.5670034,55.8500715 79.1005051,53.3165698 C81.6340068,50.7830681 85.1340068,49.2160647 89,49.2160647 Z" fill="#000000" stroke="#FFFFFF" stroke-linecap="round" stroke-width="6" />\n  </g>\n</svg>\n'}),define("text!res/icons/menu-data-setup-code.svg",[],function(){return'<svg version="1.1" viewBox="0 0 176 143" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M65.2666224,28 L126.733378,28 C137.431602,28 141.311037,29.1139073 145.222148,31.2055924 C149.13326,33.2972776 152.202722,36.3667404 154.294408,40.2778516 C156.386093,44.1889627 157.5,48.0683975 157.5,58.7666224 L157.5,100.233378 C157.5,110.931602 156.386093,114.811037 154.294408,118.722148 C152.202722,122.63326 149.13326,125.702722 145.222148,127.794408 C141.311037,129.886093 137.431602,131 126.733378,131 L65.2666224,131 C54.5683975,131 50.6889627,129.886093 46.7778516,127.794408 C42.8667404,125.702722 39.7972776,122.63326 37.7055924,118.722148 C35.6139073,114.811037 34.5,110.931602 34.5,100.233378 L34.5,58.7666224 C34.5,48.0683975 35.6139073,44.1889627 37.7055924,40.2778516 C39.7972776,36.3667404 42.8667404,33.2972776 46.7778516,31.2055924 C50.6889627,29.1139073 54.5683975,28 65.2666224,28 Z" fill="#000000" opacity="0.2" />\n    <path d="M55.4207946,22 L124.579205,22 C133.940152,22 137.334658,22.9746689 140.75688,24.8048934 C144.179102,26.6351179 146.864882,29.3208979 148.695107,32.7431201 C150.525331,36.1653423 151.5,39.5598478 151.5,48.9207946 L151.5,98.0792054 C151.5,107.440152 150.525331,110.834658 148.695107,114.25688 C146.864882,117.679102 144.179102,120.364882 140.75688,122.195107 C137.334658,124.025331 133.940152,125 124.579205,125 L55.4207946,125 C46.0598478,125 42.6653423,124.025331 39.2431201,122.195107 C35.8208979,120.364882 33.1351179,117.679102 31.3048934,114.25688 C29.4746689,110.834658 28.5,107.440152 28.5,98.0792054 L28.5,48.9207946 C28.5,39.5598478 29.4746689,36.1653423 31.3048934,32.7431201 C33.1351179,29.3208979 35.8208979,26.6351179 39.2431201,24.8048934 C42.6653423,22.9746689 46.0598478,22 55.4207946,22 Z" fill="#FFFFFF" />\n    <path class="icon-solid" d="M53.5749668,24 L122.425033,24 C130.448702,24 133.358278,24.8354305 136.291611,26.4041943 C139.224945,27.9729582 141.527042,30.2750553 143.095806,33.2083887 C144.664569,36.141722 145.5,39.0512981 145.5,47.0749668 L145.5,95.9250332 C145.5,103.948702 144.664569,106.858278 143.095806,109.791611 C141.527042,112.724945 139.224945,115.027042 136.291611,116.595806 C133.358278,118.164569 130.448702,119 122.425033,119 L53.5749668,119 C45.5512981,119 42.641722,118.164569 39.7083887,116.595806 C36.7750553,115.027042 34.4729582,112.724945 32.9041943,109.791611 C31.3354305,106.858278 30.5,103.948702 30.5,95.9250332 L30.5,47.0749668 C30.5,39.0512981 31.3354305,36.141722 32.9041943,33.2083887 C34.4729582,30.2750553 36.7750553,27.9729582 39.7083887,26.4041943 C42.641722,24.8354305 45.5512981,24 53.5749668,24 Z" fill="#000000" opacity="0.6" />\n    <line class="icon-dark-flip icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="4" x1="61.3157666" x2="58.4149289" y1="71.3856328" y2="86.2543672" />\n    <line class="icon-dark-flip icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="4" x1="68.7501338" x2="65.8492961" y1="71.3856328" y2="86.2543672" />\n    <line class="icon-dark-flip icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="4" x1="71.742108" x2="56.8733736" y1="75.1028164" y2="75.1028164" />\n    <line class="icon-dark-flip icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="4" x1="70.2916891" x2="55.4229548" y1="82.5371836" y2="82.5371836" />\n    <line class="icon-dark-flip icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="4" x1="88.7332353" x2="85.8323976" y1="71.3856328" y2="86.2543672" />\n    <line class="icon-dark-flip icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="4" x1="96.1676024" x2="93.2667647" y1="71.3856328" y2="86.2543672" />\n    <line class="icon-dark-flip icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="4" x1="99.1595766" x2="84.2908423" y1="75.1028164" y2="75.1028164" />\n    <line class="icon-dark-flip icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="4" x1="97.7091577" x2="82.8404234" y1="82.5371836" y2="82.5371836" />\n    <line class="icon-dark-flip icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="4" x1="116.150704" x2="113.249866" y1="71.3856328" y2="86.2543672" />\n    <line class="icon-dark-flip icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="4" x1="123.585071" x2="120.684233" y1="71.3856328" y2="86.2543672" />\n    <line class="icon-dark-flip icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="4" x1="126.577045" x2="111.708311" y1="75.1028164" y2="75.1028164" />\n    <line class="icon-dark-flip icon-hollow" stroke="#000000" stroke-linecap="round" stroke-width="4" x1="125.126626" x2="110.257892" y1="82.5371836" y2="82.5371836" />\n    <line class="icon-dark-flip" stroke="#FFFFFF" stroke-linecap="round" stroke-width="3.5" x1="58.3157666" x2="55.4149289" y1="68.3856328" y2="83.2543672" />\n    <line class="icon-dark-flip" stroke="#FFFFFF" stroke-linecap="round" stroke-width="3.5" x1="65.7501338" x2="62.8492961" y1="68.3856328" y2="83.2543672" />\n    <line class="icon-dark-flip" stroke="#FFFFFF" stroke-linecap="round" stroke-width="3.5" x1="68.742108" x2="53.8733736" y1="72.1028164" y2="72.1028164" />\n    <line class="icon-dark-flip" stroke="#FFFFFF" stroke-linecap="round" stroke-width="3.5" x1="67.2916891" x2="52.4229548" y1="79.5371836" y2="79.5371836" />\n    <line class="icon-dark-flip" stroke="#FFFFFF" stroke-linecap="round" stroke-width="3.5" x1="85.7332353" x2="82.8323976" y1="68.3856328" y2="83.2543672" />\n    <line class="icon-dark-flip" stroke="#FFFFFF" stroke-linecap="round" stroke-width="3.5" x1="93.1676024" x2="90.2667647" y1="68.3856328" y2="83.2543672" />\n    <line class="icon-dark-flip" stroke="#FFFFFF" stroke-linecap="round" stroke-width="3.5" x1="96.1595766" x2="81.2908423" y1="72.1028164" y2="72.1028164" />\n    <line class="icon-dark-flip" stroke="#FFFFFF" stroke-linecap="round" stroke-width="3.5" x1="94.7091577" x2="79.8404234" y1="79.5371836" y2="79.5371836" />\n    <line class="icon-dark-flip" stroke="#FFFFFF" stroke-linecap="round" stroke-width="3.5" x1="113.150704" x2="110.249866" y1="68.3856328" y2="83.2543672" />\n    <line class="icon-dark-flip" stroke="#FFFFFF" stroke-linecap="round" stroke-width="3.5" x1="120.585071" x2="117.684233" y1="68.3856328" y2="83.2543672" />\n    <line class="icon-dark-flip" stroke="#FFFFFF" stroke-linecap="round" stroke-width="3.5" x1="123.577045" x2="108.708311" y1="72.1028164" y2="72.1028164" />\n    <line class="icon-dark-flip" stroke="#FFFFFF" stroke-linecap="round" stroke-width="3.5" x1="122.126626" x2="107.257892" y1="79.5371836" y2="79.5371836" />\n  </g>\n</svg>\n'}),define("text!res/icons/menu-data-reset.svg",[],function(){return'<svg version="1.1" viewBox="0 0 176 143" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M65.2666224,28 L126.733378,28 C137.431602,28 141.311037,29.1139073 145.222148,31.2055924 C149.13326,33.2972776 152.202722,36.3667404 154.294408,40.2778516 C156.386093,44.1889627 157.5,48.0683975 157.5,58.7666224 L157.5,100.233378 C157.5,110.931602 156.386093,114.811037 154.294408,118.722148 C152.202722,122.63326 149.13326,125.702722 145.222148,127.794408 C141.311037,129.886093 137.431602,131 126.733378,131 L65.2666224,131 C54.5683975,131 50.6889627,129.886093 46.7778516,127.794408 C42.8667404,125.702722 39.7972776,122.63326 37.7055924,118.722148 C35.6139073,114.811037 34.5,110.931602 34.5,100.233378 L34.5,58.7666224 C34.5,48.0683975 35.6139073,44.1889627 37.7055924,40.2778516 C39.7972776,36.3667404 42.8667404,33.2972776 46.7778516,31.2055924 C50.6889627,29.1139073 54.5683975,28 65.2666224,28 Z" fill="#000000" opacity="0.2" />\n    <path d="M55.4207946,22 L124.579205,22 C133.940152,22 137.334658,22.9746689 140.75688,24.8048934 C144.179102,26.6351179 146.864882,29.3208979 148.695107,32.7431201 C150.525331,36.1653423 151.5,39.5598478 151.5,48.9207946 L151.5,98.0792054 C151.5,107.440152 150.525331,110.834658 148.695107,114.25688 C146.864882,117.679102 144.179102,120.364882 140.75688,122.195107 C137.334658,124.025331 133.940152,125 124.579205,125 L55.4207946,125 C46.0598478,125 42.6653423,124.025331 39.2431201,122.195107 C35.8208979,120.364882 33.1351179,117.679102 31.3048934,114.25688 C29.4746689,110.834658 28.5,107.440152 28.5,98.0792054 L28.5,48.9207946 C28.5,39.5598478 29.4746689,36.1653423 31.3048934,32.7431201 C33.1351179,29.3208979 35.8208979,26.6351179 39.2431201,24.8048934 C42.6653423,22.9746689 46.0598478,22 55.4207946,22 Z" fill="#FFFFFF" />\n    <path class="icon-solid" d="M53.5749668,24 L122.425033,24 C130.448702,24 133.358278,24.8354305 136.291611,26.4041943 C139.224945,27.9729582 141.527042,30.2750553 143.095806,33.2083887 C144.664569,36.141722 145.5,39.0512981 145.5,47.0749668 L145.5,95.9250332 C145.5,103.948702 144.664569,106.858278 143.095806,109.791611 C141.527042,112.724945 139.224945,115.027042 136.291611,116.595806 C133.358278,118.164569 130.448702,119 122.425033,119 L53.5749668,119 C45.5512981,119 42.641722,118.164569 39.7083887,116.595806 C36.7750553,115.027042 34.4729582,112.724945 32.9041943,109.791611 C31.3354305,106.858278 30.5,103.948702 30.5,95.9250332 L30.5,47.0749668 C30.5,39.0512981 31.3354305,36.141722 32.9041943,33.2083887 C34.4729582,30.2750553 36.7750553,27.9729582 39.7083887,26.4041943 C42.641722,24.8354305 45.5512981,24 53.5749668,24 Z" fill="#000000" opacity="0.6" />\n    <path class="icon-dark-flip icon-solid" d="M107.82,82.3660116 L74.18,82.3660116 C72.0260895,82.3660116 70.28,84.1121011 70.28,86.2660116 L70.28,88.5860116 C70.28,90.7399221 72.0260895,92.4860116 74.18,92.4860116 L107.82,92.4860116 C109.973911,92.4860116 111.72,90.7399221 111.72,88.5860116 L111.72,86.2660116 C111.72,84.1121011 109.973911,82.3660116 107.82,82.3660116 Z" fill="#000000" fill-rule="nonzero" />\n    <path class="icon-dark-flip icon-solid" d="M91.0000296,48.5139884 C90.6159986,48.5139884 90.1795209,48.6211816 89.6887752,48.8365924 L89.4157028,48.9648277 L89.1318008,49.1145646 C88.9389083,49.2215647 88.7387524,49.3429237 88.5312453,49.4786911 L88.2144604,49.6931544 C88.1607404,49.7307014 88.1065582,49.7691505 88.0519124,49.8085023 L87.7184644,50.0554537 L87.3738255,50.3241098 L87.0179301,50.6145076 L86.6507125,50.9266842 C86.5885623,50.9805306 86.5259377,51.0352859 86.4628373,51.090951 L86.0785131,51.4358649 L85.6827025,51.8026498 L85.2753399,52.1913427 L84.8563594,52.6019806 L84.4256954,53.0346003 L83.7576492,53.7248268 L83.0629457,54.4647204 L82.5848909,54.9856371 L82.0948242,55.5287205 L81.3370582,56.3849887 L80.8166745,56.9836503 L80.0131249,57.923459 L79.1818096,58.9135582 L78.0298149,60.3121357 L77.1328508,61.4200643 L76.207382,62.5786991 L74.9286999,64.2026372 L73.9358581,65.4800713 L72.5665407,67.262861 L71.1447092,69.1368294 C69.6545529,71.1119959 70.0477422,73.9211998 72.0229198,75.411351 C72.8002091,75.9977684 73.7473886,76.3149874 74.7210745,76.3149874 L107.278929,76.3149874 C109.753166,76.3149874 111.758941,74.3092338 111.758941,71.8349874 C111.758941,70.8613028 111.441724,69.9141245 110.855308,69.1368353 L109.43348,67.2628663 L108.064167,65.4800761 L107.071328,64.2026417 L105.792649,62.5787031 L104.867183,61.420068 L104.266055,60.6758224 L103.101542,59.2547915 L102.538026,58.5779324 L101.448146,57.2913422 L100.662986,56.384991 L99.9052214,55.5287225 L99.4151558,54.9856389 L98.9371021,54.464722 L98.2424001,53.7248283 L97.7940887,53.2591663 L97.3575592,52.8155416 L96.9327461,52.3939173 L96.5195835,51.9942564 L96.1180058,51.616522 L95.7279474,51.2606772 C95.6638939,51.2031918 95.6003177,51.1466169 95.5372174,51.0909518 L95.1643146,50.7678719 L94.8027669,50.4665892 L94.4525085,50.1870668 C94.3950692,50.142291 94.3380976,50.0984204 94.2815922,50.0554541 L93.9481447,49.8085027 L93.6258223,49.5832192 C93.5730253,49.5474755 93.5206892,49.5126332 93.4688125,49.4786913 L93.1630546,49.2858403 L92.8682576,49.1145648 L92.5843558,48.9648279 L92.3112836,48.8365925 C91.8205382,48.6211816 91.3840607,48.5139884 91.0000296,48.5139884 Z" fill="#000000" fill-rule="nonzero" />\n    <path class="icon-dark-flip" d="M104.82,80.3660116 L71.18,80.3660116 C69.5783742,80.3660116 68.28,81.6643858 68.28,83.2660116 L68.28,85.5860116 C68.28,87.1876374 69.5783742,88.4860116 71.18,88.4860116 L104.82,88.4860116 C106.421626,88.4860116 107.72,87.1876374 107.72,85.5860116 L107.72,83.2660116 C107.72,81.6643858 106.421626,80.3660116 104.82,80.3660116 Z" fill="#FFFFFF" fill-rule="nonzero" />\n    <path class="icon-dark-flip" d="M88.0000296,46.5139884 C85.4677536,46.5139884 79.1154121,53.2556906 68.943005,66.7390949 C67.7854707,68.2733789 68.0908962,70.4555275 69.6251853,71.6130551 C70.2289729,72.0685761 70.9647288,72.3149874 71.7210745,72.3149874 L104.278929,72.3149874 C106.200887,72.3150002 107.758941,70.7569454 107.758941,68.8349874 C107.758941,68.0786425 107.512531,67.3428873 107.057011,66.7390996 C96.8846331,53.2556921 90.5323058,46.5139884 88.0000296,46.5139884 Z" fill="#FFFFFF" fill-rule="nonzero" />\n  </g>\n</svg>\n'}),define("text!res/icons/menu-help-contact-library.svg",[],function(){return'<svg version="1.1" viewBox="0 0 176 143" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M65.2666224,28 L126.733378,28 C137.431602,28 141.311037,29.1139073 145.222148,31.2055924 C149.13326,33.2972776 152.202722,36.3667404 154.294408,40.2778516 C156.386093,44.1889627 157.5,48.0683975 157.5,58.7666224 L157.5,100.233378 C157.5,110.931602 156.386093,114.811037 154.294408,118.722148 C152.202722,122.63326 149.13326,125.702722 145.222148,127.794408 C141.311037,129.886093 137.431602,131 126.733378,131 L65.2666224,131 C54.5683975,131 50.6889627,129.886093 46.7778516,127.794408 C42.8667404,125.702722 39.7972776,122.63326 37.7055924,118.722148 C35.6139073,114.811037 34.5,110.931602 34.5,100.233378 L34.5,58.7666224 C34.5,48.0683975 35.6139073,44.1889627 37.7055924,40.2778516 C39.7972776,36.3667404 42.8667404,33.2972776 46.7778516,31.2055924 C50.6889627,29.1139073 54.5683975,28 65.2666224,28 Z" fill="#000000" opacity="0.2" />\n    <path d="M55.4207946,22 L124.579205,22 C133.940152,22 137.334658,22.9746689 140.75688,24.8048934 C144.179102,26.6351179 146.864882,29.3208979 148.695107,32.7431201 C150.525331,36.1653423 151.5,39.5598478 151.5,48.9207946 L151.5,98.0792054 C151.5,107.440152 150.525331,110.834658 148.695107,114.25688 C146.864882,117.679102 144.179102,120.364882 140.75688,122.195107 C137.334658,124.025331 133.940152,125 124.579205,125 L55.4207946,125 C46.0598478,125 42.6653423,124.025331 39.2431201,122.195107 C35.8208979,120.364882 33.1351179,117.679102 31.3048934,114.25688 C29.4746689,110.834658 28.5,107.440152 28.5,98.0792054 L28.5,48.9207946 C28.5,39.5598478 29.4746689,36.1653423 31.3048934,32.7431201 C33.1351179,29.3208979 35.8208979,26.6351179 39.2431201,24.8048934 C42.6653423,22.9746689 46.0598478,22 55.4207946,22 Z" fill="#FFFFFF" />\n    <path class="icon-solid" d="M53.5749668,24 L122.425033,24 C130.448702,24 133.358278,24.8354305 136.291611,26.4041943 C139.224945,27.9729582 141.527042,30.2750553 143.095806,33.2083887 C144.664569,36.141722 145.5,39.0512981 145.5,47.0749668 L145.5,95.9250332 C145.5,103.948702 144.664569,106.858278 143.095806,109.791611 C141.527042,112.724945 139.224945,115.027042 136.291611,116.595806 C133.358278,118.164569 130.448702,119 122.425033,119 L53.5749668,119 C45.5512981,119 42.641722,118.164569 39.7083887,116.595806 C36.7750553,115.027042 34.4729582,112.724945 32.9041943,109.791611 C31.3354305,106.858278 30.5,103.948702 30.5,95.9250332 L30.5,47.0749668 C30.5,39.0512981 31.3354305,36.141722 32.9041943,33.2083887 C34.4729582,30.2750553 36.7750553,27.9729582 39.7083887,26.4041943 C42.641722,24.8354305 45.5512981,24 53.5749668,24 Z" fill="#000000" opacity="0.6" />\n    <path d="M71.6474655,80.008347 L71.9451027,80.4231135 L72.7362779,81.5062515 L73.4388875,82.4457635 L74.061476,83.2600492 L74.879483,84.304401 L75.2992959,84.829678 L76.2355935,85.9755181 L76.8437298,86.7013558 L77.7016192,87.7018474 L78.41945,88.5180867 L79.0520468,89.2222049 L79.6854429,89.9131315 L80.5509241,90.8349286 L81.2702261,91.5814711 L81.9038004,92.2247161 L82.8758671,93.1857169 L83.4841661,93.770962 L84.2362449,94.4777859 L85.0558225,95.2265467 L85.3948353,95.5298655 L85.9929231,96.0552276 L86.6418772,96.6118234 L86.9533613,96.8738444 L86.9533613,96.8738444 L87.5425033,97.3600692 L88.4959902,98.121542 L89.0744436,98.5673465 L89.681884,99.0223941 L90.2862091,99.4612936 C95.0806758,102.881055 99.5955965,104.516022 103.657798,104.139325 L103.911969,104.115755 L104.16322,104.070683 C112.529026,102.569924 118.324324,97.6921856 119.777549,90.058731 C119.939601,89.2114192 119.97165,88.4105468 119.905165,87.5237971 L119.88116,87.2585168 C119.856634,87.0362205 119.822848,86.8238413 119.780745,86.6104498 L119.716505,86.3084945 C119.692931,86.207468 119.667062,86.1057145 119.638491,86.0021768 L119.574804,85.7841889 C118.728073,82.9520128 116.399386,79.8834756 113.405631,77.2917837 C110.795493,75.0309656 107.887532,73.3277657 105.257492,72.6380359 L104.954131,72.5612598 L104.84669,72.5362155 C104.282916,72.4102539 103.724056,72.331151 103.160865,72.3108279 L101.851973,72.2635957 L98.952627,73.4681786 L98.7332559,73.5812701 C98.057552,73.929613 97.4077747,74.2489302 96.7993596,74.5309787 L96.1338053,74.8323217 L95.4955874,75.1110358 L95.1813734,75.2439214 L94.3900614,74.3464389 C92.9599319,72.7012214 91.5775881,70.9901309 90.2586974,69.2293186 L89.5309025,68.2436976 C88.3292919,66.5931084 87.1847956,64.9034911 86.1005705,63.1809917 L85.8852918,62.8351582 L86.7581579,61.7176812 L86.93892,61.5072756 L86.93892,61.5072756 L87.4839864,60.8938432 L87.4839864,60.8938432 L88.0699087,60.2569658 L88.0699087,60.2569658 L88.6340585,59.6532599 L89.5278922,58.6003893 L90.4426512,57.513972 L90.8025411,56.3616087 C91.0429173,55.5919268 91.1580519,54.8000743 91.1894439,53.9692448 L91.1917927,53.8574875 C91.2660508,51.2427595 90.5143939,48.124174 89.180897,45.0955071 L89.0335879,44.7668723 C87.3672196,41.1191419 85.0742611,38.0273806 82.5669592,36.3991218 L82.4227368,36.3054627 L81.9597116,36.0411804 L81.8461683,35.9826338 C81.0527503,35.5735216 79.5704448,35.1258394 78.5498347,35.0275091 C70.6510788,34.2582034 64.4613296,38.2790308 60.4494831,46.2455619 C58.4596489,50.3236342 59.1187536,55.6610178 61.6069368,62.0669584 L61.9659134,62.9677264 C62.0894742,63.2702812 62.2169094,63.5751285 62.3481364,63.882249 L62.6445089,64.5639435 L62.9852369,65.3219259 L63.4357579,66.2861646 L63.6767863,66.7868132 L64.0277075,67.4980652 L64.4070913,68.2463673 L65.0159715,69.4073185 L65.4134298,70.1410405 L65.8389126,70.9079291 L66.4408134,71.9628445 L66.959322,72.8456931 L67.2005169,73.2490347 L67.9283571,74.4392514 L68.4094012,75.2052689 L68.933158,76.0224126 L69.4391866,76.7957511 L69.9878973,77.6178956 C70.0783773,77.7520958 70.168744,77.8854501 70.2595564,78.0188074 L71.0924998,79.2242054 L71.6474655,80.008347 Z" fill="#FFFFFF" fill-rule="nonzero" />\n    <path class="icon-solid" d="M101.987973,77.4673508 C101.807139,76.4815341 101.603622,75.4945622 101.380329,74.5655601 L100.500892,71.4980744 L100.377246,71.189158 C99.8328051,69.8981592 99.167815,69.2212918 98.0611958,68.9567613 L97.9158069,68.922007 L97.7669742,68.9080555 C94.3484822,68.5876076 90.8663673,68.4453793 87.3500493,68.496402 C84.1961364,68.5423188 81.0742514,68.7431173 78.0030923,69.0873927 L76.8517851,69.2233634 L76.7252324,69.2550776 C75.5211073,69.5568319 74.8562224,70.3312886 74.3266887,71.8448044 L74.2151417,72.1805385 L74.1068549,72.5394792 L74.0009453,72.922209 L73.8965297,73.3293103 C73.8792025,73.3992238 73.8619008,73.4701771 73.8446061,73.5421822 L73.7407756,73.9869328 L73.5834152,74.7026673 C73.5657311,74.7854946 73.5479621,74.8694344 73.5300897,74.954499 C73.3330673,75.8922372 73.1575914,76.8884016 73.0048454,77.8833808 L72.6369313,79.4231063 C72.5362807,79.5516247 72.3966472,79.6971511 72.2191474,79.8536684 L72.1738455,79.892158 L72.0629164,79.9837467 C70.7802673,81.033772 68.5376715,82.0367702 65.9476247,82.6395856 C63.0258141,83.320441 60.290892,83.3446872 58.8011675,82.821387 C58.7035419,82.7889769 58.6347591,82.7609725 58.5435267,82.7182679 C58.4905236,82.6937336 58.4481629,82.6720616 58.4129368,82.6519657 L58.36501,82.6228431 C58.0329127,82.4176378 57.8134381,82.2443115 57.6075859,82.0248931 C54.0701394,78.2606938 53.837408,73.3344295 56.477818,67.8797149 C57.6075859,65.9771186 60.2032586,63.9985177 64.8232623,62.4524614 L65.4484219,62.248593 L66.0916046,62.049391 L66.7523677,61.8550376 C66.8639354,61.8230595 66.9762171,61.7912911 67.0892036,61.7597361 L67.7755073,61.5729973 L68.4782847,61.3915626 C68.8337181,61.3022018 69.1951631,61.2148983 69.5623707,61.1297547 L70.3043956,60.9623779 C70.4293224,60.9349719 70.554871,60.9078134 70.6810323,60.8809063 L71.4452776,60.7225109 C71.5738525,60.6966245 71.7030216,60.6709971 71.8327756,60.6456325 L72.6182453,60.4966284 L73.4173113,60.3541131 C73.5515973,60.3309114 73.6864315,60.3079876 73.8218045,60.2853456 L74.6404347,60.1529051 L75.4715545,60.0274088 L76.3147211,59.9090391 C76.4562282,59.8899149 76.5982188,59.8710951 76.7406837,59.8525837 L77.6010905,59.7452455 L78.4724374,59.6454895 L79.3542818,59.5534978 L80.2461809,59.4694528 C80.395644,59.4561176 80.5455077,59.4431211 80.6957626,59.4304672 L81.6019137,59.3586837 L82.5170129,59.2953025 C82.6702505,59.2854493 82.8238425,59.2759537 82.9777797,59.2668197 L83.9054708,59.2163834 C84.2160327,59.2010375 84.5279014,59.1871679 84.8410033,59.1748049 L85.7839344,59.1422665 C86.0994286,59.1329473 86.4160822,59.1251651 86.7338214,59.1189503 L87.211235,59.1108075 C87.5307579,59.1061585 87.8489733,59.102957 88.1658243,59.1011819 L89.1122272,59.1001149 C89.2692599,59.1006433 89.4259372,59.101523 89.5822521,59.1027515 L90.5157353,59.1142856 C90.6705719,59.1168984 90.825032,59.1198546 90.9791082,59.1231517 L91.8989033,59.1470028 C92.3564412,59.1609522 92.8103971,59.1779217 93.2605789,59.1978401 L94.1558533,59.241588 C94.4525628,59.2574672 94.747538,59.2746361 95.040722,59.2930735 L95.9148434,59.3521703 C96.0596157,59.3626471 96.203926,59.3734357 96.3477671,59.3845335 L97.2051274,59.4548106 C97.3470635,59.4671349 97.4885163,59.4797632 97.6294785,59.4926929 L98.4693094,59.5738659 C98.6082813,59.5879905 98.7467485,59.6024111 98.8847038,59.6171252 L99.7062371,59.7089101 L100.515145,59.8076117 L101.311086,59.9131037 C101.442644,59.9312445 101.573647,59.949663 101.704088,59.9683566 L102.479939,60.0837973 L103.24197,60.2057126 L103.989839,60.3339763 C104.23673,60.3777749 104.481204,60.4226104 104.723205,60.4684619 L105.441726,60.6090433 C105.678721,60.6569057 105.913185,60.7057629 106.145061,60.7555941 L106.832868,60.9079879 C112.838915,62.2795687 116.987624,64.3202522 118.21995,66.6382927 C121.257006,72.5298608 120.976872,77.2247383 117.496019,81.1504487 C117.294214,81.3785226 116.655563,81.8352251 116.58123,81.8726475 L116.368459,81.9686436 C114.851938,82.5507822 112.117951,82.6059777 109.178298,82.0107818 L108.867256,81.9456196 C106.392403,81.4088867 104.248893,80.5058468 102.988096,79.5339642 L102.943445,79.5009197 C102.667264,79.2838683 102.465317,79.0837462 102.341324,78.9171305 C102.116279,78.0079734 101.998495,77.5247135 101.987973,77.4673508 Z" fill="#000000" fill-rule="nonzero" transform="translate(87.507228, 71.142737) rotate(-126.000000) translate(-87.507228, -71.142737) " />\n  </g>\n</svg>\n';
}),define("text!res/icons/menu-help-survey.svg",[],function(){return'<svg version="1.1" viewBox="0 0 176 143" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M65.2666224,28 L126.733378,28 C137.431602,28 141.311037,29.1139073 145.222148,31.2055924 C149.13326,33.2972776 152.202722,36.3667404 154.294408,40.2778516 C156.386093,44.1889627 157.5,48.0683975 157.5,58.7666224 L157.5,100.233378 C157.5,110.931602 156.386093,114.811037 154.294408,118.722148 C152.202722,122.63326 149.13326,125.702722 145.222148,127.794408 C141.311037,129.886093 137.431602,131 126.733378,131 L65.2666224,131 C54.5683975,131 50.6889627,129.886093 46.7778516,127.794408 C42.8667404,125.702722 39.7972776,122.63326 37.7055924,118.722148 C35.6139073,114.811037 34.5,110.931602 34.5,100.233378 L34.5,58.7666224 C34.5,48.0683975 35.6139073,44.1889627 37.7055924,40.2778516 C39.7972776,36.3667404 42.8667404,33.2972776 46.7778516,31.2055924 C50.6889627,29.1139073 54.5683975,28 65.2666224,28 Z" fill="#000000" opacity="0.2" />\n    <path d="M55.4207946,22 L124.579205,22 C133.940152,22 137.334658,22.9746689 140.75688,24.8048934 C144.179102,26.6351179 146.864882,29.3208979 148.695107,32.7431201 C150.525331,36.1653423 151.5,39.5598478 151.5,48.9207946 L151.5,98.0792054 C151.5,107.440152 150.525331,110.834658 148.695107,114.25688 C146.864882,117.679102 144.179102,120.364882 140.75688,122.195107 C137.334658,124.025331 133.940152,125 124.579205,125 L55.4207946,125 C46.0598478,125 42.6653423,124.025331 39.2431201,122.195107 C35.8208979,120.364882 33.1351179,117.679102 31.3048934,114.25688 C29.4746689,110.834658 28.5,107.440152 28.5,98.0792054 L28.5,48.9207946 C28.5,39.5598478 29.4746689,36.1653423 31.3048934,32.7431201 C33.1351179,29.3208979 35.8208979,26.6351179 39.2431201,24.8048934 C42.6653423,22.9746689 46.0598478,22 55.4207946,22 Z" fill="#FFFFFF" />\n    <path class="icon-solid" d="M53.5749668,24 L122.425033,24 C130.448702,24 133.358278,24.8354305 136.291611,26.4041943 C139.224945,27.9729582 141.527042,30.2750553 143.095806,33.2083887 C144.664569,36.141722 145.5,39.0512981 145.5,47.0749668 L145.5,95.9250332 C145.5,103.948702 144.664569,106.858278 143.095806,109.791611 C141.527042,112.724945 139.224945,115.027042 136.291611,116.595806 C133.358278,118.164569 130.448702,119 122.425033,119 L53.5749668,119 C45.5512981,119 42.641722,118.164569 39.7083887,116.595806 C36.7750553,115.027042 34.4729582,112.724945 32.9041943,109.791611 C31.3354305,106.858278 30.5,103.948702 30.5,95.9250332 L30.5,47.0749668 C30.5,39.0512981 31.3354305,36.141722 32.9041943,33.2083887 C34.4729582,30.2750553 36.7750553,27.9729582 39.7083887,26.4041943 C42.641722,24.8354305 45.5512981,24 53.5749668,24 Z" fill="#000000" opacity="0.6" />\n    <path class="icon-dark-flip icon-solid" d="M118,47 C120.103941,47 122.026846,47.9186647 123.411863,49.4575719 C124.688451,50.8760029 125.5,52.8297671 125.5,55 C125.5,57.1008626 124.739421,58.9994601 123.532676,60.4049928 C122.200645,61.9564509 120.333427,62.9138517 118.278774,62.9945518 L118.278774,62.9945518 L58,63 C55.8960589,63 53.9731536,62.0813353 52.588137,60.5424281 C51.3115491,59.1239971 50.5,57.1702329 50.5,55 C50.5,52.8991374 51.2605793,51.0005399 52.4673238,49.5950072 C53.7993551,48.0435491 55.6665726,47.0861483 57.7212262,47.0054482 L57.7212262,47.0054482 Z" fill="#000000" fill-rule="nonzero" stroke="#FFFFFF" stroke-width="6" />\n    <path class="icon-dark-flip icon-solid" d="M67.75,6 L108.25,6 C112.115993,6 115.25,9.13400675 115.25,13 L115.25,50 L115.25,50 L60.75,50 L60.75,13 C60.75,9.13400675 63.8840068,6 67.75,6 Z" fill="#000000" />\n    <path class="icon-dark-flip" d="M69,12 L107,12 C108.656854,12 110,13.3431458 110,15 L110,56 L110,56 L66,56 L66,15 C66,13.3431458 67.3431458,12 69,12 Z" fill="#FFFFFF" />\n    <path class="icon-dark-flip icon-hollow" d="M98,26.6659782 L84.3815899,41.0606073 C84.2338094,41.2166546 83.9926738,41.2376114 83.8202527,41.1093119 C81.0085323,39.0170942 79.068448,37.4395973 78,36.3768209" stroke="#000000" stroke-linecap="round" stroke-width="5" />\n  </g>\n</svg>\n'}),define("text!res/icons/menu-help-feedback.svg",[],function(){return'<svg version="1.1" viewBox="0 0 176 143" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M65.2666224,28 L126.733378,28 C137.431602,28 141.311037,29.1139073 145.222148,31.2055924 C149.13326,33.2972776 152.202722,36.3667404 154.294408,40.2778516 C156.386093,44.1889627 157.5,48.0683975 157.5,58.7666224 L157.5,100.233378 C157.5,110.931602 156.386093,114.811037 154.294408,118.722148 C152.202722,122.63326 149.13326,125.702722 145.222148,127.794408 C141.311037,129.886093 137.431602,131 126.733378,131 L65.2666224,131 C54.5683975,131 50.6889627,129.886093 46.7778516,127.794408 C42.8667404,125.702722 39.7972776,122.63326 37.7055924,118.722148 C35.6139073,114.811037 34.5,110.931602 34.5,100.233378 L34.5,58.7666224 C34.5,48.0683975 35.6139073,44.1889627 37.7055924,40.2778516 C39.7972776,36.3667404 42.8667404,33.2972776 46.7778516,31.2055924 C50.6889627,29.1139073 54.5683975,28 65.2666224,28 Z" fill="#000000" opacity="0.2" />\n    <path d="M55.4207946,22 L124.579205,22 C133.940152,22 137.334658,22.9746689 140.75688,24.8048934 C144.179102,26.6351179 146.864882,29.3208979 148.695107,32.7431201 C150.525331,36.1653423 151.5,39.5598478 151.5,48.9207946 L151.5,98.0792054 C151.5,107.440152 150.525331,110.834658 148.695107,114.25688 C146.864882,117.679102 144.179102,120.364882 140.75688,122.195107 C137.334658,124.025331 133.940152,125 124.579205,125 L55.4207946,125 C46.0598478,125 42.6653423,124.025331 39.2431201,122.195107 C35.8208979,120.364882 33.1351179,117.679102 31.3048934,114.25688 C29.4746689,110.834658 28.5,107.440152 28.5,98.0792054 L28.5,48.9207946 C28.5,39.5598478 29.4746689,36.1653423 31.3048934,32.7431201 C33.1351179,29.3208979 35.8208979,26.6351179 39.2431201,24.8048934 C42.6653423,22.9746689 46.0598478,22 55.4207946,22 Z" fill="#FFFFFF" />\n    <path class="icon-solid" d="M53.5749668,24 L122.425033,24 C130.448702,24 133.358278,24.8354305 136.291611,26.4041943 C139.224945,27.9729582 141.527042,30.2750553 143.095806,33.2083887 C144.664569,36.141722 145.5,39.0512981 145.5,47.0749668 L145.5,95.9250332 C145.5,103.948702 144.664569,106.858278 143.095806,109.791611 C141.527042,112.724945 139.224945,115.027042 136.291611,116.595806 C133.358278,118.164569 130.448702,119 122.425033,119 L53.5749668,119 C45.5512981,119 42.641722,118.164569 39.7083887,116.595806 C36.7750553,115.027042 34.4729582,112.724945 32.9041943,109.791611 C31.3354305,106.858278 30.5,103.948702 30.5,95.9250332 L30.5,47.0749668 C30.5,39.0512981 31.3354305,36.141722 32.9041943,33.2083887 C34.4729582,30.2750553 36.7750553,27.9729582 39.7083887,26.4041943 C42.641722,24.8354305 45.5512981,24 53.5749668,24 Z" fill="#000000" opacity="0.6" />\n    <path class="icon-dark-flip icon-solid" d="M118,47 C120.103941,47 122.026846,47.9186647 123.411863,49.4575719 C124.688451,50.8760029 125.5,52.8297671 125.5,55 C125.5,57.1008626 124.739421,58.9994601 123.532676,60.4049928 C122.200645,61.9564509 120.333427,62.9138517 118.278774,62.9945518 L118.278774,62.9945518 L58,63 C55.8960589,63 53.9731536,62.0813353 52.588137,60.5424281 C51.3115491,59.1239971 50.5,57.1702329 50.5,55 C50.5,52.8991374 51.2605793,51.0005399 52.4673238,49.5950072 C53.7993551,48.0435491 55.6665726,47.0861483 57.7212262,47.0054482 L57.7212262,47.0054482 Z" fill="#000000" fill-rule="nonzero" stroke="#FFFFFF" stroke-width="6" />\n    <path class="icon-dark-flip icon-solid" d="M67.75,6 L108.25,6 C112.115993,6 115.25,9.13400675 115.25,13 L115.25,50 L115.25,50 L60.75,50 L60.75,13 C60.75,9.13400675 63.8840068,6 67.75,6 Z" fill="#000000" />\n    <path class="icon-dark-flip" d="M69,12 L107,12 C108.656854,12 110,13.3431458 110,15 L110,56 L110,56 L66,56 L66,15 C66,13.3431458 67.3431458,12 69,12 Z" fill="#FFFFFF" />\n    <path class="icon-dark-flip icon-solid" d="M87.9318815,44.9348022 C91.6310917,44.9348022 95.5540286,42.0749455 94.5998227,40.0769575 C94.0932804,39.0468565 91.3093432,41.3870466 87.9318815,41.4263588 C84.7158224,41.4014667 81.9607501,39.261335 81.3972992,40.0769575 C80.0077218,42.030025 84.34773,44.9348022 87.9318815,44.9348022 Z" fill="#000000" transform="translate(87.938308, 42.375012) scale(1, -1) translate(-87.938308, -42.375012) " />\n    <ellipse class="icon-dark-flip icon-solid" cx="81.4383076" cy="31.7810587" fill="#000000" rx="3.5" ry="5" />\n    <ellipse class="icon-dark-flip icon-solid" cx="94.4383076" cy="31.7810587" fill="#000000" rx="3.5" ry="5" />\n    <path class="icon-dark-flip icon-solid" d="M74.0162085,23.1400221 C74.3076543,22.7096168 77.3059573,24.1360491 83.0111175,27.4193189 C83.6970759,27.8838106 83.8766102,28.8164347 83.4121185,29.5023931 C82.9749498,30.1480011 82.1231033,30.3450118 81.4525108,29.9787059 L81.3290443,29.9033941 C76.1441593,25.8517851 73.7065474,23.5973277 74.0162085,23.1400221 Z" fill="#000000" fill-rule="nonzero" />\n    <path class="icon-dark-flip icon-solid" d="M92.0620663,23.1627868 C92.3456234,22.7271439 95.4342901,24.1409498 101.328066,27.4042045 C102.022372,27.8561236 102.218866,28.7853225 101.766947,29.4796284 C101.341611,30.1330927 100.493495,30.3455882 99.8163406,29.9915587 L99.6915227,29.9185085 C94.3039391,25.8775647 91.760787,23.6256574 92.0620663,23.1627868 Z" fill="#000000" fill-rule="nonzero" transform="translate(97.024051, 26.623678) scale(-1, 1) translate(-97.024051, -26.623678) " />\n  </g>\n</svg>\n'}),define("text!res/icons/notif-actions.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M32,12.78 C42.6149129,12.78 51.22,21.3850871 51.22,32 C51.22,42.6149129 42.6149129,51.22 32,51.22 C21.3850871,51.22 12.78,42.6149129 12.78,32 C12.78,21.3850871 21.3850871,12.78 32,12.78 Z M36.7836269,21.1437686 L30.0842926,21.1437686 C29.956756,21.1383169 29.8418754,21.2198988 29.8050739,21.3419872 L26.1762179,33.2976073 C26.149932,33.384255 26.1672611,33.4782999 26.2227539,33.5497594 C26.2782477,33.6214134 26.3648954,33.6615247 26.4554361,33.6576317 L30.8936953,33.6576317 L28.9900176,43.8771074 C28.9658731,44.0061991 29.0349959,44.1345183 29.1559109,44.1855309 C29.2766335,44.2365436 29.416826,44.1964348 29.492373,44.0893427 L38.9606658,30.7215786 C39.0147939,30.6374631 39.0196638,30.5307622 38.9735167,30.4419711 C38.9275644,30.353185 38.8374115,30.2957422 38.7373303,30.2916548 L33.9112205,30.2913458 L37.0377261,21.5094356 C37.0647911,21.4262921 37.0515504,21.3351682 37.0015098,21.2635142 C36.9516636,21.1916659 36.8710522,21.1472728 36.7836269,21.1437686 Z" fill="#000000" fill-rule="nonzero" />\n  </g>\n</svg>\n'}),define("text!res/icons/notif-advance.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M32,12.78 C42.6149129,12.78 51.22,21.3850871 51.22,32 C51.22,42.6149129 42.6149129,51.22 32,51.22 C21.3850871,51.22 12.78,42.6149129 12.78,32 C12.78,21.3850871 21.3850871,12.78 32,12.78 Z M31.9263412,23.9620555 C31.2545465,24.6338503 31.2172245,25.6998559 31.8143754,26.4154519 L31.9263412,26.5379445 L36.1039418,30.7135714 L23.5,30.7142857 C22.4940528,30.7142857 21.6785714,31.5297671 21.6785714,32.5357143 C21.6785714,33.4913641 22.4145433,34.2751186 23.3506145,34.3511049 L23.5,34.3571429 L36.1039418,34.3565714 L31.9263412,38.5334841 C31.2545465,39.2052788 31.2172245,40.2712845 31.8143754,40.9868805 L31.9263412,41.1093731 C32.598136,41.7811678 33.6641416,41.8184898 34.3797376,41.2213389 L34.5022302,41.1093731 L41.3586297,34.2529736 C42.263936,33.3476673 42.3050863,31.9054433 41.4820805,30.9513263 L41.3586297,30.818455 L34.5022302,23.9620555 C33.7909181,23.2507434 32.6376533,23.2507434 31.9263412,23.9620555 Z" fill="#000000" />\n  </g>\n</svg>\n'}),define("text!res/icons/notif-dismiss.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M32,12.78 C42.6149129,12.78 51.22,21.3850871 51.22,32 C51.22,42.6149129 42.6149129,51.22 32,51.22 C21.3850871,51.22 12.78,42.6149129 12.78,32 C12.78,21.3850871 21.3850871,12.78 32,12.78 Z M39.4607003,28.5 L24.5204246,28.5003573 L24.5015528,28.5014287 C24.2261995,28.5222888 24.0198919,28.7624172 24.040752,29.0377706 L24.040752,29.0377706 L25.1449597,43.6133117 C25.2042196,44.3955431 25.8562008,45 26.6406737,45 L26.6406737,45 L37.3593499,45 C38.1438228,45 38.795804,44.3955431 38.855064,43.6133117 L38.855064,43.6133117 L39.9592716,29.0377706 C39.9602237,29.0252029 39.9607003,29.0126037 39.9607003,29 C39.9607003,28.7238576 39.7368427,28.5 39.4607003,28.5 L39.4607003,28.5 Z M28.4910664,30.8749392 L28.6112713,30.8802774 C29.0864588,30.9270375 29.487971,31.2738742 29.5964158,31.7475834 L29.5964158,31.7475834 L29.6172944,31.8685536 L30.6172944,40.3685536 L30.6250608,40.4910664 C30.6302589,41.0580002 30.2073734,41.5495383 29.6314464,41.6172944 C29.0555194,41.6850506 28.5301032,41.3050773 28.4035842,40.7524166 L28.4035842,40.7524166 L28.3827056,40.6314464 L27.3827056,32.1314464 L27.3749392,32.0089336 C27.3697411,31.4419998 27.7926266,30.9504617 28.3685536,30.8827056 L28.3685536,30.8827056 L28.4910664,30.8749392 Z M35.5089336,30.8749392 L35.6314464,30.8827056 C36.2485111,30.9553014 36.6898903,31.5143817 36.6172944,32.1314464 L36.6172944,32.1314464 L35.6172944,40.6314464 L35.5964158,40.7524166 C35.4698968,41.3050773 34.9444806,41.6850506 34.3685536,41.6172944 C33.7514889,41.5446986 33.3101097,40.9856183 33.3827056,40.3685536 L33.3827056,40.3685536 L34.3827056,31.8685536 L34.4035842,31.7475834 C34.5301032,31.1949227 35.0555194,30.8149494 35.6314464,30.8827056 Z M32.5,19 L31.5,19 L31.3079648,19.0051789 C29.4642776,19.1048736 28,20.6314366 28,22.5 L28,22.5 L28,23.5 L23.25,23.5 L23.10554,23.5068666 C22.3448881,23.5795513 21.75,24.2203039 21.75,25 C21.75,25.8284271 22.4215729,26.5 23.25,26.5 L23.25,26.5 L40.75,26.5 L40.89446,26.4931334 C41.6551119,26.4204487 42.25,25.7796961 42.25,25 C42.25,24.1715729 41.5784271,23.5 40.75,23.5 L40.75,23.5 L36,23.5 L36,22.5 L35.9948211,22.3079648 C35.8951264,20.4642776 34.3685634,19 32.5,19 L32.5,19 Z M32.5,22 L32.5898756,22.0080557 C32.8231248,22.0503916 33,22.2545401 33,22.5 L33,22.5 L33,23.5 L31,23.5 L31,22.5 L31.0080557,22.4101244 C31.0503916,22.1768752 31.2545401,22 31.5,22 L31.5,22 L32.5,22 Z" fill="#000000" fill-rule="nonzero" />\n  </g>\n</svg>\n'}),define("text!res/icons/notif-pin.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M32,12.78 C42.6149129,12.78 51.22,21.3850871 51.22,32 C51.22,42.6149129 42.6149129,51.22 32,51.22 C21.3850871,51.22 12.78,42.6149129 12.78,32 C12.78,21.3850871 21.3850871,12.78 32,12.78 Z M31.5743348,22.39 C30.4117356,22.39 29.2829416,22.5719648 28.1879528,22.9358944 L28.1879528,22.9358944 L28.1881981,29.3780854 C26.1321435,30.2979805 24.7488183,32.0174424 24.7488183,33.9868193 L24.7488183,33.9868193 L24.7488183,35.1147978 C24.7488183,35.3522205 24.9412874,35.5446896 25.1787101,35.5446896 L25.1787101,35.5446896 L30.3368183,35.544 L30.3374119,42.9509507 C30.3374119,43.6632188 30.9148193,44.2406262 31.6270874,44.2406262 C32.3393554,44.2406262 32.9167628,43.6632188 32.9167628,42.9509507 L32.9167628,42.9509507 L32.9158183,35.544 L38.0754646,35.5446896 C38.3128873,35.5446896 38.5053564,35.3522205 38.5053564,35.1147978 L38.5053564,35.1147978 L38.5053564,33.9868193 C38.5053564,32.0177593 37.1224765,30.298534 35.0669694,29.3785297 L35.0669694,29.3785297 L35.0662219,22.9358944 C33.9008964,22.5719648 32.7369341,22.39 31.5743348,22.39 Z" fill="#000000" />\n  </g>\n</svg>\n'}),define("text!res/icons/notif-pinned.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M32,24.0752453 C45.3609001,24.0752453 56.1920497,32.4532303 56.1920497,42.7879985 C56.1920497,44.1104296 56.1920497,45.4328608 56.1920497,46.7552919 C56.1920497,47.5903482 55.5151028,48.267295 54.6800466,48.267295 L9.31995343,48.267295 C8.48489718,48.267295 7.80795033,47.5903482 7.80795033,46.7552919 C7.80795033,45.4328608 7.80795033,44.1104296 7.80795033,42.7879985 C7.80795033,32.4532303 18.6390999,24.0752453 32,24.0752453 Z" fill="#000000" />\n    <rect class="icon-solid" fill="#000000" height="17" opacity="0.7" rx="1" width="10" x="27" y="46.2406262" />\n    <path class="icon-solid" d="M19.9039752,7.92000394 C23.7552381,6.64000131 27.7253998,6 31.8144603,6 C35.9035208,6 39.9973757,6.64000131 44.0960248,7.92000394 L44.0960248,36.2400621 L19.9039752,36.2400621 L19.9039752,7.92000394 Z" fill="#000000" />\n  </g>\n</svg>\n'}),define("text!res/icons/notif-unpin.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M51.22,32 C51.22,42.6149129 42.6149129,51.22 32,51.22 C27.2509749,51.22 22.9042355,49.4976107 19.5503852,46.6434356 L30.336,35.856 L30.3374119,42.9509507 C30.3374119,43.6632188 30.9148193,44.2406262 31.6270874,44.2406262 C32.2948387,44.2406262 32.8440601,43.7331392 32.9101044,43.0828125 L32.9167628,42.9509507 L32.9158183,35.544 L38.0754646,35.5446896 C38.286507,35.5446896 38.4620305,35.3926153 38.4984303,35.1920714 L38.5053564,35.1147978 L38.5053564,33.9868193 C38.5053564,32.4023237 37.6098914,30.9796052 36.1890528,30.0049325 L46.6434356,19.5503852 C49.4976107,22.9042355 51.22,27.2509749 51.22,32 Z M32,12.78 C36.7494967,12.78 41.0966279,14.5027315 44.4506141,17.3574148 L35.066,26.741 L35.0662219,22.9358944 C33.9008964,22.5719648 32.7369341,22.39 31.5743348,22.39 C30.5570605,22.39 29.5656683,22.5293168 28.6001582,22.8079504 L28.1879528,22.9358944 L28.1881981,29.3780854 C26.2082936,30.2639103 24.8522096,31.8911716 24.7544749,33.7690561 L24.7488183,33.9868193 L24.7488183,35.1147978 C24.7488183,35.3258402 24.9008926,35.5013637 25.1014365,35.5377635 L25.1787101,35.5446896 L26.264,35.544 L17.3574148,44.4506141 C14.5027315,41.0966279 12.78,36.7494967 12.78,32 C12.78,21.3850871 21.3850871,12.78 32,12.78 Z" fill="#000000" />\n  </g>\n</svg>\n'}),define("text!res/icons/notif-provider-shelf.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-hollow" d="M19.4875317,56.9512422 C18.4530725,56.9561423 17.8327197,56.9569808 17.6264735,56.9537577 L16.7388272,56.9320533 L15.9279862,56.8960292 C15.1534888,56.8528862 14.4849331,56.7884479 13.8945201,56.7032668 L13.3291251,56.6111918 L12.8096476,56.5054111 L12.3299101,56.3860472 C11.8679834,56.2599327 11.4564004,56.1136278 11.0673619,55.9476848 L10.6848087,55.7752163 C10.6219592,55.7453873 10.5594784,55.715018 10.4972378,55.6841109 L10.1256463,55.4922344 C8.33359597,54.5338354 6.9271844,53.1274239 5.96878541,51.3353736 L5.77690899,50.963782 L5.59794047,50.5864271 L5.43200261,50.1971313 C5.00698495,49.1375966 4.72227037,47.8847978 4.58833421,45.9115826 L4.54519635,45.1368277 L4.51631672,44.2883563 L4.50181808,43.3599907 C4.50060688,43.1982621 4.5,43.0329471 4.5,42.8639171 L4.5,16.5971028 L4.50726211,15.6264735 C4.5096794,15.4717888 4.51269845,15.3205617 4.51631672,15.1726635 L4.54519635,14.3241921 L4.58833421,13.5494373 C4.75575441,11.0829182 5.1587659,9.74204989 5.77690899,8.49723781 L5.96878541,8.12564628 C6.9271844,6.33359597 8.33359597,4.9271844 10.1256463,3.96878541 L10.4972378,3.77690899 L10.8745927,3.59794047 C12.085196,3.0517739 13.475411,2.7016101 15.9279862,2.56499067 L16.7388272,2.52896658 L17.6264735,2.50726211 C17.7811582,2.50484481 17.9393005,2.50302929 18.1010291,2.50181808 L44.8639171,2.5 C45.2019771,2.5 45.525177,2.50242752 45.8345464,2.50726211 L46.7221927,2.52896658 L47.5330336,2.56499067 C49.8565259,2.69441961 51.2265426,3.01550609 52.3936579,3.51333503 L52.7762111,3.68580357 C52.8390607,3.71563251 52.9015414,3.74600184 52.963782,3.77690899 L53.3353736,3.96878541 C55.1274239,4.9271844 56.5338354,6.33359597 57.4922344,8.12564628 L57.6841109,8.49723781 C58.302254,9.74204989 58.7052654,11.0829182 58.8726856,13.5494373 L58.9158235,14.3241921 L58.9447031,15.1726635 L58.9592018,16.1010291 L58.9610198,29.1180767" stroke="#000000" stroke-linecap="round" stroke-width="3.29900171" />\n    <path class="icon-solid" d="M49,4 C53.9705627,4 58,8.02943725 58,13 L58.0007844,37.5555183 C55.9273301,36.2581988 53.476292,35.5083191 50.8501101,35.5083191 L39.6407776,35.5083191 C32.1849335,35.5083191 26.1407776,41.552475 26.1407776,49.0083191 L26.1407776,50.5 C26.1407776,52.4590138 26.5580474,54.3205689 27.3085571,56.0006355 L15,56 C10.0294373,56 6,51.9705627 6,47 L6,13 C6,8.02943725 10.0294373,4 15,4 L49,4 Z" fill="#000000" fill-opacity="0.07" />\n    <path d="M50.8501101,38.0083191 L39.6407776,38.0083191 C33.662076,38.0083191 28.7974124,42.7780827 28.644485,48.7199116 L28.6407776,49.0083191 L28.6407776,50.5 C28.6407776,56.4787016 33.4105412,61.3433652 39.3523701,61.4962926 L39.6407776,61.5 L50.8501101,61.5 C56.8288117,61.5 61.6934753,56.7302364 61.8464027,50.7884075 L61.8501101,50.5 L61.8501101,49.0083191 C61.8501101,43.0296175 57.0803466,38.1649539 51.1385176,38.0120265 L50.8501101,38.0083191 Z" fill="#A61C49" fill-rule="nonzero" />\n    <path d="M46.9138645,55.6280416 L46.9138645,43.8802776 L45.0174398,43.8802776 C44.9503097,44.3278114 44.8104554,44.702621 44.5978768,45.0047064 C44.3852982,45.3067918 44.1251691,45.5501383 43.8174896,45.734746 C43.5098101,45.9193537 43.1629713,46.0480197 42.7769734,46.120744 C42.3909754,46.1934682 41.990992,46.2242362 41.5770232,46.2130478 L41.5770232,48.0087775 L44.5307467,48.0087775 L44.5307467,55.6280416 L46.9138645,55.6280416 Z" fill="#FFFFFF" fill-rule="nonzero" />\n    <path class="icon-hollow" d="M20.6785349,26.3252223 L21.583458,6.69972193 C21.583458,5.53301666 22.5292595,4.58721516 23.6959648,4.58721516 L43.3214651,3.68229207" stroke="#000000" stroke-linecap="round" stroke-width="3.38001084" transform="translate(32.000000, 15.003757) rotate(-135.000000) translate(-32.000000, -15.003757) " />\n  </g>\n</svg>\n'}),define("text!res/icons/notif-provider-push.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 92" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M47.3181547,1.61474356 L16.0645155,1.61474356 C9.30826719,1.61474356 3.8312458,7.09176495 3.8312458,13.8480132 L3.8312458,78.1519868 C3.8312458,84.908235 9.30826719,90.3852564 16.0645155,90.3852564 L47.3181547,90.3852564 C54.074403,90.3852564 59.5514244,84.908235 59.5514244,78.1519868 L59.5514244,13.8480132 C59.5514244,7.09176495 54.074403,1.61474356 47.3181547,1.61474356 Z M16.0645155,4.61474356 L47.3181547,4.61474356 C52.4175488,4.61474356 56.5514244,8.7486192 56.5514244,13.8480132 L56.5514244,78.1519868 C56.5514244,83.2513808 52.4175488,87.3852564 47.3181547,87.3852564 L16.0645155,87.3852564 C10.9651214,87.3852564 6.8312458,83.2513808 6.8312458,78.1519868 L6.8312458,13.8480132 C6.8312458,8.7486192 10.9651214,4.61474356 16.0645155,4.61474356 Z" fill="#000000" fill-rule="nonzero" />\n    <path class="icon-solid" d="M47.3181547,4.61474356 C52.4175488,4.61474356 56.5514244,8.7486192 56.5514244,13.8480132 L56.5514244,78.1519868 C56.5514244,83.2513808 52.4175488,87.3852564 47.3181547,87.3852564 L16.0645155,87.3852564 C10.9651214,87.3852564 6.8312458,83.2513808 6.8312458,78.1519868 L6.8312458,13.8480132 C6.8312458,8.7486192 10.9651214,4.61474356 16.0645155,4.61474356 L47.3181547,4.61474356 Z M48.1737458,10.2179487 L15.8262542,10.2179487 C13.0510365,10.2179487 10.8012781,12.4677071 10.8012781,15.2429248 L10.8012781,23.1929726 C10.8012781,25.9681903 13.0510365,28.2179487 15.8262542,28.2179487 L48.1737458,28.2179487 C50.9489635,28.2179487 53.1987219,25.9681903 53.1987219,23.1929726 L53.1987219,15.2429248 C53.1987219,12.4677071 50.9489635,10.2179487 48.1737458,10.2179487 Z" fill="#000000" fill-opacity="0.07" fill-rule="nonzero" />\n    <path d="M16.6686928,13.2179487 L47.3313072,13.2179487 C48.9149367,13.2179487 50.198722,14.3788012 50.198722,15.8107854 L50.198722,22.625112 C50.198722,24.0570962 48.9149367,25.2179487 47.3313072,25.2179487 L16.6686928,25.2179487 C15.0850633,25.2179487 13.801278,24.0570962 13.801278,22.625112 L13.801278,15.8107854 C13.801278,14.3788012 15.0850633,13.2179487 16.6686928,13.2179487 Z" fill="#A61C49" fill-rule="nonzero" />\n  </g>\n</svg>\n'}),define("text!res/icons/notif-provider-email.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M50.6600579,1 L13.3399421,1 C7.11193525,1 2.025,5.68357899 2.025,11.5052518 L2.025,36.0908575 C2.025,41.9125303 7.11193523,46.5961093 13.3399421,46.5961093 L50.6600579,46.5961093 C56.8880647,46.5961093 61.975,41.9125303 61.975,36.0908575 L61.975,11.5052518 C61.975,5.68357901 56.8880647,1 50.6600579,1 Z M13.3399421,4.16600842 L50.6600579,4.16600842 C55.1952598,4.16600842 58.8089916,7.49319805 58.8089916,11.5052518 L58.8089916,36.0908575 C58.8089916,40.1029113 55.1952598,43.4301009 50.6600579,43.4301009 L13.3399421,43.4301009 C8.80474015,43.4301009 5.19100842,40.1029113 5.19100842,36.0908575 L5.19100842,11.5052518 C5.19100842,7.49319803 8.80474017,4.16600842 13.3399421,4.16600842 Z" fill="#000000" fill-rule="nonzero" />\n    <path class="icon-solid" d="M50.6600579,4.16600842 C55.1952598,4.16600842 58.8089916,7.49319805 58.8089916,11.5052518 L58.8089916,36.0908575 C58.8089916,40.1029113 55.1952598,43.4301009 50.6600579,43.4301009 L13.3399421,43.4301009 C8.80474015,43.4301009 5.19100842,40.1029113 5.19100842,36.0908575 L5.19100842,11.5052518 C5.19100842,7.49319803 8.80474017,4.16600842 13.3399421,4.16600842 L50.6600579,4.16600842 Z M7.21081994,12.240143 C6.49095556,13.3927288 6.79519541,14.8947655 7.87755163,15.6818269 L8.02994559,15.7846218 L23.3666985,25.3635547 C24.5816039,27.2410853 26.6305745,29.1097146 29.6238308,31.2128663 L30.3634846,31.7243518 L32.0234812,32.8405504 L33.6834778,31.7243532 L34.4231308,31.2128689 C37.5004314,29.0506675 39.5796773,27.136338 40.7806324,25.2053751 L55.5792218,15.7720188 C56.7772375,15.0084019 57.1293872,13.4181845 56.3657703,12.2201688 C55.6353541,11.0742408 54.1486532,10.7022241 52.9723073,11.3403235 L52.8139203,11.4336203 L41.5486934,18.6141089 C40.5666997,16.4551807 38.2615512,14.8924153 35.6103171,14.8924153 L35.3254815,14.8994305 C34.1934431,14.9555264 33.1473968,15.3477389 32.1277265,16.0650582 L32.023,16.1404628 L31.9192374,16.0650598 C30.8145945,15.2879661 29.678992,14.8924153 28.4366537,14.8924153 C25.740179,14.8924153 23.4016999,16.5089681 22.4491635,18.7251409 L10.7552987,11.4210173 C9.55032264,10.6684319 7.96340543,11.0351669 7.21081994,12.240143 Z" fill="#000000" fill-opacity="0.07" fill-rule="nonzero" />\n    <path class="icon-solid" d="M8.04997464,11.8502646 C8.48586126,11.1523599 9.37655527,10.9113936 10.0980477,11.2715736 L10.2311924,11.3461872 L22.3673661,18.9257704 C22.1255067,19.5525797 21.9934821,20.2235159 21.9934821,20.9166267 C21.9934821,21.4673044 22.0483943,22.0036475 22.1604046,22.5304834 L8.55405196,14.0314823 L8.42858479,13.9445761 C7.7883607,13.4542761 7.61408802,12.5481693 8.04997464,11.8502646 Z" fill="#000000" fill-rule="nonzero" />\n    <path class="icon-solid" d="M53.4781631,11.27811 C54.1963182,10.911321 55.089187,11.1440995 55.5314629,11.8379728 C55.9737388,12.5318461 55.8077926,13.4395148 55.172097,13.9356721 L55.0474331,14.0237266 L41.9138768,22.3959774 C42.0075051,21.9123968 42.0534821,21.4205127 42.0534821,20.9166267 C42.0534821,20.18354 41.9057891,19.4752596 41.6366583,18.8177594 L53.3457091,11.3539429 L53.4781631,11.27811 Z" fill="#000000" fill-rule="nonzero" />\n    <path d="M35.395107,17.2985867 C37.6943888,17.2985867 39.571682,19.080654 39.571682,21.0813454 L39.5686126,21.262692 C39.5009801,23.2539494 38.3122575,25.1324599 35.6623,27.3492782 L35.1643121,27.7561643 L34.6336663,28.1711088 L34.0699083,28.594714 C33.8764198,28.7374261 33.6773369,28.8816821 33.4725839,29.0275824 L32.8412386,29.4703165 C32.7331541,29.5449611 32.6236331,29.6200419 32.5126662,29.6955714 L32.0230289,30.0252914 L31.8715456,29.9235186 C31.6438088,29.7706391 31.4218937,29.6196048 31.2057244,29.4703152 L30.5743784,29.0275802 C30.3696252,28.8816796 30.1705421,28.7374234 29.9770534,28.594711 L29.413295,28.1711052 L28.8826489,27.7561602 C25.7972006,25.2912684 24.475282,23.2615315 24.475282,21.0813454 C24.475282,19.0806549 26.3525791,17.2985867 28.6518634,17.2985867 C29.5940786,17.2985867 30.4595488,17.677839 31.4063784,18.5018626 L32.023483,19.0389272 L32.6405868,18.5018617 C33.5874191,17.6778333 34.4528781,17.2985867 35.395107,17.2985867 Z" fill="#A61C49" fill-rule="nonzero" />\n  </g>\n</svg>\n'}),define("text!res/icons/tout-join-plus.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M35.2,8.33 L28.8,8.33 C28.5692677,8.33 28.3773681,8.49626265 28.3375723,8.71551691 L28.33,8.8 L28.33,28.33 L8.8,28.33 C8.5692677,28.33 8.37736813,28.4962627 8.33757233,28.7155169 L8.33,28.8 L8.33,35.2 C8.33,35.4307323 8.49626265,35.6226319 8.71551691,35.6624277 L8.8,35.67 L28.33,35.67 L28.33,55.2 C28.33,55.4307323 28.4962627,55.6226319 28.7155169,55.6624277 L28.8,55.67 L35.2,55.67 C35.4307323,55.67 35.6226319,55.5037373 35.6624277,55.2844831 L35.67,55.2 L35.67,35.67 L55.2,35.67 C55.4307323,35.67 55.6226319,35.5037373 55.6624277,35.2844831 L55.67,35.2 L55.67,28.8 C55.67,28.5692677 55.5037373,28.3773681 55.2844831,28.3375723 L55.2,28.33 L35.67,28.33 L35.67,8.8 C35.67,8.5692677 35.5037373,8.37736813 35.2844831,8.33757233 L35.2,8.33 Z" fill="#000000" fill-rule="nonzero" />\n  </g>\n</svg>\n'}),define("text!res/icons/tout-join-arrow.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M39.442547,9.30104005 C39.2801339,9.13918872 39.0298838,9.11915647 38.8457263,9.24080997 L38.7712969,9.30162143 L34.2328048,13.8402479 C34.0688332,14.0177644 34.0601164,14.2749593 34.1956067,14.454906 L34.2531536,14.5184585 L47.9570801,28.0909264 L2.80513212,28.0946523 C2.57189695,28.0947053 2.37791936,28.2627873 2.33766573,28.4843889 L2.33,28.5697746 L2.33,35.0102541 C2.33,35.2434881 2.49801418,35.4374164 2.71963446,35.4775903 L2.8050306,35.4852247 L48.0027058,35.4814951 L34.6668313,47.8178568 C34.5045001,47.980188 34.4842087,48.2307714 34.6059571,48.4151657 L34.6668313,48.4896892 L39.1766068,52.9994647 C39.338938,53.1617959 39.5895214,53.1820873 39.7739157,53.0603389 L39.8484392,52.9994647 L61.1964064,31.6514974 C61.3589649,31.4883757 61.3788858,31.2376938 61.2568261,31.0535027 L61.195824,30.9790837 L39.442547,9.30104005 Z" fill="#000000" fill-rule="nonzero" />\n  </g>\n</svg>\n';
}),define("text!res/symbols/mascot.svg",[],function(){return'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024">\n  <g class="mascot-symbol" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">\n    <path class="mascot-field mascot-neg" fill="#631A35" d="M0 0h1024v1024H0z" />\n    <g class="mascot-libby" transform="translate(176 141)">\n      <path class="mascot-bob" fill="#A61C49" d="M102.419 639.156C39.239 588.234 0 511.792 0 412.103 0 217.018 150.273 75.956 336.148 75.956c184.868 0 335.14 141.05 335.14 336.147 0 99.692-39.237 176.132-102.278 227.053H102.419Z" />\n      <circle class="mascot-face mascot-skin" fill="#FEA" cx="335.644444" cy="409.6" r="301.511111" />\n      <path class="mascot-ribbon mascot-env" fill="#29CFC3" d="M576.222 0s-55.7 27.256-67.855 27.256C496.212 27.256 439.69 0 439.69 0v71.386c51.51 15.05 98.043 42.975 136.533 77.947V0Z" />\n      <path class="mascot-right-hair" fill="#A61C49" d="M496.186 354.418c39.716-49.47 70.43-106.476 89.662-168.532 53.113 59.452 85.44 138.005 85.44 224.217 0 34.455-5.219 67.708-14.91 99.011L496.186 354.418Z" />\n      <g class="mascot-spectacles mascot-neg mascot-hide" fill="#631A35" transform="translate(100.982 353.223)">\n        <path class="mascot-spectacles-right-eye" d="M331.69 105.514a35.215 35.215 0 0 1-1.028-8.467c0-19.368 15.67-35.07 35-35.07s35 15.702 35 35.07c0 13.386-7.484 25.02-18.489 30.93-3.78-15.278-17.556-26.603-33.973-26.603a34.79 34.79 0 0 0-16.51 4.14Z" />\n        <path class="mascot-spectacles-frame" d="m86.882 0 3.98.015 8.908.06 2.425.011 3.262.006 1.82.012 1.85.024 1.404.027 1.42.033 1.913.057.965.033 1.947.077.982.044.985.047 1.986.105.999.059 2.009.128 1.01.07 2.029.15 2.04.167 1.537.136c.513.047 1.026.096 1.54.146l1.932.195 2.323.254 1.94.229 1.552.194 1.552.205c.517.07 1.034.141 1.551.215l1.55.225 1.547.237c.773.12 1.545.246 2.316.375l1.538.264c1.024.18 2.045.367 3.062.562l1.521.298 1.515.31 1.506.322 1.498.334 1.488.346c14.587 3.465 27.698 8.725 36.116 16.448 4.787 4.393 7.904 9.638 9.904 15.432h63.3c2-5.794 5.118-11.04 9.905-15.432 8.418-7.723 21.529-12.983 36.115-16.448l1.489-.346 1.497-.334 1.507-.322 1.514-.31 1.522-.298c1.016-.195 2.037-.383 3.061-.562l1.539-.264c.77-.13 1.542-.254 2.315-.375l1.548-.237 1.55-.225c.516-.074 1.034-.145 1.55-.215l1.553-.205 1.552-.194 1.551-.185 1.55-.174.775-.083 1.546-.16c.515-.052 1.03-.102 1.543-.15l1.923-.174 2.424-.2 2.029-.152 1.01-.07L354.18.61l.999-.059 1.985-.105 1.967-.091 1.947-.077 1.925-.063c1.276-.038 2.536-.066 3.778-.087l1.85-.024 1.82-.012 3.262-.006 2.425-.011 8.908-.06 3.98-.015h1.882l2.965.01 2.241.017 2.255.028 1.508.025 1.513.03 1.514.037 1.517.043 1.518.05 1.518.058 1.518.066 1.516.074 1.514.082 1.511.092.754.05 1.88.134 1.872.15 1.491.132 1.484.144c.74.075 1.476.154 2.21.238l1.461.173 1.452.187 1.441.2c12.201 1.754 23.135 4.986 30.524 10.88 6.334 5.051 10.447 11.797 13.106 19.484l43.254-8.326c1.656-.503 3.538 1.423 4.965 3.948l.247.451.12.23.231.465.111.236.214.475.102.24.194.479c.063.16.123.32.18.48l.166.477c.052.158.102.316.15.473l.132.467c.56 2.08.592 3.894-.245 4.521l-45.134 39.526-.03 2.839-.083 6.698-.015 1.637-.012 2.422-.001.798c0 50.163-46.736 90.828-104.387 90.828-57.652 0-104.388-40.665-104.388-90.828 0-3.027-.081-6.112-.189-9.227l-.106-2.881h-57.429l-.105 2.881c-.107 3.115-.189 6.2-.189 9.227 0 50.163-46.735 90.828-104.387 90.828C46.907 181.748.171 141.083.171 90.92l-.001-.798-.007-1.61-.03-3.274-.074-5.873-.045-4.282L0 72.488V69.88l.006-.872.016-1.745.03-1.888.027-1.26.034-1.259.065-1.887.053-1.257.061-1.256.07-1.253.08-1.25.09-1.247.1-1.244c.036-.414.073-.827.112-1.24l.122-1.234.066-.616.14-1.227c.049-.408.1-.815.153-1.22l.166-1.216C3.318 33.18 7.78 20.91 17.822 12.9c7.39-5.893 18.324-9.125 30.524-10.88l1.441-.2 1.452-.186 1.462-.173 1.103-.123 1.107-.115 1.484-.144 1.49-.132 1.872-.15 1.88-.135.755-.049 1.51-.092 1.515-.082 1.516-.074L68.45.298 69.97.241l1.517-.05 1.517-.044L74.518.11 76.03.08 77.54.055l2.254-.028 2.242-.018L84.999 0h1.883Zm.506 35.843h-3.28l-2.568.012-1.663.015-2.422.033-1.568.029-1.531.035-1.497.04-1.462.047-1.428.053-1.396.06-1.365.065-1.99.112-.65.04-1.276.086-1.25.093-1.222.1-1.493.136-1.455.147-1.137.126-1.116.133-1.094.142-1.075.15-1.157.172-.615.099-1.195.203c-3.122.553-5.736 1.203-7.791 1.914-.887.306-1.603.602-2.143.867l-.194.097-.25.137-.073.086c-.08.1-.175.239-.288.425-.133.22-.27.472-.407.757l-.208.45c-.313.715-.63 1.596-.938 2.655-.6 2.063-1.083 4.511-1.45 7.392l-.078.624-.12 1.07c-.093.87-.177 1.777-.25 2.72l-.054.716-.082 1.222-.038.626-.067 1.282-.058 1.323-.048 1.363-.039 1.404-.04 2.09-.017 1.326-.01 1.374-.001 1.731.003 1.127.03 3.868.12 10.114.02 4.189c0 29.174 29.667 54.986 68.546 54.986 38.49 0 67.951-25.299 68.537-54.112l.009-.874.004-1.449.014-1.457.024-1.49.046-2.073.063-2.223.06-1.799.321-8.668.069-2.118.033-1.165.038-1.674.024-1.587.008-1.011.002-1.45-.007-.922-.013-.89-.02-.855-.025-.825-.031-.793-.038-.764-.045-.735-.05-.707-.058-.68-.063-.655-.07-.63-.077-.605-.083-.583-.09-.56-.096-.54-.103-.52-.12-.545-.121-.488-.12-.434a9.942 9.942 0 0 0-.237-.71l-.058-.147-.111-.255-.067-.137-.047-.042-.256-.21a10.4 10.4 0 0 0-.309-.235l-.175-.125-.39-.265-.214-.14-.47-.294-.256-.153c-1.403-.828-3.164-1.686-5.254-2.534-4.638-1.883-10.5-3.563-17.295-4.934-12.48-2.518-27.295-3.83-41.548-3.908l-2.444-.004-16.06-.089Zm304.412 0-4.678.005-14.663.084h-1.108c-14.66 0-30.014 1.316-42.884 3.912-6.794 1.371-12.656 3.05-17.295 4.934-2.09.848-3.85 1.706-5.253 2.534-.787.465-1.391.877-1.815 1.211l-.308.256-.018.045-.11.237-.056.136-.115.306-.117.353c-.098.315-.197.68-.295 1.1l-.116.53-.107.54-.093.522-.087.54-.08.56-.075.58-.068.6-.063.621-.056.645-.05.67-.044.694-.039.721-.032.749-.027.777-.02.806-.016.838-.013 1.316v.92l.01 1.443.021 1.525.021 1.064.027 1.103.07 2.327.05 1.424.296 7.958.077 2.372.059 2.18.042 2.045.014.988.017 1.94.002.966c0 29.174 29.666 54.986 68.546 54.986 38.49 0 67.95-25.299 68.536-54.112l.01-.874.012-3.456.14-12.23.016-2.094.005-1.518-.002-1.774-.01-1.453-.019-1.403-.038-1.891-.05-1.749-.064-1.684-.03-.657-.068-1.282-.037-.626-.082-1.222-.092-1.184c-.385-4.658-1.003-8.39-1.86-11.338-.514-1.765-1.053-3.036-1.554-3.862l-.156-.245a3.196 3.196 0 0 0-.132-.18l-.073-.087-.25-.136c-.557-.289-1.339-.62-2.336-.964-2.441-.844-5.669-1.602-9.602-2.216l-1.156-.173-1.075-.15-1.095-.14-1.115-.134-1.138-.126-1.455-.147-1.492-.136-1.223-.1-1.249-.093-1.277-.086-.648-.04-1.991-.112-1.365-.065-1.396-.06-1.429-.053-1.462-.047-1.496-.04-1.532-.035-1.567-.029-2.422-.033-1.663-.015-2.57-.012Z" fill-rule="nonzero" />\n      </g>\n      <path class="mascot-left-hair" fill="#A61C49" d="M22.522 530.941C7.974 493.441 0 452.69 0 410.103 0 224.23 150.273 73.956 336.148 73.956c93.25 0 177.698 38.234 238.497 99.986-64.492 208.97-259.17 360.814-489.312 360.814a517.144 517.144 0 0 1-62.811-3.815Z" />\n      <path class="mascot-smile mascot-neg" fill="#631A35" d="M337.2 635.644c31.793 0 65.509-24.578 57.308-41.75-4.354-8.853-28.28 11.26-57.308 11.597-27.64-.214-51.318-18.607-56.16-11.597-11.943 16.785 25.357 41.75 56.16 41.75Z" />\n      <path class="mascot-right-eye-closed mascot-neg mascot-hide" fill="#631A35" d="M478.863 507c-28.996 0-61.545-37.514-57.892-42.896 3.652-5.381 35.455 9.435 56.044 9.435 22.35 0 56.796-14.755 60.397-9.6 3.602 5.154-28.611 43.061-58.55 43.061Z" />\n      <path class="mascot-right-eye-open mascot-neg" fill="#631A35" d="M425.299 480.058a41.965 41.965 0 0 1-1.232-10.124c0-23.16 18.804-41.934 42-41.934s42 18.774 42 41.934c0 16.006-8.982 29.917-22.187 36.984-4.536-18.269-21.068-31.81-40.768-31.81a41.867 41.867 0 0 0-19.813 4.95Z" />\n    </g>\n    <g class="mascot-book mascot-hide" transform="translate(93 741)">\n      <path class="mascot-pages-outline mascot-neg" fill="#631A35" d="M38 84.993c0-55.225 44.214-92.891 98.63-83.507 0 0 194.386 27.99 260.37 65.513 10.795.08 32.676.08 44 0C507.613 29.183 695.425 1.782 695.425 1.782 749.866-7.487 794 29.778 794 84.992V568H38V84.993Z" />\n      <path class="mascot-pages" fill="#FFF" d="M38 70.322c0-34.42 27.56-57.962 61.514-52.32 0 0 231.502 34.409 297.486 71.998 10.795-.05 32.676-.05 44 0 66.613-37.882 291.53-71.827 291.53-71.827 33.949-5.618 61.47 17.73 61.47 52.15V568H38V70.322Z" />\n      <path class="mascot-back-cover" fill="#29CFC3" d="M419 568V114L52 47C23.093 41.545.5 61.46 1 91L0 568h419Z" />\n      <path class="mascot-front-cover" fill="#23B0A7" d="M419 568V113l367-67c29.292-5.452 53 14.448 53 44v478H419Z" />\n      <path class="mascot-spine" fill="#26BFB5" d="M473 568V104H364v464z" />\n    </g>\n    <g class="mascot-mortarboard mascot-hide" transform="translate(110 162)">\n      <path class="mascot-cap mascot-neg" fill="#631A35" d="M399.085 324.762v.106l-.144-.053-.146.053v-.107c-204.715-75.292-211.545-74.83-304.45-74.83l28.281-148.053H679.69l28.637 148.053c-94.074 0-101.947-.462-309.242 74.831Z" />\n      <path class="mascot-ribbon-shadow mascot-neg" fill="#631A35" d="M254.337 313.778v94.678l-40.772-16.349-40.773 16.35v-94.68c0-19.394 13.527-35.63 31.602-39.804V165.337l18.635 3.42v105.216c17.954 4.273 31.308 20.502 31.308 39.805Z" />\n      <path class="mascot-cap-board" fill="#A61C49" d="M383.016-.38c11.687-3.06 30.622-3.024 42.296.083l358.423 95.366c3.378.899 5.894 1.977 7.604 3.054 3.92 2.468 4.792 5.325 4.768 7.648-.023 2.325-.953 5.164-4.925 7.55-1.733 1.04-4.27 2.066-7.667 2.893l-358.219 87.22c-11.664 2.84-30.587 2.874-42.266.075L18.468 116.15c-3.393-.814-5.93-1.822-7.66-2.845-4.026-2.38-4.94-5.222-4.964-7.53-.024-2.307.83-5.168 4.805-7.63 1.71-1.06 4.224-2.12 7.6-3.004Z" stroke="#A61C49" stroke-width="11.449" />\n      <path class="mascot-cap-ribbon mascot-env" fill="#50DCD2" d="M240.442 305.334v94.678l-40.772-16.349-40.772 16.35v-94.68c0-19.394 13.527-35.631 31.602-39.804V160.313l193.685-62.667c1.832-4.778 8.651-8.328 16.784-8.328 9.537 0 17.268 4.881 17.268 10.902 0 6.02-7.731 10.902-17.268 10.902-2.162 0-4.23-.251-6.137-.709l-185.698 57.478v97.638c17.954 4.273 31.308 20.502 31.308 39.805Z" />\n    </g>\n  </g>\n</svg>\n'}),define("text!res/symbols/fingerprint.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'>\n  <g stroke='none' stroke-width='1' fill='#000000' fill-rule='nonzero' transform='translate(32.000000, 32.000000) scale(-1, 1) translate(-32.000000, -32.000000) translate(8.000000, 6.000000)' class='icon-solid'>\n    <path d='M0.3315912,12.4805609 C0.0586608,12.9077631 -0.0513676,13.4223997 0.02235488,13.9269037 C0.0960776,14.4314486 0.3484296,14.8908054 0.731592,15.2179894 C1.082716,15.4734283 1.500636,15.6157337 1.931592,15.6265609 C2.241536,15.6234557 2.546716,15.5482786 2.823956,15.4066677 C3.101192,15.2650977 3.343196,15.0608529 3.531592,14.809418 C4.3824,13.6745291 5.33304,12.6214771 6.3716,11.663418 C9.32864,9.13893686 12.79168,7.30743371 16.51676,6.29797629 C20.2418,5.28851886 24.13824,5.12566229 27.9316,5.82084657 C32.54676,6.618378 36.89256,8.58499571 40.5716,11.5408466 C40.9908,11.876774 41.5232,12.0288851 42.052,11.9637589 C42.5808,11.8986326 43.0628,11.6215803 43.3916,11.1935609 C43.7204,10.7655414 43.8692,10.2216103 43.8056,9.681438 C43.742,9.14122486 43.4708,8.64905971 43.0516,8.31313229 C38.8182,4.91798543 33.80688,2.68207829 28.4916,1.81684657 C24.1468,1.05032571 19.68952,1.27949343 15.44204,2.48776171 C11.19456,3.69607086 7.263,5.85324629 3.931592,8.803418 C2.617908,9.90725543 1.412252,11.1387306 0.3315912,12.4805609 Z' />\n    <path d='M46.1716,31.5608466 C46.7032,30.518254 47.0264,29.3780946 47.1224,28.2067203 C47.2188,27.035346 47.086,25.8561271 46.7316,24.7377037 C46.5264,24.09784 46.286,23.4703969 46.0116,22.8582751 C44.3744,19.0674269 41.832,15.7568951 38.61732,13.2299626 C35.40264,10.7030709 31.61852,9.04059371 27.61168,8.39484657 C23.48164,7.65892771 19.23432,8.05814286 15.30512,9.55151229 C11.37592,11.0448409 7.9062,13.5786374 5.25168,16.8931323 C3.003468,20.1821731 1.579796,23.9845023 1.105564,27.9665211 C0.631328,31.94854 1.12102,35.9884943 2.531676,39.7322343 C2.680196,40.2523457 3.02492,40.6911514 3.490012,40.9514114 C3.9551,41.21208 4.50248,41.2729571 5.01168,41.1213771 C5.51652,40.9522286 5.93688,40.5890086 6.1834,40.10812 C6.42992,39.62764 6.48312,39.0674886 6.33168,38.5473771 C5.09904,35.4109786 4.64744,32.011174 5.01744,28.652676 C5.38744,25.2941371 6.56744,22.0818669 8.45168,19.3037037 C10.66272,16.5814331 13.54428,14.5104254 16.79952,13.3039549 C20.05476,12.0974843 23.56604,11.7991454 26.97168,12.4397037 C30.31892,12.977874 33.48124,14.3625226 36.17092,16.4675643 C38.86056,18.5726469 40.992,21.3313211 42.3716,24.4925609 C42.5716,25.0237037 42.7716,25.5139894 42.9316,26.0451323 C43.3004,27.2800394 43.1856,28.6128811 42.6116,29.7631323 C42.1708,30.7229483 41.382,31.4701437 40.4116,31.8468466 C38.98216,32.2893703 37.4428,32.1751337 36.09088,31.5261997 C34.739,30.8772657 33.67048,29.7396803 33.09168,28.3331323 C32.50392,26.4569723 31.46288,24.7622997 30.06468,23.4055566 C28.66648,22.0487726 26.9562,21.073676 25.09168,20.5702751 C22.98316,20.1574137 20.79984,20.4909714 18.90192,21.5159954 C17.00396,22.5410194 15.5048,24.196224 14.65168,26.2085609 C13.9446,28.8770634 13.94224,31.6892606 14.64484,34.3589889 C15.34748,37.0287171 16.72996,39.4605343 18.65168,41.4073771 C22.4436,45.5870629 27.42444,48.44502 32.89168,49.5788057 L33.17168,49.5788057 C33.70212,49.6114914 34.22344,49.4272257 34.62104,49.0672743 C35.0186,48.7069143 35.25984,48.2002857 35.29168,47.65852 C35.32352,47.1167543 35.14332,46.5843857 34.79076,46.1782657 C34.43816,45.7721457 33.94212,45.5257771 33.41168,45.4930914 C28.92064,44.4782 24.83512,42.0999057 21.69168,38.6699486 C20.27992,37.2591514 19.23092,35.5139794 18.63784,33.589608 C18.04472,31.6652366 17.9258,29.6211129 18.29168,27.6385609 C18.78912,26.5779503 19.60316,25.7058954 20.61664,25.1479094 C21.63016,24.5899234 22.79084,24.3747697 23.93168,24.533418 C25.69168,24.9419894 27.57168,25.9225609 29.33168,29.967418 C30.29448,32.3357023 32.10384,34.2407483 34.39212,35.295598 C36.68044,36.3504886 39.27608,36.47592 41.6516,35.6465609 C43.6228,34.9396914 45.2452,33.4733286 46.1716,31.5608466 Z' />\n    <path d='M41.7316,40.9579486 C41.7316,40.4161829 41.5208,39.89648 41.1456,39.5136486 C40.7708,39.1304086 40.262,38.9150914 39.73148,38.9150914 C31.73148,38.9150914 27.01148,35.8099486 25.49148,29.7631323 C25.35888,29.2213257 25.021,28.7555543 24.55216,28.468206 C24.08332,28.1808577 23.52192,28.095548 22.99148,28.2309894 C22.46104,28.3664309 22.00504,28.711592 21.72372,29.1904786 C21.4424,29.6693651 21.35888,30.2427543 21.49148,30.7845609 C22.89148,36.3410914 27.17148,43.0416629 39.61148,43.0416629 C39.88744,43.0588229 40.164,43.0171486 40.4232,42.9195 C40.6828,42.8218514 40.9196,42.6702714 41.1188,42.4745657 C41.318,42.27886 41.4752,42.0431143 41.5808,41.7820371 C41.686,41.52096 41.7376,41.2402714 41.7316,40.9579486 Z' />\n    <path d='M25.41168,18.5682751 C27.8764,19.009042 30.192,20.0792131 32.14316,21.6793014 C34.09436,23.2794306 35.61772,25.3574657 36.57168,27.7202751 C36.81144,28.2014089 37.22796,28.5660589 37.73012,28.734472 C38.23232,28.902926 38.77936,28.861456 39.25168,28.6191323 C39.48872,28.5020766 39.7002,28.3374631 39.8736,28.1350977 C40.0468,27.9327323 40.1788,27.6967823 40.2608,27.4413026 C40.3428,27.185782 40.3736,26.9160431 40.3516,26.6480611 C40.3296,26.38012 40.2548,26.1194923 40.1316,25.8817037 C38.89196,22.9053834 36.93036,20.3007406 34.43188,18.3134491 C31.93344,16.3261577 28.98052,15.0218343 25.85168,14.523418 C22.61456,13.9954211 19.29684,14.467934 16.32464,15.8803246 C13.35244,17.2927151 10.86144,19.58047 9.17168,22.4497037 C5.41168,28.9868466 6.57168,40.4676629 17.57168,51.37652 C17.95188,51.7393314 18.4514,51.9436171 18.97168,51.94852 C19.3714,51.9509714 19.76268,51.83126 20.09504,51.6040943 C20.4274,51.3773371 20.68556,51.0541571 20.83624,50.67582 C20.98692,50.2974829 21.0232,49.8819657 20.9404,49.4823829 C20.8576,49.0832086 20.65948,48.7183543 20.37168,48.4348057 C10.89168,39.07852 9.65168,29.681418 12.61168,24.533418 C13.95276,22.3820851 15.8754,20.6737663 18.14704,19.6151577 C20.41868,18.5565083 22.94196,18.1928797 25.41168,18.5682751 Z' />\n  </g>\n</svg>\n"}),define("text!res/symbols/encircle.svg",[],function(){return'<svg width="48" height="48" viewBox="0 0 48 48" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n  <defs>\n    <path id="encircle" d="M41.0880238,9.73830637 C37.5356371,7.57946732 32.7357682,5.94047587 24.0027996,5.94047587 C12.1302237,5.94047587 2.76684682,13.5332926 2.50559922,25.713849 C2.24435161,37.8944055 11.1499263,45.1035817 24.0027996,45.4872222 C36.8556729,45.8708627 45.5,37.5778729 45.5,25.713849 C45.5,18.1774747 37.3246029,7.46002323 28.2010942,2.5" />\n  </defs>\n  <g stroke-linecap="round" fill="none">\n    <use stroke="#FFF" stroke-width="6" xlink:href="#encircle" class="icon-shadow" />\n    <use stroke="#000" stroke-width="3" xlink:href="#encircle" class="icon-hollow" />\n  </g>\n</svg>\n'}),define("text!res/symbols/anchor-academy.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="color-bg" d="M48.9960748,3.10536518 L15.0039252,3.10536518 C8.42936887,3.10536518 3.09963787,8.43509618 3.09963787,15.0096526 L3.09963787,40.7855053 L3.10296114,41.0664719 L3.11379973,41.3638181 C3.42201489,47.6868751 8.63812963,52.6897927 15.0039252,52.6897927 L23.009,52.689 L30.3178947,59.9979468 L30.4612005,60.1303026 L30.6049094,60.2427644 C31.6769342,61.0272205 33.1346169,60.9267297 34.063358,59.9979886 L41.369,52.689 L48.9960152,52.6897927 C55.5706258,52.6897927 60.9003621,47.360067 60.9003621,40.7855053 L60.9003621,15.0096526 C60.9003621,8.43509618 55.5706311,3.10536518 48.9960748,3.10536518 Z" fill="#FFFFFF" fill-rule="nonzero" />\n    <line class="icon-hollow" stroke="#000000" stroke-linecap="square" x1="24.5" x2="24.5" y1="31.5" y2="33.5" />\n    <path class="icon-hollow" d="M48.9960748,6.51161518 C51.342743,6.51161518 53.4672523,7.46279042 55.0050946,9.0006327 C56.5429369,10.538475 57.4941121,12.6629843 57.4941121,15.0096526 L57.4941121,15.0096526 L57.4941121,40.7855053 C57.4941121,43.1321736 56.5429369,45.2566829 55.0050946,46.7945252 C53.4672523,48.3323675 51.342743,49.2835427 48.9960927,49.2835427 L48.9960927,49.2835427 L39.9595439,49.2833578 L32.2671885,56.9768988 L24.415618,49.2833582 L15.0039252,49.2835427 C12.657257,49.2835427 10.5327477,48.3323675 8.99490539,46.7945252 C7.4570631,45.2566829 6.50588787,43.1321736 6.50588787,40.7855053 L6.50588787,40.7855053 L6.50588787,15.0096526 C6.50588787,12.6629843 7.4570631,10.538475 8.99490539,9.0006327 C10.5327477,7.46279042 12.657257,6.51161518 15.0039252,6.51161518 L15.0039252,6.51161518 Z" stroke="#000000" stroke-width="1.75" />\n    <polygon class="icon-solid" fill="#000000" points="44.603792 25.4299408 45.7604667 31.4072958 44.2613449 31.4141213 43.6787409 31.4288726 43.2619143 31.4483145 42.8550188 31.4768912 42.451466 31.5163607 42.1810345 31.5495934 41.7684126 31.6111244 41.4858349 31.6606926 41.1949826 31.7177064 40.8939037 31.7826869 40.5806461 31.8561549 40.0836545 31.9834104 39.5482805 32.1326929 38.9679361 32.3057602 38.3360329 32.5043705 37.6459828 32.7302816 36.6240783 33.0770032 35.7727314 33.3734533 34.1725497 33.942096 31.915659 34.757517 31.915652 34.7622354 29.3410878 33.8209486 27.8099085 33.271556 26.9960777 32.9858382 26.2529098 32.7309129 25.3606341 32.4358778 24.7569093 32.2459745 24.2020441 32.0810119 23.6894976 31.9392343 23.3680802 31.8567294 23.0606258 31.7832285 22.6213856 31.6887219 22.3403599 31.6354552 21.7979099 31.5499519 21.5326095 31.5166748 21.1366137 31.4771395 20.8710934 31.4569442 20.327676 31.4290007 19.7548356 31.4141853 18.6349311 31.4073313 18.272417 31.4072958 19.414292 25.4299408 20.9916703 26.5362196 20.3922953 29.6765946 20.7077243 29.6910093 21.1540747 29.7198553 21.5915214 29.7592516 22.026313 29.8107573 22.4646984 29.8759318 22.9129262 29.9563343 23.2202985 30.019166 23.5366739 30.0899207 23.8639039 30.1690604 24.3791513 30.3045026 24.929236 30.46141 25.318399 30.5787099 26.1589122 30.845857 26.8510012 31.0765153 27.8679389 31.4274215 29.3112563 31.9409404 31.9125453 32.8887196 34.5435682 31.9427386 36.2710031 31.338208 37.2724875 31.0005315 37.7337547 30.8499276 38.5866168 30.5829078 38.9819227 30.4655793 39.5411938 30.3085302 39.8942888 30.2157946 40.2337466 30.1320978 40.5614227 30.0569835 40.8791728 29.9899955 41.1888522 29.9306776 41.4923166 29.8785735 41.6422981 29.8550841 41.9399191 29.8129454 42.2359639 29.77688 42.532288 29.7464317 42.8307471 29.7211442 43.2864975 29.6918915 43.6357953 29.6757196 43.0285453 26.5362196" />\n    <path class="icon-hollow" d="M32.0275608,19.9854993 C32.0913764,19.9687883 32.1941951,19.9688339 32.2568297,19.9854993 L49.8377341,24.6632916 C49.9005403,24.6800026 49.9003688,24.7059882 49.8377341,24.7212387 L32.2568297,29.0019151 C32.1940236,29.0172075 32.0912021,29.0171657 32.0275608,29.0019151 L14.1640936,24.7212387 C14.100278,24.7059464 14.1004523,24.679957 14.1640936,24.6632916 L32.0275608,19.9854993 Z" stroke="#000000" stroke-width="1.6" />\n    <path class="icon-solid" d="M26.5,38.076331 L26.5,43.1653196 L24.4879543,41.6679499 L22.5,43.1653196 L22.5,38.076331 C22.5,37.0338746 23.1214777,36.1646122 23.973943,35.9403053 L25.0234544,35.9403053 C25.8701978,36.1700015 26.5,37.0388084 26.5,38.076331 Z" fill="#000000" />\n    <circle class="icon-solid" cx="24.5" cy="35" fill="#000000" r="1.5" />\n  </g>\n</svg>\n'}),define("text!res/symbols/fmt-with-span.svg",[],function(){return'<svg\n  width="100%"\n  viewBox="0 0 190 68"\n  version="1.1"\n  preserveAspectRatio="xMinYMin meet"\n  xmlns="http://www.w3.org/2000/svg"\n>\n  <foreignObject width="190" height="68" xmlns="http://www.w3.org/1999/xhtml" style="text-align:center;">\n    <div>\n      <b></b>\n      <span></span>\n    </div>\n  </foreignObject>\n</svg>\n'}),define("text!res/symbols/star-rating.svg",[],function(){return'<svg viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n  <defs>\n    <clipPath class="star-clip"><rect x="0" y="0" height="16" width="16" /></clipPath>\n  </defs>\n  <polygon class="star-bg" fill="#333333" points="8 12 3.29771798 14.472136 4.19577393 9.23606798 0.39154787 5.52786405 5.64885899 4.76393202 8 0 10.351141 4.76393202 15.6084521 5.52786405 11.8042261 9.23606798 12.702282 14.472136"></polygon>\n  <polygon class="star-fg" fill="#000000" points="8 12 3.29771798 14.472136 4.19577393 9.23606798 0.39154787 5.52786405 5.64885899 4.76393202 8 2.27373675e-13 10.351141 4.76393202 15.6084521 5.52786405 11.8042261 9.23606798 12.702282 14.472136"></polygon>\n</svg>\n'}),define("text!res/symbols/the-end.svg",[],function(){return'<svg version="1.1" viewBox="0 0 200 100" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M140.28182,46.1026361 L140.917846,46.0556775 L141.514805,46.0167247 L142.073251,45.986567 L142.593739,45.9659939 L143.076825,45.9557947 C145.089959,45.9352153 146.065208,46.2290711 146.205746,47.1264205 L146.218269,47.2326555 L146.226388,47.3273261 C146.268718,48.008962 145.968972,48.3023576 145.12147,48.6341425 L144.777579,48.7611947 L144.260629,48.9361374 L143.874234,49.0581265 L143.262248,49.2393235 L142.03141,49.5820163 L137.51715,50.79979 L135.52513,51.3486198 L133.762108,51.8489484 L132.433315,52.2389374 L131.442709,52.5377595 L129.723817,53.0713278 L128.608145,53.4256979 L127.854278,53.6545466 L127.085632,53.8951662 L125.900136,54.2797462 L125.08491,54.5529531 L123.819222,54.9897994 L122.49551,55.4612557 L121.577131,55.7959913 L120.627459,56.1479148 L119.139461,56.709607 L118.101925,57.1076598 L116.471809,57.7419316 L114.148982,58.6608452 L98.9115033,64.8221723 L94.8468117,66.445108 L93.8602517,66.8332174 L92.6286253,67.3124322 L90.2163476,68.2392731 C89.8191278,68.3905307 89.4240422,68.5402785 89.030672,68.6886633 C80.5580912,71.8614833 73.0667032,74.2371227 66.2954236,75.8270716 C59.0426093,77.5344987 52.3143046,78.3783956 46.6258023,78.2828316 C41.501664,78.2185455 36.92498,77.5123592 33.2394884,76.3938812 L32.6915006,76.2239131 L32.1687603,76.0539045 L31.6723433,75.88362 C31.5918605,75.8552032 31.5125194,75.826765 31.4343422,75.7983007 L30.9794272,75.6271611 C30.8325645,75.5699835 30.6905372,75.512662 30.5535247,75.4551571 L30.1577106,75.2820534 C28.636065,74.5871255 27.8623569,73.8601554 28.1463965,73.0333536 L28.2167121,72.8569946 C28.4439226,72.3070141 28.8305863,72.1698913 29.4775292,72.1617631 L29.6314899,72.162048 L29.9951268,72.1757199 L30.3422652,72.2027955 L30.9459241,72.2668902 L33.6107885,72.5911825 L33.9697652,72.631644 C38.0686335,73.0869669 41.990663,73.2349317 46.4905078,72.9365252 C51.7244265,72.6106781 57.9451513,71.4903827 64.7327163,69.6504335 L65.385327,69.4725008 L66.7076416,69.1022207 L68.0540527,68.7123971 C68.2805496,68.6457763 68.5081158,68.5783249 68.7367839,68.510035 L70.1222768,68.0901676 L71.5357823,67.6497853 L72.978867,67.1884995 L74.4530973,66.7059217 C74.7014848,66.6236962 74.9512354,66.5405673 75.2023815,66.4565269 L76.7262673,65.9412826 L78.2852149,65.4037748 L79.8807908,64.843615 L81.5145614,64.2604147 C81.7901264,64.161273 82.0673482,64.0611551 82.3462593,63.9600529 L84.0402591,63.3415633 L85.7763699,62.6990617 L105.335619,55.2475478 L108.730706,53.9776938 L109.848701,53.5702085 L111.256403,53.0643687 L112.621296,52.5818069 L113.944989,52.1221649 C114.162261,52.047448 114.377883,51.9736712 114.591888,51.900827 L115.856796,51.4748935 L117.084523,51.0709848 L118.276677,50.6887427 L119.434866,50.3278092 L120.560699,49.9878262 C120.930762,49.8779505 121.295701,49.7715069 121.655783,49.6684357 L122.721725,49.3692796 L123.760135,49.0899998 C123.930998,49.0450897 124.100781,49.0009928 124.269517,48.9577017 L125.269642,48.707565 C125.434325,48.6674673 125.598029,48.6281604 125.760786,48.589637 L126.726244,48.3678379 C126.885351,48.3324183 127.043578,48.2977672 127.20096,48.2638772 C132.144644,47.1036799 136.67341,46.3816165 140.28182,46.1026361 Z M174.646292,55.1330403 C174.490203,55.2832317 174.302832,55.3682539 174.1081,55.401258 L173.990569,55.4149234 L173.872419,55.4167304 C173.722747,55.4117617 173.596326,55.3822162 173.457265,55.3346723 L173.343728,55.2930585 L173.214212,55.2391026 L172.425397,54.8837423 L171.995109,54.7029419 C171.786301,54.6194041 171.578754,54.5430482 171.335377,54.4598718 C171.045338,54.3607478 170.745267,54.2688375 170.434898,54.1851907 C167.829746,53.4912256 164.822703,53.8743243 162.313907,55.7966713 C159.08579,58.2534411 157.404687,63.4031899 158.954026,67.9745209 C159.784547,70.4660826 161.432668,72.5663199 163.817489,74.0495228 L164.147251,74.2479319 C166.877824,75.9276129 170.05832,76.5928475 173.114454,76.0036252 C179.75408,74.819794 185.746194,68.0028814 186.690218,60.214183 C187.202851,56.2071029 186.195945,52.0689956 183.822458,48.7176248 C181.240413,44.9954187 177.73376,41.9270978 173.610627,39.8346241 C165.809825,35.831164 155.62229,34.8464413 143.606121,36.3843784 C133.66329,37.6764907 123.143302,40.5289679 111.793042,44.8546901 L109.4519,45.7549702 L105.393486,47.3334256 L93.7290025,51.9013877 L90.6581817,53.0890787 L87.757093,54.1943554 L84.5323868,55.389331 L83.1203491,55.8970144 L81.4951879,56.4681756 L79.725804,57.0752636 L77.8527626,57.7049731 C65.1052358,61.9564776 54.8686057,64.2223729 45.1110003,64.5176438 C39.4660232,64.6667681 34.1302622,64.1319869 29.1809875,62.8705787 C23.7914306,61.4991576 19.1370125,59.2308916 15.619719,56.0482105 L15.2472357,55.7037091 C11.3833507,52.1423236 8.68914221,47.6080502 7.66493838,42.8375612 C7.14043311,40.3635394 7.05119134,37.904694 7.41941477,35.5297465 C7.7622904,33.3937999 8.45699723,31.3280454 9.45378861,29.4294058 L9.70925109,28.9582836 L9.90717982,28.611905 C14.2711771,21.1435955 22.9121972,17.1446936 30.2587798,18.9108078 C33.6182837,19.6664765 36.5749531,21.5459162 38.7873901,24.1097144 C40.6968401,26.3423941 41.9130587,28.9839329 42.3476173,31.6451915 C42.7430168,34.041735 42.4781072,36.4058649 41.6645245,38.3841882 C40.9802497,40.0397852 39.9907614,41.4019699 38.8172312,42.4595772 C36.8138204,44.2185913 34.8110681,45.2076929 34.1524134,44.0435514 L34.125,43.99 L34.1019318,43.9492273 C33.9574093,43.6596161 33.9689415,43.3759826 34.0672975,43.1238948 L34.114564,43.017863 L34.171251,42.9161412 C34.2458975,42.7944696 34.3308269,42.6972761 34.4430518,42.5877066 L34.5147156,42.5196295 L34.9952701,42.0991388 C35.6380732,41.5419365 36.1435733,41.0534808 36.721273,40.3882861 C38.4383569,38.4380181 39.325347,35.5341729 38.5811907,32.3857846 C38.1304245,30.4440224 37.1117733,28.5297216 35.619829,26.957613 C33.9008967,25.1582454 31.7010894,23.8944512 29.2940097,23.4576787 C23.9663547,22.3613948 17.4129461,25.7304006 14.4113995,31.5146144 C12.7897924,34.5675523 12.3281113,38.1423249 13.1830987,41.5921344 C13.9978862,45.0201385 16.0219897,48.3528213 18.9046342,51.0172997 L19.2410371,51.3217415 C22.0762893,53.9089425 25.9429448,55.7485439 30.6714716,56.883268 C35.0251134,57.9272392 39.8326975,58.3448765 44.8982632,58.1509704 C51.590641,57.8728558 58.6236802,56.5757593 66.82644,54.2181286 L68.3783675,53.7636346 C69.1613876,53.5301633 69.9551437,53.2873482 70.7603192,53.0351548 L72.3860982,52.5182538 C72.9332348,52.3417786 73.4856489,52.1611252 74.0435432,51.9762835 L75.7338684,51.409183 L76.4305152,51.1710943 L77.8389669,50.6824939 L79.2728919,50.1755619 L80.7386057,49.6481777 L82.2424235,49.0982204 L83.7906606,48.5235694 L85.3896323,47.9221039 L87.045654,47.2917031 L90.7505396,45.8591675 L104.103441,40.601329 L107.132237,39.4236039 L108.279357,38.9817897 C120.48457,34.2539899 131.88228,31.15034 142.785302,29.7899191 C148.961663,29.0333705 154.708118,28.9019763 160.13568,29.4686528 C166.206918,30.0974824 171.765826,31.6544333 176.54984,34.1892168 C181.528219,36.7770177 185.834903,40.6498783 188.900644,45.217632 C192.070091,49.8010939 193.380597,55.6048808 192.572431,60.9979282 C191.052103,71.3294563 183.281487,79.7663335 174.012928,81.2755265 C169.664088,82.0003331 165.0952,80.9001829 161.500149,78.5015781 C158.100097,76.4078127 155.484173,72.9417778 154.515022,69.3488306 C153.544104,65.9925733 153.733772,62.4385846 154.929316,59.3571462 C156.045041,56.5227679 157.86167,54.1707647 160.067007,52.6788273 C162.04559,51.332333 164.289814,50.6424998 166.509898,50.5587927 C168.279412,50.4895132 169.914019,50.7995528 171.380501,51.3923951 C173.840435,52.4240845 175.693761,53.9307008 174.751494,55.0196754 L174.646292,55.1330403 Z" fill="#000000" fill-rule="nonzero" />\n  </g>\n</svg>\n'}),define("text!res/symbols/limelight.svg",[],function(){return'<svg version="1.1" viewBox="0 0 128 128" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <defs>\n    <linearGradient id="limelight-mask-gradient" x1="78.838577%" x2="50%" y1="35.4321889%" y2="100%">\n      <stop offset="0%" stop-color="#FFFFFF" stop-opacity="0" />\n      <stop offset="100%" stop-color="#FFFFFF" />\n    </linearGradient>\n  </defs>\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <ellipse cx="64.4848261" cy="116.383334" fill="#FFFFFF" rx="36.637176" ry="11.6166655" />\n    <path d="M64.4848261,128 C84.7189797,128 101.122002,122.799042 101.122002,116.383334 C101.122002,116.226224 110.228789,89.0863429 128.442361,34.963691 L103.720873,18.9820618 C53.1387245,79.6391054 27.8476501,112.106196 27.8476501,116.383334 C27.8476501,122.799042 44.2506725,128 64.4848261,128 Z" fill="url(#limelight-mask-gradient)" opacity="0.7" />\n    <path d="M37.0795374,128 C57.3136909,128 73.7167133,122.799042 73.7167133,116.383334 C73.7167133,116.226224 82.8234998,89.0863429 101.037073,34.963691 L76.3155845,18.9820618 C25.7334358,79.6391054 0.442361415,112.106196 0.442361415,116.383334 C0.442361415,122.799042 16.8453838,128 37.0795374,128 Z" fill="url(#limelight-mask-gradient)" opacity="0.7" transform="translate(50.739717, 73.491031) scale(-1, 1) translate(-50.739717, -73.491031) " />\n  </g>\n</svg>\n';
}),define("text!res/symbols/tutorial-balloon-large.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <defs>\n    <radialGradient cx="65.4735658%" cy="31.1402867%" fx="65.4735658%" fy="31.1402867%" gradientTransform="translate(0.654736,0.311403),scale(1.000000,0.829115),rotate(103.125525),translate(-0.654736,-0.311403)" id="radialGradient-1" r="54.3308717%">\n      <stop offset="0%" stop-color="#999999" />\n      <stop offset="100%" stop-color="#000000" />\n    </radialGradient>\n  </defs>\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M32.5767784,3.24963444 L32.2865213,3.25417544 L31.966161,3.26495607 L31.3875996,3.29763072 L30.9659711,3.33036321 L30.5125213,3.37323612 L30.0295017,3.42713627 L29.5190931,3.49293682 L28.9834275,3.57149863 L28.4246027,3.66367072 L27.8446911,3.77029022 L27.2457454,3.892182 L26.6298025,4.03015817 L25.9857746,4.18850489 L25.6784385,4.269024 L25.0219025,4.45277387 L24.5278563,4.60150864 L24.0290262,4.76115886 L23.5262403,4.93203689 L23.0203206,5.11445043 L22.5179427,5.30631484 L21.8807849,5.56598209 L21.2366232,5.84807931 L20.726573,6.08609631 L20.2177656,6.33727006 L19.7044221,6.60549683 L19.3260027,6.81315704 L18.9561484,7.02464588 L18.4440342,7.33271405 L18.2099879,7.47927121 L17.7060152,7.80918445 L17.4247349,8.00185559 C11.989476,11.7848325 8.75722497,17.5765381 8.42802106,25.955337 C8.1880424,32.0632018 10.9167335,38.0690279 16.1344886,44.141988 L16.4940961,44.5561594 L17.1618294,45.3038789 L17.4900207,45.6619497 L18.1539533,46.3686239 L18.8269465,47.0631523 L19.5130941,47.7509382 L19.8553184,48.0870136 L20.1905744,48.4121157 L21.0535674,49.2309232 L21.9183996,50.0281836 L22.8566588,50.8699054 L23.7900384,51.6862752 L24.7143338,52.4768414 L25.625379,53.2412061 L26.5148138,53.9755803 L28.2390967,55.3748218 L30.5930844,57.2681892 L30.855,57.482 L34.5127663,54.9788202 L35.9076743,54.0105168 L36.8634864,53.3349993 L37.8368076,52.6343911 L38.8266149,51.9063911 L39.5730218,51.3456198 L40.322719,50.7709347 L41.0738992,50.1824247 L41.82475,49.5801925 L42.5734554,48.9643544 L43.3181979,48.3350408 L44.0717071,47.6794454 C44.4047138,47.3852875 44.7312221,47.0907456 45.0465252,46.8001533 L45.5104876,46.3677689 L46.2296835,45.6777785 L46.5718481,45.340601 L47.2709355,44.6312049 L47.6374086,44.2476192 C52.6580111,38.9344487 55.4604272,33.5125516 55.6844007,27.8120452 C56.0176671,19.3298476 53.1796585,13.2589116 47.9685553,9.08071188 L47.6710581,8.84622796 L47.1821087,8.47693371 L46.7127878,8.1406808 L46.213033,7.80154807 L45.9862558,7.65320667 L45.3686052,7.26760362 L44.7404874,6.90026072 L44.2405676,6.62432148 L43.7395972,6.36156976 L43.2439085,6.11433953 L42.6249403,5.82256368 L41.8288786,5.47373156 L41.5047676,5.33957117 L41.1952988,5.21547404 L40.5431618,4.96721659 L40.2394612,4.85718317 L39.6030154,4.63845598 L39.3074385,4.5418837 L38.5652093,4.3135716 L37.6892809,4.06970255 L36.9919922,3.89479128 L36.4734844,3.77557433 L35.7165381,3.61894946 L35.2529742,3.53328853 L34.8296472,3.46215511 L34.2419631,3.37587678 L33.7263097,3.31376144 L33.4679039,3.28779278 L33.0179784,3.25659041 L32.8222575,3.25086246 L32.5767784,3.24963444 Z" fill="#000000" fill-rule="nonzero" />\n    <path d="M31.0056203,55.25 L32.3677229,55.7622279 C32.7453761,55.904247 33,56.302032 33,56.75 C33,57.1642136 32.7015232,57.5 32.3333333,57.5 L29.6666667,57.5 C29.2984768,57.5 29,57.1642136 29,56.75 C29,56.3021823 29.2548938,55.9046827 29.6326326,55.7634276 L31.0056203,55.25 Z M32.6975257,5.28025765 L32.9070445,5.28568484 L33.3603881,5.31519447 L33.6375335,5.34178212 L34.1117161,5.39829112 L34.6511201,5.47671207 L35.0442147,5.5422543 L35.4621833,5.61916762 L36.1321757,5.75728675 L36.6051309,5.86548453 L37.2230129,6.02001272 L37.999372,6.23540875 L37.999372,6.23540875 L38.1321069,6.27462873 L38.6716512,6.44137032 L38.9462265,6.53080096 L39.5039549,6.72219 L39.7866966,6.82431165 L40.3589069,7.04181733 L40.6479641,7.1573646 L40.6479641,7.1573646 L40.9387152,7.27755032 L41.6366759,7.58289593 L41.6366759,7.58289593 L42.1996241,7.84736283 L42.6516374,8.07217406 L43.1043315,8.30906575 L43.5569769,8.55832736 L44.1216041,8.8877406 L44.1216041,8.8877406 L44.6835909,9.23749956 L44.9073272,9.38322659 L45.3524839,9.68486271 L45.573722,9.84084417 L45.573722,9.84084417 L45.7939449,10.0003162 L46.2309808,10.3298764 C50.5043525,13.6408594 54.0301014,19.0399025 53.6872676,27.7656035 C53.4589414,33.576894 50.380731,38.5651832 46.4613292,42.7129821 L46.1501917,43.0386935 L45.5494105,43.6486907 L45.2450468,43.9489427 L44.6293182,44.5399452 C44.215973,44.9297218 43.7972447,45.3110454 43.3751498,45.6838983 L42.7397347,46.2368226 L42.100782,46.7770278 L41.4598041,47.3045007 L40.8183133,47.8192282 L40.177822,48.3211972 L39.5398425,48.8103944 L38.9058871,49.2868066 L38.0694868,49.9021125 L37.2465138,50.4946351 L36.440553,51.0643431 L35.2713512,51.8760594 L31.8640517,54.2091839 L31.2999466,54.6067877 C31.1109492,54.751559 30.9831224,54.8173909 30.9164662,54.8042835 L30.8882356,54.7911515 L30.3793814,54.3638423 L29.5352038,53.6731423 L27.5998166,52.116558 L26.1652607,50.952453 L25.4154072,50.3334229 L24.6485984,49.6901576 L23.8684056,49.0229696 L23.0784,48.332171 L22.282153,47.6180744 L21.5454603,46.9392059 L21.5454603,46.9392059 L20.8092973,46.2410371 L20.5156078,45.9564203 L20.5156078,45.9564203 L20.2226302,45.6687703 L19.639528,45.0844334 L19.0614246,44.4881518 L18.4897536,43.880051 L18.2007802,43.5650133 L18.2007802,43.5650133 L17.6297505,42.925857 C13.4788156,38.1945612 10.1745042,32.495556 10.4271258,26.0659079 C10.7580946,17.6421893 14.4401412,12.5921751 18.7613461,9.58458724 L19.006607,9.41651878 L19.4587345,9.11999248 L19.6861669,8.97704084 L20.1433499,8.70155492 L20.4879358,8.50389368 L20.4879358,8.50389368 L20.8336633,8.31375236 L21.2959205,8.0716883 L21.7590342,7.84241709 L22.222334,7.62560964 L22.8006993,7.37162615 L22.8006993,7.37162615 L23.3769986,7.13596036 L23.8356707,6.96018454 L24.2915122,6.79539159 L24.7438529,6.64125245 L25.1920222,6.49743802 L25.6353499,6.36361922 L26.2177634,6.20017411 L26.5047988,6.12465216 L27.0695341,5.9855219 L27.6204977,5.86162648 L28.1561004,5.75218584 L28.6747534,5.65641993 L29.1748676,5.57354869 L29.6548539,5.50279208 L30.1131233,5.44337004 L30.5480868,5.39450252 L30.9581554,5.35540947 L31.34174,5.32531083 L31.8639834,5.29532102 L32.1744061,5.28429569 L32.4527832,5.27953458 L32.6975257,5.28025765 Z" fill="url(#radialGradient-1)" />\n  </g>\n</svg>\n'}),define("text!res/symbols/tutorial-balloon-small.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <defs>\n    <radialGradient cx="65.4735658%" cy="31.1402867%" fx="65.4735658%" fy="31.1402867%" gradientTransform="translate(0.654736,0.311403),scale(1.000000,0.777036),rotate(102.327073),translate(-0.654736,-0.311403)" id="radialGradient-1" r="57.790149%">\n      <stop offset="0%" stop-color="#999999" />\n      <stop offset="100%" stop-color="#000000" />\n    </radialGradient>\n  </defs>\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M32.8296435,0.132942301 L33.0827145,0.139497631 L33.6302935,0.175141361 L33.9650485,0.207255719 L34.5377983,0.275511107 L35.189327,0.370233237 L35.6641332,0.449399579 L36.1689839,0.542300683 L36.9782461,0.709130313 L37.5495133,0.839818913 L38.295833,1.02646851 L39.233572,1.28663839 L39.233572,1.28663839 L39.3938982,1.33401094 L40.0455964,1.53541271 L40.3772469,1.64343308 L41.0509089,1.87460571 L41.3924235,1.99795515 L42.0835778,2.26067322 L42.4327207,2.40023903 L42.4327207,2.40023903 L42.7839095,2.54540747 L43.6269537,2.91422454 L43.6269537,2.91422454 L44.3069205,3.23366555 L44.8528928,3.50520776 L45.3996873,3.79134155 L45.9464231,4.09241659 L46.628418,4.49030418 L46.628418,4.49030418 L47.3072237,4.91276669 L47.5774675,5.08878565 L48.1151579,5.45312216 L48.3823842,5.64152712 L48.3823842,5.64152712 L48.6483843,5.83414817 L49.1762658,6.23221332 C54.3379332,10.2314425 58.596571,16.7527719 58.1824733,27.2922637 C57.9066854,34.3115332 54.1886147,40.3367263 49.4544961,45.3467184 L49.0786833,45.7401345 L48.3530191,46.4769304 L47.985388,46.8395951 L47.2416694,47.5534479 C46.7424031,48.0242465 46.2366347,48.4848349 45.7268,48.9351919 L44.9593027,49.6030512 L44.1875324,50.2555476 L43.413316,50.892665 L42.63848,51.5143877 L41.8648513,52.1206998 L41.0942565,52.7115852 L40.3285222,53.2870281 L39.3182614,54.0302362 L38.324219,54.7459251 L37.350725,55.4340569 L35.938484,56.4145028 L31.8229173,59.2326084 L31.141553,59.712861 C30.9132692,59.8877256 30.7588713,59.9672419 30.6783594,59.9514098 L30.6442606,59.9355481 L30.0296321,59.4194151 L29.0099773,58.5851411 L26.6722858,56.7049933 L24.9395321,55.2989085 L24.0338083,54.5512021 L23.1076048,53.7742228 L22.1652351,52.9683479 L21.211013,52.1339547 L20.249252,51.2714206 L19.3594248,50.4514373 L19.3594248,50.4514373 L18.4702374,49.6081417 L18.1154992,49.2643623 L18.1154992,49.2643623 L17.7616211,48.9169192 L17.0573109,48.2111176 L16.3590384,47.4908884 L15.6685355,46.7563831 L15.319494,46.3758592 L15.319494,46.3758592 L14.6297657,45.603843 C9.61598577,39.8890639 5.62481507,33.0054202 5.92994847,25.2392564 C6.32971498,15.0645193 10.7771399,8.96477066 15.9965834,5.33200267 L16.2928261,5.12899822 L16.8389362,4.7708337 L17.1136444,4.59816705 L17.665861,4.26541651 L18.0820751,4.02666791 L18.0820751,4.02666791 L18.4996682,3.79700237 L19.0580137,3.50462102 L19.6173938,3.22769175 L20.1769986,2.96581705 L20.8755873,2.65903861 L20.8755873,2.65903861 L21.5716805,2.37438553 L22.1256957,2.1620716 L22.676292,1.96302355 L23.2226596,1.77684387 L23.7639888,1.60313507 L24.29947,1.44149967 L25.0029484,1.24407962 L25.3496492,1.15285909 L26.0317747,0.984808162 L26.6972657,0.835158893 L27.344203,0.702969088 L27.9706671,0.587296544 L28.5747388,0.487199063 L29.1544987,0.401734444 L29.7080275,0.329960486 L30.2334059,0.270934989 L30.7287144,0.223715754 L31.1920338,0.187360579 L31.8228348,0.151136868 L32.1977843,0.137819719 L32.5340269,0.13206893 L32.8296435,0.132942301 Z" fill="#000000" />\n    <path d="M31.0112406,56.5 L33.7354457,57.5244558 C34.4907522,57.8084939 35,58.604064 35,59.5 C35,60.3284271 34.4030463,61 33.6666667,61 L28.3333333,61 C27.5969537,61 27,60.3284271 27,59.5 C27,58.6043645 27.5097876,57.8093654 28.2652652,57.5268552 L31.0112406,56.5 Z M32.6975257,5.28025765 L32.9070445,5.28568484 L33.3603881,5.31519447 L33.6375335,5.34178212 L34.1117161,5.39829112 L34.6511201,5.47671207 L35.0442147,5.5422543 L35.4621833,5.61916762 L36.1321757,5.75728675 L36.6051309,5.86548453 L37.2230129,6.02001272 L37.999372,6.23540875 L37.999372,6.23540875 L38.1321069,6.27462873 L38.6716512,6.44137032 L38.9462265,6.53080096 L39.5039549,6.72219 L39.7866966,6.82431165 L40.3589069,7.04181733 L40.6479641,7.1573646 L40.6479641,7.1573646 L40.9387152,7.27755032 L41.6366759,7.58289593 L41.6366759,7.58289593 L42.1996241,7.84736283 L42.6516374,8.07217406 L43.1043315,8.30906575 L43.5569769,8.55832736 L44.1216041,8.8877406 L44.1216041,8.8877406 L44.6835909,9.23749956 L44.9073272,9.38322659 L45.3524839,9.68486271 L45.573722,9.84084417 L45.573722,9.84084417 L45.7939449,10.0003162 L46.2309808,10.3298764 C50.5043525,13.6408594 54.0301014,19.0399025 53.6872676,27.7656035 C53.4589414,33.576894 50.380731,38.5651832 46.4613292,42.7129821 L46.1501917,43.0386935 L45.5494105,43.6486907 L45.2450468,43.9489427 L44.6293182,44.5399452 C44.215973,44.9297218 43.7972447,45.3110454 43.3751498,45.6838983 L42.7397347,46.2368226 L42.100782,46.7770278 L41.4598041,47.3045007 L40.8183133,47.8192282 L40.177822,48.3211972 L39.5398425,48.8103944 L38.9058871,49.2868066 L38.0694868,49.9021125 L37.2465138,50.4946351 L36.440553,51.0643431 L35.2713512,51.8760594 L31.8640517,54.2091839 L31.2999466,54.6067877 C31.1109492,54.751559 30.9831224,54.8173909 30.9164662,54.8042835 L30.8882356,54.7911515 L30.3793814,54.3638423 L29.5352038,53.6731423 L27.5998166,52.116558 L26.1652607,50.952453 L25.4154072,50.3334229 L24.6485984,49.6901576 L23.8684056,49.0229696 L23.0784,48.332171 L22.282153,47.6180744 L21.5454603,46.9392059 L21.5454603,46.9392059 L20.8092973,46.2410371 L20.5156078,45.9564203 L20.5156078,45.9564203 L20.2226302,45.6687703 L19.639528,45.0844334 L19.0614246,44.4881518 L18.4897536,43.880051 L18.2007802,43.5650133 L18.2007802,43.5650133 L17.6297505,42.925857 C13.4788156,38.1945612 10.1745042,32.495556 10.4271258,26.0659079 C10.7580946,17.6421893 14.4401412,12.5921751 18.7613461,9.58458724 L19.006607,9.41651878 L19.4587345,9.11999248 L19.6861669,8.97704084 L20.1433499,8.70155492 L20.4879358,8.50389368 L20.4879358,8.50389368 L20.8336633,8.31375236 L21.2959205,8.0716883 L21.7590342,7.84241709 L22.222334,7.62560964 L22.8006993,7.37162615 L22.8006993,7.37162615 L23.3769986,7.13596036 L23.8356707,6.96018454 L24.2915122,6.79539159 L24.7438529,6.64125245 L25.1920222,6.49743802 L25.6353499,6.36361922 L26.2177634,6.20017411 L26.5047988,6.12465216 L27.0695341,5.9855219 L27.6204977,5.86162648 L28.1561004,5.75218584 L28.6747534,5.65641993 L29.1748676,5.57354869 L29.6548539,5.50279208 L30.1131233,5.44337004 L30.5480868,5.39450252 L30.9581554,5.35540947 L31.34174,5.32531083 L31.8639834,5.29532102 L32.1744061,5.28429569 L32.4527832,5.27953458 L32.6975257,5.28025765 Z" fill="url(#radialGradient-1)" />\n  </g>\n</svg>\n'}),define("text!res/symbols/filter-cloud-search-scope-mural.svg",[],function(){return'<svg version="1.1" viewBox="0 0 128 128" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M0,128 L0,1.8663515 C1.08684968,1.8663515 2.35151605,1.24423433 3.79399912,0 C5.04270458,1.24423433 6.29048887,1.8663515 7.537352,1.8663515 C8.78421512,1.8663515 10.0301751,1.24423433 11.2752319,0 C12.5345618,1.24423433 13.7935639,1.8663515 15.0522382,1.8663515 C16.3109124,1.8663515 17.5692653,1.24423433 18.8272969,0 C20.0963913,1.24423433 21.3515183,1.8663515 22.5926777,1.8663515 C23.8338371,1.8663515 25.0612995,1.24423433 26.2750649,0 C27.4626115,1.24423433 28.6881212,1.8663515 29.951594,1.8663515 C31.2150667,1.8663515 32.5157418,1.24423433 33.8536193,0 C34.9949323,1.20275986 36.1612475,1.82418578 37.3525649,1.86427778 L37.4758938,1.8663515 C38.5627434,1.8663515 39.8274098,1.24423433 41.2698929,0 C42.5185984,1.24423433 43.7663826,1.8663515 45.0132458,1.8663515 C46.2601089,1.8663515 47.5060688,1.24423433 48.7511256,0 C50.0104556,1.24423433 51.2694577,1.8663515 52.5281319,1.8663515 C53.7868062,1.8663515 55.0451591,1.24423433 56.3031906,0 C57.5722851,1.24423433 58.8274121,1.8663515 60.0685715,1.8663515 C61.3097309,1.8663515 62.5371933,1.24423433 63.7509586,0 C64.9385053,1.24423433 66.164015,1.8663515 67.4274878,1.8663515 C68.6909605,1.8663515 69.9916356,1.24423433 71.3295131,0 C72.4708261,1.20275986 73.6371413,1.82418578 74.8284586,1.86427778 L74.9517875,1.8663515 C76.0493981,1.8663515 77.3265859,1.24423433 78.783351,0 C80.0444199,1.24423433 81.3045585,1.8663515 82.5637668,1.8663515 C83.8229751,1.8663515 85.0812713,1.24423433 86.3386554,0 C87.6104539,1.24423433 88.8819214,1.8663515 90.1530578,1.8663515 C91.4241941,1.8663515 92.695006,1.24423433 93.9654933,0 C95.247153,1.24423433 96.514707,1.8663515 97.7681551,1.8663515 C99.0216033,1.8663515 100.261219,1.24423433 101.487002,0 C102.686306,1.24423433 103.92395,1.8663515 105.199932,1.8663515 C106.475914,1.8663515 107.789467,1.24423433 109.140591,0 C110.293204,1.20275986 111.471067,1.82418578 112.67418,1.86427778 L112.79873,1.8663515 C113.89634,1.8663515 115.173528,1.24423433 116.630293,0 C117.891362,1.24423433 119.151501,1.8663515 120.410709,1.8663515 C121.669917,1.8663515 122.928214,1.24423433 124.185598,0 C125.033463,0.829489556 126.304931,1.45160672 128,1.8663515 L128,128 L0,128 Z" fill="#000000" />\n  </g>\n</svg>\n'}),define("text!res/symbols/filter-cloud-tag-availability-mural.svg",[],function(){return'<svg version="1.1" viewBox="0 0 128 111" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M113.589724,22.6060693 C121.057236,22.6060693 127.11085,28.659684 127.11085,36.1271961 L127.11085,86.6032453 C127.11085,94.0707575 121.057236,100.124372 113.589724,100.124372 L58.3224492,100.124954 C60.5715568,98.0188935 61.9769931,95.0228102 61.9769931,91.6984696 L61.973749,91.4220948 C61.826958,85.1753828 56.717146,80.1566144 50.4351379,80.1566144 L45.9672815,80.1562479 L45.9677784,75.6892549 C45.9677784,69.3148643 40.8003138,64.1473997 34.4259232,64.1473997 L34.1495483,64.1506437 C30.9355859,64.2261684 28.0466787,65.6154793 25.999126,67.8022772 L26.0000207,36.1271961 C26.0000207,28.659684 32.0536353,22.6060693 39.5211474,22.6060693 L113.589724,22.6060693 Z" fill="#000000" />\n    <path class=" title-status-plus icon-solid" d="M34.4259232,73.1614842 C35.8219724,73.1614842 36.9536939,74.2932057 36.9536939,75.6892549 L36.9536939,89.1706989 L50.4351379,89.1706989 C51.8311871,89.1706989 52.9629086,90.3024204 52.9629086,91.6984696 C52.9629086,93.0945189 51.8311871,94.2262404 50.4351379,94.2262404 L36.9536939,94.2262404 L36.9536939,107.707684 C36.9536939,109.103734 35.8219724,110.235455 34.4259232,110.235455 C33.0298739,110.235455 31.8981524,109.103734 31.8981524,107.707684 L31.8981524,94.2245552 L18.4167084,94.2262404 C17.0206592,94.2262404 15.8889377,93.0945189 15.8889377,91.6984696 C15.8889377,90.3024204 17.0206592,89.1706989 18.4167084,89.1706989 L31.8981524,89.1690137 L31.8981524,75.6892549 C31.8981524,74.2932057 33.0298739,73.1614842 34.4259232,73.1614842 Z" fill="#000000" transform="translate(34.425923, 91.698470) rotate(-360.000000) translate(-34.425923, -91.698470) " />\n    <line class="icon-hollow" opacity="0.7" stroke="#000000" stroke-linecap="round" stroke-width="5.4084507" transform="translate(8.536221, 34.732671) rotate(-360.000000) translate(-8.536221, -34.732671) " x1="3.6056338" x2="13.4668087" y1="35.2508967" y2="34.2144455" />\n    <line class="icon-hollow" opacity="0.7" stroke="#000000" stroke-linecap="round" stroke-width="5.4084507" transform="translate(21.626978, 10.097898) rotate(-360.000000) translate(-21.626978, -10.097898) " x1="18.9997726" x2="24.2541833" y1="5.89349074" y2="14.3023057" />\n    <line class="icon-hollow" opacity="0.7" stroke="#000000" stroke-linecap="round" stroke-width="5.4084507" transform="translate(48.800432, 7.981591) rotate(-360.000000) translate(-48.800432, -7.981591) " x1="51.1307217" x2="46.4701426" y1="3.6056338" y2="12.3575481" />\n  </g>\n</svg>\n'}),define("text!res/symbols/overdrive-logo.svg",[],function(){return'<svg version="1.1" viewBox="0 0 518 135" x="0" xmlns="http://www.w3.org/2000/svg" y="0">\n  <g>\n    <path class="icon-solid" d="M84.3 34.2c21 0 35.6 14.1 31.5 32.6C111.9 84.6 91.3 99 70 99c-21.3 0-35.5-14.4-31.6-32.2 4-18.4 24.8-32.6 45.9-32.6zM72.4 88.3c14.1 0 27.2-10 29.7-21.5 2.6-12-6.3-21.7-20.2-21.7C68 45 54.7 54.8 52.1 66.7c-2.5 11.5 6.1 21.6 20.3 21.6z" fill="#000000" />\n    <path class="icon-solid" d="M118.9 51.1h14.4l6.6 31h.3l19.4-31h14.6l-32.8 46.7H131l-12.1-46.7z" fill="#000000" />\n    <path class="icon-solid" d="M177.4 79.4c-.1 3 3.7 9.6 13.2 9.6 5.9 0 10.8-2.1 14.1-6h14c-5.1 8.4-17.3 16.2-30.4 16.2-16.9 0-26.9-11.1-23.9-24.7 2.9-13.2 17.1-25.1 34.7-25.1 18.2 0 25.9 12.5 23.3 24.3-.5 2.2-1.3 4.1-2 5.6h-43zm32.3-9c.2-7.5-5.5-10.7-12.6-10.7-5.4 0-13.6 2-18.1 10.7h30.7z" fill="#000000" />\n    <path class="icon-solid" d="M231.9 51.1h12.2l-.9 4.1h.2c3.2-3 6.3-5.7 13.2-5.7h1.1l-2.4 10.9c-12.2.4-14 8.4-14.6 11.2l-5.8 26.3h-13.3l10.3-46.8z" fill="#000000" />\n    <path class="icon-solid" d="M264.3 35.5h16.8c18.2 0 25.2 4.1 28.8 7.2 5.9 5 9 14.3 6.9 24.1-2.5 11.2-11.7 22-23.6 26.9-7.5 3.2-17.2 4-25.5 4h-17.1l13.7-62.2zm2.4 51.5h2.9c7.4 0 12.3-.4 18.7-3 8-3.4 13.4-10.5 14.9-17.2 1.3-6.1-.5-11.8-4.5-15.3-4.7-4.4-11.8-5.2-20.4-5.2h-2.6l-9 40.7z" fill="#000000" />\n    <path class="icon-solid" d="M323.9 51.1h12.2l-.9 4.1h.2c3.2-3 6.3-5.7 13.2-5.7h1.1l-2.4 10.9c-12.2.4-14 8.4-14.6 11.2l-5.8 26.3h-13.3l10.3-46.8z" fill="#000000" />\n    <path class="icon-solid" d="M352.9 51.1h13.3l-10.3 46.7h-13.3l10.3-46.7zm3.4-15.6h13.3l-2.3 10.3H354l2.3-10.3z" fill="#000000" />\n    <path class="icon-solid" d="M368.9 51.1h14.4l6.6 31h.3l19.4-31h14.6l-32.8 46.7H381l-12.1-46.7z" fill="#000000" />\n    <path class="icon-solid" d="M428.5 79.4c-.1 3 3.7 9.6 13.2 9.6 5.9 0 10.8-2.1 14.1-6h14c-5.1 8.4-17.3 16.2-30.4 16.2-16.9 0-26.9-11.1-23.9-24.7 2.9-13.2 17.1-25.1 34.7-25.1 18.2 0 25.9 12.5 23.3 24.3-.5 2.2-1.3 4.1-2 5.6h-43zm32.2-9c.2-7.5-5.5-10.7-12.6-10.7-5.4 0-13.6 2-18.1 10.7h30.7z" fill="#000000" />\n    <path class="icon-solid" d="M481.9 49.9c-.5 2.7-3.1 4.9-5.8 4.9-2.8 0-4.5-2.2-4-4.9A6.2 6.2 0 0 1 478 45c2.6 0 4.4 2.3 3.9 4.9zm-8.7 0c-.4 2.1 1 3.8 3.1 3.8s4.1-1.7 4.5-3.8c.4-2.1-.9-3.8-3.1-3.8a4.8 4.8 0 0 0-4.5 3.8zm4.6-2.7c.4 0 2 0 1.7 1.5-.1.6-.5 1.2-1.3 1.4.7.2.8.7.7 1.4-.1.9-.1 1.1-.1 1.3h-1.2c-.1-.2-.1-.3 0-1 .1-.9 0-1.1-.8-1.2h-1l-.4 2.2h-1.1l1-5.6h2.5zm-1.7 2.4h1c.4 0 1.1 0 1.3-.9 0-.6-.4-.6-.8-.6h-1.1l-.4 1.5z" fill="#000000" />\n  </g>\n</svg>\n'}),define("text!res/symbols/store-logo-apple.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M45.6644848,23.2212542 C45.4459077,23.3908399 41.5868918,25.5653049 41.5868918,30.4003806 C41.5868918,35.9929388 46.4973388,37.9714382 46.644313,38.0204296 C46.6217016,38.1410239 45.864219,40.7300316 44.0553053,43.3680308 C42.4423572,45.6894701 40.7578063,48.0071408 38.1951785,48.0071408 C35.6325508,48.0071408 34.973051,46.5185555 32.0147233,46.5185555 C29.1317671,46.5185555 28.106716,48.0561322 25.7626653,48.0561322 C23.4186146,48.0561322 21.7830551,45.9080472 19.9025385,43.270048 C17.7243049,40.1722832 15.9643826,35.359819 15.9643826,30.7923119 C15.9643826,23.4662113 20.7278554,19.5808154 25.4159568,19.5808154 C27.9069817,19.5808154 29.983464,21.2163749 31.5474206,21.2163749 C33.0360059,21.2163749 35.3574451,19.4828325 38.19141,19.4828325 C39.2654525,19.4828325 43.1244684,19.5808154 45.6644848,23.2212542 Z M36.8460304,16.3812992 C38.0180557,14.9906968 38.8471412,13.0611888 38.8471412,11.1316809 C38.8471412,10.8641124 38.8245298,10.5927753 38.7755384,10.3741982 C36.8686418,10.4458011 34.5999625,11.6442064 33.2319715,13.2307745 C32.157929,14.4517912 31.1554893,16.3812992 31.1554893,18.3371872 C31.1554893,18.6311357 31.2044807,18.9250841 31.2270921,19.0192984 C31.3476864,19.0419098 31.543652,19.0682898 31.7396177,19.0682898 C33.4505486,19.0682898 35.6024022,17.9226445 36.8460304,16.3812992 Z" fill="#000000" fill-rule="nonzero" />\n  </g>\n</svg>\n'}),define("text!res/symbols/store-logo-google.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path d="M34.4684622,31.244443 L20.3029225,46.0855376 C20.6252569,47.227985 21.4575555,48.1572976 22.5576988,48.6031343 C23.6578421,49.0489709 24.90229,48.9612667 25.9290273,48.365535 L41.8678984,39.2877674 L34.4684622,31.244443 Z" fill="#EA4335" fill-rule="nonzero" />\n    <path d="M48.7923352,28.721668 L41.8995651,24.7738946 L34.1412404,31.5822204 L41.9312317,39.2666563 L48.7712241,35.3611051 C50.0063256,34.714432 50.7803075,33.4355393 50.7803075,32.0413865 C50.7803075,30.6472338 50.0063256,29.3683411 48.7712241,28.721668 L48.7923352,28.721668 Z" fill="#FBBC04" fill-rule="nonzero" />\n    <path d="M20.3029225,17.9233467 C20.2172947,18.2398955 20.1746896,18.5665348 20.1762143,18.8944567 L20.1762143,45.1144275 C20.1771124,45.4421935 20.2196765,45.7685181 20.3029225,46.0855376 L34.9540172,31.6244426 L20.3029225,17.9233467 Z" fill="#4285F4" fill-rule="nonzero" />\n    <path d="M34.5740177,32.0044421 L41.8995651,24.7738946 L25.981805,15.6539048 C25.3829739,15.3031867 24.7018913,15.1174369 24.0079183,15.1155644 C22.2855567,15.1121589 20.7713645,16.2553524 20.3029225,17.9127912 L34.5740177,32.0044421 Z" fill="#34A853" fill-rule="nonzero" />\n  </g>\n</svg>\n'}),define("text!res/patterns/bank-note.svg",[],function(){return'<svg width="100px" height="20px" viewBox="0 0 100 20" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n  <g class="pattern-solid" fill="#FFF" fill-rule="evenodd">\n    <path d="M21.1841339,20 C21.5411448,19.869748 21.9037256,19.7358773 22.272392,19.5983261 C22.6346445,19.4631679 23.8705367,18.9999982 24.0399055,18.9366758 C33.6397477,15.3475548 39.6469349,14 50,14 C60.2711361,14 65.3618399,15.2217689 74.6286093,18.9284767 C75.584355,19.310775 76.4978747,19.6675274 77.3787841,20 L83.604005,20 C81.0931362,19.2694473 78.4649665,18.3089537 75.3713907,17.0715233 C65.8881601,13.2782311 60.5621972,12 50,12 C39.3741437,12 33.144814,13.3973866 23.3395101,17.0633242 C23.1688625,17.1271247 21.9338538,17.5899633 21.5732596,17.7245028 C19.0984715,18.6478581 16.912678,19.3994574 14.8494171,20 L21.1841339,20 L21.1841339,20 Z M21.1841339,0 C13.2575214,2.89194861 8.07672845,4 7.87150385e-14,4 L7.81597009e-14,4 L0,2 C5.74391753,2 9.9514017,1.4256397 14.8494171,1.40165657e-15 L21.1841339,6.9388939e-17 L21.1841339,0 Z M77.3787841,2.21705987e-12 C85.238555,2.9664329 90.5022896,4 100,4 L100,2 C93.1577329,2 88.6144135,1.4578092 83.604005,1.04805054e-13 L77.3787841,0 L77.3787841,2.21705987e-12 Z M7.87150385e-14,14 C8.44050043,14 13.7183277,12.7898887 22.272392,9.59832609 C22.6346445,9.46316794 23.8705367,8.99999822 24.0399055,8.9366758 C33.6397477,5.34755477 39.6469349,4 50,4 C60.2711361,4 65.3618399,5.2217689 74.6286093,8.92847669 C84.1118399,12.7217689 89.4378028,14 100,14 L100,12 C89.7288639,12 84.6381601,10.7782311 75.3713907,7.07152331 C65.8881601,3.2782311 60.5621972,2 50,2 C39.3741437,2 33.144814,3.39738661 23.3395101,7.0633242 C23.1688625,7.12712472 21.9338538,7.58996334 21.5732596,7.72450279 C13.2235239,10.8398294 8.16350991,12 0,12 L7.81597009e-14,14 L7.87150385e-14,14 L7.87150385e-14,14 Z" />\n  </g>\n</svg>\n'}),define("text!res/patterns/floor-tile.svg",[],function(){return'<svg height="30" viewBox="0 0 30 30" width="30" xmlns="http://www.w3.org/2000/svg">\n  <path class="pattern-solid" d="m0 10h10v10h-10zm10-10h10v10h-10z" fill-rule="evenodd" />\n</svg>\n'}),define("text!res/patterns/graph-paper.svg",[],function(){return'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="100" height="100">\n  <g fill-rule="evenodd" fill="#FFF" class="pattern-solid">\n    <path opacity=".5" d="M96 95h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9zm-1 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9z" />\n    <path d="M6 5V0H5v5H0v1h5v94h1V6h94V5H6z" />\n  </g>\n</svg>\n'}),define("text!res/patterns/hexagons.svg",[],function(){return'<svg height="49" viewBox="0 0 28 49" width="28" xmlns="http://www.w3.org/2000/svg">\n  <path class="pattern-solid" d="m13.99 9.25 13 7.5v15l-13 7.5-12.99-7.5v-15zm-10.99 8.65v12.7l10.99 6.34 11-6.35v-12.69l-11-6.34zm-3-2.9 12.98-7.5v-7.5h-2v6.35l-10.98 6.34v2.3zm0 18.5 12.98 7.5v8h-2v-6.85l-10.98-6.34v-2.3zm15-33.5v7.5l12.99 7.5h.01v-2.31h-.01l-10.99-6.34v-6.35zm0 49v-8l12.99-7.5h.01v2.31h-.01l-10.99 6.34v6.85z" />\n</svg>\n'}),define("text!res/patterns/hideout.svg",[],function(){return'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40" width="40" height="40">\n  <g fill="#FFF" fill-rule="evenodd" class="pattern-solid">\n    <path d="M0 38.59l2.83-2.83 1.41 1.41L1.41 40H0v-1.41zM0 1.4l2.83 2.83 1.41-1.41L1.41 0H0v1.41zM38.59 40l-2.83-2.83 1.41-1.41L40 38.59V40h-1.41zM40 1.41l-2.83 2.83-1.41-1.41L38.59 0H40v1.41zM20 18.6l2.83-2.83 1.41 1.41L21.41 20l2.83 2.83-1.41 1.41L20 21.41l-2.83 2.83-1.41-1.41L18.59 20l-2.83-2.83 1.41-1.41L20 18.59z" />\n  </g>\n</svg>\n'}),define("text!res/patterns/polka-dots.svg",[],function(){return'<svg width="20px" height="20px" viewBox="0 0 20 20" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n  <g fill-rule="evenodd" fill="#FFF" class="pattern-solid">\n    <circle cx="3" cy="3" r="3" />\n    <circle cx="13" cy="13" r="3" />\n  </g>\n</svg>\n'}),define("text!res/patterns/random.svg",[],function(){return'<svg viewBox="0 0 80 80" width="240" height="240" xmlns="http://www.w3.org/2000/svg">\n  <path class="pattern-solid" d="m11 0 5 20h-10zm42 31a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-53 41h40v4h-40zm0-8h31v4h-31zm20-16h20v4h-20zm-20 8h40v4h-40zm63-25a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm10 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-20 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm10 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm10 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-30 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-28-8a5 5 0 0 0 -10 0zm10 0a5 5 0 0 1 -10 0zm31-28a5 5 0 0 0 -10 0zm10 0a5 5 0 0 1 -10 0zm-3 46a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm10 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-52-51 5 20h-10zm43 64v-4h-4v4h-4v4h4v4h4v-4h4v-4zm-28-51h4v4h-4zm4 4h4v4h-4zm-4 4h4v4h-4zm8-8h4v4h-4z" fill-rule="evenodd" />\n</svg>\n'}),define("text!res/patterns/temple.svg",[],function(){return'<svg xmlns="http://www.w3.org/2000/svg" width="152" height="152" viewBox="0 0 152 152">\n  <g class="pattern-solid" fill="#FFF" fill-rule="evenodd">\n    <path d="M152 150v2H0v-2h28v-8H8v-20H0v-2h8V80h42v20h20v42H30v8h90v-8H80v-42h20V80h42v40h8V30h-8v40h-42V50H80V8h40V0h2v8h20v20h8V0h2v150zm-2 0v-28h-8v20h-20v8h28zM82 30v18h18V30H82zm20 18h20v20h18V30h-20V10H82v18h20v20zm0 2v18h18V50h-18zm20-22h18V10h-18v18zm-54 92v-18H50v18h18zm-20-18H28V82H10v38h20v20h38v-18H48v-20zm0-2V82H30v18h18zm-20 22H10v18h18v-18zm54 0v18h38v-20h20V82h-18v20h-20v20H82zm18-20H82v18h18v-18zm2-2h18V82h-18v18zm20 40v-18h18v18h-18zM30 0h-2v8H8v20H0v2h8v40h42V50h20V8H30V0zm20 48h18V30H50v18zm18-20H48v20H28v20H10V30h20V10h38v18zM30 50h18v18H30V50zm-2-40H10v18h18V10z" />\n  </g>\n</svg>\n'}),define("app/base/constants",["require","common","app/base/quirks","shibui","text!res/icons/answer-code.svg","text!res/icons/answer-contact.svg","text!res/icons/answer-email.svg","text!res/icons/app-notice-dismiss.svg","text!res/icons/app-notice-launch.svg","text!res/icons/app-notice-pause.svg","text!res/icons/arrow-curl.svg","text!res/icons/block-strap-dismiss.svg","text!res/icons/block-strap-chevron.svg","text!res/icons/block-strap-jump.svg","text!res/icons/block-strap-add.svg","text!res/icons/block-strap-alert.svg","text!res/icons/card-actions.svg","text!res/icons/card-expired.svg","text!res/icons/chevron-left.svg","text!res/icons/chevron-right.svg","text!res/icons/cog.svg","text!res/icons/download-ring.svg","text!res/icons/filter-cloud-decal.svg","text!res/icons/filter-cloud-editor.svg","text!res/icons/filter-cloud-filter.svg","text!res/icons/filter-cloud-lock.svg","text!res/icons/filter-cloud-pin.svg","text!res/icons/filter-cloud-asterisk.svg","text!res/icons/filter-cloud-remove.svg","text!res/icons/filter-cloud-similar.svg","text!res/icons/filter-cloud-sort.svg","text!res/icons/filter-cloud-spinner.svg","text!res/icons/fmt-book.svg","text!res/icons/fmt-audiobook.svg","text!res/icons/fmt-magazine.svg","text!res/icons/fmt-video.svg","text!res/icons/hourglass.svg","text!res/icons/library-card.svg","text!res/icons/library-card-add.svg","text!res/icons/library-personalize.svg","text!res/icons/link-anchor.svg","text!res/icons/map-find-me.svg","text!res/icons/map-fit-branches.svg","text!res/icons/map-zoom-in.svg","text!res/icons/map-zoom-out.svg","text!res/icons/play.svg","text!res/icons/mini-player-jump.svg","text!res/icons/mini-player-toggle.svg","text!res/icons/mini-player-failure.svg","text!res/icons/nav-close.svg","text!res/icons/notify-me-bell.svg","text!res/icons/now-bar-dismiss.svg","text!res/icons/now-bar-manage.svg","text!res/icons/search.svg","text!res/icons/shamrock.svg","text!res/icons/shamrock-badge.svg","text!res/icons/share-android.svg","text!res/icons/share-ios.svg","text!res/icons/share-generic.svg","text!res/icons/star-indicator.svg","text!res/icons/tag-button.svg","text!res/icons/tag-add.svg","text!res/icons/tag-list.svg","text!res/icons/tag-line-head.svg","text!res/icons/timeline-tag.svg","text!res/icons/timeline-marks.svg","text!res/icons/title-status-available.svg","text!res/icons/title-status-available-ld.svg","text!res/icons/title-status-downloading.svg","text!res/icons/title-status-downloaded.svg","text!res/icons/title-status-scanning.svg","text!res/icons/title-status-notify.svg","text!res/icons/title-status-streaming.svg","text!res/icons/title-status-streaming-dl.svg","text!res/icons/title-status-wait-list.svg","text!res/icons/title-status-wait-list-acq.svg","text!res/icons/title-status-ellipsis.svg","text!res/icons/tick.svg","text!res/icons/wifi.svg","text!res/icons/wreath.svg","text!res/icons/footer-search.svg","text!res/icons/footer-library.svg","text!res/icons/footer-menu-hamburger.svg","text!res/icons/footer-menu-spinner.svg","text!res/icons/footer-shelf.svg","text!res/icons/footer-tags.svg","text!res/symbols/footer-mantle.svg","text!res/icons/input-command.svg","text!res/icons/shelf-nav-loans.svg","text!res/icons/shelf-nav-holds.svg","text!res/icons/shelf-nav-timeline.svg","text!res/icons/shelf-nav-notifications.svg","text!res/icons/shelf-sync-failure.svg","text!res/icons/shelf-sync-offline.svg","text!res/icons/ghost-authentication.svg","text!res/icons/sharing-social-twitter.svg","text!res/icons/feature-accessibility.svg","text!res/icons/feature-settings.svg","text!res/icons/feature-one-tap-magazines.svg","text!res/icons/feature-magazine-rack.svg","text!res/icons/feature-newsstand.svg","text!res/icons/menu-libraries-add.svg","text!res/icons/menu-libraries-cards.svg","text!res/icons/menu-settings-notifications.svg","text!res/icons/menu-settings-accessibility.svg","text!res/icons/menu-settings-downloads.svg","text!res/icons/menu-settings-fulfiller.svg","text!res/icons/menu-settings-language.svg","text!res/icons/menu-settings-navigation.svg","text!res/icons/menu-data-back-up.svg","text!res/icons/menu-data-setup-code.svg","text!res/icons/menu-data-reset.svg","text!res/icons/menu-help-contact-library.svg","text!res/icons/menu-help-survey.svg","text!res/icons/menu-help-feedback.svg","text!res/icons/notif-actions.svg","text!res/icons/notif-advance.svg","text!res/icons/notif-dismiss.svg","text!res/icons/notif-pin.svg","text!res/icons/notif-pinned.svg","text!res/icons/notif-unpin.svg","text!res/icons/notif-provider-shelf.svg","text!res/icons/notif-provider-push.svg","text!res/icons/notif-provider-email.svg","text!res/icons/tout-join-plus.svg","text!res/icons/tout-join-arrow.svg","text!res/symbols/mascot.svg","text!res/symbols/fingerprint.svg","text!res/symbols/encircle.svg","text!res/symbols/anchor-academy.svg","text!res/symbols/fmt-with-span.svg","text!res/symbols/star-rating.svg","text!res/symbols/the-end.svg","text!res/symbols/limelight.svg","text!res/symbols/tutorial-balloon-large.svg","text!res/symbols/tutorial-balloon-small.svg","text!res/symbols/filter-cloud-search-scope-mural.svg","text!res/symbols/filter-cloud-tag-availability-mural.svg","text!res/symbols/overdrive-logo.svg","text!res/symbols/store-logo-apple.svg","text!res/symbols/store-logo-google.svg","text!res/patterns/bank-note.svg","text!res/patterns/floor-tile.svg","text!res/patterns/graph-paper.svg","text!res/patterns/hexagons.svg","text!res/patterns/hideout.svg","text!res/patterns/polka-dots.svg","text!res/patterns/random.svg","text!res/patterns/temple.svg"],function(e){
var t=e("common"),i=t.Class.new(),s=i.prototype,n=(e("app/base/quirks"),e("shibui"));s.FORMAT_MAPPINGS={ebook:{singular:"book",plural:"books",subtypes:["ebook-overdrive","ebook-media-do","ebook-overdrive-provisional"]},audiobook:{singular:"audiobook",plural:"audiobooks",subtypes:["audiobook-overdrive","audiobook-overdrive-provisional"]},magazine:{singular:"magazine",plural:"magazines",subtypes:["magazine-overdrive"]}},s.LIST_SOURCES=["everything","curated","generated","spotlight","subject","publisher","imprint","award","creator","series","issues","search","campaign","similar"],s.LANGUAGE_ENDONYMS={en:"English","en-US":"English (US)","en-GB":"English (British)","cy-GB":"Cymraeg","da-DK":"Dansk","de-DE":"Deutsch","es-419":"Español","fr-CA":"Français","is-IS":"Íslenska","it-IT":"Italiano","ja-JP":"日本語","ko-KR":"한국어","mi-NZ":"Māori","ms-SG":"Bahasa Melayu","sv-SE":"Svenska","ru-RU":"Русский","ta-SG":"தமிழ்","zh-Hans-CN":"简体中文","zh-Hant-TW":"繁體中文"},s.NOTEMOJI={recommendation:"👍",thought:"💭","favorite-quote":"💬",trivia:"💡","sponsored-by":"🌟",unavailability:"➖"};var r=navigator.userAgent.toLowerCase().match(/android/);return t.each({"answer-code":e("text!res/icons/answer-code.svg"),"answer-contact":e("text!res/icons/answer-contact.svg"),"answer-email":e("text!res/icons/answer-email.svg"),"app-notice-dismiss":e("text!res/icons/app-notice-dismiss.svg"),"app-notice-launch":e("text!res/icons/app-notice-launch.svg"),"app-notice-pause":e("text!res/icons/app-notice-pause.svg"),"arrow-curl":e("text!res/icons/arrow-curl.svg"),"block-strap-dismiss":e("text!res/icons/block-strap-dismiss.svg"),"block-strap-chevron":e("text!res/icons/block-strap-chevron.svg"),"block-strap-jump":e("text!res/icons/block-strap-jump.svg"),"block-strap-add":e("text!res/icons/block-strap-add.svg"),"block-strap-alert":e("text!res/icons/block-strap-alert.svg"),"card-actions":e("text!res/icons/card-actions.svg"),"card-expired":e("text!res/icons/card-expired.svg"),"chevron-left":e("text!res/icons/chevron-left.svg"),"chevron-right":e("text!res/icons/chevron-right.svg"),cog:e("text!res/icons/cog.svg"),"download-ring":e("text!res/icons/download-ring.svg"),"filter-cloud-decal":e("text!res/icons/filter-cloud-decal.svg"),"filter-cloud-editor":e("text!res/icons/filter-cloud-editor.svg"),"filter-cloud-filter":e("text!res/icons/filter-cloud-filter.svg"),"filter-cloud-lock":e("text!res/icons/filter-cloud-lock.svg"),"filter-cloud-pin":e("text!res/icons/filter-cloud-pin.svg"),"filter-cloud-asterisk":e("text!res/icons/filter-cloud-asterisk.svg"),"filter-cloud-remove":e("text!res/icons/filter-cloud-remove.svg"),"filter-cloud-similar":e("text!res/icons/filter-cloud-similar.svg"),"filter-cloud-sort":e("text!res/icons/filter-cloud-sort.svg"),"filter-cloud-spinner":e("text!res/icons/filter-cloud-spinner.svg"),"fmt-book":e("text!res/icons/fmt-book.svg"),"fmt-audiobook":e("text!res/icons/fmt-audiobook.svg"),"fmt-magazine":e("text!res/icons/fmt-magazine.svg"),"fmt-video":e("text!res/icons/fmt-video.svg"),hourglass:e("text!res/icons/hourglass.svg"),"library-card":e("text!res/icons/library-card.svg"),"library-card-add":e("text!res/icons/library-card-add.svg"),"library-personalize":e("text!res/icons/library-personalize.svg"),"link-anchor":e("text!res/icons/link-anchor.svg"),"map-find-me":e("text!res/icons/map-find-me.svg"),"map-fit-branches":e("text!res/icons/map-fit-branches.svg"),"map-zoom-in":e("text!res/icons/map-zoom-in.svg"),"map-zoom-out":e("text!res/icons/map-zoom-out.svg"),play:e("text!res/icons/play.svg"),"mini-player-jump":e("text!res/icons/mini-player-jump.svg"),"mini-player-toggle":e("text!res/icons/mini-player-toggle.svg"),"mini-player-failure":e("text!res/icons/mini-player-failure.svg"),"nav-close":e("text!res/icons/nav-close.svg"),"notify-me-bell":e("text!res/icons/notify-me-bell.svg"),"now-bar-dismiss":e("text!res/icons/now-bar-dismiss.svg"),"now-bar-manage":e("text!res/icons/now-bar-manage.svg"),search:e("text!res/icons/search.svg"),shamrock:e("text!res/icons/shamrock.svg"),"shamrock-badge":e("text!res/icons/shamrock-badge.svg"),share:e(r?"text!res/icons/share-android.svg":"text!res/icons/share-ios.svg"),"share-generic":e("text!res/icons/share-generic.svg"),"star-indicator":e("text!res/icons/star-indicator.svg"),"tag-button":e("text!res/icons/tag-button.svg"),"tag-add":e("text!res/icons/tag-add.svg"),"tag-list":e("text!res/icons/tag-list.svg"),"tag-line-head":e("text!res/icons/tag-line-head.svg"),"timeline-tag":e("text!res/icons/timeline-tag.svg"),"timeline-marks":e("text!res/icons/timeline-marks.svg"),"title-status-available":e("text!res/icons/title-status-available.svg"),"title-status-available-ld":e("text!res/icons/title-status-available-ld.svg"),"title-status-downloading":e("text!res/icons/title-status-downloading.svg"),"title-status-downloaded":e("text!res/icons/title-status-downloaded.svg"),"title-status-scanning":e("text!res/icons/title-status-scanning.svg"),"title-status-notify":e("text!res/icons/title-status-notify.svg"),"title-status-streaming":e("text!res/icons/title-status-streaming.svg"),"title-status-streaming-dl":e("text!res/icons/title-status-streaming-dl.svg"),"title-status-wait-list":e("text!res/icons/title-status-wait-list.svg"),"title-status-wait-list-acq":e("text!res/icons/title-status-wait-list-acq.svg"),"title-status-ellipsis":e("text!res/icons/title-status-ellipsis.svg"),tick:e("text!res/icons/tick.svg"),wifi:e("text!res/icons/wifi.svg"),wreath:e("text!res/icons/wreath.svg"),"footer-search":e("text!res/icons/footer-search.svg"),"footer-library":e("text!res/icons/footer-library.svg"),"footer-menu-hamburger":e("text!res/icons/footer-menu-hamburger.svg"),"footer-menu-spinner":e("text!res/icons/footer-menu-spinner.svg"),"footer-shelf":e("text!res/icons/footer-shelf.svg"),"footer-tags":e("text!res/icons/footer-tags.svg"),"footer-mantle":e("text!res/symbols/footer-mantle.svg"),"input-command":e("text!res/icons/input-command.svg"),"shelf-nav-loans":e("text!res/icons/shelf-nav-loans.svg"),"shelf-nav-holds":e("text!res/icons/shelf-nav-holds.svg"),"shelf-nav-timeline":e("text!res/icons/shelf-nav-timeline.svg"),"shelf-nav-notifications":e("text!res/icons/shelf-nav-notifications.svg"),"shelf-sync-failure":e("text!res/icons/shelf-sync-failure.svg"),"shelf-sync-offline":e("text!res/icons/shelf-sync-offline.svg"),"ghost-authentication":e("text!res/icons/ghost-authentication.svg"),"sharing-social-twitter":e("text!res/icons/sharing-social-twitter.svg"),"feature-accessibility":e("text!res/icons/feature-accessibility.svg"),"feature-settings":e("text!res/icons/feature-settings.svg"),"feature-one-tap-magazines":e("text!res/icons/feature-one-tap-magazines.svg"),"feature-magazine-rack":e("text!res/icons/feature-magazine-rack.svg"),"feature-newsstand":e("text!res/icons/feature-newsstand.svg"),"menu-libraries-add":e("text!res/icons/menu-libraries-add.svg"),"menu-libraries-cards":e("text!res/icons/menu-libraries-cards.svg"),"menu-settings-notifications":e("text!res/icons/menu-settings-notifications.svg"),"menu-settings-accessibility":e("text!res/icons/menu-settings-accessibility.svg"),"menu-settings-downloads":e("text!res/icons/menu-settings-downloads.svg"),"menu-settings-fulfiller":e("text!res/icons/menu-settings-fulfiller.svg"),"menu-settings-language":e("text!res/icons/menu-settings-language.svg"),"menu-settings-navigation":e("text!res/icons/menu-settings-navigation.svg"),"menu-data-back-up":e("text!res/icons/menu-data-back-up.svg"),"menu-data-setup-code":e("text!res/icons/menu-data-setup-code.svg"),"menu-data-reset":e("text!res/icons/menu-data-reset.svg"),"menu-help-contact-library":e("text!res/icons/menu-help-contact-library.svg"),"menu-help-survey":e("text!res/icons/menu-help-survey.svg"),"menu-help-feedback":e("text!res/icons/menu-help-feedback.svg"),"notif-actions":e("text!res/icons/notif-actions.svg"),"notif-advance":e("text!res/icons/notif-advance.svg"),"notif-dismiss":e("text!res/icons/notif-dismiss.svg"),"notif-pin":e("text!res/icons/notif-pin.svg"),"notif-pinned":e("text!res/icons/notif-pinned.svg"),"notif-unpin":e("text!res/icons/notif-unpin.svg"),"notif-provider-shelf":e("text!res/icons/notif-provider-shelf.svg"),"notif-provider-push":e("text!res/icons/notif-provider-push.svg"),"notif-provider-email":e("text!res/icons/notif-provider-email.svg"),"tout-join-plus":e("text!res/icons/tout-join-plus.svg"),"tout-join-arrow":e("text!res/icons/tout-join-arrow.svg"),mascot:e("text!res/symbols/mascot.svg"),fingerprint:e("text!res/symbols/fingerprint.svg"),encircle:e("text!res/symbols/encircle.svg"),"anchor-academy":e("text!res/symbols/anchor-academy.svg"),"fmt-with-span":e("text!res/symbols/fmt-with-span.svg"),"star-rating":e("text!res/symbols/star-rating.svg"),"the-end":e("text!res/symbols/the-end.svg"),limelight:e("text!res/symbols/limelight.svg"),"tutorial-balloon-large":e("text!res/symbols/tutorial-balloon-large.svg"),"tutorial-balloon-small":e("text!res/symbols/tutorial-balloon-small.svg"),"filter-cloud-search-scope-mural":e("text!res/symbols/filter-cloud-search-scope-mural.svg"),"filter-cloud-tag-availability-mural":e("text!res/symbols/filter-cloud-tag-availability-mural.svg"),"overdrive-logo":e("text!res/symbols/overdrive-logo.svg"),"store-logo-apple":e("text!res/symbols/store-logo-apple.svg"),"store-logo-google":e("text!res/symbols/store-logo-google.svg"),"bank-note":e("text!res/patterns/bank-note.svg"),"floor-tile":e("text!res/patterns/floor-tile.svg"),"graph-paper":e("text!res/patterns/graph-paper.svg"),hexagons:e("text!res/patterns/hexagons.svg"),hideout:e("text!res/patterns/hideout.svg"),"polka-dots":e("text!res/patterns/polka-dots.svg"),random:e("text!res/patterns/random.svg"),temple:e("text!res/patterns/temple.svg")},n.Illustrator.add.bind(n.Illustrator)),s.URLS={libby:"https://libbyapp.com",help:"https://help.libbyapp.com",terms:"https://company.cdn.overdrive.com/policies/terms-and-conditions.htm",privacy:"https://company.cdn.overdrive.com/policies/privacy-policy.htm","upgrade:apple":"https://itunes.apple.com/us/app/libby-by-overdrive/id1076402606","upgrade:google":"https://play.google.com/store/apps/details?id=com.overdrive.mobile.android.libby","help:passkeys":"https://help.libbyapp.com/6302.htm","help:skip-the-line":"https://help.libbyapp.com/6172.htm","help:fastlane":"https://help.libbyapp.com/6299.htm","help:kindle-returns":"https://help.libbyapp.com/6015.htm"},s.$init=function(){this.VERSION_NUMBER=this._metaContentValue("x-dewey-version"),this.ENV=this._metaContentValue("x-dewey-env"),this.ROOT_URI=this._metaContentValueAsURI("x-roster-root"),this.SHARE_URI=this.ROOT_URI.replace("//","//share."),this.STATUS_URI=this.ROOT_URI.replace("//","//status."),this.SENTRY_URI=this._metaContentValueAsURI("x-sentry-uri"),this.SAGE_URI=this._metaContentValueAsURI("x-sage-uri"),this.VANDAL_URI=this._metaContentValueAsURI("x-vandal-uri"),this.THUNDER_URI=this._metaContentValueAsURI("x-thunder-uri"),this.AUTOCOMPLETE_URI=this._metaContentValueAsURI("x-autocomplete-uri"),this.AUTOCOMPLETE_KEY=this._metaContentValue("x-autocomplete-key",{isOptional:!0}),this.NTC_API_URI=this._metaContentValueAsURI("x-ntc-api-uri"),this.NTC_SITE_URI=this._metaContentValueAsURI("x-ntc-site-uri"),this.NTC_TARGET_CLIENT=this._metaContentValue("x-ntc-target-client"),this.OMC_FAQ_URI=this._metaContentValueAsURI("x-omc-faq-uri")},s.formats=function(e){if(arguments.length<1){var i=[];return t.each(this.FORMAT_MAPPINGS,function(e,t){i.push(t.singular)}),i}return"string"==typeof e?t.try(this.FORMAT_MAPPINGS[e],"singular"):void APP.journal.warn("[CONSTANTS] invalid mediaType:",e)},s.mediaTypes=function(e){if("string"!=typeof e){var i=[];return t.each(this.FORMAT_MAPPINGS,function(e,t){i.push(e)}),i}for(var s in this.FORMAT_MAPPINGS){var n=t.try(this.FORMAT_MAPPINGS[s],"singular");if(n==e)return s}},s.discoverableFulfillmentSubtypes=function(){var e=[];return t.each(this.FORMAT_MAPPINGS,function(t,i){e=e.concat(i.subtypes)}),t.unique(e)},s.bestNameForSubject=function(e,i){var s=n.Phrasebook.text("subjects."+e,{},{okIfMissing:!0});return!s&&SPARK.locale.isEnglish&&(s=i,this._.unlocalizedSubjects=this._.unlocalizedSubjects||{},this._.unlocalizedSubjects["subjects."+e]=s,s=t.try(APP,"arena._amplifyText()",s)||s||""),s},s.filePath=function(e){return["/dewey-"+this.VERSION_NUMBER,"inc",e].join("/")},s.fileURL=function(e){return this.ROOT_URI+this.filePath(e)},s._metaContentValueAsURI=function(e){var t=this._metaContentValue(e);return t.match(/^\/\//)?"nautilus-https:"!=location.protocol?t:"https:"+t:t},s._metaContentValue=function(e,t){var i=document.querySelector('meta[name="'+e+'"]');return i?i.getAttribute("content"):void(t&&t.isOptional||console.warn("[CONSTANTS] meta constant not found:",e))},i}),define("app/base/journal",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.$init=function(e){this._.lines=[],this._.options={},this.debugging=t.among(APP.constants.ENV,"dev","alpha"),this.configure(e)},s.configure=function(e){var i=t.absorb(this._.options,{});return this._.options=t.absorb(e,i)},s.write=function(e,i){var s=t.select(Array.prototype.slice.call(arguments,1),function(e){try{return"string"==typeof e?e:JSON.stringify(e)}catch(e){return"{unprintable}"}}).join(" "),n=t.compact([this._.options.linePrefix,{log:"-",info:"-",warn:"=",error:"≡"}[e],s]).join(" ");return this._.lines.push(n),APP.events.dispatch("journal:write",{journal:this,prefix:this._.options.linePrefix,level:e,line:s}),n},s.read=function(){return this._.lines.slice(0)},s.debug=function(e){this.debugging&&console.debug.apply(console,arguments)},s.log=function(e){this._writeToConsole("log",arguments)},s.info=function(e){this._writeToConsole("info",arguments)},s.warn=function(e){this._writeToConsole("warn",arguments)},s.error=function(e){this._writeToConsole("error",arguments)},s._writeToConsole=function(e,i){var s=Array.prototype.slice.call(i,0),n=function(e){e&&("string"==typeof s[0]?s[0]=e+" "+s[0]:s.unshift(e))};this.write.apply(this,t.flatten([e,s])),n(this._.options.linePrefix),n(this._.options.consolePrefix),console[e].apply(console,s)},i}),define("app/base/bank/bank-scope-memory",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.COMMIT_DELAY_MS=0,s.$init=function(e,t){this._.name=e,this._.flush={keys:[],timer:null},this._.data=t||this._read()},s.get=function(e){return this._.data[e]},s.set=function(e,i){t.isNullish(i)?delete this._.data[e]:this._.data[e]=i,this._write(e)},s.dump=function(e,t){this.set(e,t.export())},s.flush=function(){this._commit(),this._.flush.keys=[],this._.flush.timer=null},s._read=function(){return{}},s._commit=function(){},s._write=function(e){this._.flush.keys.indexOf(e)<0&&this._.flush.keys.push(e),this._.flush.timer=this._.flush.timer||setTimeout(this.flush.bind(this),this.COMMIT_DELAY_MS)},s._eachFlushKey=function(e){t.each(this._.flush.keys,e,this)},i}),define("app/base/bank/bank-scope-domain",["require","common","./bank-scope-memory"],function(e){var t=e("common"),i=e("./bank-scope-memory"),s=i.new(),n=s.prototype;return n._read=function(){var e={},t=new RegExp("^"+this._.name+":(.+)$");return this._eachRawPair(function(i,s){var n=i.match(t);if(n){var r=n[1];e[r]=JSON.parse(s)}}),e},n._commit=function(){this._eachFlushKey(function(e){var i=this.get(e),s=this._.name+":"+e;if(t.isNullish(i))this._localStorage().removeItem(s);else try{this._localStorage().setItem(s,JSON.stringify(i))}catch(e){APP.journal.warn("[BANK] error stringifying value:",e,s,i)}})},n._eachRawPair=function(e){for(var t=[],i=0,s=this._localStorage().length;i<s;++i){var n=this._localStorage().key(i);"string"==typeof n&&t.push(n)}for(var i=0,s=t.length;i<s;++i)e(t[i],this._localStorage().getItem(t[i]))},n._localStorage=function(){return"undefined"!=typeof window.localStorage?window.localStorage:(this._.fakeStorage||(APP.journal.warn("[BANK] localStorage disabled. No persistence for session."),this._.fakeStorage=this._makeFakeStorage()),this._.fakeStorage)},n._makeFakeStorage=function(){return{getItem:function(e){for(var t=0,i=this.__data.length;t<i;++t)if(this.__data[t][0]==e)return this.__data[t][1]},setItem:function(e,t){for(var i=0,s=this.__data.length;i<s;++i)if(this.__data[i][0]==e)return this.__data[i][1]=t;this.__data.push([e,t]),this.length=this.__data.length},removeItem:function(e){for(var t=0,i=this.__data.length;t<i;++t)if(this.__data[t][0]==e){this.__data.splice(t,1);break}this.length=this.__data.length},key:function(e){return this.__data[e][0]},length:0,__data:[]}},s}),define("app/base/bank/migrations/noop",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.DELTA_TTL=2592e6,s.migrate=function(e){},i}),define("app/base/bank/migrations/b003",["require","common","./noop"],function(e){var t=e("common"),i=e("./noop"),s=i.new(),n=s.prototype;return n.migrate=function(e){t.each(e._.data,function(t,i){"_bank-version"!=t&&(t.match(/^migration/)||e.set(t,null))})},s});define("app/base/bank/migrations/b004",["require","common","./noop"],function(e){var t=(e("common"),e("./noop")),i=t.new(),s=i.prototype;return s.migrate=function(e){e.set("library:all")},i});define("app/base/bank/migrations/b005",["require","common","./noop"],function(e){var t=e("common"),i=e("./noop"),s=i.new(),n=s.prototype;return n.migrate=function(e){e.set("tour:met",null),e.set("advisor:dismissals",null),e.set("advisor:dismissals:horizon",null),e.set("advisor:navigations",null),e.set("campaign:dismissals",null);var i={},s=e.get("patron:choices")||{};t.each(s.all,function(e,t){e.match(/^guide:filter/)||(s[e]=t)}),delete s.all,delete s.v;var n=e.get("cards:all");if("undefined"!=typeof n){var r={patronName:"patron:name",emailAddress:"patron:email:address",autoBorrowHolds:"holds:borrow:automatically",daysToSuspendHolds:"holds:suspend:days",readingDevice:"device:reading",sendingDevice:"device:sending",listeningDevice:"device:listening"};t.each(r,function(e,t){"undefined"!=typeof n[e]&&"undefined"==typeof s[t]&&(s[t]=n[e],delete n[e])}),e.set("cards:all",n)}var n=e.get("syllabus:alerts:disable");"undefined"!=typeof n&&(s["notifications:syllabus"]=n?"off":"on",e.set("syllabus:alerts:disable",null)),n=e.get("library:subjects:sort"),"undefined"!=typeof n&&(s["explore:subjects:sort"]=n,e.set("library:subjects:sort",null)),n=e.get("footer:visited"),n&&n.length&&n.indexOf("shelf")>=0&&(i["footer:shelf:cue"]=t.epochSeconds(),e.set("footer:visited",null)),n=e.get("libby:skin-tone"),"undefined"!=typeof n&&(s["mascot:skin-tone"]=n,e.set("libby:skin-tone",null)),n=e.get("shelf:activities:filter"),"undefined"!=typeof n&&(s["shelf:filters:activities"]=n,e.set("shelf:activities:filter",null)),n=e.get("shelf:filters"),"undefined"!=typeof n&&(n.loans&&(s["shelf:filters:loans"]=n.loans),n.holds&&(s["shelf:filters:holds"]=n.holds),e.set("shelf:filters",null)),n=e.get("update-manager.auto-download"),"undefined"!=typeof n&&(s["roster:auto-download"]=n,e.set("update-manager.auto-download",null)),n=e.get("update-manager.download-queue"),"undefined"!=typeof n&&(s["roster:download-queue"]=n,e.set("update-manager.download-queue",null)),n=e.get("update-manager.update-horizon"),"undefined"!=typeof n&&(s["roster:update-horizon"]=n,e.set("update-manager.update-horizon",null)),n=e.get("search-history"),"undefined"!=typeof n&&(e.set("catalog:search:history",n),e.set("search-history",null)),e.set("patron:choices",s),e.set("patron:dismissals",i)},s}),define("app/base/bank/migrations/b006",["require","common","./noop"],function(e){var t=(e("common"),e("./noop")),i=t.new(),s=i.prototype;return s.migrate=function(e){var t=e.get("patron:choices")||{};"kindle"==t["device:reading"]&&delete t["device:reading"],delete t["shelf:filters:loans"],delete t["shelf:filters:holds"],delete t["shelf:filters:tags"],delete t["shelf:filters:tag"],delete t["shelf:filters:activities"],e.set("patron:choices",t)},i}),define("app/base/bank/migrations/b007",["require","common","./noop"],function(e){var t=(e("common"),e("./noop")),i=t.new(),s=i.prototype;return s.migrate=function(e){var t=e.get("patron:choices")||{};return delete t["shelf:filters:loans"],e.set("patron:choices",t),"B7"},i}),define("app/base/bank/migrations/b008",["require","common","./noop"],function(e){var t=e("common"),i=e("./noop"),s=i.new(),n=s.prototype;return n.migrate=function(e){var i=e.get("patron:choices")||{};i["reading:device"]&&delete i["reading:device"],t.each(["loans","holds","tags","tag","activities"],function(e){var s=t.excise(i,"shelf:filters:"+e);s&&(i["shelf:criteria:"+e]=s)}),e.set("patron:choices",i);var s={},n={v:1,all:[]},r=e.get("card:all");r&&(t.each(r.all,function(e){e.websiteId=t.try(e,"library.websiteId"),delete e.library}),e.set("patron:card:all",r),e.set("card:all",null));var o=e.get("activity:all");o&&(t.each(t.try(o,"all"),function(e){e.card&&(e.cardId=e.card.id+"",delete e.card),e.title&&(e.titleId=e.title.titleId,e.websiteId=t.try(e.title,"library.websiteId"),s[e.title.titleId]=e.title,delete e.title)}),e.set("patron:activity:all",o),e.set("activity:all",null));var a=function(e){var t={},i=function(i,s){"undefined"!=typeof e[i]&&(t[s||i]=e[i])};return i("copies","copiesOwned"),i("estimatedWaitDays"),i("position"),i("prerelease","isPrerelease"),i("total","holdsCount"),t},l=e.get("loan:all");l&&(t.each(l.all,function(e){s[e.psnKey]=t.clone(e),e.titleId=t.excise(e,"psnKey"),e.waitList&&(e.holding=a(t.excise(e,"waitList")))}),e.set("patron:loan:all",l),e.set("loan:all",null));var c=e.get("hold:all");c&&(t.each(c.all,function(e){s[e.psnKey]=t.clone(e),e.titleId=t.excise(e,"psnKey"),e.waitList&&(e.holding=a(t.excise(e,"waitList")))}),e.set("patron:hold:all",c),e.set("hold:all",null));var h=e.get("tag:all");h&&(t.each(h.all,function(e){t.each(e.all,function(e){s[e.titleId]=e,e.titleId=e.titleId,e.websiteId=t.try(e,"library.websiteId")})}),e.set("patron:tag:all",h),e.set("tag:all",null));var u=e.get("title");u&&(s[u.titleId]=u,n["now:slug"]=u.titleId,e.set("title",null));var p=t.epochMilliseconds();t.each(s,function(e,i){i.v=1,i.fetchedAt=p,t.excise(i,"library");var s=t.excise(i,"authors");s&&(i.creators=i.creators||{},i.creators.Creator=[],t.each(s.split(/,\s*/),function(e){i.creators.Creator.push({name:e})})),i.duration||t.excise(i,"duration"),i.edition||t.excise(i,"edition"),i.imprint||t.excise(i,"imprint"),i.series||t.excise(i,"series");var r={},o=t.excise(i,"coverColor");o&&(r.color=o,i.cover=r);var a=t.excise(i,"coverURLForDPI");a&&(r.url=a,i.cover=r),"boolean"==typeof i.sampleAvailable&&(i.isSampleAvailable=t.excise(i,"sampleAvailable")),n.all.push(i)}),e.set("title:all",n),setTimeout(function(){try{APP.titles._saveNow()}catch(e){}},1e3)},s}),define("app/base/bank/migrations/b009",["require","common","./noop"],function(e){var t=(e("common"),e("./noop")),i=t.new(),s=i.prototype;return s.migrate=function(e){var t=e.get("engage:state");"undefined"!=typeof t&&(delete t.earlyReturnCount,delete t.readingChoices,e.set("daemon:engagement",t),e.set("engage:state",null))},i}),define("app/base/bank/migrations/b010",["require","common","./noop"],function(e){var t=(e("common"),e("./noop")),i=t.new(),s=i.prototype;return s.migrate=function(e){var t=e.get("patron:choices")||{};delete t["holds:suspend:days"],e.set("patron:choices",t)},i}),define("app/base/bank/migrations/b011",["require","common","./noop"],function(e){var t=(e("common"),e("./noop")),i=t.new(),s=i.prototype;return s.migrate=function(e){var t=e.get("patron:choices")||{};delete t["notifications:syllabus"],delete t["notifier:subscriptions"],e.set("patron:choices",t)},i}),define("app/base/bank/migrations/b012",["require","common","./noop"],function(e){var t=(e("common"),e("./noop")),i=t.new(),s=i.prototype;return s.migrate=function(e){e.set("scribe:queues")},i}),define("app/base/bank/migrations/b013",["require","common","./noop"],function(e){var t=(e("common"),e("./noop")),i=t.new(),s=i.prototype;return s.migrate=function(e){e.set("notifier:sentry:service"),e.set("notifier:sentry:subscriptions")},i}),define("app/base/bank/migrations/b014",["require","common","./noop"],function(e){var t=e("common"),i=e("./noop"),s=i.new(),n=s.prototype;return n.migrate=function(e){var i=e.get("patron:choices");if(i){var s=["cover-taps","device:sending","holds:borrow:automatically","shelf:criteria:tags","daemon:grc"];i["fulfillment:preferences"]={};var n=t.excise(i,"device:reading");t.among(n,"libby","here","there")&&(n="bifocal"),t.among(n,"bifocal","kindle")&&(i["fulfillment:preferences"].book=n);var r={};t.each(i,function(e,t){var i=e.match(/^device:reading:([^:]+)$/);i&&(r[t]=r[t]||[],r[t].push(i[1]),s.push(e))}),i["fulfillment:choices"]=r,t.each(s,t.excise.bind(t,i)),e.set("patron:choices",i)}var o=e.get("list:preferences");if(o){var a=t.excise(o,"list.parameters.device-format");a&&("adobe"==t.try(a,"values[0]")&&(a.values=["epub"],a.propertyValue=["epub"]),a.property="supports",o["list.parameters.supports"]=a,e.set("list:preferences",o))}t.each(["loan:all","hold:all","card:all","activity:all"],function(t){e.set(t)})},s}),define("app/models/items/item",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.export=function(){return this._serializeAttributes()},s.import=function(e,i){return e=t.absorb(e,{}),"internal"!=i.source&&(e=this._transformAttributes(e,i)),this._deserializeAttributes(e,i),this},s.remove=function(){this.collation&&!this.removedFromCollation&&this.collation.removeItem(this)},s._transformAttributes=function(e,t){return e},s._serializeAttributes=function(){return{}},s._deserializeAttributes=function(e){t.each(e,function(e,t){if(this[e]&&this[e]===this.__class.prototype[e])return APP.journal.warn("[ITEM] attempt to override prototype:",e,t);for(var i=this,s=e.split(".");s.length;){var n=s.pop();i=i[n]=s.length?i[n]||{}:t}},this)},s._utcStringToTime=function(e){if(e)return new Date(e).getTime()},i}),define("app/models/collations/collation",["require","common","app/models/items/item"],function(e){var t=e("common"),i=e("app/models/items/item"),s=i.new(),n=s.prototype;return n.ITEM_CLASS=null,n.ITEM_NAME="item",n.ITEM_KEY=null,n.BANK_PREFIX="",n.BANK_SUFFIX=":all",n.SAVE_DELAY=200,n.PERSISTENCE="complete",n.ANNOUNCE=!0,n.$init=function(){this.all=[],this._rebuildLookupTable()},n.loadingLock=function(e){var t=this._.loadingLock;this._.loadingLock=!0;var i=e(this);return t?this._.loadingLock=!0:delete this._.loadingLock,i},n.isLoadingLocked=function(){return!(!this.collation||!this.collation.isLoadingLocked())||!!this._.loadingLock},n.load=function(){var e;return this.PERSISTENCE&&(e=this.loadingLock(function(){var e=t.clone(APP.bank.get(this._bankName())),i={source:"internal",integrity:this.PERSISTENCE};return this.import(e,i)}.bind(this))),this._.isLoaded=!0,this._announce("load:all",{collation:this}),"function"==typeof this.loaded&&this.loaded(),e},n.save=function(e){if(!this.isLoadingLocked()){var i=this.SAVE_DELAY;"number"==typeof t.try(e,"delay")&&e.delay>=0&&(i=e.delay),t.defer(this,"save",this._saveNow.bind(this),i)}},n.produce=function(e){var t=e;return this.FIND_WITH_ATTRS_TO_QUERY&&(t=this._attributesToQuery(e)),this.find(t)||this.make(e,{source:"internal",integrity:"incomplete"})},n.make=function(e,t){var i=new this.ITEM_CLASS;return i.collation=this,i.import(e,t),this.addItem(i)},n.addItem=function(e){if(this._isValidItem(e))return this.all.push(e),this._.lookupTable&&(this._.lookupTable[e[this.ITEM_KEY]]=e),"function"==typeof e.added&&e.added(),this._announce("add",{item:e}),this.save(),e},n.removeItem=function(e){return t.excise(this.all,e),this._.lookupTable&&delete this._.lookupTable[e[this.ITEM_KEY]],e.removedFromCollation=!0,"function"==typeof e.removed&&e.removed(),this._announce("remove",{item:e}),this.save(),e},n.remove=function(e){var t=this.find(e);return t?this.removeItem(t):void APP.journal.warn('[COLLATION] Could not remove missing "%s"',this.ITEM_NAME,e)},n.removeAll=function(e){return t.select(this.filter(e),this.removeItem.bind(this))},n.find=function(e){return this.filter(e,1)[0]},n.filter=function(e,t,i){!i&&this._.lookupTable&&e[this.ITEM_KEY]?i=[this._.lookupTable[e[this.ITEM_KEY]]]:i||(i=this.all);for(var s=[],n=0,r=i.length;n<r;++n){var o=!0;for(var a in e){for(var l=a.split("."),c=i[n];l.length;){var h=l.shift();c=c?c[h]:null}if(e[a]instanceof Array?e[a].indexOf(c)<0&&(o=!1):c!=e[a]&&(o=!1),!o)break}if(o&&(s.push(i[n]),t&&s.length>=t))break}return s},n.pathWithCriteria=function(e){var i=this.PATH_FOR_CRITERIA||"shelf/"+this.ITEM_NAME+"s",s=[];return t.each(e,function(e,t){t&&s.push(t)}),t.compact([i,s.join(",")]).join("/")},n.criteria=function(){},n.collate=function(e){var t=this.all.slice(0);return t.sort(this._compareItemsBy.bind(this,e.sort))},n.totalCount=function(){return this.all.length},n.facetCount=function(e,i,s){if(this.facetCounts){var n=this._criteriaSignature(s),r=t.try(this.facetCounts,"["+n+"]["+e+"]["+i+"]");if("number"==typeof r||"string"==typeof r)return r}var o=t.absorb(s,{});return o[e]=i,this.collate(o).length},n.export=function(){var e=i.prototype.export.apply(this,arguments);return e.all=this._serializeItems(),e},n.import=function(e,s){var n=function(){var n=t.excise(e||{},"all")||[];i.prototype.import.call(this,e,s);var r=this._deserializeItems(n,s);s.resetCollation&&(this.all=r,this._rebuildLookupTable()),this.save()}.bind(this);return s.resetCollation?this.loadingLock(n):n(),this},n.importAll=function(e,t){var i=this._deserializeItems(e,t);return i.length&&this.save(),i},n._bankName=function(){return this.BANK_PREFIX+this.ITEM_NAME+this.BANK_SUFFIX},n._saveNow=function(){this.PERSISTENCE&&APP.bank.dump(this._bankName(),this),this._announce("update:all",{collation:this.ITEM_NAME,all:this.all})},n._serializeItems=function(e){e=e||this.all;var i=[];return t.each(e,function(e){if(e&&"function"==typeof e.export){var t=e.export();t&&i.push(t)}}),i},n._deserializeItems=function(e,i){var s=[];return t.each(e,function(e){var t=this.find(this._attributesToQuery(e,i));t?t.import(e,i):t=this.make(e,i),this._isValidItem(t)&&s.push(t)},this),s},n._attributesToQuery=function(e,t){var i={};return this.ITEM_KEY?i[this.ITEM_KEY]=e[this.ITEM_KEY]:(APP.journal.warn("[COLLATION] "+this.ITEM_NAME+" -- _attributesToQuery undefined"),i.id=e.id),i},n._criteriaSignature=function(e){try{return window.btoa(JSON.stringify(e))}catch(t){return APP.journal.warn("[COLLATION] erroring criteria signature",t,e),"[erroring-criteria]"}},n._announce=function(e,t){this.ANNOUNCE&&!this.isLoadingLocked()&&(APP.journal.debug("[COLLATION] ",this.ITEM_NAME+":"+e),APP.events.dispatch(this.ITEM_NAME+":"+e,t))},n._isValidItem=function(e){return!!e},n._compareItemsBy=function(e,i,s){if("oldest"==e)return i.createTime-s.createTime;if("newest"==e)return s.createTime-i.createTime;if("title"==e){var n=i.sortTitle||t.try(i,"title.sortTitle"),r=s.sortTitle||t.try(s,"title.sortTitle");return n||r?n?r?n.localeCompare(r):1:-1:0}if("author"==e){var n=i.sortAuthor||t.try(i,"title.sortAuthor"),r=s.sortAuthor||t.try(s,"title.sortAuthor");return n||r?n?r?n.localeCompare(r):1:-1:0}return i.createTime&&s.createTime?i.createTime-s.createTime:0},n._rebuildLookupTable=function(){if(this.ITEM_KEY)return this._.lookupTable={},t.each(this.all,function(e){this._.lookupTable[e[this.ITEM_KEY]]=e},this),this._.lookupTable},s}),define("app/models/items/tagging",["require","common","app/models/items/item"],function(e){var t=e("common"),i=e("app/models/items/item"),s=i.new(),n=s.prototype;return n.$init=function(){this.type="tagging"},n.summarizeForVandal=function(){return t.absorb({tagUUID:this.collation.uuid,tagName:this.collation.name,titleSubjects:this.title.subjects},this.export())},n.card=function(){return void 0!==this._.card?this._.card:this.cardId?(this._.card=APP.patron.cards.find({cardId:this.cardId})||null,this._.card):this._.card=null},n.library=function(){return void 0!==this._.library?this._.library:(this.websiteId=t.try(this.card(),"library.websiteId")||this.websiteId,this.websiteId?(this._.library=APP.libraries.produce({websiteId:this.websiteId}),this._.library=t.try(this._.library,"dereference()"),
this._.library):this._.library=null)},n.save=function(){this.collation.isLoadingLocked()||this.collation.collation.save(),APP.services.vandal.updateTagging(this)},n._deserializeAttributes=function(e){e.titleId&&(this.title=APP.titles.produce({titleId:e.titleId}),this.title.format=this.title.format||e.titleFormat,this.title.sortTitle=this.title.sortTitle||e.sortTitle,this.title.sortAuthor=this.title.sortAuthor||e.sortAuthor),this.websiteId=e.websiteId||this.websiteId,this.cardId=e.cardId||this.cardId,this.createTime=e.createTime||this.createTime||0,this.properties=t.excise(e,"properties")||this.properties},n._serializeAttributes=function(){var e={};return t.try(this.title,"titleId")&&(e.titleId=this.title.titleId,e.titleFormat=this.title.format,e.sortTitle=this.title.sortTitle,e.sortAuthor=this.title.sortAuthor),e.websiteId=this.websiteId,e.cardId=this.cardId,e.createTime=this.createTime,e.properties=this.properties,e},s}),define("app/models/collations/tag",["require","common","app/models/collations/collation","app/models/items/tagging"],function(e){var t=e("common"),i=e("app/models/collations/collation"),s=i.new(),n=s.prototype;return n.ITEM_CLASS=e("app/models/items/tagging"),n.ITEM_NAME="tagging",n.PERSISTENCE=!1,n.rename=function(e,t){this.name=this._normalizeName(e),"string"==typeof t&&(this.description=t),this.save()},n.niceName=function(){return t.safe(this.name)},n.urlSafeName=function(){var e="",i=this.name.toLowerCase(),s=(t.try(this.collation,"all")||[]).slice();return s.sort(function(e,t){return e.createTime-t.createTime}),t.each(s,function(s){s===this&&t.breakIteration(),s.name.toLowerCase()===i&&(e+="~")},this),encodeURIComponent(this.name.toLowerCase()).replace(/%20/g,"+").replace(/\./g,"%2E")+e},n.path=function(e){return t.compact(["tags/tag",this.urlSafeName(),e]).join("/")},n.behave=function(e,i){if(!e)return this.behavior&&this.behavior.detach(),delete this.behavior,void this.save();var s=e;return"string"==typeof e?(e=null,t.each(APP.patron.tags.BEHAVIORS,function(i){i.prototype.KEY==s&&(e=new i,t.breakIteration())},this),console.assert(e,"[TAG] unrecognized tag behavior",s)):s=e.key,t.try(this.behavior,"key")!=s&&(this.behavior&&this.behavior.detach(),this.behavior=e,this.behavior.attach(this)),i&&this.behavior.import(i),this.save(),this.behavior},n.added=function(){this.isLoadingLocked()||APP.services.vandal.addTag(this)},n.removed=function(){t.each(this.all,function(e){t.try(e,"title.tags.all")&&(t.excise(e.title.tags.all,this),t.excise(e.title.tags.taggings||[],e))},this),this.isLoadingLocked()||APP.services.vandal.removeTag(this)},n.import=function(e,t){return this.loadingLock(function(){return i.prototype.import.call(this,e,t)}.bind(this))},n.addToTitle=function(e,i,s){var n=this.find({"title.titleId":e.titleId});if(!n){var r=t.absorb(s||{},{titleId:e.titleId,createTime:t.try(n,"createTime")||t.epochMilliseconds()});if(i=i||APP.library){var o=i.card();r.cardId=t.try(o,"cardId"),r.websiteId=i.websiteId}n=this.make(r,{source:"internal",integrity:"complete"}),e.tags.all=e.tags.all||[],e.tags.taggings=e.tags.taggings||[],e.tags.all.push(this),e.tags.taggings.push(n),this.totalTaggings+=1,this.collation.totalTaggings+=1,this.behavior&&this.behavior.addTagging(n),t.try(APP.patron.tags.titleIds,"push",e.titleId),APP.services.vandal.addTagging(n)}return n},n.removeFromTitle=function(e,i){var s=this.find({"title.titleId":e.titleId});if(s)return this.removeItem(s),e.tags.use(function(e,i){return e.isIdeal?(t.excise(i.all,this),void t.excise(i.taggings,s)):i.reuse()},this),s&&(this.totalTaggings-=1,this.collation.totalTaggings-=1,this.behavior&&this.behavior.removeTagging(s),t.try(i,"skipVandal")||APP.services.vandal.removeTagging(s)),s},n.save=function(){this.collation&&!this.isLoadingLocked()&&(this.collation.save(),APP.services.vandal.updateTag(this))},n.pathWithCriteria=function(e){return this.PATH_FOR_CRITERIA=this.path(),i.prototype.pathWithCriteria.apply(this,arguments)},n.criteria=function(){return{sort:["default","newest","oldest","title","author"],format:["all"].concat(APP.constants.formats()),availability:["everything","available"]}},n.collate=function(e){var t;t=e.format&&"all"!=e.format?this.filter({"title.format":e.format}):this.all.slice(0);var i=e.sort;return i&&"default"!=i||(i="newest"),t.sort(this._compareItemsBy.bind(this,i))},n.totalCount=function(){return this.totalTaggings||i.prototype.totalCount.call(this)},n.facetCount=function(e,s,n){if("availability"==e&&"available"==s)return 1/0;var r=i.prototype.facetCount.apply(this,arguments);return r&&!t.among(e,"sort","availability")&&"available"==n.availability?1/0:r},n.page=function(e,i,s,n,r){var o=t.absorb(e,{});o.sort&&"default"!=o.sort||(o.sort="newest"),isFinite(i)&&isFinite(s)&&(o.range=[i,s]),APP.services.vandal.taggingsForTag(this,o,function(i){this.loadingLock(function(){var s={source:"internal",integrity:"complete"},r=[];if(t.each(i.taggings,function(e){var t=this.produce({"title.titleId":e.titleId});t.import(e,s),r.push(t)},this),i.facetCounts){var a={format:{book:0,audiobook:0,magazine:0},availability:{everything:0}};t.absorb(t.try(i.facetCounts,"format"),a.format),t.each(a.format,function(e,t){a.availability.everything+=t}),this.facetCounts=this.facetCounts||{},this.facetCounts[this._criteriaSignature(e)]=a}this.totalTaggings!=i.totalTaggings&&(this.totalTaggings=i.totalTaggings||this.all.length,this.save()),r.sort(this._compareItemsBy.bind(this,o.sort)),"available"==e.availability?this._filterTaggingsByTitleAvailability(r,n):n(r)}.bind(this))}.bind(this),function(){var t=this.collate(e);t.length?n(t.slice(i,s)):r.apply(r,arguments)}.bind(this))},n._serializeAttributes=function(){var e={};return e.name=this.name,e.uuid=this.uuid,e.createTime=this.createTime,e.totalTaggings=this.totalTaggings||this.all.length,e.description=this.description,e.behaviors={},this.behavior&&(e.behaviors[this.behavior.key]=this.behavior.export()),e},n._serializeItems=function(){var e=this.collation.taggingsLimitForPersistence(),t=this.all.slice(0).reverse().slice(0,e);return i.prototype._serializeItems.call(this,t)},n._deserializeAttributes=function(e){this.name=this._normalizeName(e.name),this.uuid=e.uuid||t.generateUUID(),this.createTime=e.createTime||t.excise(e,"timestamp")||t.epochMilliseconds(),this.totalTaggings=e.totalTaggings||this.all.length,this.description=e.description||this.description;var i=!1;t.each(e.behaviors,function(e,s){this.behave(e,s),i=!0,t.breakIteration()},this),i||this.behave()},n._attributesToQuery=function(e){return{"title.titleId":e.titleId}},n._normalizeName=function(e){var e=(e||"").trim()||"🏷";return{"&#x1f4da;":"📚","&amp;#x1f4da;":"📚","&#x1f44d;":"👍","&amp;#x1f44d;":"👍","&#x1f44e;":"👎","&amp;#x1f44e;":"👎"}[e]||e},n._filterTaggingsByTitleAvailability=function(e,i){if(!e.length)return i([]);var s=e.slice(0),n=e.slice(0);t.each(e,function(e){e.title.holdings.withBestCircAction(function(r){if(!i)return"stop";if(t.among(r.action,"borrow","lucky-day")?t.excise(s,e):t.among(r.status,"complete","failed")&&(t.excise(s,e),t.excise(n,e)),!s.length){var o=i;i=null,o(n)}return t.among(e,s)?"continue":"stop"}.bind(this))},this)},s}),define("app/base/bank/migrations/b015",["require","common","./noop","app/models/collations/tag"],function(e){var t=e("common"),i=e("./noop"),s=i.new(),n=s.prototype,r=e("app/models/collations/tag");return n.migrate=function(e){var i=[],s=e.get("patron:tag:all");t.each(t.try(s,"all"),function(e){e.all.length&&(i.push({action:"tag:add",name:r.prototype._normalizeName(e.name),uuid:e.uuid,createTime:e.createTime||e.timestamp}),t.each(e.all,function(t){i.push({action:"tagging:add",tagUUID:e.uuid,tagName:r.prototype._normalizeName(e.name),titleId:t.titleId,websiteId:t.websiteId,cardId:t.cardId,createTime:t.createTime})}),t.excise(e,"all"))}),e.set("vandal:queue",i),e.set("patron:tag:all",s)},s}),define("app/base/bank/migrations/b016",["require","common","./noop"],function(e){var t=(e("common"),e("./noop")),i=t.new(),s=i.prototype;return s.migrate=function(e){var t=e.get("daemon:wish-list-sync");t&&(e.set("daemon:default-tags",{"wish-list-sync":t}),e.set("daemon:wish-list-sync"))},i}),define("app/base/bank/migrations/b017",["require","common","./noop"],function(e){var t=e("common"),i=e("./noop"),s=i.new(),n=s.prototype;return n.migrate=function(e){setTimeout(this._deferredTagNameUpdate.bind(this),1e3)},n._deferredTagNameUpdate=function(){var e=0;t.each(APP.patron.tags.all,function(i){var s=i.name,n=t.element({html:i.name}).innerText;(s!=n||s.indexOf(".")>=0)&&(i.rename(n),APP.services.vandal.updateTag(i),e+=1)}),e&&APP.patron.tags._saveNow()},s}),define("app/base/bank/migrations/b019",["require","common","./noop"],function(e){var t=(e("common"),e("./noop")),i=t.new(),s=i.prototype;return s.migrate=function(e){e.set("codex")},i}),define("app/base/bank/migrations/b020",["require","common","./noop"],function(e){var t=e("common"),i=e("./noop"),s=i.new(),n=s.prototype;return n.migrate=function(e){var i=e.get("list:preferences");if(i){var s=e.get("patron:pin:all")||{},n=[];t.each(s.all,function(e){"title"!=e.scope&&n.push(e)}),s.all=n,t.each(i,function(e,i){if(t.try(i,"values.length")){var s={scope:"title"};s.category={sort:"sort",availability:"availability",format:"format",audience:"audience",language:"language",supports:"fulfillable"}[e.replace(/^list.parameters./,"")],t.each(i.values,function(e){"audience"==s.category&&(e={1:"juvenile",2:"youngadult",3:"generalcontent",4:"adultonly"}[""+e]),s.category&&e&&n.push(t.absorb(s,{value:e}))})}}),e.set("patron:pin:all",s),e.set("list:preferences")}},s}),define("app/base/bank/migrations/b021",["require","common","./noop"],function(e){var t=e("common"),i=e("./noop"),s=i.new(),n=s.prototype;return n.migrate=function(e){var i=[],s=[],n=t.try(e.get("patron:loan:all"),"all");t.each(n,function(e){var n=e.downloader;if(n){var r={};r.titleId=e.titleId,r.websiteId=e.websiteId,r.psnKey=[e.cardId,r.titleId].join("-"),n.urls&&(r.urls=t.absorb(n.urls,{}),r.expiresAt=t.excise(r.urls,"expires"),i.push(r));var o={titleId:r.titleId,storageChoice:n.autoDownload?"download":"stream",rosters:[]},a=n.downloadPercent||0;n.totalBytes&&(o.bytes={total:n.totalBytes,downloaded:n.totalBytes*a,percent:a}),t.each(n.rosterIds,function(e){var i=e.match(/^(title-(map|content))-(.{9})/);r.bankScope=r.bankScope||"title-"+t.try(i,"[3]");var s={id:e};s.health=a>=1?"valid":"invalid",s.group=t.try(i,"[1]"),o.rosters.push(s)}),s.push(o)}}),e.set("title:passport:all",{all:i}),e.set("title:luggage:all",{all:s})},s}),define("app/base/bank/migrations/b022",["require","common","./noop"],function(e){var t=e("common"),i=e("./noop"),s=i.new(),n=s.prototype;return n.migrate=function(e){var i=e.get("app:flags:overrides")||{};t.try(i,"joystick.reason")&&i.joystick.reason.match(/^b018:/)&&(t.excise(i,"joystick"),e.set("app:flags:overrides",i))},s}),define("app/base/bank/bank-migrator",["require","common","app/base/journal","./migrations/noop","./migrations/noop","./migrations/noop","./migrations/b003","./migrations/b004","./migrations/b005","./migrations/b006","./migrations/b007","./migrations/b008","./migrations/b009","./migrations/b010","./migrations/b011","./migrations/b012","./migrations/b013","./migrations/b014","./migrations/b015","./migrations/b016","./migrations/b017","./migrations/noop","./migrations/b019","./migrations/b020","./migrations/b021","./migrations/b022"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("app/base/journal");return s.BANK_VERSION_KEY="_bank-version",s.BANK_MIGRATIONS=[e("./migrations/noop"),e("./migrations/noop"),e("./migrations/noop"),e("./migrations/b003"),e("./migrations/b004"),e("./migrations/b005"),e("./migrations/b006"),e("./migrations/b007"),e("./migrations/b008"),e("./migrations/b009"),e("./migrations/b010"),e("./migrations/b011"),e("./migrations/b012"),e("./migrations/b013"),e("./migrations/b014"),e("./migrations/b015"),e("./migrations/b016"),e("./migrations/b017"),e("./migrations/noop"),e("./migrations/b019"),e("./migrations/b020"),e("./migrations/b021"),e("./migrations/b022")],s.$init=function(){this.journal=new n({consolePrefix:"[BANK-MIGRATOR]"})},s.migrate=function(e){var i,s=e.get(this.BANK_VERSION_KEY),n=this._versionToIndex(s)||0,r=0;this.journal.log("initial version is "+s+" ("+n+")"),t.each(this.BANK_MIGRATIONS,function(s,o){if(n>=o)return r=o;try{var a=this._performMigration(e,s,o);t.isEmpty(a.add)&&t.isEmpty(a.del)||e.set(this._indexToMigrationDataKey(o),a),r=o,i=this._indexToVersion(r),this.journal.info("migrated to "+i+" ("+r+")")}catch(e){this.journal.warn("migration failed:",e)}},this),i=i||this._indexToVersion(r),i&&i!=s&&(this.journal.info("revised version is "+i+" ("+r+")"),e.set(this.BANK_VERSION_KEY,s=i));var o=[],a=[],l=t.epochMilliseconds();if(t.each(e._.data,function(e,t){var i=e.match(/^migration:(b\d+)$/);if(i){var s=this._versionToIndex(i[1]);s>r&&(o[s]=t,t.exp=l),t.exp&&t.exp<=l&&a.push(e)}},this),o.length)try{t.each(o.reverse(),this._reverseMigration.bind(this,e)),this.journal.info("reversed to "+s)}catch(e){this.journal.warn("reversal failed:",e)}t.each(a,function(t){this.journal.info("erasing expired data "+t),e.set(t)},this)},s._performMigration=function(e,i,s){var n=t.clone(e._.data),r=new i;r.migrate(e);var o=this._jsonDiff(n,e._.data);return o.exp=t.epochMilliseconds()+r.DELTA_TTL,o.del&&o.del["sentry.chip"]&&APP.events.dispatch("investigate:record",{what:"sentry chip modified by bank migration",where:"BankMigrator#_performMigration",why:"INV-BANK002 INV-BANK002-D",migrationVersion:this._indexToVersion(s)}),o},s._reverseMigration=function(e,i){i&&(t.each(i.del,function(t,s){delete i.add[t];var n=t.split(" > "),r=n.shift(),o=e.get(r);if(o&&n.length){for(var a=o;n.length>1;){var l=n.shift();a[l]||(a[l]={}),a=a[l]}a[n.shift()]=s}else o=s;e.set(r,o)}),t.each(i.add,function(t){var i=t.split(" > "),s=i.shift(),n=e.get(s);if(n&&i.length){for(var r=n;i.length>1&&r;)r=r[i.shift()];r&&i[0]&&delete r[i.shift()]}else n=void 0;e.set(s,n)}))},s._versionToIndex=function(e){e=(e||"")+"",e=e.replace(/[^\d]+/,"");parseFloat(e);if(isFinite(e))return Math.round(e)},s._indexToVersion=function(e){return"b"+(parseFloat(e)+1e3).toString().substring(1)},s._indexToMigrationDataKey=function(e){return"migration:"+this._indexToVersion(e)},s._jsonDiff=function(e,i){var s=function(e){return"object"==typeof e&&!t.isList(e)},n=function(e,i,r,o){return t.each(i,function(t,i){var a=e.concat([t]);"undefined"==typeof r[t]?o[a.join(" > ")]=i:s(i)&&s(r[t])?n(a,i,r[t],o):JSON.stringify(i)!=JSON.stringify(r[t])&&(o[a.join(" > ")]=i)}),o},r={del:n([],e,i,{}),add:n([],i,e,{})};return t.each(r.add,function(e,t){r.add[e]="<"+typeof t+">"}),r},i}),define("app/base/shell/shell-none",["require","common","quirkbase","app/base/bank/bank-scope-domain","app/base/bank/bank-migrator"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("quirkbase"),r=e("app/base/bank/bank-scope-domain"),o=e("app/base/bank/bank-migrator");return s.BANK_SCOPE="dewey",s.$init=function(){this.info={},this._.backlog=[],this._listen(),this.capabilities=this._detectCapabilities()},s.has=function(e){return!!this.capability(e)},s.capability=function(e){return this.capabilities[e]},s.transmit=function(e){"string"==typeof e&&(e={name:e}),"string"!=typeof e.dest&&(e.dest="shell"),this._dispatchMessageObject(e)},s.convey=function(e,t){this.transmit({name:"bank:write",scope:"conveyance",key:e,value:t})},s.start=function(e){this._.onStartedCallback=e,this._onStarted(new r(this.BANK_SCOPE))},s.releaseBacklog=function(){this._.backlog&&(t.each(this._.backlog,function(e){APP.events.dispatch(e[0],e[1])}),this._.oldBacklog=this._.backlog,delete this._.backlog)},s.colorize=function(e,i){var s=["","search","theatre","bifocal","force"],n=s.indexOf(i);for(n<0&&(n=0),this._.colorizeLocks=this._.colorizeLocks||[],this._.colorizeLocks[n]=e;this._.colorizeLocks.length&&!t.last(this._.colorizeLocks);)this._.colorizeLocks.pop();var r=t.last(this._.colorizeLocks)||this.DEFAULT_SURFACE_COLOR,o={immersive:!1};if("none"==r)o.immersive=!0,o.rgba=t.try(this,"_.colorizeLast.rgba")||[255,255,255,1];else if("string"==typeof r)o.rgba=t.hexToRGB(r);else{if(!(t.isList(r)&&r.length>=3))return e?APP.journal.warn("[SHELL] unknown colorize value: "+e):void 0;o.rgba=r.slice(0,4)}o.rgba[3]=o.rgba[3]||1,o.hsluv=t.rgbToHSLuv(o.rgba.slice(0,3)),o.yiq=t.colorYIQ(o.rgba),o.tint=o.hsluv[2]>=APP.coverGuru.TINT_THRESHOLD?"light":"dark",JSON.stringify(o)!=JSON.stringify(this._.colorizeLast)&&(clearTimeout(this._.colorizeTimer),this._.memoColorize={colors:o,lock:s[this._.colorizeLocks.length-1]||""},this._.colorizeTimer=setTimeout(this._performColorization.bind(this),16),this._.colorizeLast=t.clone(o))},s.openURL=function(e,i){var s=0===e.indexOf(APP.constants.ROOT_URI);if(i=t.absorb(i,{inExternalApp:s}),APP.journal.info("[SHELL] opening URL:",e),s&&"Android"==this.info.platform&&(window.location.href="googlechrome://navigate?url="+e,i.sameWindow="prevent"),this.has("nav:url:handle"))return this.transmit({name:"nav:url:handle",url:e,openWithExternalApp:!!i.inExternalApp}),!0;var n=this.info.platform?"prevent":i.sameWindow;return!("force"==n||!window.open(e,"_blank"))||"prevent"!=n&&(window.location.href=e,!0)},s.bindOpenURL=function(e){return this.openURL.bind(this,e)},s.oauthRequest=function(e){var i=/^([^:]+:)?\/\//,s=/^[^:]+(?=(:?\/\/))/,n=e.navigate,r=e.callback,o=APP.constants.ROOT_URI.replace(s,"https");n.match(i)||(n=[o,n].join("/")),r.match(i)||(r=[o,r].join("/"));var a=this.capability("ui:oauth");if(!a)return n=t.parameterizeURL(n,{continuation:r}),APP.journal.info("[SHELL] navigating to OAuth URL:",n),window.location.replace(n);r=r.replace(s,a),n=t.parameterizeURL(n,{continuation:r}),APP.journal.debug("[SHELL] sending OAuth request:",n);var l=function(){APP.events.off(t.excise(this._,"oauthHandlers"))}.bind(this);l(),this._.oauthHandlers=[APP.events.on("msg:ui:oauth:callback",function(i){l();var s=t.absorb(i.m,{});if(s.url){var n=s.url.replace(/^[^\?]*/,"");s=t.absorb(s,t.queryStringToObject(n))}e.onSuccess(s)}.bind(this)),APP.events.on("msg:ui:oauth:canceled",function(t){l(),e.onFailure({response:{result:"authentication_canceled"}})}.bind(this))],this.transmit({name:"ui:oauth:request",url:n})},s._onStarted=function(e){var t=new o;APP.events.dispatch("investigate:dewey-bank-data-before-migration",{bank:e,migrator:t}),t.migrate(e),APP.events.dispatch("investigate:dewey-bank-data-after-migration",{bank:e,migrator:t}),APP.network.prime(this._.onStartedCallback.bind(this,e)),delete this._.onStartedCallback},s._applyCompatibilityClass=function(e){document.documentElement.classList.add("compat-"+e)},s._detectCapabilities=function(e){var i={};return!this.info.platform&&n.ask("ios-standalone")?(i["device:ios-web-app"]=!0,i["device:soft-keyboard"]=!0):navigator.userAgent.match(/Android|iOS/)&&(i["device:soft-keyboard"]=!0),"geolocation"in navigator&&!navigator.userAgent.match(/Edge/)&&(i.geolocation="navigator"),t.absorb(e,i)},s._listen=function(){APP.events.on(window,"message",this._onWindowMessageEvent.bind(this)),APP.events.on("debug:command",this._onDebugCommand.bind(this))},s._onWindowMessageEvent=function(e){var i=e.data;if("string"==typeof i)try{i=JSON.parse(i)}catch(e){i={name:i}}i&&i.name&&this._routeMessageObject(t.absorb(i,{source:"bifocal"}))},s._routeMessageObject=function(e){e.dest&&"client"!=e.dest?this._dispatchMessageObject(e):this._receiveMessageObject(e)},s._receiveMessageObject=function(e){var i=t.absorb(e,{});delete i.name,delete i.dest;var s="msg:"+e.name;this._.backlog?this._.backlog.push([s,i]):APP.events.dispatch(s,i)},s._dispatchMessageObject=function(e){e=t.absorb(e,{source:"client"}),"bifocal"==e.dest&&t.try(APP.lectern.session,"check()")&&APP.lectern.bifocal.transmit(e)},s._bridgeMessageEventType=function(e){var t=this.info.spec||APP.client.info.spec;return t>9?"bridge:"+e:"dewey:bridge:"+e},s._performColorization=function(){if(this._.memoColorize){var e=this._.memoColorize.colors,i=e.rgba?t.rgbToHex(e.rgba):"#FFF",s=document.querySelector('meta[name="theme-color"]');s&&s.setAttribute("content",i)}},s._onDebugCommand=function(e){var t=(e.m.command||"").trim();if("bank"==t)return e.m.output+=JSON.stringify(APP.bank._.data,null,2);var i=t.match(/^bank (get|set) ([^\s]+)\s*([^\s]+)?/i);i&&("get"==i[1]?e.m.output+=APP.bank.get(i[2]):"set"==i[1]&&(e.m.output+=APP.bank.set(i[2],i[3]||void 0)||"[CLEARED]"))},i}),define("app/base/bank/bank-scope-native",["require","./bank-scope-memory"],function(e){var t=e("./bank-scope-memory"),i=t.new(),s=i.prototype;return s.COMMIT_DELAY_MS=1e3,s._commit=function(){this._eachFlushKey(function(e){APP.shell.transmit({name:"bank:write",scope:this._.name,key:e,value:this.get(e)})})},i}),define("app/base/shell/shell-native",["require","common","./shell-none","quirkbase","app/base/bank/bank-scope-native","app/base/bank/bank-scope-domain","shibui"],function(e){var t=e("common"),i=e("./shell-none"),s=i.new(),n=s.prototype,r=e("quirkbase"),o=e("app/base/bank/bank-scope-native"),a=e("app/base/bank/bank-scope-domain"),l=e("shibui");return n.DEFAULT_SURFACE_COLOR=[255,255,255],n.$init=function(e){this.info=e,this._.backlog=[]},n.start=function(e){this._.onStartedCallback=e,this._waitForBridge()},n._waitForBridge=function(){t.defer(this,"wait-for-bridge"),(this.bridge=this.bridge||this._constructBridge())?this._onBridgeStarted():t.defer(this,"wait-for-bridge",this._waitForBridge.bind(this),10)},n._constructBridge=function(){var e=window.BRIDGE;if(!e)return null;var t={};return"function"==typeof e.clientToShellAsJSON?t.clientToShellAsJSON=e.clientToShellAsJSON.bind(e):"function"==typeof e.clientToShell?t.clientToShellAsJSON=function(t){e.clientToShell(JSON.parse(t))}:t.clientToShellAsJSON=this._clientToShellFallback.bind(this),"function"==typeof e.capabilities?t.capabilities=e.capabilities():t.capabilities=e.capabilities,"string"==typeof t.capabilities&&(t.capabilities=JSON.parse(t.capabilities)),"function"==typeof e.userAgent?t.userAgent=e.userAgent():t.userAgent=e.userAgent,"function"==typeof e.environment?t.environment=e.environment():t.environment=e.environment,t.environment=t.environment||"",t.userAgent=t.userAgent||navigator.userAgent,t.capabilities=t.capabilities||{},t},n._onBridgeStarted=function(){this.capabilities=this._detectCapabilities(t.excise(this.bridge,"capabilities")),this._detectCompatibilityClasses(),this._listen(),this._requestTraits(),this._sendShortcuts(),this._startBank()},n._detectCapabilities=function(e){var s=i.prototype._detectCapabilities.call(this);s.rosters=!0,s["ui:oauth"]=!1,t.among(this.info.platform,"iOS","Android")&&(s["diagnostics:platform-settings"]=["app"],r.ask("ios>=13")&&s["diagnostics:platform-settings"].push("app-language"));var n=t.absorb(s,{});return t.each(e,function(e,t){t&&"null"!==t&&"[unknown]"!==t&&(e.match(/^notifier/)?n[e]=this._meetsMinimumNotifierVersion()&&t:n[e]=t)},this),n},n._detectCompatibilityClasses=function(){this._applyCompatibilityClass("bridged-"+this.info.platform.toLowerCase()),r.ask("android-chrome chrome<40")&&this._applyCompatibilityClass("kitkat-webview")},n._listen=function(){i.prototype._listen.call(this),APP.events.on(window,this._bridgeMessageEventType("receive"),this._onBridgeMessageEvent.bind(this)),this.has("network:request-override")&&APP.events.on("network:request",this._onNetworkRequest.bind(this)),APP.events.on("title:switch",this._onTitleSwitch.bind(this)),APP.events.on("msg:platform:traits",this._recordTraits.bind(this)),APP.events.on("aide:lighting",this._performColorization.bind(this))},n._requestTraits=function(){this.transmit("platform:traits")},n._recordTraits=function(e){var i=this.traits=t.clone(e.m);delete i.name,delete i.dest,delete i.source,t.defer(this,"traits",function(){APP.events.dispatch("platform:traits",{traits:i})})},n._sendShortcuts=function(){var e=[{type:"nav:library:root",title:l.Phrasebook.text("footer.nav.library")},{type:"nav:shelf:root",title:l.Phrasebook.text("footer.nav.shelf")}];t.try(APP.title,"title")&&e.push({type:"nav:title",title:APP.title.title}),this.transmit({name:"nav:shortcuts",shortcuts:e})},n._startBank=function(){this.has("bank")?this.transmit({name:"bank:read",dest:"shell",source:"client",scopes:[this.BANK_SCOPE]}):(APP.events.dispatch("investigate:record",{what:"native shell with no bank capability",where:"ShellNative#_startBank",capabilities:this.capabilities}),this._onStarted(new a(this.BANK_SCOPE)))},n._onBankScopes=function(e){var t=e[this.BANK_SCOPE];APP.events.dispatch("investigate:dewey-bank-data-received",{bankData:t});var i=new o(this.BANK_SCOPE,t);this._onStarted(i)},n._onBridgeMessageEvent=function(e){this._routeMessageObject(t.absorb(e.detail,{source:"shell"})),e.preventDefault()},n._receiveMessageObject=function(e){this._logMessageObject(e),"bank:read"==e.name&&e.scopes[this.BANK_SCOPE]&&this._.onStartedCallback?this._onBankScopes(e.scopes):"network:info"==e.name?APP.network._onInfo(e):"platform:capabilities"==e.name?(this.capabilities=this._detectCapabilities(e.capabilities),APP.events.dispatch("platform:capabilities",{capabilities:this.capabilities})):i.prototype._receiveMessageObject.call(this,e)},n._dispatchMessageObject=function(e){e=t.absorb(e,{source:"client"}),this._logMessageObject(e);var i=this._safenObjectToJSON(e);this.bridge.clientToShellAsJSON(i)},n._safenObjectToJSON=function(e){var t=JSON.stringify(e);return"undefined"==typeof this._.jsonStringifyEscapesSeparators&&(this._.jsonStringifyEscapesSeparators='["\u2028\u2029"]'!==JSON.stringify(["\u2028\u2029"])),this._.jsonStringifyEscapesSeparators||(t=t.replace(/\u2028/g,"\\u2028"),t=t.replace(/\u2029/g,"\\u2029")),t},n._clientToShellFallback=function(e){var t=JSON.parse(e),i=this._bridgeMessageEventType("send"),s=new CustomEvent(i,{detail:t});window.dispatchEvent(s)},n._logMessageObject=function(e){this.info&&"DEBUG"==this.info.mode&&APP.journal.debug("[BRIDGE] ➜ %s — %s %o",e.dest,e.name,e)},n._onNetworkRequest=function(e){var i=e.m;if(this._isOverridableRequest(i)){var s={};i.method&&(s.method=i.method),i.headers&&(s.headers=i.headers),i.body&&(s.body=i.body),i.url+=i.url.match(/\?/)?"&":"?",i.url+="_override="+t.base64EncodeSafely(JSON.stringify(s)),i.method="GET",i.headers={},i.body=null}},n._isOverridableRequest=function(e){if(0!=e.url.indexOf("/")&&0!=e.url.indexOf(location.origin))return!1;if("GET"!=e.method)return!0;for(var t in e.headers)return!0},n._onTitleSwitch=function(e){this._sendShortcuts()},n._performColorization=function(){if(i.prototype._performColorization.apply(this,arguments),this._.memoColorize){var e=this._.memoColorize.colors,s=this._.memoColorize.lock,n=t.clone(e);t.excise(n,"immersive");var r={};"bifocal"==s&&"book"==t.try(APP.title,"format")?r=n:"dark"==APP.semaphore.get("aide-lighting")?(r.tint="dark",r.rgba=[0,0,0,1],r.yiq=0):(r.tint="light",r.rgba=[255,255,255,1],r.yiq=255),this.transmit({name:"surface:tint",immersive:e.immersive,top:n,bottom:r,tint:e.immersive?"none":e.tint})}},n._meetsMinimumNotifierVersion=function(){var e=this.info.platform.toLowerCase();return("ios"!=e||!APP.shell.info.version.isOlderThan("3.0.0"))&&(("android"!=e||!APP.shell.info.version.isOlderThan("3.0.3"))&&APP.shell.info.spec>=17)},s}),define("app/base/shell/shell-chooser",["require","common","app/base/quirks","app/base/version","./shell-none","./shell-native"],function(e){var t={},i=e("common"),s=e("app/base/quirks"),n=e("app/base/version"),r={None:e("./shell-none"),Native:e("./shell-native")};return t.select=function(){var e=i.absorb(s.shellInfo,{});return e.spec>=2?(e.version=function(){var t=new n;return t.assign(e.version),t}(),new r.Native(e)):new r.None},t}),define("app/base/err",["require","common","shibui"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("shibui");return s.$init=function(e,i){this.id=e,this.errorData=i,this.errorMessage=t.excise(i,"errorMessage")||this.id,this.errorHumanReadable=t.excise(i,"errorHumanReadable")||this.title().replace(/\.$/,""),i.errorCode&&(this.errorCode=this.errorMessage+" -- "+t.excise(i,"errorCode")),this.errorSource=t.excise(i,"errorSource"),this.timestamp=t.epochMilliseconds()},s.sendToSage=function(e){if("deny"==APP.bank.get("sage:permission"))return this;var i=t.absorb(e,{});return i.errorHumanReadable=this.errorHumanReadable,i.errorMessage=this.errorMessage,i.errorSource=this.errorSource,i.errorData=t.absorb(this.errorData,{}),i.submissionContext=t.excise(i.errorData,"submissionContext"),APP.sage.submit("error",i,function(e){this.sageId=e}.bind(this)),this},s.present=function(){try{APP.events.dispatch("app:error:presenting",{error:this},!0)&&APP.arena.dom.notices.dom.error.present(this)}catch(e){APP.journal.warn("[ERR] exception caught while presenting:",this,e)}return this},s.title=function(){return n.Phrasebook.text("error."+this.id+".title")||"Unlocalized error: "+this.id},s.explanation=function(){return n.Phrasebook.text("error."+this.id+".explanation")},i}),define("app/base/flags",["require","common"],function(require){var C=require("common"),CLASS=C.Class.new(),PROTO=CLASS.prototype;return PROTO.FLAGS={},PROTO.BANK_KEY_OVERRIDES="app:flags:overrides",PROTO.$init=function(){this._.config=this._reloadConfiguration(),APP.events.on("debug:command",this._onDebugCommand.bind(this))},PROTO.isOn=function(e){return!!this.property(e,"enabled")},PROTO.isOff=function(e){return!this.isOn(e)},PROTO.override=function(e,t){var i=APP.bank.get(this.BANK_KEY_OVERRIDES)||{};return"boolean"==typeof t?(i[e]=i[e]||{},i[e].enabled=t):"undefined"!=typeof t?i[e]=t:delete i[e],"{}"==JSON.stringify(i)&&(i=void 0),APP.bank.set(this.BANK_KEY_OVERRIDES,i),this._.config=this._reloadConfiguration(),this._.config[e]},PROTO.property=function(e,t){return"string"==typeof t?C.try(this._.config,e+"."+t):this._.config[e]},PROTO._reloadConfiguration=function(){return C.absorb(APP.bank.get(this.BANK_KEY_OVERRIDES)||{},C.clone(this.FLAGS))},PROTO._onDebugCommand=function(evt){if(!evt.m.output){var cmd=(evt.m.command||"").trim(),match;if("flags"==cmd)evt.m.output=this._.config;else if(match=cmd.match(/^flag\s+([\w-]+)(\s(.+))?/i)){var flag=match[1];match[3]?(this.override(flag,eval(match[3])),evt.m.output=this._.config):evt.m.output=this._.config[flag]||"NO SUCH FLAG: "+flag}}},CLASS}),define("app/base/routing/historian",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.$init=function(){this._.realmOrder=[],this.future=[],APP.events.on(window,"popstate",this._onPopState.bind(this)),APP.events.on("router:navigate",this._onRouterNavigation.bind(this)),window.history.pushState(this._historyState(),document.title)},s.updateLocation=function(e,t){t=t||{},t.title&&this.updateTitle(t.title);var i=this._.pop||t.push?"pushState":"replaceState";window.history[i](this._historyState(),document.title,"/"+e)},s.updateTitle=function(e){document.title=this._titleForRoute(e)},s.history=function(){var e=[];return t.each(this._.realmOrder,function(t){for(var i=APP.router.waypoints[t]||[],s=0;s<i.length;++s){var n=i[s].path,r=n!=APP.router.route.path;r=r&&this.future.indexOf(n)<0,r&&e.push(n)}},this),e},s.rewind=function(e){var t=Math.max(0,e?e-1:0),i=this.history();for(this.future.unshift(APP.router.route.path);t&&i.length;)this.future.unshift(i.shift()),t-=1;var s=i.shift();if(s)return this._.pop=s,this.future.unshift(s),APP.router.navigate(this._.pop),s},s._historyState=function(){return this._.count=(this._.count||0)+1,{count:this._.count}},s._onPopState=function(e){APP.nav.back()||window.history.back()},s._onRouterNavigation=function(e){this._.realmOrder[0]!=APP.router.realm&&(t.excise(this._.realmOrder,APP.router.realm),this._.realmOrder.unshift(APP.router.realm)),this._.pop||this.future.splice(0),delete this._.pop,this._publishNavHistory()},s._publishNavHistory=function(){APP.shell.transmit({name:"nav:history",records:this.history()})},s._titleForRoute=function(e){this._.baseTitle||(this._.baseTitle=document.title);var i=e?[this._.baseTitle,e].join(" - "):this._.baseTitle;return t.decodeEntitiesInString(i);
},i}),define("app/base/routing/waypoint",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.$init=function(e){this.route=e,this.name=APP.arena._phrase("loading")},s.configure=function(e){e=t.absorb(e,{}),e.label&&(e.name=e.name||APP.arena._phrase(e),delete e.label,delete e.substitutions);var i=!1,s=["name","topName","path","color","origination"];t.each(s,function(t){if(e[t]){var s=this[t],n=e[t];try{s=JSON.stringify(s)}catch(e){}try{n=JSON.stringify(n)}catch(e){}s!=n&&(this[t]=e[t],i=!0)}},this),i&&this._changed()},s.clone=function(){var e=new i(this.route);return e.name=this.name,e.color=this.color,e.origination=this.origination,e},s.onChange=function(e){this._.onChangeCallbacks=this._.onChangeCallbacks||[],this._.onChangeCallbacks.push(e)},s._changed=function(){this==t.try(APP.router,"route.waypoint")&&APP.historian.updateTitle(this.name),t.each(this._.onChangeCallbacks,function(e){e(this)}.bind(this))},i}),define("app/controllers/controller",["require","common","app/base/routing/waypoint"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("app/base/routing/waypoint");return s.SUB_CONTROLLERS=[],s.$init=function(){this.path=null,this.ancestor=null,this.segments={},this.waypoint=new n(this),this._.eventHandlers=[],this._defaults()},s.configure=function(){this.realm=t.try(this.ancestor,"realm")||APP.router.TRANSIENT_REALM},s.match=function(e,t,i){},s.refine=function(e,t,i){},s.enter=function(){},s.usher=function(e){},s.fill=function(){},s.unfill=function(){},s.focus=function(){this._.hasFocus=!0;var e="function"==typeof this.screen?this.screen():this.screen;e&&"function"==typeof e.focus&&e.focus()},s.refocus=function(){var e="function"==typeof this.screen?this.screen():this.screen;e&&"function"==typeof e.focus&&e.focus(),t.try(e,"scroller.scrollToTop()")},s.blur=function(){this._.hasFocus=!1;var e="function"==typeof this.screen?this.screen():this.screen;e&&"function"==typeof e.blur&&e.blur()},s.eject=function(){},s.exit=function(){var e="function"==typeof this.screen?this.screen():this.screen;e&&"function"==typeof e.extract&&e.extract(),"function"!=typeof this.screen&&delete this.screen},s.on=function(e,i,s,n){var r=APP.events.on.apply(APP.events,arguments);return t.excise(this._.eventHandlers,r),this._.eventHandlers.push(r),r},s.off=function(e){arguments.length>0?(APP.events.off(e),t.each(t.flatten[e],function(e){this._.eventHandlers.excise(e)})):(APP.events.off(this._.eventHandlers),this._.eventHandlers.splice(0))},s._defaults=function(){this.realm=null,this.historical=!1,this.root=!1},i}),define("app/controllers/redirect-controller",["require","common","app/controllers/controller"],function(e){var t=e("common"),i=e("app/controllers/controller"),s=i.new(),n=s.prototype;return n.match=function(e,i,s){if(!e.match(/^interview\/version/)){var n=APP.versionValet.check();if(n)return APP.versionValet.next=e+i+s,APP.interviews.nextAssignments={reason:n},{rewrite:"interview/version/upgrade"};if(!APP.versionValet.hasAcknowledgedLatestFeatures()){APP.versionValet.next=e+i+s;var r=e||i?{next:e+i}:void 0;return{rewrite:t.parameterizeURL("interview/version/features",r)}}if(APP.summoner.daemons.userLanguage.isUsingNewLocale)return{rewrite:"interview/version/locale"}}if(!e.match(/interview\/reset/)&&APP.investigator.isChipMissingFromBank())return{rewrite:"interview/reset/chip-data"};if(!e&&APP.library&&(APP.library.baseKey||APP.library.websiteId))return{rewrite:"shelf"};if(!e||"welcome"==e)return{rewrite:"interview/welcome"};if("timeline"==e)return{rewrite:"shelf/timeline/all,loans"};if("interview"==e)return{rewrite:"interview/menu"};var o=e.match(/^authenticate\/([\w\-]+)\/?([^\?\#]*)/);if(o){var r=t.queryStringToObject(i)||{};return t.absorb({key:o[1],cardId:o[2]||void 0},r),{rewrite:t.parameterizeURL("interview/authenticate/card",r)}}var o=e.match(/^resolve\/([\w\-]+)?\/?([^\?\#]*)/);if(o){var r=t.queryStringToObject(i)||{};return t.absorb({key:o[1],next:o[2]||void 0},r),{rewrite:t.parameterizeURL("interview/locate-library/resolve",r)}}return"unsubscribe"==e?{rewrite:"interview/configure/unsubscribe"+i}:void 0},s}),define("shibui/src/view",["require","common","gala","./illustrator","./phrasebook"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("gala"),r=e("./illustrator"),o=e("./phrasebook");return s.$init=function(e){e&&this.impart(e)},s.impart=function(e,t){var s=this._._extraction;if(delete this._._extraction,e||s){this._impartViews(s),this._listenHandlers(),this._prepare();var n={view:this,dom:this.dom};return e instanceof i&&(n.parentView=e,e=e.dom.appendix||e.dom.root),e&&e.firstChild&&"prepend"==t?e.insertBefore(this.dom.root,e.firstChild):e?e.parentNode&&"before"==t?e.parentNode.insertBefore(this.dom.root,e):e.parentNode&&"after"==t?e.nextSibling?e.parentNode.insertBefore(this.dom.root,e.nextSibling):e.parentNode.appendChild(this.dom.root):e.appendChild(this.dom.root):s&&s.sibling&&s.sibling.parentNode==s.parent?s.parent.insertBefore(this.dom.root,s.sibling):s?s.parent.appendChild(this.dom.root):this.isInDocument()||console.trace("[VIEW] cannot impart to null node:",this.dom.root.className),this.access(this.dom.root),this._dispatch("view:impart",n),this.dom}},s.extract=function(){if(this._._extraction)return this.dom;this._dispatch("view:extract",{view:this,dom:this.dom}),this._deafenHandlers();var e=t.try(this.dom,"root.parentNode");return e&&(this._._extraction={parent:e,sibling:this.dom.root.nextSibling,views:this._extractViews()},e.removeChild(this.dom.root)),this.dom},s.isInDocument=function(){return t.try(this,"dom.root")&&t.isInDOM(this.dom.root)},s.appendChild=function(e){this._prepare(),(this.dom.appendix||this.dom.root).appendChild(e)},s.access=function(e,i){if(!t.isElement(e)&&(i=e,e=t.try(this.dom,"root"),!t.isElement(e)))return console.warn("[VIEW] cannot assign access",e,i);i||(i=this._attr(e,"data-access")),"string"==typeof i&&(i=i.split(/\s+/)),i=t.compact(t.flatten([i])),t.excise(i,"normal");var s=[];delete e._accessAttributes,t.each(i,function(i){i&&"string"==typeof i?s.push(i):e._accessAttributes=t.absorb(i,e._accessAttributes||{})}),this._attr(e,"data-access",s.join(" ")||null);for(var n,r=[],o=e.parentNode;t.isElement(o);)(n=this._attr(o,"data-access"))&&(r=r.concat(n.split(/\s+/))),o=o.parentNode;var a=function(e,i){n=this._attr(e,"data-access")||"",n&&(i=n.split(/\s+/).concat(i));var s=this._attr(e,"role");n.indexOf("spoken")>=0?this._attr(e,"role",s||"text"):"text"==s&&this._attr(e,"role",null);var r=t.among("inert",i)||t.among("visual",i);return this._attr(e,"aria-hidden",r?"true":null),this._attr(e,"disabled",t.try(e._accessAttributes,"disabled")),this._attr(e,"tabindex",t.try(e._accessAttributes,"tabindex")),this._isInteractiveElement(e)?t.among("inert",i)?(e==document.activeElement&&e.blur(),this._attr(e,"disabled",!0),this._attr(e,"tabindex",-1)):t.among("visual",i)&&(e==document.activeElement&&e.blur(),this._attr(e,"disabled",null),this._attr(e,"tabindex",-1)):e.classList.contains("native-scrollable")&&(t.among("inert",i)||t.among("visual",i))&&this._attr(e,"tabindex",-1),t.each(e._accessAttributes,this._attr.bind(this,e)),e.namespaceURI==document.documentElement.namespaceURI&&t.each(e.children,function(e){a(e,i)}),e}.bind(this);return a(e,r)},s.on=function(e,t){var i=null===this._.dispatcher,s=n.on(this.enableEvents(),e,t);return i&&this.disableEvents(),s},s.enableEvents=function(){return this._.dispatcher?this._.dispatcher:this._.disabledDispatcher?(this._.dispatcher=this._.disabledDispatcher,void delete this._.disabledDispatcher):t.try(this,"dom.root")?this._.dispatcher=this.dom.root:this._.dispatcher=this._element()},s.disableEvents=function(){return this._.disabledDispatcher=this._.dispatcher||this._.disabledDispatcher,this._.dispatcher=null},s._dispatch=function(e,t,i){return!this._.dispatcher||n.dispatch(this._.dispatcher,e,t,i)},s._prepare=function(){return this.dom||(this.dom={root:this._.dispatcher||this._element()},this._deafenHandlers(),this.handlers={},"function"==typeof this._beforeLayout&&this._beforeLayout(this.dom),this._layout(this.dom),"function"==typeof this._afterLayout&&this._afterLayout(this.dom),console.assert(this.dom,"[VIEW] this.dom unassigned after _layout"),console.assert(this.dom.root,"[VIEW] this.dom.root unassigned after _layout"),"function"==typeof this._beforeListen&&this._beforeListen(this.dom),this._listen(this.handlers,this.dom),"function"==typeof this._afterListen&&this._afterListen(this.handlers,this.dom),this.dom.root._view=this),this.dom},s._extractViews=function(){if(!this.dom||!this.dom.root)return[];var e=[],i=function(s,n){s._view&&!n?(s._view.extract(),e.push(s._view)):s.children.length&&t.each(Array.prototype.slice.call(s.children,0),i)};return i(this.dom.root,!0),e},s._impartViews=function(e){t.each(t.try(e,"views"),function(e){e.impart()})},s._listenHandlers=function(){t.each(this.handlers,function(e,t){n.on(t)})},s._deafenHandlers=function(){t.each(this.handlers,function(e,t){n.off(t)})},s._layout=function(e){},s._listen=function(e){},s._element=function(e,i,s){arguments[0]&&"function"==typeof arguments[0].appendChild?arguments[1]&&"string"!=typeof arguments[1]&&(s=arguments[1],i=void 0):arguments[0]&&(s=arguments[0],e=i=void 0),s=s||{},s.parentNode=s.parentNode||e,s.classes=[i,s.classes],s=this._normalizeElementOptions(s);var n=t.excise(s,"factory"),o=n.graphic?r.graphic(t.excise(n,"graphic"),n):t.element(n);return this._applyNormalizedElementOptions(o,s)},s._normalizeElementOptions=function(e){var i={};if(!e)return i;e=t.absorb(e,{}),i.factory={tag:t.excise(e,"tag"),graphic:t.excise(e,"graphic")||t.excise(e,"icon"),namespace:t.excise(e,"namespace"),parentNode:t.excise(e,"parentNode"),pos:t.excise(e,"pos")},i.textData={html:t.excise(e,"html"),label:t.excise(e,"label"),substitutions:t.excise(e,"substitutions"),substitutionTags:t.excise(e,"substitutionTags"),morph:t.excise(e,"morph"),enliven:t.excise(e,"enliven"),wrapper:t.excise(e,"wrapper"),visual:t.excise(e,"visual"),spoken:t.excise(e,"spoken")},i.access=t.excise(e,"access");var s=t.excise(e,"classes");"string"==typeof s&&(s=s.split(/\s+/)),t.isList(s)&&(i.classes=t.unique(t.compact(t.flatten(s))).join(" ").trim()),i.onTap=t.excise(e,"button");var n=t.excise(e,"link");if(i.attributes=t.excise(e,"attributes")||{},!i.attributes.id){var r=t.excise(e,"id");r===!0?i.attributes.id=this._generateIdAttribute(i.classes):"string"==typeof r&&(i.attributes.id=r)}var o=t.excise(e,"landmark")||[];return o[0]&&(i.attributes["aria-label"]=this._phrase(o[0])),o[1]&&(i.attributes["aria-roledescription"]=this._phrase(o[1])),t.absorb(e,i.attributes),i.factory.graphic?(i.classes=((i.classes||"")+" icon").trim(),i.attributes.alt=i.attributes.alt||this._phrase(i.textData),i.attributes["aria-label"]=i.attributes["aria-label"]||i.attributes.alt):i.onTap?(i.factory.tag="button",i.attributes.type=i.attributes.type||"button"):n&&(i.factory.tag="a","string"!=typeof n&&(console.warn("[VIEW] link is not a string",n),"function"==typeof n&&(i.attributes.role="button",i.onTap=n),n="#"),n.match(/^#/)||n.match(/^\w+:/)?i.attributes.href=n:i.attributes.href="/"+n.replace(/^\//,"")),(i.onTap||n)&&(i.classes=((i.classes||"")+" halo").trim()),i},s._applyNormalizedElementOptions=function(e,i){return t.applyElementOptions(e,i.factory),i.textData&&this._textify(e,i.textData),i.classes&&this._classify(e,i.classes),"function"==typeof i.onTap&&this._buttonify(e,i.onTap),t.each(i.attributes,this._attr.bind(this,e)),i.access&&this.access(e,i.access),e},s._swapElement=function(e,i){var s;t.each(this.dom,function(i,n){n==e&&(s=i,t.breakIteration())});var n=this._element(i);e.parentNode&&e.parentNode.insertBefore(n,e),t.each(Array.prototype.slice.call(e.childNodes,0),function(e){n.appendChild(e)}),e.parentNode&&e.parentNode.removeChild(e),n.className=e.className;var r=e.getAttribute("data-access");return r&&this.access(n,r),e._view&&(n._view=e._view),s&&(this.dom[s]=n),n},s._attr=function(e,i,s){var n=Array.prototype.slice.call(arguments);return t.isElement(n[0])||(n.unshift(t.try(this.dom,"root")),t.isElement(n[0]))?(n.length>=3&&(n[2]="undefined"!=typeof n[2]?n[2]:null,n[2]===!0?n[2]="":n[2]===!1&&(n[2]=null)),e=n[0],i=n[1],s=n[2],i?(null===s?e.removeAttribute(i):"undefined"!=typeof s&&e.setAttribute(i,s),e.getAttribute(i)):console.warn("[VIEW] attr() -- missing name",n)):console.warn("[VIEW] pass an element to _attr()",n[0])},s._build=function(){if("string"!=typeof arguments[0]){var e=Array.prototype.slice.call(arguments),s=e.shift(),n=e.shift(),r=e.shift();if(t.isList(e[0])&&(e=e.shift()),n&&e.unshift(n),e.unshift(r||""),e[0])for(var o=1,a=e.length;o<a;++o)"string"==typeof e[o]&&(e[o]=" "+e[o]);return console.warn("[VIEW] legacy _build():",e),t.absorb(this._build.apply(this,e),s)}var l=[],c=0,h=null,u=[],p={},d=Array.prototype.slice.call(arguments),m=d[0].replace(/\b\s+.*$/,"");t.try(d[1],"extending")&&(p=t.excise(d[1],"extending"),d[1].element||d[1].parentNode||(d[1].element=p.root),d[1].extensionClass?m=t.excise(d[1],"extensionClass"):p.root.classList[0]?m=p.root.classList[0]:d[0]=d[0].replace(m,"root"));for(var f=m?m+"-":"";d&&d.length;){var g=d.shift();console.assert("string"==typeof g,"[VIEW] cannot build element with non-string name:",g);var b=((g.match(/^\s+/)||[])[0]||"").length,v={};if("string"!=typeof d[0]&&(t.isElement(d[0])?v.element=d.shift():"function"==typeof d[0]?v.construct=d.shift():t.absorb(d.shift(),v)),t.excise(v,"extending")&&console.warn('[VIEW] ignored child `extending`: "%s"',g),t.excise(v,"skip"))(null===h||h>b)&&(h=b);else if(!(null!==h&&b>h)){h=null;var y=[];v.classes&&y.push(v.classes),g=g.replace(/<([\w]+)>/,function(e,t){return"button"==t?v.button=v.button||"tag":v.tag=v.tag||t,""}),g=g.replace(/\{([\w-\.]+)\}/,function(e,t){return v.label=v.label||t,""}),g=g.replace(/#([\w-]+)/,function(e,t){return v.id=v.id||t,""}),g=g.replace(/\.([\w-\.]+)/g,function(e,t){return y.push(t.split(".").join(" ")),""});var _=null,w=null;if(p.root&&p.root!=v.element?g=g.replace(/([\w-]+)/,function(e,i){return w=t.dasherize(i),_=t.camelize(w),y.unshift(f+w),""}):m&&y.unshift(m),v.classes=y.join(" "),v.parentNode=v.parentNode||l[b],b&&console.assert("function"==typeof t.try(v.parentNode,"appendChild"),["[VIEW] invalid build stack depth: ","  depth: %s => newDepth: %s","  elementInTree:%o","  parentNode:%o","  stack:%o","  view:%o"].join("\n"),c,b,g.trim()||null,v.parentNode||null,l,this),v.construct){var P=[v.parentNode];if(v.with&&(t.isList(v.with)||(v.with=[v.with]),P=P.concat(v.with)),t.try(v.construct,"prototype")instanceof i){var A=function(){return v.construct.apply(this,P)};A.prototype=v.construct.prototype,p[_]=new A}else p[_]=v.construct.apply(this,P);console.assert(t.isElement(p[_])||p[_]instanceof i,"[VIEW] options.construct() did not return an element or view:",_),l[b+1]=p[_]}else{var C=null;if(v.button===!0){var k=["on","Tap"];_&&k.push(_),C=this._handlerMethodName(k)}var L={label:t.excise(v,"labeling")||t.excise(v,"labelling"),description:t.excise(v,"describing")},x=t.excise(v,"element");if(x){var T=this._normalizeElementOptions(v);this._applyNormalizedElementOptions(x,T)}else x=x||this._element(v);p.root?_&&(p[_]=x):p.root=x,C&&(this.handlers[C]=this._buttonify(x,this[C].bind(this))),L.label&&u.push({element:x,targetName:t.camelize(L.label),attribute:"aria-labelledby"}),L.description&&u.push({element:x,targetName:t.camelize(L.description),attribute:"aria-describedby"}),l[b+1]=x}}}return t.each(u,function(e){e.element.id=e.element.id||"aria-"+t.generateUUID().replace(/-.*/,""),p[e.targetName]?this._attr(p[e.targetName],e.attribute,e.element.id):console.warn("[VIEW] no such target for ARIA:",e)},this),p},s._generateIdAttribute=function(e){var s=e?t.flatten([e]).join(" ").split(/\s+/)[0]:"shibui-element";i.ID_COUNTS=i.ID_COUNTS||{},i.ID_COUNTS[s]=(i.ID_COUNTS[s]||0)+1;var n="0000",r=""+i.ID_COUNTS[s];return r=n.slice(0,Math.max(0,n.length-r.length))+r,s+"-"+r},s._handle=function(e,i){var s,r=function(){return console.assert("function"==typeof this[s],"[VIEW] no such handler method:",s,this),this[s].bind(this)}.bind(this);if(!i)return s=this._handlerMethodName(["on",e]),this.handlers[s]=n.on(e,r());if(i==this)return s=this._handlerMethodName(["on",e,"Self"]),this.handlers[s]=this.on(e,r());var o=t.select(this.dom,function(o,a){if(a==i){if(s=this._handlerMethodName(["on",e,o]),t.isElement(a))return this.handlers[s]=n.on(a,e,r());if("function"==typeof a.on)return this.handlers[s]=a.on(e,r());console.warn("[VIEW] no way to listen for handler:",o,e,a),t.breakIteration()}},this);return s?o:void console.assert(s,"[VIEW] no target for handler:",e,i)},s._handleTap=function(e){var i,s;e?t.each(this.dom,function(n,r){r==e&&(i=this._handlerMethodName(["on","Tap",n]),s=r,t.breakIteration())},this):(i=this._handlerMethodName(["on","Tap"]),s=this.dom.root),console.assert(i&&s,"[SHIBUI] could not _handleTap",e),this.handlers[i]=this._buttonify(s,this[i].bind(this))},s._handlerMethodName=function(e){var i=[];t.each(e,function(e){i=i.concat(e.split(/[\:\-\_]/))});var s="_"+t.camelize(i.join("_"));return console.assert("function"==typeof this[s],"[SHIBUI] handler method does not exist",s),s},s._stylePrefix=function(e,i,s){t.prefixProperty(e.style,i,s)},s._styleTransform=function(e,i){t.prefixProperty(e.style,"transform",i)},s._classify=function(e,i,s){e&&e.classList&&("string"==typeof i&&(i=i.split(/\s+/)),t.isList(i)&&("boolean"!=typeof s&&(s=!0),t.each(i,function(t){e.classList.toggle(t,s)})))},s._declassify=function(e,t){t?this._classify(e,t,!1):this._attr(e,"class",null)},s._semaphore=function(e,i){return 1==arguments.length?t.DataClass.get(this.dom.root,e):i?(t.DataClass.set(this.dom.root,e,i),i.toString()):void t.DataClass.clear(this.dom.root,e)},s._focusElement=function(e,i){if("function"!=typeof t.try(e,"focus"))return!1;if(!t.isInDOM(e))return!1;if("true"==this._attr(e,"aria-hidden"))return!1;var s=t.excise(i||{},"delay");return"number"==typeof s?(this._defer("focus",this._focusElement.bind(this,e,i),s),!0):(this._defer("focus"),this._attr(e,"tabindex")||this._isInteractiveElement(e)||this._attr(e,"tabindex",-1),e.focus(i),!0)},s._focusFirstInvalidity=function(e){var i=e.querySelector(":invalid:not(form)");return i?(i=t.elementClosest(i,".shibui-form-field")||i,this._focusElement(i)&&i):null},s._isInteractiveElement=function(e){if(!t.isElement(e))return!1;var i=["BUTTON","INPUT","TEXTAREA","SELECT","IFRAME","DETAILS","SUMMARY"];return!!(t.among(e.tagName.toUpperCase(),i)||this._attr(e,"src")||this._attr(e,"href"))},s._hasInteractiveChildren=function(e){var i=!1;return t.each(e.querySelectorAll("*"),function(e){this._isInteractiveElement(e)&&(i=!0,t.breakIteration())},this),i},s._swapInteractiveElement=function(e,i){var s=t.excise(i,"tag")||"div";if(i.button&&"BUTTON"==e.tagName)return this._buttonify(e,i.button),e;if(i.link&&"A"==e.tagName)return this._linkify(e,i.link),e;if(!i.button&&!i.link){if(e.tagName==s.toUpperCase())return e;t.absorb({tag:s},i)}return this._swapElement(e,i)},s._linkify=function(e,t){if("A"==e.tagName)if("string"==typeof t&&t){var i=t;t.match(/^#/)||t.match(/^\w+:/)||(i="/"+t.replace(/^\//,"")),this._attr(e,"href",i),"text"==this._attr(e,"role")&&this._attr(e,"role",null)}else this._attr(e,"href",null),this._attr(e,"role","text");else this._swapInteractiveElement(e,{link:t})},s._buttonify=function(e,t,i){if(this._unbuttonify(e),t){var s=function(e){t(e),n.stop(e)};return e.__onTapHandlers=n.onTap(e,s,i)}},s._unbuttonify=function(e){e.__onTapHandlers&&(n.off(e.__onTapHandlers),delete e.__onTapHandlers)},s._formify=function(e,t){e.__onSubmitHandler&&n.off(e.__onSubmitHandler);var i=function(e){n.stop(e),t(e)};e.__onSubmitHandler=n.on(e,"submit",i)},s._enliven=function(e,i,s){var n=e.querySelectorAll('[href="'+i+'"]');return t.each(n,function(e){this._classify(e,"halo",s!==!1),s===!1?this._attr(e,"href",null):"string"==typeof s?this._linkify(e,s):"function"==typeof s&&this._buttonify(e,s)},this),n.length&&"text"==this._attr(e,"role")&&this._attr(e,"role"),n},s._textify=function(e,i){if(e){if("string"==typeof i)i={label:i};else if(t.isList(i)){var s=i;i={},t.each(s,function(e){"string"==typeof e?(i.label=i.label||[],i.label.push(e)):e.label?(i.label=i.label||[],e=t.absorb(e,{}),i.label.push(t.excise(e,"label")),t.absorb(e,i)):e.html&&!i.label?(i.html?i.html+=" "+e.html:i.html=e.html,e.enliven&&(i.enliven=t.absorb(e.enliven,i.enliven||{}))):(APP.journal.warn("[VIEW] unhandled array of strings",s),t.breakIteration())})}else i||(i={html:""});if(i.morph&&e.innerHTML){var n="number"==typeof i.morph?i.morph:100,r=t.absorb({morph:!1},t.absorb(i,{})),o=this._element(r);return void(e.innerHTML!=o.innerHTML&&(e._=e._||{},e._.morphing=!0,this._classify(e,"shibui-morphable-text"),t.defer(e,"morph",function(){this._classify(e,"shibui-morphing-text"),t.defer(e,"morph",function(){for(e.innerHTML="";o.firstChild;)e.appendChild(o.firstChild);t.defer(e,"morph",function(){this._declassify(e,"shibui-morphing-text"),delete e._.morphing}.bind(this),n)}.bind(this),n)}.bind(this))))}if(e._&&e._.morphing&&(t.defer(e,"morph"),this._declassify(e,"shibui-morphing-text")),"undefined"!=typeof i.spoken){i.spoken&&("string"==typeof i.spoken&&(i.spoken={label:i.spoken}),i.spoken.substitutions||(i.spoken.substitutions=i.substitutions));var a;i.spoken&&(a=i.spoken.html||this._phrase(i.spoken));var l,c;"IMG"==e.tagName?(l=e,this._attr(l,"alt",a)):this._isInteractiveElement(e)&&"A"!=e.tagName?(l=e,a?a!=this._attr(l,"aria-label")&&this._attr(l,"aria-label",a):this._attr(l,"aria-label",null)):(2==e.children.length&&e.firstChild.matches('[data-access~="spoken"]')&&e.lastChild.matches('[data-access~="visual"]')?(l=e.firstChild,c=e.lastChild):a&&(l=this._element({tag:"span",access:"spoken"}),c=this._element({tag:"span",access:"visual",html:e.innerHTML}),e.innerHTML="",e.appendChild(l),e.appendChild(c)),!a&&c?(e.innerHTML=c.innerHTML,c=l=null):a&&l&&(l.innerHTML=a,e=c))}return i=i.visual||i,"string"==typeof i&&(i={label:i}),i.html&&i.html.nodeType&&i.html.nodeName?(e.innerHTML="",e.appendChild(i.html)):"function"==typeof i.html?(e.innerHTML="",i.html=i.html(e)):"string"!=typeof i.html&&("undefined"==typeof i.wrapper&&(i.wrapper="span"),i.html=this._phrase(i)),"string"==typeof i.html&&(i.wrapper&&(i.html="<"+i.wrapper+">"+i.html+"</"+i.wrapper+">"),e.innerHTML!=i.html&&(e.innerHTML=i.html,"span"==i.wrapper&&e.firstElementChild&&!this._hasInteractiveChildren(e.firstElementChild)&&(this._attr(e.firstElementChild,"role","text"),e.firstElementChild._accessAttributes={role:"text"}))),t.each(i.enliven,this._enliven.bind(this,e)),e}},s._phrase=function(e){var i=t.flatten(Array.prototype.slice.call(arguments,0));if(i.length){if(i.length>1){var s=[];return t.each(i,function(e){var t=this._phrase(e);"string"==typeof t&&s.push(t)},this),s.join(" ")}if(e=i[0],e="string"==typeof e?{label:e}:t.absorb(e,{}),"string"==typeof e.html)return e.html;if(t.isList(e.label)){var s=[];return t.each(e.label,function(i){var n=t.absorb({label:i},t.absorb(e,{})),r=this._phrase(n);"string"==typeof r&&s.push(r)},this),s.join(" ")}return e.label?o.text(t.excise(e,"label"),t.excise(e,"substitutions")||{},e):"number"==typeof e.number?o.number(t.excise(e,"number"),e):e.list?o.list(t.excise(e,"list"),e):e.date?o.date(t.excise(e,"date"),e):e.time?o.time(e.time):e.dateAndTime?o.dateAndTime(t.excise(e,"dateAndTime"),e):e.relativeTime?o.relativeTime(t.excise(e,"relativeTime"),t.excise(e,"unit")):e.relativeDate?o.relativeDate(t.excise(e,"relativeDate"),e):void 0}},s._graphic=function(e,t){r.add(e,t)},s._defer=function(e,i,s){if("string"==typeof e){var n=[this].concat(Array.prototype.slice.call(arguments));return t.defer.apply(t,n)}t.defer.apply(t,arguments)},i}),define("app/views/core/partial",["require","common","shibui/src/view","shibui","shibui/src/keys"],function(e){var t=e("common"),i=e("shibui/src/view"),s=i.new(),n=s.prototype,r=e("shibui");e("shibui/src/keys");return n.listen=n.enableEvents,n.deafen=n.disableEvents,n._layout=function(e){this._.parts=e,this._.parts.box=e.root,this._layoutPartial(e)},n._listen=function(e,t){this._listenPartial(this._.parts||t)},n._layoutPartial=function(e){},n._listenPartial=function(e){},n._elem=function(e,i,s,n){return n=t.absorb({parentNode:e,classes:i},n||{}),"string"==typeof s&&(s={label:s}),s&&(n=t.absorb(s,n)),this._element(n)},n._tag=function(e,i,s,n,r){return r=t.absorb({tag:e},r||{}),this._elem(i,s,n,r)},n._icon=n._symbol=function(e,i,s){return s=t.absorb(s,{}),s.classes=("icon "+(s.classes||"")).trim(),s.parentNode=s.parentNode||i,r.Illustrator.graphic(e,s)},n._amplifyText=function(e){var t='<span class="amp">&amp;</span>';return e.replace(/&amp;/gi,t).replace(" & "," "+t+" ")},n._textWithoutOrphans=function(e){return e.replace(/[^\s]+/g,"").length<3?e:e.replace(/\s([^\s<]{0,12})\s*$/,"&nbsp;$1")},n._emptyElement=function(e){return e&&e.firstChild&&this._textify(e),e},n._findViewWithin=function(e,i){if("function"!=typeof t.try(e,"querySelectorAll"))return APP.journal.warn("[PARTIAL] first argument to findViewWithin is not an element",e);for(var s=e.querySelectorAll("*"),n=0,r=s.length;n<r;++n)if(s[n]._view instanceof i)return s[n]._view},n._distanceInTime=function(e,i){var s=t.secondsToUnits(e),n=[];return s.weeks&&(s.days+=7*s.weeks),s.days&&(n.push(this._elem(null,"",{label:"units.days",substitutions:{N:s.days}}).innerHTML),i-=1),s.hours&&i&&(n.push(this._elem(null,"",{label:"units.hours",substitutions:{N:s.hours}}).innerHTML),i-=1),i&&(s.minutes=s.minutes||1,n.push(this._elem(null,"",{label:"units.minutes",substitutions:{N:s.minutes}}).innerHTML)),this._phrase({list:n,type:"unit"})},s}),define("app/views/core/scroller",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.$init=function(e){this.lastScroll={},this.element=e,this.element.classList.add("halos-anchor"),this.element.scroller=this,APP.events.scrollable(this.element),APP.events.on(this.element,"scroll",this._onScroll.bind(this)),this._setWinWidth(),this.announce()},s._setWinWidth=function(e){var i=s.LAST_SCROLLBAR_WIDTH||0;if(this.element.clientWidth?i=Math.max(0,window.innerWidth-this.element.clientWidth):e||t.defer(this,"win-width",this._setWinWidth.bind(this,!0)),i!=this._.sbWidth){s.LAST_SCROLLBAR_WIDTH=this._.sbWidth=i;var n=i?"calc(100vw - "+i+"px)":"100vw";this.element.style.setProperty("--px-win-width",n)}},s.announce=function(){t.defer(this,"announce-scroll",this._onScroll.bind(this))},s.isScrolling=function(){return this.lastScroll.ended=this.lastScroll.ended||this.lastScroll.at<t.epochMilliseconds()-200,!this.lastScroll.ended},s.scrollToTop=function(e){this.scrollTo(0,e)},s.scrollTo=function(e,i){if(t.defer(this,"stop-user-scroll"),this.element&&(i=t.absorb(i,{duration:250}),this.element._memoOverflow&&(this._restoreElementOverflow(this.element),this.lastScroll.ended=!0),("prefer"!=i.userScroll||!this.isScrolling())&&("cancel"==i.userScroll&&this.isScrolling()&&(this._replaceElementOverflow(this.element,"hidden"),t.defer(this,"stop-user-scroll",function(){this._restoreElementOverflow(this.element),this.lastScroll.ended=!0,t.defer(this,"stop-user-scroll",this.scrollTo.bind(this,e,i))}.bind(this))),this.element.scrollTop!==e))){if(0===i.duration)return this.element.scrollTop=e;"undefined"==typeof this._.nativeScrolling&&(this._.nativeScrolling="scrollBehavior"in this.element.style&&"function"==typeof this.element.scroll),this._.nativeScrolling?this.element.scroll({top:e,behavior:"smooth"}):this._manualScrollToY(e,i.duration||this.DEFAULT_DURATION)}},s.scrollToElement=function(e,t){if(this.element.contains(e)){t=t||{};var i=t.aperture||.5*window.innerHeight,s=this.element.getBoundingClientRect(),n=e.getBoundingClientRect(),r=n.top-s.top,o=this.element.scrollTop;if(!(r>0&&o+r<o+i)){var a=o+r-i;this.scrollTo(a,t.duration)}}},s._manualScrollToY=function(e,t){var i=function(e,t,i,s){return e/=s/2,e<1?i/2*e*e+t:(e--,-i/2*(e*(e-2)-1)+t)},s=this.element.scrollTop,n=e-s,r=0,o=20;this.element.style.setProperty("-webkit-overflow-scrolling","auto");var a=function(){r+=o,r<t?(this.element.scrollTop=i(r,s,n,t),requestAnimationFrame(a)):(this.element.scrollTop=e,this.element.style.removeProperty("-webkit-overflow-scrolling"))}.bind(this);a()},s._recomputeScrollData=function(){var e={scroller:this};return e.h=this.element.clientHeight,e.max=Math.ceil(this.element.scrollHeight-e.h)-1,e.y=Math.round(Math.max(0,Math.min(this.element.scrollTop,e.max))),e.max=Math.max(e.y,e.max),e.at=t.epochMilliseconds(),e},s._onScroll=function(e){var t=this._recomputeScrollData();t.y!==this.lastScroll.y&&(this.lastScroll=t),t.max!==this.lastScroll.max&&(this.lastScroll=t),this==APP.arena.scroller&&(APP.events.dispatch("arena:scroll",t),this._.scrollEnd||(this._.scrollEnd={},this._.scrollEnd.handler=APP.events.on(document.body,"touchmove",this._onScrollTouchMove.bind(this))),this._.scrollEnd&&!this._.scrollEnd.touching&&this._scheduleScrollEnd(200))},s._onScrollTouchMove=function(){this._.scrollEnd&&(this._.scrollEnd.touching=!0,t.defer(this,"scrollend"),APP.events.off(this._.scrollEnd.handler),this._.scrollEnd.handler=APP.events.on(document.body,"touchend",this._onScrollTouchEnd.bind(this)))},s._onScrollTouchEnd=function(){this._.scrollEnd&&(APP.events.off(this._.scrollEnd.handler),this._scheduleScrollEnd(100))},s._scheduleScrollEnd=function(e){if(this._.scrollEnd){"number"!=typeof e&&(e=100);var i=this._.scrollEnd;t.defer(this,"scrollend",function(){this._.scrollEnd===i&&(this.lastScroll.ended=!0,APP.events.off(t.excise(this._,"scrollEnd").handler),APP.events.dispatch("arena:scroll:end",this.lastScroll))}.bind(this),e)}},s._saveElementOverflow=function(e){e._memoOverflow||(e._memoOverflow=e.style.getProperty("overflow")||!0)},s._replaceElementOverflow=function(e,t){this._saveElementOverflow(e),e.style.setProperty("overflow",t)},s._restoreElementOverflow=function(e){e._memoOverflow===!0?e.style.removeProperty("overflow"):e._memoOverFlow&&e.style.setProperty("overflow",t.excise(e,"_memoOverflow"))},i}),define("shibui/src/components/chevron",["require","common","../view"],function(e){var t=e("common"),i=e("../view"),s=i.new(),n=s.prototype;return n.$init=function(){this._.d=[["M",[6,7]],["L",[26,30]],["C",[27,31],[27,32],[26,33]],["L",[6,57]]],this._.bearing="e",this._.rotation=0,this._.sharpness=1,this._.inversion=1,this._.speed=200,this._.verticalCompression=.5,i.prototype.$init.apply(this,arguments)},n.bearing=function(e){if(e==this._.bearing)return this;var t="nesw",i=t.indexOf(this._.bearing),s=t.indexOf(e);return 2==Math.abs(s-i)?this._.inversion*=-1:(s%2?this._.sharpness/=this._.verticalCompression:this._.sharpness*=this._.verticalCompression,0==s&&3==i?this._.rotation+=90:3==s&&0==i?this._.rotation-=90:this._.rotation+=s>i?90:-90),this.dom.image&&(this.dom.image.style.transform="rotate("+this._.rotation+"deg)",this._attr(this.dom.image,"data-bearing",e),this._updatePath()),this._.bearing=e,this._semaphore("bearing",this._.bearing),this._dispatch("chevron:bearing",{bearing:this._.bearing}),this},n.sharpness=function(e){return this._.sharpness=e,this._updatePath(),this},n.speed=function(e){return this._.speed=e,this.dom.image&&(this.dom.image.style.transition="all "+this._.speed+"ms ease-in-out",this.dom.path.style.transition="all "+this._.speed+"ms ease-in-out"),this},n._layout=function(e){this._build("shibui-chevron",{extending:e}," image",{tag:"svg",namespace:"svg",attributes:{viewBox:"0 0 32 64",version:1.1}},"  path",{tag:"path",namespace:"svg"}),this.speed(this._.speed),this._semaphore("bearing",this._.bearing),this._.timer=setTimeout(this._updatePath.bind(this),0)},n._updatePath=function(){if(this.dom.path)if(cancelAnimationFrame(this._.timer),clearTimeout(this._.timer),"undefined"==typeof this._.multiplier)this._.multiplier=this._.inversion*this._.sharpness,this._attr(this.dom.path,"d",this._multiplyPath(this._.multiplier));else{var e=this._.multiplier,i=this._.inversion*this._.sharpness-this._.multiplier,s=t.epochMilliseconds(),n=function(){var r=t.epochMilliseconds(),o=Math.min(1,(r-s)/this._.speed);
this._.multiplier=e+i*o,this._attr(this.dom.path,"d",this._multiplyPath(this._.multiplier)),o<1&&(this._.timer=requestAnimationFrame(n))}.bind(this);n()}},n._multiplyPath=function(e){for(var t=16,i=[],s=0,n=this._.d.length;s<n;++s){i.push(this._.d[s][0]);for(var r=1,o=this._.d[s].length;r<o;++r){var a=this._.d[s][r][0],l=a-t,c=t+l*e;i.push(c+","+this._.d[s][r][1]+" ")}}return i.join("").trim()},s}),define("app/views/core/crumbs",["require","common","app/views/core/partial","shibui/src/components/chevron"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("shibui/src/components/chevron");return n.focus=function(){this._updateCrumbs()},n._layout=function(e){this._build("crumbs",{extending:e})},n._updateCrumbs=function(){this._prepare(),this._textify(this.dom.root);var e=APP.router.waypoints[APP.router.realm].slice(1);e.length?t.each(e.reverse(),this._addCrumbForWaypoint.bind(this)):this.defaultCrumbs&&t.each(this.defaultCrumbs,this._addCrumb.bind(this))},n._addCrumbForWaypoint=function(e){return this._addCrumb(this._phrase({label:e.name,okIfMissing:!0})||e.name,e.path)},n._addCrumb=function(e,t){return this._build("crumb",{parentNode:this.dom.root,button:this._onTapCrumb.bind(this,t),spoken:e?{label:"a11y.crumb.prefix",substitutions:{WAYPOINT:e}}:void 0,attributes:{"data-halo-class":"subtle"}}," chevron",function(e){return new r(e).bearing("w")}," name <span>",{html:e})},n._onTapCrumb=function(e,t){APP.nav.go(e)},s}),define("app/views/core/app-topper",["require","app/views/core/partial"],function(e){var t=e("app/views/core/partial"),i=t.new(),s=i.prototype;return s.contextualize=function(e){this._textify(this.dom.title,{html:e})},s._layout=function(){this.dom=this._build("app-topper",{button:!0,spoken:"a11y.scroll-to-top",access:"inert"}," bumper .bumper-n .bumper-e .bumper-w","  sheen","  content .pillar","   title <span>"),this.contextualize(this._phrase("loading"))},s._onTap=function(){APP.semaphore.get("scrollfocus")||(APP.arena.resetElementFocus(),APP.arena.scroller&&APP.arena.scroller.scrollToTop())},i}),define("app/views/core/app-header",["require","common","./partial","app/views/core/crumbs","app/views/core/app-topper"],function(e){var t=e("common"),i=e("./partial"),s=i.new(),n=s.prototype,r=e("app/views/core/crumbs"),o=e("app/views/core/app-topper");return n.focus=function(){this._contextualizeToRoute(),this.dom.crumbs&&this.dom.crumbs.focus(),this._updateRoller(!0)},n._layout=function(){this.dom=this._build("app-header <header> .halos-anchor"," roller","  nav","   sheen .bumper-n .bumper-e .bumper-w","   bumper .bumper-n .bumper-e .bumper-w","    controls .pillar","   topper",o),this._layoutControls(this.dom)},n._layoutControls=function(e){e.crumbs=new r(e.controls)},n._listen=function(e,t){this._handle("aide:lighting"),this._handle("arena:scroll"),this._handle("arena:scroll:end")},n._contextualizeToRoute=function(){APP.router.route&&(this.route=APP.router.route,this._.waypoint||(this._.waypoint=this.route.waypoint,this._.waypoint.onChange(this._onWaypointChange.bind(this))),this._onWaypointChange(this._.waypoint))},n._onWaypointChange=function(e){e=t.absorb(e,{}),e.name=e.name||this._phrase("loading"),this._updateColor(),this._.color=this._pickCSSColor(this.dom.nav)||e.color,this.dom.topper.contextualize(e.topName||e.name),APP.arena.dom.elastiguard.colorize(this._.color),APP.shell.colorize(this._.color)},n._onAideLighting=function(){APP.router.route==this.route&&this._defer("update-color",this._updateColor.bind(this,!0),100)},n._updateColor=function(e){this._defer("update-color"),this._.color=this._pickCSSColor(this.dom.nav)||this._.waypoint.color,this.dom.topper.contextualize(this._.waypoint.topName||this._.waypoint.name),APP.arena.dom.elastiguard.colorize(this._.color),APP.shell.colorize(this._.color),this._updateRoller(e)},n._onArenaScroll=function(e){if(APP.router.route==this.route){this._.scrollDir=e.m.y-(this._.scrollTop||0)||this._.scrollDir,this._.scrollTop=Math.max(0,e.m.y);var t=this._.scrollTop>0;this._updateRoller(this._.furled!=t),this._.furled!=t&&(this._.furled=t,this.access(this.dom.controls,this._.furled?"inert":"normal"),this.dom.topper.access(this._.furled?"normal":"inert"))}},n._onArenaScrollEnd=function(e){if(APP.router.route==this.route&&!(e.m.y<=0))if(e.m.max<30)e.m.scroller.scrollTo(0,{duration:80});else if(e.m.y<30){var t=this._.scrollDir>0?34:0;e.m.scroller.scrollTo(t,{duration:80})}},n._updateRoller=function(e){var t=this._.rollerProgress||0;this._.rollerProgress=Math.max(0,Math.min(this._.scrollTop/30,1)),e?this._defer("roller",this._updateRollerProgress.bind(this)):this._.rollerProgress!=t&&this._defer("roller",this._updateRollerProgress.bind(this),20)},n._updateRollerProgress=function(){var e=t.smoothFloat(this._.rollerProgress,1);if(this._.rollerProgress<1?this.dom.topper.dom.title.style.setProperty("visibility","hidden"):this.dom.topper.dom.title.style.removeProperty("visibility"),0==this._.rollerProgress?this.dom.topper.dom.root.style.setProperty("visibility","hidden"):this.dom.topper.dom.root.style.removeProperty("visibility"),e>0&&!this._.sheenUp?(this._.sheenUp=!0,this.dom.sheen.style.setProperty("pointer-events","auto"),this.dom.topper.dom.root.style.setProperty("pointer-events","auto")):0==e&&this._.sheenUp&&(this._.sheenUp=!1,this.dom.sheen.style.removeProperty("pointer-events"),this.dom.topper.dom.root.style.removeProperty("pointer-events")),!this._.skippingAnimation){var i=this._colorShaded(.075*e,Math.min(1,1.5*e)),s=this._colorShaded(-.125*(.25-.25*e),1);this.dom.sheen.style.setProperty("background-color",i),this.dom.topper.dom.sheen.style.setProperty("background-color",s);var n=e>=1?90.001:Math.round(90*e);this._styleTransform(this.dom.nav,n?"rotateX("+n+"deg)":null),this.dom.bumper.style.setProperty("opacity",1-e),e>0&&e<1?(this._.animationHasDuration=!0,this._stylePrefix(this.dom.nav,"transition-duration","250ms")):this._.animationHasDuration&&(delete this._.animationHasDuration,this._stylePrefix(this.dom.nav,"transition-duration"))}},n._colorShaded=function(e,i){var s=APP.coverGuru.rgbForColor(this._.color||"#999"),n=t.adjustRGB(s,{shade:e});return n[3]=i,"rgba("+n.join(",")+")"},n._pickCSSColor=function(e){var i=getComputedStyle(e).getPropertyValue("background-color");if(i&&!i.match(/^rgba\(0,\s*0,\s*0,\s*0\)$/))return t.rgbStringToHex(i)},s}),define("app/views/screens/screen",["require","common","app/views/core/partial","app/views/core/scroller","app/views/core/app-header"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/core/scroller"),o=e("app/views/core/app-header");return n.$init=function(e){this.controller=e},n.become=function(e){this._prepare(),this.dom.view&&this.dom.view.extract(),this.dom.view=e,this.dom.view.impart(this.dom.content)},n.focus=function(){t.try(this.dom.view,"focus()"),t.try(this.dom.header,"focus()"),APP.events.dispatch("screen:focus",{screen:this,route:this.controller})},n._layout=function(e){this._build("screen",{extending:e}," content .content .bumper-n .bumper-e .bumper-w .bumper-s")},n._afterLayout=function(e){this._layoutScroller(e),this._layoutHeader(e)},n._afterListen=function(e,t){this.controller.waypoint.onChange(this._onWaypointChange.bind(this))},n._layoutScroller=function(e){this._classify(e.root,"scroller"),this.scroller=new r(e.root)},n._layoutHeader=function(e){e.header=new o,e.header.impart(e.root,"prepend")},n._onWaypointChange=function(e){APP.coverGuru.paint(this.dom.root,"waypoint-raw",e.color)},s}),define("app/views/components/interviews/interview-crumbs",["require","common","app/views/core/crumbs"],function(e){var t=e("common"),i=e("app/views/core/crumbs"),s=i.new(),n=s.prototype;return n._afterLayout=function(e){this._classify(e.root,"interview-crumbs")},n._updateCrumbs=function(){this._prepare(),this._textify(this.dom.root);var e=APP.router.waypoints[APP.router.realm][0],i=APP.router.waypoints[APP.router.realm].slice(1);e&&e.origination&&!i.length?this._addCrumb(null,e.origination):i.length?t.each(i.reverse(),this._addCrumbForWaypoint.bind(this)):APP.router.route.root||this._addCrumb("interview.menu","interview/menu")},n._addCrumb=function(e,t){var s=i.prototype._addCrumb.apply(this,arguments);return this._textify(s.name,"shade.back"),s},s}),define("app/views/components/interviews/app-header-interview",["require","common","app/views/core/app-header","app/views/components/interviews/interview-crumbs"],function(e){var t=e("common"),i=e("app/views/core/app-header"),s=i.new(),n=s.prototype,r=e("app/views/components/interviews/interview-crumbs");return n.createAction=function(e){if(this.dom.action&&this.dom.slot.removeChild(this.dom.action),"function"==typeof e)return this.dom.action=e(this.dom.slot)},n.setMascotCharacter=function(e){e?t.DataClass.set(this.dom.cameo,"character",e):t.DataClass.clear(this.dom.cameo,"character")},n._layoutControls=function(e){this._classify(e.root,"app-header-interview"),this._build("",{extending:e,element:e.controls,extensionClass:"app-header-interview"}," crumbs",r," cameo-button",{button:!0,access:["visual",{tabindex:null}],spoken:"a11y.skin-tone-picker.choose"},"  cameo .mascot-icon .mascot-neg",{graphic:"mascot"}," slot <span>")},n._onTapCameoButton=function(e){APP.arena.pickSkinTone(this.dom.cameoButton)},s}),define("text!shibui/svg/spinner-9.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-linecap="round" stroke-width="1">\n    <line class="icon-hollow" stroke="#000000" stroke-width="4" x1="32" x2="32" y1="15" y2="19" />\n    <line class="icon-hollow" stroke="#000000" stroke-width="4" x1="43.570177" x2="40.9990265" y1="19.2112" y2="22.2753778" />\n    <line class="icon-hollow" stroke="#000000" stroke-width="4" x1="49.7265396" x2="45.7873085" y1="29.8743328" y2="30.5689255" />\n    <line class="icon-hollow" stroke="#000000" stroke-width="4" x1="47.5884573" x2="44.1243557" y1="42" y2="40" />\n    <line class="icon-hollow" stroke="#000000" stroke-width="4" x1="38.1563626" x2="36.788282" y1="49.9144672" y2="46.1556967" />\n    <line class="icon-hollow" stroke="#000000" stroke-width="4" x1="25.8436374" x2="27.211718" y1="49.9144672" y2="46.1556967" />\n    <line class="icon-hollow" stroke="#000000" stroke-width="4" x1="16.4115427" x2="19.8756443" y1="42" y2="40" />\n    <line class="icon-hollow" stroke="#000000" stroke-width="4" x1="14.2734604" x2="18.2126915" y1="29.8743328" y2="30.5689255" />\n    <line class="icon-hollow" stroke="#000000" stroke-width="4" x1="20.429823" x2="23.0009735" y1="19.2112" y2="22.2753778" />\n  </g>\n</svg>\n'}),define("text!shibui/svg/spinner-12.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-linecap="round" stroke-width="1">\n    <line class="icon-hollow" stroke="#000000" stroke-width="3" x1="32" x2="32" y1="12.875" y2="16.125" />\n    <line class="icon-hollow" stroke="#000000" stroke-width="3" x1="41.5625" x2="39.9375" y1="15.4372642" y2="18.2518467" />\n    <line class="icon-hollow" stroke="#000000" stroke-width="3" x1="48.5627358" x2="45.7481533" y1="22.4375" y2="24.0625" />\n    <line class="icon-hollow" stroke="#000000" stroke-width="3" x1="51.125" x2="47.875" y1="32" y2="32" />\n    <line class="icon-hollow" stroke="#000000" stroke-width="3" x1="48.5627358" x2="45.7481533" y1="41.5625" y2="39.9375" />\n    <line class="icon-hollow" stroke="#000000" stroke-width="3" x1="41.5625" x2="39.9375" y1="48.5627358" y2="45.7481533" />\n    <line class="icon-hollow" stroke="#000000" stroke-width="3" x1="32" x2="32" y1="51.125" y2="47.875" />\n    <line class="icon-hollow" stroke="#000000" stroke-width="3" x1="22.4375" x2="24.0625" y1="48.5627358" y2="45.7481533" />\n    <line class="icon-hollow" stroke="#000000" stroke-width="3" x1="15.4372642" x2="18.2518467" y1="41.5625" y2="39.9375" />\n    <line class="icon-hollow" stroke="#000000" stroke-width="3" x1="12.875" x2="16.125" y1="32" y2="32" />\n    <line class="icon-hollow" stroke="#000000" stroke-width="3" x1="15.4372642" x2="18.2518467" y1="22.4375" y2="24.0625" />\n    <line class="icon-hollow" stroke="#000000" stroke-width="3" x1="22.4375" x2="24.0625" y1="15.4372642" y2="18.2518467" />\n  </g>\n</svg>\n'}),define("shibui/src/components/spinner",["require","common","../view","text!shibui/svg/spinner-9.svg","text!shibui/svg/spinner-12.svg"],function(e){var t=e("common"),i=e("../view"),s=i.new(),n=s.prototype;return n._graphic("spinner-9",e("text!shibui/svg/spinner-9.svg")),n._graphic("spinner-12",e("text!shibui/svg/spinner-12.svg")),n.HEIGHT=200,n.$init=function(e,i){this.options=t.absorb(i,{variant:"medium"}),this.impart(e)},n.spin=function(){return this.dom.root.style.removeProperty("display"),this._attr(this.dom.root,"aria-busy","true"),this.access({tabindex:0}),this},n.stop=function(){return this._defer("focus"),this.access("inert"),this._attr(this.dom.root,"aria-busy",null),this.dom.root.style.setProperty("display","none"),this},n.isSpinning=function(){return"none"!=this.dom.root.style.getPropertyValue("display")},n.focus=function(){this.isSpinning()||this.spin();var e=document.activeElement;this._defer("focus",function(){document.activeElement==e&&this.isInDocument()&&this._focusElement(this.dom.root)}.bind(this),100)},n.spokenStatus=function(e){this._textify(this.dom.status,e)},n._layout=function(e){this._build("shibui-spinner",{extending:e,classes:"shibui-spinner-"+this.options.variant}," status {loading}",{labeling:"root",access:"spoken"}," icon",{icon:"spinner-"+{small:9,medium:12}[this.options.variant]}),this._attr(this.dom.root,"role","progressbar"),this._attr(this.dom.root,"aria-busy","true"),this._attr(this.dom.root,"aria-valuemin","0"),this._attr(this.dom.root,"aria-valuemax","100"),this._attr(this.dom.root,"aria-valuetext",this._phrase("loading"))},s}),define("app/views/components/locate-library/map-frame",["require","common","app/base/quirks"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("app/base/quirks");return s.$init=function(e,i,s){s=t.absorb(s,{}),"boolean"!=typeof s.dark&&(s.dark="dark"==APP.semaphore.get("aide-lighting"));var n=function(){this._execute("instantiateMap",i,s),this.updateDimensions()}.bind(this);this._.iframe=t.iframe({parentNode:e,src:this._mapURL(),width:"100%",height:"100%"},n),this._.resizeHandler=APP.events.on(window,"resize",this._onWindowResize.bind(this))},s.situate=function(e){e=this._optionsForAnimation(e),this._execute("situateMap",e)},s.populate=function(e){this._execute("populateMap",e)},s.fitBranches=function(e){e=this._optionsForAnimation(e),this._execute("fitMapToBranches",e)},s.highlight=function(e,t,i){t?(i=i||{},i.zoomIntoPoint&&(this._execute("zoomIntoPoint",t,i.offsetY||0,this._optionsForAnimation()),delete i.zoomIntoPoint,delete i.offsetY),this._execute("addHighlightToPoint",e,t,i)):this._execute("removeHighlight",e)},s.style=function(e){this._execute("setCustomStyles",e)},s.updateDimensions=function(){var e=this._.iframe.parentNode;e&&(this._.iframe.style.width=e.offsetWidth+"px",this._.iframe.style.height=e.offsetHeight+"px",setTimeout(function(){this._execute("updateMapDimensions")}.bind(this),0))},s.scope=function(){return this._.scope=this._.scope||"dewey:map:"+t.generateUUID()},s.extract=function(){this._.iframe&&this._.iframe.parentNode&&(this._.iframe.parentNode.removeChild(this._.iframe),delete this._.iframe)},s._mapURL=function(){var e="/api/locate/map";return n("webgl-unavailable")&&(e+="/unsupported"),n("map-requires-absolute-url")&&(e=APP.constants.ROOT_URI+e),e+="?scope="+this.scope()},s._optionsForAnimation=function(e){return e=t.absorb(e,{}),t.try(APP.aide,"reduceMotion")?e.duration=1:"undefined"==typeof e.speed&&(e.speed=2),e},s._execute=function(e,t){this._checkViability()&&this._.iframe.contentWindow.postMessage({scope:this.scope(),name:e,args:Array.prototype.slice.call(arguments,1)},"*")},s._onWindowResize=function(e){this._checkViability()&&this.updateDimensions()},s._checkViability=function(){return!!(this._.iframe&&this._.iframe.contentWindow&&this._.iframe.parentNode)||(APP.events.off(this._.resizeHandler),APP.events.off(this._.messageHandler),!1)},i}),define("app/views/components/locate-library/library-branches-map",["require","common","app/views/core/partial","shibui/src/illustrator","shibui/src/components/spinner","./map-frame"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=(e("shibui/src/illustrator"),e("shibui/src/components/spinner")),o=e("./map-frame");return n.LOAD_TIMEOUT=1e4,n.spin=function(){this._declassify(this.dom.root,"library-branches-map-loaded"),this._textify(this.dom.pan),this.dom.spinner=new r(this.dom.pan),this.dom.spinner.spin()},n.spun=function(){this.dom.spinner&&(this.dom.spinner.extract(),delete this.dom.spinner)},n.load=function(e,i){this.dom.map&&this.dom.map.extract(),i=t.absorb(i,{}),this._defer("load-map",this._onMapLoadTimeout.bind(this),this.LOAD_TIMEOUT),this.dom.map=new o(this.dom.pan,e,i),this._textify(this.dom.controls);var s=i.buttons||{};i.zoomable!==!1&&s.zoom&&(this.dom.zoomIn=this._build("",{element:this.dom.controls}," app-button .join-button-start",{button:this._zoom.bind(this,"in"),spoken:"branches-map.zoom-in"},"  icon",{graphic:"map-zoom-in"}).appButton,this._zoomHandler(this.dom.zoomIn,"in"),this.dom.zoomOut=this._build("",{element:this.dom.controls}," app-button .join-button-end",{button:this._zoom.bind(this,"out"),spoken:"branches-map.zoom-out"},"  icon",{graphic:"map-zoom-out"}).appButton,this._zoomHandler(this.dom.zoomOut,"out")),s.findMe&&(this.dom.findMe=this._build("",{element:this.dom.controls}," app-button .app-button-find-me",{button:this._onTapFindMe.bind(this),spoken:"branches-map.find-me"},"  icon",{graphic:"map-find-me"}," find-me-cue <p> {locate-map.find-me-cue}",{access:"visual"}).appButton),s.fitBranches&&(this.dom.fitBranches=this._build("",{element:this.dom.controls}," app-button",{button:this._onTapFitBranches.bind(this),spoken:"branches-map.fit-branches"},"  icon",{graphic:"map-fit-branches"}).appButton),this.dom.findMe&&this.dom.fitBranches&&(this._classify(this.dom.findMe,"join-button-start"),this._classify(this.dom.fitBranches,"join-button-end"))},n.populate=function(e,i){var s={};this._.systems=t.select(i,function(e){if(e.websiteId&&!s[e.websiteId])return e=APP.libraries.applyBrandingOverrides(e),s[e.websiteId]=e},this),this._.branches=t.select(e,function(e){return e.system=e.system||t.try(e.systems,"[0]"),e.system?s[e.system.websiteId]?e.system=s[e.system.websiteId]:(e.system=APP.libraries.applyBrandingOverrides(e.system),s[e.system.websiteId||"-"]=e.system):e.system=this._.systems[0],e},this),this.dom.map.populate(this._geoJSONForBranches(this._.branches))},n.select=function(e,t){if(t=t||{},this._highlightBranch(e,t),e)return{system:e.system,branch:e}},n.findMe=function(e){this._announceMarker(),this._dispatch("map:branches:find-me",{coordinates:e});var i=t.try(this,"_.lastSituation"),s=i?i.coordinates:null,n=3;this._.highlightingMe&&i.zoom>13&&s&&t.smoothFloat(s[0],n)==t.smoothFloat(e[0],n)&&t.smoothFloat(s[1],n)==t.smoothFloat(e[1],n)?(this.dom.map.highlight("me",null),delete this._.highlightingMe):(this.dom.map.highlight("me",e,{zoomIntoPoint:!0}),this._.highlightingMe=e)},n.fitBranches=function(e){if(!e){var t=this.dom.pan.offsetWidth,i=Math.round(Math.min(200,Math.max(50,.15*t)));e={padding:i,maxZoom:14}}this.dom.map.fitBranches(e)},n._layout=function(e){this._build("library-branches-map",{extending:e}," pattern",{style:"background-image: url("+APP.constants.filePath("images/topography.svg")+");"}," pan"," controls .bumper-s .bumper-w")},n._listen=function(e,t){this._handle("msg:map:loaded"),this._handle("msg:map:situation"),this._handle("msg:map:marker"),this._handle("view:extract",this)},n._onMapLoadTimeout=function(){this.spun(),this._textify(this.dom.pan),delete this.dom.map,this._dispatch("map:branches:failed")},n._onMsgMapLoaded=function(e){if(this.dom.map&&this.dom.map.scope()==e.m.source){var t=APP.displayArea.computeStyleRules("margin-_");this.dom.map.style(t.join(" ")),this._classify(this.dom.root,"library-branches-map-loaded"),this._defer("load-map"),this._dispatch("map:branches:loaded",{situation:e.m})}},n._onMsgMapSituation=function(e){delete this._.lastSituation,this.dom.map&&this.dom.map.scope()==e.m.source&&(this._.lastSituation=e.m,this._dispatch("map:branches:move",{situation:e.m}))},n._onMsgMapMarker=function(e){this.dom.map&&this.dom.map.scope()==e.m.source&&this._announceMarker(e.m)},n._onViewExtractSelf=function(){this._defer("load-map")},n._announceMarker=function(e){var t={};if(e&&e.cluster)this.dom.map.situate({center:e.coordinates,zoomDelta:2}),APP.haptics.select();else if(e&&e.branch){for(var i=0,s=this._.branches.length;i<s;++i)if(this._.branches[i].id==e.branch.id){t.branch=this._.branches[i],t.system=t.branch.system;break}t.branch&&APP.haptics.select()}this._dispatch("map:branches:marker",t)},n._highlightBranch=function(e,i){var s="branch";if(e){var n=[e.longitude,e.latitude],r=t.absorb(i,{zoomIntoPoint:!0,deselectable:!0,color:this._colorForSystem(e.system)});this.dom.map.highlight(s,n,r)}else this.dom.map.highlight(s,null)},n._colorForSystem=function(e){var i=t.try(e,"colors()");return t.try(i,"[0].hex")||t.try(i,"[0].rgb")||t.try(i,"[1].hex")||t.try(i,"[1].rgb")||t.try(this,"defaultLibraryColors[0].hex")},n._geoJSONForBranches=function(e){var i={type:"FeatureCollection",features:[]};return t.each(e,function(e){(e.longitude||e.latitude)&&i.features.push({type:"Feature",geometry:{type:"Point",coordinates:[e.longitude,e.latitude]},properties:{id:e.id,name:e.name,color1:this._colorForSystem(e.system),systems:[]}})},this),i},n._zoomHandler=function(e,t){var i={},s=APP.events.onContact(e,{start:function(){s.capture(),this._zoom(t),i.timer=setInterval(this._zoom.bind(this,t),100)}.bind(this),end:function(){clearTimeout(i.timer)},cancel:function(){clearTimeout(i.timer)}})},n._zoom=function(e){this.dom.map.situate({zoomDelta:.25*("in"==e?1:-1),speed:1})},n._onTapFindMe=function(){APP.geolocator.coordinates({strategies:["gps:authorize"],onSuccess:this._onFindMeCoordinates.bind(this),onFailure:this._onFindMeFailed.bind(this)})},n._onFindMeCoordinates=function(e){this.findMe(e.coordinates)},n._onFindMeFailed=function(){var e="branches-map.geo-denied",i=APP.shell.info.platform;"iOS"!=i&&"Android"!=i||(e+=".native");var s=APP.arena.popover(this.dom.findMe).notice({label:e}),n=this._enliven(s.content,"#platform-settings",function(){this._defer("platform-settings",function(){APP.shell.transmit({name:"diagnostics:platform-settings",settings:"app-geolocation-permissions"})}.bind(this),100),s.close()}.bind(this));t.each(n,function(e){e.classList.add("branches-map-platform-settings-link")})},n._onTapFitBranches=function(){this.fitBranches()},s}),define("app/views/screens/interviews/screen-interview",["require","common","app/views/screens/screen","app/views/components/interviews/app-header-interview","app/views/components/locate-library/library-branches-map"],function(e){var t=e("common"),i=e("app/views/screens/screen"),s=i.new(),n=s.prototype,r=e("app/views/components/interviews/app-header-interview"),o=e("app/views/components/locate-library/library-branches-map");return n.become=function(e){var s=t.try(this.controller,"args.instructions")||{};this._prepare(),s.map&&!this.dom.map&&this._createBranchesMap(),s.action&&this.dom.header.createAction(s.action),e.claimOwnership(this),i.prototype.become.apply(this,arguments),"string"==typeof s&&(s={path:s}),APP.events.off(e._onCharacteristicsForScreen),e._onCharacteristicsForScreen=e.on("interview:characteristics",this._onInterviewCharacteristics.bind(this));var n=s.path.replace(/^[^#].*/,"");e.assign(s.assignments||{}),e.become(n),t.last(e.episodes).waypoint=this.controller.waypoint},n.focus=function(){t.try(this.dom,"header.focus()"),t.try(this.dom,"view.refresh()")},n._layout=function(e){this._build("screen-interview .screen",{extending:e}," backdrop"," content .content .bumper-n .bumper-e .bumper-w .bumper-s")},n._layoutHeader=function(e){e.header=new r,e.header.impart(e.root,"prepend")},n._listen=function(e,t){i.prototype._listen.apply(this,arguments),this._handle("view:extract",this),this._handle("aide:lighting")},n._onViewExtractSelf=function(){this.handlers._reimpart||t.try(this.dom,"map")&&(this.handlers._reimpart=this.on("view:impart",this._onViewReimpartSelf.bind(this)))},n._onViewReimpartSelf=function(){this._reloadMap()},n._onAideLighting=function(){this._reloadMap()},n._onInterviewCharacteristics=function(e){this.dom.header.setMascotCharacter(t.try(e,"m.episode.mascot"))},n._createBranchesMap=function(){return this._classify(this.dom.root,"has-map"),this.dom.map=new o(this.dom.backdrop),this.dom.map.spin(),this.dom.map},n._reloadMap=function(){if(!t.try(this.dom,"map"))return null;if(!this.dom.map.isInDocument())return null;var e=t.try(this.dom.map,"_.lastSituation");if(this.dom.map.extract(),this._createBranchesMap(),this.dom.view._dispatch("interview:map:reload"),e)var i=this.dom.map.on("map:branches:loaded",function(){APP.events.off(i),this.dom.map.dom.map.situate({center:e.coordinates,zoom:e.zoom})}.bind(this));return this.dom.map},s}),define("app/controllers/interviews/interview-controller",["require","common","app/controllers/controller","app/views/screens/interviews/screen-interview"],function(e){var t=e("common"),i=e("app/controllers/controller"),s=i.new(),n=s.prototype,r=e("app/views/screens/interviews/screen-interview");return n.configure=function(){this.realm="interview"},n.interview=function(){},n.enter=function(){this.screen=new r,this.screen.controller=this},n.fill=function(){var e=this.interview();console.assert(e,"[INTERVIEW-CONTROLLER] #interview() missing"),this.screen.become(e)},n.focus=function(){APP.arena.raise("interview"),APP.arena.surfaces.interview.present(this.screen),APP.arena.dom.footer[this.footer===!1?"lower":"raise"](),APP.arena.dom.footer.setSurface("interview"),APP.shell.colorize("#FFF"),i.prototype.focus.apply(this,arguments)},n.exit=function(){this.footer===!1&&APP.arena.dom.footer.raise(),i.prototype.exit.apply(this,arguments)},n._commenceInterview=function(e){e.on("interview:yield",function(t){this._continueInterview(e,t.m)}.bind(this)),e.on("interview:forget",function(e){APP.router.forget(this)}.bind(this));var i=e.commence();if("string"==typeof i&&(i={path:i}),!i||"string"!=typeof i.path)return APP.journal.error("[INTERVIEW-CONTROLLER] invalid instructions",i);if(i.path.match(/^#.*$/))return this.args=t.absorb({instructions:i},this.args||{}),this.interview=function(){return e},{head:e.address+i.path};var s=t.parameterizeURL(i.path,i.parameters);if(!i.path.match(/^interview\//))return{rewrite:s};var n=t.absorb(i.assignments,{}),r=t.excise(n,"callback")||i.callback;return(r=e.callbackToYield(r))&&(n.callback=r),APP.interviews.nextAssignments=n,{rewrite:s}},n._continueInterview=function(e,i){if("string"==typeof i&&(i={path:i}),!i||"string"!=typeof i.path)return APP.journal.error("[INTERVIEW-CONTROLLER] invalid yield path:",i.path);var s=t.absorb(i.assignments,{}),n=t.excise(s,"callback")||i.callback;(n=e.callbackToYield(n))&&(s.callback=n);var r=i.path.match(/^(interview\/[^#]*)?(#.*)?$/),o=r[1],a=r[2];o?APP.interviews.go(i.path,s,i.parameters):a?(APP.interviews.nextAssignments=s,APP.nav.go(e.address+a)):APP.nav.go(i.path)},s}),define("app/controllers/interviews/topics-controller",["require","common","app/controllers/interviews/interview-controller"],function(e){var t=e("common"),i=e("app/controllers/interviews/interview-controller"),s=i.new(),n=s.prototype;return n.match=function(e,i,s){if("interview"==e)return{rewrite:"interview/menu"};var n=e.match(/^interview\/([^\?\#]+)/);if(n){var r=n[1],o=APP.interviews.lookup(r);if(o&&o.addressable!==!1){var a=t.excise(APP.interviews,"nextAssignments")||{},l=t.queryStringToObject(i)||{},c=(new o.view).configure(r,a,l);console.assert(c,"[TOPICS-CONTROLLER] Interview#configure did not return the interview");var h="interview."+r.replace(/\/+/,"-");return this._configureRouteForInterview(o,h,c),this._commenceInterview(c)}}},n.refine=function(e,i,s){if(e=e.replace("ROLLBACK:",""),s&&!this.path.indexOf(e)){var n=s,r=this.interview();t.each(r.episodes,function(e){n=="#"+e.name&&(this.waypoint=e.waypoint||this.waypoint,this.waypoint.rewriting=!0)},this);var o=t.last(r.episodes||[]);return!this.waypoint.rewriting&&t.try(o,"isRewritable()",n)&&(this.waypoint=o.waypoint||this.waypoint,this.waypoint.rewriting=!0),this.waypoint.rewriting||(this.waypoint=this.waypoint.clone()),this.args.instructions={path:n,assignments:t.excise(APP.interviews,"nextAssignments"),parameters:t.queryStringToObject(i)||{}},{head:e+i+s}}},n.returnToWaypoint=function(e){var i=t.try(e.path.match(/(#.*)$/),"[1]");i&&(this.waypoint=e,this.args.instructions={path:i},this.interview().become(i))},n._configureRouteForInterview=function(e,i,s){var n=function(i){"function"==typeof e[i]?this[i]=e[i](this,s):"undefined"!=typeof e[i]?this[i]=e[i]:"realm"==i?this[i]=t.try(s,"assignments.realm")||"interview":"footer"==i&&(this[i]="transient"!==this.realm)}.bind(this);n("realm"),n("footer"),n("root"),this.graftable=this.footer!==!1,"function"==typeof e.label?this.waypoint.configure({label:e.label(this,s)}):"string"==typeof e.label?this.waypoint.configure({label:e.label}):this.waypoint.configure({label:i})},s}),define("app/controllers/train-controller",["require","common","./controller"],function(e){var t=e("common"),i=e("./controller"),s=i.new(),n=s.prototype;return n.screen=function(e){var i={};t.absorb(this.screenOptions||{},i),t.absorb(e||{},i);var s=i.screenClass||this.SCREEN_CLASS||t.try(this._.screen,"screenClass");if(console.assert(s,"[TRAIN] Undefined screenClass"),!i.replace&&this._.screen&&this._.screen.train&&this._.screen.screenClass==s&&this.routeEntered)return this._.screen;var n=APP.arena.surfaces[i.screenSurface||this.realm].dom.main,r=new s(this);return r.screenClass=s,i.root||this.root?n.firstCar(r):this._.screen&&this._.screen.train?n.replace(this._.screen,r):n.add(r),this._.screen=r},n.focus=function(){this._.hasFocus=!0;var e=this.screen();e.train.restore(e),"function"==typeof e.focus&&e.focus()},n.exit=function(){this._.screen&&this._.screen.train&&this._.screen.train.remove(this._.screen)},s}),define("app/views/components/library/library-logo",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return s.CACHE=[],n.become=function(e,i){this.options=t.absorb(i,this.options||{});var s=this._prepare();return this._classify(s.root,"is-invertible",this.options.invertible!==!1),this.library=e,this._fillOut(s,this.library),this},n._layout=function(e){this._build("library-logo",{extending:e}," canvas <canvas>")},n._listen=function(e,t){this._handle("contextlost",t.canvas)},n._fillOut=function(e,t){this._.state={},this._declassify(e.root,"is-drawn"),this._clearImage(),t&&t.withProxiedLogoURL(function(i){var s=this.options.spoken||"a11y.library-logo";if("string"==typeof s&&(s={label:s}),s.substitutions={LIBRARY_NAME:t.safeName()},s.wrapper=!1,this.access(e.canvas,{"aria-label":this._phrase(s)}),this.options.describing){var n=this._attr(e.canvas,"id")||this._attr(e.canvas,"id",this._generateIdAttribute("library-logo"));this._attr(this.options.describing,"aria-describedby",n)}i?this._restoreImageData(i)||this._fetchImage(i):this._writeImage(t.safeName())}.bind(this))},n._clearImage=function(){var e=this._prepare().canvas,t=e.getContext("2d");t.clearRect(0,0,e.width,e.height)},n._writeImage=function(e){},n._fetchImage=function(e){this._.state.url=e;var t=new Image;APP.events.once(t,"load",this._drawImage.bind(this,t,e)),t.src=e},n._drawImage=function(e,t){var i=this._prepare(),s=i.canvas;
t.match(/\.svg$/)?(s.width=512,s.height=s.width*e.naturalHeight/e.naturalWidth):(s.width=e.naturalWidth,s.height=e.naturalHeight);var n=s.getContext("2d");n.drawImage(e,0,0,s.width,s.height),this._cacheImageData(t,this._alphaCanvas(n)),this._.state.drawn=!0,this._classify(i.root,"is-drawn"),this.options.callback&&this.options.callback(this)},n._alphaCanvas=function(e){var t;try{t=e.getImageData(0,0,e.canvas.width,e.canvas.height)}catch(e){return}for(var i=t.data,s=[255,255,255,255],n=0,r=i.length;n<r;n+=4){var o=i[n],a=i[n+1],l=i[n+2],c=i[n+3],h=this._colorToAlpha([o,a,l,c],s);i[n]=h[0],i[n+1]=h[1],i[n+2]=h[2],i[n+3]=h[3]}return e.putImageData(t,0,0),t},n._colorToAlpha=function(e,t){var i,s,n,r,o=e[0]/255,a=e[1]/255,l=e[2]/255,c=e[3]/255,h=t[0]/255,u=t[1]/255,p=t[2]/255;return r=c,i=h<1e-4?o:o>h?(o-h)/(1-h):o<h?(h-o)/h:0,s=u<1e-4?a:a>u?(a-u)/(1-u):a<u?(u-a)/u:0,n=p<1e-4?l:l>p?(l-p)/(1-p):l<p?(p-l)/p:0,c=i>s?i>n?i:n:s>n?s:n,o=(o-h)/c+h,a=(a-u)/c+u,l=(l-p)/c+p,c*=r,[~~(255*o),~~(255*a),~~(255*l),~~(255*c)]},n._cacheImageData=function(e,t){e&&t&&!this._imageDataInCache(e)&&(s.CACHE.unshift([e,t]),s.CACHE.length=Math.min(s.CACHE.length,10))},n._restoreImageData=function(e){var t=this._imageDataInCache(e);if(!t)return!1;var i=this._prepare();return i.canvas.width=t.width,i.canvas.height=t.height,i.canvas.getContext("2d").putImageData(t,0,0),this._classify(i.root,"is-drawn"),this._.state.drawn=!0,this.options.callback&&this.options.callback(this),!0},n._imageDataInCache=function(e){for(var t=0,i=s.CACHE.length;t<i;++t)if(s.CACHE[t][0]==e)return s.CACHE[t][1]},n._onContextlostCanvas=function(e){this.library&&this.dom&&this.isInDocument()&&this._fillOut(this.dom,this.library)},s}),define("app/views/core/block-strap",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.configure=function(e){if(e.text){"string"==typeof e.text&&(e.text={label:e.text,wrapper:!1}),this._textify(this.dom.heading);var i=this._phrase(e.text);i&&(this.dom.text=this._element({tag:e.text.button||e.text.link?void 0:"span",button:e.text.button,link:e.text.link,parentNode:this.dom.heading,classes:"block-strap-text",html:i,enliven:t.try(e.text,"enliven")}))}if(e.circle){var s={button:t.excise(e.circle,"button"),link:t.excise(e.circle,"link")},n=!(!s.button&&!s.link);this._swapInteractiveElement(this.dom.circle,s),this._classify(this.dom.circle,"halo",n),e.circle.icon&&(t.try(this.dom,"icon.parentNode")==this.dom.circle&&this.dom.circle.removeChild(t.excise(this.dom,"icon")),this._textify(this.dom.circle,e.circle),this.dom.icon=this._element({parentNode:this.dom.circle,icon:e.circle.icon}))}if(e.color){var r=APP.coverGuru.rgbForColor(e.color),o=t.adjustRGB(r,{min:30,max:70}),a=APP.coverGuru.cssColorForRGB(o);this.dom.root.style.setProperty("color",a)}return this},n._layout=function(e){this._build("block-strap",{extending:e}," flex","  info","   heading <h2>","   line","  circle")},s}),define("app/views/account/library-colors",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.DEFAULT_SIZE=128,n.become=function(e){this.libraries=t.compact(t.flatten([e]));var i={};t.each(this.libraries,function(e){e.use(function(s){i[e.websiteId]=[e.colors()[0].hex,e.colors()[1].hex];var n=[];t.each(i,function(e,t){n=n.concat(t)}),this.setColors(n)},this)},this)},n.setColors=function(e){this.colors&&this.colors[0]==e[0]&&this.colors[1]==e[1]||(this.colors=e,this._defer("draw",this._draw.bind(this)),this._dispatch("colors",{libraries:this.libraries,colors:e}))},n._layout=function(){this.dom=this._build("library-colors")},n._listen=function(e){this._handle("library:colors")},n._draw=function(){this.size=this.size||this.DEFAULT_SIZE,2==this.colors.length?this._drawAsHTML():this._drawAsCanvas()},n._drawAsHTML=function(){this._prepareRootAs("div");var e={colors:[{hex:this.colors[0]},{hex:this.colors[1]}]};APP.libraries.paintColors(t.try(this,"libraries[0]"),this.dom.root,e)},n._drawAsCanvas=function(){this._prepareRootAs("canvas"),this.dom.root.setAttribute("width",this.size),this.dom.root.setAttribute("height",this.size);var e=this.dom.root.getContext("2d");if(e){var i=-.375*Math.PI,s=360/this.colors.length*Math.PI/180,n=this.size/2;t.each(this.colors,function(t){e.beginPath(),e.arc(n,n,4*n,i,i+s),e.lineTo(n,n),i+=s,e.fillStyle=t,e.fill()})}},n._onLibraryColors=function(e){this.isInDocument()?this.libraries&&this.libraries.indexOf(e.m.library)>=0&&this.become(this.libraries):APP.events.off(this.handlers.onLibraryColors)},n._prepareRootAs=function(e){if(this._prepare(),this.dom.root.tagName!=e){var t=this._element({tag:e,classes:this.dom.root.className});this.dom.root.parentNode&&this.dom.root.parentNode.replaceChild(t,this.dom.root),this.dom.root=t}return this.dom.root},s}),define("app/views/account/library-card-icon",["require","common","shibui/src/view","app/views/account/library-colors"],function(e){var t=e("common"),i=e("shibui/src/view"),s=i.new(),n=s.prototype,r=e("app/views/account/library-colors");return n.become=function(e){e=t.absorb(e,{});var i=[],s=[],n=function(e){e&&!t.among(e,i)&&i.push(e)},r=function(e){e&&!t.among(e,s)&&(s.push(e),n(e.library))};if(n(e.library),t.each(e.libraries,n),r(e.card),t.each(e.cards,r),this._prepare(),i.length?this.dom.colors.become(i):e.colors&&this.dom.colors.setColors(e.colors),1==i.length){var o=i[0],a=o.card();this._textify(this.dom.desc,{spoken:{label:"a11y.library-card",substitutions:{CARD_NAME:a?a.safeName():void 0,LIBRARY_NAME:o.safeName()}}})}else this._textify(this.dom.root,{spoken:""});return e.describe&&this._attr(e.describe,"aria-describedby",this.dom.desc.id),this},n._layout=function(){this.dom=this._build("library-card-icon"," desc .aria-spoken",{id:!0}," colors",r," overlay",{graphic:"library-card",access:"visual"})},s}),define("app/views/components/library/summary-list-of-libraries",["require","common","app/views/core/partial","app/views/core/block-strap","app/views/account/library-card-icon"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/core/block-strap"),o=e("app/views/account/library-card-icon");return n.become=function(e){this.sections&&(this.extract(),this._textify(this.dom.sections),this.impart()),this.sections=[],t.each(e,this._addSection.bind(this,this._prepare()))},n.refresh=function(e){t.isEmpty(e)||t.each(this.sections,function(t,i){t.libraries=e[i],this._populateSectionWithLibraries(t)},this)},n._layout=function(e){this._build("summary-list-of-libraries",{extending:e}," sections")},n._addSection=function(e,i){var s=t.absorb(i,{});return this.sections.push(s),this._buildSection(e,s)},n._buildSection=function(e,i){return i.strap&&i.actions&&i.actions.clearRecent&&(delete i.actions.clearRecent,i.strap.circle={icon:"block-strap-dismiss",spoken:"library-autocomplete.clear-recent",button:this._onClearRecentLibrariesAction.bind(this,i)}),t.isEmpty(i.libraries)&&t.isEmpty(i.actions)?i:(i.dom=this._build("summary-list-section",{parentNode:e.sections}," strap",{skip:!i.strap,construct:r}," list <ul>"," actions <ul>",{skip:t.isEmpty(i.actions)},"  .summary-list-action <li>",{skip:!t.try(i.actions,"manageCards")},"   .summary-list-action-manage-cards",{button:this._onManageCardsAction.bind(this,i)},"    .summary-list-action-flex","     <span> {menu.library.response.manage-cards}","     .summary-list-action-icon",{graphic:"menu-libraries-cards"},"  .summary-list-action <li>",{skip:!t.try(i.actions,"addLibrary")},"   .summary-list-action-add-library",{button:this._onAddLibraryAction.bind(this,i)},"    .summary-list-action-flex","     <span> {menu.library.response.add-library}","     .summary-list-action-icon",{graphic:"menu-libraries-add"}),i.strap&&i.dom.strap.configure(i.strap),this._populateSectionWithLibraries(i),i)},n._populateSectionWithLibraries=function(e){return e.dom?(this._emptyElement(e.dom.list),t.each(e.libraries,function(t){this._linkForLibrary(e,t)},this),void this._updateAriaCurrent(e.dom.list,t.try(APP.library,"websiteId"))):void(t.isEmpty(e.libraries)||this._buildSection(this.dom,e))},n._linkForLibrary=function(e,t){var i=this._build("summary-list-library",{tag:"li",parentNode:e.dom.list}," button",{button:this._onSelectLibrary.bind(this,t,e.dom.list),"data-item-id":t.websiteId},"  row-1","   name <strong>",{html:t.safeName()},"   card",o,"   indicator",{skip:!e.options||!e.options.indicator,icon:"star-indicator"},"  row-2","   usage <p>",{html:this._libraryUsageSentence(t),wrapper:!1});return i.card.become({library:t}),i.card.access("visual"),i},n._libraryUsageSentence=function(e){var i={CARD_COUNT:e.cards().length,LOAN_COUNT:0,LOAN_LIMIT:0,HOLD_COUNT:0,HOLD_LIMIT:0},s=e.cards();if(t.isEmpty(s))return this._phrase({label:"library.summary.usage.recent",substitutions:{MONTH_AND_YEAR:new Date(e.activatedAt)}});t.each(e.cards(),function(e){"number"==typeof t.try(e.limits,"loan")&&(i.LOAN_COUNT+=e.counts.loan,i.LOAN_LIMIT+=e.limits.loan)});var n=[];return n.push(this._phrase({label:"library.summary.usage.cards",substitutions:i})),i.LOAN_LIMIT&&n.push(this._phrase({label:"library.summary.usage.loans",substitutions:i})),i.HOLD_LIMIT&&n.push(this._phrase({label:"library.summary.usage.holds",substitutions:i})),i.PHRASES=n,this._phrase({label:"library.summary.usage",substitutions:i})},n._onSelectLibrary=function(e,i){var s={library:e},n=this._dispatch("summary:library:select",s,!0);return n?APP.nav.go(e.path()):void this._updateAriaCurrent(i,t.try(APP.library,"websiteId"))},n._onManageCardsAction=function(e,t){var i=this._dispatch("summary:library:manage",{},!0);i&&APP.interviews.go("interview/configure/cards")},n._onAddLibraryAction=function(e,t){var i=this._dispatch("summary:library:add",{},!0);i&&!APP.library?APP.interviews.go("interview/welcome"):i&&APP.interviews.go("interview/locate-library/search")},n._onClearRecentLibrariesAction=function(e,t){APP.arena.popover(t.target).confirm({warningLabel:"library-autocomplete.clear-recent.warning",buttonLabel:"library-autocomplete.clear-recent.confirm",onSubmit:this._clearRecentLibraries.bind(this,e)})},n._clearRecentLibraries=function(e){t.removeElement(e.dom.root),t.each(e.libraries,function(e){delete e.activatedAt}),APP.libraries.save()},n._updateAriaCurrent=function(e,t){var i=e.querySelector('[aria-current="true"]');i&&this._attr(i,"aria-current",null);var s=e.querySelectorAll("[data-item-id]");if(!(s.length<2)){var n=e.querySelector('[data-item-id="'+t+'"]');n&&this._attr(n,"aria-current","true")}},s}),define("app/views/account/library-card-limits",["require","common","shibui/src/view"],function(e){var t=e("common"),i=e("shibui/src/view"),s=i.new(),n=s.prototype;return n.become=function(e){this.card=e,this._refreshLimits()},n._layout=function(e){this._build("library-card-limits",{extending:e}," loans","  loans-statement .library-card-limits-statement","  loans-label .library-card-limits-label {library-card.limits.loans}","  loans-track .library-card-limits-track","   loans-progress .library-card-limits-progress"," holds","  holds-statement .library-card-limits-statement","  holds-label .library-card-limits-label {library-card.limits.holds}","  holds-track .library-card-limits-track","   holds-progress .library-card-limits-progress"," description .aria-spoken",{id:!0,access:"visual"})},n._listen=function(e,t){this._handle("patron:sync:complete")},n._onPatronSyncComplete=function(){this._refreshLimits()},n._refreshLimits=function(){var e=this.card;if(e){var i=this._prepare(),s=t.try(e.counts,"loan"),n=t.try(e.limits,"loan"),r=t.try(e.counts,"hold"),o=t.try(e.limits,"hold");i.loansProgress.style.setProperty("width",(s||0)/(n||1)*100+"%"),i.holdsProgress.style.setProperty("width",(r||0)/(o||1)*100+"%");var a={COUNT:s,LIMIT:n,ITEM_TYPE:"loan"},l={COUNT:r,LIMIT:o,ITEM_TYPE:"hold"};this._textify(i.loansStatement,{label:"library-card.picker.limits",wrapper:!1,substitutions:a}),this._textify(i.holdsStatement,{label:"library-card.picker.limits",wrapper:!1,substitutions:l}),this._textify(i.description),this._element({tag:"span",wrapper:!1,parentNode:i.description,label:"a11y.library-card.limits",substitutions:a}),this._element({tag:"span",wrapper:!1,parentNode:i.description,label:"a11y.library-card.limits",substitutions:l}),this._attr(i.root,"title",[i.description.firstChild.innerText,i.description.lastChild.innerText].join(". "))}},s}),define("app/views/components/library/summary-list-of-library-cards",["require","common","app/views/core/partial","app/views/core/block-strap","app/views/account/library-card-icon","app/views/account/library-card-limits"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/core/block-strap"),o=e("app/views/account/library-card-icon"),a=e("app/views/account/library-card-limits");return n.become=function(e){this.sections&&(this.extract(),this._textify(this.dom.sections),this.impart()),this.sections=[],t.each(e,this._addSection.bind(this,this._prepare()))},n.refresh=function(e){t.isEmpty(e)||t.each(this.sections,function(e,t){e.cards=cardsInSection[t],this._populateSectionWithCards(e)},this)},n._layout=function(e){this._build("summary-list-of-library-cards",{extending:e}," sections")},n._addSection=function(e,i){var s=t.absorb(i,{});return this.sections.push(s),this._buildSection(e,s)},n._buildSection=function(e,i){return t.isEmpty(i.cards)&&t.isEmpty(i.actions)?i:(i.dom=this._build("summary-list-section",{parentNode:e.sections}," strap",{skip:!i.strap,construct:r}," list <ul>"," actions <ul>",{skip:t.isEmpty(i.actions)},"  .summary-list-action <li>",{skip:!t.try(i.actions,"manageCards")},"   .summary-list-action-manage-cards",{button:this._onManageCardsAction.bind(this,i)},"    <span> {menu.library.response.manage-cards}","    <figure>","     .summary-list-action-icon",{graphic:"tag-list"},"  .summary-list-action <li>",{skip:!t.try(i.actions,"addCard")},"   .summary-list-action-add-card",{button:this._onAddCardAction.bind(this,i)},"    .summary-list-action-flex","     <span> {library-cards.add-card}","     <figure>","      .summary-list-action-icon",{graphic:"menu-libraries-add"}),i.strap&&i.dom.strap.configure(i.strap),this._populateSectionWithCards(i),i)},n._populateSectionWithCards=function(e){return e.dom?(this._emptyElement(e.dom.list),t.each(e.cards,function(t){if(t&&t.library){var i=this._build("summary-list-card <li>",{parentNode:e.dom.list}," button",{button:this._onSelectCard.bind(this,t,e.dom.list),"data-item-id":t.cardId},"  icon",o,"  .aria-spoken",{label:"a11y.library-card.picker.card-name"},"  name",t?{html:t.safeName()}:{label:"library-card.picker.no-card"},"  limits",{skip:!t,construct:a},"   indicator",{skip:!e.options||!e.options.indicator,icon:"star-indicator"});APP.libraries.paintColors(t.library,i.root),i.icon.become({library:t.library}),i.icon.access("visual"),i.limits&&i.limits.become(t)}},this),void this._updateAriaCurrent(e.dom.list,t.try(APP.library,"card().cardId"))):void(t.isEmpty(e.cards)||this._buildSection(this.dom,e))},n._onSelectCard=function(e,i){var s={card:e},n=this._dispatch("summary:card:select",s,!0);n&&APP.patron.cards.activateCard(e),this._updateAriaCurrent(i,t.try(APP.library,"card().cardId"))},n._onManageCardsAction=function(e,t){var i=this._dispatch("summary:card:manage",{},!0);i&&APP.interviews.go("interview/configure/cards")},n._onAddCardAction=function(e,t){var i=this._dispatch("summary:card:add",{},!0);i&&APP.interviews.go("interview/authenticate/card")},n._updateAriaCurrent=function(e,t){var i=e.querySelector('[aria-current="true"]');i&&this._attr(i,"aria-current",null);var s=e.querySelectorAll("[data-item-id]");if(!(s.length<2)){var n=e.querySelector('[data-item-id="'+t+'"]');n&&this._attr(n,"aria-current","true")}},s}),define("app/views/dialogs/dialog-library-picker",["require","common","app/views/core/partial","app/views/components/library/summary-list-of-libraries","app/views/components/library/summary-list-of-library-cards"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/components/library/summary-list-of-libraries"),o=e("app/views/components/library/summary-list-of-library-cards");return n.become=function(e){return this._fillOut(this._prepare(),e),this},n.handle=function(e){return this._.eventMappings=e,this._applyEventMappings(),this},n.present=function(e){return this.shade=APP.arena.shade(this,{heading:"library-card.picker.heading",classes:"shade-library-picker",springs:e||[.8]}),this.shade},n._layout=function(e){this._build("dialog-library-picker",{extending:e}," summaries")},n._fillOut=function(e,i){t.each(e.summaries.children,function(e){t.try(e,"_view.extract()")});var s=[],n=function(){s[0]&&(s[0].cards?new o(e.summaries).become(s):new r(e.summaries).become(s))}.bind(this);t.each(i,function(e){!s[0]||s[0].cards&&e.cards||!s[0].cards&&!e.cards?s.push(e):(n(),s=[e])}),n(),this._applyEventMappings()},n._applyEventMappings=function(){this.dom.summaries&&this._.eventMappings&&t.each(this._.eventMappings,function(e,i){t.each(this.dom.summaries.children,function(s){t.try(s._view,"on()",[e,i])},this)},this)},s}),define("app/views/components/locate-library/library-branch-details",["require","common","app/views/core/partial","./library-branches-map","app/views/account/library-card-icon","app/views/components/library/library-logo"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("./library-branches-map"),o=e("app/views/account/library-card-icon"),a=e("app/views/components/library/library-logo");return n.become=function(e,i,s){return this.system=e,this.branch=i,this.options=t.absorb(s,{}),this._fillOut(this._prepare()),this},n.libraryAttributes=function(){if(this.system){var e={name:this.system.name,websiteId:this.system.websiteId,branchCount:this.branchCount,logo:this.system.logo,colors:t.try(this.system,"colors()"),urls:this.system.urls};return this.branch&&(e.branch={id:this.branch.id,name:this.branch.name,address:this.branch.address,city:this.branch.city,region:this.branch.region,country:this.branch.country,lat:this.branch.latitude,lng:this.branch.longitude}),e}},n.mapDirections=function(e){e=e||this.branch;var i=e.formattedAddress||[e.address,e.city,e.region,e.postalCode,e.country].join(","),s={};return"iOS"==APP.shell.info.platform||navigator.userAgent.match("Mac OS")?(e.name&&(s.q=e.name),i&&(s.daddr=i),{url:t.parameterizeURL("https://maps.apple.com/",s),openInPlace:!0}):(s.api=1,i&&(s.destination=i),{url:t.parameterizeURL("https://www.google.com/maps/dir/",s),openInPlace:!1})},n._layout=function(e){this._build("library-branch-details",{extending:e}," row-1","  map"," row-2","  address <address>","   names","    system-name <h2>","    branch-name <h3>","   addr-street","   addr-area","  card",{access:"visual"}," row-3","  links","  logo",{access:"visual"})},n._fillOut=function(e){if(this.options.map&&t.try(this.branch,"latitude")){this._emptyElement(e.map);var i=new r(e.map);i.load([this.branch.longitude,this.branch.latitude],{zoom:14,zoomable:!1,logo:!1,attrib:!1}),i.on("map:branches:loaded",function(){i.populate([this.branch],[this.system])}.bind(this)),i.on("map:branches:failed",function(){i.extract()}),"directions"==this.options.map&&this._element({button:this._onTapDirections.bind(this,this.branch),parentNode:e.map,wrapper:"span",html:"🗺️ "+this._phrase("library.branches.contact-info.address.directions")})}if((this.options.card||this.options.colors)&&(this._emptyElement(e.card),"function"==typeof this.system.colors)){var s=this.system.colors().slice(0,2);s[0]=t.try(s,"[0].hex")||t.try(s,"[0].rgb")||s[0],s[1]=t.try(s,"[1].hex")||t.try(s,"[1].rgb")||s[1],new o(e.card).become({colors:s})}if(t.among("system",this.options.names)&&t.try(this.system,"name")&&this._textify(e.systemName,{html:t.try(this.system,"safeName()")||t.safe(this.system.name)}),t.among("branch",this.options.names)&&t.try(this.branch,"name")&&this._textify(e.branchName,{html:t.safe(this.branch.name)}),this.branch&&(this._textify(e.addrStreet,{html:t.safe(this.branch.address)}),this._textify(e.addrArea,{html:t.safe(t.compact([this.branch.city||null,this.branch.region||null,this._shortCountryName(this.branch.country)]).join(", "))})),this.options.links){var n=this._element({tag:"ul",parentNode:this._emptyElement(e.links),classes:"library-card-details-links-list"});t.each(this.options.links,this._addLink.bind(this,n))}this.options.logo&&this.system.withProxiedLogoURL&&new a(this._emptyElement(e.logo)).become(this.system)},n._addLink=function(e,i){var s,n=APP.libraries.branchAndLibraryURLs(this.branch,this.system),r={"🗺️":"directions","📬":"email","📞":"phone","🌐":"home","🏠":"home","🆘":"help","🛟":"help","🙋":"help"}[i];r?s=i:r=i;var o,a={};if("directions"==r&&this.branch.address?(s=s||"🗺️",a.button=this._onTapDirections.bind(this,this.branch),a.html=this._phrase("library.branches.contact-info.address.directions")):"email"==r&&n.supportEmailAddress?(o=this._phrase("library.branches.contact-info.email"),a.link=t.safe(n.supportEmailAddress),a.html=t.safe(n.supportEmailAddress.replace(/^mailto:/,""))):"phone"==r&&n.supportPhoneNumber?(o=this._phrase("library.branches.contact-info.telephone"),a.link=t.safe(n.supportPhoneNumber),a.html=t.safe(n.supportPhoneNumber.replace(/^tel:/,""))):"home"==r&&n.home?(o=this._phrase("library.branches.contact-info.website.home"),a.link=t.safe(n.home),a.html=t.safe(n.home.replace(/^.*:\/\//,"").replace(/^www\./,"").replace(/\/.*$/,""))):"help"==r&&n.support&&(o=this._phrase("menu.help-support.heading"),a.link=t.safe(n.support),a.html=t.safe(n.support.replace(/^.*:\/\//,"").replace(/^www\./,"").replace(/%.*/,""))),!t.isEmpty(a)){var l=this._element({tag:"li",parentNode:e});if(s)this._classify(l,"is-compact"),this._element({tag:"span",parentNode:l,html:s||"🗺️"}),this._element(t.absorb(a,{parentNode:l}));else{var i=this._element(t.absorb(a,{parentNode:l}));this._element({tag:"strong",parentNode:i,pos:"prepend",html:o})}return l}},n._shortCountryName=function(e){var t=(e||"").toUpperCase().replace(/[^\A-Z\s]/g,"");return{"UNITED STATES":"USA","UNITED STATES OF AMERICA":"USA",US:"USA","UNITED KINGDOM":"UK",UK:"UK"}[t]||e||null},n._onTapDirections=function(e){var t=this.mapDirections();APP.shell.openURL(t.url,{sameWindow:t.openInPlace?"force":""})},s}),define("app/views/dialogs/dialog-library-summary",["require","common","./dialog-library-picker","app/views/components/locate-library/library-branch-details"],function(e){var t=(e("common"),e("./dialog-library-picker")),i=t.new(),s=i.prototype,n=e("app/views/components/locate-library/library-branch-details");return s.present=function(e){if(!e){e=[.8];var i=document.querySelector(".screen-library-home-intro .library-emblem");if(i&&i.offsetHeight){var s=i.getBoundingClientRect().bottom-20;e=[1-s/window.innerHeight]}}return t.prototype.present.call(this,e),APP.semaphore.set("shade-name","library-summary"),this.shade.on("shade:invisible",this._onShadeInvisible.bind(this)),this.shade},s._fillOut=function(e,i){t.prototype._fillOut.call(this,e,i),e.contact||(e.contact=this._element({classes:"dialog-library-summary-contact",parentNode:e.root,pos:"prepend"}),new n(e.contact).become(APP.library,APP.library.branch,{map:"directions",colors:!0,names:["branch"],links:["🌐","🆘","📬","📞"]}),e.findBranchLink=this._element({link:"interview/locate-library/branches?key="+APP.library.key(),parentNode:e.contact,classes:"dialog-library-summary-find-branch-link",label:"library.branches.find-a-branch"}))},s._onShadeInvisible=function(e){APP.semaphore.set("shade-name")},i}),define("app/views/components/library/library-emblem",["require","common","app/views/core/partial","app/views/components/library/library-logo","app/views/dialogs/dialog-library-summary","app/views/dialogs/dialog-library-picker"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/components/library/library-logo"),o=e("app/views/dialogs/dialog-library-summary"),a=e("app/views/dialogs/dialog-library-picker");return n.become=function(e,i){this.library=e,this.options=t.absorb(i,{});var s=this._prepare();if(s.logo.become(this.library,{invertible:!1,describing:s.button,callback:function(e){var t=Math.min(e.dom.canvas.width,e.dom.canvas.height),i=Math.max(e.dom.canvas.width,e.dom.canvas.height);e.dom.canvas.style.padding=Math.min(.165,.065+t/i/8)+"em"}.bind(this)}),SPARK.locale.isEnglish){var n="a11y.library-switcher";this.options.summary&&(n+=".with-summary"),this._textify(s.button,{spoken:n})}},n._layout=function(e){this._build("library-emblem",{extending:e}," shadows","  button .halo",{button:!0},"   logo",r)},n._onTapButton=function(){APP.haptics.select();var e=[];if(APP.library){var t={};t.strap={text:{html:APP.library.safeName()}},t.cards=APP.library.cards().slice(0).sort(function(e,t){return e.createTime-t.createTime}),t.cards.length||(t.actions={addCard:!0}),t.options={indicator:!0},t.handlers={"summary:card:select":this._onSummaryCardSelect.bind(this)},e.push(t)}var i=APP.libraries.excludingNow(APP.libraries.withCards());i.length&&e.push({strap:{text:"menu.library.heading"},libraries:APP.libraries.byOldestCard(i),actions:{addLibrary:!0}});var s=APP.libraries.excludingNow(APP.libraries.recent());s.length&&e.push({strap:{text:"library-autocomplete.recent"},libraries:s,actions:{clearRecent:!0}}),APP.library||i.length||e.push({actions:{addLibrary:!0}});var n={"summary:card:select":this._onSummaryCardSelect.bind(this),"summary:library:select":this._onSummaryLibrarySelect.bind(this)};if(this.options.summary){var r=new o;r.become(e,this.options.summary).handle(n).present()}else(new a).become(e).handle(n).present()},n._onSummaryCardSelect=function(e){APP.events.stop(e),APP.patron.cards.activateCard(e.m.card),this._switchToLibrary(e.m.card.library)},n._onSummaryLibrarySelect=function(e){APP.events.stop(e),this._switchToLibrary(e.m.library)},n._switchToLibrary=function(e){var i=e._computeActiveKey();i=e.baseKey||i;var s=/^(library|search)\/[^\/]+/,n=APP.router.route.path.replace(s,"$1/"+i),r=function(){n!=APP.router.route.path?(n=n.replace(/\/scope-auto/,""),APP.nav.go(n)):(APP.libraries.now(e),APP.router.rebuild(APP.router.realm))}.bind(this),o=t.try(APP.router.route,"screen().train");o?o.skippingAnimations(r):r()},s}),define("shibui/src/components/form-field",["require","common","../view","gala"],function(e){var t=e("common"),i=e("../view"),s=i.new(),n=s.prototype;e("gala");return n.$init=function(e,t){this.options=this._normalizeOptions(e,t),this.options=this._expandOptions(this.options),this.options.parentNode&&this.impart(this.options.parentNode)},n._normalizeOptions=function(e,i){return t.isElement(e)?t.absorb(i,{parentNode:e}):t.absorb(arguments[0],{})},n._expandOptions=function(e){return!e.form&&e.parentNode&&(e.form=t.elementClosest(e.parentNode)),e},n._dispatchFieldEvent=function(e,i){i=t.absorb(i,this._fieldEventData()),this._dispatch("form:field:"+e,i)},n._fieldEventData=function(){return{field:this}},s}),define("shibui/src/components/form-control",["require","common","./form-field","gala"],function(e){var t=e("common"),i=e("./form-field"),s=i.new(),n=s.prototype,r=e("gala");return n.value=function(){return this._prepare().control.value},n.setValue=function(e){return this._prepare().control.value=e},n.focus=function(){this._focusElement(this.dom.control)},n.blur=function(){var e=this.dom.control;e&&"function"==typeof e.blur&&e.blur()},n.enable=function(){var e=this.dom.control;e&&this.access(e,"normal"),this._declassify(this.dom.root,"is-disabled")},n.disable=function(){var e=this.dom.control;e&&this.access(e,{disabled:!0}),this._classify(this.dom.root,"is-disabled")},n.validate=function(e){return this._.validating=!0,this._setValidity(this._checkValidity(),e)},n.explain=function(e){"string"==typeof e&&(e={label:e}),this._.validating||(this.options.explanation=e),this.dom.explanation.innerHTML&&this.dom.explanation.style.setProperty("min-height",this.dom.explanation.clientHeight+"px"),e&&!t.isList(e)&&(e=t.absorb(e,{morph:!0})),this._textify(this.dom.explanation,e),this.dom.control&&this.dom.explanation.innerHTML&&this._attr(this.dom.control,"aria-describedby",this.dom.explanation.id)},n._expandOptions=function(e){return("string"==typeof e.label||t.isList(e.label))&&(e.label={label:e.label}),i.prototype._expandOptions.call(this,e)},n._layout=function(e){var i=t.flatten(this.options.classes||[],[this.options.style||"shibui-style-default"]).join(" ");this._build("shibui-form-field",{extending:e,classes:i}," core","  label <label>",{skip:!this.options.label},"   label-text <span>",t.absorb(this.options.label,{id:!0,wrapper:!1})," explanation <label>",{id:!0})},n._afterLayout=function(e){e.control&&(this._classify(e.control,"shibui-form-field-control"),e.label&&(this._attr(e.label,"for",e.control.id),this._attr(e.control,"aria-labelledby",e.labelText.id),this._hasInteractiveChildren(e.label)||this.access(e.label,{"aria-hidden":"true"})),e.explanation&&this._attr(e.explanation,"for",e.control.id)),this.explain(this.options.explanation)},n._listen=function(e,t){t.control&&(this._handle("focus",t.control),this._handle("blur",t.control),this._handle("change",t.control),this._handle("invalid",t.control),e.__onTapControl=r.onTap(t.control,this._onTapControl.bind(this),{ariaRole:null}))},n._onFocusControl=function(e){this.hasFocus=!0,this._classify(this.dom.root,"is-focused"),this._dispatchFieldEvent("focus")},n._onBlurControl=function(e){this.hasFocus=!1,this._declassify(this.dom.root,"is-focused"),this._dispatchFieldEvent("blur")},n._onChangeControl=function(e){this._dispatchFieldEvent("change")},n._onTapControl=function(e){this._dispatchFieldEvent("tap")},n._checkValidity=function(){var e=this.dom.control;e.setCustomValidity&&e.setCustomValidity("");var i=t.try(this.options,"invalidations()",this.value());return i?(this._attr(this.dom.control,"data-validation",i),!1):!e.checkValidity||e.checkValidity()},n._setValidity=function(e,t){if(this._.validating=!0,t=t||{},e!==this._.validity||!t.ambient){if(e)this._declassify(this.dom.root,"is-invalid"),this._.validity!==e&&this.explain(this.options.explanation);else if(!t.ambient){this._classify(this.dom.root,"is-invalid");var i=this._attr(this.dom.control,"data-validation")||"required";this.explain({label:"field.validation."+i})}e||this.dom.control.setCustomValidity(this.dom.explanation.innerText),this._dispatchFieldEvent("validity",{validity:e})}return delete this._.validating,this._.validity=e},n._onInvalidControl=function(e){r.stop(e),this._.validating||this._setValidity(!1)},s}),define("shibui/src/components/form-input",["require","common","./form-control","gala"],function(e){var t=e("common"),i=e("./form-control"),s=i.new(),n=s.prototype,r=e("gala");return n.DEFAULT_LINES_COUNT=4,n.setValue=function(e){var t=i.prototype.setValue.apply(this,arguments);return this._updateCharCount(),t},n._layout=function(e){i.prototype._layout.apply(this,arguments),this.options.form||this._swapElement(e.root,{tag:"form",attributes:{methods:"GET",action:"#"}});var s=t.absorb(this.options.control,{});s.classes=t.flatten(["shibui-form-input-control",s.classes||[]]).join(" ").trim(),s.id=s.id||!0,s.attributes=t.absorb(this.options.attributes,{});var n=this.options.type||(this.options.lines>1?"textarea":"text");"textarea"==n?(s.tag="textarea",s.attributes.rows=this.options.lines||this.DEFAULT_LINE_COUNT):(s.tag="input",s.attributes.type=n),this.options.placeholder&&(s.attributes.placeholder=this._phrase(this.options.placeholder),this.options.label||s.attributes["aria-label"]||(s.attributes["aria-label"]=s.attributes.placeholder)),this.options.required&&(s.attributes=t.absorb(s.attributes,{required:!0,pattern:".*[^\\s]+.*"})),s.attributes.minlength=this.options.minlength,s.attributes.maxlength=this.options.maxlength,this._classify(e.root,"shibui-form-input"),this._build("",{extending:e,element:e.core,extensionClass:"shibui-form-input"}," rim",{
id:!0},"  control",s,"  char-length",{skip:!this.options.maxlength||!this.options.showLimit},"   char-count <span>",{html:"0"},"   <span>",{html:" / "},"   char-limit <span>",{html:""+this.options.maxlength}),this._attr(e.control,"data-halo-delegate",e.rim.id),this._attr(e.rim,"data-halo-states","active"),this._classify(e.root,"shibui-form-input-with-char-length",!!e.charLength)},n._afterLayout=function(e){i.prototype._afterLayout.apply(this,arguments),this.setValue(this.options.value||"")},n._listen=function(e,t){i.prototype._listen.apply(this,arguments),this._handle("input",t.control),this._handle("keydown",t.control),e.onSubmitForm=r.on(this.options.form||t.root,"submit",this._onSubmitForm.bind(this)),e.onResetForm=r.on(this.options.form||t.root,"reset",this._onResetForm.bind(this)),"undefined"!=typeof APP&&APP.keyboardFocus&&APP.keyboardFocus.track(t.control)},n._onInputControl=function(e){this._dispatchFieldEvent("change:immediate"),this._updateCharCount(),this._defer("validation",this.validate.bind(this,{ambient:!0}),500)},n._onKeydownControl=function(e){9==e.keyCode?this._dispatchFieldEvent("tab",{event:e}):13==e.keyCode&&this._dispatchFieldEvent("enter",{event:e})},n._onSubmitForm=function(e){e.preventDefault(),this._dispatchFieldEvent("submit")},n._onResetForm=function(e){this.focus(),this._dispatchFieldEvent("reset")},n._updateCharCount=function(){if(this.dom&&this.dom.charCount){var e=this.dom.control.value.length;this._textify(this.dom.charCount,{html:""+e});var t=!e,i=this.dom.charLength.classList.contains("is-invisible");t!==i&&this._classify(this.dom.charLength,"is-invisible",t)}},n._fieldEventData=function(){return{field:this,value:this.value(),validity:this._.validity,control:this.dom.control}},s}),define("text!shibui/svg/input-search.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="icon-solid" d="M46.4190729,7.10290497e-16 C52.5323443,-4.12699233e-16 54.7491642,0.636518476 56.9840848,1.83176711 C59.2190055,3.02701575 60.9729843,4.78099454 62.1682329,7.01591518 C63.3634815,9.25083581 64,11.4676557 64,17.5809271 L64,46.4190729 C64,52.5323443 63.3634815,54.7491642 62.1682329,56.9840848 C60.9729843,59.2190055 59.2190055,60.9729843 56.9840848,62.1682329 C54.7491642,63.3634815 52.5323443,64 46.4190729,64 L17.5809271,64 C11.4676557,64 9.25083581,63.3634815 7.01591518,62.1682329 C4.78099454,60.9729843 3.02701575,59.2190055 1.83176711,56.9840848 C0.636518476,54.7491642 -2.51763928e-16,52.5323443 4.33307141e-16,46.4190729 L4.73526998e-16,17.5809271 C-2.75132822e-16,11.4676557 0.636518476,9.25083581 1.83176711,7.01591518 C3.02701575,4.78099454 4.78099454,3.02701575 7.01591518,1.83176711 C9.25083581,0.636518476 11.4676557,-1.14197516e-16 17.5809271,1.96543643e-16 L46.4190729,7.10290497e-16 Z M28.8351648,16.1758242 C21.843604,16.1758242 16.1758242,21.843604 16.1758242,28.8351648 C16.1758242,35.8267256 21.843604,41.4945055 28.8351648,41.4945055 C31.4582961,41.4945055 33.8950867,40.6966858 35.9161185,39.3304643 L44.2223681,47.2062033 L44.4384319,47.3950283 C45.2654277,48.0244447 46.4509036,47.961503 47.2062033,47.2062033 C48.0301667,46.38224 48.0301667,45.0463315 47.2062033,44.2223681 L47.2062033,44.2223681 L38.9748797,36.4156817 C40.5572593,34.3024903 41.4945055,31.6782803 41.4945055,28.8351648 C41.4945055,21.843604 35.8267256,16.1758242 28.8351648,16.1758242 Z M28.8351648,20.3956044 C33.4962054,20.3956044 37.2747253,24.1741243 37.2747253,28.8351648 C37.2747253,33.4962054 33.4962054,37.2747253 28.8351648,37.2747253 C24.1741243,37.2747253 20.3956044,33.4962054 20.3956044,28.8351648 C20.3956044,24.1741243 24.1741243,20.3956044 28.8351648,20.3956044 Z" fill="#000000" />\n  </g>\n</svg>\n'}),define("text!shibui/svg/input-reset.svg",[],function(){return'<svg version="1.1" viewBox="0 0 64 64" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">\n  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">\n    <path class="color-primary icon-solid" d="M32,0 C49.673112,-3.24649801e-15 64,14.326888 64,32 C64,49.673112 49.673112,64 32,64 C14.326888,64 2.164332e-15,49.673112 0,32 C-2.164332e-15,14.326888 14.326888,3.24649801e-15 32,0 Z" fill="#000000" opacity="0.151629" />\n    <path class="icon-solid" d="M39.2760967,21.2998578 C40.2216208,20.3543337 41.7546182,20.3543337 42.7001422,21.2998578 C43.6456663,22.2453818 43.6456663,23.7783792 42.7001422,24.7239033 L42.7001422,24.7239033 L35.4237147,31.9997147 L42.7001422,39.2760967 C43.6456663,40.2216208 43.6456663,41.7546182 42.7001422,42.7001422 C41.7546182,43.6456663 40.2216208,43.6456663 39.2760967,42.7001422 L31.9997147,35.4237147 L24.7239033,42.7001422 C23.8213576,43.6026879 22.3835314,43.6437127 21.4323239,42.8232166 L21.2998578,42.7001422 C20.3543337,41.7546182 20.3543337,40.2216208 21.2998578,39.2760967 L21.2998578,39.2760967 L28.5757147,31.9997147 L21.2998578,24.7239033 C20.3543337,23.7783792 20.3543337,22.2453818 21.2998578,21.2998578 C22.2453818,20.3543337 23.7783792,20.3543337 24.7239033,21.2998578 L31.9997147,28.5757147 Z" fill="#000000" fill-rule="nonzero" />\n  </g>\n</svg>\n'}),define("shibui/src/components/form-input-search",["require","common","./form-input","text!shibui/svg/input-search.svg","text!shibui/svg/input-reset.svg"],function(e){var t=e("common"),i=e("./form-input"),s=i.new(),n=s.prototype;return n._graphic("input-search",e("text!shibui/svg/input-search.svg")),n._graphic("input-reset",e("text!shibui/svg/input-reset.svg")),n._expandOptions=function(e){return i.prototype._expandOptions.call(this,t.absorb(e,{type:"search",lines:1,attributes:{autocapitalize:"off"},placeholder:"form.search.placeholder"}))},n._layout=function(e){i.prototype._layout.call(this,e),this._classify(e.root,"shibui-form-input-search"),this._attr(e.root,"role")||this._attr(e.root,"role","search"),this._build("",{extending:e,element:e.rim}," reset-button <button>",{spoken:"a11y.form.search.reset",attributes:{type:"reset"}},"  reset-icon",{icon:this.options.resetIcon||"input-reset"}," submit-button <button>",{spoken:"a11y.form.search.submit",attributes:{type:"submit"}},"  submit-icon",{icon:this.options.submitIcon||"input-search"})},s}),define("app/views/components/search/app-header-search-catalog",["require","common","app/views/core/app-header","app/views/components/library/library-emblem","shibui/src/components/form-input-search"],function(e){var t=e("common"),i=e("app/views/core/app-header"),s=i.new(),n=s.prototype,r=e("app/views/components/library/library-emblem"),o=e("shibui/src/components/form-input-search");return n.focus=function(){i.prototype.focus.call(this),this.library=APP.library,this.dom.emblem.become(this.library);var e=t.excise(APP.router.route,"inputState"),s=e&&e.match(/^focus:(.*)/);s?(e="focus",this.setInputText(s[1])):"reset"==e&&this.setInputText(""),t.among(e,"focus","reset")&&(this._classify(this.dom.input.dom.root,"is-focused"),this._defer("input-focus",function(){this.dom.input.focus()}.bind(this),250))},n.setInputText=function(e){this.dom.input.setValue(e)},n.getInputText=function(){return this.dom.input.value()},n._layoutControls=function(e){this._classify(this.dom.root,"app-header-search-catalog"),this._build("",{extending:e,element:e.controls,extensionClass:"app-header-search-catalog"}," anchor","  input",{construct:o,with:{placeholder:"search.placeholder",attributes:{incremental:"incremental",autocorrect:"off",autocapitalize:"off","aria-label":this._phrase("a11y.search.catalog.prompt")}}},"  emblem",r),this._element({graphic:"search",parentNode:e.input.dom.rim,classes:"app-header-search-placeholder-icon",access:"visual"})},n._listen=function(){i.prototype._listen.apply(this,arguments),this._handle("form:field:change:immediate",this.dom.input),this._handle("form:field:submit",this.dom.input),this._handle("form:field:reset",this.dom.input)},n._onFormFieldChangeImmediateInput=function(e){this._manageEmblemAccess(),this._dispatch("catalog:search:input",{query:this.getInputText()})},n._onFormFieldResetInput=function(e){this.setInputText(""),this.dom.input.focus(),this._manageEmblemAccess(),this._dispatch("catalog:search:reset",{query:this.getInputText()})},n._onFormFieldSubmitInput=function(e){this._dispatch("catalog:search:submit",{query:this.getInputText()})},n._manageEmblemAccess=function(){this._.emblemAccess=this._.emblemAccess||"normal";var e=this.getInputText();e&&"normal"==this._.emblemAccess?this.dom.emblem.access(this._.emblemAccess="inert"):e||"inert"!=this._.emblemAccess||this.dom.emblem.access(this._.emblemAccess="normal")},s}),define("app/views/components/filters/filter-cloud",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.configure=function(e){var t=this._prepare();return"undefined"!=typeof e.hinting&&this._classify(t.root,"is-hinting",!!e.hinting),"undefined"!=typeof e.limit&&("number"==typeof e.limit&&isFinite(e.limit)?this._updateExpando(e.limit):this._updateExpando(1/0)),e.explainEmpty&&!t.base.firstChild?t.explainEmpty=t.explainEmpty||this._element({tag:"p",parentNode:t.root,classes:"filter-cloud-explain-empty",label:"filter-cloud.empty"}):t.explainEmpty&&(t.explainEmpty.parentNode.removeChild(t.explainEmpty),delete t.explainEmpty),this},n.reset=function(){this._.buttons={},this._textify(this._prepare().base),this._textify(this._prepare().expansion),this._attr(this.dom.root,"aria-busy",null)},n.pending=function(e){this._attr(this.dom.root,"aria-busy",e?"true":null)},n.become=function(e){return this._.buttons||this.reset(),this._retainingOnlyAccessedButtons(function(){t.each(e,this.button,this)}.bind(this)),this},n.button=function(e,i){var s=t.excise(i||{},"element");if(s||(this._.buttons=this._.buttons||{},s=this._.buttons[e],t.try(this._.accessedButtonKeys,"push()",e)),!i)return s;i="string"==typeof i?{label:i}:t.absorb(i,{}),i.classes=t.compact(["filter-button",i.classes]).join(" "),i.access=i.access||"normal",s||i.label||i.html||(i.label="filter."+e),i.wrapper="span";var n=t.excise(i,"category"),r=t.excise(i,"count"),o=t.compact([t.excise(i,"graphic"),t.excise(i,"icon")])[0];"number"==typeof r?isFinite(r)?r>999?i["data-count"]=Math.floor(r/1e3)+"k":i["data-count"]=r:o=o||"filter-cloud-filter":"string"==typeof r&&(i["data-count"]=r);var a=t.excise(i.button||{},"tooltip");if(a?i.button=function(){}:s||i.button||i.link||(i.button=function(e){var t="true"==this._attr(e.currentTarget,"aria-selected");this._attr(e.currentTarget,"aria-selected",t?"false":"true"),APP.haptics.select()}.bind(this)),s)t.isEmpty(i)||(this._applyNormalizedElementOptions(s,this._normalizeElementOptions(i)),"prepend"==i.pos&&s.parentNode.children.length>1?s!=s.parentNode.firstChild&&s.parentNode.insertBefore(s,s.parentNode.firstChild):t.among(i.pos,"prepend","append")&&s!=s.parentNode.lastChild&&s.parentNode.appendChild(s));else{var l=this.dom.expansion.firstChild?this.dom.expansion:this.dom.base,c={parentNode:l};i["aria-selected"]&&(c.role="option"),s=this._element(t.absorb(i,c)),this._.buttons[e]=s}if(APP.events.off(t.excise(s,"_toolTipHandler")),a?(this._declassify(s,"halo"),this._attr(s,"aria-disabled","true"),this._attr(s,"touch-action","manipulation"),s._toolTipHandler=APP.events.onContact(s,{start:this._presentToolTip.bind(this,s,a),end:this._dismissToolTip.bind(this,s),cancel:this._dismissToolTip.bind(this,s)})):this._attr(s,"aria-disabled",null),"string"==typeof n&&t.DataClass.set(s,"category",n),"string"==typeof o&&(t.each(s.querySelectorAll(".shibui-graphic"),function(e){e.parentNode.removeChild(e)}),o&&this._element({graphic:o,parentNode:s,classes:o})),this._classify(s,"has-graphic",!!o),!i.spoken&&!s.querySelector('[data-access="spoken"]')){var h=this._phrase({label:"a11y.filter."+("sort"==n?"sort":"with-count"),substitutions:{FILTER:t.capitalize(s.firstChild.innerText),COUNT:"number"==typeof r&&isFinite(r)&&!o?r:null}});a&&(h+=" "+this._phrase(a)),this._attr(s,"aria-label",h),this.access(s.firstChild,"visual")}return this._defer("update-expando",this._updateExpando.bind(this,void 0)),s},n.presentEditorDialog=function(){e(["app/views/dialogs/dialog-filter-cloud-editor"],function(e){var t=new e;this._populateEditorDialog(t),t.on("filter-cloud-editor:submit",this._onEditorDialogSubmit.bind(this,t)),t.on("filter-cloud-editor:reset",this._onEditorDialogReset.bind(this,t)),t.on("filter-cloud-editor:cancel",this._onEditorDialogCancel.bind(this,t)),t.present()}.bind(this))},n._layout=function(e){this._build("filter-cloud",{extending:e,role:"listbox","aria-busy":"true","aria-multiselectable":"true","aria-orientation":"horizontal","aria-roledescription":this._phrase("a11y.filter.list-of-filters")}," base"," expansion"," expando {filter-cloud.more}",{button:!0,"aria-expanded":"false"})},n._buttonForEditorDialog=function(){var e=this.button("editor-dialog",{button:this.presentEditorDialog.bind(this),classes:"filter-editor-button",graphic:"filter-cloud-editor",html:"",spoken:"a11y.filter.editor",pos:"prepend"});return this.dom.base.firstChild!=e&&this.dom.base.insertBefore(e,this.dom.base.firstChild),e},n._populateEditorDialog=function(e){},n._onEditorDialogSubmit=function(e,i){t.try(e,"shade.minimize()")},n._onEditorDialogReset=function(e,t){},n._onEditorDialogCancel=function(e,t){},n._updateExpando=function(e){if(this._defer("update-expando"),this._.expandoLimit=this._.expandoLimit||1/0,"number"==typeof e){if(!isFinite(e)&&!isFinite(this._.expandoLimit))return;this._.expandoLimit=e}else e=this._.expandoLimit;for(;this.dom.base.children.length<e&&this.dom.expansion.firstChild;)this.dom.base.appendChild(this.dom.expansion.firstChild);for(;this.dom.base.children.length>e;)this.dom.expansion.firstChild?this.dom.expansion.insertBefore(this.dom.base.lastChild,this.dom.expansion.firstChild):this.dom.expansion.appendChild(this.dom.base.lastChild);this._classify(this.dom.root,"is-expandable",!!this.dom.expansion.firstChild),this.dom.expansion.querySelector('[aria-selected="true"]')&&this._toggleExpando(!0)},n._onTapExpando=function(){var e=this._toggleExpando();this._defer("expando-focus",function(){e?t.try(this.dom.expansion,"firstChild.focus()"):this.dom.expando.focus(),APP.events.dispatch("halos:refresh")}.bind(this),150)},n._toggleExpando=function(e){return"undefined"==typeof e?e=this.dom.root.classList.toggle("is-expanded"):this._classify(this.dom.root,"is-expanded",!!e),e?(this._textify(this.dom.expando,"filter-cloud.less"),this._attr(this.dom.expando,"aria-expanded","true")):(this._textify(this.dom.expando,"filter-cloud.more"),this._attr(this.dom.expando,"aria-expanded","false")),e},n._retainingOnlyAccessedButtons=function(e){return this._.accessedButtonKeys?e():(this._.buttons=this._.buttons||{},this._.accessedButtonKeys=[],this._.discardedButtonKeys=[],e(),t.each(this._.buttons,function(e,i){t.among(e,this._.accessedButtonKeys)||(this._.discardedButtonKeys.push(e),i.parentNode&&i.parentNode.removeChild(i))},this),t.each(this._.discardedButtonKeys,t.excise.bind(t,this._.buttons)),t.each(this._.accessedButtonKeys,function(e){var t=this._.buttons[e];t.parentNode&&t.parentNode.appendChild(t)},this),void delete this._.accessedButtonKeys)},n._textDataForFilter=function(e,i){if("source"==e)for(var s=this._.memoSources=this._.memoSources||APP.libraries.withCards(),n=0,r=s.length;n<r;++n)if(s[n].websiteId==i)return{html:s[n].safeName()};return t.among(e,"year")?{html:i}:"sort"==e?{label:"filter.sort-"+i}:void 0},n._presentToolTip=function(e,t){if(e._toolTipDOM)return this._dismissToolTip(e);var i=this._prepare();i.tooltips=i.tooltips||this._element({parentNode:this.dom.root,classes:"filter-cloud-tooltips"});var s=this._build("filter-cloud-tooltip",{parentNode:i.tooltips}," label <span>");this._textify(s.label,t),s.root.style.setProperty("bottom",12-e.offsetTop+"px"),s.root.style.setProperty("left",e.offsetLeft+"px"),e._toolTipDOM=s},n._dismissToolTip=function(e,i){this._defer("dismissToolTip",function(){var i=t.excise(e,"_toolTipDOM");if(i){var s=i.root.parentNode;s.removeChild(i.root),s.firstChild||(s.parentNode.removeChild(s),t.excise(this.dom,"tooltips"))}}.bind(this),"pointercancel"==t.try(i,"type")?1e3:0)},s}),define("app/views/components/filters/filter-line-graph",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.configure=function(e){return this.width=t.try(e,"width")||this.width,this.height=t.try(e,"height")||this.height,this.aspectRatio=t.try(e,"aspectRatio")||this.aspectRatio||.75,this.strokeWidth=t.try(e,"strokeWidth")||this.strokeWidth||2.5,this.roof=t.try(e,"roof")||this.strokeWidth,t.try(e,"heading")&&this._applyHeadingTextData(e.heading),t.try(e,"labels")&&this._applyLabelsTextData(e.labels),this._.configured=!0,this},n.become=function(e){return t.isList(e[0])||(e=[e]),this.scores=e,this.refresh()},n.refresh=function(){this._.configured||this.configure(),this.w=this.width||this.dom.root.innerWidth||360,this.h=this.height||this.w*(this.aspectRatio||0)||160;var e=this._prepare();this._attr(e.image,"width",this.w),this._attr(e.image,"height",this.h),this._attr(e.image,"viewBox",[0,0,this.w,this.h].join(" ")),this._attr(e.stroke,"stroke-width",this.strokeWidth),this._textify(e.fills);var i=t.flatten(this.scores),s=0,n=0;t.each(i,function(e,t){e<=s||(s=e,n=t)}),this._textify(e.apex,{number:s}),e.apex.style.setProperty("margin-left",100/12*n+"%");var r=[];t.each(i,function(e){r.push(e/s)});var o=!0,a=this.w/r.length,l=a/2,c=this.h-this.strokeWidth/2,h=0,u=this.h,p=[];t.each(r,function(e,i){e<0&&p.length?t.breakIteration(o=!1):e>=0&&(u=this.roof+(c-this.roof)*(1-e),p.push([h+l,u])),h+=a},this),p[0]&&(p[0][0]-=l),p[1]&&(p[1][0]-=l/2),o&&p.length&&(p[p.length-1][0]+=l),this._attr(e.stroke,"points",p.join(" "));var d=0;return t.each(this.scores,function(i){for(i=i.slice(0);i[0]<0;)i.shift();for(;t.last(i)<0;)i.pop();var s=i.length,n=p.slice(d,d+s);if(n.length){var r=p[d-1],o=n[0],a=t.last(n),c=p[d+s];if(r){var h=o[0]-l,u=o[1]+(r[1]-o[1])/2;n.unshift([h,u]),n.unshift([h,this.h])}else n.unshift([o[0],this.h]);if(c){var m=c[0]-l,f=a[1]+(c[1]-a[1])/2;n.push([m,f]),n.push([m,this.h])}else n.unshift([a[0],this.h]);this._element({tag:"polygon",parentNode:e.fills,namespace:"svg",points:t.flatten(n).join(" ")}),d+=s}},this),this},n._layout=function(e){this._build("filter-line-graph",{extending:e}," heading <h2>"," apex"," image",{tag:"svg",namespace:"svg",attributes:{version:1.1,preserveAspectRatio:"none"}},"  fills",{tag:"g",namespace:"svg"},"  stroke",{tag:"polyline",namespace:"svg"}," x-labels"),this.headingTextData&&this._applyHeadingTextData(this.headingTextData),this.labelsTextData&&this._applyLabelsTextData(this.labelsTextData)},n._applyHeadingTextData=function(e){this.headingTextData=e,this.dom&&this._textify(this.dom.heading,this.headingTextData)},n._applyLabelsTextData=function(e){this.labelsTextData=e,this.dom&&t.each(this.labelsTextData,function(e){"string"==typeof e&&(e={label:e}),this._element(t.absorb(e,{tag:"span",parentNode:this.dom.xLabels}))},this)},s}),define("app/views/popovers/popover-filter-actions",["require","common","shibui/src/view","app/views/components/filters/filter-cloud","app/views/components/filters/filter-line-graph","app/views/components/library/library-logo"],function(e){var t=e("common"),i=e("shibui/src/view"),s=i.new(),n=s.prototype,r=e("app/views/components/filters/filter-cloud"),o=e("app/views/components/filters/filter-line-graph"),a=e("app/views/components/library/library-logo");return n.become=function(e,i,s,n){return this.scope=e,this.category=i,this.value=s,this.buttons=t.try(n,"buttons"),this.actions=t.try(n,"actions"),this.options=n,this},n.present=function(e){return APP.arena.popover(e).build(function(e,t){t.appendChild(this._prepare().root),e.choices(this._populatePopover.bind(this))}.bind(this))},n._populatePopover=function(e,i){this._attr(i,"data-popover-arrow-color","none");var s="sort"==this.category,n=this.buttons&&this.buttons.size>1,o=this._build("popover-filter-actions",{element:i}," explanation"," filter-cloud",{skip:!n,construct:r});this._explanationForCategory(o.explanation),n&&(t.each(this.buttons,function(e,i){"true"==t.excise(i,"aria-selected")&&(i["aria-readonly"]="true",e.match(/^sort-/)?i.graphic="filter-cloud-sort":"number"==typeof i.count&&isFinite(i.count)?i.graphic="":i.graphic="filter-cloud-filter",i.button=function(e){e.currentTarget&&e.currentTarget.scrollIntoView({inline:"center",behavior:"smooth"})})}),o.filterCloud.become(this.buttons),APP.events.scrollable(o.filterCloud.dom.root,"x"),this._defer(function(){var e=o.filterCloud.dom.root.querySelector(".is-innate");e&&e.scrollIntoView({inline:"center"})},100));var a=this.options.behavior||(s?"sort":"filter"),l=this._phrase({label:"filter-cloud.behavior."+a,okIfMissing:!0}),c="unfaceted"==a?"asterisk":a,h=this._build("popover-filter-actions-behavior",{parentNode:i.parentNode,access:"visual",pos:"prepend"}," star","  decal",{graphic:"filter-cloud-decal"},"  graphic",{graphic:"filter-cloud-"+c}," label",{skip:!l,html:l});t.DataClass.set(h.root,"behavior",a),t.each(this.actions,e.choice.bind(e))},n._explanationForCategory=function(e){if("source"==this.category?this._explanationForSourceCategory(e):"year"==this.category?this._explanationForYearCategory(e):this._explanationForGenericCategory(e),this.options.flagsLabel){var i="string"==typeof this.options.flagsLabel?{label:this.options.flagsLabel}:this.options.flagsLabel,s=this._element(t.absorb(i,{tag:"p"})),n=e.querySelector("p");n&&n.nextSibling?e.insertBefore(s,n.nextSibling):e.appendChild(s)}},n._explanationForGenericCategory=function(e){this._element({parentNode:e,classes:"spacer"});var i="sort"==this.category,s="filter.teach."+this.category,n=s+"."+this.scope,r=s+"-"+this.value,o=r+"."+this.scope,a="filter.teach."+(i?"sort":"filter"),l={okIfMissing:!0,substitutions:{CATEGORY:this.category,VALUE:t.safe(this.value)}},c=this._phrase(t.absorb(l,{label:o}))||this._phrase(t.absorb(l,{label:n}))||this._phrase(t.absorb(l,{label:r}))||this._phrase(t.absorb(l,{label:s}))||this._phrase(t.absorb(l,{label:a}));c&&this._element({tag:"p",parentNode:e,html:c})},n._explanationForSourceCategory=function(e){this._explanationForGenericCategory(e),new a(e).become(APP.libraries.find({websiteId:this.value}))},n._explanationForYearCategory=function(e){for(var i=[],s=[],n=parseFloat(this.value),r=new Date,a=n==r.getFullYear()?r.getMonth():12,l=0;l<12;++l)i.push({html:this._phrase({date:new Date(0,l),day:void 0,month:"narrow",year:void 0})}),s.push(l>a?-1:0);var c=this.options.collation.collate(this.options.criteria);t.each(c,function(e){var t=parseFloat(e.creation.month);s[t]=(s[t]||0)+1}),(new o).configure({width:280,aspectRatio:.4,heading:{label:"filter.category.year.by-month",substitutions:{YEAR:n}},labels:i}).become(s).impart(this._element({parentNode:e,classes:"popover-filter-actions-year-graph",access:"visual"}))},s}),define("app/views/components/filters/filter-line-graph-with-ranges",["require","common","app/views/core/partial","./filter-line-graph"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("./filter-line-graph");return n.configure=function(e){return e=t.absorb(e,{}),this.rangeWidth=t.excise(e,"rangeWidth"),this._.onSelectRange=t.excise(e,"onSelectRange"),t.try(e,"heading")&&this._applyHeadingTextData(t.excise(e,"heading")),this.graphConfigOptions=t.absorb(e,this.graphConfigOptions||{}),t.try(this.dom,"graph")&&this.dom.graph.configure(this.graphConfigOptions),this},n.become=function(e){var i=this._prepare();e.size>1?APP.events.scrollable(i.scroller,"x"):APP.events.unscrollable(i.scroller);var s=[];return t.each(e,function(e,t){s.push(t.scores)}),i.graph.configure({width:this.rangeWidth*s.length}),i.graph.become(s),this._textify(i.ranges),t.each(e,function(e,t,s){if(this._addRange(e,t),t.isApplied){var n=i.graph.dom.root.querySelectorAll("polygon")[s];n&&this._classify(n,"is-highlighted")}},this),this},n.scrollTo=function(e,i){if(!t.try(this.dom,"ranges.firstChild"))return!1;for(var s=0;s<e.length;++s){var n={behavior:i||"instant"};if("start"==e[s])return n.left=0,this.dom.scroller.scrollTo(n),"start";if("end"==e[s])return n.left=this.dom.scroller.scrollWidth,this.dom.scroller.scrollTo(n),"end";if("applied"==e[s])for(var r=0,o=this.dom.ranges.children.length;r<o;++r){var a=this.dom.ranges.children[r];if("true"==this._attr(a.firstChild,"aria-current")){var l=this.rangeWidth,c=l*r,h=this.dom.scroller.clientWidth;return n.left=c,l<h&&(n.left-=(h-l)/2,n.left=Math.max(0,n.left)),this.dom.scroller.scrollTo(n),"applied"}}}},n._layout=function(e){this._build("filter-line-graph-with-ranges",{extending:e}," heading .filter-line-graph-heading <h2>"," scroller",{access:{"aria-label":this._phrase("a11y.filter.line-graph")}},"  graph",r,"  ranges"),this.headingTextData&&this._applyHeadingTextData(this.headingTextData),e.graph.configure(this.graphConfigOptions)},n._applyHeadingTextData=function(e){this.headingTextData=e,this.dom&&this._textify(this.dom.heading,this.headingTextData)},n._addRange=function(e,t){var i=this._build("filter-line-graph-range",{parentNode:this.dom.ranges}," target",{spoken:{label:"a11y.filter.with-count",substitutions:{FILTER:e,COUNT:t.totalScore}},"aria-current":""+t.isApplied,button:t.totalScore?function(){"function"==typeof this._.onSelectRange&&this._.onSelectRange(e,i)}.bind(this):void 0}," sticker",{access:"visual"},"  flagpole",{html:this._phrase({number:t.totalScore})},"  check",{graphic:"tick",id:!0,skip:!t.totalScore},"  label",{html:t.html||e});return i.check&&this._attr(i.target,"data-halo-delegate",i.check.id),this.rangeWidth&&i.root.style.setProperty("width",this.rangeWidth+"px"),i},s}),define("app/views/components/filters/filter-cloud-for-list",["require","common","app/views/components/filters/filter-cloud","app/views/popovers/popover-filter-actions","app/views/components/filters/filter-line-graph-with-ranges","shibui/src/components/form-input-search"],function(e){var t=e("common"),i=e("app/views/components/filters/filter-cloud"),s=i.new(),n=s.prototype,r=e("app/views/popovers/popover-filter-actions"),o=e("app/views/components/filters/filter-line-graph-with-ranges"),a=e("shibui/src/components/form-input-search");return n.BLOCK_CATEGORIES=["scope","sort","format","availability","audience","subject","search","language","fulfillable"],n.become=function(e,i){this.list=e.resolve(),i?(this._retainingOnlyAccessedButtons(function(){t.each(i,this.button,this)}.bind(this)),this._primaryButtonsAdded()):(this.pending(!0),this._suggestFacetsForList(this.list)),this.access(this.button("editor-dialog"),"normal"),t.try(this._,"howToRefresh._isExternal")||(this.howToRefresh(this.become.bind(this,e,i)),delete this._.howToRefresh._isExternal)},n.pending=function(e){var t=this._prepare();if(!t.base.children.length){this._buttonsForPins(),e&&!t.base.children.length&&this.button("blank",{html:"                   ",access:"visual"});var s=this._buttonForEditorDialog();this.access(s,this.list?"normal":{disabled:!0})}i.prototype.pending.apply(this,arguments)},n.howToRefresh=function(e){"function"==typeof e&&(e._isExternal=!0),this._.howToRefresh=e,this._.pinSignature=APP.patron.pins.signature("title")},n._listen=function(e,t){this.route=APP.router.route,this._handle("pin:update:all"),this._handle("screen:focus")},n._primaryButtonsAdded=function(){this._buttonsForPins(),this.dom.base.children.length&&this._buttonForEditorDialog(),this.pending(!1)},n._suggestFacetsForList=function(e){if(!e.isFaceted()){this.reset();var i="unfaceted",s="asterisk";return"similar"==e.params.source.name&&(i=s="similar"),this.button("unfaceted",{label:"filter.link-"+i,graphic:"filter-cloud-"+s,access:[{"aria-readonly":"true","aria-selected":"true"}],button:function(e){var t=new r;t.become("title","link",i,{behavior:i}),t.present(e.currentTarget)}}),this._primaryButtonsAdded()}e.facets.withCountsForAlternatives(function(i){this.reset();var s=i.find({applied:!0,innate:!1,encompass:!1,pinned:!1});if(i.hasAnyTitles()){var n=i.find({innate:!0,pinned:!1});s=s.concat(n),s.length<=1&&s.length==n.length&&!i.find({pinned:!0}).length&&t.each(i.find({category:"format"}),function(e){"readalong"!=e.value&&s.push(e)})}var r=this._facetForSearchWithin(e);r&&s.push(r);var o=this._buttonsPropertiesForFacets(s);t.each(o,this.button.bind(this)),this._primaryButtonsAdded()}.bind(this),function(e){APP.journal.warn("[FCFL] failure fetching suggested facets"),this.reset(),this._primaryButtonsAdded()}.bind(this))},n._facetForSearchWithin=function(e){if(e.params.refinements.query&&"search"!=e.params.source.name){var t=decodeURIComponent(e.params.refinements.query);return t.length>8&&(t=t.substr(0,7)+"…"),{category:"query",value:e.params.refinements.query,html:this._phrase({label:"quotation",substitutions:{QUOTE:t}}),applied:!0}}},n._buttonsForPins=function(e){var i=t.try(this.list,"params.overrides()")||[];if(t.among("all",i))return[];e=e||t.select(APP.patron.pins.asFacets(),function(e){if(!t.among(e.category,i))return e});var s,n=this._buttonsPropertiesForFacets(e);return t.select(n,function(e,t){var i=this.button(e,t),n=i.parentNode;return s=s||n.firstChild,s?s!=i&&n.insertBefore(i,s):(n.appendChild(i),s=i),i},this)},n._populateEditorDialog=function(e){if(!this._.fetching){this._.fetching=!0,e.list=(e.list||this.list).resolve();var i=t.try(e,"_.blocks.retry.root");t.try(i,"parentNode")&&i.parentNode.removeChild(i),this._listBlocksForDialog(e,"fetching"),this._updateCountForDialog(e,"fetching"),e.list.facets.withCountsForAlternatives(function(i){delete this._.fetching;var s=t.excise(e._,"refiningSearchFrom"),n=e.list.params.refinements.query;if("string"==typeof s&&(s=decodeURIComponent(s)),"string"==typeof n&&(n=decodeURIComponent(n)),s==n&&(s=null),i.hasAnyTitles())this._listBlocksForDialog(e,"fetched"),this._updateCountForDialog(e,"fetched");else{if(e.list.meetsDeepSearchCriteria())return this._refineSearchQuery(e,n,{retry:s,scope:"auto"});if(s&&e._.refiningSearchFailure!=s)return e._.refiningSearchFailure=n,this._refineSearchQuery(e,s);if(this.list.params.address()!=e.list.params.address()){var r=this.list.params.address();return e.list=this.list=e.list.library.catalog.lists.produce(r),this._populateEditorDialog(e)}e.reset(),this._retryBlockForDialog(e),e.updateCount(void 0,"titles")}e.pending(!1),t.try(e,"shade.grow()")}.bind(this),function(){delete this._.fetching,APP.journal.warn("[FCFL] failure populating editor dialog",arguments),e.reset(),this._retryBlockForDialog(e),e.updateCount(void 0,"titles"),e.pending(!1),t.try(e,"shade.grow()")}.bind(this))}},n._updateCountForDialog=function(e,t){"fetched"==t?(e.updateCount(e.list.totalTitles,"titles"),e.focusOnSubmit(320)):e.updateCount(void 0,"titles")},n._listBlocksForDialog=function(e,i){this._.blockLookup=this._.blockLookup||{tutorial:this._tutorialBlockForDialog,sort:this._sortBlockForDialog,format:this._formatBlockForDialog,availability:this._availabilityBlockForDialog,days:this._daysBlockForDialog,audience:this._audienceBlockForDialog,fulfillable:this._fulfillableBlockForDialog,subject:this._subjectBlockForDialog,language:this._languageBlockForDialog,scope:this._scopeBlockForDialog,search:this._searchBlockForDialog},t.each(this._blockCategories(),function(t,s){s.phase==i&&this._.blockLookup[t].call(this,e)},this)},n._blockCategories=function(){return this._.blockCategories?this._.blockCategories:(this._.blockCategories={},t.each(this.BLOCK_CATEGORIES,function(e,t){this._.blockCategories[e]=t.phase?t:{phase:"fetched"}},this),this._.blockCategories)},n._buttonsPropertiesForFacets=function(e,i){var s=new Map;return t.each(e,function(e){var n={category:e.category,count:e.totalTitles,html:e.html||e.name||void 0,graphic:"sort"==e.category?"filter-cloud-sort":void 0};n.count&&(n.graphic=n.graphic||"");t.try(i,"dialog.list")||this.list;e.pinned||!e.innate&&!e.encompass?(e.applied&&(n.graphic="filter-cloud-remove"),
e.pinned&&(n.graphic="filter-cloud-pin"),n["aria-readonly"]=null,n["aria-selected"]=e.applied?"true":"false",n.access="normal",t.try(i,"dialog")?n.button=this._toggleFilter.bind(this,e,i):n.button=this._onTapFilterButton.bind(this,e,i)):(n.graphic=n.graphic||"filter-cloud-filter",n["aria-readonly"]="true",n["aria-selected"]=e.innate?"true":"false",t.try(i,"dialog")?e.innate?n.button={tooltip:"filter-cloud-for-list.tooltip.innate"}:"sort"==e.category?n.button={tooltip:"filter-cloud-for-list.tooltip.sort"}:n.button={tooltip:"filter-cloud-for-list.tooltip.encompass"}:n.button=this._onTapFilterButton.bind(this,e,i)),s.set(e.category+"-"+e.value,n)},this),s},n._facetBlockForDialog=function(e,i,s){var n=i.list.facets.find({category:e}),r=this._buttonsPropertiesForFacets(n,{dialog:i});return s=t.absorb(s,{}),"undefined"==typeof s.explainEmpty&&(s.explainEmpty=!0),i.block(e,r,s)},n._sortBlockForDialog=function(e){var i=e.list.facets.find({category:"sort"});if(!(i.length<=1)){var s=this._buttonsPropertiesForFacets(i,{dialog:e});return t.each(s,function(e,t){t.graphic="filter-cloud-sort"}),e.block("sort",s,{limit:4,hinting:!0})}},n._formatBlockForDialog=function(e){return this._facetBlockForDialog("format",e)},n._availabilityBlockForDialog=function(e){return this._facetBlockForDialog("availability",e)},n._daysBlockForDialog=function(e){var i,s={"0-7":{scores:[0,0]},"0-14":{scores:[0,0]},"0-30":{scores:[0,0]},"0-90":{scores:[0,0]},"0-180":{scores:[0,0]}},n={},r=e.list.facets.find({category:"days"});t.each(s,function(e,s){s.html=s.html||this._phrase("filter.chart.days-"+e),t.each(r,function(t){t.value==e&&(s.isApplied=t.applied||!1,s.totalScore=s.scores[0]=s.scores[1]=t.totalTitles,s.scores[0]&&(n["days-"+e]={isApplied:s.isApplied,count:s.scores[0]}))},this),i&&(i.scores[1]=s.scores[0]),i=s},this);var a=e.block("days",n);return a.filterCloud.extract(),a.graph||(a.graph=new o(a.root),a.xLabel=this._element({parentNode:a.root,classes:"filter-line-graph-sub-label",label:"filter.chart.days-ago"}),this._classify(a.root,"dialog-filter-cloud-editor-block-days-ago")),a.graph.configure({category:"days",height:120,rangeWidth:69,onSelectRange:function(t){var i={category:"days",value:t},s={dialog:e};this._toggleFilter(i,s,window.event)}.bind(this)}).become(s),a},n._audienceBlockForDialog=function(e){return this._facetBlockForDialog("audience",e)},n._fulfillableBlockForDialog=function(e){return this._facetBlockForDialog("fulfillable",e,{limit:3,hinting:!0})},n._subjectBlockForDialog=function(e){var i=[],s=[],n=[];t.each(e.list.facets.find({category:"subject"}),function(r){r.applied||r.innate?i.push(r):t.among(r.value,e.list.facets.VAGUE_SUBJECT_IDS)?n.push(r):s.length<5?s.push(r):n.push(r)},this);var r=this._buttonsPropertiesForFacets(i.concat(s).concat(n),{dialog:e}),o=e.block("subject",r,{limit:5,hinting:!0});return o.mural||(o.mural=APP.imageDirector.mural(o.box,"filter-subjects",{classes:"filter-cloud-subjects-mural",access:"visual"})),o},n._languageBlockForDialog=function(e){return this._facetBlockForDialog("language",e,{limit:4,hinting:!0})},n._scopeBlockForDialog=function(e){var i="deep"==t.try(e.list,"params.refinements.scope");"search"==t.try(e.list,"params.source.name");if(i||this._isDeepSearchAllowed(e.list)){var s=this._facetBlockForDialog("scope",e,{explainEmpty:!1});this._classify(s.box,"dialog-filter-cloud-editor-box-feature"),this._classify(s.box,"dialog-filter-cloud-editor-box-search-scope"),this._textify(s.head),s.mask=s.mask||this._element({parentNode:s.box,classes:"mural-mask",pos:"prepend"}),s.mural=s.mural||this._element({graphic:"filter-cloud-search-scope-mural",parentNode:s.mask,classes:"mural"}),s.paragraph=s.paragraph||this._element({tag:"p",parentNode:s.box});var n=e.list.facets.find({category:"scope"});return n.length?this._textify(s.paragraph,"filter.teach.scope-deep"):APP.library.allowDeepSearch?this._textify(s.paragraph,"filter.teach.scope-deep.excess"):this._textify(s.paragraph,"filter.teach.scope-deep.disallowed"),s}},n._searchBlockForDialog=function(e){var i=e.block("search");this._textify(i.head,"list.refine.search-within"),i.input||(i.input=new a(i.box,{placeholder:{html:" "}}),i.input.on("form:field:focus",function(e){i.input.explain("filter.search-within.enter-query")}.bind(this)),i.input.on("form:field:blur",function(t){var s=decodeURIComponent(e.list.params.refinements.query||""),n=i.input.value(),r=n.toLowerCase()!=s.toLowerCase();i.input.explain(r?"filter.search-within.apply-query":void 0)}.bind(this)),i.input.on("form:field:submit",function(t){this._refineSearchQuery(e,t.m.value,{input:i.input})}.bind(this)),i.input.on("form:field:reset",function(){this._refineSearchQuery(e,null,{input:i.input})}.bind(this)));var s=e.list.params.refinements.query||"";i.input.setValue(decodeURIComponent(s));var n=t.excise(e._,"refiningSearchFailure");return n?i.input.explain({html:['<span class="search-explain-no-results">',this._phrase({label:"filter.search-within.no-matches",substitutions:{QUERY:t.safe(n)}}),"</span>"].join("")}):i.input.explain(),i.input.enable(),i},n._refineSearchQuery=function(e,i,s){t.try(s,"input.blur()");var n={};n.query="string"==typeof i?i:"",n.scope=t.try(s,"scope")||null;var r=e.list.params.withRefinements(n);r.address()!=e.list.params.address()?(e.pending(!0),e._.refiningSearchFrom=t.try(s,"retry")||e.list.params.refinements.query||!0,t.try(s,"input.explain()","library-autocomplete.finding"),e.list=e.list.library.catalog.lists.produce(r.address()),this._populateEditorDialog(e)):t.try(s,"input.explain()")},n._retryBlockForDialog=function(e){if(!e.list.isFaceted()){var i=e.block("retry",{});return this._textify(i.head,"filter-cloud-for-list.retry-block.unfaceted"),void this._classify(e.dom.resetButton,"hide")}var s=t.flatten([APP.patron.pins.asFacets(),e.list.facets.find({applied:!0,innate:!1,encompass:!1})]);if(s.length){var n=this._buttonsPropertiesForFacets(s,{dialog:e}),i=e.block("retry",n);this._textify(i.head,"filter-cloud-for-list.retry-block.filtered")}else{var i=e.block("retry",{});this._textify(i.head,"filter-cloud-for-list.retry-block.unfiltered")}return i},n._onTapFilterButton=function(e,i,s){if(e.applied||e.innate||e.encompass){var n={buttons:[],actions:[]};if(e.pinned||e.innate||e.encompass||(n.buttons=this._buttonsPropertiesForFacets(this.list.facets.find({category:e.category}),{replacing:e}),"subject"==e.category&&(t.each(n.buttons,function(e,t){t.graphic="filter-cloud-filter",delete t.count}),t.each(this.list.facets.VAGUE_SUBJECT_IDS,function(e){n.buttons.delete("subject-"+e)}))),e.pinned||e.innate||e.encompass){var o=this._pathForAllTitlesMatchingFacet(e);o&&o!=APP.router.route.path&&n.actions.push({label:"filter-cloud-for-list.action.matching",icon:"filter-cloud-asterisk",link:"/"+o})}e.pinnable&&e.pinned?n.flagsLabel="filter-cloud-for-list.pinned-filter":e.pinnable&&(n.flagsLabel="filter-cloud-for-list.pinnable-filter",n.actions.push({label:"filter-cloud.pin-"+("sort"==e.category?"sort":"filter"),icon:"filter-cloud-pin",button:function(){APP.patron.pins.produce({scope:"title",category:e.category,value:e.value});var t=this._toggleFacetToRefinement(this.list,e),i=this.list.params.withRefinements(t),s=this.list.library.catalog.lists.produce(i.address());this._navigateToList(s,!0)}.bind(this)})),e.innate?n.flagsLabel="filter-cloud-for-list.innate-filter":e.encompass?n.flagsLabel="filter-cloud-for-list.encompass-filter":n.actions.push({label:"filter-cloud.remove-"+("sort"==e.category?"sort":"filter"),icon:"filter-cloud-remove",classes:"danger",button:this._toggleFilter.bind(this,e,i)});var a=new r;a.become("title",e.category,e.value,n),a.present(s.currentTarget)}else this._toggleFilter(e,i,s)},n._toggleFilter=function(e,i,s){i=i||{};var n=t.try(s,"currentTarget");if(n&&this._attr(n,"aria-selected")&&(this.button(e.category+"-"+e.val,{element:n,graphic:"filter-cloud-spinner","aria-busy":"true","aria-selected":e.applied?"false":"true"}),APP.haptics.select()),e.pinned){var r=APP.patron.pins.remove({scope:"title",category:e.category,value:e.value});i.dialog&&(i.dialog.removedPins=i.dialog.removedPins||[],i.dialog.removedPins.push(r))}var o=t.try(i.dialog,"list")||this.list,a={accumulator:{}};i.replacing&&this._toggleFacetToRefinement(o,i.replacing,a),this._toggleFacetToRefinement(o,e,a);var l=o.params.withRefinements(a.accumulator);i.dialog?(i.dialog.pending(!0),i.dialog.list=o.library.catalog.lists.produce(l.address()),this._populateEditorDialog(i.dialog)):this._navigateToList(o.library.catalog.lists.produce(l.address()),!0)},n._toggleFacetToRefinement=function(e,i,s){var n=t.try(s,"accumulator")||{};if(i.flagParam)n[i.flagParam]=!i.applied||null;else{var r=i.category.replace(/s?$/,"s");t.among(r,e.params.PLURAL_PARAMS)?(n[r]=t.compact(t.unique(t.flatten([n[r]||e.params.refinements[r],i.value]))),i.applied&&t.excise(n[r],i.value)):n[i.category]=i.applied?null:i.value}return n},n._navigateToList=function(e,i){t.try(e,"params.refinements.breakpoint")&&(delete e.params.refinements.breakpoint,delete e._.baseAPIURL);var s=t.try(e,"path()");return s&&s!==APP.router.route.path?(APP.nav.go(s),s):i?(APP.router.route.list=e||APP.router.route.list,this._rebuildRoute(),APP.router.route.path):void 0},n._onEditorDialogSubmit=function(e,i){var s=t.try(e,"list"),n=!!t.try(e,"removedPins.length");this._navigateToList(s,n)||t.try(e,"shade.minimize()")},n._rebuildRoute=function(){var e=APP.router.route;APP.router._unfillRoute(e),APP.router._fillRoute(e),e.focus()},n._onEditorDialogReset=function(e,i){var s={},n=e.list||this.list,r=n.facets.find({applied:!0,innate:!1});t.each(r,function(e){this._toggleFacetToRefinement(n,e,{accumulator:s})},this),n.params.refinements.query&&"search"!=n.params.source.name&&(s.query=null);var o=APP.patron.pins.removeAll({scope:"title"});if(o.length&&(e.removedPins=e.removedPins||[],e.removedPins=e.removedPins.concat(o)),!t.isEmpty(s)||o.length){var a=n.params.withRefinements(s).address();e.list=n.library.catalog.lists.produce(a),e.pending(!0),this._populateEditorDialog(e)}},n._onEditorDialogCancel=function(e,i){t.each(t.excise(e,"removedPins"),function(e){APP.patron.pins.produce({scope:"title",category:e.category,value:e.value})}),this.list=this.list.resolve()},n._isDeepSearchAllowed=function(e){var i=t.try(e,"params.source.name");if(!i)return!1;if(!t.among(i,e.DEEP_SEARCHABLE_SOURCES))return!1;if(APP.library.allowDeepSearch)return!0;for(var s=APP.libraries.withCards(),n=0,r=s.length;n<r;++n)if(s[n].allowDeepSearch)return!0;return!1},n._pathForAllTitlesMatchingFacet=function(e){if("scope"!=e.category){if(!t.try(this.list,"library.baseKey"))return void APP.events.dispatch("investigate:record",{what:"missing list or library",where:"FilterCloudForList#_pathForAllTitlesMatchingFacet",why:"INV-pFATMF",list:t.try(this.list,"params.address()"),library:t.try(this.list,"library.websiteId")});var i;if("subject"==e.category)i="subject-"+e.value;else if("sort"==e.category&&"newlyadded"==e.value)i="spotlight-new";else if("sort"==e.category&&"mostpopular"==e.value)i="spotlight-popular";else if("sort"==e.category&&"random"==e.value)i="spotlight-random";else if("availability"==e.category&&"available"==e.value)i="spotlight-available";else if("format"==e.category)i="spotlight-"+e.value+"s";else if("fulfillable"==e.category&&"kindle"==e.value)i="spotlight-kindle";else{e=t.absorb({applied:!1},t.absorb(e,{}));var s=this.list.library.catalog.lists.produce("everything"),n=this._toggleFacetToRefinement(s,e);i=s.params.withRefinements(n).address()}var r={search:"search"}[APP.router.realm]||"library";return[r,this.list.library.baseKey,i,"page-1"].join("/")}},n._onPinUpdateAll=function(){"undefined"!=typeof this._.pinSignature&&APP.patron.pins.signature("title")!=this._.pinSignature&&APP.router.route!=this.route&&(this._.refreshOnFocus=!0)},n._onScreenFocus=function(e){e.m.route==this.route&&(this._.refreshOnFocus&&"function"==typeof this._.howToRefresh&&this._.howToRefresh(this),delete this._.refreshOnFocus)},s}),define("app/views/components/interviews/interview-block",["require","common","app/views/core/partial","shibui/src/components/spinner"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("shibui/src/components/spinner");return n.become=function(e,t,i){e=e.replace(/^interview\//,"");var s=this._lookupInterview(e,t,i);return this._presentInterview(s),this._continueInterview(this.interview.commence()),this},n.checkRelevance=function(e,i,s){var n=t.excise(i,"parameters"),r=this._lookupInterview(e,i,n),o=function(e){e&&r.assign({callback:e}),this._presentInterview(r),this._continueInterview(r.commence())}.bind(this);"function"==typeof r.checkRelevance?(this.dom.spinner.spin(),this._declassify(this.dom.root,"hide"),r.checkRelevance(function(e){s(e,o)}.bind(this))):s(!0,o)},n.reset=function(){this.interview&&this.interview.extract(),this._classify(this.dom.controls,"hide"),this.dom.spinner.stop(),this._.history=[],this._.memory=[],this._updateBackability()},n._layout=function(e){this._build("interview-block .interview-inline .hide",{extending:e}," controls .hide","  back-button .shibui-button {shade.back}",{button:!0,access:"inert"},"  cameo .mascot-icon",{graphic:"mascot",access:"visual"}," appendix"," spinner",r)},n._lookupInterview=function(e,i,s){i&&i.parameters&&(s=t.absorb(s,t.excise(i,"parameters")));var n=e.split("?");e=n.shift();var r=n.join("?").replace(/#.*/,"");r.indexOf("=")&&(s=t.absorb(t.queryStringToObject(r),s||{}));var o=APP.interviews.lookup(e);if(console.assert(o,"[INTERVIEW-BLOCK] interview not found:",e,i,s),o){var a=(new o.view).configure(e,i,s);return console.assert(a,"[INTERVIEW-BLOCK] Interview#configure did not return interview:",e,i,s),a}},n._presentInterview=function(e){this.interview!=e&&(this._prepare(),this.interview?this.interview.extract():this.dom.spinner.stop(),this.interview=e,this.interview.owner!=this&&(this.interview.claimOwnership(this),this.interview.on("interview:yield",this._onInterviewYield.bind(this)),this.interview.on("interview:characteristics",this._onInterviewCharacteristics.bind(this)),this.interview.on("interview:forget",this._onInterviewForget.bind(this))),this.interview.impart(this),this._declassify(this.dom.root,"hide"),this._declassify(this.dom.controls,"hide"))},n._onInterviewYield=function(e){this._continueInterview(e.m)},n._onInterviewCharacteristics=function(e){var i=t.absorb(e.m,{}),s=t.excise(e.m,"interview");if(!this.interview||this.interview==s){t.try(i,"episode.semaphores")&&(this._.episodeSemaphores=this._.episodeSemaphores||{},t.absorb(i.episode.semaphores,this._.episodeSemaphores),t.each(this._.episodeSemaphores,this._semaphore.bind(this)));var n=t.try(i,"episode.mascot");n&&t.try(this._prepare(),"cameo")?t.DataClass.set(this.dom.cameo,"character",n):t.try(this.dom,"cameo")&&t.DataClass.clear(this.dom.cameo,"character"),this._dispatch("interview-block:characteristics",{interview:this.interview,characteristics:i})}},n._onInterviewForget=function(e){this._.history=[],this._updateBackability()},n._continueInterview=function(e){if(t.each(this._.episodeSemaphores,function(e,t){this._semaphore(e,null)},this),this._.episodeSemaphores={},"string"==typeof e&&(e={path:e}),"string"!=typeof t.try(e,"path")||!e.path.match(/^(interview\/|#)/))return APP.journal.error("[INTERVIEW-BLOCK] invalid yield path:",t.try(e,"path"));e.map&&APP.journal.warn("[INTERVIEW-BLOCK] cannot present with map",e),e.action&&APP.journal.warn("[INTERVIEW-BLOCK] cannot present with action",e);var i=t.absorb(e.assignments,{}),s=t.excise(i,"callback")||e.callback;(s=this.interview.callbackToYield(s))&&(i.callback=s);var n=e.path.match(/^(interview\/[^#]*)?(#.*)?$/),r=n[1],o=n[2],a=t.last(this.interview.episodes||[]),l=!r&&t.try(a,"isRewritable()",o)&&t.try(this._.history,"[0].episodeName")=="#"+a.name;l&&this._.history.shift();var c;if(o&&this._.history)for(var h=this._.history.slice(),u=r||t.try(this.interview,"address");h.length;){var p=h.shift();p.address==u&&p.episodeName==o&&(this._.history=[p].concat(h),p.address!=this.interview.address&&this._presentInterview(p.interview),this.interview.assign(i),c=this.interview.become(o,{focusFirstElement:this._isContinuingInterview()}),this._updateBackability())}if(!c&&r){r=t.parameterizeURL(r,e.parameters);var d=!1;t.each(this._.memory,function(e){(d=e.interview&&e.address==r)&&(this._presentInterview(e.interview),o?this._continueInterview({path:o,assignments:i}):(this.interview.assign(i),this._continueInterview(this.interview.commence())),t.breakIteration())},this),d||this.become(e.path,i,e.parameters)}else if(!c&&o){this._addToHistory({interview:this.interview,address:this.interview.address,episodeName:o}),this.interview.assign(i);var c=this.interview.become(o,{focusFirstElement:this._isContinuingInterview()})}else c||APP.nav.go(e.path);c&&c.interview==this.interview&&this._dispatch("interview-block:yield",{interview:this.interview,episodeName:o,episode:c,assignments:i})},n._addToHistory=function(e){var i=[];this._.history&&this._.history.length&&t.each(this._.history.reverse(),function(s){s.episodeName!=e.episodeName?i.unshift(s):t.breakIteration()}),this._.history=i,this._.history.unshift(e),this._.memory=this._.memory||[];var s=!1;t.each(this._.memory,function(i){i.address==e.address&&t.breakIteration(s=!0)},this),s||this._.memory.push({interview:e.interview,address:e.address}),this._updateBackability()},n._onTapBackButton=function(e){var i=t.try(this._,"history[1]");i&&(this._.history.splice(0,1),i.interview!=this.interview&&this._presentInterview(i.interview),this._continueInterview(i.episodeName))},n._updateBackability=function(){var e=this._.history.length>1,t=!e&&this.dom.root.classList.contains("is-interview-backable");this._classify(this.dom.root,"is-interview-backable",e),this._classify(this.dom.root,"was-interview-backable",t),this.access(this.dom.backButton,e?"normal":"inert")},n._isContinuingInterview=function(){return this._.history.length>1},s}),define("app/views/components/common/tutorial-balloon",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.attach=function(e,t){return e!=this._prepare().root.parentNode&&this.impart(e),t=t||this.size||"small",this.size!=t&&(this.size=t,this._classify(this.dom.root,"is-"+this.size),this._textify(this.dom.bob),this._element({parentNode:this.dom.bob,graphic:"tutorial-balloon-"+this.size,access:"visual"})),this},n.release=function(){if(this.dom&&this.dom.root){var e=this._element({parentNode:APP.arena.dom.overlay,classes:"tutorial-balloon-release-anchor"}),t=(new s).attach(e,this.size),i=this.dom.root.getBoundingClientRect();t.dom.root.style.setProperty("top",i.top+"px"),t.dom.root.style.setProperty("left",i.left+"px"),t.dom.root.style.setProperty("right","initial"),t.dom.root.style.setProperty("bottom","initial"),this._classify(e,"is-released"),this._defer(function(){t.extract(),e.parentNode.removeChild(e)},1200),this.extract(),APP.haptics.impact("light")}},n.whenDismissed=function(e,i){return e&&t.among(i,"extract","release")?this._.whenDismissed={key:e,action:i}:delete this._.whenDismissed,this},n._layout=function(e){this._build("tutorial-balloon",{extending:e}," pan-y","  pan-x","   scale","    bob")},n._listen=function(e,t){this._handle("patron:dismiss")},n._onPatronDismiss=function(e){return this.isInDocument()?void(this._.whenDismissed&&this._.whenDismissed.key==e.m.key&&("release"==this._.whenDismissed.action?this.release():"extract"==this._.whenDismissed.action&&this.extract())):this._deafenHandlers()},s}),define("app/views/components/filters/filter-cloud-for-catalog",["require","common","app/views/components/filters/filter-cloud-for-list","app/views/components/interviews/interview-block","app/views/components/common/tutorial-balloon"],function(e){var t=e("common"),i=e("app/views/components/filters/filter-cloud-for-list"),s=i.new(),n=s.prototype,r=e("app/views/components/interviews/interview-block"),o=e("app/views/components/common/tutorial-balloon");return n.BLOCK_CATEGORIES=["tutorial","subject","format","availability","sort","audience","language","fulfillable"],n.become=function(e,i){this.catalog=e,this.list=this.catalog.lists.produce("everything"),this.reset(),i?(this._retainingOnlyAccessedButtons(function(){t.each(i,this.button,this)}.bind(this)),this._primaryButtonsAdded()):this.pending(!0)},n._tutorialBlockForDialog=function(e){if(t.try(this.dom.balloon,"dom.root.parentNode")){var i=e.block("tutorial");if(i.head){delete i.head,this._textify(i.box),this._classify(i.root,"is-tutorial");var s=new o;i.interview=new r(i.box),i.interview.become("tutorial/filter-cloud-editor",{callback:function(){s.release(),i.interview.extract(),i.root.parentNode.removeChild(i.root)}});var n=i.root.querySelector(".interview-answers");s.attach(n,"large")}return i}},n._subjectBlockForDialog=function(e){if(t.try(e,"list.facets.subject.length")){var i=e.list.facets.find({applied:!0,category:"subject"});t.each(e.list.facets.subject,function(s){if(!(i.length>=6))return s.applied?s:void(s.totalTitles>.95*e.list.totalTitles||t.among(s.value,e.list.facets.VAGUE_SUBJECT_IDS)||i.push(s))});var s=this._buttonsPropertiesForFacets(i,{dialog:e}),n=e.block("subject",s);n.link||(n.link=this._element({link:e.list.library.path("subjects"),parentNode:n.box,classes:"filter-cloud-for-catalog-subjects-link"}),n.linkText=this._element({tag:"span",parentNode:n.link}));var r=APP.patron.pins.signature("title")?"some":"all",o=APP.library.catalog.lists.produce("everything");return this._textify(n.linkText,{label:"filter-cloud-for-catalog.subjects."+r,substitutions:{SUBJECT_COUNT:t.try(o,"facets.subject.length")||t.try(this.list,"facets.subject.length")},wrapper:!1}),n.mural||(n.mural=APP.imageDirector.mural(n.root,"filter-subjects",{classes:"filter-cloud-subjects-mural",access:"visual"})),n}},n._sortBlockForDialog=function(e){var i=e.list.facets.find({category:"sort"});i=t.select(i,function(e){if(!e.innate&&!e.encompass)return e;var i={innate:!1,encompass:!1,applied:!1};return t.absorb(i,t.absorb(e,{}))});var s=this._buttonsPropertiesForFacets(i,{dialog:e});return t.each(s,function(e,t){t.graphic="filter-cloud-sort"}),e.block("sort",s,{limit:4,hinting:!0})},n._navigateToList=function(e){return this._rebuildRoute(),APP.router.route.path},n._onEditorDialogSubmit=function(e,i){var s=t.try(e,"list.path()");t.try(i,"m.intentional")&&s?APP.nav.go(s):t.try(e,"removedPins.length")?this._rebuildRoute():t.try(e,"shade.minimize()")},s}),define("shibui/src/haptics",["require","common"],function(e){var t=e("common"),i=t.Class.new();i.prototype;return i.GAP_MS=75,i.attach=function(e){return this._=this._||{},this._.shell=e,i},i.detach=function(){return delete this._,i},i.prepare=function(){this._transmit("prepare")},i.select=function(){navigator.userAgent.match(/Chrome/)||this._transmit("select")},i.impact=function(e){e=e||"light",this._transmit("impact:"+e)},i.notify=function(e){e=e||"success",this._transmit("notify:"+e)},i._isSupported=function(){return!(!this._||!this._.shell)&&("undefined"==typeof this._.supported&&(this._.supported=this._.shell.has("ui:haptics")),this._.supported)},i._transmit=function(e){if(this._isSupported()){clearTimeout(this._.transmissionTimer);var i=t.epochMilliseconds(),s=i-(this._.lastTransmissionMS||0);s<this.GAP_MS?this._.transmissionTimer=setTimeout(this._forceTransmit.bind(this,e),s+1):this._forceTransmit(e)}},i._forceTransmit=function(e){this._&&this._.shell&&(this._.lastTransmissionMS=t.epochMilliseconds(),this._.shell.transmit({name:"haptic:"+e,dest:"shell"}))},i}),define("text!shibui/svg/trash.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'>\n  <g stroke='none' stroke-width='1' fill='none' fill-rule='evenodd'>\n    <line x1='14.5' y1='18.5' x2='49.5' y2='18.5' stroke='#000000' stroke-width='3' stroke-linecap='round' class='icon-hollow' />\n    <path d='M27,18 L27,15 C27,13.8954305 27.8954305,13 29,13 L35,13 C36.1045695,13 37,13.8954305 37,15 L37,18 L37,18' stroke='#000000' stroke-width='3' class='icon-hollow' />\n    <path d='M46.9213769,22 C47.4736617,22 47.9213769,22.4477153 47.9213769,23 C47.9213769,23.0252074 47.9204238,23.0504058 47.9185196,23.0755411 L45.7101043,52.2266233 C45.5915844,53.7910862 44.287622,55 42.7186762,55 L21.2813238,55 C19.712378,55 18.4084156,53.7910862 18.2898957,52.2266233 L16.0814804,23.0755411 C16.0397602,22.5248344 16.4523753,22.0445775 17.003082,22.0028573 L17.0408255,22.0007146 L17.0408255,22.0007146 L46.9213769,22 Z M32,28.5 C31.4477153,28.5 31,28.9477153 31,29.5 L31,29.5 L31,47.5 L31.0067277,47.6166211 C31.0644928,48.1139598 31.4871642,48.5 32,48.5 C32.5522847,48.5 33,48.0522847 33,47.5 L33,47.5 L33,29.5 L32.9932723,29.3833789 C32.9355072,28.8860402 32.5128358,28.5 32,28.5 Z M23.5613447,28.501788 L23.44453,28.5015396 C22.8930956,28.5321749 22.4709044,29.0040356 22.5015396,29.55547 L22.5015396,29.55547 L23.5015396,47.55547 L23.514726,47.6715384 C23.5999896,48.1649071 24.0434238,48.5269074 24.55547,48.4984604 C25.1069044,48.4678251 25.5290956,47.9959644 25.4984604,47.44453 L25.4984604,47.44453 L24.4984604,29.44453 L24.485274,29.3284616 C24.4000104,28.8350929 23.9565762,28.4730926 23.44453,28.5015396 Z M40.55547,28.5015396 C40.0040356,28.4709044 39.5321749,28.8930956 39.5015396,29.44453 L39.5015396,29.44453 L38.5015396,47.44453 L38.501788,47.5613447 C38.5318768,48.0611219 38.9324837,48.4700133 39.44453,48.4984604 C39.9959644,48.5290956 40.4678251,48.1069044 40.4984604,47.55547 L40.4984604,47.55547 L41.4984604,29.55547 L41.498212,29.4386553 C41.4681232,28.9388781 41.0675163,28.5299867 40.55547,28.5015396 Z' fill='#000000' class='icon-solid' />\n  </g>\n</svg>\n"}),define("shibui/src/components/edit-rail",["require","common","../view","gala","quirkbase","../haptics","text!shibui/svg/trash.svg"],function(e){var t=e("common"),i=e("../view"),s=i.new(),n=s.prototype,r=e("gala"),o=e("quirkbase"),a=e("../haptics");return n._graphic("trash",e("text!shibui/svg/trash.svg")),n.SLIDE_PX=8,n.TERMINAL_PERCENT=.65,n.$init=function(e,s){this.item=e,t.isList(s)?this.actions={right:s}:s&&"function"!=typeof s?this.actions=s:this.actions={right:[{icon:"trash",spoken:"a11y.edit-rail.delete",button:s||!0}]},i.prototype.$init.call(this,e)},n.delete=function(){var e,i=t.last(this.actions.right);return i&&!i.retain&&(e=i.button),this._terminate(e),!!e},n._layout=function(e){this._classify(this.item,"halos-anchor"),"TR"==this.item.tagName&&this._swapElement(e.root,{tag:"td"}),this._build("shibui-edit-rail",{extending:e}),t.each(this.actions.right,function(i){i=t.absorb(i,{});var s=t.excise(i,"button");t.excise(i,"retain")?this._.lastButtonAction=this._close.bind(this,s):this._.lastButtonAction=this._terminate.bind(this,s);var n=this._element({parentNode:e.root,button:this._.lastButtonAction,spoken:t.excise(i,"spoken")}),r=this._element(t.absorb(i,{parentNode:n}));this._attr(r,"id",this._generateIdAttribute("edit-rail-icon")),this._attr(n,"data-halo-delegate",r.id)},this)},n._listen=function(e,t){o("forgets-how-to-scroll")||(e.slide=r.onContact(this.item,{start:this._onSlideStart.bind(this),move:this._onSlideMove.bind(this),end:this._onSlideEnd.bind(this),cancel:this._onSlideCancel.bind(this)}),r.setTouchAction(this.item,"manipulation"),r.on(this.item,"mousedown",r.stop))},n._onSlideStart=function(e){var t=this._.state?this._.state.slidePosition:0,i=this._.state={};i.startX=e.screenX,i.startY=e.screenY,i.slidePosition=i.prevPosition=i.startPosition=t||0,i.terminatePosition=0-(this.item.getBoundingClientRect().width+4),i.thresholdPosition=i.terminatePosition*this.TERMINAL_PERCENT,i.buttonWidths=this._computeButtonWidths(),i.openPosition=0-i.buttonWidths[0],a.prepare(),this.velocity||(this.velocity=new r.Velocity,this.velocity.onUpdate=this._onVelocityUpdate.bind(this)),this._configureVelocity(i.openPosition,0,{first:!0})},n._onSlideMove=function(e){var t=this._.state;if(!t.aborted){var i=e.screenX-t.startX,s=e.screenY-t.startY;if(!(!t.sliding&&Math.abs(i)<this.SLIDE_PX&&Math.abs(s)<this.SLIDE_PX))if(t.sliding||Math.abs(i)>Math.abs(s)){if(!t.sliding){if(i>0)return;t.sliding=!0,this._captureContact()}r.stop(e),this.velocity.trackNext(t.startPosition+i,0)}else i!=s&&(t.aborted=!0)}},n._onSlideEnd=function(e){var t=this._.state;t&&t.captured&&(this._releaseContact(),t.terminal?this._defer("transitioning",this._.lastButtonAction,100):t.slidePosition<=Math.min(-1,t.prevPosition)?this._defer("transitioning",this._open.bind(this)):(this._defer("transitioning",this._close.bind(this)),t.slidePosition>=0&&delete this._.state))},n._onSlideCancel=function(){this._releaseContact(),this._defer("transitioning",this._close.bind(this),100)},n._captureContact=function(){this._.state&&!this._.state.captured&&(this._.state.captured=!0,this.handlers.slide.capture(),this.handlers._onTouchMove=r.on(this.item,"touchmove",r.stop),this._classify(this.item,"is-gripping"),this._defer("activation"))},n._releaseContact=function(){this._.state&&this._.state.captured&&(this._.state.captured=!1,this.handlers.slide.release(),this._declassify(this.item,"is-gripping"),this.handlers._onTouchMove.deafen(),this.access(this.item,"inert"),this._defer("activation",this.access.bind(this,this.item,"normal"),100))},n._computeButtonWidths=function(){var e=Array.prototype.slice.call(this.dom.root.children,0).reverse(),i=[],s=0;return t.each(e,function(e){s+=e.scrollWidth,i.unshift(s)}),i},n._configureVelocity=function(e,i,s){if(this.velocity){var n=t.try(this._,"state.slidePosition")||0;this.velocity.configure({position:{x:n,y:0},boundary:{left:e,right:i,top:0,bottom:0},boundaryFrictionBase:{x:0,y:0}}),s&&s.first?this.velocity.trackFirst(n,0):s&&s.last&&this.velocity.trackLast(n,0)}},n._onVelocityUpdate=function(e,i,s){var n=this._.state;if(n&&!n.terminated){var r=Math.max(Math.min(e,0),n.terminatePosition);if(n.prevPosition=n.slidePosition,n.slidePosition=r,n.captured&&r<=n.thresholdPosition||n.terminal&&!n.captured)n.terminal||(n.terminal=!0,a.impact("light"),t.each(this.dom.root.children,function(e,t){t&&(this._stylePrefix(e,"transition","transform 150ms"),this._styleTransform(e))},this)),this._styleTransform(this.item,"translate3d("+r+"px, 0, 0)");else if(Math.ceil(r)){if(n.terminal&&(n.terminal=!1,a.impact("light")),r-=4,this._styleTransform(this.item,"translate3d("+r+"px, 0, 0)"),this._classify(this.dom.root,"is-open"),this._classify(this.item,"is-editing"),n.buttonWidths.length>1){var o=Math.max(r,n.openPosition)/n.openPosition;t.each(this.dom.root.children,function(e,t){if(t){var i=r*-1-(n.buttonWidths[t]*o+4);this._stylePrefix(e,"transition"),this._styleTransform(e,"translate3d("+i+"px, 0, 0)")}},this)}}else this._styleTransform(this.item),this._declassify(this.dom.root,"is-open"),this._declassify(this.item,"is-editing")}},n._open=function(){if(this.handlers.dismissal)r.on(this.handlers.dismissal);else{var e=function(e){for(var t=e.target.parentNode;t;){if(t==this.dom.root)return!0;t=t.parentNode}}.bind(this),i=function(t){e(t)||(this._configureVelocity(0,0,{last:!0}),r.stop(t))}.bind(this),s=function(t){e(t)||(this._defer("transitioning",this._close.bind(this),100),r.stop(t))}.bind(this),n=function(t){e(t)||r.stop(t)},o=document.body,a=[];t.each(["pointerdown","mousedown","touchstart"],function(e){a.push(r.on(o,e,i,!0))}),t.each(["pointerup","mouseup","touchend"],function(e){a.push(r.on(o,e,s,!0))}),t.each(["click"],function(e){a.push(r.on(o,e,n,!0))}),this.handlers.dismissal=a}r.off(this.handlers.slide);var l=t.try(this._,"state.openPosition")||-100;this._configureVelocity(l,l,{last:!0})},n._close=function(e){r.off(this.handlers.dismissal),r.on(this.handlers.slide),this._configureVelocity(0,0,{last:!0}),"function"==typeof e&&e(this)},n._terminate=function(e,i){r.off(this.handlers.dismissal);var s,n=this.item.getBoundingClientRect();this._.state?(this._.state.terminated=!0,s=this._.state.terminatePosition):s=0-(n.width+4),this.access(this.item,"inert"),this._stylePrefix(this.item,"transition","all 200ms"),
this._styleTransform(this.item,"translate3d("+s+"px, 0, 0)"),this.item.style.setProperty("opacity",0),this.item.style.setProperty("height",n.height+"px"),this._defer("transitioning",function(){for(;this.item.firstChild!==this.dom.root;)this.item.removeChild(this.item.firstChild);this.item.style.setProperty("height",0),this._defer("transitioning",function(){this.item.parentNode&&this.item.parentNode.removeChild(this.item),"function"==typeof e&&e(this)}.bind(this),200)}.bind(this));var o=t.try(i,"tappedElement")||this.dom.root.lastChild;this._stylePrefix(o,"transition"),this._styleTransform(o),t.each(this.dom.root.children,function(e){e!=o&&e.parentNode.removeChild(e)},this)},s}),define("app/views/components/search/search-suggestions",["require","common","app/views/core/partial","app/views/core/block-strap","shibui/src/components/edit-rail"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/core/block-strap"),o=e("shibui/src/components/edit-rail");return n.onSelected=function(e){this._.onSelectedCallback=e},n.update=function(e){this._prepare();var t="empty";this._updateGuessList(e)?(t="guess",this._scrollToTopOfScreen(),this.impart()):this._updateRecentList()?(t="recent",this.dom.guessList.style.setProperty("display","none"),this._scrollToTopOfScreen(),this.impart()):this.extract(),this._semaphore("search-suggestions",t)},n.saveQuery=function(e){APP.patron.searchHistory.add(e),this._.recentReady=!1},n._layout=function(e){this._build("search-suggestions",{extending:e}," guesses .pillar","  guess-list <ul>"," recents .pillar","  recent-strap",r,"  recent-list <ul>"),e.recentStrap.configure({text:"search.recent.head",circle:{icon:"block-strap-dismiss",spoken:"search.recent.clear",button:this._onTapClearRecentSearchesButton.bind(this)}})},n._listen=function(){APP.keyboardFocus.blurOnContactWith(this.dom.root)},n._updateGuessList=function(e){if(e&&e.trim()){var i;if(this.jobs=t.select(this.jobs||[],function(t){return e===t.query&&(i=t),0===e.indexOf(t.query)?t:void t.request.abort()}),this.jobs=t.select(this.jobs,function(e,t){return 0===t||e===i?e:void e.request.abort()}),i)return!0;var s={query:e,sortBy:"score",categorySize:12,maxSize:12,mediaType:this._mediaTypesForRequest(),fuzzy:APP.flags.isOn("fuzzy-autocomplete")||void 0},n={};return n.query=e,n.request=APP.services.autocomplete.fetch(t.parameterizeURL("autocomplete",s),this._onSuggestions.bind(this,n),function(){t.excise(this.jobs,n)}.bind(this)),this.jobs.push(n),!0}return t.each(this.jobs,function(e){e.request.abort()}),this.jobs=[],!1},n._updateRecentList=function(){if(this._.recentReady)return!0;this._prepare(),this._textify(this.dom.recentList);var e=0;return t.each(APP.patron.searchHistory.queries,function(t){this._createRecentItem(this.dom.recentList,t),e+=1},this),this._.recentReady=APP.patron.searchHistory.queries.length>0},n._onTapClearRecentSearchesButton=function(e){APP.arena.popover(e.target).confirm({warningLabel:"search.recent.clear.warning",buttonLabel:"search.recent.clear.confirm",onSubmit:this._clearRecentSearches.bind(this)})},n._clearRecentSearches=function(){APP.patron.searchHistory.reset(),this._.recentReady=!1,this.update()},n._onSuggestions=function(e,i){for(var s=this.jobs.shift();s&&s!=e;)s.request.abort(),s=this.jobs.shift();var n=this._prepare().guessList;n.style.removeProperty("display");var r=JSON.parse(i),o=[];r.items?t.each(r.items,function(e){o.push({value:APP.titles.cleanTitleString(e.text),category:e.field})}):r.suggestions&&t.each(r.suggestions,function(e){o.push({value:APP.titles.cleanTitleString(e)})});var a=Array.prototype.slice.call(n.children);t.each(o,function(e){this._createGuessItem(n,e.value,e.category,a)},this),t.each(a,function(e){e.parentNode.removeChild(e)})},n._createRecentItem=function(e,i){var s=this._element({tag:"li",parentNode:e});s.setAttribute("data-term",i);var n=(this._element({button:this._onTapQueryItem.bind(this,s),parentNode:s,classes:"search-suggestion",html:t.safe(i),attributes:{"data-halo-inset":"0"}}),new o(s,this._deleteRecentItem.bind(this,s,i)));n.TERMINAL_PERCENT=.45},n._deleteRecentItem=function(e,t){e.parentNode&&e.parentNode.removeChild(e),APP.patron.searchHistory.remove(t)},n._createGuessItem=function(e,t,i,s){var n;if(s&&s.length)n=s.shift();else{n=this._element({tag:"li",parentNode:e});var r=this._element({parentNode:n,button:this._onTapQueryItem.bind(this,n),classes:"search-suggestion",attributes:{"data-halo-inset":"0"}});this._element({tag:"span",parentNode:r}),this._element({tag:"span",parentNode:r})}var o=n.querySelector("span:first-child"),a=n.querySelector("span:last-child");this._textify(o,{html:t});try{n.setAttribute("data-term",o.innerText)}catch(e){n.setAttribute("data-term",t)}n.setAttribute("data-category",i),i?this._textify(a,{label:"search.guesses.category."+i,wrapper:!1}):this._textify(a)},n._onTapQueryItem=function(e,t){var i=e.getAttribute("data-term");this._.onSelectedCallback&&this._.onSelectedCallback(i)},n._mediaTypesForRequest=function(){var e=APP.patron.pins.filter({scope:"title",category:"format"}),i=t.unique(t.select(e,function(e){return APP.constants.mediaTypes(e.value||"")}));return i.length?i:APP.constants.mediaTypes()},n._scrollToTopOfScreen=function(){APP.arena&&APP.arena.scroller&&APP.arena.scroller.scrollToTop({duration:0,stopUserScrollFirst:!0})},s}),define("app/views/screens/search/screen-search-catalog",["require","common","app/views/screens/screen","app/views/components/search/app-header-search-catalog","app/views/core/block-strap","app/views/components/filters/filter-cloud-for-catalog","app/views/components/search/search-suggestions"],function(e){var t=e("common"),i=e("app/views/screens/screen"),s=i.new(),n=s.prototype,r=e("app/views/components/search/app-header-search-catalog"),o=e("app/views/core/block-strap"),a=e("app/views/components/filters/filter-cloud-for-catalog"),l=e("app/views/components/search/search-suggestions");return n.search=function(e){this._prepare(),"string"!=typeof e&&(e=this.dom.header.getInputText());var t={},i=e.trim();i&&(this.dom.header.setInputText(e),this.dom.suggestions.saveQuery(i),t.query=encodeURIComponent(i)),t.query&&this.controller.performSearch(this._library(),t)},n.focus=function(){this.controller.inputState&&this.scroller.scrollToTop({duration:0}),this.dom.header.focus(),this._populateFilterCloud(this.dom.filterCloud),this._updateSuggestions()},n.refocus=function(){this.dom.header.setInputText(""),this._updateSuggestions()},n._layout=function(e){this._build("screen-search-catalog",{extending:e}," pillar .pillar .bumper-n .bumper-e .bumper-w .bumper-s","  parameters","   parameters-block-strap",o,"   filter-cloud",a,"  suggestions",l),e.parametersBlockStrap.configure({text:"search.filters.head"})},n._layoutHeader=function(e){e.header=new r,e.header.impart(e.root,"prepend")},n._listen=function(e){this._handle("catalog:search:input",this.dom.header),this._handle("catalog:search:reset",this.dom.header),this._handle("catalog:search:submit",this.dom.header),this.dom.suggestions.onSelected(this.search.bind(this))},n._populateFilterCloud=function(e){if(!this._.isFillingOutFilters){this._.isFillingOutFilters=!0;var i=this._library();e.become(i.catalog),e.list.facets.freshen(function(s){if(this._.isFillingOutFilters){delete this._.isFillingOutFilters;var n=new Map,r=function(e){return["search",i.baseKey,e,"page-1"].join("/")};t.each(s.find({category:"format",pinned:!1}),function(e){"readalong"!=e.value&&n.set(e.category+"-"+e.value,{link:r("spotlight-"+e.value+"s"),count:e.totalTitles})});var o;if(o=s.find({category:"availability",value:"available",pinned:!1})[0]){var a=o.totalTitles;"number"==typeof a&&isFinite(a)||(a=s.totalTitles||1/0),n.set("link-available",{link:r("spotlight-available"),count:a})}(o=s.find({category:"fulfillable",value:"kindle",pinned:!1})[0])&&o.totalTitles&&n.set("link-kindle",{link:r("spotlight-kindle"),count:o.totalTitles}),i.hasLuckyDayTitles&&n.set("link-skip-the-line",{link:r("everything/skip-the-line"),classes:"filter-button-shamrock",graphic:"shamrock"}),e.become(i.catalog,n)}}.bind(this))}},n._onCatalogSearchInputHeader=function(e){this._updateSuggestions()},n._onCatalogSearchResetHeader=function(e){this._updateSuggestions()},n._onCatalogSearchSubmitHeader=function(e){this.search(e.m.query)},n._updateSuggestions=function(){var e=this.dom.header.getInputText();this._classify(this.dom.root,"has-search-query",!!e),this.dom.suggestions.update(e)},n._library=function(){return this.controller.args.library},s}),define("app/models/items/list-parameters",["require","common","shibui/src/phrasebook"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("shibui/src/phrasebook");return s.MULTI_PARAMS=["subject","language","audience","fulfillable"],s.QUERY_PARAMS=["query","title","identifier","issues"],s.RELATED_PARAMS=["creator","publisher","imprint","series","award"],s.ORED_PARAMS=["formats","audiences","languages","fulfillables"],s.ANDED_PARAMS=["subjects","bisacCodes","invalidities"],s.PLURAL_PARAMS=s.ORED_PARAMS.concat(s.ANDED_PARAMS),s.DEFAULT_SORT={everything:"newlyadded",publisher:"releasedate",imprint:"releasedate",subject:"mostpopular",spotlight:"mostpopular",series:"languageformatreadingorder"},s.$init=function(e,t){APP.services.thunder.freshmaker(this,{ttl:6048e5});var i=t?this._parseAddress(t):{};this.library=e,this.source=i.source||{},this.definition=null,this.refinements=i.refinements||{}},s.freshen=function(e,i){if(this.applyDefinition())this._freshenWithOptions(void 0,e,i);else if("spotlight"==this.source.name)this.library.catalog.guides.use(function(t,s){return t.isIdeal?(this.applyDefinition(),void this._freshenWithOptions(void 0,e,i)):s.reuse()},this);else if(t.among(this.source.name,"generated","curated")){var s=this.library.key();this._freshenWithOptions({url:"libraries/"+s+"/collections/"+this.source.id+"/definition",onFetch:this._parseFreshenResponse.bind(this)},e,i)}else this._freshenWithOptions(void 0,e,i)},s.applyDefinition=function(){if(this.definition)return this.definition;if(t.among(this.source.name,"spotlight","generated","curated")){console.assert(this.library,"[LIST] need library for: %o",this);var e=this.library.catalog.lists.listDefinition(this.source.name,this.source.id);e&&"spotlight"==this.source.name?this._applySpotlightListDefinition(e):e&&this._applyThunderListDefinition(e)}return this.definition},s.composite=function(e,i){i&&delete this._.baseComposite;var s;if(e&&(s=this.overrides(),t.among("all",s)&&(e=!1)),!e&&this._.baseComposite)return this._.baseComposite;var n=t.clone(this.refinements),r={source:{name:this.source.name,id:this.source.id}};if(e){var o={};t.each(APP.patron.pins.filter({scope:"title"}),function(e){var i=e.category;if(!t.among(i,s)){var r=this.PLURAL_PARAMS.indexOf(i+"s")>=0;r?(i+="s",o[i]=o[i]||[],o[i].push(e.value)):"availability"==i&&"available"==e.value?o.flagAvailable=!0:o[i]=e.value,t.isList(n[i])&&(o[i]=o[i].concat(n[i])),delete n[i]}},this),this._applyLayer(o,r)}return this.definition&&((src=this.definition.source)&&(r.source.name=src.name||r.source.name,r.source.id=src.id||r.source.id),this._applyLayer(this.definition.refinements,r)),n&&this._applyLayer(n,r),t.each(this.PLURAL_PARAMS,function(e){r[e]=r[e]||[]}),!e&&this.definition&&this.refinements&&(this._.baseComposite=r),r},s.overrides=function(){return t.unique(t.compact(t.flatten([t.try(this.definition,"refinements.overrides"),t.try(this.refinements,"overrides")])))},s.address=function(){var e=[],i=",",s=this.refinements;"subject"==this.source.name?e.push("subject-"+s.subjects.join(i)):e.push(this.source.name+(this.source.id?"-"+this.source.id:"")),s.scope&&e.push("scope-"+s.scope),s.flagAvailableFirst?e.push("available-first"):s.flagAvailable?e.push("available"):s.flagAvailable===!1?e.push("everything"):s.flagAvailableLuckyDayOnly&&e.push("skip-the-line"),s.flagPrerelease&&e.push("prerelease"),s.flagReadalong&&e.push("readalong");var n=[];if(t.each(s.formats,function(e){n.push(e+"s")}),n.length&&e.push(n.join(i)),t.each(this.QUERY_PARAMS,function(t){var i=s[t];i&&e.push(t+"-"+i)},this),t.each(this.RELATED_PARAMS,function(t){var i=s[t];i&&this.source.name!=t&&"generated"!=this.source.name&&e.push(t+"-"+i)},this),t.each(this.MULTI_PARAMS,function(t){if(t!=this.source.name){var n=s[t.replace(/s?$/,"s")];n&&n.length&&e.push(t+"-"+n.join(i))}},this),s.bisacCodes&&s.bisacCodes.length&&e.push("bisac-"+s.bisacCodes.join(",")),s.days&&e.push("days-"+s.days),t.among("all",s.overrides)?e.push("override"):t.try(s.overrides,"length")&&e.push("override-"+s.overrides.join(",")),s.sort){var r=s.sort;s.seed&&(r+=","+s.seed),e.push("sort-"+r)}return s.maxItems&&e.push("max-"+s.maxItems),s.breakpoint&&e.push("contd-"+s.breakpoint),s.facets&&e.push("facets-"+s.facets),e.join("/")},s.rootAddress=function(){return"search"==this.source.name?"search/query-"+this.refinements.query:this.address().match(/[^\/,]+/)[0]},s.withRefinements=function(e,s){var n=t.try(s,"library")||this.library,r=new i(n,this.address());try{r.applyDefinition()&&(delete r.definition.seed,delete r.definition.breakpoint)}catch(e){delete r.definition}return delete r.refinements.seed,delete r.refinements.breakpoint,t.absorb(e,r.refinements),r},s.reportingContext=function(){var e={listSourceName:this.source.name,listSourceId:this.source.id,listPath:this.library.path(this.address()),clientName:"Dewey",clientVersion:APP.constants.VERSION_NUMBER,environment:APP.constants.ENV};return"search"==this.source.name?e.listSourceId=this.refinements.query:"subject"==this.source&&(e.listSourceId=this.refinements.subjects.join(",")),t.isNullish(e.listSourceId)?t.isNullish(this.source.id)?e.listSourceId=null:e.listSourceId=""+this.source.id:e.listSourceId=""+e.listSourceId,e},s.apiEndpoint=function(e){e=e||{};var i="libraries/"+this.library.key()+"/media",s=[],n=this.composite(!0);if(this._constrainComposite(n),"campaign"==n.source.name&&n.source.id){var r=this.library.key();return"libraries/"+r+"/pages/home/campaigns/"+n.source.id}if("similar"==n.source.name&&n.source.id)return i+="/"+n.source.id+"/recommended?truncateDescription=false";if("issues"==n.source.name&&n.source.id)return t.parameterizeURL(i+"/issues/"+n.source.id,e);if("curated"==n.source.name&&n.source.id&&s.push("collectionId="+n.source.id.replace(/-.*/,"")),n.creator&&n.creator.match(/^\d+$/)?s.push("creatorId="+n.creator):n.creator&&s.push("creator="+n.creator),n.publisher){var o="publisherId",a=n.publisher;n.publisher.match(/^ent-/)&&(o="publisherEntityId",a=n.publisher.replace(/^ent-/,"")),s.push(o+"="+a)}if(n.imprint&&s.push("imprintId="+n.imprint),n.award&&s.push("awards="+n.award),n.series&&n.series==""+parseFloat(n.series)?s.push("seriesId="+n.series):n.series&&s.push("series="+n.series),n.scope){var l={shallow:"owned",deep:"all",auto:"all"};s.push("show="+(l[n.scope]||n.scope))}n.flagAvailableLuckyDayOnly?(s.push("showOnlyLuckyDayAvailable=true"),s.push("excludeNormallyAvailable=true")):n.flagAvailableLuckyDay?s.push("showOnlyLuckyDayAvailable=true"):n.flagAvailable?s.push("showOnlyAvailable=true"):n.flagPrerelease&&s.push("showOnlyPrerelease=true"),n.flagAvailableFirst&&s.push("availableFirst=true"),n.flagReadalong&&s.push("hasAudioSynchronizedText=true"),t.each(this.QUERY_PARAMS,function(e){n[e]&&s.push(e+"="+n[e])}),t.each(n.subjects,function(e){var i=t.flatten([e]);t.excise(i,"0"),s.push("subject="+i.join(","))});var c=[],h=[];t.each(n.languages,function(e){return"string"==typeof e&&(e=e.split(","),1==e.length)?c.push(e):void(e.length&&h.push(e))}),c.length&&h.unshift(c),t.each(h,function(e){t.excise(e,"0"),e.length&&s.push("language="+e.join(","))}),t.each(n.audiences,function(e){s.push("maturityLevel="+e)},this),t.each(n.bisacCodes,function(e){var i=t.flatten([e]);s.push("bisacCode="+i.join(","))},this),n.days&&s.push("addedDate=days-"+n.days);var u=n.sort||this.DEFAULT_SORT[n.source.name];u&&(s.push("sortBy="+u),n.seed&&s.push("seed="+n.seed)),n.maxItems&&s.push("maxItems="+n.maxItems),n.breakpoint&&s.push("breakpoint="+n.breakpoint);var p=[],d=[],m=[];if(t.each(n.formats,function(e){t.each(e.split(","),function(e){var t=APP.constants.mediaTypes(e);t&&p.push(t)})}),t.each(this._thunderFormatsForComposite(n),function(e){var i=t.select(e,function(e){var i=e.replace(/-.*/,"");if(p.length){if(!t.among(i,p))return}else d.push(i);return e},this);i.length&&m.push(i)},this),p.length&&s.push("mediaTypes="+t.unique(p).join(",")),t.each(m,function(e){s.push("format="+e.join(","))}),n.facets){var f;"false"==n.facets?(f=[],s.push("includeFacets=false")):(t.isList(n.facets)?f=n.facets:"string"==typeof n.facets&&(f=n.facets.split(",")),t.each(f,function(e){s.push("includedFacets="+e)})),f&&(t.excise(e,"includeFacets"),t.excise(e,"includedFacets"))}e.includedFacets=t.excise(e,"requiredFacets"),e.truncateDescription=!1;var g=s.length?i+"?"+s.join("&"):i;return g=t.parameterizeURL(g,e)},s._parseAddress=function(e){var i=e.split("/"),s={source:{},refinements:{}};if(["everything","search"].indexOf(i[0])>=0)s.source.name=i.shift();else{var n=i[0].match(/^([^-]+)-(.+)$/);s.source.name=n[1],"subject"!=s.source.name&&(s.source.id=n[2],i.shift(),t.among(s.source.name,"issues","campaign")||(s.refinements[s.source.name]=s.source.id))}return t.each(i,function(e){var t=e.split("-"),i=t.shift(),n=t.join("-");this._parseKeyVal(i,n,s.refinements)},this),"subject"==s.source.name&&(s.source.id=s.refinements.subjects[0]),s},s._parseKeyVal=function(e,i,s){"override"==e?s.overrides=i?i.split(","):["all"]:"scope"==e?s.scope=i:"available"==e&&"first"==i?s.flagAvailableFirst=!0:"available"!=e||i?"everything"!=e||i?"skip"==e&&"the-line"==i?s.flagAvailableLuckyDayOnly=!0:"prerelease"!=e||i?"readalong"!=e||i?e.match(this._formatsRegex())?(s.formats=[],t.each(e.split(","),function(e){e=e.replace(/s$/,""),APP.constants.mediaTypes(e)&&s.formats.push(e)})):"bisac"==e?s.bisacCodes=i.split(","):"days"==e?s.days=i:"sort"==e?(i=i.split(","),s.sort=i.shift(),s.seed=i.shift()):"max"==e?s.maxItems=parseFloat(i):"contd"==e?s.breakpoint=i:"facets"==e?s.facets=i:(t.each(this.MULTI_PARAMS,function(t){e==t&&(s[t.replace(/s?$/,"s")]=i.split(","))}),t.each(this.QUERY_PARAMS,function(t){e==t&&(s[t]=i)}),t.each(this.RELATED_PARAMS,function(t){e==t&&(s[t]=i)})):s.flagReadalong=!0:s.flagPrerelease=!0:s.flagAvailable=!1:s.flagAvailable=!0},s._formatsRegex=function(){var e=[];return t.each(APP.constants.FORMAT_MAPPINGS,function(t,i){e.push(i.plural)}),new RegExp(e.join("|"))},s._freshenWithOptions=function(e,t,i){APP.services.thunder.freshen(this,e,{onSuccess:t.bind(this,this),onFailure:i||APP.services.thunder.onServiceFailure})},s._parseFreshenResponse=function(e){var t=JSON.parse(e),i=this.library.catalog.lists.addListDefinition(this.source.name,t);this._applyThunderListDefinition(i)},s._applyThunderListDefinition=function(e){this.definition={name:e.name,description:e.description};var i=this.definition.refinements={};e.showOnlyAvailable&&(i.flagAvailable=!0),e.sortByAvailability&&(i.flagAvailableFirst=!0),e.showOnlyLuckyDayAvailable&&(i.flagAvailableLuckyDay=!0);var s=e.mediaTypes||[];!s.length&&e.mediaType&&s.push(e.mediaType),s.length&&(i.formats=[],t.each(s,function(e){"string"==typeof e&&(e=e.split(","));var s=[];t.each(e,function(e){var t=APP.constants.formats(e);t&&s.push(t)}),s.length?i.formats=t.unique(t.flatten([i.formats,s])):this._invalidateLayer(i,{reason:"unknown mediatype",key:"formats",value:e.join(",")})},this)),e.maturityLevels&&(i.audiences=e.maturityLevels.slice(0)),e.sortBy&&(i.sort=e.sortBy),e.seed&&(i.seed=e.seed),e.subjects&&(i.subjects=t.select(e.subjects,function(e){return e.split(",")})),e.publisherId?i.publisher=e.publisherId:e.publisherEntityId&&(i.publisher="ent-"+e.publisherEntityId),e.language&&(i.languages=[e.language]),e.bisacCodes&&e.bisacCodes.length&&(i.bisacCodes=t.select(e.bisacCodes,function(e){return e.split(",")})),e.maxItems&&(i.maxItems=e.maxItems)},s._applySpotlightListDefinition=function(e){if(this.definition=this._parseAddress(e.address),e.i18n){var t=this.composite(),i=1==t.formats.length?t.formats[0]:void 0;e.i18n.head&&(this.definition.name=n.text(e.i18n.head,{FORMAT:i},{okIfMissing:!0})),e.i18n.lede&&(this.definition.description=n.text(e.i18n.lede,{FORMAT:i},{okIfMissing:!0}))}this.definition.name=this.definition.name||e.head,this.definition.description=this.definition.description||e.lede},s._applyLayer=function(e,i){t.each(e,function(e,s){var n=i[e];if(e.match(/^flagAvailable/)||"sort"==e||"maxItems"==e)i[e]=s;else if(t.isNullish(n))i[e]=t.isList(s)?Array.prototype.slice.call(s,0):s;else if(t.isList(n)){if(!s.length)return;if(n.length&&"languages"==e)i[e]=t.isList(n[0])?n:[n],i[e].push(t.isList(s)?s:[s]);else if(n.length&&t.among(e,this.ORED_PARAMS)){var r=this._overlappingValues(n,s);r.length?i[e]=r:this._invalidateLayer(i,{reason:"no overlap",key:e,existing:n,value:s})}else t.each(s,function(e){for(var t=0,i=n.length;t<i;++t)if(""+n[t]==""+e)return;n.push(e)})}else n!==s&&this._invalidateLayer(i,{reason:"existing value",key:e,existing:n,value:s})},this)},s._overlappingValues=function(e,i){var s=[];return t.each(e,function(e){t.each(i,function(t){""+e==""+t&&s.push(e)})}),s},s._invalidateLayer=function(e,t){e.invalidities=e.invalidities||[],e.invalidities.push(t)},s._constrainComposite=function(e){var i=!0;t.each(this.library.cards(),function(e){i=e.canPlaceHolds||e.isExpired(),i&&t.breakIteration()}),i||(e.flagAvailable=!0)},s._thunderFormatsForComposite=function(e){var i={default:[APP.constants.discoverableFulfillmentSubtypes()],bifocal:[["ebook-overdrive","audiobook-overdrive","magazine-overdrive","ebook-overdrive-provisional","audiobook-overdrive-provisional"]],kindle:[["ebook-overdrive","ebook-overdrive-provisional"],["ebook-kindle"]],epub:[["ebook-overdrive","ebook-overdrive-provisional"],["ebook-epub-adobe","ebook-epub-open"]],pdf:[["ebook-overdrive","ebook-overdrive-provisional"],["ebook-pdf-adobe","ebook-pdf-open"]],brightcove:[["video-streaming"]],"media-do":[["ebook-media-do"]]},s=[[],[]];return t.each(e.fulfillables,function(e){var n=i[e];n?(n[1]=n[1]||n[0],t.each(n,function(e,i){t.each(e,function(e){t.among(e,s[i])||s[i].push(e)})})):t.each(i,function(i,n){t.among(e,n[1])&&(s[0]=t.unique(s[0].concat(n[0])),t.last(s).push(e),t.breakIteration())})},this),s[0].length||(s[0]=i.default[0],s[1]=[]),s},i}),define("app/views/components/library/app-header-dismissive",["require","common","app/views/core/partial","app/views/core/crumbs"],function(e){var t=(e("common"),e("app/views/core/partial")),i=t.new(),s=i.prototype,n=e("app/views/core/crumbs");return s.focus=function(){this.dom.crumbs.focus()},s._layout=function(e){this.dom=this._build("app-header-dismissive .app-header .halos-anchor <header>"," pillar .bumper-n .bumper-e .bumper-w","  crumbs",n)},i}),define("app/models/agents/usage",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.RETRY_MS=1e3,s.$init=function(e,t){this._.stackTasks=[],this._.queueTasks=[],this._.staleTasks=[],this.owner=e,this._.ownerImport=this.owner.import,this.owner.import=this._import.bind(this),this.owner.use=this._use.bind(this),this.owner.reuse=this._reuse.bind(this),this.owner.reset=this.reset.bind(this),t.instance||(t.instance=new t),this.agent=t.instance,this.reset(),this.check()},s.reset=function(){this.state={integrity:"incomplete",life:1,work:"idle",failures:0,freshHorizon:APP.freshHorizon}},s.check=function(){var e=this._ttl();if(this.state.freshHorizon!=APP.freshHorizon)this.reset();else if(isFinite(e)){var i=this._.fetchedAt||0,s=i+e,n=t.epochMilliseconds();this.state.life=Math.max(0,Math.min(1,(s-n)/e)),!this._.staleTimer&&s>n&&(this._.staleTimer=setTimeout(this._onStale.bind(this),s-n+1e3))}else this.state.life=1;return this.state.isBusy=["fetching","waiting"].indexOf(this.state.work)>=0,this.state.isBroken=["failed"].indexOf(this.state.work)>=0,this.state.isIdeal="complete"==this.state.integrity&&this.state.life>0,this.state},s.freeze=function(){this.state.work="frozen"},s.unfreeze=function(){"frozen"==this.state.work&&(this.state.work="idle")},s.markAsFetched=function(e){this._.fetchedAt=t.epochMilliseconds(),"complete"!=this.state.integrity&&(this.state.integrity=e||"complete")},s._import=function(e,i){i=t.absorb(i,{source:"internal",integrity:"complete"}),e&&"function"==typeof this._.ownerImport?this._.ownerImport.call(this.owner,e,i):("internal"!=i.source&&"function"==typeof this.owner._transformAttributes&&(e=this.owner._transformAttributes(e,i)),"function"==typeof this.owner._deserializeAttributes?this.owner._deserializeAttributes(e,i):t.each(e,function(e,t){this.owner[e]=t},this)),"complete"!=this.state.integrity&&(this.state.integrity=i.integrity)},s._use=function(e,t){if("frozen"!=this.state.work){this.check();var i={callback:e,thisArg:t,route:APP.router.route,updateRequested:!1};this._executeTask(i),i.updateRequested||this._addStaleTask(i)}},s._reuse=function(e,i){if("frozen"!=this.state.work){var s=t.last(this._.stackTasks);s&&(s.updateRequested=!0,"function"==typeof e&&(s.callback=e,s.thisArg=i),this.state.isIdeal||"failed"==this.state.work||(this.state.work=APP.network.reachable?"fetching":"waiting",this.check()),this._enqueueWork(s))}},s._enqueueWork=function(e){if(!this.check().isIdeal){var t=this._.queueTasks.length;if("function"==typeof e.callback&&(this._.queueTasks.push(e),this._.exitRouteHandler=this._.exitRouteHandler||APP.events.on("router:exit",this._onExitRoute.bind(this))),!t){var i=this.state.failures*this.state.failures*this.RETRY_MS;clearTimeout(this._.enqueueTimer),this._.enqueueTimer=setTimeout(this._enqueueNow.bind(this),i)}}},s._enqueueNow=function(){var e=APP.network.reachable?"fetching":"waiting";this.state.work!=e&&(this.state.work=e,this._executeTasks(this._.queueTasks)),"fetching"==e?(APP.events.off(this._.networkHandler),delete this._.networkHandler,this.agent.enqueue(this.owner,this._onWorkDone.bind(this))):this._.networkHandler||(this._.networkHandler=APP.events.on("network:info",this._onNetworkInfo.bind(this)))},s._addStaleTask=function(e){var t=this.agent.TTL||1/0;if(isFinite(t)){for(var i=0,s=this._.staleTasks.length;i<s;++i)if(this._.staleTasks[i].callback==e.callback)return;this._.staleTasks.push(e)}},s._executeTasks=function(e){this.check(),t.each(e.splice(0),this._executeTask,this)},s._executeTask=function(e){this._.stackTasks.push(e),e.thisArg?e.callback.call(e.thisArg,this.state,this.owner):e.callback(this.state,this.owner),this._.stackTasks.pop()},s._onWorkDone=function(e,t){"success"==t?(this.state.work="idle",this.state.freshHorizon=APP.freshHorizon,this.state.failures=0,this.markAsFetched(this.state.integrity),clearTimeout(this._.staleTimer),delete this._.staleTimer):(this.state.work="failed",this.state.failures+=1),this._executeTasks(this._.queueTasks),this._maybeDeafenHandlers()},s._onNetworkInfo=function(e){APP.events.off(this._.networkHandler),delete this._.networkHandler,"waiting"==this.state.work&&(clearTimeout(this._.enqueueTimer),this._.enqueueTimer=setTimeout(this._enqueueNow.bind(this),0))},s._onStale=function(){this._.staleTasks.length>20||this._executeTasks(this._.staleTasks)},s._onExitRoute=function(e){var i=function(i){try{var s=[];return t.each(i,function(t){t.route!=e.m.route&&s.push(t)}),s}catch(e){return APP.events.dispatch("investigate:record",{what:"error weeding tasks",where:"Usage#_onExitRoute",why:"INV-DEWEY-1692",taskCount:i.length,error:e}),[]}};this._.queueTasks=i(this._.queueTasks),this._.staleTasks=i(this._.staleTasks),this._maybeDeafenHandlers()},s._maybeDeafenHandlers=function(){this._.queueTasks.length||this._.staleTasks.length||(APP.events.off(this._.exitRouteHandler),delete this._.exitRouteHandler),!this._.queueTasks.length&&this._.networkHandler&&(APP.events.off(this._.networkHandler),delete this._.networkHandler)},s._ttl=function(){var e;return"function"==typeof this.owner._usageTTL&&(e=this.owner._usageTTL()),"number"==typeof e?e:"number"==typeof this.agent.TTL?this.agent.TTL:1/0},i}),define("app/models/agents/usage-agent",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.TTL=1/0,s.MAX_BATCH_SIZE=1,s.BATCHING_MS=1,s.$init=function(){this._.queue=[]},s.enqueue=function(e,t){for(var i=0,s=this._.queue.length;i<s;++i)if(this._.queue[i].item==e)return void this._.queue[i].callbacks.push(t);this._.queue.push({item:e,callbacks:[t]}),clearTimeout(this._.batchingTimer),this.BATCHING_MS?this._.batchingTimer=setTimeout(this._processQueue.bind(this),this.BATCHING_MS):this._processQueue()},s._processQueue=function(){for(;this._.queue.length;){var e={};e.queue=this._.queue.splice(0,this.MAX_BATCH_SIZE),this._processBatch(e)}},s._processBatch=function(e){},s._onRequestSuccess=function(e,i,s){if(1==this.MAX_BATCH_SIZE){t.excise(e.requests,s);var n=e.queue[0];this._importTask(n,JSON.parse(i)),e.requests.length||this._succeedTask(n)}else APP.journal.warn("[USAGE-AGENT] How do I process a multi-item batch?",e)},s._onRequestFailure=function(e){t.each(e.queue,this._failTask.bind(this))},s._importTask=function(e,t,i){i=i||{source:"external",integrity:"complete"},e.item.import(t,i)},s._succeedTask=function(e){e.hasFailed||t.each(e.callbacks,function(t){t(e.item,"success")})},s._failTask=function(e){e.hasFailed||(e.hasFailed=!0,t.each(e.callbacks,function(t){t(e.item,"failure")}))},i}),define("app/models/agents/title-agent",["require","common","./usage-agent"],function(e){var t=e("common"),i=e("./usage-agent"),s=i.new(),n=s.prototype;return n.TTL=864e5,n.MAX_BATCH_SIZE=24,n.BATCHING_MS=100,n._processBatch=function(e){var i=[];t.each(e.queue,function(e){i.push(e.item.titleId)});var s=APP.services.thunder.fetch("media/bulk?titleIds="+i.join(","),this._onRequestSuccess.bind(this,e),this._onRequestFailure.bind(this,e));e.requests=[s]},n._onRequestSuccess=function(e,i,s){var n={items:JSON.parse(i)};t.each(n.items,function(i){t.each(e.queue,function(e){e.item.titleId+""==i.id+""&&(this._importTask(e,i),this._succeedTask(e))},this)},this)},s}),define("app/models/agents/taggable-agent",["require","common","./usage-agent"],function(e){var t=e("common"),i=e("./usage-agent"),s=i.new(),n=s.prototype;return n.TTL=36e5,n.MAX_BATCH_SIZE=48,n.BATCHING_MS=100,n._processBatch=function(e){var i=[];t.each(e.queue,function(e){i.push(e.item.taggable.titleId)}),APP.patron.tags.use(function(t,s){if(!t.isIdeal&&!t.isBroken)return s.reuse();var n=APP.services.vandal.taggingsForTitles(i,this._onRequestSuccess.bind(this,e),this._onRequestFailure.bind(this,e));e.requests=[n]},this)},n._onRequestSuccess=function(e,i,s){var n={};t.each(e.queue,function(e){n[e.item.taggable.titleId]={task:e}},this);var r={source:"internal",integrity:"complete"};t.each(t.clone(i),function(e,i){var s=n[e];s&&(s.attrs={all:[],taggings:[]},t.each(i,function(e){var i=t.excise(e,"tagUUID"),n=t.excise(e,"tagName"),o=t.element({html:n}).innerText,a=APP.patron.tags.find({uuid:i});a=a||APP.patron.tags.find({name:n}),a=a||APP.patron.tags.find({name:o}),a||APP.patron.tags.loadingLock(function(e){a=e.importAll([{name:o,uuid:i}],r)[0]}),a.loadingLock(function(){var t=a.produce({"title.titleId":e.titleId});t.import(e,r),s.attrs.all.push(a),s.attrs.taggings.push(t)}.bind(this))},this),this._importTask(s.task,s.attrs,r),this._succeedTask(s.task))},this)},s}),define("app/models/agents/activity-agent",["require","common","./usage-agent"],function(e){var t=e("common"),i=e("./usage-agent"),s=i.new(),n=s.prototype;return n.TTL=36e5,n.MAX_BATCH_SIZE=48,n.BATCHING_MS=100,n._processBatch=function(e){t.each(e.queue,function(e){e.item.all=e.item.all||[]}),this._tempFetchActs(e)},n._tempFetchActs=function(e){var i={};t.each(e.queue,function(e){i[e.item.actable.titleId]={task:e}}),t.each(APP.patron.activities.visible(),function(e){var s=i[t.try(e.title,"titleId")];s&&(s.attrs=s.attrs||{all:[]},s.attrs.all.push(e))}),t.each(e.queue,function(e){this._importTask(e,i[e.item.actable.titleId].attrs),this._succeedTask(e)},this)},s}),define("text!res/data/review-sources.json",[],function(){
return'[{\n  "name": "Publisher’s Weekly",\n  "about": "Trade reviews for publishers, librarians, booksellers, and agents.",\n  "logo": { "href": "https://images.overdrive.com/misc/libby/review-source-publishers-weekly.png" },\n  "website": {\n    "label": "publishersweekly.com",\n    "href": "https://www.publishersweekly.com"\n  },\n  "hasPremiumReviews": true,\n  "aliases": [\n    "Publisher’s Weekly",\n    "Publisher\'s Weekly",\n    "Publishers Weekly"\n  ]\n},{\n  "name": "Kirkus Reviews",\n  "about": "Pre-release reviews of fiction, non-fiction, children\'s literature.",\n  "logo": { "href": "https://images.overdrive.com/misc/libby/review-source-kirkus-reviews.png" },\n  "website": {\n    "label": "kirkusreviews.com",\n    "href": "https://www.kirkusreviews.com"\n  },\n  "hasPremiumReviews": true,\n  "aliases": [\n    "Kirkus Reviews",\n    "Kirkus"\n  ]\n}, {\n  "name": "Booklist",\n  "about": "The book review journal of the American Library Association.",\n  "logo": { "href": "https://images.overdrive.com/misc/libby/review-source-booklist.png" },\n  "website": {\n    "label": "booklistonline.com",\n    "href": "https://www.booklistonline.com"\n  },\n  "hasPremiumReviews": true,\n  "aliases": [\n    "Booklist",\n    "Booklist Online",\n    "Booklist On-line"\n  ]\n}, {\n  "name": "Library Journal",\n  "about": "Hundreds of pre-publication reviews for librarians every month.",\n  "logo": { "href": "https://images.overdrive.com/misc/libby/review-source-library-journal.png" },\n  "website": {\n    "label": "libraryjournal.com",\n    "href": "https://www.libraryjournal.com"\n  },\n  "hasPremiumReviews": true,\n  "aliases": [\n    "Library Journal",\n    "LJ"\n  ]\n}, {\n  "name": "School Library Journal",\n  "about": "Juvenile and young adult book reviews for school librarians.",\n  "logo": { "href": "https://images.overdrive.com/misc/libby/review-source-school-library-journal.png" },\n  "website": {\n    "label": "slj.com",\n    "href": "https://www.slj.com"\n  },\n  "hasPremiumReviews": true,\n  "aliases": [\n    "School Library Journal",\n    "SLJ"\n  ]\n}, {\n  "name": "DOGObooks",\n  "about": "Comments and insights on popular titles, from real kids.",\n  "logo": { "href": "https://images.overdrive.com/misc/libby/review-source-dogobooks.png" },\n  "website": {\n    "label": "dogobooks.com",\n    "href": "https://www.dogobooks.com"\n  },\n  "hasPremiumReviews": true,\n  "aliases": [\n    "DOGObooks",\n    "DOGO Books",\n    "DOGO"\n  ]\n}, {\n  "name": "AudioFile Magazine",\n  "about": "Weekly reviews of audiobooks.",\n  "logo": { "href": "https://images.overdrive.com/misc/libby/review-source-audiofile-magazine.png" },\n  "website": {\n    "label": "audiofilemagazine.com",\n    "href": "https://audiofilemagazine.com"\n  },\n  "hasPremiumReviews": true,\n  "aliases": [\n    "AudioFile",\n    "AudioFile magazine",\n    "AudioFile Magazine"\n  ]\n}, {\n  "name": "New York Times",\n  "about": "Excerpts from articles in the Book Review section.",\n  "logo": { "href": "https://images.overdrive.com/misc/libby/review-source-nytrb.png" },\n  "website": {\n    "label": "nytimes.com/books",\n    "href": "https://www.nytimes.com/section/books/review"\n  },\n  "aliases": [\n    "New York Times",\n    "The New York Times",\n    "New York Times Book Review",\n    "The New York Times Book Review",\n    "JANET MASLIN, The New York Times",\n    "Michiko Kakutani, The New York Times"\n  ]\n}, {\n  "name": "Wall Street Journal",\n  "aliases": [\n    "Wall Street Journal",\n    "The Wall Street Journal"\n  ]\n}, {\n  "name": "Washington Post",\n  "logo": { "href": "https://images.overdrive.com/misc/libby/review-source-wapo.png" },\n  "website": {\n    "label": "washingtonpost.com",\n    "href": "https://www.washingtonpost.com/entertainment/books"\n  },\n  "aliases": [\n    "Washington Post",\n    "The Washington Post"\n  ]\n}, {\n  "name": "Boston Globe",\n  "aliases": [\n    "Boston Globe",\n    "The Boston Globe"\n  ]\n}, {\n  "name": "Time Magazine",\n  "aliases": [\n    "TIME",\n    "Time Magazine",\n    "Time magazine"\n  ]\n}, {\n  "name": "Entertainment Weekly",\n  "aliases": [\n    "Entertainment Weekly"\n  ]\n}, {\n  "name": "USA Today",\n  "aliases": [\n    "USA Today"\n  ]\n}, {\n  "name": "Los Angeles Times",\n  "aliases": [\n    "Los Angeles Times"\n  ]\n}, {\n  "name": "People Magazine",\n  "aliases": [\n    "People",\n    "People Magazine"\n  ]\n}, {\n  "name": "Chicago Sun-Times",\n  "aliases": [\n    "Chicago Sun-Times"\n  ]\n}, {\n  "XXX TODO XXX": [\n    "Chicago Tribune",\n    "San Francisco Chronicle",\n    "Newsweek",\n    "Associated Press",\n    "Cleveland Plain Dealer",\n    "Esquire",\n    "The Seattle Times",\n    "The New Yorker",\n    "Romantic Times",\n    "Dallas Morning News",\n    "The Washington Post Book World",\n    "The Denver Post",\n    "Houston Chronicle",\n    "Newsday",\n    "The Economist",\n    "Rocky Mountain News",\n    "The Times (London)",\n    "Miami Herald",\n    "New York Daily News"\n  ]\n}]\n'}),define("rinser/src/blurb-rinser",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.rinse=function(e,i){if(!e)return"<hr />";i=i||{};var s={lowercase:/[a-z]/g,uppercase:/[A-Z]/g,spacedEllipsis:/\s?\.\s?\.\s?\.(\s|$)/g,quoted:/^\s*["“](.+?)["”](.+)/,apostrophe:/(\w)'(\w)/g,singleStraightQuotes:/'([^']*)'/g,doubleStraightQuotes:/"([^"]*)"/g,dashes:/\s*(—|--)\s*/g,whitespace:/\s+/g},n=document.createElement("div"),r=document.createElement("div");n.innerHTML=e;var o,a,l=function(e,i){return t.element({tag:e,parentNode:i||r})},c=function(){t.try(o,"innerHTML")&&(o=null)},h=function(e){return!!i.isEnglish&&(!(!e||e.length<=4)&&(e=e.substring(0,50),(e.match(s.lowercase)||[]).length<(e.match(s.uppercase)||[]).length))};t.walk(n.firstChild,function(e){e.nodeType==Node.ELEMENT_NODE?"P"==e.tagName||"DIV"==e.tagName?c():"BR"==e.tagName?c():"LI"==e.tagName?o&&(o.innerHTML.indexOf("•")>=0||h(o.innerHTML))?o.innerHTML+=" • ":e.innerHTML.indexOf("•")>=0?c():(r.lastChild&&"UL"==r.lastChild.tagName||l("UL"),o=l("LI",r.lastChild)):["Q","BLOCKQUOTE","CITE"].indexOf(e.tagName)>0&&(o=o||l("P"),o=l(e.tagName,o),a=e):e.nodeType==Node.TEXT_NODE&&(a&&!a.contains(e)&&(o=o.parentNode,a=null),(o||e.nodeValue.trim())&&(o=o||l("P"),o.innerHTML+=e.nodeValue))});var u,p=0;return t.walk(r.firstChild,function(e){if(e.nodeType==Node.TEXT_NODE){var n=e.parentNode,r=e.nodeValue.replace(s.spacedEllipsis,"… ").replace(s.apostrophe,"$1’$2").replace(s.singleStraightQuotes,"‘$1’").replace(s.doubleStraightQuotes,"“$1”").replace(s.dashes," — ").replace(s.whitespace," ");(u=h(r))&&(r='<span class="is-mostly-caps">'+r+"</span>"),r=r.replace(s.quoted,"<q>$1</q>$2"),"CITE"!=n.tagName&&i.title&&(r=r.replace(new RegExp(t.regExpEscape(i.title),"g"),"<cite>"+(i.titleHTML||i.title)+"</cite>")),"magazine"==i.titleFormat&&"P"==n.tagName&&(i.isEnglish&&r.match(/subscri[bp]/)?r="":r.length<32&&!r.match(/[\.\!\?\']$/)?n.classList.add("rinse-head"):++p>5&&u&&(r="")),r=r.replace(/At the Publisher.*\(DRM\) applied./,"");for(var o=[];n.lastChild!=e;)o.push(n.lastChild),n.removeChild(n.lastChild);for(n.removeChild(e),n.innerHTML+=r;o.length;)n.appendChild(o.pop());n.innerHTML||n.parentNode.removeChild(n)}}),r.querySelectorAll("p:not(.rinse-head)").length>2&&t.each(r.querySelectorAll("p.rinse-head"),function(e){e.parentNode.removeChild(e)}),r.innerHTML||"<hr />"},i}),define("rinser/rinser",["require","./src/blurb-rinser"],function(e){var t={Blurb:e("./src/blurb-rinser")};return t}),define("rinser",["rinser/rinser"],function(e){return e}),define("app/models/agents/title-blurb-agent",["require","common","./usage-agent"],function(e){var t=e("common"),i=e("./usage-agent"),s=i.new(),n=s.prototype;return n.TTL=6048e5,n._processBatch=function(e){var t=e.queue[0].item;t.title.use(this._onTitleUsed.bind(this,e))},n._onTitleUsed=function(e,i,s){if("failed"==i.work)return this._onRequestFailure(e);if(!i.isIdeal)return s.reuse(this._onTitleUsed.bind(this,e));if("magazine"!=s.format){var n=APP.services.thunder.fetch("media/"+s.titleId+"/reviews?premiumOnly=false",this._onRequestSuccess.bind(this,e),this._onRequestFailure.bind(this,e));e.requests=[n]}else t.each(e.queue,function(e){this._succeedTask(e)},this)},n._onRequestSuccess=function(e,i,s){t.excise(e.requests,s);var n=e.queue[0];this._importTask(n,{reviews:JSON.parse(i).items}),e.requests.length||this._succeedTask(n)},s}),define("app/models/items/title-blurb",["require","common","text!res/data/review-sources.json","rinser","app/models/agents/usage","app/models/agents/title-blurb-agent"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;s.REVIEW_SOURCES=JSON.parse(e("text!res/data/review-sources.json"));var n=e("rinser"),r=e("app/models/agents/usage"),o=e("app/models/agents/title-blurb-agent");return s.$init=function(e){this.usage=new r(this,o),this.title=e,this._.memos={}},s.description=function(){if(this._.memos.description)return this._.memos.description;try{return this._.memos.description=this._rinseHTML(this._.description)}catch(e){return this._.description}},s.excerpt=function(e){var i="excerpt-"+e;if(this._.memos[i])return this._.memos[i];var s=[],n=[],r=0,o=t.element({html:this.description()});t.each(o.querySelectorAll("p"),function(i){var o=i.innerText.trim();o.match(/[\.\!\?\'\"’”:,]$/)||(o+="."),n.push(o),i.classList.contains("rinse-head")||i.innerHTML.match("is-mostly-caps")||(s.push(o),r+=o.length,r>=e&&t.breakIteration())});var a=(r>=e?s:n).join("\n");return a.length>e&&(a=a.slice(0,e-1)+"…"),this._.memos[i]=a},s._transformAttributes=function(e,i){var s={};if(e.fullDescription)s.description=e.fullDescription;else if(e.description){var n=e.description.length,r=this._.description?this._.description.length:0;n>r&&(s.description=e.description)}return e.awards&&(s.awards=e.awards),e.reviews&&(s.reviews=[],t.each(e.reviews,function(e){e&&s.reviews.push(this._parseReviewAttributes(e))},this)),s},s._deserializeAttributes=function(e,i){this._.memos={},this._.description=t.excise(e,"description")||this._.description,t.each(e,function(e,t){this[e]=t},this)},s._rinseHTML=function(e){var i={title:this.title.title,titleHTML:this.title.titleWithoutOrphans(),titleFormat:this.title.format,isEnglish:!1};return t.each(this.title.languages,function(e){e.id.match(/^en/)&&(i.isEnglish=!0)}),(new n.Blurb).rinse(e,i)},s._parseReviewAttributes=function(e){var i={lines:[],publicationDate:null,copyright:{},source:{},isPremiumReview:e.isPremium,isStarredReview:!1,_:{raw:e}},s=t.element({html:e.source}),n=t.element({html:e.content});if(t.each(n.querySelectorAll("p"),function(e,s){var n=e.innerText.match(/copyright[\s\(]+(\d+)[\s\)]+(.+)/i);if(n)return i.copyright.year=parseFloat(n[1]),i.copyright.attribution=n[2].replace(/[,\.\s]*used with permission\.?/i,""),void(i.copyright.attribution!=n[2]?i.copyright.rights="Used with permission.":(i.copyright.attribution=n[2].replace(/[,\.\s]*all rights reserved\.?/i,""),i.copyright.attribution!=n[2]&&(i.copyright.rights="All rights reserved.")));var r=t.try(e.firstChild,"innerText")||t.try(e.firstChild,"nodeValue");if(r&&r.trim()){var o=r.trim().replace(/^star\w* review from\s*/i,"");o!=r?(i.isStarredReview=!0,r=o):r=r.trim();var a=new Date(r);a&&isFinite(a)&&(i.publicationDate=a,e.removeChild(e.firstChild))}t.each(e.querySelectorAll("br:first-child"),function(e){e.parentNode.removeChild(e)}),e.innerText.trim()&&i.lines.push(i.isPremiumReview?e.innerHTML.trim():e.innerText.trim())},this),i.lines.length||i.lines.push(i.isPremiumReview?n.innerHTML.trim():n.innerText.trim()),t.each(i.lines,function(e,t){var s=e.match(/(?:�|©|\(c\)) AudioFile\s?(\d+)?[,\.\s]+([^\.$]*)/i);s&&(s[1]&&(i.copyright.year=parseFloat(s[1])),i.copyright.attribution="AudioFile",i.copyright.rights=s[2]+".",i.lines[t]=e.replace(s[0],""))},this),1==i.lines.length){var r=i.lines[0].replace(/[\.\!\?]([A-Z\“\(][^\.])/g,".<br>$1");i.lines=r.split("<br>")}var o=s.querySelector("strong"),a=t.try(o,"innerText");return a&&(i.source.name=a.replace(/[,\s\(]+star.*review[\s\)\.]*/i,""),i.source.name!=a&&(i.isStarredReview=!0,o.parentNode.removeChild(o))),!i.source.name&&(o=s.querySelector("[alt]"))&&(i.source.name=o.getAttribute("alt")),i.source.name||(i.source.name=s.innerText.trim()),i.source.name&&(a=i.source.name,i.source.name=i.source.name.replace(/[,;]+.*/,"").trim(),i.source.name!=a&&(i.source.about=a.replace(/[^,;]+[,;]+\s*/,"").trim())),i.source.name&&t.each(this.REVIEW_SOURCES,function(e){t.among(i.source.name,e.aliases)&&(t.absorb(e,i.source),delete i.source.aliases,t.breakIteration())}),i},i}),define("app/models/agents/title-holding-agent",["require","common","./usage-agent"],function(e){var t=e("common"),i=e("./usage-agent"),s=i.new(),n=s.prototype;return n.TTL=18e5,n.MAX_BATCH_SIZE=99,n.BATCHING_MS=1e3,n._processQueue=function(){var e={};this._queue=t.select(this._.queue,function(t){if(t.item.possession)return void this._succeedTask(t);var i=t.item.libraryKey;return e[i]=e[i]||[],e[i].push(t),t},this),this._.queue=[],t.each(e,function(e,t){for(;t.length;){var i={key:e,queue:t.splice(0,this.MAX_BATCH_SIZE)};this._processBatch(i)}},this)},n._processBatch=function(e){if(!e.key||"undefined"==e.key)return this._onRequestFailure(e);var i=[];t.each(e.queue,function(e){e.titleId=e.item.collation.title.titleId+"",i.push(e.titleId)});var s=APP.services.thunder.fetch({url:"libraries/"+e.key+"/media/availability",method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ids:i})},this._onRequestSuccess.bind(this,e),this._onRequestFailure.bind(this,e));e.requests=[s]},n._onRequestSuccess=function(e,i){var s=JSON.parse(i),n={};t.each(s.items,function(e){e&&(n[e.id]=e)}),t.each(e.queue,function(e){this._importTask(e,n[e.titleId]||{ownedCopies:0,availableCopies:0,isHoldable:!1}),this._succeedTask(e)},this)},s}),define("app/models/items/title-holding",["require","common","./item","app/models/agents/usage","app/models/agents/title-holding-agent"],function(e){var t=e("common"),i=e("./item"),s=i.new(),n=s.prototype,r=e("app/models/agents/usage"),o=e("app/models/agents/title-holding-agent");return n.MAX_ESTIMATE=182.5,n.$init=function(){this.usage=new r(this,o)},n.estimatedWaitInDays=function(){if(this.copiesOwned<1)return 1/0;if("number"==typeof this._.estimatedWaitDays)return this._.estimatedWaitDays;var e=14,t=this.position?this.position:(this.holdsCount||0)+1,i=t/this.copiesOwned;return Math.round(i*e)},n.estimatedWaitInWords=function(e){var t=Math.max(1,this.estimatedWaitInDays()),i={label:"wait-list."+(e||"short")+".estimate."};return isFinite(t)?t>this.MAX_ESTIMATE?i.label+="max":t<=7?i.label+="soon":(i.label+="weeks",i.substitutions={WEEKS:Math.ceil(t/7)}):i.label+="unknown",i},n.acquiredCopies=function(){return"number"==typeof this.originalCopiesOwned?Math.max(0,this.copiesOwned-this.originalCopiesOwned):0},n.roundsAhead=function(){return this.copiesOwned&&this.position?Math.floor((this.position-1)/this.copiesOwned):0},n.roundsBehind=function(){if(this.copiesOwned){if(this.position){var e=Math.ceil(this.position/this.copiesOwned)*this.copiesOwned,t=Math.max(0,this.holdsCount-e);return Math.round(t/this.copiesOwned)}return Math.round(this.holdsCount/this.copiesOwned)}return 1/0},n.isProbablyAllowedToHold=function(){if(!this.isHoldable)return!1;var e=this._exactCards();if(!e.length)return!0;for(var t=0;t<e.length;++t)if(e[t].canPlaceHolds)return!0;return!1},n.hasPeopleWaiting=function(){return!this.copiesAvailable&&this.holdsCount>0},n.numberOfHoldsByOthers=function(){var e=Math.max(0,this.holdsCount-(this._hold()?1:0));return Math.max(0,e-this.copiesAvailable)},n.isOnlyAvailableAsLuckyDayLoan=function(){return!t.try(this._hold(),"isAvailable")&&("undefined"!=typeof this.copiesAvailable&&"undefined"!=typeof this.luckyDayCopiesAvailable||this.reuse(),!(0!=this.copiesAvailable||!this.luckyDayCopiesAvailable))},n.circActionScore=function(e){var t=this.usage.state||{},i=t.life>0&&t.isIdeal,s={score:1,action:"unowned",holding:this,status:i?"complete":t.isBroken?"failed":"scanning"};return this.isOnlyAvailableAsLuckyDayLoan()?(s.action="lucky-day",s.score=999):this.isAvailable?(s.action="borrow",s.score=1e3,e?s.score+=6e3:(s.score+=Math.min(5e3,10*(this.copiesAvailable||0)),s.score+=Math.min(500,this.copiesOwned||0))):this.isProbablyAllowedToHold()&&(s.action="hold",s.score=100,s.score+=365-Math.min(this._.estimatedWaitDays||365,365)),e&&(s.score+=1),s},n._transformAttributes=function(e,i){var s={};if(e.id&&(s.titleId=e.id),"number"==typeof e.ownedCopies&&(s.copiesOwned=e.ownedCopies,s.isOwned=!!s.copiesOwned),"number"==typeof e.availableCopies&&(s.copiesAvailable=e.availableCopies,s.isAvailable=!!s.copiesAvailable),"boolean"==typeof e.isOwned&&(s.isOwned=e.isOwned),"boolean"==typeof e.isAvailable&&(this.position&&!e.position?s.isAvailable=(this._hold()||e).isAvailable:s.isAvailable=e.isAvailable),"number"==typeof e.luckyDayOwnedCopies&&(s.luckyDayCopiesOwned=e.luckyDayOwnedCopies,s.isOwned=s.isOwned||!!s.luckyDayCopiesOwned),"number"==typeof e.luckyDayAvailableCopies&&(s.luckyDayCopiesAvailable=e.luckyDayAvailableCopies),e.isOwned&&"always"==e.availabilityType?(s.copiesAvailable=s.copiesOwned=1/0,s.luckyDayCopiesAvailable=s.luckyDayCopiesAvailable||0,s.isOwned=!0,s.isAvailable=!0,s.isHoldable=!1,s.holdsCount=0):s.isOwned===!1?(s.isAvailable=!1,s.copiesOwned=0,s.copiesAvailable=0):s.isAvailable===!1&&(s.copiesAvailable=0),"boolean"==typeof e.isPreReleaseTitle&&(s.isPrerelease=e.isPreReleaseTitle),"number"==typeof e.holdsCount&&(s.holdsCount=e.holdsCount),"number"==typeof e.holdListPosition&&(s.position=e.holdListPosition),"boolean"==typeof e.isHoldable?s.isHoldable=e.isHoldable:"number"==typeof s.holdsCount&&(s.isHoldable=!0),s.isFastlane=!!e.isFastlane,s.isAvailable?s.estimatedWaitDays=0:"number"!=typeof e.estimatedWaitDays||"number"!=typeof s.position&&"number"==typeof this.position||(s.estimatedWaitDays=e.estimatedWaitDays),e.formats&&t.try(this.collation,"title.fulfillers")){var n=this.collation.title,r=this._library();n&&r&&n.fulfiller(r).import(t.absorb(e,{}),{source:"external",integrity:"complete"})}return s},n._deserializeAttributes=function(e,s){e.holdsCount&&e.copiesOwned&&(this.holdsRatio=e.holdsCount/e.copiesOwned);var n=t.excise(e,"estimatedWaitDays");"number"==typeof n&&(this._.estimatedWaitDays=n),this.usage.markAsFetched(s.integrity);var r=t.excise(e,"id");return e.titleId||(e.titleId=this.titleId||r),e.titleId||(e.titleId=t.try(this,"collation.title.titleId")),e.titleId||(e.titleId=t.try(this,"possession.title.titleId")),e.titleId||APP.journal.warn("[TITLE-HOLDING] no titleId",e),i.prototype._deserializeAttributes.apply(this,arguments)},n._serializeAttributes=function(){var e={},t=function(t){if("undefined"!=typeof this[t])return e[t]=this[t]}.bind(this);return t("titleId"),t("isOwned"),t("isAvailable"),this.isPrerelease&&t("isPrerelease"),t("copiesOwned"),t("copiesAvailable"),t("holdsCount"),t("position"),"number"==typeof this._.estimatedWaitDays&&(e.estimatedWaitDays=this._.estimatedWaitDays),"number"==typeof this.originalPosition?e.originalPosition=this.originalPosition:"number"==typeof this.position&&(e.originalPosition=this.position),"number"==typeof this.originalCopiesOwned?e.originalCopiesOwned=this.originalCopiesOwned:"number"==typeof this.copiesOwned&&(e.originalCopiesOwned=this.copiesOwned),e},n._usageTTL=function(){if(0==this.copiesAvailable&&this.luckyDayCopiesAvailable)return 6e4},n._hold=function(){return"hold"==t.try(this.possession,"type")?this.possession:void 0},n._library=function(){return APP.libraries.find({baseKey:this.libraryKey})||t.try(this._exactCards()[0],"library")},n._exactCards=function(){return APP.patron.cards.filter({advantageKey:this.libraryKey})},s}),define("app/models/collations/title-holdings",["require","common","./collation","app/models/items/title-holding"],function(e){var t=e("common"),i=e("./collation"),s=i.new(),n=s.prototype;return n.ITEM_CLASS=e("app/models/items/title-holding"),n.ITEM_NAME="holding",n.PERSISTENCE=!1,n.ANNOUNCE=!1,n.$init=function(e){this.title=e,i.prototype.$init.call(this)},n.withBestCircAction=function(e,i){i=t.absorb(i,{debounce:0});var s,n,r=t.try(i,"libraries.preferred"),o=t.try(i,"libraries.scope"),a=t.try(i,"libraries.fallback"),l=this._allHoldingsFromCards(o,[r],a),c={},h=function(t){return s=t,i.onUpgraded?i.onUpgraded(s):e?e(s):void 0},u=function(){if("function"==typeof e){var i,n=this._resultFromCircActionScores(l,c,r);s?n.action!=s.action||n.status!=s.status||n.libraryKey!=s.libraryKey?i=h(n):t.among(n.status,"complete","failed")&&(i=h(n)):i=e(s=n),"stop"==i&&(e=null)}}.bind(this);t.each(l,function(t){t.use(function(s){if("function"==typeof e){var o=r&&t._library()===r,a=t.circActionScore(o);c[t.libraryKey]=a,clearTimeout(n),n=setTimeout(u,i.debounce||0),"complete"!=a.status&&t.reuse()}},this)},this),clearTimeout(n),u()},n._allHoldingsFromCards=function(e,i,s){var n=t.try(APP.library,"key()"),r=t.try(s,"key()")||n,o=[],a=[];t.each(t.compact(i||[]),function(e){o.push(e.key())}),t.each(APP.patron.cards.all,function(i){e&&!t.among(i.library,e)||a.push(i.advantageKey)},this),t.among(n,o)?o.unshift(n):t.among(n,a)?a.unshift(n):!r||o.length||a.length||a.push(r),keys=t.unique(t.compact(o.concat(a)));var l=[];return t.each(keys,function(e){l.push(this.produce({libraryKey:e}))},this),l},n._resultFromCircActionScores=function(e,i,s){var n={score:0,action:"unowned"},r="complete",o=0;if(t.each(e,function(e){var a=s&&e._library()===s,l=i[e.libraryKey]||e.circActionScore(a);i[e.libraryKey]=l,l.score>o&&(o=l.score,t.absorb(l,n)),"scanning"==l.status&&(r="scanning"),"failed"==l.status&&"scanning"!=r&&(r="failed")},this),n.holding){n.holding._library();n.libraryKey=n.holding.libraryKey,n.websiteId=t.try(n.holding._library(),"websiteId")}return t.absorb({status:r},n)},s}),define("app/models/agents/title-fulfiller-agent",["require","common","./usage-agent"],function(e){var t=e("common"),i=e("./usage-agent"),s=i.new(),n=s.prototype;return n.TTL=6048e5,n._processBatch=function(e){var t=e.queue[0].item;if(t.loan)return this._onAllDataImported(e);var i=t.title;if(!i)return this._onRequestFailure(e);var s=i.holding(t._library());return s?(e.awaiting=[],t.sampleURL||(e.awaiting.push(i),i.use(this._onDataImported.bind(this,e))),e.awaiting.push(s),void s.use(this._onDataImported.bind(this,e))):this._onRequestFailure(e)},n._onDataImported=function(e,i,s){return"failed"==i.work?this._onRequestFailure(e):i.isIdeal?(t.excise(e.awaiting,s),e.awaiting.length?void 0:this._onAllDataImported(e)):s.reuse(this._onDataImported.bind(this,e))},n._onAllDataImported=function(e){t.each(e.queue,function(e){this._importTask(e,{}),this._succeedTask(e)},this)},s}),define("app/views/popovers/popover-offline",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.attempt=function(e,t){return APP.network.reachable?(e(),!0):t?(APP.arena.popover(t).confirm({warningLabel:"action.explanation.offline",buttonLabel:"mascot.persevere",onSubmit:e}),!1):void 0},i}),define("app/models/items/title-fulfiller",["require","common","app/models/items/item","app/models/agents/usage","app/models/agents/title-fulfiller-agent","app/views/popovers/popover-offline"],function(e){var t=e("common"),i=e("app/models/items/item"),s=i.new(),n=s.prototype,r=e("app/models/agents/usage"),o=e("app/models/agents/title-fulfiller-agent"),a=e("app/views/popovers/popover-offline");return s.knownFulfillments=function(){var e=[{fulfillmentType:"bifocal",fulfillmentSubtype:"ebook-overdrive",formats:["book"],isMemorable:!0},{fulfillmentType:"bifocal",fulfillmentSubtype:"audiobook-overdrive",formats:["audiobook"],isMemorable:!0},{fulfillmentType:"bifocal",fulfillmentSubtype:"magazine-overdrive",formats:["magazine"],isMemorable:!0},{fulfillmentType:"brightcove",fulfillmentSubtype:"video-streaming",formats:["video"],isMemorable:!0},{fulfillmentType:"epub",fulfillmentSubtype:"ebook-epub-open",formats:["book"],isDownloadable:!0},{fulfillmentType:"epub",fulfillmentSubtype:"ebook-epub-adobe",formats:["book"],isDownloadable:!0,hasDRM:!0},{fulfillmentType:"pdf",fulfillmentSubtype:"ebook-pdf-open",formats:["book"],isDownloadable:!0},{fulfillmentType:"pdf",fulfillmentSubtype:"ebook-pdf-adobe",formats:["book"],isDownloadable:!0,hasDRM:!0},{fulfillmentType:"media-do",fulfillmentSubtype:"ebook-media-do",formats:["book"]},{fulfillmentType:"kindle",fulfillmentSubtype:"ebook-kindle",formats:["book"],isMemorable:!0},{fulfillmentType:"ntc",fulfillmentSubtype:"ntc-pay-per-access",useExternalApp:!0},{fulfillmentType:"ntc",fulfillmentSubtype:"ntc-subscription",useExternalApp:!0}],i=[],s=APP.constants.formats();return t.each(e,function(e){if(e.formats){for(var n=0,r=e.formats.length;n<r;++n)if(t.among(e.formats[n],s)){i.push(e);break}}else i.push(e)}),i},n.$init=function(){this.usage=new r(this,o)},n.defaultFulfillmentType=function(){var e=this._fulfillmentsMatching({isLockedIn:!0})[0],i=[];t.each(this.fulfillments,function(t){e&&t!=e&&"bifocal"!=t.fulfillmentType||i.push(t)});var s=[];if(1==i.length?s.push(i[0].fulfillmentType):t.each(i,function(e){e.isMemorable&&s.push(e.fulfillmentType)}),1==s.length)return s[0];if(!APP.network.reachable&&t.among("bifocal",s)&&this.isOpenableRightNow())return"bifocal";if(s.length>1){var n=APP.summoner.daemons.fulfillmentChoices,r=n.preference(this.title.format);if(r&&t.among(r,s))return r;var o=n.choice(this.title);if(o&&t.among(o,s))return o}return"choose"},n.isFulfillable=function(e){if(!this.loan)return!1;if(this.fulfillments){var t=this._fulfillmentsMatching(e);return!!t.length}},n.isLockedIn=function(e){if(!this.loan)return!1;if(this.fulfillments){e=this._shorthandToOptions(e),e=t.absorb(e,{isLockedIn:!0});var i=this._fulfillmentsMatching(e);return!!i.length}},n.hasSample=function(e){if(this.fulfillments){var i=this._fulfillmentsMatching(t.absorb(e,{hasSample:!0}));return!!i.length}},n.open=function(e){if(e="string"==typeof e?{fftType:e}:t.absorb(e,{}),"magazine"==this.title.format&&this._fulfillmentsMatching({fulfillmentType:"bifocal"})[0])return this._openWithOfflinePrompt(function(){var t=e.libraryKey||this._library().baseKey;APP.nav.go("open/magazine/"+t+"/"+this.title.titleId)}.bind(this),e);if(this.loan){if(e.fftType||(e.fftType=this.defaultFulfillmentType(),e.remember=!1),"choose"==e.fftType)return APP.nav.go(this.loan.pathToShelfAction("fulfill"));if("ntc"==e.fftType&&"shelf"!=APP.router.realm){var i=this._library();return APP.nav.go(i.path("extras/"+this.loan.psnKey+"/request"))}if("ntc"==e.fftType)return APP.nav.go("shelf/extras/"+this.loan.psnKey+"/open");var s=this._fulfillmentsMatching({fulfillmentType:e.fftType})[0];if(!s)return APP.journal.warn("[TITLE-FULFILLER] no such fulfillment:",{fulfillmentType:e.fftType,loan:this.loan,fulfiller:this});if("bifocal"!=s.fulfillmentType){var n=t.parameterizeURL(this.loan.pathToShelfAction("fulfill"),{fftType:s.fulfillmentType});APP.nav.go(n)}else this._openWithOfflinePrompt(function(){e.useExactLoan?APP.nav.go("open/loan/"+this.loan.card.cardId+"/"+this.title.titleId):APP.nav.go("open/loan/"+this.title.titleId)}.bind(this),e)}else{var r;r=e.fftType&&"choose"!=e.fftType?this._fulfillmentsMatching({hasSample:!0,fulfillmentType:e.fftType})[0]:this._fulfillmentsMatching({hasSample:!0,fulfillmentType:e.fftType})[0]||this._fulfillmentsMatching({hasSample:!0})[0],"bifocal"==t.try(r,"fulfillmentType")?this._openWithOfflinePrompt(function(){var t=e.libraryKey||this._library().baseKey;APP.nav.go("open/sample/"+t+"/"+this.title.titleId)}.bind(this),e):t.try(r,"sampleURL")?this._openWithOfflinePrompt(function(){APP.shell.openURL(r.sampleURL)}.bind(this),e):APP.journal.warn("[TITLE-FULFILLER] no sample available:",this)}},n.isOpenableRightNow=function(e){if(APP.network.reachable)return!0;var i=this.loan?"loan":void 0;if(APP.lectern.isOpen(this.title.titleId,i))return!0;if(e&&e.fftType&&"bifocal"!=e.fftType)return!1;var s=APP.titles.luggages.find({title:this.title});return!!t.try(s,"status().isDownloaded")},n.fulfill=function(e,i,s){this._.routePathAtFulfill=APP.router.route.path;var n=function(n){"ntc"==e.fulfillmentType?APP.sentry.getNTCCode(this.loan.card,function(s){n=t.parameterizeURL(n,{code:s}),this._onFulfilled(e,n,i)}.bind(this),s):this._onFulfilled(e,n,i)}.bind(this);APP.sentry.fulfillLoan(this.loan,e,n,s)},n._openWithOfflinePrompt=function(e,t){var i=function(){"function"==typeof t.prenavigate?t.prenavigate():"string"==typeof t.prenavigate&&APP.nav.go(t.prenavigate),e()};t.offlinePromptTarget&&!this.isOpenableRightNow()?(new a).attempt(i,t.offlinePromptTarget):i()},n._onFulfilled=function(e,t,i){if(this._.routePathAtFulfill==APP.router.route.path){var s=this._fulfillmentsMatching({fulfillmentSubtype:e.fulfillmentSubtype})[0];return s&&(s.isLockedIn=!0),APP.patron.loans.save(),APP.events.dispatch("title:open:fulfill",{title:this.title,fulfillmentType:e.fulfillmentType,fulfillmentSubtype:e.fulfillmentSubtype}),APP.scribe.record("loan:sent",{"title:id":this.title.titleId,"fulfillment:type":e.fulfillmentType,"fulfillment:subtype":e.fulfillmentSubtype}),"function"==typeof i?i(e,t):void 0}},n._transformAttributes=function(e,i){var n={};e.title&&(n.title=e.title),e.websiteId&&(n.websiteId=e.websiteId),e.loan&&(n.loan=e.loan),e.sample&&(n.sampleURL=t.try(e.sample,"href"));var r=!e.availabilityType&&"undefined"==typeof e.isFormatLockedIn;if(e.fulfillments)n.fulfillments=[],t.each(e.fulfillments,function(e){t.select(n.fulfillments,function(t){return t.fulfillmentSubtype==e.fulfillmentSubtype})[0]||n.fulfillments.push(e)});else{n.fulfillments=[],r&&this.fulfillments&&(n.fulfillments=t.clone(this.fulfillments));var o=[];e.isFormatLockedIn&&t.each(e.otherFormats,function(e){o.push(e.id)}),t.each(s.knownFulfillments(),function(i){t.each(e.formats,function(e,s){i.fulfillmentSubtype==e.id&&(r&&!e.sample||(i=t.select(n.fulfillments,function(t){if(t.fulfillmentSubtype==e.id)return t})[0]||t.clone(i),i.isLockedIn=t.among(i.fulfillmentSubtype,o),t.try(e,"sample.href")&&(i.hasSample=!0,i.sampleURL=e.sample.href),t.among(i,n.fulfillments)||n.fulfillments.push(i),t.breakIteration()))})})}return!t.try(n.fulfillments,"length")&&this.fulfillments&&(n.fulfillments=t.clone(this.fulfillments)),n},n._deserializeAttributes=function(e){var s=this.fulfillments;i.prototype._deserializeAttributes.call(this,e),e.fulfillments&&t.each(s,function(e){var i=this._fulfillmentsMatching({fulfillmentSubtype:e.fulfillmentSubtype})[0];i&&t.absorb(t.absorb(i,e),i)},this)},n._serializeAttributes=function(){return{websiteId:this.websiteId,fulfillments:this.fulfillments}},n._fulfillmentsMatching=function(e){var i=[];return e?(e=this._shorthandToOptions(e),t.each(this.fulfillments,function(s){var n=!0;t.each(e,function(e,i){s[e]!==i&&(n=!1,t.breakIteration())}),n&&i.push(s)}),i):this.fulfillments||i},n._library=function(){return this._.library?this._.library:(this._.library=t.try(this.loan,"library"),!this._.library&&this.websiteId&&(this._.library=APP.libraries.produce({websiteId:this.websiteId})),this._.library||APP.library)},n._shorthandToOptions=function(e){if("string"!=typeof e)return e;var i;if(t.try(this.fulfillments,"length"))for(var s=0,n=this.fulfillments.length;s<n;++s){var r=this.fulfillments[s];if(r.fulfillmentSubtype==e)return{fulfillmentSubtype:e};r.fulfillmentType==e&&(i={fulfillmentType:e})}return i||{fulfillmentSubtype:e}},s}),define("app/models/collations/title-fulfillers",["require","common","./collation","app/models/items/title-fulfiller"],function(e){var t=(e("common"),e("./collation")),i=t.new(),s=i.prototype;return s.ITEM_CLASS=e("app/models/items/title-fulfiller"),s.ITEM_NAME="fulfiller",s.PERSISTENCE=!1,s.ANNOUNCE=!1,s.$init=function(e){t.prototype.$init.call(this),this.title=e},i}),define("app/models/agents/title-talkers-agent",["require","common","./usage-agent"],function(e){var t=(e("common"),e("./usage-agent")),i=t.new(),s=i.prototype;return s.TTL=864e5,s._processBatch=function(e){var t=e.queue[0].item;e.requests=[],e.requests.push(APP.services.thunder.fetch("libraries/"+t.libraryKey+"/media/"+t.title.titleId+"/notes",this._onNotesRequestSuccess.bind(this,e),this._onNotesRequestFailure.bind(this,e)));
},s._onNotesRequestSuccess=function(e,t){var i=e.queue[0];this._importTask(i,JSON.parse(t)),this._succeedTask(i)},s._onNotesRequestFailure=function(e,t){404==t.status?this._onNotesRequestSuccess(e,"{}"):this._onRequestFailure(e,t)},i}),define("app/models/items/title-talker",["require","common","./item"],function(e){var t=e("common"),i=e("./item"),s=i.new(),n=s.prototype;return n.added=function(){this.format=this.collation.title.format},n.isActive=function(){if(this.noteType){if(this.schedule&&this.noteType){var e=new Date,t=new Date(this.schedule.startDate||0),i=new Date(this.schedule.endDate||e.getTime()+1);return e>=t&&e<=i}return!0}return!1},n._transformAttributes=function(e,i){var s=t.absorb(e,{});return s.note=t.excise(s,"body"),s.account=t.excise(s,"privateAccountId"),t.excise(s,"title"),s},s}),define("app/models/collations/title-talkers",["require","common","./collation","app/models/agents/usage","app/models/agents/title-talkers-agent","app/models/items/title-talker"],function(e){var t=e("common"),i=e("./collation"),s=i.new(),n=s.prototype,r=e("app/models/agents/usage"),o=e("app/models/agents/title-talkers-agent");return n.ITEM_CLASS=e("app/models/items/title-talker"),n.ITEM_NAME="talker",n.PERSISTENCE=!1,n.ANNOUNCE=!1,n.$init=function(e,t){i.prototype.$init.call(this),this.title=e,this.libraryKey=t,this.usage=new r(this,o)},n.best=function(){var e=[],i=[],s=APP.patron.cards.find({advantageKey:this.libraryKey}),n=t.try(s,"accounts")||[-1];t.each(this.all,function(s){t.among(s.account,n)&&(s.account>=0?e.push(s):i.push(s))},this);for(var r=e.concat(i),o=0,a=r.length;o<a;++o)if(r[o].isActive())return r[o]},n._deserializeAttributes=function(e,i){var s=[SPARK.locale.tag],n=t.try(this.title,"languages")||[];1==n.length&&s.unshift(n[0].id),s=t.unique(t.compact(s));var r=t.clone(t.try(e,"notes")),o=[];t.each(r,function(e){o.push(e.language)}),o=t.unique(t.compact(o));var a=[],l=SPARK.locale.negotiate(s,o);t.each(l,function(e){t.each(r,function(t){t.language==e&&a.push(t)})}),this.importAll(a,i)},n._attributesToQuery=function(e,t){return{account:e.account,language:e.language}},s}),define("app/models/items/title",["require","common","app/models/items/item","app/models/agents/usage","app/models/agents/title-agent","app/models/agents/taggable-agent","app/models/agents/activity-agent","app/models/items/title-blurb","app/models/collations/title-holdings","app/models/collations/title-fulfillers","app/models/collations/title-talkers","shibui/src/phrasebook"],function(e){var t=e("common"),i=e("app/models/items/item"),s=i.new(),n=s.prototype,r=e("app/models/agents/usage"),o=e("app/models/agents/title-agent"),a=e("app/models/agents/taggable-agent"),l=e("app/models/agents/activity-agent"),c=e("app/models/items/title-blurb"),h=e("app/models/collations/title-holdings"),u=e("app/models/collations/title-fulfillers"),p=e("app/models/collations/title-talkers"),d=e("shibui/src/phrasebook");return n.PERSISTENCE="incomplete",n.$init=function(){this.usage=new r(this,o),this.blurb=new c(this),this.holdings=new h(this),this.fulfillers=new u(this),this.tags={taggable:this},new r(this.tags,a),this.acts={actable:this},new r(this.acts,l)},n.journey=function(){return APP.journeys.produce({titleId:this.titleId})},n.path=function(e,i){var s,n=APP.library;if("string"==typeof e&&"string"!=typeof i&&(i=e,e=null),t.among(i,"borrow","hold")&&(i="request"),"string"==typeof e){if(!APP.library||!i||!i.match(/^request/))return APP.interviews.path("interview/ensure",{origination:APP.router.route.path,key:e,title:this.titleId,subpath:i})}else t.try(e,"params")?s=e:t.try(e,"baseKey")&&(n=e);if(s)return s.path()+"/"+this.titleId+(i?"/"+i:"");var r="similar-"+this.titleId+"/page-1",o=r+"/"+this.titleId+(i?"/"+i:"");if(n&&"library"==APP.router.realm)return n.path(o);if(n&&"search"==APP.router.realm)return n.path(o).replace(/^library/,"search");var a="tags"==APP.router.realm?"tags":"shelf";return a+"/"+o},n.holding=function(e){var i=e||APP.library;return"string"!=typeof i&&(i=t.try(i,"key()")),i?this.holdings.produce({titleId:this.titleId,libraryKey:i}):void APP.journal.warn("[TITLE] holding() is null",e,APP.library)},n.talkers=function(e){var i=e;if("string"!=typeof e&&(i=t.try(e||APP.library,"key()")),i){var s="talkers-"+i;return this._.memos[s]=this._.memos[s]||new p(this,i)}},n.fulfiller=function(e){if(e=e||APP.library){var t=this.fulfillers.produce({websiteId:e.websiteId});return t.title=this,t}},n.possession=function(e){if("string"!=typeof e||"loan"==e){var t=APP.patron.loans.find({"title.titleId":this.titleId});if(t)return t}if("string"!=typeof e||"hold"==e){var t=APP.patron.holds.find({"title.titleId":this.titleId});if(t)return t}},n.creatorList=function(e,t){var i="creator-"+t.id,s=e.key()+"-"+i;return this._.memos[s]||(this._.memos[s]=e.catalog.lists.produce(i),this._.memos[s]._.name=t.name),this._.memos[s]},n.subjectList=function(e,t){var i="subject-"+t.id,s=e.key()+"-"+i;return this._.memos[s]||(this._.memos[s]=e.catalog.lists.produce(i),this._.memos[s]._.name=APP.constants.bestNameForSubject(t.id,t.name)),this._.memos[s]},n.publisherList=function(e,t){"undefined"==typeof t&&(t=this.publisher);var i="publisher-"+t.id,s=e.key()+"-"+i;return this._.memos[s]||(this._.memos[s]=e.catalog.lists.produce(i),this._.memos[s]._.name=t.name),this._.memos[s]},n.imprintList=function(e,t){"undefined"==typeof t&&(t=this.imprint);var i="imprint-"+t.id,s=e.key()+"-"+i;return this._.memos[s]||(this._.memos[s]=e.catalog.lists.produce(i),this._.memos[s]._.name=t.name),this._.memos[s]},n.seriesList=function(e,i){if(e){var s=t.try(i,"series")||this.series;"string"==typeof s&&(s={name:s});var n=s.id||encodeURIComponent(s.name),r=this.parentMagazineId?void 0:t.try(i,"breadth"),o=t.compact([e.key(),"series",r,n]).join("-");if(!this._.memos[o]){var a;if(this.parentMagazineId)a=e.catalog.lists.produce("issues-"+this.parentMagazineId);else if(a=e.catalog.lists.produce("series-"+n),"narrow"==r){var l={};this.format&&(l.formats=[this.format]);var c=t.try(this,"languages[0].id");c&&(l.languages=[c]);var h=a.params.withRefinements(l).address();a=e.catalog.lists.produce(h)}this._.memos[o]=a}return this._.memos[o]}},n.seriesReadingOrder=function(){if("magazine"!=this.format&&this.series&&this.series.name)return t.try(this._.memos,"seriesReadingOrder.label")?this._.memos.seriesReadingOrder:void 0},n.otherFormats=function(e,i){if(!(["book","audiobook"].indexOf(this.format)<0)){var s=this._.memos.otherFormats||(this._.memos.otherFormats={});if(s.list&&s.results)return i(s.list,s.results);if(s.callback)return s.callback=i;s.callback=i,s.list=e.catalog.lists.make(["search","query-"+encodeURIComponent(this.title+" "+t.try(this.authors(),"[0].name")),"facets-false","override"].join("/"));var n=function(e,t){if(!e||!t)return 0;if(e==t)return 5;var i={};i.a=e.toLowerCase().split(/[^\w]+/),i.b=t.toLowerCase().split(/[^\w]+/),i.a.length<=i.b.length?(i.less=i.a,i.more=i.b):(i.less=i.b,i.more=i.a);for(var s=0;s<i.less.length;++s)if(!(i.less[s].length<=3)&&i.more.indexOf(i.less[s])<0)return 0;var n=i.more.length-i.less.length;return 4-Math.min(n,3)};s.list.freshen(0,10,function(e,i){for(var r=[],o=0,a=i.length;o<a;++o){var l=i[o],c={};l.format!=this.format&&(c.title=n(this.title,l.title))&&(c.authors=n(this.authorNames(),l.authorNames()))&&r.push({title:l,rank:2*c.title+c.authors})}r.sort(function(e,t){return t.rank-e.rank}),s.results=[],t.each(r,function(e){s.results.push(e.title)}),s.callback(s.list,s.results),delete s.callback}.bind(this))}},n.titleWithoutOrphans=function(){return this.title.match(/\s.+\s/)?this.title.replace(/\s([^\s<]{0,12})\s*$/,"&nbsp;$1"):this.title},n.titleAsNonUniquePathname=function(){var e=this.title.toLowerCase().replace(/[^\w]+/g,"-")||"-";return"-"==e?this.titleId:e},n.authors=function(){return t.try(this._mainContributorsWithRoles(),"[0][1]")},n.authorNames=function(){var e=t.try(this._mainContributorsWithRoles(),"[0]");if(!e)return"";var i="authorNames";if(!this._.memos[i]){var s=function(e){var i=[];t.each(e,function(e){i.push(e.name)});var s=t.try(this.languages,"[0].id");return s&&s.slice(0,2)==SPARK.locale.tag.slice(0,2)?d.list(i,{type:"unit"}):d.list(i,{type:"narrow"})}.bind(this),e=this._mainContributorsWithRoles()[0],n=e[0],r=e[1];"Editor"==n?this._.memos[i]=d.text("title.creator.editors",{EDITORS:s(r),ED_COUNT:r.length}):this._.memos[i]=s(r)}return this._.memos[i]||""},n.attribution=function(){return this.isExtra?"":this.authorNames()||this.edition||t.try(this,"publisher.name")||""},n.humanFormat=function(){return d.text("format."+this.format)},n.humanDuration=function(e){if(this.duration){var t=this.duration/36e5;if(t<.85)return d.text("units.minutes",{N:Math.floor(60*t)});var t=t<1.5?1:Math.round(t);return d.text("units.hours"+(e?"."+e:""),{N:t})}},n.publicationDate=function(){if(this.publicationTime)return d.date(this.publicationTime)},n.countsTowardLoanLimit=function(){return"magazine"!=this.format},n._transformAttributes=function(e,i){var s={},n=function(t,i){if(void 0!==e[t]&&null!==e[t])return s[i||t]=e[t]},r=e.libraryKey;if(!r&&e.cardId){var o=APP.patron.cards.find({cardId:e.cardId});o&&(r=o.advantageKey)}if(!r&&e.websiteId){var a=APP.libraries.produce({websiteId:e.websiteId});r=a?a.key():null}if(!r&&APP.library&&(r=APP.library.key()),n("id","titleId"),n("reserveId"),n("title"),n("sortTitle"),n("subtitle"),e.edition&&(s.edition=t.decodeEntitiesInString(e.edition).replace(new RegExp("^"+t.regExpEscape(t.decodeEntitiesInString(s.title))),"").trim()),e.parentMagazineTitleId&&n("parentMagazineTitleId","parentMagazineId"),t.try(e,"type.id")&&(s.format=APP.constants.formats(e.type.id)),e.detailedSeries){s.series={id:e.detailedSeries.seriesId,name:e.detailedSeries.seriesName};var l=e.detailedSeries.rank,c=e.detailedSeries.readingOrder;c&&c.match(/^\d+$/)&&(c="#"+c),s.seriesReadingOrder={rank:l,label:c}}else e.series&&(s.series={name:e.series});s.series&&s.parentMagazineId&&(s.series.isPeriodical="9"!=t.try(e,"frequency.id")),e.covers&&(s.cover={},s.cover.color=this._findCoverColor(e.covers,s.title),s.cover.url=this._findCoverURLForDPI(e.covers));var h=this._calculateDuration(e.formats);if(h&&(s.duration=h),"ntc"==t.try(e,"formats[0].fulfillmentType")&&(s.isExtra=!0),e.creators){s.creators={};var u={};t.each(e.creators,function(e){t.among(e.id,t.try(u,e.role))||((u[e.role]=u[e.role]||[]).push(e.id),s.creators[e.role]=s.creators[e.role]||[],s.creators[e.role].push({id:e.id,name:e.name,sortName:e.sortName}))})}else!e.firstCreatorName||t.try(this.creators,"Author")||t.try(this.creators,"Editor")||(s.creators={Creator:[{id:e.firstCreatorId,name:e.firstCreatorName,sortName:e.firstCreatorSortName}]});n("publisher"),s.publisher&&e.publisherAccount&&(s.publisher.accountId=e.publisherAccount.id),n("imprint"),n("subjects"),e.languages&&(s.languages=t.select(e.languages,function(e){var t=d.text("language.code-"+e.id,{},{okIfMissing:!0});if(t)return{name:t,id:e.id}})),e.ratings&&e.ratings.maturityLevel&&(s.audiences=[e.ratings.maturityLevel.id]),e.starRating&&e.starRatingCount>=10&&(s.stars={rating:e.starRating,ratingCount:e.starRatingCount}),s.awards=e.awards||[];var p=this._earliestPubTime(e);if(p&&(s.publicationTime=p),e.estimatedReleaseDate?"complete"!=i.integrity&&s.parentMagazineId||(s.releaseTime=new Date(e.estimatedReleaseDate).getTime()):e.releaseTime&&(s.releaseTime=e.releaseTime),n("isPreReleaseTitle","isPrerelease"),e.description&&this.blurb.import(e,{source:"external",integrity:"incomplete"}),t.each(e.formats,function(e){e.id.match("overdrive")&&t.each(e.identifiers,function(e){e.type.match(/^ISBN$/i)&&(s.isbn=e.value)})}),r&&!e.cardId){var m=t.absorb(e,{}),f={source:"external",integrity:"complete"};e.availabilityType||(delete m.formats,f.integrity="incomplete"),this.holdings.produce({titleId:s.titleId,libraryKey:r}).import(m,f)}if(r){var g=APP.libraries.includingNow(APP.libraries.withCards());t.each(g,function(i){e.websiteId&&i.websiteId!=e.websiteId||this.fulfiller(i).import(t.absorb({title:this},t.absorb(e,{})),{source:"external",integrity:"complete"})},this)}return s},n._deserializeAttributes=function(e,s){e=t.absorb(e,{}),this._.memos={},this.titleId=t.excise(e,"titleId")||t.excise(e,"slug")||this.titleId,this._.originalTitle=t.excise(e,"title")||this._.originalTitle||"",this.title=APP.titles.cleanTitleString(this._.originalTitle),this.sortTitle=t.excise(e,"sortTitle")||this.title,this.cover=t.excise(e,"cover")||this.cover||{};var n=t.excise(e,"format");"string"==typeof n&&(this.format=n);var r=t.excise(e,"seriesReadingOrder");return r&&(this._.memos.seriesReadingOrder=r),i.prototype._deserializeAttributes.call(this,e),this.titleId?(this.sortAuthor=this._guessSortAuthor(),void this.usage.markAsFetched(s.integrity)):console.trace("[TITLE] missing titleId")},n._serializeAttributes=function(){var e={},t=function(t){"undefined"!=typeof this[t]&&(e[t]=this[t])}.bind(this);return t("titleId"),e.title=this._.originalTitle||this.title,t("subtitle"),t("edition"),t("format"),t("series"),t("cover"),t("duration"),t("creators"),t("publisher"),t("imprint"),t("subjects"),t("languages"),t("stars"),t("parentMagazineId"),t("publicationTime"),t("isPrerelease"),e},n._mainContributorsWithRoles=function(e){var i=[];if(this.creators){e="number"==typeof e?e:3;var s=this.creators.Author||[],n=this.creators.Editor||[];s.length&&s.length<=e&&i.push(["Author",s]),n.length&&n.length<=e&&i.push(["Editor",n]),s.length>4&&i.push(["Author",s.slice(0,e)]),n.length>4&&i.push(["Editor",n.slice(0,e)]),i.length||t.each(this.creators,function(s,n){n.length&&(i.push([s,n.slice(0,e)]),t.breakIteration())},this)}return i},n._earliestPubTime=function(e){var i,s=t.compact(t.unique(t.flatten([e.estimatedReleaseDate],t.select(e.formats,function(e){return e.onSaleDateUtc}))));t.each(s,function(e){var t=new Date(e);i=i&&i>t?i:t});var n=i?i.getTime():null;return n&&isFinite(n)?n:null},n._calculateDuration=function(e){if(!e)return null;for(var t=0,i=e.length;t<i;++t){var s=e[t].duration;if(s){var n=s.split(":");return 1e3*(60*parseFloat(n[0])*60+60*parseFloat(n[1])+parseFloat(n[2]))}}},n._findCoverColor=function(e,i){var s=this._findWithinCoverAttrs(e,function(e){var i=t.try(e,"primaryColor");if(i&&(i.rgb||i.hex))return i});if(s&&s.rgb)return[s.rgb.red,s.rgb.green,s.rgb.blue];if(s&&s.hex)return t.hexToRGB(s.hex);if("string"==typeof i&&i){var n=t.hashStringToFloat(i),r=t.hashStringToFloat(i.split("").reverse().join(""));return t.hslaToRGBA([360*n,20+70*r,25,1])}},n._findCoverURLForDPI=function(e){return this._findWithinCoverAttrs(e,function(e){return t.try(e,"href")})},n._findWithinCoverAttrs=function(e,i){var s,n=window.devicePixelRatio>1.5?[510,300,150]:[300,510,150],r=1/0;return t.each(e,function(e,t){if(t&&t.href&&t.isPlaceholderImage!==!0&&!(t.href.indexOf("00000000-0000-0000-0000")>=0)){var o=i(t);if(o){var a=parseFloat(e.replace(/[^\d]/g,"")),l=n.indexOf(a);l<0&&(l=1/0),(!s||l<r)&&(r=l,s=o)}}}),s},n._guessSortAuthor=function(){return"magazine"==this.format?this.title+" - "+this.attribution():t.select(this.authors(),function(e){return e.sortName||void 0}).join("; ")},s}),define("app/views/components/common/cover-3d",["require","common","app/views/core/partial","quirkbase","app/models/items/title"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=(e("quirkbase"),e("app/models/items/title"));return n.become=function(e,i,s){var n;if(e){var o=e.titleId||e.psnKey.split("-").pop();if(this._.ownerKey===o)return;this._.ownerKey=o,n=e instanceof r?e:e.title}else{if(!this._.ownerKey)return;this._.ownerKey=null}this._declassify(this.dom.root,"is-loaded is-error"),APP.coverGuru.paint(this.dom.root,"cover"),this._textify(this.dom.front);var a;t.try(i,"complete")||(i=null),t.try(i,"naturalWidth")||(i=null),t.try(i,"getBoundingClientRect().width")||(i=null),i?(a=t.element({tag:"canvas",parentNode:this.dom.front}),APP.coverGuru.cloneImageToCanvas(i,a)):e&&(a=t.element({tag:"img",parentNode:this.dom.front})),n?n.use(function(t,n){return this._semaphore("format",n.format||"book"),n.format||t.isBroken?(APP.coverGuru.paintWithCover(n,this.dom.root,"cover",{delay:1,callback:s}),void(i||(APP.coverGuru.applyCoverToImage(e,a,{cloneIfPossible:!0,composeOnError:!0,onLoad:this._classify.bind(this,this.dom.root,"is-loaded",!0),onError:this._onImageError.bind(this,n)}),APP.imageDirector.expedite(this.dom.root)))):n.reuse()}.bind(this)):this._semaphore("format","book")},n.interactive=function(e){if(!this.dom.fallback){if(!e)return APP.events.off(t.excise(this.handlers,"contact"));if(!this.handlers.contact){var i,s=this.dom.bounds;APP.events.setTouchAction(this.dom.frame,"none"),this.handlers.contact=APP.events.onContact(this.dom.frame,{start:function(e){t.prefixProperty(s.style,"transition","none"),i={firstX:e.pageX,firstY:e.pageY,firstR:this._getYRotation(),moving:!1},APP.events.dispatch("cover-3d:interaction:start",{cover:this}),this.handlers.contact.capture()}.bind(this),move:function(e){if(i){var n=e.pageX-i.firstX,r=e.pageY-i.firstY;if(i.moving||(i.moving=Math.abs(n)>Math.abs(r)),i.moving){var o="translateZ(-300px) rotateY("+(i.firstR+n)+"deg)";t.prefixProperty(s.style,"transform",o),APP.events.stop(e)}}}.bind(this),end:function(e){i&&(t.prefixProperty(s.style,"transform"),t.prefixProperty(s.style,"transition"),i=null,APP.events.dispatch("cover-3d:interaction:stop",{cover:this}))}.bind(this)})}}},n._layout=function(e){this._swapElement(e.root,{tag:"figure"}),this._build("cover-3d",{extending:e}," lining","  shadow","  frame","   bounds","    back","    spine","    leaves","    front")},n._onImageError=function(e,t){this._classify(this.dom.root,"is-loaded is-error")},n._getYRotation=function(){var e=-24;try{var t=window.getComputedStyle(this.dom.bounds,null),i=t.getPropertyValue("transform"),s=i.split("(")[1];s=s.split(")")[0],s=s.split(",");var n=parseFloat(s[2]),r=parseFloat(s[0]);e=Math.round(Math.atan2(n,r)*(180/Math.PI))*-1}catch(e){}return e},s}),define("app/views/screens/library/screen-title-circ",["require","common","app/views/screens/screen","shibui/src/components/spinner","app/views/components/library/app-header-dismissive","app/views/components/common/cover-3d","app/views/components/interviews/interview-block","app/views/components/library/library-logo"],function(e){var t=e("common"),i=e("app/views/screens/screen"),s=i.new(),n=s.prototype,r=e("shibui/src/components/spinner"),o=e("app/views/components/library/app-header-dismissive"),a=e("app/views/components/common/cover-3d"),l=e("app/views/components/interviews/interview-block"),c=e("app/views/components/library/library-logo");return n.become=function(e,i){var s,n={};e.providerId?(s="circ/open-extra",n.action="open",n.providerId=e.providerId):(s="circ/prepare-title",n.titleId=e.titleId);var r=this._prepare(),o=r.interview.become(s,n,i).interview;t.try(o,"_setupStage()",r.stretch),this._colorizeScreen()},n._layout=function(e){this._build("screen-title-circ",{extending:e}," content .content","  upper","   pillar .bumper-p-n","    stretch","     cover-3d",a,"    commentary","     action <p> {circ-base.commentary.action.check}","     biblio <p>","      title-link",{link:"#"},"       title <strong> {dot-dot-dot}","       <br>","       attribution <span> {blank}","     outcome <p>","  lower","   pillar","    status-disc","     spinner",r,"     cameo-button .mascot-neg",{button:!0,access:"visual"},"      .mascot-icon",{graphic:"mascot",access:"visual"},"     availabilities","      library-logo",c,"    interview",l),this.dom.cover3d.access("inert"),this._classify(e.cover3d.dom.root,"screen-title-circ-cover"),this._buttonify(e.titleLink,this._onTapTitleLink.bind(this)),this._attr(e.titleLink,"role",null),e.spinner.stop()},n._colorizeScreen=function(e){e=e||[32,32,32],this.controller.waypoint.configure({color:e}),APP.arena.dom.elastiguard.colorize(e),APP.shell.colorize(e)},n._onTapTitleLink=function(){var e=this.controller.ancestor.path;APP.nav.back(),APP.nav.go(e)},n._onTapCameoButton=function(e){APP.arena.pickSkinTone(this.dom.cameoButton)},n._onTapAvailabilities=function(e){this.dom.interview.interview.yield("#chooseLibrary")},n._layoutHeader=function(e){e.header=new o,e.header.impart(e.root,"prepend")},n._listen=function(e,t){this._handle("interview-block:characteristics",t.interview)},n._onInterviewBlockCharacteristicsInterview=function(e){var i=e.m.interview,s=t.absorb(e.m.characteristics,{episode:{}});this._updatePageTitle(i,t.try(this.title,"title")||t.try(this.extra,"name"));var n=this.dom.cameoButton.firstChild;if(s.episode.mascot?t.DataClass.set(n,"character",s.episode.mascot):t.DataClass.clear(n,"character"),this._semaphore("status",s.episode.status||"confirm"),"pending"==s.episode.status?(this.dom.spinner.spin(),this.dom.spinner.focus(),t.try(i,"commentate()","outcome.pending",this.dom.outcome)):"speech"==s.episode.status?this.dom.spinner.stop():"complete"==s.episode.status?(this.dom.spinner.stop(),t.try(i,"commentate()","outcome",this.dom.outcome)):"error"==s.episode.status&&(this._textify(this.dom.outcome,"error.sentry-failure.title"),this.dom.spinner.stop()),"circ"!=s.topic){var r=s.episode.status||s.topic;return this._semaphore("status",r)}var o=i.assignments;this._semaphore("action",t.try(a,"action")||o.action),t.try(i,"commentate()","action",this.dom.action),o.extra&&o.extra!=this.extra?(this.extra=o.extra,this._textify(this.dom.title,{html:this.extra.name}),this._updatePageTitle(i,this.extra.name)):o.title&&o.title!=this.title&&(this.title=o.title,this.title.use(function(e,t){return t.title?(this._updatePageTitle(i,t.title),t.cover&&!t.isExtra&&(this.dom.cover3d.access("normal"),this.dom.cover3d.become(t),this.dom.cover3d.interactive(!0),this._classify(this.dom.cover3d.dom.root,"is-resize-animated")),this._textify(this.dom.title,{html:t.titleWithoutOrphans()}),void this._textify(this.dom.attribution,{html:t.attribution()})):t.reuse()},this));var a=o.userCirc||o.bestCirc||o;t.try(a,"library")&&a.library!=this._.library&&(this._.library=a.library,this.dom.libraryLogo.become(this._.library,{invertible:!1}))},n._updatePageTitle=function(e,t){if(e&&e._circPhrase){var i;"string"==typeof t&&t.match(/\w/)&&(i=e._circPhrase({label:"screen-with-title",substitutions:{TITLE:t},okIfMissing:!0})),i=i||e._circPhrase({label:"screen",okIfMissing:!0}),i&&this.controller.waypoint.name!=i&&this.controller.waypoint.configure({name:i})}},s}),define("app/controllers/library/title-circ-controller",["require","common","app/controllers/train-controller","app/views/screens/library/screen-title-circ"],function(e){var t=e("common"),i=e("app/controllers/train-controller"),s=i.new(),n=s.prototype;return n.SCREEN_CLASS=e("app/views/screens/library/screen-title-circ"),n.configure=function(){this.realm=t.try(this.ancestor,"realm")||"library"},n.match=n.refine=function(e,i,s){if("request"==e)return this.args={parameters:t.queryStringToObject(i)},{head:e+i}},n.usher=function(){APP.arena.dom.footer.lower()},n.fill=function(){this.title=this.ancestor.title,this.screen().become(this.title,this.args.parameters)},n.blur=function(){APP.arena.dom.footer.raise()},s}),define("app/views/components/shelf/shelf-actions-button",["require","common","app/views/core/partial","shibui/src/components/spinner"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("shibui/src/components/spinner");return n.become=function(e){this.actions=e},n._layout=function(e){this._swapInteractiveElement(e.root,{button:this._onTap.bind(this)}),this._build("shelf-actions",{extending:e}," sync-status","  spinner",{construct:r,with:{variant:"small"}},"  failure",{icon:"shelf-sync-failure"},"  offline",{icon:"shelf-sync-offline"}," pill .shibui-button {actions}",{id:!0}),this._attr(e.root,"data-halo-delegate",e.pill.id),this._attr(e.pill,"aria-describedby",e.spinner.dom.status.id),this._updateSpinner()},n._listen=function(e,t){this._handle("patron:sync:commence"),this._handle("patron:sync:complete")},n._onTap=function(){var e=APP.arena.popover(this.dom.pill);e.choices(this._createActionsOptions.bind(this))},n._createActionsOptions=function(e){var i=this.actions;return"function"==typeof this.actions&&(i=this.actions(this)),t.isList(i)?(i=i.slice(0),void t.each(i,function(i){if("string"!=typeof i)e.choice(t.absorb(i,{}));else if("sync"==i)e.choice({html:function(e){this._tag("span",e,"","action.shelf.sync"),this._tag("span",e,"sync-pending popover-choice-indicator","action.shelf.sync.pending"),this._tag("span",e,"sync-failure popover-choice-indicator","action.shelf.sync.failure"),this._tag("span",e,"sync-offline popover-choice-indicator","action.shelf.sync.offline")}.bind(this),classes:"action-sync-choice",button:this._onTapActionSync.bind(this)});else if("grc"==i){if(APP.summoner.daemons.fulfillmentChoices.isChoiceToMake()){var s=APP.summoner.daemons.fulfillmentChoices.preference();e.choice({label:"interview.configure-fulfillment",indicator:s?{label:"fulfillment-type.name."+s}:null,button:this._onTapActionGrc.bind(this)})}}else if("dld"==i){if(!APP.shell.has("rosters"))return;e.choice({label:"interview.configure-downloads",icon:"wifi",button:this._onTapActionDld.bind(this)})}else if("sus"==i){var n=APP.patron.holds.all.length;e.choice({label:"interview.configure-suspend-holds",classes:n?"":"subtle",button:n?this._onTapActionSus.bind(this):null})}},this)):APP.journal.warn("[SHELF-ACTIONS-BUTTON] actions is not a list")},n._onTapActionSync=function(){APP.patron.sync.commence({manual:!0,freshness:1e4,journeyFreshness:3e4})},n._onTapActionGrc=function(){APP.interviews.dialog("configure/fulfillment").present()},n._onTapActionDld=function(){APP.interviews.dialog("configure/downloads").present()},n._onTapActionSus=function(){APP.interviews.dialog("configure/suspend-holds").present()},n._onPatronSyncCommence=function(e){this._updateSpinner(e.m.status)},n._onPatronSyncComplete=function(e){this._updateSpinner(e.m.status)},n._updateSpinner=function(e){e=e||APP.semaphore.get("sync")||"success","pending"==e?(this.dom.spinner.spin(),this.dom.spinner.access("visual")):this.dom.spinner.stop(),this.dom.spinner.spokenStatus({label:"a11y.sync.status."+e})},s}),define("app/views/components/shelf/app-header-shelf",["require","common","app/views/core/app-header","app/views/components/shelf/shelf-actions-button"],function(e){var t=(e("common"),e("app/views/core/app-header")),i=t.new(),s=i.prototype,n=e("app/views/components/shelf/shelf-actions-button");return s.actions=function(e){this.dom.actions.impart(this.dom.controls),this.dom.actions.become(e)},s._layoutControls=function(e){t.prototype._layoutControls.apply(this,arguments),this._classify(e.root,"app-header-shelf"),e.actions=new n},i}),define("app/views/shelf/journey-statement",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.become=function(e,i){this.journey=e,this.options=t.absorb(i,{}),this.journey.isSyncing()?this._spin():this.journey.data||"number"==typeof this.journey.progress?this._state(this.journey):this._noData(this.journey)},n._layout=function(e){this.dom=this._build("journey-statement",{element:e.root})},n._spin=function(){this._textify(this.dom.root),this._element({parentNode:this._element({parentNode:this.dom.root,classes:"journey-statement-spinner"}),icon:"spinner-12",classes:"spinner"}),this._classify(this.dom.root,"is-spinning")},n._state=function(e){var i=e.progress||0,s="none",n={PERCENT:i,FORMAT:e.title().format};if(i){s="some";var r=t.try(e.data,"timestamps.created");if(r){n.START_DATE=this._phrase({relativeDate:1e3*r});var o=t.try(e.data,"statistics.accesses");if(o){n.PICKUPS=o;var a=t.try(e.data,"statistics.readingTime");if(a){n.READING_TIME=this._distanceInTime(a,3);var l=e.statisticalEstimatedTime();n.ESTIMATED_TIME=this._distanceInTime(l,3),s=i<.995?"stats":"stats-all"}}}}this._fillOut({label:"journey.statement."+s,substitutions:n})},n._noData=function(e){this._fillOut({label:"journey.statement.none"})},n._fillOut=function(e){if(this._textify(this.dom.root,e),this.options.openTitleOptions){var i=this._element(t.absorb(this.options.openTitleOptions,{parentNode:this.dom.root,label:"journey.statement.none"==e.label?"journey.statement.start-reading":"journey.statement.continue-reading"}));this.options.openTitleHandler&&this._buttonify(i,this.options.openTitleHandler)}this._declassify(this.dom.root,"is-spinning")},s}),define("app/views/core/tag-line",["require","common","app/views/core/partial","app/models/collations/tag","app/models/items/title"],function(require){var C=require("common"),SUPER=require("app/views/core/partial"),CLASS=SUPER.new(),PROTO=CLASS.prototype,Tag=require("app/models/collations/tag"),Title=require("app/models/items/title");return PROTO.$init=function(){return this._.itemCache={},SUPER.prototype.$init.apply(this,arguments)},PROTO.configure=function(e){return this.options=C.absorb(e,{}),this._prepare(),this._classify(this.dom.root,"has-smarts",!!this.options.smarts),this._classify(this.dom.root,"is-headless",!!this.options.headless),this},PROTO.become=function(e){this._prepare(),this.things=C.flatten(Array.prototype.slice.call(arguments,0)),C.try(this.options,"smarts")||this._declassify(this.dom.root,"has-smarts");var t=[],i=!1;return C.each(this.things,function(s){s instanceof Title?(s.tags.use(function(i,s){return i.isIdeal?(C.each(s.all.slice(0).reverse(),function(e){t.push(this.add({html:e.niceName()})),e.behavior&&this._classify(this.dom.root,"has-smarts")},this),void this._retainItems(t)):s.reuse(this.become.bind(this,e))},this),this.handlers._onTagUpdateAll.listen(),i=!0):s instanceof Tag?(t.push(this.add({html:s.niceName()})),this.handlers._onTagUpdateAll.listen(),this._classify(this.dom.root,"has-smarts",!!s.behavior)):(t.push(this.add(s)),this.handlers._onTagUpdateAll.deafen())},this),i||this._retainItems(t),this},PROTO.add=function(textData){var cacheKey=this._cacheKeyForTextData(textData),item=this._.itemCache[cacheKey];if(item)this.dom.body.lastChild!=item&&this.dom.body.appendChild(item);else{var attrs=C.absorb({parentNode:this.dom.body,classes:"tag-line-item"},C.absorb(textData,{}));if(!attrs.spoken){var sugg=C.try(this.options,"suggestions");attrs.spoken={label:"a11y.tag-line"+(sugg?".suggestion":""),substitutions:{TAG_NAME:attrs.html}}}item=this._.itemCache[cacheKey]=this._element(attrs);var text=C.try(item.querySelector('[data-access="visual"]'),"innerText");if(text){var safeText=text.replace(/\.,=\(\{\['/g,"-"),chars=safeText.length;try{chars=eval("[...safeText].length")}catch(e){}this._attr(item,"data-tag-name-length",chars)}}return item},PROTO.suggest=function(e,t){this._prepare(),this._textify(this.dom.body),t=t||5;var i=APP.patron.tags.suggestTagNamesForBehavior(e,t);C.each(i,function(e){this.add({html:e,button:this._dispatch.bind(this,"suggestion:tap",{suggestion:e})})},this)},PROTO._layout=function(){this.dom=this._build("tag-line"," body"," head",{graphic:"tag-line-head"}),this._declassify(this.dom.head,"icon shibui-graphic")},PROTO._listen=function(){this._handle("tag:update:all").deafen()},PROTO._onTagUpdateAll=function(e){this.isInDocument()&&this.things&&this.become.apply(this,this.things)},PROTO._cacheKeyForTextData=function(e){if(e="string"==typeof e?{label:e}:e.html?{html:e}:e.label?{label:e.label,substitutions:e.substitutions}:null)try{return JSON.stringify(e)}catch(e){}return APP.journal.warn("[TAG-LINE] add() -- unserializable textData",e),C.generateUUID()},PROTO._retainItems=function(e){var t={};C.each(this._.itemCache,function(i,s){C.among(s,e)?t[i]=s:s.parentNode&&s.parentNode.removeChild(s)},this),this._.itemCache=t},CLASS}),define("app/views/shelf/journey-timeline",["require","common","shibui/src/view","app/views/account/library-colors","app/views/core/tag-line"],function(e){var t=e("common"),i=e("shibui/src/view"),s=i.new(),n=s.prototype,r=e("app/views/account/library-colors"),o=e("app/views/core/tag-line");return n.become=function(e,t){this.acts=t,this._fillOut(this._prepare(),t),e&&APP.coverGuru.colorForCover(e.title(),function(e){
APP.coverGuru.paint(this.dom.root,"cover",e)}.bind(this))},n._layout=function(e){this.dom=this._build("journey-timeline <ul>")},n._fillOut=function(e,i){this._textify(this.dom.root);var s;(new Date).getFullYear();t.each(i,function(e){var t;if(e.createTime&&e.createTime>14e11){var i=new Date(e.createTime),n=this._phrase({date:i,day:"numeric",month:"long",year:"numeric"});n!=s&&(s=n,t=i)}"tagging"==e.type?this._newRow("tag",function(t,i){this._classify(t,"has-smarts",!!e.collation.behavior),this._element({parentNode:t,icon:"timeline-tag"}),this._textify(i,"journey.timeline.act.tag");var s=this._element({link:e.collation.path(),parentNode:i});new o(s).configure({headless:!0}).become({html:e.collation.niceName()})}.bind(this),t):e.markType?this._newRow("mark",function(t,i){this._element({parentNode:t,icon:"timeline-marks"}),this._textify(i,"journey.timeline.mark."+e.markType),this._element({tag:"span",parentNode:i,classes:"journey-timeline-mark-percent",label:"units.percent",substitutions:{N:e.percentageOfBook}}),this._buttonify(t,this._onTapMarkRow.bind(this,e)),this._buttonify(i,this._onTapMarkRow.bind(this,e))}.bind(this),t):e.action&&this._newRow("act",function(t,i){var s=this._element({parentNode:t,classes:"journey-timeline-library"});e.library&&new r(s).become(e.library);var n=e.humanDuration();this._textify(i,{label:"journey.timeline.act."+e.action+(n?".with-time":""),substitutions:{META_TIME:n}})}.bind(this),t)},this)},n._newRow=function(e,t,i){var s=this._element({tag:"li",parentNode:this.dom.root,classes:"journey-timeline-row journey-timeline-row-"+e}),n=this._element({parentNode:s,classes:"journey-timeline-segment"}),r=this._element({parentNode:n,classes:"journey-timeline-rune"}),o=(this._element({parentNode:n,classes:"journey-timeline-stroke"}),this._element({parentNode:s,classes:"journey-timeline-entry"})),a=this._element({parentNode:s,classes:"journey-timeline-gutter"});if(i){var l=this._element({tag:"time",parentNode:a,classes:"journey-timeline-calendar",wrapper:"span",html:this._phrase({date:i,month:void 0,year:void 0}),datetime:i.toISOString()}),c=this._element({tag:"strong",parentNode:l,html:this._phrase({date:i,day:void 0,month:"short",year:i.getFullYear()!=(new Date).getFullYear()?"2-digit":void 0})});SPARK.locale.isEnglish&&(c.innerHTML=c.innerHTML.replace(/ (\d\d)$/," '$1")),this._textify(l,{spoken:{html:this._phrase({date:i})},visual:{html:l.innerHTML}})}return t(r,o),s},n._onTapMarkRow=function(e,i){APP.arena.popover(i.target).build(function(i,s){i._classify(s,"journey-mark-popover"),e.citation&&i._element({parentNode:s,classes:"journey-mark-chapter",html:t.safe(e.citation)});var n=e.quote?t.safe(e.quote):null;if(!n&&e.extentMilliseconds&&(n=i._phrase({label:"journey.timeline.mark.duration",substitutions:{N:Math.ceil(e.extentMilliseconds/1e3)}})),n){var r=i._element({parentNode:s,classes:"journey-mark-quote"}),o=i._element({tag:"span",parentNode:r,html:n});e.color&&o.style.setProperty("background-color",APP.coverGuru.cssColorForRGB(t.hexToRGB(e.color),.6))}e.note&&i._element({parentNode:s,classes:"journey-mark-note",html:t.safe(e.note)}),s.children.length||i._element({parentNode:s,label:"journey.timeline.mark.empty"})})},s}),define("app/views/components/shelf/notice-plank",["require","common","app/views/core/partial","app/views/components/common/cover-3d","shibui/src/components/edit-rail"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/components/common/cover-3d");e("shibui/src/components/edit-rail");return n.become=function(e,i){return this.notification=e,this.options=t.absorb(i,{}),this._fillOut(this._prepare(),e),this},n.refresh=function(){var e=this._prepare(),t="pin"==this.notification.vanishAt;this._classify(this._prepare().root,"is-pinned",t),this._textify(e.actionsLabel,["a11y.breath","a11y.notification-actions"+(t?".pinned":"")])},n._layout=function(e){this._build("notice-plank",{extending:e}," rows","  row-1","   info","    biblio","    notice","   cover","    cover-3d",r,"  row-2","   cta","   actions",{button:!0},"    dateline","    bullet","    actions-label",{access:"spoken"},"    actions-icon",{graphic:"notif-actions",access:"visual"},"    pin-icon",{graphic:"notif-pin",access:"visual"})},n._fillOut=function(e,i){this._textify(e.notice,i.labelNotice()),this._textify(e.cta);var s=t.try(i,"details.titleId");s?(e.cover3d.impart(),APP.titles.produce({titleId:s}).use(function(t,s){if(!s.title)return s.reuse();if(this.options.linkFirstRow){var n=this.options.linkFirstRow;"string"!=typeof n&&(n=i.category.match(/^notify-me/)?s.path():s.journey().path()),this._swapInteractiveElement(e.row1,{link:n}),this._classify(e.row1,"halo"),this._attr(e.row1,"data-halo-states","focus")}this._textify(e.biblio,{html:s.titleWithoutOrphans()}),e.cover3d.become(s)},this),this._classify(e.root,"has-title")):(e.cover3d.extract(),e.row1.href&&(this._swapInteractiveElement(e.row1,{tag:"div"}),this._declassify(e.row1,"halo")),this._textify(e.biblio),this._declassify(e.root,"has-title"),this._swapElement(e.actions,{tag:"div"}),this._declassify(e.actions,"halo"),e.actions.removeChild(e.actionsLabel),e.actions.removeChild(e.actionsIcon),this.notification.isDismissable()&&this._element({icon:"notif-dismiss",parentNode:this._element({button:this._onTapDismiss.bind(this),spoken:"notice-actions.dismiss",parentNode:e.actions})})),this._textify(e.dateline,{date:new Date(i.createdAt),month:"short",year:void 0}),this._classify(this.dom.bullet,"hide",!i.isDismissable()),this._classify(this.dom.dismiss,"hide",!i.isDismissable()),t.each(i.actions||[{}],function(s,n){"view-journey"!=s.id&&(this._element({button:this._performAction.bind(this,i,s.id),parentNode:e.cta,label:i.labelAction(s.id).label}),t.breakIteration())},this),this.refresh()},n._performAction=function(e,t){"notifier-repair"==e.id?APP.interviews.go("interview/configure/notifications"):"card-expired"==e.category?APP.interviews.go("interview/authenticate/card",{card:e.card()}):"cards-expired"==e.category?APP.nav.go("interview/authenticate/verify-cards"):APP.notifier.performNotificationAction(e,t)},n._onTapActions=function(e){var i,s=function(){t.try(i,"minimize()"),this.refresh()}.bind(this);i=APP.interviews.dialog("tutorial/notice-actions",{notice:this.notification,callback:s}).present()},n._onTapDismiss=function(e){this.notification.dismiss()},s}),define("app/views/core/cover-box",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.become=function(e,i){this.options=t.absorb(i,{});var s=this._prepare(),n={button:this.options.button,link:this.options.link,"data-halo-delegate":s.press.id};if(this._swapInteractiveElement(s.root,n),this._classify(s.root,"halo",!(!n.button&&!n.link)),n.button||n.link){var r=this.options.label||APP.coverGuru.altText(e,!0),o=this.options.description||"a11y.cover-action.title-details";"string"==typeof r&&(r={label:r}),"string"==typeof o&&(o={label:o}),r.wrapper=o.wrapper=!1,this._textify(s.label,r),this._textify(s.description,o),this._declassify(s.label,"hide"),this._declassify(s.description,"hide"),this._attr(s.root,"aria-labelledby",s.label.id),this._attr(s.root,"aria-describedby",s.description.id)}else this._textify(s.label),this._textify(s.description),this._classify(s.label,"hide"),this._classify(s.description,"hide"),this._attr(s.root,"aria-labelledby",null),this._attr(s.root,"aria-describedby",null);e!=this.title&&(this.title=e,this._declassify(s.root,"is-loaded is-error"),this._attr(s.clip.firstChild,"src")&&(this._attr(s.clip.firstChild,"src",null),this._attr(s.clip.firstChild,"data-cover-id",null),s.press.style.removeProperty("background-color")),e.use(function(t){for(e.title&&e.format||e.reuse(),this._fillOutDuration(e.format||"book",e.humanDuration());s.clip.children.length&&(1!=s.clip.children.length||"IMG"!=s.clip.firstChild.tagName);)s.clip.removeChild(s.clip.firstChild);s.clip.firstChild||this._element({tag:"img",parentNode:s.clip,loading:"lazy"}),APP.coverGuru.applyCoverToImage(e,s.clip.firstChild,{cloneIfPossible:this.options.cloneIfPossible,composeOnError:!0,onLoad:this._classify.bind(this,s.root,"is-loaded",!0),onError:this._onImageError.bind(this,e),onColor:function(e){this._dispatch("color",{rgb:APP.coverGuru.rgbForColor(e)}),APP.coverGuru.paint(s.root,"cover",e,{delay:1})}.bind(this)})},this))},n.reset=function(e){e=e||this._semaphore("format"),this.title=null,this._swapInteractiveElement(this.dom.root,{}),this._declassify(this.dom.root,"is-loaded"),this._declassify(this.dom.root,"halo"),this._attr(this.dom.clip.firstChild,"src")&&(this._attr(this.dom.clip.firstChild,"src",null),this._attr(this.dom.clip.firstChild,"data-cover-id",null),this.dom.press.style.removeProperty("background-color")),this._fillOutDuration(e),this._textify(this.dom.label),this._textify(this.dom.description)},n.zoomable=function(e){e?APP.arena.dom.coverZoom.attach(this,this.dom.clip,this.title):APP.arena.dom.coverZoom.detach(this)},n._layout=function(e){this._build("cover-box",{extending:e}," label",{access:"spoken",labeling:"root"}," description",{access:"spoken",describing:"root"}," press",{id:!0},"  clip","   <img>",{loading:"lazy"})},n._fillOutDuration=function(e,t){if(this._semaphore("format",e),"audiobook"==e||"video"==e){this.dom.icon=this.dom.icon||this._icon("fmt-with-span",this.dom.root,{classes:"cover-box-duration"});var i=this.dom.icon.querySelector("b"),s=this.dom.icon.querySelector("span");this._textify(i),this._icon("fmt-"+e,i),this._textify(s,{html:t||""})}else this.dom.icon&&(this.dom.icon.parentNode.removeChild(this.dom.icon),delete this.dom.icon)},n._onImageError=function(e,t){this._classify(this.dom.root,"is-loaded is-error")},s}),define("app/views/components/tags/tag-plank",["require","common","app/views/core/partial","app/views/core/tag-line","app/views/core/cover-box"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/core/tag-line"),o=e("app/views/core/cover-box");return n.$init=function(e,t){return this.disposition=t,i.prototype.$init.call(this,e)},n.become=function(e,i){this.tag=e,this.options=t.absorb(i,{});var s=this._prepare();if(s.tagLine.become(this.tag),this.options.countGraphic)this._textify(s.count),this._element({graphic:this.options.countGraphic,parentNode:s.count});else{var n=e.totalTaggings,r={wrapper:!1,spoken:{label:"tag.titles.count",substitutions:{COUNT:n}}};n<=9999?r.number=n:n<=99999?r.html=t.smoothFloat(n/1e3,1)+"k":r.html=Math.floor(n/1e3)+"k",this._textify(s.count,r)}this.tag.behavior?(this._classify(this.dom.root,"has-smarts"),this._textify(s.behavior,{label:"tag.behavior.smart.with-key",substitutions:{TAG_BEHAVIOR:this._phrase("tag.behavior.smart."+this.tag.behavior.key)}})):(this._declassify(this.dom.root,"has-smarts"),this._textify(s.behavior,"tag.behavior.regular"));var o=t.safe(e.description||"");o||"always"!=this.options.describe||(o=this._phrase({label:"tagging.created",substitutions:{CREATE_TIME:e.createTime}})),this._textify(s.description,{html:o});var a=t.select(this._.coverBoxes,function(e){if(e.extract())return e}),l=t.try(i,"titles")||t.select(this.tag.collate({sort:"newest"}),function(e){return e.title});return l=l.slice(0,a.length).reverse(),t.each(l,function(e){var t=a.pop();t.impart(),t.become(e)},this),this},n.refresh=function(){this.become(this.tag,this.options)},n._layout=function(e){"toggle"==this.disposition?(this._build("tag-plank .is-toggle",{extending:e}," col-1","  row-1","   tag-line",r,"   circle",{access:"visual"},"    checkmark",{graphic:"tick"},"  row-2","   behavior <p>","   description <p>"," col-0",{skip:"toggle"!=this.disposition},"  cover-mask",{access:"visual"},"   cover-box",o,"  count"),this._.coverBoxes=[e.coverBox]):(this._build("tag-plank",{extending:e}," row-1","  tag-line",r,"  count"," row-2","  behavior <p>","  description <p>"," row-3","  cover-box-1",o,"  cover-box-2",o,"  cover-box-3",o),this._.coverBoxes=[e.coverBox1,e.coverBox2,e.coverBox3])},s}),define("text!shibui/svg/tick.svg",[],function(){return"<svg viewBox='0 0 64 64' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'>\n  <g stroke='#000000' stroke-width='5' fill='none' fill-rule='evenodd' stroke-linecap='round' class='icon-hollow'>\n    <path d='M15,38.0591818 L25.2922068,47.7559046 C25.6913541,48.1319581 26.2730601,48.0725291 26.5945962,47.6187735 L49,16' />\n  </g>\n</svg>\n"}),define("shibui/src/components/form-switch",["require","common","./form-control","shibui/src/haptics","text!shibui/svg/tick.svg"],function(e){var t=e("common"),i=e("./form-control"),s=i.new(),n=s.prototype,r=e("shibui/src/haptics");return n._graphic("tick",e("text!shibui/svg/tick.svg")),n.switch=function(e){var t=this._prepare().control;"undefined"==typeof e?t.checked=!t.checked:t.checked=!!e},n.switchOn=function(){this.switch(!0)},n.switchOff=function(){this.switch(!1)},n.isOn=function(){return!!this._prepare().control.checked},n.isOff=function(){return!this.isOn()},n._layout=function(e){i.prototype._layout.apply(this,arguments);var s={tag:"input",id:!0,attributes:t.absorb(this.options.attributes,{type:"checkbox",name:this.options.name,value:this.options.value,checked:this.options.isOn?"checked":null})};this._classify(e.root,"shibui-form-switch"),this._build("",{extending:e,element:e.core,extensionClass:"shibui-form-switch"}," target","  control",s,"  face",{id:!0},"   tick",{icon:"tick"}),this._attr(e.control,"data-halo-delegate",e.face.id),this.options.disabled&&this.disable()},n._onChangeControl=function(e){this._defer(r.impact.bind(r,"light")),i.prototype._onChangeControl.apply(this,arguments)},n._fieldEventData=function(){var e=this.isOn();return{field:this,on:e,off:!e}},s}),define("shibui/src/components/form-switch-toggle",["require","common","./form-switch"],function(e){var t=(e("common"),e("./form-switch")),i=t.new(),s=i.prototype;return s._layout=function(e){t.prototype._layout.apply(this,arguments),this._classify(e.root,"shibui-form-switch-toggle")},i}),define("app/views/dialogs/dialog-tag-add",["require","common","app/views/core/partial","app/views/components/tags/tag-plank","shibui/src/components/form-switch-toggle","app/views/components/interviews/interview-block"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/components/tags/tag-plank"),o=e("shibui/src/components/form-switch-toggle"),a=e("app/views/components/interviews/interview-block");return n.become=function(e,t){return this.title=e,this.library=t||APP.library,this._fillOut(this._prepare(),e),this},n.present=function(){return this.shade=APP.arena.shade(this,{}),this.shade},n._layout=function(e){var t=!APP.patron.tags.all.length||APP.patron.tags.requiresTutorial();this._build("dialog-tag-add",{extending:e}," new-tag-button",{button:!0},"  new-tag-graphic",{graphic:"map-zoom-in"},"  new-tag-label {tag.add.create-new-tag}"," applied-list"," manual-list"," automatic-list"," remember",{skip:t||APP.patron.tags.all.length<2},"  rem-toggle",{construct:o,with:{label:"tag.add.quick-tagging",explanation:"tag.add.quick-tagging.explanation"}}," tutorial",{skip:!t},"  interview-block",a),e.remToggle&&(e.remToggle.switch(!!APP.patron.choice("tag-add:quick")),e.remToggle.on("form:field:change",this._onChangeRemember.bind(this)))},n._listen=function(e,t){t.dismissToggle&&this._handle("form:field:change",t.dismissToggle)},n._fillOut=function(e,i){this._textify(e.appliedList),this._textify(e.manualList),this._textify(e.automaticList),t.each(APP.patron.tags.collate({sort:"activity"}),function(s){t.among(t.try(s.behavior,"key"),"borrowed","sampled")?this._rowForTag(s,e.automaticList,i):t.among(s,i.tags.all)?this._rowForTag(s,e.appliedList,i):this._rowForTag(s,e.manualList,i)},this),e.interviewBlock&&e.interviewBlock.become("tutorial/what-are-tags",{title:this.title,library:this.library}),APP.haptics.prepare()},n._requiresTutorial=function(){return!APP.patron.tags.all.length||APP.patron.tags.requiresTutorial()},n._rowForTag=function(e,i,s){var n=this._build("dialog-tag-add-item",{parentNode:i}," button",{button:this._onToggleTagForTitle.bind(this,e,s),access:{role:"checkbox"},"data-halo-states":"focus"},"  plank",{construct:r,with:"toggle"});n.plank.become(e);var o=t.among(e,s.tags.all);return this._attr(n.button,"aria-checked",o?"true":"false"),n},n._onToggleTagForTitle=function(e,i,s){s.currentTarget.classList.toggle("is-added");var n=t.among(e,i.tags.all);n?(e.removeFromTitle(this.title),this._attr(s.currentTarget,"aria-checked","false"),this._rememberTag(null)):(e.addToTitle(i,this.library),this._attr(s.currentTarget,"aria-checked","true"),this._rememberTag(e));var o=this._findViewWithin(s.currentTarget,r);o&&o.become(e),APP.haptics.select()},n._onTapNewTagButton=function(e){APP.interviews.dialog("configure/tag-name",{title:this.title,library:this.library,chooseBehavior:!1,callback:function(e){this._rememberTag(e.tag),t.try(APP.arena.activeShade,"minimize()")}.bind(this)}).present()},n._rememberTag=function(e){APP.patron.tags.lastAppliedUUID=t.try(e,"uuid")},n._onChangeRemember=function(e){APP.patron.choose("tag-add:quick",e.m.on)},s}),define("app/views/core/title-partial",["require","common","app/views/core/partial","app/views/components/library/library-logo","app/views/core/tag-line","app/views/dialogs/dialog-tag-add"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/components/library/library-logo"),o=e("app/views/core/tag-line"),a=e("app/views/dialogs/dialog-tag-add");return n.ACTIONS={},n.become=function(e,i){if(!e)throw"[TITLE-PARTIAL] no title supplied";return this.title=e,this.options=t.absorb(i,{}),this.provenance=this.options.provenance||(this.options.possessions||this.options.collation?"shelf":"library"),this._fillOut(this._prepare(),this.title),this.title.use(this.refresh.bind(this)),this._semaphore("title",this.title.titleId),this},n.refresh=function(){if(this._defer("refresh"),!this.title||!this.options)return!1;var e=this.isInDocument();if(!this._.wasInDocument||e){e&&(this._.wasInDocument=!0);var i=!1,s=function(e,i){if(t.isList(e)&&t.isList(i)){if(e.length!=i.length)return!1;for(var s=0,n=e.length;s<n;++s)if(e[s]!==i[s])return!1;return!0}if(e===i)return!0},n=this._discoverPossessions(this.title,this.options);i=i||!s(n,this.possessions),this.possessions=n;var r=this._discoverPrincipal(this.title,this.possessions);i=i||!s(r,this.principal),this.principal=r;var o=this._specify(this.title,this.options),a=JSON.stringify(o);return i=i||a!=this._.specString,i&&(this._executeSpecification(this._prepare(),o,this.title,this.principal),this._.spec=o,this._.specString=a,t.each(this.dom,function(e,i){t.try(i,"refresh()")}),this.access(),this._dispatch("refresh")),i}},n._discoverPossessions=function(e,t){var i=[];if(t.possessions)i=t.possessions.slice(0);else if(t.collation)i=t.collation.filter({"title.titleId":e.titleId});else{var s=APP.patron.loans.filter({"title.titleId":e.titleId}),n=APP.patron.holds.filter({"title.titleId":e.titleId}),r=APP.patron.extras.filter({"title.titleId":e.titleId});i=s.concat(n).concat(r)}return this._sortPossessions(i)},n._discoverPrincipal=function(e,t){var i=t[0];return i&&!this._isPossessionForAnotherLibrary(i)?i:e},n._sortPossessions=function(e){var i=["loan","hold","tagging"];if(e.sort(function(e,t){if("hold"==e.type&&e.isAvailable)return-1;if("hold"==t.type&&t.isAvailable)return 1;var s=i.indexOf(e.type)+1||1/0,n=i.indexOf(t.type)+1||1/0;if(s!==n)return s-n;if("loan"==e.type&&"loan"==t.type)return t.expireTime-e.expireTime;if("hold"==e.type&&"hold"==t.type){var r=e.holding(),o=t.holding();if(r.isAvailable||r.isOnlyAvailableAsLuckyDayLoan())return-1;if(o.isAvailable||o.isOnlyAvailableAsLuckyDayLoan())return 1;var a=e.isSuspended(),l=t.isSuspended();return!a&&l?-1:a&&!l?1:r.estimatedWaitInDays()-o.estimatedWaitInDays()}return e.createTime-t.createTime}),"library"==this.provenance){var s=this._library();e.sort(function(e,i){var n=t.try(e,"card.library.websiteId")==s.websiteId,r=t.try(i,"card.library.websiteId")==s.websiteId;return n&&!r?-1:r&&!n?1:0})}return e},n._fillOut=function(e,t){},n._specify=function(e,t){var i=this._newSpecification(e);return this.principal==e?this._specifyForTitle(i,e):"loan"==this.principal.type?this._specifyForLoan(i,this.principal):"hold"==this.principal.type?this._specifyForHold(i,this.principal):"magazine"==this.principal.type?this._specifyForMagazine(i,this.principal):"tagging"==this.principal.type&&this._specifyForTagging(i,this.principal),i},n._newSpecification=function(e){var i={actions:[],meta:{title:e.titleWithoutOrphans(),attribution:e.attribution(),coverColor:t.try(e,"cover.color")},keys:[e.titleId]};return i.meta.title&&i.meta.attribution||e.reuse(this.refresh,this),t.each(this.possessions,function(e){i.keys.push(e.psnKey)}),i},n._specifyForTitle=function(e,t){},n._specifyForLoan=function(e,t){},n._specifyForHold=function(e,t){},n._specifyForMagazine=function(e,t){this._specifyForTitle(e,t.title)},n._specifyForTagging=function(e,t){var i=this._library();i?i.use(function(s){i.key()||i.reuse(this.refresh,this),this._specifyForTitle(e,t.title)},this):this._specifyForTitle(e,t.title)},n._handleExclusions=function(e,i){return i?(t.each(e.splice(0),function(t,s){if(t){var n=t.split(",");i.indexOf(n[0])>=0||e.push(t)}},this),e):e},n._executeSpecification=function(e,t,i,s){},n._specTitleBiblio=function(e){return{format:e.format,title:e.titleWithoutOrphans(),attribution:e.attribution(),action:this._specTitleDetails(e)}},n._specTitleCover=function(e,i){var s={format:e.format,coverURL:APP.coverGuru.coverURLForTitle(e)};return"library"==this.provenance?s.action=this._specTitleDetails(e):e.parentMagazineId?s.action=this._specMagazineOpen(e):"loan"==this.principal.type?s.action=this._specTitleOpen(e):s.action=this._specTitleDetails(e),s.zoomable=!!t.try(i,"zoomable"),s},n._specTitleDetails=function(e){return"title-details,"+e.format+","+e.titleId},n._specTitleCirc=function(e){var i;return this._withBestCircAction(e,function(e){i="borrow"==e.action?t.compact(["title-circ","borrow",e.libraryKey||null]).join(","):"lucky-day"==e.action?t.compact(["title-circ","borrow","lucky-day",e.libraryKey||null]).join(","):"hold"==e.action?t.compact(["title-circ","hold",e.libraryKey||null]).join(","):"scanning"==e.status?"title-circ,scanning":"failed"==e.status?"title-circ,scanning,failed":"title-circ,unowned"}.bind(this)),i},n._specTitleOpen=function(e,t){if(e.parentMagazineId)return this._specMagazineOpen(e);if(t=t||this._possessionForAnyLibrary("loan"))return this._specLoanOpen(t);var i="title-sample,pending",s=this._fulfiller();return s?s.use(function(t){t.isIdeal||t.isBroken?i=s.hasSample()?"title-sample,"+e.format:e.isPrerelease?"title-sample-unavailable,prerelease":"title-sample-unavailable":s.reuse(this.refresh,this)},this):i="title-sample-unavailable",i+","+e.titleId},n._specTitleTags=function(e){var i=[];return e.tags.use(function(e,s){return e.isIdeal?void t.each(s.all,function(e){i.push(e.uuid)}):(i.push("fetching"),s.reuse(this.refresh,this))},this),this._refreshOn("tag:update:all"),["title-tags",i.join("-")].join(",")},n._specTitlePrerelease=function(e){var i;return this._withBestCircAction(e,function(s){t.among(s.action,"borrow","hold","lucky-day")?i="prerelease,"+e.publicationTime:"unowned"==s.action&&(i="prerelease,"+e.publicationTime+",unowned")}.bind(this)),i},n._specMagazineOpen=function(e){var i=t.try(e,"card.advantageKey");return i||this._withBestCircAction(e,function(e){i||"borrow"!=e.action?"unowned"==e.action&&(i=null):!e.holding._exactCards()[0]&&t.try(e.holding._library(),"allowAnonymousSampling")||(i=e.holding.libraryKey)}.bind(this),{libraries:{scope:APP.libraries.withCards(),fallback:this._library()}}),i?["magazine-open",e.titleId,i].join(","):null===i?"title-sample,magazine,unowned":"title-sample,magazine"},n._specLoanOpen=function(e){var t=e.fulfiller.defaultFulfillmentType();return["loan-open",t,e.psnKey].join(",")},n._specLoanReadWith=function(e){if(!(e.fulfiller.fulfillments.length<=1))return["loan-open","choose",e.psnKey].join(",")},n._specLoanReturn=function(e){var t=["loan-return"];return e.isWithinReturnWindow()?e.holding()&&e.holding().use(function(i,s){if(!i.isIdeal&&!i.isBroken)return t.push("pending"),s.reuse(this.refresh,this);var n=s.numberOfHoldsByOthers();if(n&&e.isOpenedRecently()&&!e.isLuckyDayLoan){var r=s.copiesOwned||1;t.push("wait-list-"+Math.ceil(n/r))}},this):t.push("too-early"),t.push(e.psnKey),t.join(",")},n._specLoanRenew=function(e){var t=["loan-renew"];return e.isLuckyDayLoan&&t.push("lucky-day"),e.isWithinRenewalWindow()?e.holding()&&e.holding().use(function(e,i){return e.isIdeal||e.isBroken?void(i.hasPeopleWaiting()&&t.push("wait-list")):(t.push("pending"),i.reuse(this.refresh,this))},this):t.push("too-early"),t.push(e.psnKey),t.join(",")},n._specWhisperer=function(e){if(e&&["loan","hold"].indexOf(e.type)>=0){if("library"==this.provenance)return"whisperer,shelf,"+e.type;if(this.options.whispers){var i=APP.shelfAnalyst.diagnose(e);if(!i)return;if(!t.among(i.split(",")[0],this.options.whispers))return;return"whisperer,"+i}}},n.ACTIONS["title-circ,scanning"]=function(){return{tag:"span",label:"dot-dot-dot",wrapper:!1}},n.ACTIONS["title-circ,borrow"]=function(e){var t="request";return e&&(t+="?key="+e),{label:"action.title.borrow",link:this._linkTo("title",t)}},n.ACTIONS["title-circ,borrow,lucky-day"]=function(e){var t=this.ACTIONS["title-circ,borrow"].call(this,e);return t},n.ACTIONS["title-circ,hold"]=function(e){return{label:"action.title.hold",link:this._linkTo("title","request?key="+e)}},n.ACTIONS["wait-estimate"]=function(e){return{button:this._presentAvailabilityDialogForTitle.bind(this,{},{}),html:function(t){var i=this._holding(this.title,this.principal);this._textify(t,i.estimatedWaitInWords(e))}.bind(this)}},n.ACTIONS["title-circ,unowned"]=function(e){return{label:"tag.behavior.smart.notify-me",button:this._presentNotifyMeTutorialForTitle.bind(this,"title-unowned-notify-me")}},n.ACTIONS["title-details"]=function(e){return{label:"action.title.details",indicator:{html:function(e){new r(e).become(this._library()),this._classify(e,"library-logo-indicator")}.bind(this)},link:this._linkTo("title")}},n.ACTIONS["title-sample,pending"]=function(){return{tag:"span",label:"dot-dot-dot",wrapper:!1}},n.ACTIONS["title-sample"]=function(e){return{label:"action.sample."+e,button:function(e){this._fulfiller().open({offlinePromptTarget:this.target||e.target})}.bind(this)}},n.ACTIONS["title-sample-unavailable"]=function(e){var t;return e&&(t=this._phrase({label:"action.sample.unavailable."+e,okIfMissing:!0})),t||(t=this._phrase({label:"action.sample.unavailable"})),{html:t,button:function(e){APP.arena.popover(this.target||e.target).notice({label:"action.explanation.sample-unavailable"})}}},n.ACTIONS["title-series"]=function(){return{label:"action.title.series",button:this._presentSeriesDialogForTitle.bind(this)}},n.ACTIONS["title-share"]=function(){return{label:"journey.action.share",button:this._presentShareOptionsForTitle.bind(this)}},n.ACTIONS["title-tags"]=function(e){return{html:function(t){if(this._classify(t,"is-fetching","fetching"==e),e&&"fetching"!=e){var i=this._findViewWithin(t,o)||new o(this._emptyElement(t));i.become(this.title)}else t.querySelector(".tag-button-icon")||(this._element({tag:"span",parentNode:this._emptyElement(t),label:"action.tag",wrapper:!1}),this._element({parentNode:t,graphic:"tag-button",classes:"tag-button-icon"}))}.bind(this),button:this._autoApplyTagOrPresentTagDialogForTitle.bind(this),classes:"tag-button"}},n.ACTIONS["reading-journey"]=function(){return{label:"journey.action.view",link:this._linkTo("journey")}},n.ACTIONS["magazine-open"]=function(e,i){return{label:"action.loan.open.magazine",button:function(e){this.title.reportingContext=t.try(this.options.list,"params.reportingContext()");var s=this._fulfiller(APP.libraries.withKey(i));s.open({libraryKey:i,fftType:"bifocal",offlinePromptTarget:this.target||e.target})}.bind(this)}},n.ACTIONS["magazine-issues"]=function(){var e=this.ACTIONS["title-series"].apply(this,arguments);return e.label+=".issues",e},n.ACTIONS["magazine-subscribe"]=function(){return{html:function(e){this._textify(e);var i,s=this._element({tag:"span",parentNode:e}),n=function(){var e=APP.patron.magazines.isSubscribed(this.title);e!==i&&(i=e,t.DataClass.set(s,"action-subscribe",e?"off":"on"),this._textify(s,e?"action.unsubscribe":"action.subscribe"))}.bind(this);n();var r=APP.events.on("tag:subscriptions",function(e){return t.isInDOM(s)?void n():APP.events.off(r)})}.bind(this),button:this._presentNotifyMeTutorialForTitle.bind(this,"title-subscribe")}},n.ACTIONS["loan-open"]=function(e,t){var i=APP.patron.loans.find({psnKey:t});if(!i)return{label:"action.title.unowned"};var s={button:function(t){i.fulfiller.open({fftType:e,offlinePromptTarget:this.target||t.target})}.bind(this)};return s.label="action.loan.open."+(e||i.title.format||"bifocal"),"bifocal"==e&&(i.fulfiller.fulfillments.length<=1||"bifocal"==APP.summoner.daemons.fulfillmentChoices.preference(i.title.format))&&(s.label="action.loan.open."+(i.title.format||"bifocal")),s},n.ACTIONS["loan-return"]=function(){var e=Array.prototype.slice.call(arguments),i=APP.patron.loans.find({psnKey:e.pop()});if(i){var s={label:"action.loan.return",link:this._linkTo(i,"return")};return t.each(e,function(e){var t=e.match(/^wait-list-(\d+)/);if(t){var i=parseFloat(t[1]),n="shelf.whisperer.loan.waiting";s.indicator={label:n,substitutions:{HOLDS:i}}}else"too-early"==e?(s.icon="hourglass",s.classes="subtle"):"pending"==e&&(s.indicator={label:"dot-dot-dot"})}),s}},n.ACTIONS["loan-renew"]=function(){var e=Array.prototype.slice.call(arguments),t=APP.patron.loans.find({psnKey:e.pop()});if(t)return{label:"action.loan.renew",link:this._linkTo(t,"renew")}},n.ACTIONS["loan-renew,pending"]=function(){var e=this.ACTIONS["loan-renew"].apply(this,arguments);return t.absorb({indicator:{label:"dot-dot-dot"}},e||{}),e},n.ACTIONS["loan-renew,wait-list"]=function(){var e=this.ACTIONS["loan-renew"].apply(this,arguments);return t.absorb({indicator:{label:"action.loan.renew.wait-list"}},e||{}),e},n.ACTIONS["loan-renew,too-early"]=function(){var e=this.ACTIONS["loan-renew"].apply(this,arguments);return t.absorb({icon:"hourglass",classes:"subtle"},e||{}),e},n.ACTIONS["loan-renew,lucky-day"]=function(){var e=Array.prototype.slice.call(arguments),i=e.pop(),s=e.pop(),n=this.ACTIONS["loan-renew"].call(this,i);return t.absorb({icon:"shamrock",iconClasses:"lucky-day-shamrock-icon",classes:"too-early"==s?"subtle":null},n||{}),n},n.ACTIONS["title-circ,borrow-hold"]=function(e){var t=Array.prototype.slice.call(arguments),i=APP.patron.holds.find({psnKey:t.pop()});if(i)return{label:"action.title.borrow",link:this._linkTo(i,"borrow")}},n.ACTIONS["hold-cancel"]=function(e){var t=Array.prototype.slice.call(arguments),i=APP.patron.holds.find({psnKey:t.pop()});if(i)return{label:"action.hold.cancel",link:this._linkTo(i,"cancel")}},n.ACTIONS["hold-suspend"]=function(e){var t=Array.prototype.slice.call(arguments),i=APP.patron.holds.find({psnKey:t.pop()});if(i){var s,n=i.suspendedDaysRemaining();return n&&(s={label:"units.days",substitutions:{N:n}}),{label:"action.hold.suspend"+(n?"ed":""),indicator:s,link:this._linkTo(i,"suspend")}}},n.ACTIONS["hold-redeliver"]=function(e){var t=Array.prototype.slice.call(arguments),i=APP.patron.holds.find({psnKey:t.pop()});if(i){var s=i.redeliveryDate(),n={};return n.label="action.hold.redeliver"+(s?"ing":""),n.link=this._linkTo(i,"redeliver"),s&&(n.indicator={label:"units.date.relative-to-today",substitutions:{DATE:s}}),n}},n._differs=function(e,i){var s=t.try(e,i),n=t.try(this._.spec,i);return"string"!=typeof s&&(s=JSON.stringify(s)),"string"!=typeof n&&(n=JSON.stringify(n)),s!==n},n._executeBiblioSpec=function(e,i){this._linkify(e.action,this._action(i.action).link),this._attr(e.action,"aria-label",this._phrase({
label:"a11y.title.biblio",substitutions:{FORMAT:i.format,TITLE:i.title,AUTHOR:i.attribution}}).replace(/&nbsp;/g," ")),this._textify(e.title,{html:i.title}),this._textify(e.actionDescription,{label:"a11y.cover-action."+i.action.replace(/,.*/,""),okIfMissing:!0,wrapper:!1});var s=[];t.each(this.title.authors(),function(e,t){var i=this.title.creatorList(this._library(),e).path();i="/"+i.replace(/^\//,""),s.push('<a href="'+i+'">'+e.name+"</a>")},this),this._textify(e.author,{html:this._phrase({list:s,style:"narrow"})}),e.author.children.length||this._textify(e.author,{html:i.attribution})},n._executeCoverSpec=function(e,t,i){var s=this._action(t.action)||{};s.label=APP.coverGuru.altText(i,!0),t.action&&(s.description={label:"a11y.cover-action."+t.action.replace(/,.*/,""),okIfMissing:!0}),e.coverBox.become(i,s),e.coverBox.zoomable(!!t.zoomable)},n._showPrereleaseInfo=function(e,i,s){var n={parentNode:e,label:"title.prerelease"};"unowned"==s[2]&&(n.label+=".unowned");var r=t.epochMilliseconds();if(i.publicationTime>r){var o=Math.max(r+160704e5,new Date((new Date).getFullYear(),11,32).getTime()),a=new Date((new Date).getFullYear()+1,11,32).getTime();i.publicationTime<o?(n.substitutions={DATE:i.publicationDate()},n.substitutionTags=!0):i.publicationTime<a&&(n.substitutions={DATE:new Date(i.publicationTime).getFullYear()})}return this._element(n)},n._action=function(e){if(e)for(var t=e.split(","),i=[];t.length;){var s=this.ACTIONS[t.join(",")];if(s)return s.apply(this,i);i.unshift(t.pop())}},n._rowAsAction=function(e,i){if(!e)return APP.journal.warn("[TITLE-TILE] no row for act",i);if(i){i=t.absorb(i,{});var s=t.excise(i,"link")||t.excise(i,"button"),n=t.try(e.firstChild,"childNodes"),r=t.excise(i,"html"),o=t.excise(i,"icon"),a=t.excise(i,"underline"),l=t.excise(i,"indicator"),c=t.absorb(i,{parentNode:e});"string"==typeof s?c.link=s:"function"==typeof s&&(c.button=s);var h;!s&&e.firstChild&&"function"==typeof r?(h=e.firstChild,r(h)):(this._textify(e),h=this._element(c),"string"==typeof r?this._textify(h,{html:r}):"function"==typeof r&&(t.each(n,function(e){h.appendChild(e)}),r(h))),o&&this._element({parentNode:h,icon:o,classes:t.excise(i,"iconClasses")}),l&&this._addIndicator(h,l),this._addUnderline(e,a)}else this._textify(e)},n._addIndicator=function(e,i){if(i){var s=e.querySelector("a, button")||e,n=i.classes||"action-indicator",r=this._tag("span",s,n.trim());"function"==typeof i.html?i.html(r):this._textify(r,t.absorb(i,{wrapper:!1}))}},n._addUnderline=function(e,t){},n._linkTo=function(e,i,s){if("journey"==e)return this.title?this.title.journey().path():(APP.journal.warn("[TITLE-PARTIAL] _linkTo -- journey title not found"),"#");var n;if(e&&"string"!=typeof e?(n=e,e=n.type||"title"):"title"!=e&&(n=this.principal),"title"!=e)if(n&&n.type==e||(n=this._possessionForAnyLibrary(e)),n){if(n.type!=e&&APP.journal.warn("[TITLE-PARTIAL] _linkTo -- principalType mismatch",e,n,i),"function"==typeof n.pathToShelfAction)return n.pathToShelfAction(i)}else APP.journal.warn("[TITLE-PARTIAL] _linkTo -- principal not found",e,i);if(this.title){var r=this._library(),o=t.try(s,"libraryKey");return o&&r.key()!=o?this.title.path(o,i):this.title.path(this.options.list||r,i)}return APP.journal.warn("[TITLE-PARTIAL] _linkTo -- title not found"),"#"},n._library=function(){var e=t.try(this,"options.library");return e=e||t.try(this,"options.list.library"),!e&&t.try(this,"principal.library")&&(e="function"==typeof this.principal.library?this.principal.library():this.principal.library),e||APP.library},n._possessionLibraries=function(){var e=[];return t.each(this.possessions,function(i){var s=t.try(i,"card.library");s&&e.push(s)}),e},n._holding=function(e,t){if(t&&!this._isPossessionForAnotherLibrary(t)){var i=t.holding();if(i)return i}var s=this._library();if(s)return e.holdings.produce({libraryKey:s.key()})},n._fulfiller=function(e){e&&e.websiteId||(e=this._library());var i;return this.title!=this.principal&&(i=t.try(this.principal,"fulfiller"),"function"==typeof i&&(i=i.call(this.principal,e))),i&&i.websiteId&&i.title||(i=this.title.fulfiller(e)),i},n._possessionForAnyLibrary=function(){var e,i=Array.prototype.slice.call(arguments,0);for(i.length||(i=["loan","hold","tagging"]);i.length;){var s=i.shift();if("loan"==s?e=APP.patron.loans.find({"title.titleId":this.title.titleId}):"hold"==s?e=APP.patron.holds.find({"title.titleId":this.title.titleId}):"tagging"==s&&(e=t.try(this.title.tags,"taggings[0]")),e)return e}},n._possessionForAnotherLibrary=function(){var e=this._possessionForAnyLibrary.apply(this,arguments);if(e&&this._isPossessionForAnotherLibrary(e))return e},n._isPossessionForAnotherLibrary=function(e){if("library"==this.provenance){var i=this._library();return t.try(e,"card.library.websiteId")!=i.websiteId}return!1},n._presentAvailabilityDialogForTitle=function(i,s){s=t.absorb(s,{springs:[.5,.8]}),i=t.absorb(i,t.absorb(this.options,{})),i.possessions=[],i.exclusions=["download","possessions","title","blurb"],e(["app/views/dialogs/dialog-manage-possession"],function(e){var t=new e;t.become(this.title,i),t.present(s)}.bind(this))},n._autoApplyTagOrPresentTagDialogForTitle=function(){var e=APP.patron.choice("tag-add:quick")&&APP.patron.tags.find({uuid:APP.patron.tags.lastAppliedUUID});e&&!t.among(e,this.title.tags.all)?e.addToTitle(this.title,this._library()):this._presentTagDialogForTitle()},n._presentTagDialogForTitle=function(){(new a).become(this.title,this._library()).present()},n._presentSeriesDialogForTitle=function(){e(["app/views/library/series-pedestal"],function(e){var t=new e;t.SIZE=96,t.become(this.title,{library:this._library(),mini:!0}),APP.arena.shade(t,{springs:[.5,.8],constrainToContentHeight:!1})}.bind(this))},n._presentShareOptionsForTitle=function(){APP.stasher.shareTitle(this.title)},n._presentNotifyMeTutorialForTitle=function(e,i){i=t.absorb(i,{constrainToContentHeight:!0,springs:[.8]}),APP.interviews.dialog("tutorial/"+e,{title:this.title,library:this._library()}).present(i)},n._countdownToExpiry=function(e,i,s){if(!s||t.isInDOM(e)){var n=i.distanceInTimeToExpiry();"undefined"==typeof n?this._textify(e,"loan.expiry.now"):e.__timeInWords!=n&&(e.__timeInWords=n,this._textify(e,{label:"loan.expiry"+(n?"":".now"),substitutions:{EXPIRE_TIME:n}}))}var r=(i.expireTime||0)-t.epochMilliseconds();if(!(r<=0)){var o=864e5;r<2*o&&(o=36e5),r<2*o&&(o=6e4),r<o&&(o=Math.ceil(r)),t.defer(e,"countdown",this._countdownToExpiry.bind(this,e,i,!0),o)}},n._refreshOn=function(e){var t="refresh:on:"+e;this.handlers[t]||(this.handlers[t]=APP.events.on(e,this.refresh.bind(this)))},n._withBestCircAction=function(e,i,s){var n=t.absorb(s,{debounce:200,libraries:{fallback:this._library()},onUpgraded:function(){return this._defer("refresh",this.refresh.bind(this)),"stop"}.bind(this)});return"library"==this.provenance&&(n.libraries.preferred=this._library()),this.options.scopeToLibraries&&(n.libraries.scope=this.options.scopeToLibraries),e.holdings.withBestCircAction(i,n)},s}),define("app/views/core/lucky-day-shamrock",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.$init=function(e,s){if(this.options=t.absorb(s,{helpLabel:"lucky-day.link-to-help-article",helpURL:APP.constants.URLS["help:skip-the-line"]}),"undefined"==typeof this.options.explanation){if(this.options.loan)this.options.explanation={label:"lucky-day.loan-explanation"};else if(this.options.title&&(this.options.explanation={label:"lucky-day.title-explanation"},this.options.holding)){var n=this.options.holding.estimatedWaitInWords("long");if(n.label.match(/\.weeks$|\.max$/)){var r=n.label.split(".").pop();n.label=this.options.explanation.label+"."+r,this.options.explanation=n}this.options.explanation.enliven={"#hold":this._onTapPlaceHold.bind(this)}}}else"string"==typeof this.options.explanation&&(this.options.explanation={label:this.options.explanation});i.prototype.$init.call(this,e)},n._layout=function(e){this._build("lucky-day-shamrock",{extending:e}," icon",{graphic:"shamrock",access:"visual"}," label",{label:this.options.label,button:!!this.options.explanation&&this._onTapLabel.bind(this)})},n._onTapLabel=function(e){APP.arena.popover(this.dom.icon).choices(function(e,i){e.backButton({label:"lucky-day.list-name"}),this._element(t.absorb(this.options.explanation,{parentNode:i,classes:"popover-explanation"})),e.choice({label:this.options.helpLabel,button:this._onTapHelp.bind(this),icon:"shamrock",iconClasses:"lucky-day-shamrock-icon"})}.bind(this))},n._onTapHelp=function(){APP.shell.openURL(this.options.helpURL)},n._onTapPlaceHold=function(){if(APP.arena.popover().close(),this.options.interview)return this.options.interview.yield("interview/circ/prepare-title",{title:this.options.title,parameters:{key:this.options.holding.libraryKey,action:"hold"}});var e="request?action=hold&key="+this.options.holding.libraryKey;APP.nav.go(this.options.title.path(this.options.list,e))},s}),define("app/views/shelf/shelf-whisperer",["require","common","app/views/core/partial","app/views/core/lucky-day-shamrock"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/core/lucky-day-shamrock");return n.ACTIONS={},n.$init=function(e){this._.container=e,i.prototype.$init.call(this,e)},n.become=function(e,t){this.owner=e;var i=this._action(t);i?(this.impart(this._.container),this._fillOut(i)):this.extract()},n._layout=function(e){e.root.classList.add("shelf-whisperer")},n._fillOut=function(e){var i=this._prepare(),s={parentNode:i.root};e.labelSet?(s.label=e.labelSet,s.button=this._explainAction.bind(this,e.labelSet+".pop",e.labelSet+".confirm",e.onConfirm)):t.absorb(e,s),i.target=this._element(s),t.DataClass.set(i.target,"whisperer-level",e.level||"info")},n.ACTIONS.shelf=function(e){return{label:"shelf.whisperer."+e+"-shelf",link:this.owner.title.journey().path()}},n.ACTIONS["loan-surplus"]=function(){return{labelSet:"shelf.whisperer.loan.surplus-loans",onConfirm:null}},n.ACTIONS["loan-cancel-holds"]=function(){return{labelSet:"shelf.whisperer.loan.cancel-holds",onConfirm:null}},n.ACTIONS["loan-finished"]=function(){return{labelSet:"shelf.whisperer.loan.finished",onConfirm:APP.nav.go.bind(APP.nav,this._linkTo("loan","return"))}},n.ACTIONS["loan-lucky-day"]=function(e){return{html:function(e){new r(e,{label:"lucky-day.loan-whisperer",loan:this.owner})}.bind(this)}},n.ACTIONS["loan-extend"]=function(e){return{level:"warn",labelSet:"shelf.whisperer.loan."+e,onConfirm:APP.nav.go.bind(APP.nav,this._linkTo("loan",e))}},n.ACTIONS["loan-waitlist"]=function(e,t){"string"==typeof e&&(e=parseFloat(e)),"string"==typeof t&&(t=parseFloat(t));var i=Math.ceil(e/t),s={};return s.label="shelf.whisperer.loan.waiting",s.substitutions={HOLDS:i},s.button=this._explainAction.bind(this,{label:"shelf.whisperer.loan.waiting.pop",substitutions:{HOLDS:e,COPIES:t}},"shelf.whisperer.loan.waiting.confirm",APP.nav.go.bind(APP.nav,this._linkTo("loan","return"))),s},n.ACTIONS["hold-borrow"]=function(){var e=this._findCase("hold-borrow");if(e)return{level:"alert",labelSet:"shelf.whisperer.hold.ready",onConfirm:APP.nav.go.bind(APP.nav,this._linkTo(e,"borrow"))}},n.ACTIONS["hold-expand"]=function(){var e=this._findCase("hold-expand");if(e)return{labelSet:"shelf.whisperer.hold.expand"}},n.ACTIONS["hold-found"]=function(){var e=this._findCase("hold-found");if(e)return{level:"alert",labelSet:"shelf.whisperer.hold.found"}},n.ACTIONS["hold-lucky-day"]=function(){var e=this._findCase("hold-lucky-day");if(e)return{level:"lucky",labelSet:"lucky-day.hold-whisperer",onConfirm:APP.nav.go.bind(APP.nav,this._linkTo(e.title,"borrow"))}},n._action=function(e){if(e)for(var t=e.split(","),i=[];t.length;){var s=this.ACTIONS[t.join(",")];if(s)return s.apply(this,i);i.unshift(t.pop())}},n._explainAction=function(e,t,i){APP.arena.popover(this.dom.target||this.dom.root).confirm({warningLabel:e,buttonLabel:t,onSubmit:i})},n._linkTo=function(e,i){var s;if("string"!=typeof e?(s=e,e=s.type||"title"):s="title"==e?this.owner.title:this.owner.principal,s||(APP.journal.warn("[WHISPERER] _linkTo -- principal not found"),s=this.owner.title))return"title"!=e&&s.type!=e&&APP.journal.warn("[WHISPERER] _linkTo -- principalType mismatch"),"title"!=e&&"function"==typeof s.pathToShelfAction?s.pathToShelfAction(i):("function"!=typeof s.path&&s.title&&(s=s.title),"function"==typeof s.path?s.path(t.try(this,"owner.options.list")||t.try(this,"owner.options.library")||t.try(this,"owner.principal.library"),i):(APP.journal.warn("[WHISPERER] _linkTo -- path method not found"),"#"))},n._findCase=function(e){for(var t=APP.shelfAnalyst.cases(e),i=0,s=t.length;i<s;++i)if(t[i].title.titleId==this.owner.title.titleId)return t[i]},s}),define("app/views/components/common/download-ring",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.become=function(e){return this._prepare(),this.possession!==e&&(this.possession=e,this.title=this.possession.title,this._listenForDownloadEvents()),this.refresh()},n.refresh=function(){this.luggage=t.try(this.possession,"luggage()");var e=this.status(),i=t.absorb(e,{});return this._updateStatus(t.excise(i,"status"),i),this._semaphore("status")&&!this.isInDocument()||this._renderDownloadProgressSoon(),e},n.status=function(){if(!this.possession)return{status:"invalid",reason:"uninitialized"};if(!APP.shell.has("rosters"))return{status:"invalid",reason:"unsupported"};if(!this.luggage)return{status:"invalid",reason:"missing-luggage"};if(this.luggage.isDisabledByFulfillmentChoice())return{status:"invalid",reason:"fulfillment-choice",fftType:t.try(this.possession,"fulfiller.defaultFulfillmentType()")};var e=this.luggage.status();return e.isInvalid?{status:"invalid"}:e.isPaused?APP.network.reachable?"bifocal"==e.pauseReasons.join()?this._.bifPaused?{status:"paused",reason:"stop"}:{status:"downloading"}:t.among("wifi",e.pauseReasons)?{status:"paused",reason:"wifi"}:{status:"paused",reason:"stop"}:{status:"paused",reason:"offline"}:e.isStreamed?{status:"streaming"}:e.isDownloading?{status:"downloading"}:t.try(this.luggage.passport(),"urls.web")?{status:"complete"}:{status:"invalid"}},n._layout=function(e){this._swapElement(e.root,{graphic:"download-ring",classes:"download-ring"}),e.circuit=e.root.querySelector(".download-ring-circuit"),this._attr("data-download-progress",0)},n._listenForDownloadEvents=function(){var e=function(e){e.m.title.titleId==this.title.titleId&&this.refresh()}.bind(this);APP.events.off(this.handlers.storageChoice),this.handlers.storageChoice=APP.events.on("luggage:storage:choice",e),APP.events.off(this.handlers.patronChoice),this.handlers.patronChoice=APP.events.on("patron:choice",function(e){e.m.key.match(/^(roster:download-queue|fulfillment:)/)&&this.refresh()}.bind(this)),APP.events.off(this.handlers.networkInfo),this.handlers.networkInfo=APP.events.on("network:info",this.refresh.bind(this)),APP.events.off(this.handlers.passportUpdateAll),this.handlers.passportUpdateAll=APP.events.on("passport:update:all",this._onPassportUpdateAll.bind(this)),APP.events.off(this.handlers.downloadInitialize),this.handlers.downloadInitialize=APP.events.on("luggage:download:initialize",e),APP.events.off(this.handlers.downloadProgress),this.handlers.downloadProgress=APP.events.on("luggage:download:progress:"+this.title.titleId,this._onDownloadProgress.bind(this)),APP.events.off(this.handlers.downloadFinalize),this.handlers.downloadFinalize=APP.events.on("luggage:download:finalize",e),APP.events.off(this.handlers.downloadFailure),this.handlers.downloadFailure=APP.events.on("luggage:download:failure",e),APP.events.off(this.handlers.downloadPause),this.handlers.downloadPause=APP.events.on("bifocal:downloads:pause",function(){this._.bifPaused||(this._.bifPaused=!0,this.refresh())}.bind(this)),APP.events.off(this.handlers.downloadResume),this.handlers.downloadResume=APP.events.on("bifocal:downloads:resume",function(){this._.bifPaused&&(this._.bifPaused=!1,this.refresh())}.bind(this)),APP.events.off(this.handlers.rosterAudit),this.handlers.rosterAudit=APP.events.on("roster:audit",this._deferRefresh.bind(this))},n._updateStatus=function(e,i){this._semaphore("status",e),this._dispatch("status",t.absorb(i,{status:e,title:this.title,possession:this.possession,luggage:this.luggage}))},n._onPassportUpdateAll=function(e){"invalid"==this._semaphore("status")&&this.refresh()},n._onDownloadProgress=function(e){var i=t.try(e,"m.bytes");this._renderDownloadProgressSoon(i),i&&i.downloaded>=i.total&&this._deferRefresh()},n._renderDownloadProgressSoon=function(e){if(!this._.renderStagger){var i=function(){var e=this._.renderStatus||t.try(this.luggage,"status()"),i=t.try(e,"bytes.percent")||0;this._attr("data-download-progress",i);var s=Math.floor(175*(1-i));this.dom.circuit.style.setProperty("stroke-dashoffset",s)}.bind(this);this._.renderStagger=t.staggerInvocation(i,250,500)}this._.renderStatus=e?{bytes:e}:null,this._.renderStagger()},n._deferRefresh=function(e){return"number"!=typeof e&&(e=750),this._defer("refresh",this.refresh.bind(this),e)},s}),define("app/views/core/title-status",["require","common","app/views/core/title-partial","app/views/components/common/download-ring","app/views/account/library-colors"],function(e){var t=e("common"),i=e("app/views/core/title-partial"),s=i.new(),n=s.prototype,r=e("app/views/components/common/download-ring"),o=e("app/views/account/library-colors");return n.ACTIONS=t.absorb(n.ACTIONS,{}),n.tapped=function(e,i,s){if(t.among(this.principal.type,"loan","magazine")){var n=this.principal,r=function(e){APP.haptics.impact("light");var t=n.luggage();return t?t.chooseStorage(e):void APP.journal.warn("[TITLE-STATUS] no luggage to choose storage",e)},o=t.try(this.dom.downloadRing,"refresh()")||{};if(o.status)if("invalid"==o.status&&"unsupported"==o.reason)APP.interviews.dialog("tutorial/browser-download").present();else if("invalid"==o.status&&"fulfillment-choice"==o.reason)APP.arena.popover(this.dom.root).notice("download.disabled."+o.fftType);else if("streaming"==o.status)r("download");else{var a;a="invalid"==o.status?"download.progress.invalid":"downloading"==o.status?"download.progress.downloading":"paused"==o.status?"download.paused."+o.reason:"download.progress.complete";var l=t.try(n.luggage(),"status().bytes.total");APP.arena.popover(this.dom.root).confirm({warningLabel:{label:a,substitutions:{DOWNLOAD_SIZE:l}},buttonLabel:"download.manage.remove",onSubmit:r.bind(this,"stream")})}else this._presentAvailabilityDialogForTitle(i,s)}else{var c=t.try(this._,"spec.status")||"",h=c.match(/^unowned,?(notify-me)?$/);if(h){var u="tutorial/title-unowned"+(h[1]?"-"+h[1]:"");APP.interviews.dialog(u,{title:this.title,library:this._library()}).present()}else this._presentAvailabilityDialogForTitle(i,s)}},n._layout=function(e){this._build("title-status",{extending:e}," download-ring",r," backdrop","  library-colors",o," icon"," badge"),this._semaphore("action","scanning"),this._becomeIcon("scanning")},n._listen=function(e,t){this._handle("status",t.downloadRing)},n._specify=function(e,s){var n=i.prototype._specify.call(this,e,s);return n.status=n.status||"unknown",n.websiteIds=t.compact(n.websiteIds||[]),n},n._specifyForTitle=function(e,t){if("magazine"==this.options.forceType)return this._specifyForMagazine(e,t);var i;this._withBestCircAction(t,function(t){"borrow"==t.action?i="available":"lucky-day"==t.action?i="available,lucky-day":"hold"==t.action?(i="wait-list",e.substitutions={WAIT:this._phrase(t.holding.estimatedWaitInWords())},e.calendar={ahead:t.holding.roundsAhead(),behind:t.holding.roundsBehind()}):i="scanning"==t.status?"scanning":"failed"==t.status?"scanning,failed":this.options.scopeToLibraries?"unowned":"unowned,notify-me",e.status=i,e.websiteIds=[t.websiteId],e.holdingKey=t.libraryKey}.bind(this))},n._specifyForHold=function(e,i){var s=0;t.each(this.possessions,function(e){"hold"==e.type&&(s+=e.holding().acquiredCopies())});var n=i.holding();i.isAvailable?e.status="available,hold":n.luckyDayCopiesAvailable>0?e.status="available,lucky-day":(i.isSuspended()?e.status="wait-list,hold-suspended":(e.status="wait-list,hold",e.substitutions={WAIT:this._phrase(n.estimatedWaitInWords())},e.calendar={ahead:n.roundsAhead(),behind:n.roundsBehind(),position:n.position}),s&&(e.status+=",acquired")),e.holdingKey=n.libraryKey,t.each(this._possessionLibraries(),function(i){t.among(i.websiteId,e.websiteIds)||(e.websiteIds=e.websiteIds||[],e.websiteIds.push(i.websiteId))})},n._specifyForLoan=function(e,i){e.status="borrowed",e.holdingKey=i.holding().libraryKey,t.each(this._possessionLibraries(),function(i){t.among(i.websiteId,e.websiteIds)||(e.websiteIds=e.websiteIds||[],e.websiteIds.push(i.websiteId))})},n._specifyForMagazine=function(e,t){e.status="magazine"},n._executeSpecification=function(e,i,s,n){var r="unknown";if(i.status){this._declassify(this.dom.root,"hide");var o=i.status.split(",").join("-"),a="a11y.title-status."+o;if(this._phrase({label:a,okIfMissing:!0})?r=o:APP.journal.warn("[TITLE-STATUS] unrecognized suffix",o),this.dom.downloadRing&&t.among(n.type,"loan","magazine")){var l=this.dom.downloadRing.become(n);this._updateIconWithDownloadRingStatus(l)}if(this._differs(i,"status")){this._action(i.status);var c=this._phrase({label:"a11y.title-status."+r,substitutions:i.substitutions});this._attr("aria-label",c),this._attr("title",c),this._semaphore("action",r)}var h;t.among(t.try(this.principal,"type"),"loan","hold")&&(h=this.principal.holding()),h=h||s.holdings.produce({libraryKey:i.holdingKey,titleId:s.titleId}),this._dispatch("title-status:spec",{spec:i,suffix:r,holding:h})}else this._classify(this.dom.root,"hide");if(this._differs(i,"websiteIds")){var u=[];t.each(i.websiteIds,function(e){var i=APP.libraries.find({websiteId:e});t.among(i,u)||u.push(i)}),this.dom.libraryColors.become(u)}i.calendar&&this._differs(i,"calendar")&&this._populateCalendar(i.calendar)},n.ACTIONS.unknown=function(){this._becomeIcon("scanning")},n.ACTIONS.scanning=function(){this._becomeIcon("scanning")},n.ACTIONS["scanning,failed"]=function(){this._becomeIcon("scanning")},n.ACTIONS.unowned=function(e){"notify-me"==e?(this._becomeIcon("notify"),this._assignTagBehaviorsData()):this._becomeIcon("scanning")},n.ACTIONS.available=function(e){"lucky-day"==e?this._becomeIcon("available-ld"):this._becomeIcon("available")},n.ACTIONS["wait-list"]=function(e,t){"acquired"==t?this._becomeIcon("wait-list-acq"):this._becomeIcon("wait-list")},n.ACTIONS.borrowed=function(){this.dom.downloadRing.become(this.principal)},n.ACTIONS.magazine=function(){var e=this.principal.luggage;"function"==typeof e&&(e=this.principal.luggage()),e&&this.dom.downloadRing.become(this.principal)},n._becomeIcon=function(e){this._semaphore("icon")!=e&&(this._semaphore("icon",e),this._textify(this.dom.icon),this._textify(this.dom.badge),this._element({icon:"title-status-"+e,parentNode:this.dom.icon}))},n._populateCalendar=function(e){var i=e.ahead+e.behind,s=t.try(this.dom.icon.querySelector(".title-status-dates"),"children");t.each(s,function(t,s){var n="";isFinite(e.behind)?e.position&&s==e.ahead?n="title-status-dates-you":(e.ahead||e.behind)&&s<i&&(n="title-status-dates-other"):n="title-status-dates-unknown",this._attr(t,"class",n||null)},this)},n._onStatusDownloadRing=function(e){this._updateIconWithDownloadRingStatus(e.m)},n._updateIconWithDownloadRingStatus=function(e){var i=this._semaphore("action");"borrowed"==i?"invalid"==e.status&&t.among(e.reason,"unsupported","fulfillment-choice")?this._becomeIcon("streaming"):"streaming"==e.status?this._becomeIcon("streaming-dl"):"complete"==e.status?this._becomeIcon("downloaded"):this._semaphore("icon","downloading"):"magazine"==i&&("streaming"==e.status||"invalid"==e.status?this._becomeIcon("ellipsis"):this._semaphore("icon","downloading"))},n._assignTagBehaviorsData=function(){var e=[];this.title.tags.use(function(i,s){return i.isIdeal?(t.each(s.all,function(i){e.push(t.try(i,"behavior.key"))}),void(APP.patron.magazines.isSubscribed(this.title)&&e.push("notify-me"))):s.reuse(this.refresh,this)},this),e=t.unique(t.compact(e));var i=e.length?e.join(" "):null;this._attr(this.dom.root,"data-tag-behaviors",i),this.handlers.onTagUpdateAll=this.handlers.onTagUpdateAll||APP.events.on("tag:update:all",this._onTagUpdateAll.bind(this))},n._onTagUpdateAll=function(e){this.isInDocument()?this._assignTagBehaviorsData():APP.events.off(t.excise(this.handlers,"onTapUpdateAll"))},s}),define("app/views/components/common/wait-list-summary",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.reset=function(){this._textify(this._prepare().root)},n.become=function(e,i,s){var n=this._prepare(),r={},o=i.copiesOwned||0,a=t.try(s,"hold"),l="title-availability.wait-list-summary.";if(a&&a.isAvailable&&!a.isSuspended()){var c=l+"available",h=t.epochSeconds()-a.createTime/1e3;return r.WEEKS=t.secondsToUnits(h).weeks,(r.REDELIVER_COUNT=t.try(a.redeliverCounts,"automated"))&&(c+=".with-redeliveries"),(r.SUSPEND_COUNT=t.try(a.redeliverCounts,"requested"))&&(c+=".with-suspensions"),(r.ACQUISITION_COUNT=i.acquiredCopies())&&(c+=".with-acquisitions"),this._textify(n.root,{label:c,substitutions:r,wrapper:!1}),!0}if(!i.isPrerelease&&!o){var u={label:l+"unknown"+(a?".hold":""),substitutions:r};return e.talkers(i.libraryKey).use(function(e,i){var s=i.best();"unavailability"==t.try(s,"noteType")&&(r.LIBRARY_NOTE=s.note),this._textify(n.root,t.absorb(u,{})),e.isIdeal||i.reuse()},this),!0}if(!SPARK.locale.isEnglish)return!1;var p=[];a&&t.try(s,"showCreationDate")!==!1&&p.push({label:"hold.created.punctuated",substitutions:{CREATE_TIME:a.createTime}}),a&&(r={POSITION:i.position},i.originalPosition>i.position&&(r.ORIGINAL_POSITION=i.originalPosition),p.push({label:l+"position",substitutions:r})),i.isPrerelease?(r={COPIES:o},p.push({label:l+"prerelease",substitutions:r})):(r={COPIES:o},p.push({label:l+"in-use",substitutions:r}));var d=i.holdsCount||0,m=i.holdsRatio||0;return o<=1||d==Math.round(m)?(r={HOLDS:d},p.push({label:l+"in-total.one",substitutions:r})):(r={HOLDS:d},p.push({label:l+"in-total",substitutions:r}),m>=1?(r={HOLDS:Math.round(m)},p.push({label:l+"per-copy",substitutions:r})):(r={},p.push({label:l+"per-copy.less-than-one",substitutions:r}))),i.isFastlane&&(t.last(p).substitutions.HOLD_LANES=2,t.last(p).enliven={"#fastlane":this._presentFastlanePopover.bind(this)}),r={COPIES:i.acquiredCopies()},r.COPIES&&p.push({html:"<b>"+this._phrase({label:l+"acquisitions",substitutions:r})+"</b>"}),this._textify(n.root,t.select(p,function(e){return{html:this._phrase(e),enliven:e.enliven}},this)),!0},n._layout=function(e){this._build("wait-list-summary",{extending:e})},n._presentFastlanePopover=function(e){var t=APP.arena.popover(e.target);t.choices(function(e,t){e._element({tag:"p",parentNode:t,classes:"popover-explanation",label:"title-availability.wait-list-summary.explain-fastlane",wrapper:!1}),e.choice({label:"title-availability.wait-list-summary.fastlane-help-link",link:APP.constants.URLS["help:fastlane"],wrapper:!1})})},s}),define("app/views/core/title-availability",["require","common","app/views/core/partial","app/views/core/title-status","app/views/components/common/wait-list-summary"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/core/title-status"),o=e("app/views/components/common/wait-list-summary");return n.become=function(e,i,s){this.title=e,this.library=i,this.options=t.absorb(s,{}),this._prepare();var n=!!this.options.interactive;return this._swapInteractiveElement(this.dom.action,{button:n}),this._textify(this.dom.library,{label:"title-availability.at-library",substitutions:{LIBRARY_NAME:this.library.safeName()},substitutionTags:!0,wrapper:!1}),this.dom.icon.become(this.title,{library:this.library,possessions:this._possessionsAtLibrary(this.title,this.library),provenance:"library",scopeToLibraries:[this.library]}),this},n._layout=function(e){this._build("title-availability",{extending:e}," action","  text",{access:{role:"text"}},"   status {title-availability.scanning}","   library",{label:"title-availability.at-library",substitutionTags:!0,wrapper:!1},"   wait-list-summary",o,"  icon",r),e.icon.access("visual")},n._listen=function(){this._handle("title-status:spec",this.dom.icon)},n._onTitleStatusSpecIcon=function(e){var i=e.m.suffix;if(i.match(/^wait-list/)){var s=e.m.holding.estimatedWaitInWords("short-sentence");s.wrapper=!1,this._textify(this.dom.status,s)}else i.match(/^unowned-/)&&(i="unowned"),i.match(/^borrowed-/)&&(i="borrowed"),this._textify(this.dom.status,{label:"title-availability."+i,substitutions:{COPIES_AVAILABLE:e.m.holding.copiesAvailable,COPIES_OWNED:e.m.holding.copiesOwned},wrapper:!1});var n=!1;if(i.match(/^wait-list-/)||"wait-list"==i&&APP.library==this.library?n=this.dom.waitListSummary.become(this.title,e.m.holding,{hold:e.m.holding._hold()}):this.dom.waitListSummary.reset(),this._classify(this.dom.root,"is-summarized",n),this.options.interactive){var r,o,a=e.m.holding.libraryKey,l=a?this.title.path(a,""):null,c=t.try(e.m,"spec.status")||"unowned";if(c.match(/^borrowed/))r=this.dom.icon.tapped.bind(this.dom.icon);else if(c.match(/^wait-list,hold/)){var h=e.m.holding._hold();r=function(e){APP.arena.popover(e.target).choices(function(e){e.choice({label:"action.hold.suspend"+(c.match(/susp/)?"ed":""),link:h.pathToShelfAction("suspend")}),e.choice({label:"action.hold.cancel",link:h.pathToShelfAction("cancel")})})}}else if(c.match(/^wait-list/))o="hold";else if(c.match(/^available,hold/)){var h=e.m.holding._hold();r=APP.nav.go.bind(APP.nav,h.pathToShelfAction("borrow"))}else c.match(/^available/)?o="borrow":c.match(/^unowned/)&&(r=function(e){APP.interviews.dialog("tutorial/title-unowned",{title:this.title,library:this.library}).present()}.bind(this));l&&!r&&o&&(r=function(){o="request?key="+a,APP.nav.go(this.title.path(a,o))}.bind(this)),r?(this._buttonify(this.dom.action,r),this._classify(this.dom.action,"halo"),this.access(this.dom.action,"normal")):(this._unbuttonify(this.dom.action),this._declassify(this.dom.action,"halo"),this.access(this.dom.action,{disabled:!0}))}},n._possessionsAtLibrary=function(e,i){var s={"title.titleId":e.titleId,"library.websiteId":i.websiteId};return t.flatten([APP.patron.loans.filter(s),APP.patron.holds.filter(s)])},s}),define("app/views/components/common/magazine-keep-prompt",["require","common","app/views/core/title-partial"],function(e){var t=e("common"),i=e("app/views/core/title-partial"),s=i.new(),n=s.prototype;return n.become=function(e){this.title=e,this.refresh()},n.refresh=function(){if(!this.title)return this.extract();this.impart(),this.magazine=APP.patron.magazines.find({"title.titleId":this.title.titleId});var e=this._prepare();if(t.try(this.magazine,"isLatestIssueOfSubscription()")){this._textify(e.question,"magazine.keep-prompt.keeping-latest-issue"),this._textify(e.answers);var i=this.magazine.isMarkedAsFinished();this._element({button:this._toggleFinished.bind(this),parentNode:this._element({tag:"p",parentNode:e.answers}),label:"magazine.keep-prompt.answer-mark-as-"+(i?"unfinished":"finished")})}else if(t.try(this.magazine,"expireTime")){var s={},n=this.magazine.expiryDate(),r=new Date((new Date).setHours(24,0,0,0)),o="later-today";if(n>r){s.EXPIRY_DAY=this._dateToDayName(n);var a=this._dateToDayName()==s.EXPIRY_DAY;o=a?"same-day-next-week":"any-other-day"}this._textify(e.question,{label:"magazine.keep-prompt.keeping-until-expiry."+o,substitutions:s});var l=new Date(APP.patron.magazines.keepUntilMS());this._textify(e.answers),n<l&&this._element({button:this._onTapKeep.bind(this),parentNode:this._element({tag:"p",parentNode:e.answers}),label:"magazine.keep-prompt.answer-extend"}),this._element({button:this._onTapStop.bind(this),parentNode:this._element({tag:"p",parentNode:e.answers}),label:"magazine.keep-prompt.answer-remove"})}else this._textify(e.question,"magazine.keep-prompt.question"),
this._textify(e.answers),this._element({button:this._onTapKeep.bind(this),parentNode:this._element({tag:"p",parentNode:e.answers}),label:"magazine.keep-prompt.answer-keep"})},n._layout=function(e){this._build("magazine-keep-prompt",{extending:e}," question <p>"," answers")},n._listen=function(e,t){this._handle("tag:subscriptions")},n._onTapKeep=function(e){APP.patron.magazines.keepIssue(this.title),this._dispatch("magazine:keep",{title:this.title})},n._onTapStop=function(e){APP.patron.magazines.stopKeepingIssue(this.title),this._dispatch("magazine:stop",{title:this.title})},n._onTagSubscriptions=function(e){return this.isInDocument()?void this.refresh():this.extract()},n._toggleFinished=function(){this.magazine._.markedAsFinished=!this.magazine.isMarkedAsFinished(),this.refresh(),this._dispatch("magazine:finished:toggle",{title:this.title,magazine:this.magazine,finished:this.magazine.isMarkedAsFinished()}),APP.patron.magazines.save()},n._dateToDayName=function(e){return"number"==typeof e?e=new Date(e):e||(e=new Date),e.toLocaleDateString(SPARK.locale.tag,{weekday:"long"})},s}),define("app/views/shelf/download-toggle",["require","common","app/views/core/partial","app/views/components/common/download-ring"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/components/common/download-ring");return n.become=function(e){this._prepare().downloadRing.become(e)},n._layout=function(e){this._build("download-toggle",{extending:e}," explanation <p>"," button",{button:function(){}},"  button-text <span>","  download-ring",r)},n._listen=function(e,t){this._handle("status",t.downloadRing)},n._onStatusDownloadRing=function(e){this._updateStatus(e.m)},n._updateStatus=function(e){this._declassify(this.dom.button,"hide danger");var i="download.progress."+e.status;"invalid"==e.status&&"fulfillment-choice"==e.reason?(i=e.fftType?"download.disabled."+e.fftType:"blank",this._classify(this.dom.button,"hide")):"invalid"==e.status?this._classify(this.dom.button,"danger"):"paused"==e.status?i="download.paused."+e.reason:"streaming"==e.status&&"magazine"==t.try(e.possession,"type")&&(i="download.progress.streaming.magazine");var s=t.try(e.luggage,"status().bytes.total");this._textify(this.dom.explanation,{label:i,substitutions:{DOWNLOAD_SIZE:s},morph:!0});var n="download.manage.add",r="download";"streaming"!=e.status&&(n="download.manage.remove",r="stream"),this._textify(this.dom.buttonText,n),this._buttonify(this.dom.button,this._toggleDownload.bind(this,e.luggage,r))},n._toggleDownload=function(e,i){APP.haptics.impact("light"),t.try(e,"chooseStorage()",i)},s}),define("app/views/dialogs/dialog-manage-possession",["require","common","app/views/core/title-partial","app/views/core/cover-box","app/views/shelf/shelf-whisperer","app/views/core/title-availability","app/views/components/common/magazine-keep-prompt","app/views/account/library-card-icon","app/views/shelf/download-toggle","app/views/core/tag-line","app/views/components/tags/tag-plank","app/views/components/library/library-logo"],function(e){var t=e("common"),i=e("app/views/core/title-partial"),s=i.new(),n=s.prototype,r=e("app/views/core/cover-box"),o=(e("app/views/shelf/shelf-whisperer"),e("app/views/core/title-availability")),a=e("app/views/components/common/magazine-keep-prompt"),l=e("app/views/account/library-card-icon"),c=e("app/views/shelf/download-toggle"),h=e("app/views/core/tag-line"),u=e("app/views/components/tags/tag-plank"),p=e("app/views/components/library/library-logo");return n.ACTIONS=t.absorb(n.ACTIONS,{}),n.present=function(e){return this.shade=APP.arena.shade(this,e)},n._layout=function(e){this._build("dialog-manage-possession",{extending:e}," summary",{link:"#"},"  spoken-biblio",{access:"spoken"},"  summary-flex",{access:"visual"},"   cover","    cover-box",r,"   biblio","    author","    title <span>","   logo",p,"  blurb <p>",{access:"visual",describing:"summary"}," possessions"," availabilities"," actions")},n._specify=function(e,i){var s=this._newSpecification(e),n=i.exclusions;if(i.exclusions=[].concat(i.exclusions||[]),s.possessions=[],t.each(this.possessions,function(e){var t={actions:[],type:e.type,websiteId:e.library.websiteId};"loan"==e.type?this._specifyForLoan(t,e,s):"hold"==e.type?this._specifyForHold(t,e,s):"magazine"==e.type&&this._specifyForMagazine(t,e,s),t.actions.length&&s.possessions.push(t)},this),!(this.possessions&&this.possessions.length||"magazine"!=i.forceType)){var r={actions:[],type:"magazine"};this._specifyForMagazine(r,e,s),s.possessions.push(r)}return t.among("summary",i.exclusions)?s.summary="hide":this._specifyForSummary(s,e),t.among("title",i.exclusions)||this._specifyForTitle(s,e),t.among("possessions",i.exclusions)&&t.excise(s,"possessions"),"magazine"==e.format?s.actions.unshift("magazine-keep-prompt"):t.among("availabilities",i.exclusions)||(s.availabilities=!0),i.exclusions=n,s},n._specifyForSummary=function(e,i){e.summaryAction=this._linkTo("title"),e.biblio={title:i.titleWithoutOrphans(),attribution:i.attribution()},e.cover=this._specTitleCover(i),e.cover&&delete e.cover.action,t.among("blurb",this.options.exclusions)?this._classify(this.dom.summary,"has-blurb",!1):(this._classify(this.dom.summary,"has-blurb",!0),e.blurb=i.blurb.excerpt(200),e.blurb||i.reuse(this.refresh,this))},n._specifyForTitle=function(e,i){"magazine"==i.format||t.among("journey",this.options.exclusions)||i.journey().coalesce(function(s){e.actions.push(["reading-journey",i.format,s.progress||0,t.try(s.data,"statistics.readingTime")||0,s.statisticalEstimatedTime()].join(","))});var s=["title-tag-list"];i.tags.use(function(e,i){return e.isIdeal?void t.each(i.all,function(e){s.push(e.uuid)}):i.reuse(this.refresh,this)},this),e.actions.push(s.join(",")),e.actions.push("title-share"),i.series&&e.actions.push("title-series"),APP.shell.has("rosters")&&!t.among("download",this.options.exclusions)&&t.each(this.possessions,function(i){var s=APP.patron.loans.find({psnKey:i.psnKey})||APP.patron.magazines.find({psnKey:i.psnKey});t.try(s,"luggage()")&&(e.actions.push("download,"+s.psnKey),t.breakIteration())},this),this._handleExclusions(e.actions,this.options.exclusions)},n._specifyForLoan=function(e,t){this.options.exclusions.push("availabilities"),e.cardName=t.card.safeName(),e.labelData={label:"fob.loan.head",substitutions:{EXPIRE_TIME:t.expireTime}},SPARK.locale.isEnglish&&(e.labelData={label:"english-only.prefix.due",substitutions:{DUE_DATE:this._phrase(e.labelData)}}),e.actions.push(this._specLoanReadWith(t)),e.actions.push(this._specLoanReturn(t)),e.actions.push(this._specLoanRenew(t)),this._handleExclusions(e.actions,this.options.exclusions)},n._specifyForHold=function(e,t){e.cardName=t.card.safeName(),t.isAvailable?(this.options.exclusions.push("availabilities"),e.actions.push("title-circ,borrow-hold,"+t.psnKey),e.labelData={label:"shelf.whisperer.hold.ready"}):(e.labelData=t.holding().estimatedWaitInWords("short"),SPARK.locale.isEnglish&&e.labelData.label.match(/max|weeks/)&&(e.labelData={label:"english-only.prefix.wait",substitutions:{WAIT_INFO:this._phrase(e.labelData)}})),t.isRedeliverable?e.actions.push("hold-redeliver,"+t.psnKey):t.isAvailable||e.actions.push("hold-suspend,"+t.psnKey),e.actions.push("hold-cancel,"+t.psnKey),this._handleExclusions(e.actions,this.options.exclusions)},n._specifyForMagazine=function(e,t){t.daysToKeepInRack||(t=APP.patron.magazines.find({"title.titleId":t.titleId})),this.options.exclusions.push("availabilities"),e.actions.push("magazine-subscribe"),e.actions.push("reading-journey"),this._handleExclusions(e.actions,this.options.exclusions)},n._executeSpecification=function(e,i,s,n){if(this._classify(e.summary,"hide","hide"==i.summary),this._differs(i,"biblio")&&(this._textify(e.spokenBiblio,{label:"a11y.title.biblio",substitutions:{FORMAT:s.format,TITLE:i.biblio.title,AUTHOR:i.biblio.attribution}}),this._textify(e.author,{html:i.biblio.attribution}),this._textify(e.title,{html:i.biblio.title})),this._differs(i,"cover")&&this._executeCoverSpec(e,i.cover,s),this.dom.logo.become(this._library()),this._differs(i,"blurb")&&this._textify(this.dom.blurb,{html:i.blurb||""}),this._differs(i,"summaryAction")&&this._linkify(this.dom.summary,i.summaryAction||"#"),this._differs(i,"possessions")&&(this._textify(e.possessions),t.each(i.possessions,function(i){var s=this._phrase(t.absorb(i.labelData,{okIfMissing:!0,wrapper:!1}));if(s){var n=this._element({tag:"h2",parentNode:e.possessions}),r=APP.libraries.find({websiteId:i.websiteId});r&&new l(n).become({library:r}),this._element({tag:"span",parentNode:n,html:s}),this._element({tag:"span",parentNode:n,html:i.cardName,access:"visual"})}var o=this._element({tag:"ul",parentNode:e.possessions,classes:"action-list"});t.each(i.actions,this._buildAction.bind(this,o))},this)),this._differs(i,"actions")){this._textify(e.actions);var r,u,p=this._element({parentNode:e.actions,classes:"action-grid"});t.each(i.actions,function(e){if(e.match(/^reading-journey/)){var i=e.split(","),n=parseFloat(i[2])||0,o=parseFloat(i[3])||void 0,l=parseFloat(i[4])||void 0,d=n>=.01,m=d&&o&&l,f=this._build("action-cell .action-cell-journey",{parentNode:p,link:this._linkTo("journey")}," head {journey.action.view}"," body",{label:"journey.statement."+(m?"stats-abbreviated":d?"some":"none"),substitutions:{FORMAT:i[1],PERCENT:n,READING_TIME:this._distanceInTime(o||0,3),ESTIMATED_TIME:this._distanceInTime(l||0,3)}}," mural",{access:"visual"});APP.imageDirector.mural(f.mural,"welcome-specs")}else if("magazine-keep-prompt"==e){var g=this._build("action-cell .action-cell-magazine-keep",{parentNode:p}," body","  icon",{graphic:"feature-one-tap-magazines"},"  prompt",a);g.prompt.become(s);var b=function(){t.try(this.shade,"minimize()")}.bind(this);g.prompt.on("magazine:stop",b),g.prompt.on("magazine:finished:toggle",b)}else if(e.match(/^title-tag-list/)){r=this._element({parentNode:p,classes:"action-grid-horiz"}),u=this._element({parentNode:r,classes:"action-grid-vert"});var g=this._build("action-cell .action-cell-tags",{parentNode:u}," head {shelf.nav.tags}",{button:this._presentTagDialogForTitle.bind(this)},"  icon",{icon:"library-card-add"}," body");s.tags.use(function(e,i){e.isIdeal||i.reuse(),this._textify(g.body),t.each(i.all,function(e){var t=this._element({button:this._onTapTag.bind(this,e),parentNode:g.body});new h(t).become(e)},this)}.bind(this))}else if("title-share"==e){var v=this._build("action-cell .action-cell-share",{parentNode:r||p,button:this._presentShareOptionsForTitle.bind(this)}," icon",{icon:"share-generic"}," head {journey.action.share}"," body","  mural",{access:"visual"});APP.imageDirector.mural(v.mural,"menu-tablet",{classes:"action-cell-mural-east"}),APP.imageDirector.mural(v.mural,"menu-phone",{classes:"action-cell-mural-west"})}else if("title-series"==e)var g=this._build("action-cell .action-cell-series",{parentNode:u||p,button:this._presentSeriesDialogForTitle.bind(this)}," head {title.details.series}"," body",{label:"title.series-number-with-name",substitutions:{LABEL:t.try(s.seriesReadingOrder(),"label"),SERIES_NAME:s.series.name},substitutionTags:!0});else if(e.match(/^download/)){var y=e.replace("download,",""),_=APP.patron.loans.find({psnKey:y})||APP.patron.magazines.find({psnKey:y});if(_&&_.card){var g=this._build("action-cell .action-cell-download",{parentNode:p}," download-toggle",c);g.downloadToggle.become(_)}}},this)}if(this._differs(i,"availabilities")&&(this._textify(this.dom.availabilities),i.availabilities)){var d=this._library(),m=APP.libraries.withCards();d&&(t.excise(m,d),m.unshift(d));var f=this._.statuses={};t.each(m,function(e){f[e.websiteId]="pending";var t=new o(this.dom.availabilities);t.dom.icon.on("title-status:spec",function(t){f[e.websiteId]=t.m.suffix,this._defer("statuses",this._checkStatuses.bind(this,this._.statuses))}.bind(this)),t.become(this.title,e,{interactive:!0})},this)}},n._buildAction=function(e,t){var i=this._element({tag:"li"}),s=t;"string"==typeof t&&(s=this._action(t));var n=this._rowAsAction(i,s);return i.firstChild&&e.appendChild(i),n},n._checkStatuses=function(e){var i=t.select(e,function(e,t){if(!t.match(/^unowned/))return t});if(!i.length){this.dom.availabilities.style.setProperty("min-height",Math.min(this.dom.availabilities.offsetHeight,240)+"px"),this._textify(this.dom.availabilities);var s=this._element({button:this._presentNotifyMeTutorialForTitle.bind(this,"title-unowned-notify-me"),parentNode:this.dom.availabilities,classes:"title-availability-all-notify-me"});this._element({tag:"strong",parentNode:s,label:"tag.behavior.smart.notify-me"}),this._element({tag:"span",parentNode:s,label:"tutorial-title-unowned.404"}),this._element({graphic:"notify-me-bell",parentNode:s,classes:"nm-bell-silhouette",access:"visual"})}},n._onTapTag=function(e,t){var i=t.tappedElement||t.target;APP.arena.popover(i).choices(function(t,i){var s=this._element({link:e.path(),parentNode:i,classes:"tag-plank-link","data-halo-states":"focus"});new u(s).become(e),t.choice({label:"tag.remove-from-title",button:this._removeTagFromTitle.bind(this,e),classes:"danger"})}.bind(this))},n._removeTagFromTitle=function(e){e.removeFromTitle(this.title),this.refresh()},s}),define("app/views/popovers/popover-export",["require","common","shibui/src/view"],function(e){var t=e("common"),i=e("shibui/src/view"),s=i.new(),n=s.prototype;return n.DATA_FORMATS=["HTML","CSV","JSON"],n.become=function(e,t){return this.filename=e,this.exportable=t,this},n.present=function(e){return APP.arena.popover(e).choices(this._popoverChoices.bind(this))},n._popoverChoices=function(e,i){e.backButton({label:"action.journey.export"}),t.each(this.DATA_FORMATS,function(t){e.choice({label:"action.export."+t,indicator:"action.export."+t+".format",button:this._onTapDataFormat.bind(this,t)})},this)},n._onTapDataFormat=function(e){var i=APP.stasher.cap(),s=t.try(this.exportable,"count")||1;s>i?APP.arena.popover().confirm({warningLabel:{label:"action.export.confirm-truncation",substitutions:{CAP:i,COUNT:s}},buttonLabel:"action.export.confirm-truncation.button",onSubmit:this._onConfirmExport.bind(this,e)}):this._onConfirmExport(e)},n._onConfirmExport=function(e){APP.arena.popover().spinner();var t="."+e.toLowerCase();APP.stasher.share(this.filename,{export:this.exportable},{representation:"data",filename:this.filename+t},this._onDataURL.bind(this),this._onDataURLFailed.bind(this))},n._onDataURL=function(e){APP.arena.popover().close(),location.href=e},n._onDataURLFailed=function(){APP.arena.popover().notice({label:"action.export.failure",backButton:!0})},s}),define("app/views/screens/shelf/screen-shelf-journey",["require","common","app/views/screens/screen","app/views/components/shelf/app-header-shelf","app/views/core/block-strap","app/views/shelf/journey-statement","app/views/shelf/journey-timeline","app/views/components/common/cover-3d","app/views/components/shelf/notice-plank","app/views/dialogs/dialog-manage-possession","app/views/core/title-availability","app/views/components/common/magazine-keep-prompt","app/views/popovers/popover-export"],function(e){var t=e("common"),i=e("app/views/screens/screen"),s=i.new(),n=s.prototype,r=e("app/views/components/shelf/app-header-shelf"),o=e("app/views/core/block-strap"),a=e("app/views/shelf/journey-statement"),l=e("app/views/shelf/journey-timeline"),c=e("app/views/components/common/cover-3d"),h=e("app/views/components/shelf/notice-plank"),u=e("app/views/dialogs/dialog-manage-possession"),p=e("app/views/core/title-availability"),d=e("app/views/components/common/magazine-keep-prompt"),m=e("app/views/popovers/popover-export");return n.become=function(e){this.journey=e,this.journey.coalesce(function(){this._fillOut(this._prepare(),this.journey)}.bind(this)),APP.events.off(this.handlers.journeyUpdate),this.handlers.journeyUpdate=APP.events.on("journey:update:"+this.journey.titleId,this._onJourneyUpdate.bind(this))},n._layout=function(e){this._build("screen-shelf-journey",{extending:e}," content .content","  pillar",{classes:"pillar bumper-n bumper-s bumper-e bumper-w"},"   intro","    heading .screen-shelf-collation-heading <h1> {journey.view.heading}","    biblio","     title-link",{link:"#","data-halo-states":"focus"},"      cover-3d",c,"     progress","      statement",a,"      progress-row","       progress-bar",{classes:"hide"},"        progress-needle","   highlights .hide",{skip:!0},"     highlights-strap",o,"     highlights-content","   .screen-shelf-journey-wide-flex","    notices .hide","     notices-strap",o,"     notices-content","    about","     about-strap",o,"     about-content","   .screen-shelf-journey-wide-flex","    timelines .hide","     timelines-strap",o,"     timelines-content","    availabilities","     availabilities-strap",o,"     availabilities-content"),this.dom.noticesStrap.configure({text:"journey.section.notices",circle:{button:this._onDismissNotices.bind(this),spoken:"notice-actions.dismiss.group",icon:"block-strap-dismiss"}}),this.dom.aboutStrap.configure({text:"journey.section.about"}),this.dom.timelinesStrap.configure({text:"journey.section.timeline"}),this.dom.availabilitiesStrap.configure({text:"title-availability.heading"})},n._layoutHeader=function(e){e.header=new r,e.header.impart(e.root,"prepend"),e.header.actions(["sync",{label:"journey.action.export",button:this._onTapActionsExport.bind(this)},{label:"journey.action.share",icon:"share",button:this._onTapActionsShare.bind(this)},{label:"action.journey.delete",button:this._onTapActionsDelete.bind(this),classes:"danger"}])},n._fillOut=function(e,i){var s=i.title(),n={},r=s.possession("loan");t.try(r,"fulfiller.isFulfillable()","bifocal")&&(n.openTitleOptions={link:"#"},n.openTitleHandler=function(i){r.fulfiller.open({fftType:"bifocal",offlinePromptTarget:t.try(i,"target")||e.progress})}.bind(this)),e.statement.become(i,n),e.progressNeedle.style.setProperty("width",100*i.progress+"%"),e.cover3d.become(s),this._linkify(e.titleLink,s.path()),this._classify(e.progressBar,"hide",!i.progress),this._fillOutHighlights(e,i),this._fillOutNotices(e,this._notices()),this._fillOutAbout(e,s),this._fillOutTimelines(e,i),this._fillOutAvailabilities(e,s)},n._fillOutHighlights=function(e,t){},n._fillOutNotices=function(e,i){this._emptyElement(e.noticesContent),this._classify(e.notices,"hide",!i.length);var s="_onNotificationDismiss";if(APP.events.off(this.handlers[s]),i.length){var n=t.select(i,function(t){return t.vanishAt||t.toggleVanishing(t.vanishAt="seen"),new h(e.noticesContent).become(t)},this);this.handlers[s]=APP.events.on("notification:dismiss",function(e){n=t.select(n,function(t){return t.notification!=e.m.notification?t:void t.extract()}),this._classify(this.dom.notices,"hide",!n.length)}.bind(this))}},n._fillOutAbout=function(e,i){this._emptyElement(e.aboutContent),APP.library&&this._build("screen-shelf-journey-about-list <ul>",{parentNode:e.aboutContent}," <li>","  <a>",{link:i.path(APP.library)},"   <strong> {journey.section.about.title-details}","   <cite> {journey.section.about.title-details.cite}",{substitutions:{TITLE:i.titleWithoutOrphans(),AUTHOR_NAMES:i.authorNames()||null}}," <li>","  <a>",{link:APP.library.catalog.lists.produce("similar-"+i.titleId).path()},"   <strong> {list.source.similar}","   <cite> {title-availability.at-library}",{substitutions:{LIBRARY_NAME:APP.library.safeName()}}," <li>",{skip:!i.series},"  <a>",{link:i.series?i.seriesList(APP.library).path():"#"},"   <strong> {title.details.series}","   <cite> {title.series-number-with-name.unpunctuated}",{substitutions:{LABEL:t.try(i.seriesReadingOrder(),"label"),SERIES_NAME:t.try(i.series,"name")}}," <li>","  more-button {journey.section.about.more}",{button:this._onTapMoreAbout.bind(this,i)})},n._fillOutTimelines=function(e,i){i.coalesce(function(){var e=0;for(t.each(i.timelines(),function(t){var s="timeline"+e;this.dom[s]=this.dom[s]||new l(this.dom.timelinesContent),this.dom[s].become(i,t),e+=1},this);this.dom["timeline"+e];)this.dom["timeline"+e].extract(),delete this.dom["timeline"+e],e+=1}.bind(this)),this._classify(e.timelines,"hide",!this.dom.timelinesContent.firstChild)},n._fillOutAvailabilities=function(e,i){this._emptyElement(e.availabilitiesContent),i.parentMagazineId?(e.availabilitiesStrap.configure({text:"journey.magazine-issue.heading"}),new d(e.availabilitiesContent).become(i)):(e.availabilitiesStrap.configure({text:"title-availability.heading"}),t.each(APP.libraries.withCards(),function(t){var s=new p(e.availabilitiesContent);s.become(i,t,{interactive:!0})},this))},n._notices=function(){return APP.notifier.notifications.filter({"details.titleId":this.journey.titleId,dismissedAt:null})},n._onDismissNotices=function(e){APP.arena.popover(e.target).confirm({warningLabel:"journey.section.notices.dismiss",buttonLabel:"list.confirm-dismiss.proceed",onSubmit:this._onConfirmDismissNotices.bind(this)})},n._onConfirmDismissNotices=function(){t.each(this._notices(),function(e){e.dismiss()})},n._onTapMoreAbout=function(e,i){var s={library:t.try(this.journey,"mostRelevantLibrary()")||APP.library,exclusions:["availabilities","journey","title-series"]};(new u).become(e,s).present()},n._onJourneyUpdate=function(){this._fillOutTimelines(this.dom,this.journey)},n._onTapActionsExport=function(){var e=["libbyjourney",this.journey.titleId,this.journey.title().titleAsNonUniquePathname()].join("-"),t={journey:this.journey};(new m).become(e,t).present()},n._onTapActionsShare=function(){APP.stasher.shareTitle(this.journey.title())},n._onTapActionsDelete=function(){APP.arena.popover().confirm({warningLabel:[{label:"action.journey.delete.warning"},{label:"shelf.activities.privacy",enliven:{"#privacy":APP.shell.bindOpenURL(APP.constants.URLS.privacy)}}],buttonLabel:"action.journey.delete.confirm",onSubmit:this._onConfirmDeleteJourney.bind(this)})},n._onConfirmDeleteJourney=function(e){this.journey.wipe(function(){this._onConfirmDismissNotices(),this.dom.statement.become(this.journey)}.bind(this))},s}),define("app/controllers/shelf/journey-controller",["require","common","../train-controller","app/views/screens/shelf/screen-shelf-journey"],function(e){var t=e("common"),i=e("../train-controller"),s=i.new(),n=s.prototype;return n.SCREEN_CLASS=e("app/views/screens/shelf/screen-shelf-journey"),n.configure=function(){this.realm=t.try(this.ancestor,"realm")||"shelf",this.waypoint.configure({label:"journey.view.heading"})},n.match=function(e){var i=e.match(/^journey(\/([^\/]+))?(\/.*)?/);if(i){var s=t.try(i[2],"trim()")||"";if(this.args={titleId:s||t.try(this.ancestor,"args.titleId")},this.args.titleId)return{head:"journey"+(s?"/"+s:""),tail:i[3]}}},n.usher=function(){var e=this.args.titleId;this.journey=APP.journeys.produce({titleId:e}),this.on("journey:update:"+e,this._onJourneyUpdate.bind(this)),this._doJourneyUpdate()},n.fill=function(){this.screen().become(this.journey)},n.focus=function(){i.prototype.focus.apply(this,arguments),this._doJourneyUpdate()},n._doJourneyUpdate=function(){this.journey.sync({freshness:3e4,callback:this._onJourneyUpdate.bind(this)})},n._onJourneyUpdate=function(e){this._.pendingUpdate=!0,this._performPendingUpdate()},n._performPendingUpdate=function(){this._.pendingUpdate&&this._.hasFocus&&(clearTimeout(this._.updateTimer),this._.updateTimer=setTimeout(this.fill.bind(this),0))},s}),define("app/views/components/library/app-header-with-emblem",["require","common","app/views/core/app-header","app/views/components/library/library-emblem"],function(e){var t=(e("common"),e("app/views/core/app-header")),i=t.new(),s=i.prototype,n=e("app/views/components/library/library-emblem");return s.focus=function(){t.prototype.focus.apply(this,arguments);this._prepare().emblem.become(APP.library)},s._layoutControls=function(e){t.prototype._layoutControls.apply(this,arguments),this._classify(e.root,"app-header-with-emblem"),e.emblem=new n(e.controls)},i}),define("app/views/components/search/app-header-search-switcher",["require","common","app/views/core/app-header","app/views/components/library/library-emblem"],function(e){var t=e("common"),i=e("app/views/core/app-header"),s=i.new(),n=s.prototype,r=e("app/views/components/library/library-emblem");return n.focus=function(){var e=i.prototype.focus.apply(this,arguments),s=this._prepare();return(this._.searchParameters=this._findSearchParametersInRoute())&&(this.query=decodeURIComponent(this._.searchParameters.query),this._textify(s.queryText,{html:t.safe(this.query)}),this._classify(s.queryButton,"has-query")),e},n._layoutControls=function(e){i.prototype._layoutControls.apply(this,arguments),this._classify(e.root,"app-header-search-switcher"),this._build("buttons",{extending:e,parentNode:e.controls,extensionClass:"app-header-search-switcher"}," query-button",{button:!0,spoken:"a11y.search.catalog.prompt"},"  query-icon",{icon:"search"},"  query-text <span> {search.placeholder}"," reset-button",{button:!0,spoken:"a11y.form.search.reset"},"  reset-icon",{icon:"input-reset"}," emblem",r),e.emblem.become(APP.library)},n._findSearchParametersInRoute=function(){if("search"==APP.router.realm)for(var e=(APP.router.waypoints.search||[]).slice(0);e.length;){var i=t.try(e.pop(),"route"),s=t.try(i,"args.params.refinements");if(s&&s.query)return this._.searchRootRoute=i,s}},n._onTapQueryButton=function(e){t.each(APP.router.waypoints.search,function(e){e.route.root&&(e.route.inputState=t.compact(["focus",this.query]).join(":"))},this),this._jumpTo("search")},n._onTapResetButton=function(e){t.each(APP.router.waypoints.search,function(e){e.route.root&&(e.route.inputState="reset")},this),this._jumpTo("search")},n._jumpTo=function(e){APP.arena.surfaces.search.dom.main.skippingAnimations(function(){APP.nav.go(e)})},s}),define("app/views/popovers/popover-title-talker",["require","common","shibui/src/view","app/views/components/library/library-logo"],function(e){var t=e("common"),i=e("shibui/src/view"),s=i.new(),n=s.prototype,r=e("app/views/components/library/library-logo");return n.become=function(e){return this.talker=e,this.dom&&this._populatePopover(this.dom,e),this},n.present=function(e){return APP.arena.popover(e).build(this._buildPopover.bind(this))},n._buildPopover=function(e,t){this.dom=e._build("popover-title-talker",{element:t}," portrait","  headshot <img>","  emoji"," attribution","  attribution-text","   type <p>","   name <h1>","   location <p>","  logo",r),this.talker&&this._populatePopover(this.dom,this.talker)},n._populatePopover=function(e,i){var s=t.try(i.curator,"headshot.href");s?(this._attr(e.headshot,"alt",this._phrase({label:"title-details.note-plate.headshot",substitutions:{NAME:i.curator.name}})),APP.imageDirector.enqueue(e.headshot,s)):(this._attr(this.dom.headshot,"src",null),this._textify(this.dom.emoji,{html:APP.constants.NOTEMOJI[i.noteType],wrapper:!1}));var n="title-details.note-plate.note-type."+i.noteType;t.try(i,"curator.name")&&(n+=".attributed",this._textify(e.name,{html:i.curator.name}),this._textify(e.location,{html:i.curator.location||""})),this._textify(this.dom.type,{label:n,substitutions:{FORMAT:i.format}}),this.dom.logo.become(APP.library)},s}),define("app/views/components/library/talker-avatar",["require","common","app/views/core/partial","app/views/popovers/popover-title-talker"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/popovers/popover-title-talker");return n.become=function(e){this.talker=e,this._textify(this.dom.root);var i=t.try(e,"curator.headshot.href");if(i){var s=this._element({tag:"img",parentNode:this.dom.root,classes:"talker-avatar-image",alt:this._phrase({label:"title-details.note-plate.headshot",substitutions:{NAME:e.curator.name}})});APP.imageDirector.enqueue(s,i)}else this._element({parentNode:this.dom.root,classes:"talker-avatar-emoji",html:APP.constants.NOTEMOJI[e.noteType],wrapper:"span"})},n.presentPopover=function(e){(new r).become(this.talker).present(e)},n._layout=function(e){this._build("talker-avatar",{extending:e})},s}),define("app/views/components/library/talker-plate",["require","common","app/views/core/partial","app/views/components/library/library-logo","app/views/components/library/talker-avatar"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/components/library/library-logo"),o=e("app/views/components/library/talker-avatar");return n.become=function(e){this.talker=e,this._prepare(),this._semaphore("note-type",e.noteType),this.dom.avatar.become(e),this._textify(this.dom.note,{html:e.note});var i="title-details.note-plate.note-type."+e.noteType,s="a11y.note-plate.note-type."+e.noteType;"unavailability"!=e.noteType&&t.try(e,"curator.name")?(i+=".attributed",s+=".attributed",this._textify(this.dom.curator,{label:"title-details.note-plate.curator",substitutions:{NAME:e.curator.name,LOCATION:e.curator.location}}),this._classify(this.dom.root,"has-curator")):(this._textify(this.dom.curator),this._declassify(this.dom.root,"has-curator")),this._textify(this.dom.type,{label:i,substitutions:{FORMAT:e.format}}),this._textify(this.dom.circle,{spoken:{label:s,substitutions:{FORMAT:e.format,CURATOR_NAME:t.try(e.curator,"name"),CURATOR_LOCATION:t.try(e.curator,"location")}}}),this.dom.logo.become(APP.library)},n._layout=function(e){this._build("talker-plate",{extending:e}," field","  circle",{button:!0,"aria-haspopup":"true"},"   avatar",o,"  note","  attribution","   attribution-text","    type","    curator","   logo",r)},n._onTapCircle=function(e){this.dom.avatar.presentPopover(e.target)},s}),define("app/views/components/library/campaign-plate",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.become=function(e,t){this.campaign=e,this.title=t,this._prepare(),this.campaign.use(this._fillOut.bind(this))},n._layout=function(e){this._build("campaign-plate",{extending:e}," murmur"," article"," logo"," actions <ul>")},n._fillOut=function(e,i){if(!e.isIdeal)return i.reuse();this._textify(this.dom.murmur,{html:i.data.murmur||""}),this._textify(this.dom.article,{html:i.data.article||""}),this._textify(this.dom.actions),i.data.actions&&t.each(i.data.actions,function(e){var i=this._tag("li",this.dom.actions);t.try(e.link,"href")?this._element({link:e.link.href,parentNode:i,html:e.label}):this._textify(i,{html:e.label})},this),this._textify(this.dom.logo);var s=t.try(i.data,"images.logo");if(t.try(s,"src")){var n=this._element({tag:"img",src:s.src,alt:i.strapline||this._phrase("a11y.campaign-logo")});t.try(s.link,"href")?this._element({link:s.link.href,parentNode:this.dom.logo}).appendChild(n):this.dom.logo.appendChild(n)}},s}),define("app/views/core/title-actions",["require","common","app/views/core/title-partial"],function(e){var t=e("common"),i=e("app/views/core/title-partial"),s=i.new(),n=s.prototype;return n.ACTIONS=t.absorb(n.ACTIONS,{}),n._layout=function(e){this._build("title-actions",{extending:e}," list <ul>")},n._listen=function(e){e.loans=APP.router.route.on("loan:update:all",this.refresh.bind(this)),e.holds=APP.router.route.on("hold:update:all",this.refresh.bind(this))},n._specifyForTitle=function(e,t){return t.parentMagazineId?this._specifyForMagazine(e,t):(e.actions.push(this._specTitleCirc(t)),e.actions.push(this._specTitleOpen(t)),void e.actions.push(this._specTitleTags(t)))},n._specifyForMagazine=function(e,t){var i=this._specMagazineOpen(t)||"";i.match(/unowned/)?(e.actions.push("title-circ,unowned"),e.actions.push(i)):(e.actions.push(i),e.actions.push("magazine-subscribe")),e.actions.push(this._specTitleTags(t))},n._specifyForLoan=function(e,t){e.actions.push("shelf,loan"),e.actions.push(this._specTitleOpen(t.title,t)),e.actions.push(this._specTitleTags(t.title))},n._specifyForHold=function(e,i){var s=this._holding(i.title,i);i.isAvailable?e.actions.push("title-circ,borrow-hold,"+i.psnKey):s&&s.isOnlyAvailableAsLuckyDayLoan()?e.actions.push(t.compact(["title-circ","borrow","lucky-day",s.libraryKey||null]).join(",")):s&&e.actions.push("shelf,hold"),e.actions.push(this._specTitleOpen(i.title)),
e.actions.push(this._specTitleTags(i.title))},n._executeSpecification=function(e,i,s,n){var r=0;for(t.each(i.actions,function(t,s){r=s;var n=e["row"+s];if(!n||this._differs(i,"actions."+s)){n?this._textify(n):(n=this._element({tag:"li",parentNode:e.list,classes:"title-actions-item"}),e["row"+s]=n);var o=this._action(t);o&&this._rowAsAction(n,o)}},this);r;){r+=1;var o=t.excise(e,"row"+r);if(!o)break;e.root.removeChild(o)}},n.ACTIONS.shelf=function(e){return{label:"action."+e+".shelf",link:this._linkTo("journey")}},n.ACTIONS["on-shelf"]=function(e){return{label:"context."+e+".shelf",link:this._linkTo("journey")}},n._addIndicator=function(e,t){t.classes=("title-action-indicator "+(t.classes||"")).trim(),i.prototype._addIndicator.call(this,e,t)},s}),define("app/views/library/title-details-actions",["require","common","app/views/core/title-actions","app/views/core/title-status"],function(e){var t=(e("common"),e("app/views/core/title-actions")),i=t.new(),s=i.prototype,n=e("app/views/core/title-status");return s._layout=function(e){this._build("title-details-actions",{extending:e}," status",{button:!0},"  title-status",n," list <ul>")},s._fillOut=function(e,t){e.titleStatus.become(t,this.options)},s._onTapStatus=function(e){this.dom.titleStatus.tapped(e)},i}),define("app/views/core/facts-table",["require","common","app/views/core/partial"],function(e){var t=(e("common"),e("app/views/core/partial")),i=t.new(),s=i.prototype;return s.$init=function(e,t){this._.tableClassName=t,this._.rows=[],this.impart(e)},s.rebuild=function(e){var t=this.dom.tbody;this.dom.tbody=this._tag("tbody",this.dom.root),e(this._createRow.bind(this)),t&&(this.dom.root.removeChild(t),delete t)},s._layout=function(){this.dom=this._build("facts-table <table>",{classes:this._.tableClassName||""})},s._createRow=function(e,t,i){for(var s,n=this._phrase(e),r=0,o=this._.rows.length;r<o;++r)if(this._.rows[r].html==n){s=this._.rows[r];break}return s||(s={html:n,row:this._tag("tr")},s.head=this._element({tag:"th",parentNode:s.row,html:n}),s.cell=this._element({tag:"td",parentNode:s.row}),this._.rows.push(s)),this.dom.tbody.appendChild(s.row),this._textify(s.cell,t||{html:"—"}),s},i}),define("app/views/core/star",["require","common","shibui/src/view"],function(e){var t=e("common"),i=e("shibui/src/view"),s=i.new(),n=s.prototype;return n.ICON_SIZE=16,n.setPercent=function(e){var t=Math.round(this.ICON_SIZE*e);this.dom.clipRect.setAttribute("width",t)},n._layout=function(e){this.dom=this._build("star"," symbol",{icon:"star-rating"}),this.dom.fg=this.dom.root.querySelector(".star-fg"),this.dom.clip=this.dom.root.querySelector(".star-clip"),this.dom.clipRect=this.dom.root.querySelector("rect");var i="star-clip-"+t.generateUUID().replace(/-.*/,"");this._attr(this.dom.clip,"id",i),this._attr(this.dom.fg,"clip-path","url(#"+i+")")},s}),define("app/views/core/star-rating",["require","common","shibui/src/view","app/views/core/star","shibui/src/phrasebook"],function(e){var t=(e("common"),e("shibui/src/view")),i=t.new(),s=i.prototype,n=e("app/views/core/star"),r=e("shibui/src/phrasebook");return s.SCALE=5,s.become=function(e){for(var t=e.rating,i=e.ratingCount,s=0;s<this.SCALE;++s){var n=this.dom.stars.children[s]._view;n.setPercent(Math.max(0,Math.min(t-s,1)))}var r=this._phrase({label:"star-rating.description",substitutions:{RATING:t,RATERS:i}});this.dom.root.setAttribute("title",r),this._textify(this.dom.summary,{html:r}),this._textify(this.dom.count,{html:this._truncatedCount(i)||""})},s._layout=function(e){this.dom=this._build("star-rating",{element:e.root}," stars <span>",{access:"visual"}," count <span>",{access:"visual"}," summary <span>",{access:"spoken"});for(var t=0;t<this.SCALE;++t)new n(this.dom.stars)},s._truncatedCount=function(e){if(e)return e<999?r.number(e):SPARK.locale.isEnglish?this._phrase({label:"star-rating.thousand",substitutions:{COUNT:(e/1e3).toFixed(2)}}):r.number(100*Math.floor(e/100))},i}),define("app/views/library/title-details-facts",["require","common","app/views/core/facts-table","app/views/core/star-rating","shibui/src/phrasebook","shibui/src/components/chevron"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("app/views/core/facts-table"),r=e("app/views/core/star-rating"),o=e("shibui/src/phrasebook"),a=e("shibui/src/components/chevron");return s.$init=function(e){this.facts=new n(e,"screen-title-details-facts"),this.reset()},s.become=function(e){e.use(function(t){this._fillOut(this._accumulateData(e,t))},this)},s.reset=function(){this._fillOut({})},s._accumulateData=function(e,i){i.isIdeal||e.reuse();var s={};s.format=e.format?e.humanFormat():"",s.releaseDate=e.publicationDate(),s.roles=[],t.each(e.creators,function(i,n){var r="title.creator."+i.toLowerCase();o.text(r,{},{okIfMissing:!0})||(r="title.creator");var a=t.element();s.roles.push({role:r,creators:a}),t.each(n,function(t){a.appendChild(this._listLink({html:t.name},e.creatorList(APP.library,t)))},this)},this),e.languages&&(s.languages=o.list(t.select(e.languages,function(e){return e.name}),{type:"unit"})),e.publisher&&(s.publisher=this._listLink({html:e.publisher.name},e.publisherList(APP.library))),e.imprint&&(s.imprint=this._listLink({html:e.imprint.name},e.imprintList(APP.library)));var n=e.holding();n&&n.use(function(i){i.isIdeal||n.reuse(this.become.bind(this,e)),s.availability=t.element();var r=(n.copiesOwned||0)+(n.luckyDayCopiesOwned||0),a=(n.copiesAvailable||0)+(n.luckyDayCopiesAvailable||0);if(r&&(APP.arena._tag("span",s.availability,"",{label:"title.copies"+(isFinite(a)?"":".unlimited"),substitutions:{AVAILABLE:a,OWNED:r}}),!a&&n.holdsRatio)){APP.arena._tag("span",s.availability,"",{label:"title.copies.holds-ratio",substitutions:{RATIO:Math.round(n.holdsRatio)}});var l=[];t.each(s.availability.children,function(e){l.push(e.outerHTML)}),s.availability.innerHTML=o.list(l,{type:"unit"})}if(n.isOwned){var c=[],h=e.fulfiller().fulfillments;t.each(h,function(e){var t=o.text("fulfillment-subtype.name."+e.fulfillmentSubtype);c.push('<a href="#" class="pop">'+t+"</a>")},this),s.fulfillments=t.element(),APP.arena._textify(s.fulfillments,{list:c,style:"narrow"});var u=s.fulfillments.querySelectorAll("a");t.each(h,function(e,t){var i=u[t];APP.arena._buttonify(i,function(){var t="fulfillment-subtype.description."+e.fulfillmentSubtype;APP.arena.popover(i).notice({label:t})})},this)}},this),e.duration&&(s.duration=e.humanDuration("approx")),s.edition=e.edition;var r=t.select(e.audiences,function(e){return o.text("audiences."+e,{},{okIfMissing:!0})});return r.length&&(s.audience=o.list(r,{type:"unit"})),s},s._fillOut=function(e){this.facts.rebuild(function(i){i("title.details.format",{html:e.format}),e.duration&&i("title.details.duration",{html:e.duration}),e.edition&&i("title.details.edition",{html:e.edition}),e.languages&&i("title.details.languages",{html:e.languages}),e.roles&&t.each(e.roles,function(e){i(e.role,{html:e.creators})},this),i("title.details.publisher",{html:e.publisher}),e.imprint&&i("title.details.imprint",{html:e.imprint}),i("title.details.release",{html:e.releaseDate}),i("title.details.copies",{html:e.availability}),e.audience&&i("title.details.audience",{html:e.audience}),e.fulfillments&&i("title.details.fulfillable",{html:e.fulfillments}),e.stars&&i("title.details.rating",{html:function(t){new r(t).become(e.stars)}})}.bind(this))},s._listLink=function(e,i){if(i){var s=this.facts._element(t.absorb(e,{link:i.path(),classes:"nav-list"}));return new a(s).bearing("e"),s}return t.element(t.absorb(e,{tag:"span"}))},i}),define("app/views/library/title-journey-preview",["require","common","shibui/src/view","app/views/shelf/journey-timeline"],function(e){var t=(e("common"),e("shibui/src/view")),i=t.new(),s=i.prototype,n=e("app/views/shelf/journey-timeline");return s.MAX_ACTS=3,s.become=function(e){this.journey=e,this._listenForUpdates(),this.focus()},s.becomeActs=function(e){e.length?(this.impart(),this.dom.timeline.become(this.journey,e),this._declassify(this.dom.root,"hide")):this.extract()},s.focus=function(){this._defer("focus"),this.journey&&this.journey.coalesce(function(e){this._fillOut(this._prepare(),e)}.bind(this))},s._layout=function(e){this.dom=this._build("title-journey-preview .hide",{element:e.root}," timeline",{construct:n}," button .shibui-button {journey.action.view}",{button:!0})},s._fillOut=function(e,t){var i=t.timelines();i.length?(this._ensureJourneyIsUpToDate(t),this.becomeActs(i[0].slice(0,this.MAX_ACTS)),APP.coverGuru.colorForCover(t.title(),function(e){APP.coverGuru.paint(this.dom.button,"cover",e)}.bind(this))):this.becomeActs([])},s._listenForUpdates=function(){this._.updateHandler&&APP.router.route.off(this._.updateHandler),this._.updateHandler=APP.router.route.on("journey:update:"+this.journey.titleId,this._defer.bind(this,"focus",this.focus.bind(this)))},s._ensureJourneyIsUpToDate=function(e){var t={freshness:6e4};e.isFresh(t)||e.sync(t)},s._onTapButton=function(){APP.nav.go(this.journey.path())},i}),define("app/views/dialogs/dialog-title-reviews",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.become=function(e,i,s){this._textify(this._prepare().root);var n=[];i?t.each(t.flatten([s.premium,s.quotes]),function(e){e.source.name===i&&e.isPremiumReview?n.unshift(e):n.push(e)}):n=t.flatten([s.quotes,s.premium]);var r=!1;t.each(t.try(e,"subjects"),function(e){t.among(parseFloat(e.id),26,43,127)&&(r=!0)});var o={};t.each(n,function(e){!o.premium&&e.isPremiumReview&&r&&(o.premium=this._build("dialog-title-reviews-warning",{parentNode:this.dom.root}," spoilers {title-reviews.warning.spoilers}")),o.unverified||e.isPremiumReview||(o.unverified=this._build("dialog-title-reviews-warning",{parentNode:this.dom.root}," unverified {title-reviews.warning.unverified}"));var i=this._build("title-review",{parentNode:this.dom.root}," source","  source-text","   source-name <h2>",{html:e.source.name},"   source-details",{skip:!e.source.about&&!e.source.website},"    source-about <span>",{skip:!e.source.about||e.source.logo&&!e.isPremiumReview,html:e.source.about},"    source-link",{skip:!e.source.website,link:t.try(e,"source.website.href"),target:"_blank"},"     source-link-icon",{graphic:"link-anchor"},"     source-link-text <span>",{html:t.try(e,"source.website.label")},"  source-logo <img>",{skip:!e.source.logo,src:t.try(e,"source.logo.href"),alt:e.source.name}," paragraphs"," dateline",{skip:!e.publicationDate&&!e.isStarredReview},"  publish-date <span>",{skip:!e.publicationDate,html:this._phrase({date:e.publicationDate})},"  starred-label <span> {title-reviews.starred}",{skip:!e.isStarredReview,spoken:"a11y.title-reviews.starred",wrapper:!1}," copyright <p>");this._classify(i.root,"is-premium-review",e.isPremiumReview),t.each(e.lines,function(e){this._element({tag:"p",html:e,parentNode:i.paragraphs})},this),e.isPremiumReview&&t.try(e,"copyright.attribution")&&this._textify(i.copyright,{label:"title-reviews.copyright",substitutions:{YEAR:e.copyright.year||"",SOURCE:e.copyright.attribution,RIGHTS:e.copyright.rights}})},this)},n.present=function(){return this.shade=APP.arena.shade(this,{springs:[.875]}),this._classify(this.shade.dom.root,"shade-for-dialog-title-reviews"),this.shade},n._layout=function(e){this._build("dialog-title-reviews",{extending:e})},s}),define("app/views/core/loading-block",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.$init=function(e){"function"==typeof e.supplant?e.supplant(this):e&&this.impart(e)},n.impart=function(e){return this.container=e,i.prototype.impart.call(this,e)},n.supplant=function(e){return this._clearLayout(),this.block=e,"function"==typeof this.block.impart?this.block.impart(this.container):this.container.appendChild(this.block),this.extract(),this.block},n.explain=function(e,t){this._.isExplaining=!0,this.block&&(this.block.extract(),this.block=null);var i=this.impart(this.container);this._.spinTimer&&this._clearLayout(),this._.parts.box.classList.add("explaining"),e&&(i.head=this._element({parentNode:i.box,classes:"explain-head"}),this._textify(i.head,e)),t&&(i.lede=this._element({parentNode:i.box,classes:"explain-lede"}),this._textify(i.lede,t))},n.showRetryButton=function(e){this.showButton("list-chain.retry",this._performRetry.bind(this,e))},n.showButton=function(e,i){t.try(t.excise(this,"block"),"extract()");var s=this.impart(this.container);this._.spinTimer&&this._clearLayout(),s.retry=this._element({button:i,parentNode:s.box,classes:"loading-block-action-button",label:e})},n.discard=function(){if(!this.block&&!this._.isExplaining){this.extract();var e=t.try(this.container,"parentNode");e&&e.removeChild(this.container)}},n._layoutPartial=function(e){e.box.classList.add("loading-block"),this._.spinTimer=setTimeout(this._spin.bind(this,e),0)},n._spin=function(e){e.spinner=this._symbol("spinner-12",e.box,{classes:"spinner"})},n._clearLayout=function(){this._.parts={box:this._.parts.box},this._.parts.box.innerHTML="",this._.parts.box.classList.remove("explaining"),clearTimeout(this._.spinTimer),delete this._.spinTimer},n._performRetry=function(e){this._clearLayout(),this._spin(this._.parts),APP.network.check(),this._.spinTimer=setTimeout(e,300)},s}),define("app/views/core/chaining-list",["require","common","app/views/core/partial","app/views/core/loading-block"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/core/loading-block");return n.SCROLL_BUFFER_PX=750,n.SCROLL_DELAY_MS=0,n.claim=function(e){return this._.view=e,this},n.reset=function(){this._prepare(),this.dom.blocks=[],this._textify(this.dom.root),this._.chainingState={},this._.scroller=this._findScroller(),this._terminateBlockTaskQueue(),this._deafenScrolling()},n.enchain=function(e){this._.blockTaskQueue.push(e),this.pending()},n.pending=function(){this._.chainingState.ended=!1,this._listenScrolling(),this._semaphore("chain","pending")},n.finishUp=function(){this._processBlockTaskQueue(),this.end()},n.end=function(){this._.chainingState.ended=!0,this._deafenScrolling(),this._semaphore("chain","ended"),this._terminateBlockTaskQueue()},n.focus=function(){this.dom&&t.each(this.dom.blocks,function(e){"function"==typeof e.focus&&e.focus()}),t.try(this,"_.chainingState.ended")||this._listenScrolling()},n.blur=function(){this._deafenScrolling()},n._layout=function(e){this.dom=this._build("chaining-list",{element:e.root}),this._semaphore("chain","init")},n._processBlockTaskQueueIfAtScrollFloor=function(){this._defer("check-scroll-floor"),this._isAtScrollFloor()&&this._processBlockTaskQueue()},n._processBlockTaskQueue=function(){this._.chainingState.ended||this._.blockTaskCurrent||(t.try(this,"_.blockTaskQueue.length")?this._performBlockTask(this._.blockTaskQueue.shift()):this.end())},n._performBlockTask=function(e){this._.blockTaskCurrent=e;var t;if(this._.loadingBlock)t=this._.loadingBlock,this.dom.root.appendChild(t.container);else{var i=this._element({parentNode:this.dom.root,classes:"chaining-block"});t=this._.loadingBlock=new r(i)}this.dom.blocks.length?this._defer(this._classify.bind(this,t.container,"show",!0)):this._classify(t.container,"show");var s=this._.blockTaskQueue._uuid;this._.blockTaskCurrent(t,this._onPerformedBlockTask.bind(this,s,t))},n._onPerformedBlockTask=function(e,t,i){var s=this._.blockTaskQueue._uuid;return s&&e!=s?(APP.journal.warn("[CHAINING-LIST] invalid block!",e,s),t.discard()):(i&&(this.dom.blocks.push(i),delete this._.loadingBlock),this._.blockTaskCurrent=null,this._.scrollData=this._getScrollData(!0),void this._processBlockTaskQueueIfAtScrollFloor())},n._terminateBlockTaskQueue=function(){delete this._.blockTaskCurrent,this._.blockTaskQueue=[],this._.blockTaskQueue._uuid=t.generateUUID(),t.try(t.excise(this._,"loadingBlock"),"discard()")},n._listenScrolling=function(){t.try(this,"_.blockTaskQueue.length")&&(this._.scrollHandler?APP.router.route.on(this._.scrollHandler):this._.scrollHandler=APP.router.route.on("arena:scroll",this._onArenaScroll.bind(this)),this._processBlockTaskQueueIfAtScrollFloor())},n._deafenScrolling=function(){APP.router.route.off(this._.scrollHandler)},n._onArenaScroll=function(e){this._.scrollData=e.m,this.SCROLL_DELAY_MS?(this._processBlockTaskQueueSoon||(this._processBlockTaskQueueSoon=t.staggerInvocation(this._processBlockTaskQueueIfAtScrollFloor.bind(this),this.SCROLL_DELAY_MS,this.SCROLL_DELAY_MS)),this._processBlockTaskQueueSoon()):this._processBlockTaskQueueIfAtScrollFloor()},n._isAtScrollFloor=function(){if(this._.view){if(this._.view.controller!=APP.router.route)return!1}else APP.journal.warn("[CHAINING-LIST] unclaimed list",this);var e=t.excise(this._,"scrollData")||this._getScrollData();return e&&e.y>=e.max-this.SCROLL_BUFFER_PX},n._findScroller=function(){if(!this.dom)return!1;var e=t.try(APP,"arena.scroller");return e&&e.element.contains(this.dom.root)?e:void 0},n._getScrollData=function(e){return this._.scroller||(this._.scroller=this._findScroller()),this._.scroller?e||!this._.scroller.lastScroll?this._.scroller._recomputeScrollData():this._.scroller.lastScroll:void 0},s}),define("app/views/library/the-end-block",["require","app/views/core/partial"],function(e){var t=e("app/views/core/partial"),i=t.new(),s=i.prototype;return s._layout=function(){this.dom=this._build("the-end-block",{button:!0,spoken:"a11y.scroll-to-top"}," fleuron .the-end-fin",{icon:"the-end"})},s._onTap=function(){APP.arena.scroller.scrollToTop()},i}),define("app/views/core/dynamic-list",["require","common","app/views/core/chaining-list","shibui/src/components/edit-rail","app/views/library/the-end-block"],function(e){var t=e("common"),i=e("app/views/core/chaining-list"),s=i.new(),n=s.prototype,r=e("shibui/src/components/edit-rail"),o=e("app/views/library/the-end-block");return n.DEFAULT_BLOCK_SIZE=12,n.$init=function(e){i.prototype.$init.call(this,e),this._.blockSize=this.DEFAULT_BLOCK_SIZE,this._.itemOffset=0},n.configure=function(e){var t;if(this._.defs=this._.defs||{},"undefined"!=typeof e.blockSize&&(e.blockSize!=this._.blockSize&&(t="repopulate"),this._.blockSize=e.blockSize),"undefined"!=typeof e.pageNumber&&((e.pageNumber-1)*this._.blockSize!=this._.itemOffset&&(t="repopulate"),this._.itemOffset=(e.pageNumber-1)*this._.blockSize),"undefined"!=typeof e.pageFactory&&(e.pageFactory!=this._.defs.pageFactory&&(t="reset"),this._.defs.pageFactory=e.pageFactory),"undefined"!=typeof e.pageControls&&(e.pageControls!=this._.defs.pageControls&&(t="reset"),this._.defs.pageControls=e.pageControls),"function"==typeof e.theEndBlock)this._.defs.theEndBlock=e.theEndBlock;else if("undefined"!=typeof e.theEndBlock){var i=e.theEndBlock;this._.defs.theEndBlock=function(e){e(i)}}return"number"==typeof e.pageLimit&&(e.pageLimit!=this._.defs.pageLimit&&(t="reset"),this._.defs.pageLimit=e.pageLimit,"function"==typeof e.pageLimitBlock&&(this._.defs.pageLimitBlock=e.pageLimitBlock)),"undefined"!=typeof e.itemFactory&&(e.itemFactory!=this._.defs.itemFactory&&(t="reset"),this._.defs.itemFactory=e.itemFactory),"undefined"!=typeof e.itemRefresh&&(e.itemRefresh!=this._.defs.itemRefresh&&(t="repopulate"),this._.defs.itemRefresh=e.itemRefresh),"undefined"!=typeof e.itemSignature&&(e.itemSignature!=this._.defs.itemSignature&&(t="reset"),this._.defs.itemSignature=e.itemSignature),"undefined"!=typeof e.itemRailActions&&(e.itemRailActions!=this._.defs.itemRailActions&&(t="reset"),this._.defs.itemRailActions=e.itemRailActions),"undefined"!=typeof e.itemDelete&&(e.itemDelete!=this._.defs.itemDelete&&(t="reset"),this._.defs.itemDelete=e.itemDelete),"undefined"!=typeof e.ignoreScrolling&&(this._.ignoreScrolling=e.ignoreScrolling),"reset"==t?(this.reset(),this.repopulate()):"repopulate"==t&&this.repopulate(),this},n.reset=function(){i.prototype.reset.call(this),this._.groupBlocks=[],this._.elements=[],this._.population=[],this._.cache={},this._.finalized=!1},n.populate=function(e){this._.lastItems=e||[],this._.elements=this._.elements||[],this._.cache=this._.cache||{};var i=!1,s=[],n=[];if(this._.finalized){var r=t.last(this.dom.blocks),o=t.try(r,"dom.root.parentNode");o=o||t.try(r,"parentNode"),t.try(r,"extract()"),o&&o.parentNode.removeChild(o),this._.lastFinalBlock=r,this._.finalized=!1}var a=this._.elements.length;a=Math.ceil(a/this._.blockSize)*this._.blockSize,a=Math.min(a,e.length);for(var l=0;l<a;++l){var c=e[l],h=this._.defs.itemSignature(c),u=this._produceElement(c,h);u&&(s.push(u),n.push(c))}t.each(this._.elements,function(e){s.indexOf(e)<0&&(this._removeElement(e),i=!0)},this);var p=this._.groupBlocks,d=Math.ceil(s.length/this._.blockSize);if(p.length<d)for(var l=p.length;l<d;++l){var m=this._makeBlock(l*this._.blockSize,(l+1)*this._.blockSize);this._element({parentNode:this.dom.root,classes:"chaining-block show"}).appendChild(m.root),p.push(m)}else if(p.length>d){for(var l=d;l<p.length;++l)p[l].root.parentNode&&p[l].root.parentNode.removeChild(p[l].root);p.length=d}this.dom.blocks=p.slice(0);return t.each(s,function(e,t){var s=Math.floor(t/this._.blockSize),n=t%this._.blockSize,r=p[s];r.group.children[n]!=e&&(this._insertElement(e,r.group,n),i=!0)},this),this._.itemCursor=s.length,this._.elements=s,this._.population=n,this._terminateBlockTaskQueue(),this.enchain(this._addAnotherBlock.bind(this)),this._.itemCursor.length||this._processBlockTaskQueue(),i},n.repopulate=function(){this._.population.length&&(this.populate(this._.population),APP.imageDirector.recalculate())},n.focus=function(){t.each(this._.elements,this._refreshElement.bind(this))},n.unpopulate=function(e){t.each(t.flatten([e]),function(e){var i=this._.cache[this._.defs.itemSignature(e)];t.try(i,"extract()")||t.try(i,"parentNode.removeChild()",i),this._onDelete(e,i)},this)},n._produceElement=function(e,t){var i=this._.cache[t];return i=i?this._refreshElement(i,e):this._generateElement(e,t)},n._generateElement=function(e,i){var s=this._.defs.itemFactory(e),n=s._prepare?s._prepare().root:s,o=this._onDelete.bind(this,e,n);if(this._.defs.itemRailActions){var a=t.flatten([this._.defs.itemRailActions]);a=t.select(a,function(i){i=t.absorb(i,{});var n=t.excise(i,"button")||APP.noop;return i.retain?i.button=function(){n(e,s)}:i.button=function(){n(e,s),o()},i},this),new r(n,a)}else this._.defs.itemDelete&&(new r(n,o).TERMINAL_PERCENT=.45);return this._.cache[i]=s},n._insertElement=function(e,t,i){e?"function"==typeof e.impart?"number"==typeof i&&t.children[i]?e.impart(t.children[i],"before"):e.impart(t):"number"==typeof i&&t.children[i]?t.insertBefore(e,t.children[i]):t.appendChild(e):APP.journal.warn("[DYNAMIC-LIST] cannot insert missing element")},n._refreshElement=function(e,t){return"function"==typeof this._.defs.itemRefresh?this._.defs.itemRefresh(e,t):"function"==typeof e.refresh&&e.refresh(),e},n._removeElement=function(e){e?"function"==typeof e.extract?e.extract():t.try(e,"parentNode.removeChild()",e):APP.journal.warn("[DYNAMIC-LIST] cannot remove missing element")},n._onDelete=function(e,i){var s=this._.defs.itemSignature(e);i=i||this._.cache[s],t.excise(this._.population,e),t.excise(this._.elements,i),t.excise(this._.cache,s),"function"==typeof this._.defs.itemDelete&&this._.defs.itemDelete(e)},n._addAnotherBlock=function(e,t){var i=this._.itemCursor+this._.itemOffset,s=i+this._.blockSize;return this._.itemCursor+=this._.blockSize,this._.chainingState.ended?t():void this._retryLoadingTask({factory:this._.defs.pageFactory||this._defaultPageFactory.bind(this),rangeStart:i,rangeEnd:s,loadingBlock:e,onComplete:t})},n._retryLoadingTask=function(e){e.factory(e.rangeStart,e.rangeEnd,this._loadingTaskSuccess.bind(this,e),this._loadingTaskFailure.bind(this,e))},n._defaultPageFactory=function(e,t,i){e-=this._.itemOffset,t-=this._.itemOffset,i(this._.lastItems.slice(e,t))},n._loadingTaskSuccess=function(e,t){var i=this._makeBlock(e.rangeStart,e.rangeEnd);this._onItemsForBlock(t,i,e.loadingBlock),i.group.children.length?(e.loadingBlock.supplant(i.root),e.onComplete(i),APP.imageDirector.recalculate()):t._unfinished?this._addAnotherBlock(e.loadingBlock,e.onComplete):e.onComplete()},n._loadingTaskFailure=function(e,i){if((t.try(i,"head")||t.try(i,"lede"))&&e.loadingBlock.explain(i.head,i.lede),i&&i.retry){var s=this._retryLoadingTask.bind(this,e);e.loadingBlock.showRetryButton(s)}else i.button&&e.loadingBlock.showButton(i.button.label,i.button.action),this.end()},n._makeBlock=function(e,t){var i={};if(this._.defs.pageControls&&!this._.chainingState.ended){var s=Math.ceil(t/this._.blockSize);i.pageControls=this._.defs.pageControls(s,e,t),i.pageControls&&(i.root=this._element(),i.divider=this._element({parentNode:i.root,classes:"chaining-divider"}),i.divider.appendChild(i.pageControls))}return i.root?i.group=this._element({parentNode:i.root,classes:"chaining-group"}):i.group=i.root=this._element({classes:"chaining-group"}),this._.groupBlocks.push(i),i},n._onItemsForBlock=function(e,i,s){return e.length?(t.each(e,function(e,s){var n=this._.defs.itemSignature(e),r=this._produceElement(e,n);t.among(r,this._.elements)||this._.elements.push(r),t.among(e,this._.population)||this._.population.push(e),this._insertElement(r,i.group)},this),void(this._.groupBlocks.length<(this._.defs.pageLimit||1/0)?this.enchain(this._addAnotherBlock.bind(this)):this._.defs.pageLimitBlock&&this._enchainFinalBlock(s))):this._enchainFinalBlock(s)},n._enchainFinalBlock=function(e){this._.finalized||(this._.finalized=!0,this._classify(e.container,"show"),this._.defs.pageLimitBlock?(this.enchain(this._.defs.pageLimitBlock),this._defer("finish-up",this.finishUp.bind(this))):this._.defs.theEndBlock?this.enchain(function(e,t){this._.defs.theEndBlock(function(i){var s=i;i===!0&&this._.lastFinalBlock instanceof o?s=this._.lastFinalBlock:i===!0&&(s=new o),t(e.supplant(s)),this._defer("finish-up",this.finishUp.bind(this))}.bind(this),this._.lastFinalBlock)}.bind(this)):this._defer("finish-up",this.finishUp.bind(this)))},n._processBlockTaskQueueIfAtScrollFloor=function(){(this._.ignoreScrolling||this._isAtScrollFloor())&&this._processBlockTaskQueue()},s}),define("app/views/core/series-number",["require","common","shibui/src/view"],function(e){var t=e("common"),i=e("shibui/src/view"),s=i.new(),n=s.prototype;return n.become=function(e,i,s){this.title=i,this._.pedestalOptions=t.absorb(s,{mini:!0}),this._textify(this.dom.text,{label:"title.series-number",substitutions:{LABEL:e,SERIES:i.series.name},wrapper:!1})},n._layout=function(){this.dom=this._build("series-number",{button:!0}," text",{tag:"span",html:"…"})},n._onTap=function(){this.title&&e(["app/views/library/series-pedestal"],function(e){var t=new e;t.SIZE=96,t.become(this.title,this._.pedestalOptions),APP.arena.shade(t,{springs:[.5,.8],constrainToContentHeight:!1})}.bind(this))},s}),define("app/views/core/title-tile-underline",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.MIN_TIMEOUT=3e3,n.become=function(e){if(this._prepare(),this._semaphore("purpose",e.purpose),this._defer("progress"),this._setProgress(0),e.progress&&e.lifespan){var i=t.epochMilliseconds();this._.lifespan=e.lifespan,this._.lifeStart=i-this._.lifespan*e.progress,this._defer("progress",this._updateProgressLifespan.bind(this,e.purpose),300)}else e.progress&&this._defer("progress",this._setProgress(e.progress),300)},n._layout=function(){this.dom=this._build("title-tile-underline"," track"," progress")},n._setProgress=function(e){if("number"==typeof e){var t=Math.min(100,Math.max(0,100*e));this.dom.progress.style.setProperty("width",t+"%")}else this.dom.progress.style.removeProperty("width")},n._updateProgressLifespan=function(e){if(this.isInDocument()){var i=t.epochMilliseconds(),s=i-this._.lifeStart,n=this._.lifespan-s,r=s/this._.lifespan;if(this._setProgress(r),"expiry"==e){var o=2592e5,a="expiry"+(n<o?"-warning":"");this._semaphore("purpose",a)}var l=Math.ceil(n/100);l=Math.min(t.MAX_TIMEOUT,Math.max(this.MIN_TIMEOUT,l)),this._defer("progress",this._updateProgressLifespan.bind(this,e),l)}},s}),define("app/views/popovers/popover-expando",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.watch=function(e){APP.events.onContact(e,{end:this._onContactEnd.bind(this,e)})},s._onContactEnd=function(e){this._isElementTruncated(e)?t.defer(this,"expand",this._expandToPopover.bind(this,e),100):t.defer(this,"expand")},s._isElementTruncated=function(e){return e.clientWidth<e.scrollWidth||e.clientHeight<e.scrollHeight},s._expandToPopover=function(e){APP.arena.popover(e).notice({html:e.innerHTML})},i}),define("app/views/core/title-tile",["require","common","app/views/core/title-partial","app/views/core/cover-box","app/views/core/star-rating","app/views/core/series-number","app/views/dialogs/dialog-manage-possession","app/views/core/title-status","app/views/shelf/shelf-whisperer","app/views/core/title-tile-underline","app/views/components/library/talker-avatar","app/views/components/common/wait-list-summary","app/views/popovers/popover-expando"],function(e){var t=e("common"),i=e("app/views/core/title-partial"),s=i.new(),n=s.prototype,r=e("app/views/core/cover-box"),o=e("app/views/core/star-rating"),a=e("app/views/core/series-number"),l=e("app/views/dialogs/dialog-manage-possession"),c=e("app/views/core/title-status"),h=e("app/views/shelf/shelf-whisperer"),u=e("app/views/core/title-tile-underline"),p=e("app/views/components/library/talker-avatar"),d=e("app/views/components/common/wait-list-summary"),m=e("app/views/popovers/popover-expando");return n.ACTIONS=t.absorb(n.ACTIONS,{}),n._layout=function(e){this._build("title-tile",{extending:e}," shell","  head","   facts","    extra","    biblio <h3>","     author",{access:"visual"},"     action",{link:"#"},"      title <span>","      action-description <span>",{describing:"action",access:["spoken",{"aria-hidden":"true"}]},"   status",{button:!0},"    title-status",c,"  cover-box",r,"  actions","   row","   row","   row","   row"," talker")},n._fillOut=function(e,t){this._defer("title-status",function(){e.titleStatus.become(t,this.options)}.bind(this),100)},n._onTapStatus=function(e){this.dom.titleStatus.tapped(e)},n._specify=function(e,t){var s=i.prototype._specify.apply(this,arguments);return t.journeyBar===!0?s.actions[3]="reading-journey,bar,"+this.title.journey().progress:t.journeyBar===!1&&(s.actions[3]=null),s},n._specifyForTitle=function(e,t){if(e.biblio=this._specTitleBiblio(t),e.cover=this._specTitleCover(t,{zoomable:!0}),t.parentMagazineId)return this._specifyForMagazineSeries(e,t);if(e.extra=[],t.isPrerelease){var i=this._specTitlePrerelease(t);i&&e.extra.push(i)}var s=t.seriesReadingOrder();s&&"string"==typeof s.label&&e.extra.push("series,"+s.label);var n=this._possessionForAnotherLibrary("loan","hold");n?e.extra=this._specWhisperer(n):e.extra=e.extra.join("+"),e.actions.push(this._specTitleCirc(t)),e.actions.push(this._specTitleOpen(t)),e.actions.push(this._specTitleTags(t)),"shelf"!=this.provenance?e.actions.push(this._specTitleReturned(t)):this._library()&&e.actions.push("title-details"),e.talker=this._specTitleTalker(t)},n._specifyForLoan=function(e,t){e.tileClass="loan",e.biblio=this._specTitleBiblio(t.title),e.cover=this._specTitleCover(t.title,{zoomable:!0}),e.extra=this._specWhisperer(t),e.actions.push(this._specTitleOpen(t.title,t)),e.actions.push("loan-manage,card-icon"),e.actions.push("date-due,"+t.expireTime),e.actions.push("reading-journey,bar,"+t.journey.progress),e.talker=this._specTitleTalker(t.title)},n._specifyForHold=function(e,i){e.tileClass="hold",e.biblio=this._specTitleBiblio(i.title),e.cover=this._specTitleCover(i.title,{zoomable:!0}),e.extra=this._specWhisperer(i);var s=this._holding(i.title,i);i.isAvailable?e.actions.push("title-circ,borrow-hold,"+i.psnKey):s&&s.isOnlyAvailableAsLuckyDayLoan()?e.actions.push(t.compact(["title-circ","borrow","lucky-day",s.libraryKey||null]).join(",")):s&&e.actions.push(t.compact(["wait-estimate","short",s.estimatedWaitInDays()]).join(",")),
e.actions.push("hold-manage,card-icon");var n=!1;t.each(this.possessions,function(e){n=n||"loan"==e.type}),i.isSuspended()?(e.actions.push(this._specTitleOpen(i.title)),i.isRedeliverable?e.actions.push("date-redelivering,"+i.redeliveryDate().getTime()):e.actions.push("date-suspended,"+i.suspendedDaysRemaining())):i.isAvailable&&i.isRedeliverable&&!n?(e.actions.push("hold-redeliver,"+i.psnKey),e.actions.push("date-created,hold")):(e.actions.push(this._specTitleOpen(i.title)),e.actions.push("date-created,hold")),e.talker=this._specTitleTalker(i.title)},n._specifyForMagazineSeries=function(e,t){t.series&&(e.extra="magazine-series"),e.actions.push(this._specMagazineOpen(t)),e.actions[0].match(/unowned/)?(e.actions.unshift("title-circ,unowned"),e.actions.push(this._specTitleTags(t))):(e.actions.push("magazine-issues"),e.actions.push("magazine-subscribe")),e.talker=this._specTitleTalker(t)},n._specTitleReturned=function(e){var t=null;return e.journey().coalesce(function(e){var i=e.lastLoanAct();if(i){var s="borrow"==i.action?"borrow":"return";t="date-circulated,"+s+","+i.createTime}}.bind(this)),t},n._specTitleTalker=function(e){if(SPARK.locale.isEnglish&&"shelf"==this.provenance&&"hold"==this.principal.type&&t.among("talker",this.options.inclusions))return"wait-list-summary";if("library"==this.provenance){var i=t.among("talker",this.options.inclusions),s={link:this._linkTo("title")};if(i)e.talkers().use(function(i,n){if(!i.isBroken){if(!i.isIdeal)return n.reuse(this.refresh,this);var r=n.best();r&&t.absorb({note:r.note,noteType:r.noteType,curator:r.curator,format:e.format},s)}},this);else if(s.note=e.blurb.excerpt(200),!s.note)return{note:"&nbsp;"};return s}},n._executeSpecification=function(e,i,s,n){if(this._semaphore("tile-class",i.tileClass),this._differs(i,"biblio")&&(this._semaphore("title-tile-format",i.biblio.format),this._executeBiblioSpec(e,i.biblio)),this._differs(i,"cover")&&(this._executeCoverSpec(e,i.cover,s),e.coverBox.access("visual")),this._differs(i,"extra")){if(this._textify(e.extra),"string"==typeof i.extra){var r=i.extra.match(/^whisperer,?(.*)/);r?new h(e.extra).become(this,r[1]):"magazine-series"==i.extra?s.series.isPeriodical===!1?this._textify(e.extra,"title.magazine.special"):this._textify(e.extra,"title.magazine.series"):t.each(i.extra.split("+"),function(t){var i=t.split(",");if("prerelease"==i[0])this._classify(this._showPrereleaseInfo(e.extra,s,i),"title-tile-extra-prerelease");else if("star-rating"==i[0]){var n=new o(e.extra);n.become(s.stars)}else if("series"==i[0]){var r=this._library();if(r){var l=new a(e.extra);l.become(i[1],s,{library:r})}}},this)}var l=e.extra.childNodes.length;this._classify(e.root,"has-extra",!!l),t.DataClass.set(e.root,"extra-lines",l>1?l:null)}var c=this._differs(i,"keys");if(t.each(i.actions,function(e,t){if(c||this._differs(i,"actions."+t)){var s=this.dom.actions.children[t];this._rowAsAction(s,this._action(e))}},this),this._differs(i,"talker"))if(this._textify(this.dom.talker),t.DataClass.set(this.dom.talker,"note-type"),"wait-list-summary"==i.talker){var u=this._element({classes:"title-tile-talker-link"}),f="hold"==t.try(this.principal,"type")&&this.principal,g=this._holding(s,f);new d(u).become(s,g,{hold:f,showCreationDate:f.isSuspended()}),(new m).watch(u),this.dom.talker.appendChild(u)}else if(t.try(i.talker,"note")){if(i.talker.noteType){var b=new p,v=this._element({button:function(e){b.presentPopover(e.target)},parentNode:this.dom.talker,classes:"title-tile-talker-circle",spoken:{label:"a11y.note-plate.note-type."+i.talker.noteType,substitutions:{FORMAT:i.talker.format,CURATOR_NAME:t.try(i.talker.curator,"name"),CURATOR_LOCATION:t.try(i.talker.curator,"location")}}});b.impart(v),b.become(i.talker),t.DataClass.set(this.dom.talker,"note-type",i.talker.noteType)}this._element({link:i.talker.link,parentNode:this.dom.talker,classes:"title-tile-talker-link",html:i.talker.note,wrapper:!1})}},n.ACTIONS["loan-manage"]=function(){return{label:"action.loan.manage",button:function(e){var i=["availabilities","title-circ","title-sample"],s=t.try(this.principal,"fulfiller");s&&"choose"==s.defaultFulfillmentType()&&i.push("loan-open"),(new l).become(this.title,{provenance:this.provenance,possessions:this.possessions,collation:this.options.collation,library:t.try(this,"principal.library"),exclusions:i}).present()}.bind(this)}},n.ACTIONS["hold-manage,card-icon"]=function(){var e=this.ACTIONS["loan-manage"].call(this);return t.absorb({label:"action.hold.manage"},e)},n.ACTIONS["reading-journey,bar"]=function(e){var t=parseFloat(e)||0,i=Math.round(100*t);return i?{link:this._linkTo("journey"),classes:"title-tile-journey-percent",visual:{label:"journey-bar.progress",substitutions:{PERCENT:i}},spoken:{label:"a11y.journey-bar.progress",substitutions:{PERCENT:i}},underline:{progress:t,purpose:"reading-progress"}}:{link:this._linkTo("journey"),label:"title.borrowed",classes:"title-tile-journey-link",substitutions:{CREATE_TIME:this.principal.createTime},underline:!0}},n.ACTIONS["date-due"]=function(){var e=this.principal,t="return";return e.isWithinRenewalWindow()&&(t+="?expiring="+e.daysRemaining()),{link:this._linkTo(e,t),html:function(t){this._textify(t),this._countdownToExpiry(this._element({parentNode:t,classes:"title-tile-journey-link"}),e)}.bind(this)}},n.ACTIONS["date-redelivering"]=function(e){return{label:"hold.redelivering",substitutions:{REDELIVERY_DATE:parseFloat(e)},classes:"title-tile-suspended-link",link:this._linkTo("hold","redeliver")}},n.ACTIONS["date-suspended"]=function(e){return{label:"hold.suspended",substitutions:{DAYS:e},classes:"title-tile-suspended-link",link:this._linkTo("hold","suspend")}},n.ACTIONS["date-created"]=function(e){return{label:e+".created",classes:"title-tile-journey-link",substitutions:{CREATE_TIME:this.principal.createTime},link:this._linkTo("journey")}},n.ACTIONS["date-circulated"]=function(e,i){var s={substitutions:{},classes:"title-tile-journey-link",link:this._linkTo("journey")};i=parseFloat(i);var n=t.epochMilliseconds()<i+28512e6;return n&&"return"==e?(s.label="title.returned",s.substitutions.RETURN_TIME=i):n?(s.label="title.borrowed",s.substitutions.CREATE_TIME=i):(s.label="title.borrowed.year",s.substitutions.LOAN_YEAR=new Date(i).getFullYear()),s},n._addUnderline=function(e,t){var i=this._findViewWithin(e,u);return this._classify(e,"is-underlined",!!t),t?(i=i||new u(e),void i.become(t)):void(i&&i.extract())},s}),define("app/views/core/title-plank",["require","common","app/views/core/title-partial","app/views/core/cover-box","app/views/core/title-status","app/views/core/star-rating","app/views/core/series-number","app/views/shelf/shelf-whisperer","app/views/dialogs/dialog-manage-possession"],function(e){var t=e("common"),i=e("app/views/core/title-partial"),s=i.new(),n=s.prototype,r=e("app/views/core/cover-box"),o=e("app/views/core/title-status"),a=e("app/views/core/star-rating"),l=e("app/views/core/series-number"),c=e("app/views/shelf/shelf-whisperer"),h=e("app/views/dialogs/dialog-manage-possession");return n._layout=function(e){this._build("title-plank",{extending:e}," flex-col","  flex-row","   cover-box",r,"   details","    main","     biblio <h3>","      action",{link:"#"},"       title <span>","       action-description <span>",{describing:"action",access:["spoken",{"aria-hidden":"true"}]},"      author",{access:"visual"},"     extra","     journey",{link:"#"},"   gutter","    actions",{button:!0},"     title-status",o)},n._fillOut=function(e,t){this._defer("title-status",function(){this.dom.titleStatus.become(t,this.options)}.bind(this),100),this._classify(e.root,"is-mini",!!this.options.mini)},n._onTapActions=function(e){var t={library:this._library()};(new h).become(this.title,t).present()},n._specifyForTitle=function(e,i){if(e.biblio=this._specTitleBiblio(i),e.cover=this._specTitleCover(i,{zoomable:!0}),e.extra=t.compact([this._specWhisperer(r)]),i.isPrerelease){var s=this._specTitlePrerelease(i);s&&e.extra.push(s)}var n=i.seriesReadingOrder();n&&"string"==typeof n.label&&e.extra.push("series,"+n.label),e.extra=e.extra.join("+");var r=this._possessionForAnyLibrary(["loan","hold"]);i.journey().coalesce(function(t){if(!e.journey){var i=t.lastLoanAct();if(i){var s="borrow"==i.action?"borrow":"return";e.journey="date-circulated,"+s+","+i.createTime}}}.bind(this))},n._specifyForLoan=function(e,t){this._specifyForTitle(e,t.title),e.extra=this._specWhisperer(t),e.journey="date-due,"+t.expireTime},n._specifyForHold=function(e,t){this._specifyForTitle(e,t.title),e.extra=this._specWhisperer(t),t.isSuspended()?t.isRedeliverable?e.journey="date-redelivering,"+t.redeliveryDate():e.journey="date-suspended,"+t.suspendedDaysRemaining():e.journey="date-created,hold"},n._executeSpecification=function(e,i,s,n){if(this._differs(i,"biblio")&&this._executeBiblioSpec(e,i.biblio),this._differs(i,"cover")&&(this._executeCoverSpec(e,i.cover,s),e.coverBox.access("visual")),this._differs(i,"journey"))if(this._linkify(e.journey),this._classify(e.root,"has-journey",!!i.journey),this._classify(e.journey,"title-plank-dateline","string"==typeof i.journey&&i.journey.match(/^date/)),"string"==typeof i.journey){var r=i.journey.split(",");if("date-returned"==r[0]){var o=parseFloat(r[1]);this._textify(e.journey,{label:"title.returned",substitutions:{RETURN_TIME:o}}),this._linkify(e.journey,this._linkTo("journey"))}else if("date-due"==r[0]){var h=parseFloat(r[1]);this._textify(e.journey,{label:"loan.expiry.full",substitutions:{EXPIRE_TIME:h}}),this._linkify(e.journey,this._linkTo("journey"))}else"date-created"==r[0]?(this._textify(e.journey,{label:r[1]+".created.full",substitutions:{CREATE_TIME:this.principal.createTime}}),this._linkify(e.journey,this._linkTo("journey"))):"date-redelivering"==r[0]?(this._textify(e.journey,{label:"hold.redelivering.full",substitutions:{REDELIVERY_DATE:this.principal.redeliveryDate()}}),this._linkify(e.journey,this._linkTo("hold","redeliver"))):"date-suspended"==r[0]&&(this._textify(e.journey,{label:"hold.suspended.full",substitutions:{DAYS:parseFloat(r[1])}}),this._linkify(e.journey,this._linkTo("hold","suspend")))}else this._textify(e.journey);this._differs(i,"extra")&&(this._classify(e.root,"has-extra",!!i.extra),this._textify(e.extra),"string"==typeof i.extra&&t.each(i.extra.split("+"),function(t){var i=t.split(",");if("whisperer"==i[0]){var n=i.slice(1).join(",");new c(e.extra).become(this,n)}else if("prerelease"==i[0])this._classify(this._showPrereleaseInfo(e.extra,s,i),"title-plank-extra-prerelease");else if("star-rating"==i[0]){var r=new a(e.extra);r.become(s.stars)}else if("series"==i[0]){var o=this._library();if(o){var h=new l(e.extra);h.become(i[1],s,{library:o})}}},this))},n._specTitleCover=function(e,t){var s=i.prototype._specTitleCover.apply(this,arguments);return"shelf"==this.provenance&&(s.action="manage"),s},n.ACTIONS.manage=function(){return{button:this._onTapActions.bind(this)}},s}),define("app/views/core/title-stand",["require","common","app/views/core/title-partial","app/views/core/cover-box","app/views/core/title-status","app/views/dialogs/dialog-manage-possession"],function(e){var t=e("common"),i=e("app/views/core/title-partial"),s=i.new(),n=s.prototype,r=e("app/views/core/cover-box"),o=e("app/views/core/title-status"),a=e("app/views/dialogs/dialog-manage-possession");return n._layout=function(e){this._build("title-stand",{extending:e}," upper","  cover-box",r," lower","  action",{button:!0},"   text","    title",{access:"visual"},"    extra","   icon","    title-status",o)},n._fillOut=function(e,t){this._defer("title-status",function(){this.dom.titleStatus.become(t,this.options)}.bind(this),100)},n._specify=function(e,i){var s=this._newSpecification(e);if(s.cover=this._specTitleCover(e,{zoomable:!0}),s.biblio={title:e.title},t.try(this.principal,"isMarkedAsFinished()"))s.extra={label:"title.magazine.marked-as-finished"},s.cover.dim=!0;else if(t.try(this.principal,"isLatestIssueOfSubscription()"))s.extra={label:"title.magazine.latest"};else{var n=t.try(this.principal,"daysToKeepInRack()");n&&(s.extra={label:"title.magazine.expiry",substitutions:{DAYS:n}})}return s},n._executeSpecification=function(e,t,i,s){this._differs(t,"biblio")&&this._textify(e.title,{html:t.biblio.title}),this._differs(t,"cover")&&(this._executeCoverSpec(e,t.cover,i),this._classify(e.root,"is-cover-dimmed",!!t.cover.dim)),this._differs(t,"extra")&&(this._classify(e.root,"has-extra",!!t.extra),this._textify(e.extra,t.extra))},n._onTapAction=function(e){var t={library:this._library(),list:this.options.list,possessions:this.possessions,forceType:this.options.forceType,exclusions:this.options.exclusions||[]};this.possessions.length||t.exclusions.push("journey"),(new a).become(this.title,t).present()},s}),define("app/views/core/title-list",["require","common","app/views/core/dynamic-list","./title-tile","./title-plank","./title-stand"],function(e){var t=e("common"),i=e("app/views/core/dynamic-list"),s=i.new(),n=s.prototype;return n.ITEM_TYPES={tile:e("./title-tile"),plank:e("./title-plank"),stand:e("./title-stand")},n.BLOCK_SIZE=12,n.$init=function(e,t,s){i.prototype.$init.call(this,e),this._.itemType=t||"tile",this._.itemClass=s||this.ITEM_TYPES[this._.itemType],this.configure({blockSize:this.BLOCK_SIZE,itemFactory:this._itemFactory.bind(this),itemSignature:this._itemSignature.bind(this)})},n.populate=function(e){var t=this._itemsFromOptions(e||{});return this._.itemOptions=e,i.prototype.populate.call(this,t)},n._makeBlock=function(){var e=i.prototype._makeBlock.apply(this,arguments);return this._classify(e.group,"title-list title-list-"+this._.itemType+"s"),e},n._itemFactory=function(e){var i=new this._.itemClass,s=t.absorb(this._.itemOptions,t.absorb(e,{}));return i.become(t.excise(s,"title"),s),i},n._itemSignature=function(e){return e.title.titleId},n._refreshElement=function(e,s){return e.options=t.absorb(this._.itemOptions,t.absorb(s,{})),t.excise(e.options,"title"),i.prototype._refreshElement.call(this,e,s)},n._itemsFromOptions=function(e){var i=[];return t.each(t.excise(e,"titles"),function(e){for(var t=0,s=i.length;t<s;++t)if(i[t].title.titleId==e.titleId)return;i.push({title:e})}),t.each(t.excise(e,"activities"),function(e){for(var t=0,s=i.length;t<s;++t)if(i[t].title.titleId==e.title.titleId)return;i.push({title:e.title,library:e.library})}),t.each(t.excise(e,"possessions"),function(e){for(var t=0,s=i.length;t<s;++t)if(i[t].title.titleId==e.title.titleId)return i[t].possessions=i[t].possessions||[],void i[t].possessions.push(e);i.push({title:e.title,possessions:[e]})}),i},n._onItemsForBlock=function(e,s,n){e&&!t.isList(e)&&(e=this._itemsFromOptions(e)),i.prototype._onItemsForBlock.call(this,e,s,n)},s}),define("app/views/library/series-pedestal",["require","common","app/views/core/partial","app/views/core/block-strap","app/views/core/title-list","shibui/src/components/chevron"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/core/block-strap"),o=e("app/views/core/title-list"),a=e("shibui/src/components/chevron");return n.PLANKS_PER_PAGE=7,n.STANDS_PER_PAGE=8,n.become=function(e,i){this.title&&e.titleId==this.title.titleId||(this._.originList=t.excise(i||{},"list"),this._.library=t.excise(i||{},"library")||t.try(this._.originList,"library")||APP.library,this._.itemOptions=t.absorb(i,{}),this.title=e,this.title.use(this._become.bind(this)))},n.focus=function(){t.try(this.dom,"chain.focus()")},n._layout=function(e){this._build("series-pedestal",{extending:e}," strap",r," content")},n._become=function(e,i){return i.series&&t.try(i,"languages.length")?!e.isIdeal&&i.parentMagazineId&&"undefined"==typeof i.series.isPeriodical?i.reuse():(this._.seriesList=i.seriesList(this._.library),this._.originList=this._.originList||this._.seriesList,this.impart(),void(i.series.isPeriodical===!1?this._fillOutOneOff(i):(this._.hasReadingOrder=!(!i.parentMagazineId&&!i.seriesReadingOrder()),this._fillOut(i),this._fetchOtherTitles(i)))):e.isIdeal?this.extract():i.reuse()},n._fillOutOneOff=function(e){var t=this._prepare();this._textify(t.content),t.strap.configure({text:{label:"title.details.series"}}),t.disclaimer=this._element({tag:"p",parentNode:t.content,classes:"series-pedestal-special-disclaimer",label:"title.magazine.special.disclaimer",substitutions:{TITLE:e.titleWithoutOrphans()},enliven:{"#series-path":this._.seriesList.path()}})},n._fillOut=function(e){this.isInDocument()||this.impart();var t=this._narrowAndDeepSeriesList().path();this._prepare(),this.dom={root:this.dom.root,strap:this.dom.strap,content:this.dom.content},this.dom.strap.configure({text:{label:"list.source.series.named",substitutions:{SERIES_NAME:e.series.name},link:t},circle:{icon:"block-strap-chevron",link:t}}),this._textify(this.dom.content);var i=this._.hasReadingOrder?"plank":"stand";this._build("",{extending:this.dom,element:this.dom.content}," expando-north .series-pedestal-expando",{button:this._expandList.bind(this,0-this._size()),skip:"stand"==i},"  chevron-north",function(e){return new a(e).bearing("n")}," list","  chain",function(e){return new o(e,i).claim(this)},"  controls","   spinner .spinner",{icon:"spinner-12"}," expando-south .series-pedestal-expando",{button:this._expandList.bind(this,this._size()),skip:"stand"==i},"  chevron-south",function(e){return new a(e).bearing("s")}),this.dom.chain.configure({blockSize:999,ignoreScrolling:!0})},n._fetchOtherTitles=function(e){var t=this._narrowAndDeepSeriesList({facets:"false"}),i=t.params.address();this._.seriesTitles=[],APP.patron.pins.pause(function(){t=this._.library.catalog.lists.produce(i),t.PAGE_SIZE=96,t.freshen(0,t.PAGE_SIZE,this._onFirstBatchOfOtherTitles.bind(this,e),this._retryOtherTitles.bind(this,e))}.bind(this),{scope:"title"})},n._onFirstBatchOfOtherTitles=function(e,t,i){t.totalTitles>i.length?(this._addEligibleTitlesToSeriesList(i),t.freshen(i.length,1/0,this._populateOtherTitles.bind(this,e),this._retryOtherTitles.bind(this,e))):this._populateOtherTitles(e,t,i)},n._populateOtherTitles=function(e,i,s){this._addEligibleTitlesToSeriesList(s),this._classify(this.dom.root,"hide",!this._.seriesTitles.length);var n=Math.max(this._.seriesTitles.indexOf(e),0);this._.rangeStart=Math.max(0,n-Math.floor(this._size()/2)),this._.rangeEnd=Math.min(this._.seriesTitles.length,this._.rangeStart+this._size()),this._expandList(0),t.each(this.dom.list.querySelectorAll(".title-plank[aria-current]"),function(e){this._attr(e,"aria-current",null)},this);var r=this.dom.list.querySelector(".title-plank.data-title_"+e.titleId);r&&(this._attr(r,"aria-current","true"),this.dom.indicator?r.appendChild(this.dom.indicator):this.dom.indicator=this._element({icon:"star-indicator",parentNode:r,classes:"series-pedestal-indicator",access:"visual"}))},n._retryOtherTitles=function(e){var i=this._element({button:function(){t.try(i.parentNode,"removeChild()",i),this._fetchOtherTitles(e)}.bind(this),parentNode:this.dom.controls,classes:"series-pedestal-retry-button",label:"list-chain.retry",pos:"prepend"});t.try(this.dom.retryButton,"parentNode.removeChild()",this.dom.retryButton),this.dom.retryButton=i},n._addEligibleTitlesToSeriesList=function(e){var i=this._size();t.each(e,function(e){(!this._.hasReadingOrder||e.parentMagazineId||e.seriesReadingOrder())&&(this._.hasReadingOrder||e.titleId!=this.title.titleId&&this._.seriesTitles.length!=i)&&this._.seriesTitles.push(e)},this)},n._expandList=function(e){var i=this._.seriesTitles.length;e<0?this._.rangeStart=Math.max(0,this._.rangeStart+e):e>0&&(this._.rangeEnd=Math.min(i,this._.rangeEnd+e));var s=this._.seriesTitles.slice(this._.rangeStart,this._.rangeEnd);this.dom.chain.populate(t.absorb(this._.itemOptions,{titles:s,list:this._.originList})),this._classify(this.dom.root,"more-north",this._.rangeStart>0),this._classify(this.dom.root,"more-south",this._.rangeEnd<i),this._clearSpinner()},n._narrowAndDeepSeriesList=function(e){if(this.title.parentMagazineId)return this._.seriesList;var i={scope:"deep"};"magazine"==this.title.format&&(i.sort="releasedate"),t.absorb(e,i);var s=this.title.seriesList(this._.library,{breadth:"narrow"}),n=s.params.withRefinements(i).address();return this._.library.catalog.lists.produce(n)},n._clearSpinner=function(){this.dom.spinner&&(this.dom.spinner.parentNode.removeChild(this.dom.spinner),delete this.dom.spinner)},n._size=function(){return this._.hasReadingOrder?this.PLANKS_PER_PAGE:this.STANDS_PER_PAGE},s}),define("app/views/screens/library/screen-title-details",["require","common","app/views/screens/screen","app/views/components/library/app-header-with-emblem","app/views/components/search/app-header-search-switcher","app/views/components/library/talker-plate","app/views/components/library/campaign-plate","app/views/library/title-details-actions","app/views/library/title-details-facts","app/views/library/title-journey-preview","app/views/components/filters/filter-cloud","app/views/dialogs/dialog-title-reviews","app/views/core/cover-box","app/views/components/common/cover-3d","app/views/library/series-pedestal","app/views/core/block-strap","app/views/core/title-list"],function(e){var t=e("common"),i=e("app/views/screens/screen"),s=i.new(),n=s.prototype,r=e("app/views/components/library/app-header-with-emblem"),o=e("app/views/components/search/app-header-search-switcher"),a=e("app/views/components/library/talker-plate"),l=e("app/views/components/library/campaign-plate"),c=e("app/views/library/title-details-actions"),h=e("app/views/library/title-details-facts"),u=e("app/views/library/title-journey-preview"),p=e("app/views/components/filters/filter-cloud"),d=e("app/views/dialogs/dialog-title-reviews"),m=e("app/views/core/cover-box"),f=e("app/views/components/common/cover-3d"),g=e("app/views/library/series-pedestal"),b=e("app/views/core/block-strap"),v=e("app/views/core/title-list");return n.RELATED_COUNT=9,n.become=function(e){this.title=e,this.list=this.controller.ancestor.list,this.title?this._fillOut(this.title):APP.journal.warn("[TITLE-DETAILS] Title not found:",this.controller.args)},n.focus=function(){i.prototype.focus.apply(this,arguments);var e=this._prepare();t.try(e.seriesPedestal,"focus()"),e.journey&&this.title&&e.journey.become(this.title.journey())},n._layout=function(e){this._build("screen-title-details",{extending:e}," content .content","  intro .library-intro .bumper-n","   intro-struts .screen-title-details-struts","    biblio","     attribution {blank}","     title <h1> .library-head {loading}","     share-button",{button:!0,spoken:"journey.action.share"},"      share-icon",{icon:"share"},"  content-struts .screen-title-details-struts","   jacket","    cover",m,"    under-cover","     actions",c,"     subjects","      filter-cloud",p,"    blurb","   flap","    reviews","    awards","    other-formats","    colophon","    series","  list .pillar .bumper-e .bumper-s .bumper-w"),e.facts=new h(this.dom.colophon)},n._layoutHeader=function(e){"search"==this.controller.realm?e.header=new o:e.header=new r,e.header.impart(e.root,"prepend")},n._listen=function(e){this._handle("color",this.dom.cover)},n._onTapShareButton=function(e){APP.stasher.shareTitle(this.title,this.dom.shareButton)},n._fillOut=function(e){e.use(function(t){e.title?this._textify(this.dom.title,{html:e.titleWithoutOrphans()}):(e.reuse(),this._textify(this.dom.title,"loading"))},this),e.use(function(i){t.try(e.authors(),"length")||e.reuse(),this._textify(this.dom.attribution,{html:e.attribution()})},this),this.dom.cover.become(e),this.dom.cover.zoomable(!0),e.use(function(t){return e.format?("undefined"==typeof e.series&&e.reuse(),e.series&&!this.dom.seriesPedestal?this.dom.seriesPedestal=new g(this.dom.series):this.dom.seriesPedestal&&(this._textify(this.dom.series),delete this.dom.seriesPedestal),void(this.dom.seriesPedestal&&this.dom.seriesPedestal.become(e,{list:this.list}))):e.reuse()},this),this.dom.actions.become(e,{list:this.list}),e.use(function(){return e.languages?void e.talkers().use(function(e,t){if(!e.isBroken){if(!e.isIdeal)return t.reuse();var i=t.best();i&&(this.dom.talkerPlate=this.dom.talkerPlate||new a,this.dom.talkerPlate.impart(this.dom.underCover,"after"),this.dom.talkerPlate.become(i))}},this):e.reuse()},this),this.dom.journey=new u,this.dom.journey.impart(this.dom.blurb,"before"),this.dom.journey.become(e.journey()),APP.library.catalog.guides.use(function(i,s){if(!i.isIdeal)return s.reuse();var n;t.each(s.home.campaigns,function(i){i.use(function(s){return t.try(i,"titles.length")||s.isIdeal||s.isBroken?void(i.isDisplayable()&&t.each(i.titles,function(t){t.titleId==e.titleId&&(this.dom.campaignPlate?n=this.dom.campaignPlate:(n=new l,n.impart(this.dom.blurb,"before")),n.become(i,e))},this)):i.reuse()},this),n?this.dom.campaignPlate=n:this.dom.campaignPlate&&(this.dom.campaignPlate.extract(),delete this.dom.campaignPlate)},this)},this),e.blurb.use(function(t,i){t.isIdeal||i.reuse(),this._textify(this.dom.blurb,{html:i.description()}),t.isIdeal&&(this._fillOutReviews(e),this._fillOutAwards(e))},this),e.use(function(i){return this._textify(this.dom.otherFormats),t.DataClass.clear(this.dom.otherFormats,"other-format"),e.format?void e.otherFormats(APP.library,function(e,i){var s=i[0];if(s){t.DataClass.set(this.dom.otherFormats,"other-format",s.format);var n=this._element({link:s.path(this.list||e),parentNode:this.dom.otherFormats});this._element({tag:"p",parentNode:n,label:"also-available."+s.format}),new f(n).become(s)}}.bind(this)):e.reuse()},this),this.dom.filterCloud.become({"link-similar":{link:APP.library.catalog.lists.produce("similar-"+e.titleId).path(),classes:"screen-title-details-similar-list",graphic:"filter-cloud-similar"}}),e.use(function(i){e.subjects&&e.subjects.length||e.reuse(),e.subjects&&e.subjects.length&&APP.library.catalog.facets.freshen(function(i){var s=t.select(e.subjects,function(s){var n=e.subjectList(APP.library,s);if(n)return n.totalTitles=n.totalTitles||t.try(i.find({category:"subject",value:s.id}),"[0].totalTitles"),n}).sort(function(e,t){return t.totalTitles-e.totalTitles});t.each(s,function(e){var t=e.name();this.dom.filterCloud.button(t,{link:e.path(),html:t,count:e.totalTitles})},this)}.bind(this))},this),this.dom.facts.become(e),this.list!=this._.filledList&&(this._fillOutList(this.list),this._.filledList=this.list)},n._fillOutReviews=function(e){if(this._textify(this.dom.reviews),t.try(e.blurb,"reviews.length")){var i={premium:[],quotes:[]};if(t.each(e.blurb.reviews,function(e){t.try(e,"source.name")&&i[e.isPremiumReview?"premium":"quotes"].push(e)}),i.premium.length||i.quotes.length){i.premium.sort(function(e,t){return e.isStarredReview&&!t.isStarredReview?-1:t.isStarredReview&&!e.isStarredReview?1:e.source.name.length-t.source.name.length});var s=function(e){var t=new d;return t.become(this.title,e,i),t.present(),t};this._element({tag:"h2",label:"title.details.reviews",parentNode:this.dom.reviews});var n=this._element({tag:"ul",parentNode:this.dom.reviews}),r=[];t.each(i.premium,function(e){var i=t.try(e,"source.name");i&&(t.among(i,r)||(r.push(i),this._build("screen-title-details-review <li>",{parentNode:n}," button",{button:s.bind(this,i)},"  star <span>",{html:e.isStarredReview?"★":"☆",access:"visual"},"  name <span>",{html:t.safe(i)})))},this),i.quotes.length&&this._build("screen-title-details-review <li>",{parentNode:n}," button",{button:s.bind(this,null)},"  star <span>",{html:"☆"},"  name <span> {title-reviews.quotes}",{substitutions:{REVIEW_COUNT:i.quotes.length}})}}},n._fillOutAwards=function(e){if(this._textify(this.dom.awards),t.try(e,"awards.length")){this._element({tag:"h2",label:"title.details.awards",parentNode:this.dom.awards});var i=APP.arena._element({tag:"ul",parentNode:this.dom.awards});t.each(e.awards,function(e){var s=APP.library.catalog.lists.produce("award-"+e.id);this._build("screen-title-details-award <li>",{parentNode:i}," wreath",{icon:"wreath",access:"visual"}," link",{link:s.subpath({sort:"popular"}),html:t.safe(e.description)})},this)}},n._fillOutList=function(e){if(this._textify(this.dom.list),e){var i=e.indexOf(this.title)+1;e.freshen(i,i+this.RELATED_COUNT,function(e,i){if(!(i.length<=2)){var s=this.controller.ancestor,n=s?s.path:e.path(),r=this._element({parentNode:this.dom.list,classes:"pillar"});new b(r).configure({text:{label:"details.list-head",link:n},circle:{icon:"block-strap-chevron",link:n}});var o=t.among(n,APP.historian.history());this._classify(this.dom.list,"hide-orphan-tiles"),this._classify(this.dom.list,"is-going-back",o);var a=new v(this.dom.list);a.configure({ignoreScrolling:!0}),a.populate({list:e,titles:i}),this._element({link:n,parentNode:this.dom.list,classes:"screen-title-details-list-link",label:"details.list-link"})}}.bind(this))}},n._onColorCover=function(e){var i=e.m.rgb.join(",");i!=this._.coverColor&&(this._.coverColor=i,this.controller.waypoint.configure({name:this.title.title,color:t.adjustRGB(e.m.rgb,{min:10,max:95})}))},s}),define("app/controllers/library/title-details-controller",["require","common","app/controllers/train-controller","app/controllers/library/title-circ-controller","app/controllers/shelf/journey-controller","app/views/screens/library/screen-title-details"],function(e){var t=e("common"),i=e("app/controllers/train-controller"),s=i.new(),n=s.prototype;return n.SUB_CONTROLLERS=[e("app/controllers/library/title-circ-controller"),e("app/controllers/shelf/journey-controller")],n.SCREEN_CLASS=e("app/views/screens/library/screen-title-details"),n.configure=function(){this.realm=t.try(this.ancestor,"realm")||"library",this.waypoint.configure({label:"crumb.title"})},n.match=function(e){var t=e.match(/^([\w-]+)\/?(.*)$/);if(t)return this.args={titleId:t[1]},{head:this.args.titleId,tail:t[2]}},n.refine=function(e){var t=this.args,i=this.match(e.replace(/^ROLLBACK:/,""));return i&&"refine"==i.tail?{head:i.head}:void(this.args=t)},n.usher=function(){this.title=APP.titles.produce({titleId:this.args.titleId}),this.title.use(function(e,t){return t.title?void(this.waypoint.name!=t.title&&this.waypoint.configure({name:t.title})):t.reuse()},this)},n.fill=function(){this.screen().become(this.title)},s}),define("app/views/components/library/list-banner",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.$init=function(e){"extended"==e?this._.extended=!0:i.prototype.$init.apply(this,arguments)},n.become=function(e){this.definition=e;var i=this._prepare(),s=t.try(this.definition,"content."+SPARK.locale.tag)||{};return this._.extended?(this._textify(i.details,this._html(s.details)),this._textify(i.exits),t.each(this.definition.exits,function(e){var s=e.path,n=t.try(e.label,SPARK.locale.tag);if(!s&&e.title){var r=APP.titles.produce({titleId:e.title});s=r.path(APP.library),n=n||r.titleWithoutOrphans()}if(!s&&e.list){var o=APP.library.catalog.lists.produce(e.list);s=o.path(),n=n||o.name()}s&&n&&this._build("list-banner-exit <li>",{parentNode:i.exits}," link",{link:s,html:e.label[SPARK.locale.tag]})},this)):this._textify(i.promptLabel,this._html(s.prompt)),this},n._layout=function(e){this._.extended?this._build("list-banner",{extending:e}," extension","  details","  exits <ul>"):this._build("list-banner",{extending:e}," prompt",{button:!0},"  prompt-label")},n._html=function(e){return{html:t.flatten([e]).join(" ")}},n._onTapPrompt=function(e){APP.patron.dismiss(this.definition.dismissKey),APP.arena.shade(new s("extended").become(this.definition))},s}),define("app/views/popovers/popover-paging",["require","common","shibui/src/view"],function(e){var t=e("common"),i=e("shibui/src/view"),s=i.new(),n=s.prototype;return n.PAGING_WINDOW=3,n.PAGING_MAX=1/0,n.PAGING_EXT=2,n.PAGING_GAP="&#x22ef;",n.PAGING_FILL=256,n.become=function(e,t){return this.minPage=1,this.currPage=e||this.minPage,this.maxPage=Math.min(t,this.PAGING_MAX),this},n.present=function(e){return APP.arena.popover(e).choices(this._initialChoices.bind(this))},n._initialChoices=function(e,i){this._classify(i,"paging-choices");var s=this._pagingOptions();
t.each(s,function(t){t.length?e.choice({html:this.PAGING_GAP,classes:"paging-gap",button:this._fillPagingGap.bind(this,e,t)}):e.choice({label:"list.paging",substitutions:{PAGE_NUMBER:t},classes:t==this.currPage?"innate":"",button:this._invokeChange.bind(this,t)})},this)},n._pagingOptions=function(){for(var e=this.currPage,t=[e],i=1;i<=this.PAGING_WINDOW;++i)e-i>this.minPage&&t.unshift(e-i),e+i<this.maxPage&&t.push(e+i);for(var s=[],i=this.minPage+1,n=e-this.PAGING_WINDOW;i<n;++i)s.push(i);s.length&&s.length<this.PAGING_EXT?t=s.concat(t):s.length&&t.unshift(s),e!=this.minPage&&t.unshift(this.minPage);for(var r=[],i=e+this.PAGING_WINDOW+1,n=this.maxPage;i<n;++i)r.push(i);return r.length&&r.length<this.PAGING_EXT?t=t.concat(r):r.length&&t.push(r),e!=this.maxPage&&t.push(this.maxPage),t},n._fillPagingGap=function(e,t,i){i.preventDefault();for(var s,n=i.tappedElement,r=!n.previousSibling.previousSibling,o=n.parentNode,a=r?n.nextSibling:n,l=n.previousSibling,c=0;t.length;){s=t[r?"pop":"shift"]();var h=e.choice({label:"list.paging",substitutions:{PAGE_NUMBER:s},button:this._invokeChange.bind(this,s)});if(o.insertBefore(h,a),r&&(a=h),++c>this.PAGING_FILL)break}t.length||o.removeChild(n),APP.arena.popover().reposition(),setTimeout(function(){l.scrollIntoView()},0)},n._invokeChange=function(e){this._dispatch("choice",{pageNumber:e})},s}),define("app/views/core/paging-controls",["require","common","app/views/core/partial","app/views/core/block-strap","app/views/popovers/popover-paging"],function(e){var t=(e("common"),e("app/views/core/partial")),i=t.new(),s=i.prototype,n=e("app/views/core/block-strap"),r=e("app/views/popovers/popover-paging");return s.become=function(e,t){this.minPage=1,this.currPage=e||this.minPage,this.maxPage=t,isFinite(this.maxPage)||(this.maxPage=this.currPage+1),this._prepare().blockStrap.configure({text:{label:"list.paging",substitutions:{PAGE_NUMBER:this.currPage,PAGE_TOTAL:this.maxPage},button:this._onTapJumpButton.bind(this)},circle:{icon:"block-strap-jump",spoken:"a11y.paging.choose",button:this._onTapJumpButton.bind(this)}})},s._layout=function(){this.dom=this._build("paging-controls"," block-strap",n)},s._onTapJumpButton=function(e){var t=new r;t.become(this.currPage,this.maxPage),t.present(e.target),t.on("choice",function(e){this._dispatch("choice",e.m)}.bind(this))},i}),define("app/views/screens/library/screen-library-list",["require","common","app/views/screens/screen","app/views/components/library/app-header-with-emblem","app/views/components/search/app-header-search-switcher","app/views/components/filters/filter-cloud","app/views/components/filters/filter-cloud-for-list","app/views/components/library/list-banner","app/views/core/title-list","app/views/core/paging-controls","app/views/library/the-end-block"],function(e){var t=e("common"),i=e("app/views/screens/screen"),s=i.new(),n=s.prototype,r=e("app/views/components/library/app-header-with-emblem"),o=e("app/views/components/search/app-header-search-switcher"),a=e("app/views/components/filters/filter-cloud"),l=e("app/views/components/filters/filter-cloud-for-list"),c=e("app/views/components/library/list-banner"),h=e("app/views/core/title-list"),u=e("app/views/core/paging-controls"),p=e("app/views/library/the-end-block");return n.PAGE_LIMIT=5,n.become=function(e,t){this.list&&APP.arena.resetElementFocus(),this.list=e,this.dom.filterCloud.pending(this._.pending=!0),this.dom.chain.reset(),this.dom.chain.configure({pageFactory:this._titlesInRange.bind(this),pageControls:this._paginationControls.bind(this),blockSize:e.PAGE_SIZE,pageNumber:t,pageLimit:this.PAGE_LIMIT,pageLimitBlock:function(i,s){if(e.totalTitles/e.PAGE_SIZE>t+this.PAGE_LIMIT-1){var n=this._element({classes:"screen-library-list-more-container"});this._element({link:e.path(t+this.PAGE_LIMIT),parentNode:n,classes:"screen-library-list-more-button",label:"details.list-link"});s(i.supplant(n))}else s(i.supplant(this._theEnd()))}.bind(this)}),this._fillOut(e);var i=[];this.dom.chain.populate({list:e,inclusions:i})},n.focus=function(){i.prototype.focus.call(this),this._prepare().chain.focus()},n._layout=function(e){this._build("screen-library-list",{extending:e}," content .content","  meta","   intro .library-intro .pillar .bumper-n .bumper-e .bumper-w","    prelude <p>","    head <h1> .library-head {loading}","    lede <p> .library-lede","  bumper .pillar .bumper-e .bumper-s .bumper-w","   filter-cloud",l,"   banners","   chain",h),this.dom.chain.claim(this)},n._layoutHeader=function(e){"search"==this.controller.realm?e.header=new o:e.header=new r,e.header.impart(e.root,"prepend")},n._isAlreadyFilledOut=function(e){return e.params.rootAddress()==this._.filledOutRoot},n._fillOut=function(e){var t=this._isAlreadyFilledOut(e);this._fillOutHead(e),t||this._fillOutColor(e)},n._fillOutColor=function(e){e.getColor(function(e){this.controller.waypoint.configure({color:e})}.bind(this))},n._fillOutHead=function(e){var i={label:"list.prelude.generic"},s=e.name()||this._phrase("loading"),n=s;i&&t.try(e.freshness,"isFresh()")&&e.totalTitles&&(i.label+=".count",i.substitutions={COUNT:e.totalTitles}),this.controller.waypoint.configure({name:n}),this._textify(this.dom.prelude,i),this._textify(this.dom.head,{html:s}),this._textify(this.dom.lede,{html:t.try(e,"description()")||""})},n._fillOutBanners=function(e){this._textify(this.dom.banners);var i=this._element({parentNode:this.dom.banners});e.banners(function(e){t.isInDOM(i)&&t.each(e,function(e){new c(i).become(e)})},this)},n._titlesInRange=function(e,t,i,s){return this.list?e>0&&!this.list.isPaginated()?i({titles:[]}):void this.list.freshen(e,t,function(e,t){return this.list.meetsDeepSearchCriteria()?(s({head:"list.facets.scope.deepening.head",lede:"list.facets.scope.deepening.lede"}),APP.nav.go(this.list.subpath({scope:"auto"}))):(this._.pending&&(this._.pending=!1,this.dom.filterCloud.become(e),this._fillOutBanners(e),this._fillOut(e),this._.filledOutRoot=e.params.rootAddress()),void(e.totalTitles>0?i({titles:t}):s(this._explainEmptyList(e))))}.bind(this),function(){this._.pending&&(this.dom.filterCloud.become(this.list),this._isAlreadyFilledOut(this.list)||(this._fillOutColor(this.list),this._fillOutHead(this.list))),s(this._explainEmptyList(this.list,!this.list.invalidities))}.bind(this)):s({retry:!0})},n._explainEmptyList=function(e,i){if(i)return{head:"list.failure",lede:"list-chain.failures.network",retry:!0};if(APP.patron.pins.signature("title"))return{head:"list.empty",lede:{label:"list.empty.filtering",enliven:{"#edit-filters":function(){t.try(this.dom.filterCloud,"presentEditorDialog()")}.bind(this)}}};var s=e.params.refinements;return s.query||s.title||s.identifier?{head:"list.empty",lede:"list.empty.search"}:{head:"list.empty",lede:"list.empty.collection"}},n._paginationControls=function(e,i,s){if(this.list&&this.list.totalTitles&&this.list.totalTitles<=i)return this.dom.chain.end(),this._theEnd();if(this.list){var n=t.element({classes:"list-paging-rule"}),r=new u(n);return r.become(e,this.list.maxPages()),r.on("choice",function(e){APP.nav.go(this.list.path(e.m.pageNumber))}.bind(this)),n}},n._theEnd=function(){var e={manualThreshold:!0};if(this.list.meetsDeepSearchCriteria(e)){var t=this._build("screen-library-list-deep-search-hint"," waves","  mural",{graphic:"filter-cloud-search-scope-mural"},"  filter-cloud",a,"  instructions {filter.teach.scope-deep.list-end-hint}",{});return t.filterCloud.become({"scope-deep":{link:this.list.subpath({scope:"deep"}),graphic:"filter-cloud-filter"}}),t.root}return(new p)._prepare().root},s}),define("app/controllers/library/list-controller",["require","common","app/controllers/train-controller","app/models/items/list-parameters","./title-details-controller","app/views/screens/library/screen-library-list"],function(e){var t=e("common"),i=e("app/controllers/train-controller"),s=i.new(),n=s.prototype,r=e("app/models/items/list-parameters");return n.SUB_CONTROLLERS=[e("./title-details-controller")],n.SCREEN_CLASS=e("app/views/screens/library/screen-library-list"),n.configure=function(){this.realm=t.try(this.ancestor,"realm")||"library",this.waypoint.configure({label:"crumb.list"})},n.match=function(e){var t=APP.constants.LIST_SOURCES.join("|"),i=new RegExp("^(("+t+")-?.*?)/page-(\\d+)/?(.*)$"),s=e.match(i);if(s)return this.args={params:this._listParameters(s[1]),page:parseInt(s[3],10)||1},{head:this._fullListPath(),tail:s[4]}},n.refine=function(e){var t=this.list.params.source.name;"search"!=t&&this.list.params.source.id&&(t+="-"+this.list.params.source.id);var i=new RegExp("^("+t+".*?)/page-(\\d+)$"),s=e.match(i);if(s)return this.args={params:this._listParameters(s[1]),page:parseInt(s[2],10)||1},{head:this._fullListPath()}},n.usher=function(){this.list&&!this.list._isFresh()&&(this.routeFilled=!1),this._acquireListFromArgs()},n.fill=function(){this.screen().become(this.list,this.args.page),this.screen().scroller.scrollToTop({duration:0})},n._listParameters=function(e){return new r(APP.library,e).withRefinements({facets:null})},n._fullListPath=function(e,t){return e=e||this.args.params,t=t||this.args.page||1,e.address()+"/page-"+t},n._acquireListFromArgs=function(){var e=this.args.params.address();e!=this.address&&(this.address=e,this.list=APP.library.catalog.lists.produce(this.address))},s}),define("app/controllers/search/catalog-controller",["require","common","app/controllers/train-controller","app/views/screens/search/screen-search-catalog","app/controllers/library/list-controller"],function(e){var t=e("common"),i=e("app/controllers/train-controller"),s=i.new(),n=s.prototype;return n.SCREEN_CLASS=e("app/views/screens/search/screen-search-catalog"),n.SUB_CONTROLLERS=[e("app/controllers/library/list-controller")],n.configure=function(){this.realm="search",this.historical=!0,this.root=!0,this.waypoint.configure({label:"footer.nav.search"})},n.match=function(e,i,s){if("search"==e)return APP.library?{rewrite:"search/"+APP.library.baseKey}:{rewrite:"/"};var n=e.match(/^search\/([\w\-]+)\/?(.*)/);if(n){if(this.args={key:n[1]},this.args.library=APP.libraries.findActivatableLibrary(this.args.key),this.args.library)return{head:"search/"+this.args.key,tail:n[2]};var r=t.parameterizeURL("interview/locate-library/resolve",{key:this.args.key,realm:"search",next:n[2]?n[2]+i+s:void 0});return{rewrite:r}}},n.usher=function(){APP.libraries.now(this.args.library),APP.arena.raise(this.realm),APP.arena.dom.footer.raise(this.realm)},n.fill=function(){this.screen()},n.refocus=function(){return this.screen().refocus(),i.prototype.refocus.apply(this,arguments)},n.performSearch=function(e,t){var i=e.catalog.lists.produce("search"),s=t?i.subpath(t):i.path();APP.nav.go(s)},s}),define("app/views/screens/library/screen-list-of-lists",["require","common","app/views/screens/screen"],function(e){var t=e("common"),i=e("app/views/screens/screen"),s=i.new(),n=s.prototype;return n.MAX_CONSECUTIVE_LIST_FAILURES=10,n._resetLists=function(e,i){this._.listCount=0,this._.failures=0,this._.lists=e.slice(0),this._.listOptions=i=t.absorb(i,{}),i.limit=i.limit||1/0,i.maxConsecutiveFailures=i.maxConsecutiveFailures||this.MAX_CONSECUTIVE_LIST_FAILURES},n._nextViableList=function(e,i,s){if(this._.listCount>=this._.listOptions.limit)return s({ended:!0});var n=24,r=1;n="function"==typeof e.maximumTitles?e.maximumTitles():e.maximumTitles||n,r="function"==typeof e.minimumTitles?e.minimumTitles():e.minimumTitles||r;var o=Math.max(n,r),a=Math.min(n,r);if(this._.lists.unused)for(var l=0,c=this._.lists.unused.length;l<c;++l){var h=this._.lists.unused[l];if(!(h.totalTitles<a))return t.excise(this._.lists.unused,h),this._.listCount+=1,i(h)}var u=this._.lists.shift();if(!u)return s({ended:!0});var p=t.absorb(e.refinements,{facets:"false"}),d=u.params.withRefinements(p).address();u=u.library.catalog.lists.produce(d),u.freshen(0,o,function(t,n){!t.invalidities&&t.totalTitles>=a?(this._.failures=0,this._.listCount+=1,i(t,n)):(this._.lists.unused=this._.lists.unused||[],this._.lists.unused.push(t),this._handleListFailure(e,i,s))}.bind(this),function(){return APP.network.reachable?void this._handleListFailure(e,i,s):(this._.lists.unshift(u),s({offline:!0}))}.bind(this),{limit:o})},n._handleListFailure=function(e,t,i){if(this._.failures+=1,this._.failures>this._.listOptions.maxConsecutiveFailures){var s=this._.failures;this._.failures=0,i({failures:s})}else this._nextViableList(e,t,i)},n._explainListFailure=function(e,i,s){i.head||i.lede?e.explain(i.head,i.lede):i.offline?e.explain(null,"list-chain.failures.network"):APP.patron.pins.signature("title")?e.explain(null,{label:"list-chain.failures.filtering",enliven:{"#edit-filters":function(){t.try(this.dom.filterCloud,"presentEditorDialog()")}.bind(this)}}):e.explain(null,"list-chain.failures"),s&&"function"==typeof s.retry&&e.showRetryButton(s.retry)},s}),define("app/views/components/filters/filter-cloud-for-guide",["require","common","app/views/components/filters/filter-cloud-for-list","app/views/components/common/tutorial-balloon"],function(e){var t=e("common"),i=e("app/views/components/filters/filter-cloud-for-list"),s=i.new(),n=s.prototype,r=e("app/views/components/common/tutorial-balloon");return n.become=function(e,i){this.guide=e,this.list=i.resolve(),this.reset(),delete this._.delta,delete this._.guideFacets;var s=this.guide.lists[0],n=this.guide.filters&&t.try(s,"params.refinements");n&&!t.isEmpty(n)?(this._.delta=this._deltaOfRefinements(this.list,s),this.pending(!0),APP.patron.pins.pause(function(e){s.facets.freshen(function(t){this._.guideFacets=t.find({applied:!0,innate:!1,encompass:!1,pinned:!1}),e(),this._suggestFacetsForList(this.list)}.bind(this),function(){e(),this._suggestFacetsForList(this.list)}.bind(this))}.bind(this),{scope:"title"})):this._suggestFacetsForList(this.list)},n._suggestFacetsForList=function(e){this.pending(!0),e.facets.freshen(function(i){var s=i.find({applied:!0,innate:!1,encompass:!1,pinned:!1});t.each(this._.guideFacets,function(e){var t=i.find({category:e.category,value:e.value});t&&t[0]&&s.push(t[0])}),s.length||(s=e.facets.find({category:"format",value:"book"}).concat(e.facets.find({category:"format",value:"audiobook"}))),this._retainingOnlyAccessedButtons(function(){t.each(this._buttonsPropertiesForFacets(s),this.button,this)}.bind(this)),this._primaryButtonsAdded()}.bind(this),function(){this._primaryButtonsAdded()}.bind(this))},n._attachBalloonForPinnables=function(){if(delete this._.pinnableDismissalKey,this._.pinnableGuideFacets=t.select(this._.guideFacets,function(e){if(t.among(e.category,"audience","language"))return e}),this._.pinnableGuideFacets.length){var e=["guide",this.guide.library.key(),this.guide.guideId].concat(t.select(this._.pinnableGuideFacets,function(e){return e.category+"-"+e.value})).join(":");return APP.patron.isDismissed(e)||(this.dom.balloon=this.dom.balloon||new r,this.dom.balloon.attach(this.button("editor-dialog"),"small"),this.dom.balloon.whenDismissed(e,"extract")),this._.pinnableDismissalKey=e}},n._populateEditorDialog=function(e){return e.list=e.list||this._mergeRefinements(this.list,this._.delta),i.prototype._populateEditorDialog.apply(this,arguments)},n._updateCountForDialog=function(e,t){e.updateCount(void 0,"guide")},n._blockCategories=function(){var e=["subject","format","availability","sort","audience","fulfillable","language"];t.each(this._.guideFacets,function(i){t.among(i.category,"format","audience","language")&&t.excise(e,i.category),"format"==i.category&&"book"!=i.value&&t.excise(e,"fulfillable")});var i={};return t.each(e,function(e){i[e]={phase:"fetched"}}),i},n._tutorialBlockForDialog=function(e){var i=[];if(t.each(this._.guideFacets,function(e){var t=this.list.facets.find({category:e.category,value:e.value});t&&t[0]&&i.push(t[0])},this),i.length){var s=this._buttonsPropertiesForFacets(i,{includeGuideFacets:!0,dialog:e}),n=e.block("tutorial",s);this._classify(n.box,"dialog-filter-cloud-editor-box-feature"),this._classify(n.box,"dialog-filter-cloud-editor-box-guide-filters"),this._textify(n.head,"filter-cloud-for-guide.associated.head"),n.cue||(n.cue=this._element({parentNode:n.box,classes:"dialog-filter-cloud-editor-box-guide-filters-cue"}),n.paragraph=this._element({tag:"p",parentNode:n.cue}));var o=this._.pinnableDismissalKey;if(o&&!APP.patron.isDismissed(o)){if(this._textify(n.paragraph,{label:"filter-cloud-for-guide.associated.cue",substitutions:{COUNT:i.length}}),this._classify(n.paragraph,"is-nudged"),!n.answers){n.answers=this._element({parentNode:n.cue,classes:"dialog-filter-cloud-editor-box-guide-filters-answers"}),this._element({button:function(){APP.patron.dismiss(o),this._tutorialBlockForDialog(e)}.bind(this),parentNode:n.answers,classes:"shibui-button",label:"filter-cloud-for-guide.associated.cue.yes",substitutions:{COUNT:i.length}}),this._element({button:function(){APP.patron.dismiss(o),this._tutorialBlockForDialog(e)}.bind(this),parentNode:n.answers,classes:"shibui-button",label:"mascot.no"});var a=(new r).attach(n.answers,"large");a.whenDismissed(o,"release")}}else this._textify(n.paragraph,{label:"filter-cloud-for-guide.associated.info",substitutions:{COUNT:i.length}}),this._declassify(n.paragraph,"is-nudged"),n.answers&&(n.answers.parentNode.removeChild(n.answers),delete n.answers);return n}},n._buttonsPropertiesForFacets=function(e,s){e=t.select(e,function(e){if("sort"!=e.category)return e;if(!e.innate&&!e.encompass)return e;var i={innate:!1,encompass:!1,applied:!1};return t.absorb(i,t.absorb(e,{}))});var n=i.prototype._buttonsPropertiesForFacets.call(this,e,s);return t.try(s,"dialog")&&!s.includeGuideFacets&&t.each(this._.guideFacets,function(e){n.delete(e.category+"-"+e.value)}),t.each(n,function(e,t){"number"==typeof t.count&&(t.count=1/0)}),n},n._onEditorDialogSubmit=function(e,i){var s=t.try(e,"list");if(s){s=this._deductRefinements(e.list,this._.delta);var n=!!t.try(e,"removedPins.length");if(this._navigateToList(s,n))return}t.try(e,"shade.minimize()")},n._navigateToList=function(e,t){var i=e.params.address().replace(/^everything\/?/,"/refine/");"/refine/"==i&&(i="");for(var s=this.guide,n=[s.guideId];s=s.parent;)n.unshift(s.guideId);var r=e.library.path("guide/"+n.join("/")+i);return r!=APP.router.route.path?(APP.nav.go(r),r):t?(this._rebuildRoute(),APP.router.route.path):void 0},n._deltaOfRefinements=function(e,i){var s=e.params.refinements,n=i.params.refinements;if(n&&!t.isEmpty(n)){var r=t.clone(n);return t.each(s,function(e,i){t.isList(r[e])?t.each(i,function(i){t.excise(r[e],i)}):delete r[e]}),r}},n._mergeRefinements=function(e,i){if(!i||t.isEmpty(i))return e;var s=t.clone(e.params.refinements);t.each(i,function(e,i){t.isList(i)?s[e]=t.unique(t.compact(t.flatten([s[e],i]))):s[e]=i});var n=e.params.withRefinements(s).address();return e.library.catalog.lists.produce(n)},n._deductRefinements=function(e,i){if(!i||t.isEmpty(i))return e;var s=t.clone(e.params.refinements);t.each(i,function(e,i){t.isList(s[e])?t.each(i,function(i){t.excise(s[e],i)}):s[e]==i&&delete s[e]});var n=e.params.withRefinements(s).address();return e.library.catalog.lists.produce(n)},n._pathForAllTitlesMatchingFacet=function(e){},s}),define("app/views/library/list-lede",["require","common","app/views/core/partial","shibui/src/components/chevron"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("shibui/src/components/chevron");return n.become=function(e){var i={wrapper:"span"},s={link:e.path(),label:"list.cue",substitutions:{}},n="many",r=e.totalTitles;r>=1e3?s.substitutions.COUNT=100*Math.floor(r/100):r>50?s.substitutions.COUNT=10*Math.floor(r/10):(s.substitutions.COUNT=r,n="some");var o=e.description();if(o){i.html=this._amplifyText(o).trim();var a=new RegExp("[^"+t.regExpPunctuation()+"]$");o.trim().match(a)&&(i.html+="."),s.label+=".described."+n}else{i.html="";var l="undescribed."+e.params.source.name+"."+n;this._phrase({label:s.label+"."+l,okIfMissing:!0})?s.label+="."+l:s.label+=".undescribed."+n}i.html||(i=null),this.populate(i,s)},n.populate=function(e,i){if(this._textify(this.dom.paragraph,e),i="string"==typeof i?{label:i}:t.absorb(i,{}),i.label||i.html){for(var s=this._element(t.absorb(i,{parentNode:this.dom.extra,classes:"list-lede-cue halo",wrapper:!1})),n=i.direction||"right",o="left"==n?"prepend":"append",a=s,l="left"==n?"firstChild":"lastChild";a[l]&&1==a[l].nodeType;)a=a[l];this._element({tag:"span",parentNode:a,html:"&nbsp;",pos:o});var c=new r;c.impart(a,o),c.bearing({left:"w",right:"e"}[n])}},n._layout=function(){this.dom=this._build("list-lede"," paragraph <p>"," extra <p>")},s}),define("app/views/library/basic-block",["require","common","app/views/core/partial","app/views/core/block-strap","app/views/library/list-lede","app/views/core/title-list"],function(e){var t=(e("common"),e("app/views/core/partial")),i=t.new(),s=i.prototype,n=e("app/views/core/block-strap"),r=e("app/views/library/list-lede"),o=e("app/views/core/title-list");return s.$init=function(e,i){this._.itemType=i||"stand",t.prototype.$init.call(this,e)},s.become=function(e){this.list=e,this._prepare(),this.list.freshen(0,this.maximumTitles(),this._fillOut.bind(this),this._fillOutFailure.bind(this)),this.dom.strap.configure({text:{html:this._amplifyText(e.name()||this._phrase("loading")),link:e.path()},circle:{icon:"block-strap-dismiss",spoken:"a11y.list.dismiss",button:function(e){this._dispatch("block:dismiss",{target:e.target})}.bind(this)}})},s.minimumTitles=function(){return 8},s.maximumTitles=function(){return 12},s._layout=function(e){this.dom=this._build("basic-block",{element:e.root}," pillar",{classes:"pillar bumper-e bumper-w"},"  intro","   strap",n,"   lede",r,"  chain",{construct:o,with:this._.itemType}),this.dom.chain.claim(this),this.dom.chain.configure({blockSize:this.maximumTitles()})},s._listen=function(){var e=this.dom.chain.focus.bind(this.dom.chain);APP.router.route.on("loan:update:all",e),APP.router.route.on("hold:update:all",e)},s._fillOut=function(e,t){this.dom.lede.become(e),this.dom.chain.populate({list:e,titles:t}),this.dom.chain.finishUp()},s._fillOutFailure=function(){APP.journal.warn("[BASIC-BLOCK] fillOutFailure",arguments,this)},i}),define("app/views/core/restore-lists-button",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.$init=function(){this.reset(),i.prototype.$init.apply(this,arguments)},n.become=function(e){e=t.absorb(e,{}),e.keyPrefix&&(this.keyPrefix=e.keyPrefix),e.library&&(this.library=e.library,this.keyPrefix=this.keyPrefix||"list:"+this.library.key()),this._updateLabel()},n.checkList=function(e){var t=this._dismissalKey(e),i=APP.patron.isDismissed(t);return i&&this._.dismissalKeys.push(t),this._updateLabel(),!i},n.dismissList=function(e,t,i){var s="list.confirm-dismiss";this.library&&(s="library.home.confirm-dismiss-list"),APP.arena.popover(i).confirm({warningLabel:s+".explain",buttonLabel:s+".proceed",onSubmit:this._onConfirmDismissList.bind(this,e,t)})},n.reset=function(){this._.dismissalKeys=[]},n._layout=function(e){this._swapInteractiveElement(e.root,{button:this._onTap.bind(this)}),this._classify(e.root,"restore-lists-button")},n._listen=function(e,t){this._handle("patron:undismiss")},n._onTap=function(){this._undismissLists(),APP.arena.scroller.scrollToTop()},n._updateLabel=function(){this._prepare();var e=this._.dismissalKeys.length;this._textify(this.dom.root,{label:"library.home.restore-dismissed-lists",substitutions:{N:e}}),this._semaphore("count",e)},n._dismissalKey=function(e){if(!e)return"unknown-dismissal-key";var t=e;return"string"!=typeof e&&e.params&&(t=e.params.withRefinements({facets:null,breakpoint:null}).address()),(this.keyPrefix?this.keyPrefix+":":"")+t},n._onConfirmDismissList=function(e,t){var i=this._dismissalKey(e);this._.dismissalKeys.push(i),APP.patron.dismiss(i),this._updateLabel(),t&&"function"==typeof t.extract&&t.extract(),this._dispatch("dismiss",{thing:e,block:t})},n._undismissLists=function(){t.each(this._.dismissalKeys,APP.patron.undismiss.bind(APP.patron))},n._onPatronUndismiss=function(e){if(t.try(this._.dismissalKeys,"length")){if(!this.isInDocument())return this.extract();var i=t.select(this._.dismissalKeys,function(i){if(!t.among(i,e.m.keys))return i});i.join(",")!=this._.dismissalKeys.join(",")&&(this._.dismissalKeys=i,this._defer("undismiss",function(){this._updateLabel(),this._dispatch("undismiss")}.bind(this)))}},s}),define("app/views/screens/library/screen-library-guide",["require","common","app/views/screens/library/screen-list-of-lists","app/views/components/library/app-header-with-emblem","app/views/components/filters/filter-cloud-for-guide","app/views/core/chaining-list","app/views/library/basic-block","app/views/core/restore-lists-button","app/views/library/the-end-block","shibui/src/components/chevron","shibui/src/illustrator"],function(e){var t=e("common"),i=e("app/views/screens/library/screen-list-of-lists"),s=i.new(),n=s.prototype,r=e("app/views/components/library/app-header-with-emblem"),o=e("app/views/components/filters/filter-cloud-for-guide"),a=e("app/views/core/chaining-list"),l=e("app/views/library/basic-block"),c=e("app/views/core/restore-lists-button"),h=e("app/views/library/the-end-block"),u=e("shibui/src/components/chevron"),p=e("shibui/src/illustrator");return n.COLLECTION_COUNT=10,n.become=function(e,t){this.guide=e,this.list=t,this.allTitlesList=e._.allTitlesList,this._prepare(),this.dom.restoreListsButton.become({library:this.guide.library}),this._resetLists(e),this._fillOut(e,t)},n.focus=function(){i.prototype.focus.call(this),this.isInDocument()&&this.dom.chain.focus()},n._layout=function(e){this._build("screen-library-guide",{extending:e}," content .content .bumper-s","  meta","   backdrop","    fade","   intro .library-intro .pillar .bumper-n .bumper-e .bumper-w","    strap <p> {guide.label}","    head <h1> .library-head {blank}","    lede <p> .library-lede","   strip .pillar .bumper-e .bumper-w","    subguides <ul>","  filters .pillar .bumper-e .bumper-w","   filter-cloud",o,"  chain",a),e.chain.claim(this),e.restoreListsButton=new c,e.filterCloud.configure({hinting:!0})},n._layoutHeader=function(e){e.header=new r,e.header.impart(e.root,"prepend")},n._listen=function(e){this._handle("dismiss",this.dom.restoreListsButton),this._handle("undismiss",this.dom.restoreListsButton)},n._fillOut=function(e,i){this._applyTheme(e.theme()),e.name.length<8?t.DataClass.set(this.dom.head,"length","short"):e.name.length<14?t.DataClass.set(this.dom.head,"length","medium"):t.DataClass.set(this.dom.head,"length","long"),this._textify(this.dom.head,{html:e.name}),this._textify(this.dom.lede,{html:e.introduction}),this._fillOutSubguides(e),this.allTitlesList&&this._build("<li>",{parentNode:this.dom.subguides}," {guide.scope.link}",{link:this.allTitlesList.path()},"  >",function(e){return new u(e).bearing("e")}),this.dom.filterCloud.become(e,i),this.dom.chain.enchain(this._addListBlock.bind(this))},n._fillOutSubguides=function(e){this._textify(this.dom.subguides),t.each(e.guides,function(e){var t=this._amplifyText(e.name);this._build("<li>",{parentNode:this.dom.subguides}," {explore.item.guide}",{link:e.path(),substitutions:{GUIDE_NAME:t}},"  >",function(e){return new u(e).bearing("e")})},this)},n._applyTheme=function(e){this.controller.waypoint.configure({name:this.guide.name,color:e.colors.bg}),this.dom.pattern=p.pattern(e.pattern,{parentNode:this.dom.backdrop,color:e.colors.ptn}),APP.coverGuru.paint(this.dom.root,"guide-bg",e.colors.bg),APP.coverGuru.paint(this.dom.root,"guide-pattern",e.colors.ptn),APP.coverGuru.paint(this.dom.root,"guide-fg",e.colors.fg)},n._resetLists=function(e){var s=[],n=0;return t.each(e.lists,function(e){this.dom.restoreListsButton.checkList(e)&&e!=this.allTitlesList&&("spotlight"!=e.params.source.name&&(n+=1),s.push(e))},this),n=Math.max(n,this.COLLECTION_COUNT),i.prototype._resetLists.call(this,s,{limit:n}),this.dom.chain.reset(),s},n._addListBlock=function(e,t){var i=new l;i.refinements=this.list.params.refinements,this._nextViableList(i,function(s){i.become(s),e.supplant(i),i.on("block:dismiss",function(e){this.dom.restoreListsButton.dismissList(s,i,e.m.target)}.bind(this)),this.dom.chain.enchain(this._addListBlock.bind(this)),t(i)}.bind(this),function(s){if(s.ended){if(i.extract(),!this._.listCount&&APP.patron.pins.signature("title"))return this._explainListFailure(e,{empty:!0}),this.dom.chain.end();this.dom.restoreListsButton._.dismissalKeys.length?this._.finalBlock=this.dom.restoreListsButton:this._.finalBlock=new h,t(e.supplant(this._.finalBlock)),this.dom.chain.end()}else this._explainListFailure(e,s,{retry:this._addListBlock.bind(this,e,t)})}.bind(this))},n._onDismissRestoreListsButton=function(){this._.finalBlock&&(this._.finalBlock.extract(),delete this._.finalBlock),this._.listCount=Math.max(0,this._.listCount-1),this.dom.chain.enchain(this._addListBlock.bind(this))},n._onUndismissRestoreListsButton=function(){this.become(this.guide,this.list)},s}),define("app/controllers/library/guide-controller",["require","common","app/controllers/train-controller","app/views/screens/library/screen-library-guide"],function(e){var t=e("common"),i=e("app/controllers/train-controller"),s=i.new(),n=s.prototype;return n.SUB_CONTROLLERS=[s],n.SCREEN_CLASS=e("app/views/screens/library/screen-library-guide"),n.configure=function(){this.realm=t.try(this.ancestor,"realm")||"library",this.waypoint.configure({label:"crumb.guide"})},n.match=function(e){var t,i;if(this.ancestor instanceof s){var n=e.match(/^([\w-]+)\/?(.*)/);n&&(this.args={guideIds:this.ancestor.args.guideIds.concat([n[1]])},t=n[1],i=n[2])}else{var n=e.match(/^guide\/([\w-]+)\/?(.*)/);n&&(this.args={guideIds:[n[1]]},t="guide/"+n[1],i=n[2])}if(t)return this.args.listAddress="everything",n=i.match(/^refine\/(.*)/),n&&(t+="/"+i,i=void 0,this.args.listAddress+="/"+n[1]),{head:t,tail:i}},n.refine=function(e){var i=e.match(/(guide\/)?([\w-]+)(\/refine\/(.*))?$/);if(i&&i[2]==t.last(this.args.guideIds))return this.args.listAddress="everything"+(i[4]?"/"+i[4]:""),{head:i[0]}},n.fill=function(){APP.library.catalog.guides.use(function(e,i){return t.try(i,"all.length")?(this.guide=i.find(this.args.guideIds),void(this.guide?(this.list=APP.library.catalog.lists.produce(this.args.listAddress),this.screen().become(this.guide,this.list)):(APP.journal.warn("[GUIDE] not found:",this.args),APP.nav.back()||APP.nav.go("")))):i.reuse()},this)},s}),define("app/views/components/filters/filter-cloud-for-subjects",["require","common","app/views/components/filters/filter-cloud-for-list"],function(e){var t=e("common"),i=e("app/views/components/filters/filter-cloud-for-list"),s=i.new(),n=s.prototype;return n.BLOCK_CATEGORIES={sort:{phase:"fetching"},format:{phase:"fetched"},audience:{phase:"fetched"},language:{phase:"fetched"}},n.become=function(e,i){this.list=e,this.options=t.absorb(i,{sort:"size"}),this.reset(),this.pending(!0),this.list.facets.freshen(function(i){var s=e.facets.find({applied:!0,innate:!1,encompass:!1,pinned:!1});t.each(this._buttonsPropertiesForFacets(s),this.button.bind(this)),this.button("sort-size",{button:this._onTapSortChoice.bind(this,"size"),classes:"filter-cloud-for-subjects-sort",graphic:"filter-cloud-sort","aria-selected":""+("size"==this.options.sort)}),this.button("sort-name",{button:this._onTapSortChoice.bind(this,"name"),classes:"filter-cloud-for-subjects-sort",graphic:"filter-cloud-sort","aria-selected":""+("name"==this.options.sort)}),this._primaryButtonsAdded()}.bind(this))},n.pending=function(e){var t=this._prepare();t.base.children.length||(this._buttonsForPins(),this._buttonForEditorDialog()),i.prototype.pending.apply(this,arguments)},n._buttonsForPins=function(){var e=t.select(APP.patron.pins.asFacets(),function(e){if("sort"!=e.category)return e});return i.prototype._buttonsForPins.call(this,e)},n._updateCountForDialog=function(e,t){"fetched"==t?(e.updateCount(e.list.facets.subject.length,"subjects"),e.focusOnSubmit(320)):e.updateCount(void 0,"subjects")},n._sortBlockForDialog=function(e){var t=function(i){
return this.options.sort=i,{"sort-size":{button:function(){e.block("sort",t("size"))},classes:"filter-cloud-for-subjects-sort",graphic:"filter-cloud-sort","aria-selected":""+("size"==i)},"sort-name":{button:function(){e.block("sort",t("name"))},classes:"filter-cloud-for-subjects-sort",graphic:"filter-cloud-sort","aria-selected":""+("name"==i)}}}.bind(this),i=e.block("sort",t(this.options.sort));return this._classify(i.box,"dialog-filter-cloud-editor-box-feature"),this._classify(i.box,"dialog-filter-cloud-editor-box-subjects-sort"),this._textify(i.head,"filter-cloud-for-subjects.sort.head"),i},n._facetBlockForDialog=function(e,i,s){var n=i.list.facets.find({category:e});"format"==e&&"readalong"==t.last(n).value&&n.pop();var r=this._buttonsPropertiesForFacets(n,{dialog:i});return i.block(e,r,s)},n._buttonsPropertiesForFacets=function(){var e=i.prototype._buttonsPropertiesForFacets.apply(this,arguments);return t.each(e,function(e,t){"number"==typeof t.count&&(t.count=1/0)}),e},n._onTapSortChoice=function(e){e!=this.options.sort&&(APP.patron.choose("explore:subjects:sort",this.options.sort=e),this._navigateToList(this.list))},n._onEditorDialogSubmit=function(e,t){this._navigateToList(e.list)},n._navigateToList=function(e){var t=e.params.address().replace(/^everything\/?/,"");t=t?t+"/":"";var i=e.library.path("subjects/"+t+this.options.sort);return i!=APP.router.route.path?(APP.nav.go(i),i):(this._rebuildRoute(),APP.router.route.path)},n._pathForAllTitlesMatchingFacet=function(e){},s}),define("app/views/screens/library/screen-library-subjects",["require","common","app/views/screens/screen","app/views/components/library/app-header-with-emblem","shibui/src/components/spinner","shibui/src/components/chevron","app/views/components/filters/filter-cloud-for-subjects"],function(e){var t=e("common"),i=e("app/views/screens/screen"),s=i.new(),n=s.prototype,r=e("app/views/components/library/app-header-with-emblem"),o=e("shibui/src/components/spinner"),a=e("shibui/src/components/chevron"),l=e("app/views/components/filters/filter-cloud-for-subjects");return n.SORT_FUNCTIONS={name:function(e,t){return e.name.localeCompare(t.name)},size:function(e,t){return t.totalTitles-e.totalTitles}},n.become=function(e){this.library=e,this.refresh()},n.refresh=function(){var e=this._prepare();e.spinner.spin(),this._textify(e.lede,"loading");var t=this.controller.args.list.resolve(),i={sort:this.controller.args.sort};e.filterCloud.become(t,i),e.filterCloud.howToRefresh(this.refresh.bind(this)),t.facets.freshen(function(t){e.spinner.stop(),this._fillOut(t,i)}.bind(this))},n._layout=function(e){this._build("screen-library-subjects .explore-view",{extending:e}," content .content","  pillar .pillar","   meta","    intro .library-intro .bumper-n .bumper-e .bumper-w","     head <h1> .library-head {subjects.head}","     lede <p> .lede {loading}","     filter-cloud",l,"   bumper .bumper-s .bumper-e .bumper-w","    table .subjects-table","    spinner",o)},n._layoutHeader=function(e){e.header=new r,e.header.impart(e.root,"prepend")},n._fillOut=function(e,i){var s=e.totalTitles,n=1e3*Math.floor(s/1e3),r="subjects.summary";s<1?r+=".none":APP.patron.pins.signature("title")&&(r+=".preferences"),this._textify(this.dom.lede,{label:r,substitutions:{IS_APPROX:!!n,COUNT:n?n:s,SUBJECT_COUNT:e.subject.length}}),this.sort=i.sort||"name",this._textify(this.dom.table),t.DataClass.set(this.dom.table,"subjects-sort",this.sort);var o=this.SORT_FUNCTIONS[this.sort],l=e.subject.slice(0).sort(o);t.each(l,function(e){var t=this._categorizeSubjectName(e.name),i=this.controller.args.list.params.refinements,s=this.library.catalog.lists.produce("subject-"+e.value),n=s.params.withRefinements(i).address(),r=this._element({link:this.library.catalog.lists.produce(n).path(),parentNode:this.dom.table,classes:"subjects-cell",html:t.shift()});this._element({tag:"span",parentNode:r,classes:"subjects-cell-count",html:this._phrase({number:e.totalTitles}),pos:"prepend"}),t[0]&&this._element({parentNode:r,classes:"subjects-cell-category",html:t[0]}),new a(r).bearing("e")},this)},n._categorizeSubjectName=function(e){var t=e.match(/^(.+) - (.+)$/);return t?[t[2],t[1]]:[e]},s}),define("app/controllers/library/subjects-controller",["require","common","app/controllers/train-controller","app/views/screens/library/screen-library-subjects"],function(e){var t=e("common"),i=e("app/controllers/train-controller"),s=i.new(),n=s.prototype;return n.SCREEN_CLASS=e("app/views/screens/library/screen-library-subjects"),n.DEFAULT_SORT="size",n.configure=function(){this.realm=t.try(this.ancestor,"realm")||"library",this.waypoint.configure({label:"subjects.head"})},n.match=n.refine=function(e){var i=t.try(e.match(/\/(name|size)$/),"[1]"),s=e.replace(/\/(name|size)$/,"").match(/^subjects(\/.+)?$/);if(s)return this.args={},this.args.sort=this._decideSort(i),this.args.listAddress="everything"+(s[1]||""),this.args.list=APP.library.catalog.lists.produce(this.args.listAddress),{head:"subjects"+(s[1]||"")+"/"+this.args.sort}},n.fill=function(){this.screen().become(APP.library)},n._decideSort=function(e){var t;return t=e?e.replace(/^\//,""):null,t=t||APP.patron.choice("explore:subjects:sort"),t=t||this.DEFAULT_SORT,"alpha"==t&&(t="name"),t},s}),define("app/views/library/guide-tile",["require","common","app/views/core/partial","app/views/core/cover-box","shibui/src/illustrator"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/core/cover-box"),o=e("shibui/src/illustrator");return n.become=function(e){if(this._prepare(),t.isList(e)){var i=e.slice(0,2);this._classify(this.dom.root,"is-more-tile"),this._linkify(this.dom.root,i[0].library.path("guides")),this._textify(this.dom.head,"guides.more"),this._textify(this.dom.enticement);for(var s=this._element({tag:"ul",parentNode:this.dom.enticement});i.length;)this._element({tag:"li",parentNode:s,html:[this._amplifyText(i.shift().name),i.length?"":"&hellip;"].join("")})}else this._declassify(this.dom.root,"is-more-tile"),this._linkify(this.dom.root,e.path()),this._textify(this.dom.head,{html:this._amplifyText(e.name)}),this._textify(this.dom.lede,{html:e.introduction}),this._applyTheme(e.theme()),this._applyList(e.lists[e.filters?1:0])},n._layout=function(){this.dom=this._build("guide-tile",{link:"#"}," clip","  backdrop","  content","   head","   lede","   enticement")},n._applyTheme=function(e){this.dom.pattern=o.pattern(e.pattern,{parentNode:this.dom.backdrop,color:e.colors.ptn}),APP.coverGuru.paint(this.dom.root,"guide-bg",e.colors.bg,{delay:0}),APP.coverGuru.paint(this.dom.root,"guide-fg",e.colors.fg,{delay:0})},n._applyList=function(e){if(this._textify(this.dom.enticement),e){var i=this._element({parentNode:this.dom.enticement,classes:"guide-tile-covers",access:"inert"});APP.patron.pins.pause(function(){e.freshen(0,8,function(e,s){s=t.shuffle(s.slice()).slice(0,5),s.sort(function(e,t){var i={book:1,magazine:2,audiobook:3};return i[t.format]-i[e.format]}),t.each(s.slice(0,3),function(e){new r(i).become(e)})})}.bind(this),{scope:"title"})}},s}),define("app/views/screens/library/screen-library-guides",["require","common","app/views/screens/screen","app/views/components/library/app-header-with-emblem","app/views/library/guide-tile"],function(e){var t=e("common"),i=e("app/views/screens/screen"),s=i.new(),n=s.prototype,r=e("app/views/components/library/app-header-with-emblem"),o=e("app/views/library/guide-tile");return n.become=function(e){this._prepare(),this.library=e,this.library.catalog.guides.use(function(e,t){e.isIdeal||t.reuse(),this._fillOut(t.all)}.bind(this))},n._layout=function(e){this._build("screen-library-guides .explore-view",{extending:e}," content .content","  pillar .pillar","   meta","    intro .library-intro .bumper-n .bumper-e .bumper-w","     head <h1> .library-head {guides.head}","     lede <p> .lede {guides.promo}","   grid .explore-grid .bumper-s .bumper-e .bumper-w")},n._layoutHeader=function(e){e.header=new r,e.header.impart(e.root,"prepend")},n._fillOut=function(e){t.each(e,function(e,t){this.dom["tile"+t]=new o(this.dom.grid).become(e)},this)},s}),define("app/controllers/library/guides-controller",["require","common","app/controllers/train-controller","app/views/screens/library/screen-library-guides"],function(e){var t=e("common"),i=e("app/controllers/train-controller"),s=i.new(),n=s.prototype;return n.SCREEN_CLASS=e("app/views/screens/library/screen-library-guides"),n.configure=function(){this.realm=t.try(this.ancestor,"realm")||"library",this.waypoint.configure({label:"guides.head"})},n.match=n.refine=function(e){if("guides"==e)return{head:"guides"}},n.fill=function(){this.screen().become(APP.library)},s}),define("app/controllers/library/extra-controller",["require","common","app/controllers/train-controller","./title-circ-controller"],function(e){var t=(e("common"),e("app/controllers/train-controller")),i=t.new(),s=i.prototype;return s.SUB_CONTROLLERS=[e("./title-circ-controller")],s.match=function(e){var t=e.match(/^([^\/]+)\/?(.*)$/);if(t){this.args={providerId:t[1]};var i=t[2];return i="request",{head:this.args.providerId,tail:i}}},s.usher=function(){this.provider=APP.library.catalog.extras.produce(this.args.providerId),this.title=this.provider},i}),define("app/views/library/extras-tile",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.become=function(e){this._prepare(),t.isList(e)?this._fillOutPromo(e):this._fillOut(e)},n._layout=function(){this.dom=this._build("extras-tile"," clip","  assets","  runner","   about","    identity","    blurb","     blurb-text <p> {loading}","    features","     features-text <p>")},n._fillOut=function(e){e.colorize(this.dom.root),this._textify(this.dom.blurbText,{html:t.safe(e.tagline),wrapper:"span"}),t.try(e,"features.length")&&this._textify(this.dom.featuresText,{html:t.safe(e.features[0]),wrapper:"span"});var i=t.try(e,"assets.length");i&&i<3?this._fillOutSingleAsset(e,t.try(e,"assets[0]")):i?this._fillOutAssets(e,{count:7,logo:0}):this._fillOutNoAssets(e)},n._fillOutPromo=function(e){this._classify(this.dom.root,"extras-tile-promo"),this._semaphore("promo",e.length),t.each(e.slice(0,3),function(i,s){var n={identity:!1,repeat:!0,logo:s,count:3};2==e.length&&(n.count=s?5:4,n.logo=s?4:0),1==e.length&&(n.count=9,n.logo=4);var r=this._fillOutAssets(i,n);i.assets.length||this._classify(r[0],"is-full-width"),t.each(r,function(e){i.colorize(e)},this)},this)},n._fillOutNoAssets=function(e,i){return i=t.absorb(i,{}),0!=i.identity&&this._populateIdentity(e,t.try(e,"icon")),this._createAssetInFrame(e,t.try(e,"logo"),{parentNode:i.container||this.dom.assets,classes:"extras-tile-asset extras-tile-asset-logo extras-tile-asset-solo"})},n._fillOutSingleAsset=function(e,i,s){return s=t.absorb(s,{}),0!=s.identity&&this._populateIdentity(e,t.try(e,"icon")),this._createAssetInFrame(e,i,{parentNode:s.container||this.dom.assets,classes:"extras-tile-asset extras-tile-asset-solo"})},n._fillOutAssets=function(e,i){i=t.absorb(i,{count:7}),i.logo!==!1&&"number"!=typeof i.logo&&(i.logo=Math.floor(i.count/2)),i.identity!==!1&&this._populateIdentity(e,t.try(e,"icon"));var s=(e.assets||[]).slice(0,i.count);if(i.repeat!==!1)for(;s.length&&s.length<i.count;)s.push(s[s.length-e.assets.length]);s.length||i.logo===!1||(s=[null],i.logo=0);var n=[];return t.each(s,function(t,s){var r="extras-tile-asset";i.logo!==!1&&s==i.logo&&(t=e.logo,r+=" extras-tile-asset-logo"),n.push(this._createAssetInFrame(e,t,{parentNode:i.container||this.dom.assets,classes:r}))},this),n},n._populateIdentity=function(e,i){i&&i.image?(this._textify(this.dom.identity),this._createAssetImage(e,i,{parentNode:this.dom.identity,classes:"icon-image"})):this._textify(this.dom.identity,{html:t.safe(e.name)})},n._createAssetImage=function(e,i,s){var n=e.optimizedAssetURL(i);if(n){var r=t.safe(i.caption||i.title||e.name||"");r=r||this._phrase("extras.unnamed");var o=this._element(t.absorb(s,{tag:"img",alt:r}));return APP.imageDirector.enqueue(o,n),o}},n._createAssetInFrame=function(e,i,s){s=t.absorb(s,{});var n={parentNode:t.excise(s,"parentNode"),classes:t.excise(s,"classes")},r=this._createAssetImage(e,i,s);if(r){var o=this._element(n);return o.appendChild(r),o}},s}),define("app/views/screens/library/screen-library-extras",["require","common","app/views/screens/screen","app/views/components/library/app-header-with-emblem","app/views/library/extras-tile"],function(e){var t=e("common"),i=e("app/views/screens/screen"),s=i.new(),n=s.prototype,r=e("app/views/components/library/app-header-with-emblem"),o=e("app/views/library/extras-tile");return n.become=function(e){this.library=e,this._prepare(),this.library.catalog.extras.use(function(e,t){return e.isIdeal?void this._fillOut(t):t.reuse()}.bind(this))},n._layout=function(e){this._build("screen-library-extras .explore-view",{extending:e}," content .content","  pillar .pillar","   meta","    intro .library-intro .bumper-n .bumper-e .bumper-w","     head <h1> .library-head {extras.head}","     lede <p> .lede {loading}","   grid .explore-grid .bumper-s .bumper-e .bumper-w")},n._layoutHeader=function(e){e.header=new r,e.header.impart(e.root,"prepend")},n._fillOut=function(e){this._textify(this.dom.lede,{label:"extras.lede",substitutions:{LIBRARY_NAME:this.library.safeName()}}),this._textify(this.dom.grid),t.each(e.active(),function(e){var t=this._element({button:e.open.bind(e),parentNode:this.dom.grid,classes:"extras-provider-button"});new o(t).become(e)},this)},s}),define("app/controllers/library/extras-controller",["require","common","app/controllers/train-controller","./extra-controller","app/views/screens/library/screen-library-extras"],function(e){var t=e("common"),i=e("app/controllers/train-controller"),s=i.new(),n=s.prototype;return n.SUB_CONTROLLERS=[e("./extra-controller")],n.SCREEN_CLASS=e("app/views/screens/library/screen-library-extras"),n.configure=function(){this.realm=t.try(this.ancestor,"realm")||"library",this.waypoint.configure({label:"extras.head"})},n.match=n.refine=function(e){var t=e.match(/^extras\/?(.*)/);if(t)return{head:"extras",tail:t[1]}},n.fill=function(){this.screen().become(APP.library)},s}),define("app/controllers/library/title-redirect-controller",["require","common","app/controllers/controller"],function(e){var t=(e("common"),e("app/controllers/controller")),i=t.new(),s=i.prototype;return s.match=function(e,t,i){var s=e.match(/^title\/(\d+)(\/(.+))?$/);if(s){var n=s[1],r=(s[3]?"/"+s[3]:"")+t+i,o="library/"+this.ancestor.args.key;return{rewrite:o+"/similar-"+n+"/page-1/"+n+r}}},i}),define("app/views/components/filters/filter-cloud-for-newsstand",["require","common","app/views/components/filters/filter-cloud-for-list"],function(e){var t=e("common"),i=e("app/views/components/filters/filter-cloud-for-list"),s=i.new(),n=s.prototype;return n.BLOCK_CATEGORIES=["subject","search","sort","audience","language"],n._layout=function(e){i.prototype._layout.apply(this,arguments),this._classify(e.root,"filter-cloud-for-newsstand")},n._navigateToList=function(e,i){t.try(e,"params.refinements.breakpoint")&&(delete e.params.refinements.breakpoint,delete e._.baseAPIURL);var s=e.params.address();return s=APP.router.route.path.match(/newsstand/)?APP.router.route.path.replace(/newsstand.*/,"newsstand/"+s):"shelf/newsstand/"+s,APP.nav.go(s),s},n._suggestFacetsForList=function(e){var i=7;window.innerWidth<=800&&(i=6),window.innerWidth<=640&&(i=5),window.innerWidth<=480&&(i=4);var s=function(e,i){this.reset(),t.each(this._buttonsPropertiesForFacets(e,i),this.button.bind(this)),this._primaryButtonsAdded()}.bind(this),n=function(e){APP.journal.warn("[FCFNS] failure fetching suggested facets"),this.reset(),this._primaryButtonsAdded()}.bind(this);e.facets.freshen(function(r){var o=r.find({applied:!0,innate:!1,encompass:!1,pinned:!1}),a=this._facetForSearchWithin(e);a&&o.push(a);var l;if(t.each(o,function(e){"subject"==e.category&&(l&&t.breakIteration(l=null),l=e)}),null===l)s(o);else{var c=e.params.withRefinements({subjects:null}).address(),h=e.library.catalog.lists.produce(c);h.facets.freshen(function(e){t.each(e.find({category:"subject",encompass:!1}),function(e){o.length>=i&&t.breakIteration();for(var s=0,n=o.length;s<n;++s)if(o[s].value==e.value)return;o.push(e)}),s(o,{replacing:l})}.bind(this),n)}}.bind(this),n)},s}),define("app/views/screens/library/screen-library-newsstand",["require","common","app/views/screens/screen","app/views/components/library/app-header-with-emblem","app/views/components/filters/filter-cloud-for-newsstand","app/views/components/library/list-banner","app/views/core/title-list"],function(e){var t=e("common"),i=e("app/views/screens/screen"),s=i.new(),n=s.prototype,r=e("app/views/components/library/app-header-with-emblem"),o=e("app/views/components/filters/filter-cloud-for-newsstand"),a=e("app/views/components/library/list-banner"),l=e("app/views/core/title-list");return n.become=function(e){this.list=e;var t=this._prepare();this._classify(t.backdrop,"is-pending"),t.filterCloud.pending(this._.pending=!0),t.chain.reset(),t.chain.configure({pageFactory:this._titlesInRange.bind(this),theEndBlock:this._listSubjectsAtEnd.bind(this),blockSize:e.PAGE_SIZE}),t.chain.populate({list:e,provenance:"shelf",forceType:"magazine"})},n._layout=function(e){this._build("screen-library-newsstand",{extending:e}," content .content","  meta","   backdrop .is-pending .pillar",{access:"visual"},"   intro .library-intro .pillar .bumper-n .bumper-e .bumper-w","    head <h1> .library-head {crumb.newsstand}","  bumper .pillar .bumper-e .bumper-s .bumper-w","   filter-cloud",o,"   banners","   chain",{construct:l,with:"stand"}),this.dom.chain.claim(this)},n._layoutHeader=function(e){e.header=new r,e.header.impart(e.root,"prepend")},n._titlesInRange=function(e,t,i,s){return this._declassify(this.dom.content,"is-list-error"),this.controller.args.recentAndPopular?this._recentAndPopularTitlesInRange.apply(this,arguments):this.list?void this.list.freshen(e,t,function(e,t){this._stopPending(e,t),e.totalTitles>0?i({titles:t}):this._checkWhetherLibraryHasMagazines(function(t){s(this._explainEmptyList(e,{hasMagazines:t}))}.bind(this))}.bind(this),function(){this._.pending&&this.dom.filterCloud.become(this.list),s(this._explainEmptyList(this.list),{isFailure:!0})}.bind(this)):s({retry:!0})},n._recentAndPopularTitlesInRange=function(e,i,s,n){var r=24,o=APP.patron.magazines;i=Math.min(i,r);var a=[];if(e>=i)return s({titles:a});var l=function(){this._stopPending(this.list,a),e||a.length?s({titles:a}):this._checkWhetherLibraryHasMagazines(function(e){n(this._explainEmptyList(this.list,{hasMagazines:e}))}.bind(this))}.bind(this),c=function(){var s=i-e-a.length;return s<=0?l():void this.list.freshen(e,i,function(e,i){if(i.length)for(;i.length&&s;){var n=i.shift();t.among(n,a)||(a.push(n),s-=1)}else a.splice(0);l()}.bind(this),function(){this._.pending&&this.dom.filterCloud.become(this.list),n(this._explainEmptyList(this.list,!this.list.invalidities))}.bind(this))}.bind(this),h=t.select(o.openHistory,function(e){if(!o.find({"title.titleId":e[0]})){for(var t=o.filter({"title.parentMagazineId":e[1]}),i=0,s=t.length;i<s;++i)if(t[i].taggings)return;return e[1]}});return h.length?void APP.services.thunder.fetch("media/bulk?titleIds="+t.unique(h).join(","),function(s){var r;try{r=JSON.parse(s)}catch(e){return n({retry:!0})}var o={source:"external",integrity:"incomplete"};t.each(r,function(e){title=APP.titles.produce({titleId:e.id}),title.import(e,o),a.push(title)}),a=a.slice(e,i),c()},function(e){n({retry:!0})}):c()},n._stopPending=function(e,t){this._.pending&&(this._.pending=!1,this.dom.filterCloud.become(e),this._fillOutBanners(e),this._fillOutBackdrop(t))},n._fillOutBanners=function(e){this._textify(this.dom.banners);var i=this._element({parentNode:this.dom.banners});e.banners(function(e){t.isInDOM(i)&&t.each(e,function(e){new a(i).become(e)})},this)},n._fillOutBackdrop=function(e){var i=this._prepare();this._classify(i.backdrop,"is-pending"),this._defer("backdrop",function(){var s=0;t.each(t.shuffle(e.slice()),function(e,n){if(s>=4)return t.breakIteration();var r=APP.coverGuru.coverURLForTitle(e);if(r){var o=i.backdrop.children[s];o?this._declassify(o,"hide"):(o=this._element({tag:"img",parentNode:i.backdrop}),APP.events.on(o,"error",this._classify.bind(this,o,"hide",!0))),APP.coverGuru._applySourceURLToImage(o,r),s+=1}},this),this._classify(i.backdrop,"is-pending",!s)}.bind(this),500)},n._listSubjectsAtEnd=function(e){var i=this._element({classes:"screen-library-newsstand-end-block"}),s=this._element({classes:"screen-library-newsstand-banners",parentNode:i});this.list.library.catalog.extras.use(function(e,i){this._textify(s),e.isIdeal||i.reuse();var n=i.find("pressreader");"active"==t.try(n,"subscription.status")&&this._build("newsstand-banner",{parentNode:s}," cue",{label:["newsstand.banner.pressreader.1","newsstand.banner.pressreader.2"]}," action","  link .shibui-button {extras.get}",{button:n.open.bind(n)})},this);var n=this._element({tag:"ul",parentNode:i,classes:"screen-library-newsstand-subjects"});this.controller.args.recentAndPopular&&t.try(APP.patron.magazines,"openHistory.length")&&this._element({button:this._clearRecentlyOpenedMagazines.bind(this),parentNode:i,classes:"screen-library-newsstand-clear-button",label:"newsstand.clear-recently-opened-magazines"});var r=this.list.library.catalog.lists.produce("spotlight-newsstand"),o=this.controller.path.replace(/newsstand.*/,"newsstand");r.facets.freshen(function(s){t.each(s.find({category:"subject"}),function(e){"1194"!=e.value&&"1191"!=e.value&&"1190"!=e.value&&"1188"!=e.value&&this._element({link:o+"/subject-"+e.value,html:e.name,parentNode:this._element({tag:"li",parentNode:n})})},this),e(i)}.bind(this))},n._clearRecentlyOpenedMagazines=function(){t.try(APP.patron.magazines.openHistory,"splice()",0),APP.patron.magazines.save(),this.become(this.list),APP.arena.scroller.scrollToTop()},n._checkWhetherLibraryHasMagazines=function(e){var t=this.list.library;return t?void t.catalog.facets.freshen(function(t){var i=t.find({category:"format",value:"magazine"})[0];e(!(!i||!i.totalTitles))}):e(!1)},n._explainEmptyList=function(e,i){if(i=i||{},i.hasMagazines===!1){this._classify(this.dom.content,"is-list-error");var s=this.dom.header.dom.emblem;return{lede:"newsstand.no-magazines-at-library",button:{label:"newsstand.no-magazines-at-library.choose",action:s._onTapButton.bind(s)}}}return i.isFailure&&!e.invalidities?(this._classify(this.dom.content,"is-list-error"),{head:"list.failure",lede:"list-chain.failures.network",retry:!0}):APP.patron.pins.signature("title")?{head:"list.empty",lede:{label:"list.empty.filtering",enliven:{"#edit-filters":function(){t.try(this.dom.filterCloud,"presentEditorDialog()")}.bind(this)}}}:{head:"list.empty",lede:"list.empty.collection"}},s}),define("app/controllers/library/newsstand-controller",["require","common","app/controllers/train-controller","app/models/items/list-parameters","app/views/screens/library/screen-library-newsstand"],function(e){var t=e("common"),i=e("app/controllers/train-controller"),s=i.new(),n=s.prototype,r=e("app/models/items/list-parameters");return n.SCREEN_CLASS=e("app/views/screens/library/screen-library-newsstand"),n.configure=function(){this.realm=t.try(this.ancestor,"realm")||"library",this.waypoint.configure({label:"crumb.newsstand",color:"#003237"})},n.match=n.refine=function(e){if(APP.library||"library"==this.realm){var i=e.match(/^newsstand(\/spotlight-newsstand)?(\/(.*))?/);if(i){var s=i[3]||null,n=t.compact(["spotlight-newsstand",s]).join("/"),o=new r(APP.library,n);return this.args={address:n,params:o,recentAndPopular:!s},this.args.recentAndPopular&&t.each(APP.patron.pins.filter({scope:"title"}),function(e){t.among(e.category,"sort","language","audience")&&(this.args.recentAndPopular=!1)},this),n!=this.address&&(delete this.address,delete this.list,delete this._.refreshToList),{head:t.compact(["newsstand",s]).join("/")}}}},n.enter=function(){APP.events.off(this._.handlers),this._.handlers={},this._.handlers.onLibrarySwitch=APP.events.on("library:switch",this._onLibrarySwitch.bind(this)),this._.handlers.onPinUpdateAll=APP.events.on("pin:update:all",this._onPinUpdateAll.bind(this))},n.usher=function(){this.list&&this.list._isFresh()||(this.routeFilled=!1);var e=this.args.params.address();e!=this.address&&(this.address=e,this.list=APP.library.catalog.lists.produce(this.address))},n.fill=function(){this._fillWithRefreshedList()||(this.screen().become(this.list),this.screen().scroller.scrollToTop({duration:0}))},n.focus=function(){return this._fillWithRefreshedList(),i.prototype.focus.apply(this,arguments)},n.exit=function(){APP.events.off(this._.handlers)},n._onLibrarySwitch=function(){this._assignRefreshedList()},n._onPinUpdateAll=function(){this._assignRefreshedList()},n._assignRefreshedList=function(){this._.refreshToList=APP.library.catalog.lists.produce(this.address)},n._fillWithRefreshedList=function(){var e=t.excise(this._,"refreshToList");return!!e&&(this.list=e,this.fill(),!0)},s}),define("app/views/library/announcements-block",["require","common","app/views/core/partial","app/views/components/interviews/interview-block"],function(e){var t=(e("common"),e("app/views/core/partial")),i=t.new(),s=i.prototype,n=e("app/views/components/interviews/interview-block");return s.become=function(e){return this.library=e,this._.route=APP.router.route,this._prepare(),this._declassify(this.dom.root,"hide"),this._semaphore("announcing",null),this.dom.interview.reset(),this.library.card()||this._hasAnnounced("auth")?this.library.promotesKindle&&SPARK.locale.isEnglish&&!this._hasAnnounced("kindle")&&!APP.patron.isDismissed("announcements:kindle-features")?(this._announce("kindle"),this.dom.interview.become("configure/kindle-shill",{callback:this.become.bind(this,this.library),focusFirstElement:!0}),this._emptyElement(this.dom.mural)):(this._dispatch("announcing",{announcement:null}),this.extract(),APP.arena.resetElementFocus()):(this._announce("auth"),this.dom.interview.become("authenticate/card",{inline:!0,library:this.library,callback:this.become.bind(this,this.library)}),APP.imageDirector.mural(this.dom.mural,"auth-intro")),this},s.focus=function(){},s._layout=function(){this.dom=this._build("announcements-block .bumper-e .bumper-w"," .pillar","  interview",n,"  mural")},s._announce=function(e){this._.announced=this._.announced||[],this._.announced.push(e),this._semaphore("announcing",e),this._dispatch("announcing",{announcement:e})},s._hasAnnounced=function(e){return this._.announced=this._.announced||[],this._.announced.indexOf(e)>=0},i}),define("app/views/library/circ-pill",["require","common","app/views/core/partial","shibui/src/components/spinner"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("shibui/src/components/spinner");return n.become=function(e,i){this.title=e,this.options=t.absorb(i,{}),this.refresh()},n.refresh=function(){if(!this.title)return this.extract();var e={"title.titleId":this.title.titleId};if(APP.patron.loans.find(e))return this.extract();if(this.options.library&&(e["library.websiteId"]=this.options.library.websiteId),APP.patron.holds.find(e))return this.extract();if(!APP.network.reachable)return APP.events.once("network:info",this.refresh.bind(this)),this.extract();this.dom.root.parentNode||this.impart(),this.dom.spinner.spin();var i={libraries:{}};this.options.library&&this.options.bestCirc?i.libraries.preferred=this.options.library:this.options.library&&(i.libraries.scope=[this.options.library]),this.title.holdings.withBestCircAction(function(e){if(t.among(e.status,"complete","failed")){if(this.action={unowned:"notify-me",hold:"hold"}[e.action]||"borrow",this.library=e.library||APP.library,"notify-me"==this.action&&(this.library=this.options.library||this.library,this.options.ignoreUnowned||!this.library.allowDeepSearch))return this.extract();this.dom.root.parentNode||this.impart();var i="action.title."+this.action,s=i;this.options.compact&&SPARK.locale.isEnglish?s={html:t.titleize(this.action.replace(/-/g," "))}:this.options.compact&&(s={html:"＋"}),this._textify(this.dom.button,s),this._attr(this.dom.button,"aria-label",this._phrase(i)),this.dom.spinner.stop()}}.bind(this),i)},n._layout=function(){this.dom=this._build("circ-pill"," spinner",{construct:r,with:{variant:"small"}}," button .shibui-button",{button:!0})},n._onTapButton=function(e){if(this._dispatchActionEvent("commence"),"notify-me"!=this.action){var i;i=t.try(this.options.list,"library")==this.library?this.title.path(this.options.list,this.action):this.title.path(this.library,this.action),"search"==APP.router.realm&&i.replace(/library/,"search"),APP.nav.go(i)}else var s=APP.interviews.dialog("tutorial/title-unowned-notify-me",{title:this.title,library:this.library,callback:function(){s.minimize(),this._dispatchActionEvent("complete")}.bind(this)}).present()},n._dispatchActionEvent=function(e){this._dispatch("action:"+e,{pill:this,action:this.action,title:this.title,library:this.library})},s}),define("app/views/components/library/campaign-block-book-club",["require","common","app/views/core/partial","app/views/core/block-strap","app/views/library/list-lede","app/views/core/cover-box","app/views/library/circ-pill"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/core/block-strap"),o=e("app/views/library/list-lede"),a=e("app/views/core/cover-box"),l=e("app/views/library/circ-pill");return n.become=function(e){this._prepare(),this.campaign=e,this.campaign.use(this._fillOut.bind(this,e))},n._layout=function(){this.dom=this._build("campaign-block-book-club .campaign-block .home-block"," pillar",{classes:"pillar bumper-e bumper-w"},"  intro .home-block-intro","   strap",r,"   article",o,"  lozenge .home-block-feature","   hero","    cover","     cover-box",a,"    cta","     murmur","     logo","   bar","    bar-title","     bar-text","      bar-strap","      bar-link",{link:"#"},"     circ-pill",l),this.dom.strap.configure({text:"campaign.heading.default",circle:{icon:"block-strap-dismiss",spoken:"a11y.list.dismiss",button:function(e){this._dispatch("block:dismiss",{target:e.target})}.bind(this)}})},n._listen=function(){this._handle("color",this.dom.coverBox)},n._fillOut=function(e,i){var s=e.titles[0],n=s?s.path(e.list):void 0;this.dom.strap.configure({text:{html:e.strapline||this._phrase("a11y.campaign-logo"),link:n}}),this.dom.article.populate({html:e.data.article}),this._textify(this.dom.murmur,{html:e.data.murmur});var r=t.try(e.data,"colors")||{};APP.coverGuru.paint(this.dom.root,"campaign-base",r.base,{delay:1}),this._textify(this.dom.logo);var o=t.try(e.data,"images.logo");if(t.try(o,"src")){var a=this._element({tag:"img",src:o.src,alt:o.caption||this._phrase("a11y.campaign-logo")});t.try(o,"link.href")?this._element({tag:"a",parentNode:this.dom.logo,href:o.link.href}).appendChild(a):this.dom.logo.appendChild(a),this._classify(this.dom.root,"has-logo")}else this._declassify(this.dom.root,"has-logo");s?(this._semaphore("campaign-format",s.format),this.dom.coverBox.become(s,{link:n}),this.dom.circPill.become(s,{library:APP.library,list:e.list,ignoreUnowned:!0,compact:!0}),this._textify(this.dom.barStrap,"guide.feature.link"),s.holding().use(function(e,t){return e.isIdeal?void(isFinite(t.copiesOwned)||this._textify(this.dom.barStrap,{label:"title-availability.available",substitutions:{COPIES_AVAILABLE:1/0}})):t.reuse()},this),this._textify(this.dom.barLink,{html:s.title}),this._linkify(this.dom.barLink,n||"#")):(this._textify(this.dom.barStrap),this._textify(this.dom.barLink),this._element({parentNode:this.dom.barLink,classes:"campaign-blame",label:"campaign.warning.misconfigured"}),this._linkify(this.dom.barLink,n||"#"))},n._onColorCoverBox=function(e){if(this.dom.coverBox.zoomable(!0),!t.try(this.campaign,"data.colors.base")){var i=t.rgbToHSLuv(e.m.rgb);i[0]=(i[0]+180)%360,i[1]=Math.max(50,Math.min(90,100-i[1])),
i[2]=Math.max(20,Math.min(80,100-i[2]));var s=t.hsluvToRGB(i);APP.coverGuru.paint(this.dom.root,"campaign-base",s,{delay:1})}},s}),define("app/views/components/library/campaign-block-call-to-action",["require","common","app/views/core/partial","app/views/core/block-strap","app/views/library/list-lede"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/core/block-strap"),o=e("app/views/library/list-lede");return n.become=function(e){this._prepare(),this.campaign=e,this.campaign.use(this._fillOut.bind(this,e))},n._layout=function(){this.dom=this._build("campaign-block-call-to-action .campaign-block .home-block"," pillar",{classes:"pillar bumper-e bumper-w"},"  intro .home-block-intro","   strap",r,"   article",o,"  lozenge .home-block-feature","   hero","    info","     logo","     shout","     murmur","    action","     link .shibui-button",{link:"#"},"     deadline","    caption",{access:"spoken"}),this.dom.strap.configure({text:"campaign.heading.default",circle:{icon:"block-strap-dismiss",spoken:"a11y.list.dismiss",button:function(e){this._dispatch("block:dismiss",{target:e.target})}.bind(this)}})},n._fillOut=function(e,i){this.dom.strap.configure({text:{html:e.strapline||this._phrase("a11y.campaign-logo")}}),this.dom.article.populate({html:e.data.article||""});var s=t.try(e.data,"actions[0]");t.try(s,"link.href")?this._textify(this.dom.shout,{html:e.data.shout||""}):this._element({parentNode:this.dom.shout,classes:"campaign-blame",label:"campaign.warning.misconfigured"}),this._textify(this.dom.murmur,{html:e.data.murmur||""});var n,r;t.among("flip",e.data.layout)&&(n="flip"),t.among("north",e.data.layout)&&(r="north"),t.among("south",e.data.layout)&&(r="south"),this._semaphore("campaign-layout-x",n),this._semaphore("campaign-layout-y",r);var o={delay:1},a=t.try(e.data,"colors")||{};APP.coverGuru.paint(this.dom.root,"campaign-base",a.base,o),APP.coverGuru.paint(this.dom.root,"campaign-strap",a.strap,o),APP.coverGuru.paint(this.dom.root,"campaign-action",a.action,o);var l,c,h=[],u=t.try(e.data,"images.hero");t.try(u,"src")&&(h.unshift('url("'+u.src+'")'),l=u.caption,c=(u.anchor||[]).join(" ").trim()||null);var p=t.try(e.data,"gradient");"linear"==t.try(p,"type")&&h.unshift("linear-gradient("+p.angle+"deg,"+p.stops.join(",")+")"),this._stylePrefix(this.dom.hero,"background-image",h.join(", ")),this._stylePrefix(this.dom.hero,"background-position",c),this._textify(this.dom.caption,l?{label:"a11y.campaign-caption",substitutions:{CAPTION:l},wrapper:!1}:""),this._textify(this.dom.logo);var d=t.try(e.data,"images.logo");if(t.try(d,"src")){this._element({tag:"img",parentNode:this.dom.logo,src:d.src,alt:d.caption||this._phrase("a11y.campaign-logo")})}t.try(s,"link.href")?(this._textify(this.dom.link,{html:s.label}),this._linkify(this.dom.link,s.link.href),this._textify(this.dom.deadline,{html:t.try(s.deadline,"label")||""})):(this._textify(this.dom.link,{html:"???"}),this._linkify(this.dom.link,"#"),this._textify(this.dom.deadline))},s}),define("app/views/library/guides-block",["require","common","app/views/core/partial","app/views/core/block-strap","app/views/library/list-lede","app/views/library/guide-tile"],function(e){var t=(e("common"),e("app/views/core/partial")),i=t.new(),s=i.prototype,n=e("app/views/core/block-strap"),r=e("app/views/library/list-lede"),o=e("app/views/library/guide-tile");return s.become=function(e){var t=0,i=this._prepare();e.use(function(s){s.isIdeal||e.reuse();for(var n=e.all.slice(0);n.length&&(t<3||1==n.length);)i["tile"+t]=new o(i.tiles).become(n.shift()),t+=1;n.length&&(i.tileMore=new o(i.tiles).become(n))})},s._layout=function(e){this._build("guides-block .home-block",{extending:e}," pillar .pillar .bumper-e .bumper-w","  intro .home-block-intro","   strap",n,"   lede",r,"  tiles .home-block-feature"),e.strap.configure({text:{label:"guides.head",link:APP.library.path("guides")},circle:{icon:"block-strap-dismiss",spoken:"a11y.list.dismiss",button:function(e){this._dispatch("block:dismiss",{target:e.target})}.bind(this)}}),e.lede.populate("guides.promo")},i}),define("shibui/src/scroll-animator",["require","common","gala"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("gala");return s.DEFAULT_DURATION="relative",s.$init=function(e){this.element=e,this.element.scrollAnimator=this,n.scrollable(this.element)},s.scrollToStart=function(e){this.scrollTo(0,e)},s.scrollToTop=s.scrollToStart,s.scrollTo=function(e,i){i=t.absorb(i,{});var s="x"==i.axis?"scrollLeft":"scrollTop";if(this.element&&this.element[s]!==e){if(0===i.duration)return this.element[s]=e;if(i.manual||"undefined"!=typeof this._.nativeScrolling||(this._.nativeScrolling="scrollBehavior"in this.element.style&&"function"==typeof this.element.scroll),this._.nativeScrolling){var n={behavior:"smooth"};"x"==i.axis?n.left=e:n.top=e,this.element.scroll(n)}else this._manualScrollToPoint(e,i)}},s.scrollToElement=function(e,i){if(this.element.contains(e)){i=t.absorb(i,{});var s=i.aperture||("x"==i.axis?.5*window.innerWidth:.5*window.innerHeight),n=this.element.getBoundingClientRect(),r=e.getBoundingClientRect(),o="x"==i.axis?"left":"top",a=r[o]-n[o],l="x"==i.axis?"scrollLeft":"scrollTop",c=this.element[l];if(!(a>0&&c+a<c+s)){var h=c+a-s;this.scrollTo(h,i)}}},s._manualScrollToPoint=function(e,t){var i=function(e,t,i,s){return e/=s/2,e<1?i/2*e*e+t:(e--,-i/2*(e*(e-2)-1)+t)},s="x"==t.axis?"scrollLeft":"scrollTop",n=this.element[s],r=e-n,o=0,a=20,l=t.duration||this.DEFAULT_DURATION;"relative"==l&&(l=Math.max(100,Math.min(Math.abs(r),750)));var c=function(){o+=a,o<l?(this.element[s]=i(o,n,r,l),requestAnimationFrame(c)):this.element[s]=e}.bind(this);c()},i}),define("app/views/library/extras-block",["require","common","app/views/core/partial","app/views/core/block-strap","app/views/library/list-lede","shibui/src/scroll-animator"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/core/block-strap"),o=e("app/views/library/list-lede"),a=e("shibui/src/scroll-animator");return n.become=function(e){this.extras=e,this._prepare(),this._textify(this.dom.providerList),this._textify(this.dom.pan),this._element({parentNode:this.dom.pan,classes:"extras-block-pan-buffer"}),delete this._.activeProvider;var i=e.active();t.each(i,function(e){this._buildProvider(e,1==i.length)},this),this._activateProvider(i[0]),this.dom.root.setAttribute("data-provider-count",i.length);var s={};i.length>4&&(s.link=APP.library.path("extras"),s.label="extras.promo.cue"),this.dom.lede.populate({label:"extras.promo",wrapper:!1},s)},n._layout=function(){this.dom=this._build("extras-block .home-block"," pillar .pillar .bumper-e .bumper-w","  intro .home-block-intro","   strap",r,"   lede",o,"  feature .home-block-feature","   window","    pan",{access:["visual",{tabindex:-1}]},"    sidebar <aside>","     provider-list <ul> .halos-anchor",{access:{tabindex:-1}},"   controls","    icon <img>","    blurb <p>",{attributes:{"aria-live":"polite"}},"    get-button .shibui-button",{button:!0,html:"+"}),this.dom.strap.configure({text:{link:APP.library.path("extras"),label:"extras.head"},circle:{icon:"block-strap-dismiss",spoken:"a11y.list.dismiss",button:function(e){this._dispatch("block:dismiss",{target:e.target})}.bind(this)}}),this._textify(this.dom.getButton,"extras.get")},n._listen=function(){APP.events.scrollable(this.dom.providerList,"y"),APP.events.scrollable(this.dom.pan,"x"),this._handle("scroll",this.dom.pan),this._.panAnimator=new a(this.dom.pan),this._.listAnimator=new a(this.dom.providerList),APP.events.setTouchAction(this.dom.pan,"pan-x pan-y")},n._buildProvider=function(e,i){var s=this._element({tag:"li",parentNode:this.dom.providerList,classes:"extras-block-provider-item",attributes:{"data-provider":e.providerId}}),n=this._element({button:this._activateProvider.bind(this,e),parentNode:s,classes:"extras-block-provider-button"}),r=(this._element({tag:"span",parentNode:n,classes:"extras-block-provider-name",html:t.safe(e.name)}),this._element({parentNode:this.dom.pan,classes:"extras-block-provider-assets",attributes:{"data-provider":e.providerId}}));if(r&&!r.firstChild){var o=e.assets.slice(0)||[];i?o.unshift(e.logo):o=o.slice(0,6);var a=!0;t.each(o,function(e,s){if(!i||s){var n=t.try(e,"image.dimensions"),r=n&&n[0]<=n[1];a=a&&r,a||t.breakIteration()}},this),a=a||o.length<6;var l=Math.ceil(o.length/2),c=a?[o.slice(0,4)]:[o.slice(0,l),o.slice(l)];t.each(c,function(i){var s=this._element({parentNode:r,classes:"extras-block-assets-row"});t.each(i,function(i){var n=e.optimizedAssetURL(i);if(n){var r=this._element({tag:"img",parentNode:s,classes:"extras-block-asset",attributes:{"data-src":n,alt:t.safe(i.caption||e.name)||this._phrase("extras.unnamed")}});(dims=t.try(i,"image.dimensions"))&&(r.setAttribute("width",500),r.setAttribute("height",Math.floor(500*dims[1]/dims[0])),r.style.setProperty("aspect-ratio",dims[0]+" / "+dims[1]+" auto"))}},this)},this)}e.colorize(s),e.colorize(r)},n._activateProvider=function(e,i){var s=t.epochMilliseconds();if(!(s-(this._.activatedAt||0)<400)&&(i=t.absorb(i,{}),this._.activeProvider!=e||i.scroll!==!1)){var n=this.dom.pan.querySelector('[data-provider="'+e.providerId+'"]');n&&i.scroll!==!1&&this._defer("pan-scroll",function(){this._.panAnimator.scrollTo(n.offsetLeft-this.dom.sidebar.offsetWidth,{axis:"x",duration:250,manual:!0})}.bind(this),100),this._.activeProvider!=e&&(this._.activeProvider=e,this._.activatedAt=s,e.colorize(this.dom.root),t.each(this.dom.root.querySelectorAll("[aria-selected]"),function(e){e.removeAttribute("aria-selected")},this),t.each(this.dom.root.querySelectorAll('[data-provider="'+e.providerId+'"]'),function(e){e.setAttribute("aria-selected",!0),e.classList.contains("extras-block-provider-item")&&this._scrollSidebarTo(e)},this),this._textify(this.dom.blurb,{html:t.safe(e.features[0]),morph:!0}),APP.imageDirector.enqueue(this.dom.icon,t.try(e,"icon.image.url")||""),this.dom.icon.setAttribute("alt",t.safe(t.try(e,"icon.caption")||e.name)),t.each(n.querySelectorAll("[data-src]"),function(e){var t=e.getAttribute("data-src");e.removeAttribute("data-src"),APP.imageDirector.enqueue(e,t)},this))}},n._onTapGetButton=function(e){t.try(this._.activeProvider,"open()")},n._onScrollPan=function(e){this._.activateSoon=this._.activateSoon||t.staggerInvocation(this._activateProviderOnScroll.bind(this),100,300),this._.activateSoon()},n._activateProviderOnScroll=function(){var e,i=this.dom.pan.scrollLeft+this.dom.sidebar.offsetWidth,s=this.dom.pan.scrollLeft+this.dom.pan.clientWidth,n=0,r=function(i){var s=this.extras.find(i);s&&(this._activateProvider(s,{scroll:!1}),e=null,t.breakIteration())}.bind(this);if(t.each(this.dom.pan.querySelectorAll("[data-provider]"),function(o,a){var l=o.getAttribute("data-provider"),c=o.offsetLeft,h=o.offsetLeft+o.offsetWidth;if(c==i&&r(l),c>=i&&h<=s&&r(l),!(c>s||h<i)){var u=Math.min(h,s)-Math.max(i,c);u>=n&&(e=l,n=u),c>=s&&t.breakIteration()}},this),e)try{r(e)}catch(e){}},n._scrollSidebarTo=function(e){var t,i=this.dom.providerList,s=i.scrollTop,n=i.clientHeight,r=i.firstChild.offsetHeight;e.offsetTop<s?t=e.offsetTop:e.offsetTop+e.offsetHeight-5>s+n&&(t=Math.max(0,e.offsetTop-(n-r))),"number"==typeof t&&this._.listAnimator.scrollTo(t,{duration:200,manual:!0})},s}),define("app/views/library/ribbon-block",["require","common","app/views/core/partial","app/views/core/block-strap","app/views/library/list-lede","app/views/core/cover-box"],function(e){var t=(e("common"),e("app/views/core/partial")),i=t.new(),s=i.prototype,n=e("app/views/core/block-strap"),r=e("app/views/library/list-lede"),o=e("app/views/core/cover-box");return s.DEFAULT_SIZE="large",s.COVER_COUNT={large:10,small:5},s.$init=function(e,t){this.size=e||this.DEFAULT_SIZE,this.coverCount=this.COVER_COUNT[this.size],t&&this.impart(t)},s.minimumTitles=s.maximumTitles=function(){return this.coverCount},s.become=function(e){this.list=e,this._prepare(),this.list.freshen(0,this.coverCount,this._fillOut.bind(this),this._fillOutFailure.bind(this)),this.dom.strap.configure({text:{html:this._amplifyText(this.list.name()||this._phrase("loading")),link:this.list.subpath({facets:null})},circle:{icon:"block-strap-dismiss",spoken:"a11y.list.dismiss",button:function(e){this._dispatch("block:dismiss",{target:e.target})}.bind(this)}})},s._layoutPartial=function(){this.dom=this._build("ribbon-block",{classes:"ribbon-"+this.size+" home-block"}," pillar .pillar .bumper-e .bumper-w","  intro .home-block-intro","   strap",n,"   lede",r,"  covers .home-block-feature")},s._fillOut=function(e,t){for(this.dom.lede.become(e);t.length;){var i=t.shift(),s=new o(this.dom.covers);s.become(i,{link:i.path(e)}),s.zoomable(!0)}},s._fillOutFailure=function(){APP.journal.warn("[RIBBON-BLOCK] fillOutFailure",arguments,this)},i}),define("app/views/library/brickwork-wall",["require","common","app/views/core/partial","app/views/core/cover-box"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/core/cover-box");return n.$init=function(e,s){this.options=t.absorb(s,{rows:4}),i.prototype.$init.call(this,e)},n.become=function(e,t){this.list=e,this.titles=t,this._fillOut(this._prepare())},n.exhibit=function(e){this._prepare(),this.dom.exhibition&&this.dom.exhibition.extract(),this.dom.exhibition=e,this.dom.exhibition.impart(this.dom.root),this._handle("view:extract",this.dom.exhibition);var i=this.dom.exhibition.dom.root.offsetWidth||320;return t.each(this.dom.rows,function(e){var t=e.children.length;t%2&&e.children[Math.floor(t/2)].style.setProperty("opacity",0),e.children[Math.ceil(t/2)].style.setProperty("margin-left",i+"px")},this),this._classify(this.dom.root,"is-exhibiting"),this.dom.exhibition},n._layout=function(){this.dom=this._build("brickwork-wall"),this.dom.rows=[],this.dom.bricks=[];for(var e=this.options.rowOffset||0,t=e;t<this.options.rows+e;++t){var i=t%2?"b":"f";this.dom.rows.push(this._createRow(this.dom.root,"f"==i?6:5,i))}},n._createRow=function(e,t,i){for(var s=this._element({parentNode:e,classes:"brickwork-row brickwork-row-"+i}),n=0;n<t;++n)this._createBrick(s);return s},n._createBrick=function(e){var t=this._element({classes:"brickwork-brick",parentNode:e});return new r(t),this.dom.bricks.push(t),t},n._fillOut=function(){t.each(this.dom.bricks,function(e,t){var i=this.titles[t];if(i){var s=this._findViewWithin(e,r);s.become(i,{link:i.path(this.list)}),this._attr(s.dom.press,"data-halo-states","focus")}},this)},n._onViewExtractExhibition=function(){t.each(this.dom.bricks,function(e){e.style.removeProperty("opacity"),e.style.removeProperty("margin-left")}),this._declassify(this.dom.root,"is-exhibiting")},s}),define("app/views/library/brickwork-block",["require","common","app/views/core/partial","app/views/core/block-strap","app/views/library/brickwork-wall","app/views/library/list-lede"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/core/block-strap"),o=e("app/views/library/brickwork-wall"),a=e("app/views/library/list-lede");return n.$init=function(e,s){this.options=t.absorb(s,{rows:5}),i.prototype.$init.call(this,e)},n.become=function(e){this.list=e,this._prepare(),this.list.freshen(0,this.maximumTitles(),this._fillOut.bind(this),this._fillOutFailure.bind(this)),this.dom.strap.configure({text:{html:this._amplifyText(this.list.name()||this._phrase("loading")),link:this.list.subpath({facets:null})},circle:{icon:"block-strap-dismiss",spoken:"a11y.list.dismiss",button:function(e){this._dispatch("block:dismiss",{target:e.target})}.bind(this)}})},n.minimumTitles=n.maximumTitles=function(){return 6*this.options.rows-Math.floor(this.options.rows/2)},n._layout=function(e){this.dom=this._build("brickwork-block",{element:e.root}," pillar",{classes:"pillar bumper-e bumper-w"},"  intro","   strap",r,"   lede",a," wall",{construct:o,with:this.options})},n._fillOut=function(e,t){this.dom.lede.become(e),this.dom.wall.become(e,t)},n._fillOutFailure=function(){APP.journal.warn("[BRICKWORK-BLOCK] fillOutFailure",arguments,this)},s}),define("app/views/dialogs/dialog-filter-cloud-editor",["require","common","app/views/core/partial","shibui/src/components/spinner","app/views/components/filters/filter-cloud"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("shibui/src/components/spinner"),o=e("app/views/components/filters/filter-cloud");return n.present=function(){return this._prepare(),this.shade=APP.arena.shade(this,{springs:[.8],constrainToContentHeight:!0}),this.shade.on("shade:invisible",this._onShadeInvisible.bind(this)),this._classify(this.shade.dom.root,"shade-filter-cloud-editor"),this.dom.submitButton=this._element({button:this._onTapSubmitButton.bind(this),parentNode:this._element({parentNode:this.shade.dom.controls,classes:"shade-filter-cloud-editor-submit halos-anchor"}),classes:"shibui-button halo"}),this._applyResultCount(),this.shade},n.reset=function(e){var i=this._prepare();t.each(this._.blocks,function(e,i){t.try(i.root,"parentNode.removeChild()",i.root)}),delete this._.blocks,!i.spinner&&e&&(i.spinner=new r(i.root),i.spinner.spin())},n.block=function(e,i,s){var n=this._prepare();n.spinner&&(n.spinner.extract(),delete n.spinner),this._.blocks=this._.blocks||{},t.try(this._.blocks[e],"root.parentNode")||(this._.blocks[e]=this._build("dialog-filter-cloud-editor-block",{parentNode:this._prepare().blocks}," box","  head <h2>",{label:"filter.category."+e,id:!0},"  filter-cloud",{construct:o,skip:!i}));var r=this._.blocks[e];if(i){var a=r.filterCloud;this._attr(a._prepare().root,"aria-labelled-by",r.head.id),a.become(i),a.configure(t.absorb(s,{category:e}))}return r},n.pending=function(e){t.each(this._.blocks,function(t,i){i.filterCloud&&i.filterCloud.pending(e)},this)},n.updateCount=function(e,i){if((e!=t.try(this._.resultData,"count")||i!=t.try(this._.resultData,"type"))&&(this._.resultData={count:e,type:i},this._prepare().submitButton))return e?void this._defer("update-count",function(){this._classify(this.dom.submitButton,"is-bouncy"),this.dom.submitButton.parentNode.appendChild(this.dom.submitButton),this._defer("update-count",this._applyResultCount.bind(this),150)}.bind(this)):this._defer("update-count",this._applyResultCount.bind(this),300)},n.focusOnSubmit=function(e){e?this._defer("focus-on-submit",this.focusOnSubmit.bind(this,0),e):(this._defer("focus-on-submit"),t.try(this.dom,"submitButton.focus()"))},n._layout=function(e){this._build("dialog-filter-cloud-editor",{extending:e}," spinner",r," blocks"," controls","  reset-button {filter-cloud.reset}",{button:!0},"  cancel-button {cancel}",{button:!0}).spinner.spin()},n._onTapSubmitButton=function(e){t.try(t.excise(this,"shade"),"minimize()"),this._dispatch("filter-cloud-editor:submit",{intentional:!0})},n._onTapResetButton=function(e){this._dispatch("filter-cloud-editor:reset")},n._onTapCancelButton=function(e){t.try(t.excise(this,"shade"),"minimize()"),this._dispatch("filter-cloud-editor:cancel")},n._applyResultCount=function(){var e=t.try(this._,"resultData.type")||"results",i=t.try(this._,"resultData.count");this._textify(this.dom.submitButton,{label:"filter-cloud.submit."+e,substitutions:{COUNT:i}})},n._onShadeInvisible=function(e){this.shade&&(delete this.shade,this._dispatch("filter-cloud-editor:submit"))},s});define("app/views/screens/library/screen-library-home",["require","common","app/views/screens/library/screen-list-of-lists","app/views/components/library/library-emblem","app/views/components/filters/filter-cloud-for-catalog","app/views/components/common/tutorial-balloon","app/views/core/chaining-list","app/views/library/announcements-block","app/views/components/library/campaign-block-book-club","app/views/components/library/campaign-block-call-to-action","app/views/library/guides-block","app/views/library/extras-block","app/views/library/ribbon-block","app/views/library/brickwork-block","app/views/library/the-end-block","app/views/core/restore-lists-button","app/views/dialogs/dialog-filter-cloud-editor"],function(e){var t=e("common"),i=e("app/views/screens/library/screen-list-of-lists"),s=i.new(),n=s.prototype,r=e("app/views/components/library/library-emblem"),o=e("app/views/components/filters/filter-cloud-for-catalog"),a=e("app/views/components/common/tutorial-balloon"),l=e("app/views/core/chaining-list"),c=e("app/views/library/announcements-block"),h=e("app/views/components/library/campaign-block-book-club"),u=e("app/views/components/library/campaign-block-call-to-action"),p=e("app/views/library/guides-block"),d=e("app/views/library/extras-block"),m=e("app/views/library/ribbon-block"),f=e("app/views/library/brickwork-block"),g=e("app/views/library/the-end-block"),b=e("app/views/core/restore-lists-button");e("app/views/dialogs/dialog-filter-cloud-editor");return n.COLLECTION_COUNT=16,n.become=function(e){this.library=e,this._prepare(),this._fillOut()},n.focus=function(){i.prototype.focus.call(this),this.isInDocument()&&this.dom.chain.focus()},n._layout=function(e){this._build("screen-library-home",{extending:e}," content .content .bumper-n .bumper-s","  intro .library-intro .pillar .bumper-e .bumper-w","   emblem",r,"   head <h1> {a11y.library.welcome}","   filter-cloud",o,"  chain",l),e.chain.claim(this),e.restoreListsButton=new b},n._listen=function(e){this._handle("app:refresh"),this._handle("dismiss",this.dom.restoreListsButton),this._handle("undismiss",this.dom.restoreListsButton)},n._fillOut=function(){this.dom.emblem.become(this.library,{summary:{}}),this.dom.restoreListsButton.become({library:this.library}),this.library.use(function(e,t){var i=this._textWithoutOrphans(t.safeName()||"")||void 0;if(this._textify(this.dom.head,{label:"a11y.library.welcome",substitutions:{LIBRARY_NAME:i},substitutionTags:!0,wrapper:!1}),!e.isIdeal)return t.reuse()},this),this._populateFilterCloud(this.dom.filterCloud),this._populateChain(this.dom.chain)},n._populateFilterCloud=function(e){var i={"sort-newest":{link:this.library.path("spotlight-new/page-1"),graphic:"filter-cloud-sort"},"sort-popular":{link:this.library.path("spotlight-popular/page-1"),graphic:"filter-cloud-sort"},"sort-random":{link:this.library.path("spotlight-random/page-1"),graphic:"filter-cloud-sort"},"link-available":{link:this.library.path("spotlight-available/page-1"),graphic:"filter-cloud-filter"}};e.become(this.library.catalog,i),e.list.facets.freshen(function(s){e.reset();var n=s.find({category:"availability",value:"available"})[0];if(n&&n.pinned)t.excise(i,"link-available");else if(n){var r=n.totalTitles;"number"==typeof r&&isFinite(r)||(r=s.totalTitles),t.absorb({count:r,graphic:""},i["link-available"])}t.each(i,e.button.bind(e)),e._primaryButtonsAdded(),e._.libHome="ready",this._attachBalloonToFilterCloud()}.bind(this))},n._populateChain=function(e){e.reset(),this._.announcementsBlock?e.enchain(function(e,t){t(e.supplant(this._.announcementsBlock))}.bind(this)):e.enchain(this._blockForAnnouncements.bind(this)),e.enchain(this._blocksForLayoutFlow.bind(this)),e._processBlockTaskQueue()},n._blockForAnnouncements=function(e,t){var i=e.supplant(new c);i.on("announcing",function(e){this._.announcementsBlock=e.m.announcement?i:null,this._attachBalloonToFilterCloud()}.bind(this)),i.become(this.library),t(i)},n._blocksForLayoutFlow=function(e,i){var s={guides:this._blockForGuides.bind(this),extras:this._blockForExtras.bind(this),campaign:this._blockForNextCampaign.bind(this,!1),list:this._blockForNextCollection.bind(this,!1)};this.library.catalog.guides.use(function(e,n){return e.isIdeal?(this.dom.filterCloud.howToRefresh(this.become.bind(this,this.library)),this.guide=n.home,this._resetCampaigns(),this._resetLists(this._gatherLists(),{limit:this.COLLECTION_COUNT}),t.each(this.guide.layoutFlow,function(e){var t=s[e];t&&this.dom.chain.enchain(t)},this),this.dom.chain.enchain(this._blockForNextCampaign.bind(this,!0)),this.dom.chain.enchain(this._blockForNextCollection.bind(this,!0)),void i()):n.reuse()}.bind(this))},n._blockForGuides=function(e,t){return this.dom.restoreListsButton.checkList("guides")?void this.library.catalog.guides.use(function(i,s){if(i.isIdeal||s.reuse(),(i.isIdeal||i.isBroken)&&s.all.length<s.DEFAULT_GUIDE_THRESHOLD)return t();var n=new p;n.become(s),n.on("block:dismiss",this._onDismissBlock.bind(this,"guides",n)),t(e.supplant(n))},this):t()},n._blockForExtras=function(e,t){return this.dom.restoreListsButton.checkList("extras")?void this.library.catalog.extras.use(function(i,s){if(!i.isIdeal&&!i.isBroken)return s.reuse();if(!s.hasActive())return t();var n=new d;n.become(s),n.on("block:dismiss",this._onDismissBlock.bind(this,"extras",n)),t(e.supplant(n))},this):t()},n._blockForNextCampaign=function(e,i,s){var n=this._.campaignQueue.shift();if(!n)return s();e&&this._.campaignQueue.length&&this.dom.chain.enchain(this._blockForNextCampaign.bind(this,!0));var r="campaign-"+t.try(n,"id");n.use(function(e){if(!e.isIdeal)return n.reuse();if(!n.isDisplayable())return s();var t=new{"campaign-book-club":h,"campaign-call-to-action":u}[n.type];t.become(n),t.on("block:dismiss",this._onDismissBlock.bind(this,r,t)),s(i.supplant(t))},this)},n._blockForNextCollection=function(e,t,i){this.dom.chain.pending();var s,n=6,r=this._.listCount%n;s=2!==r||this._.avoidBrickwork?new m("large"):new f,this._nextViableList(s,function(n){e&&this.dom.chain.enchain(this._blockForNextCollection.bind(this,!0)),s.become(n),s.on("block:dismiss",this._onDismissBlock.bind(this,n,s)),i(t.supplant(s))}.bind(this),function(n){return s&&s.extract(),this._.avoidBrickwork?(n.ended?(this.dom.restoreListsButton._.dismissalKeys.length?this._.finalBlock=this.dom.restoreListsButton:this._.finalBlock=new g,i(t.supplant(this._.finalBlock))):this._explainListFailure(t,n,{retry:this._blockForNextCollection.bind(this,e,t,i)}),void this.dom.chain.end()):(this._.avoidBrickwork=!0,this._blockForNextCollection(e,t,i))}.bind(this))},n._onDismissBlock=function(e,t,i){this.dom.restoreListsButton.dismissList(e,t,i.m.target)},n._onDismissRestoreListsButton=function(e){this._.finalBlock&&(this._.finalBlock.extract(),delete this._.finalBlock),this._.listCount=Math.max(0,this._.listCount-1),this.dom.chain.enchain(this._blockForNextCollection.bind(this,!0))},n._onUndismissRestoreListsButton=function(){this.become(this.library)},n._gatherLists=function(){var e=[];return t.each(t.try(this.guide,"lists"),function(t,i){this.dom.restoreListsButton.checkList(t)&&e.push(t)},this),e},n._resetCampaigns=function(){var e=[];return t.each(t.try(this.guide,"campaigns"),function(t){var i="campaign-"+t.id;this.dom.restoreListsButton.checkList(i)&&e.push(t)},this),this._.campaignQueue=e},n._attachBalloonToFilterCloud=function(){var e=this.dom.filterCloud,i=t.try(e,"dom.balloon");return"ready"!=t.try(e._,"libHome")||!this.library.card()||APP.patron.isDismissed("tutorial:filter-cloud-editor")?t.try(i,"extract()"):(i=i||(e.dom.balloon=new a),i.attach(e.dom.base.firstChild,"small"),void i.whenDismissed("tutorial:filter-cloud-editor","extract"))},n._onAppRefresh=function(e){APP.router.route==this.controller&&(t.isArray(e.m.realms)?t.excise(e.m.realms,"library"):(APP.events.stop(e),APP.journal.warn("[HOME] preventing full refresh, because the library realm cannot be excluded")),this._populateFilterCloud(this.dom.filterCloud),this._populateChain(this.dom.chain))},s});define("app/controllers/library/home-controller",["require","common","app/controllers/train-controller","./guide-controller","./subjects-controller","./guides-controller","./extras-controller","./title-redirect-controller","./list-controller","./newsstand-controller","app/views/screens/library/screen-library-home"],function(e){var t=e("common"),i=e("app/controllers/train-controller"),s=i.new(),n=s.prototype;return n.SUB_CONTROLLERS=[e("./guide-controller"),e("./subjects-controller"),e("./guides-controller"),e("./extras-controller"),e("./title-redirect-controller"),e("./list-controller"),e("./newsstand-controller")],n.SCREEN_CLASS=e("app/views/screens/library/screen-library-home"),n.configure=function(){this.realm="library",this.historical=!0,this.root=!0,this.waypoint.configure({label:"crumb.library"})},n.match=function(e,i,s){if("library"==e)return APP.library?{rewrite:APP.library.path()}:{rewrite:"/"};var n=e.match(/^library\/([\w\-]+)\/?(.*)/);if(n){if(this.args={key:n[1]},this.args.library=APP.libraries.findActivatableLibrary(this.args.key),this.args.library)return{head:"library/"+this.args.key,tail:n[2]};var r=t.parameterizeURL("interview/locate-library/resolve",{key:this.args.key,next:n[2]?n[2]+i+s:void 0});return{rewrite:r}}},n.enter=function(){APP.libraries.now(this.args.library),this.waypoint.configure({topName:APP.library.safeName()})},n.usher=function(){APP.arena.raise(this.realm),APP.arena.dom.footer.raise(this.realm)},n.fill=function(){this.screen().become(APP.library)},s}),define("app/views/components/filters/filter-cloud-for-collation",["require","common","app/views/components/filters/filter-cloud","app/views/popovers/popover-filter-actions"],function(e){var t=e("common"),i=e("app/views/components/filters/filter-cloud"),s=i.new(),n=s.prototype,r=e("app/views/popovers/popover-filter-actions");return n.become=function(e,i,s){this.collation=e,this.appliedCriteria=i,this.options=s,this.pinScope=this.collation.ITEM_NAME,this.pending(!1),this._retainingOnlyAccessedButtons(function(){if(!(e.all.length<1)){var i={defaults:{pos:"append"}},n=i.map=new Map,r=e.criteria();t.each(r,function(e,t){this._buttonPropertiesForCategory(e,t,i)},this),n.size||t.each(r,function(e,r,o){t.try(s,"only")?i.includingUnapplied=s.only[e]||!1:i.includingUnapplied=!n.size&&"sort"!=e,this._buttonPropertiesForCategory(e,r,i)},this),t.each(n,this.button,this)}}.bind(this)),this._buttonForEditorDialog()},n.refresh=function(){this.become(this.collation,this.appliedCriteria,this.options)},n._chooseApplicableCriteria=function(e){return e.applicableCriteria?e.applicableCriteria:t.try(e.dialog,"applicableCriteria")?e.dialog.applicableCriteria:e.applicableCriteria||t.absorb(this.appliedCriteria,{})},n._buttonPropertiesForCategory=function(e,i,s){var n=new Map,r="sort"==e,o=this._chooseApplicableCriteria(s);return t.each(i,function(i,a){if(a){var l=t.absorb(s.defaults,{category:e}),c=i==o[e];if((c||t.try(s,"includingUnapplied"))&&(!t.isList(t.try(s,"includingUnapplied"))||t.among(i,s.includingUnapplied))){if(r||(l.count=this.collation.facetCount(e,i,o)),c){var h;t.try(s.dialog,"isReset")||(h=APP.patron.pins.find({scope:this.pinScope,category:e,value:i})),l.graphic=h?"filter-cloud-pin":"filter-cloud-remove",r||(this._.appliedCount=l.count||this._.appliedCount||0)}else if(r)l.graphic="filter-cloud-sort";else if(l.graphic=l.graphic||"",!l.count)return;l["data-halo-states"]="focus",t.absorb(this._textDataForFilter(e,i),l),l.button=this._onTapFilterButton.bind(this,e,i,s),l["aria-busy"]=null,l["aria-selected"]=c?"true":"false",n.set(e+"-"+i,l),s.map&&s.map.set(e+"-"+i,l)}}},this),n},n._onTapFilterButton=function(e,i,s,n){APP.haptics.select();var o=n.currentTarget,a=this._chooseApplicableCriteria(s),l=this._toggleFilter.bind(this,e,i,t.absorb(s,{applicableCriteria:a,button:o}));if(s.dialog||a[e]!=i)this._defer(l);else{var c={actions:[{label:"filter-cloud.remove-"+("sort"==e?"sort":"filter"),icon:"filter-cloud-remove",classes:"danger",button:l}]},h={scope:this.pinScope,category:e,value:i},u=APP.patron.pins.isPinnable(h),p=u&&APP.patron.pins.find(h);u&&!p&&c.actions.unshift({label:"filter-cloud.pin-"+("sort"==e?"sort":"filter"),icon:"filter-cloud-pin",button:function(){APP.patron.pins.produce(h),this.button(e+"-"+i,{element:o,graphic:"filter-cloud-pin"})}.bind(this)}),u&&(c.flagsLabel="filter-cloud."+(p?"pinned-":"pinnable-")+("sort"==e?"sort":"filter"));var d=this.collation.criteria()[e];d&&d.length>2&&(c.buttons=this._buttonPropertiesForCategory(e,d,{includingUnapplied:!0})),"year"==e&&(c.collation=this.collation,c.criteria=a);var m=new r;m.become(this.pinScope,e,i,c),m.present(o)}},n._toggleFilter=function(e,i,s){var n=this._chooseApplicableCriteria(s);
n[e]==i?n[e]=this.collation.criteria()[e][0]:(n[e]=i,s.button&&this._attr(s.button,"aria-selected","true")),s.button&&this.button(e+"-"+i,{element:s.button,graphic:"filter-cloud-spinner","aria-busy":"true"});var r;t.try(s,"dialog")?(s.dialog.pending(!0),r=this._populateEditorDialog.bind(this,s.dialog)):(this.pending(!0),r=this._navigateToCriteria.bind(this,n)),r()},n._navigateToCriteria=function(e){var i;t.each(this.appliedCriteria,function(t,s){if(e[t]!=s){var n=APP.patron.pins.find({scope:this.pinScope,category:t});n&&APP.patron.pins.removeItem(n),i=!0}},this),i?APP.nav.go(this.collation.pathWithCriteria(e)):this.refresh()},n._populateEditorDialog=function(e){this.collation.criteria();e.applicableCriteria=e.applicableCriteria||t.absorb(this.appliedCriteria,{}),delete this._.appliedCount,t.each(this.collation.criteria(),function(t,i){var s=this._buttonPropertiesForCategory(t,i,{includingUnapplied:!0,dialog:e}),n=e.block(t,s,{explainEmpty:"availability"!=t});"sort"==t?n.filterCloud.configure({limit:4,hinting:!0}):"availability"!=t||n.box.querySelector("p")||(this._classify(n.box,"dialog-filter-cloud-editor-box-feature"),this._classify(n.box,"dialog-filter-cloud-editor-box-tag-availability"),this._textify(n.head,"filter-cloud.feature"),n.mask=this._element({parentNode:n.box,classes:"mural-mask",pos:"prepend"}),n.mural=this._element({graphic:"filter-cloud-tag-availability-mural",parentNode:n.mask,classes:"mural"}),n.paragraph=this._element({tag:"p",parentNode:n.box,label:"filter.teach.availability-available.tagging"}))},this);var i=this._.appliedCount;"number"!=typeof i&&(i=this.collation.totalCount()),i&&isFinite(i)||(i=void 0);var s="results";this.collation==APP.patron.loans?s="loans":this.collation==APP.patron.holds?s="holds":this.collation==APP.patron.tags&&(resultType="tags"),e.updateCount(i,s),e.pending(!1),e.focusOnSubmit()},n._onEditorDialogSubmit=function(e,i){e.isReset&&APP.patron.pins.removeAll({scope:this.pinScope}),t.try(e,"shade.minimize()"),this._navigateToCriteria(e.applicableCriteria)},n._onEditorDialogReset=function(e,i){e.isReset=!0,e.applicableCriteria={},t.each(this.collation.criteria(),function(t,i){e.applicableCriteria[t]=i[0]},this),this._populateEditorDialog(e)},s}),define("app/views/shelf/collation-empty-state",["require","app/views/core/partial"],function(e){var t=e("app/views/core/partial"),i=t.new(),s=i.prototype;return s.$init=function(e,t){this.container=e,this.label="shelf.empty."+t},s.toggle=function(e){if(e){var t=this.impart(this.container);this._textify(t.explanation,this.label)}else this.extract()},s._layoutPartial=function(e){this._classify(e.box,"collation-empty-state"),e.explanation=this._elem(e.box,"collation-empty-state-expl"),e.arrow=this._elem(e.box,"collation-empty-state-arrow"),this._icon("arrow-curl",e.arrow)},i}),define("app/views/screens/shelf/screen-shelf-collation",["require","common","app/views/screens/screen","app/views/components/shelf/app-header-shelf","app/views/components/filters/filter-cloud-for-collation","app/views/shelf/collation-empty-state","app/models/items/title"],function(e){var t=e("common"),i=e("app/views/screens/screen"),s=i.new(),n=s.prototype,r=e("app/views/components/shelf/app-header-shelf"),o=e("app/views/components/filters/filter-cloud-for-collation"),a=e("app/views/shelf/collation-empty-state"),l=e("app/models/items/title");return n.become=function(e,t){this._fillOut(this._prepare(),e,t)},n._layout=function(e){this._build("screen-shelf-collation",{extending:e}),this._layoutShelfStructure(e,this.controller.args.state),this._layoutShelfHead(e),this._layoutShelfList(e)},n._layoutShelfStructure=function(e,t){this._build("screen-shelf-collation",{extending:e}," content .content .bumper-n .bumper-e .bumper-p-s .bumper-w","  pillar .pillar","   empty",{construct:a,with:t},"   intro","   list")},n._layoutShelfHead=function(e){this._build("head",{extending:e,parentNode:e.intro,extensionClass:"screen-shelf-collation"}," heading <h1>"),this._build("filter-cloud",{construct:o,extending:e,parentNode:e.intro})},n._layoutShelfList=function(e){},n._layoutHeader=function(e){e.header=new r,e.header.impart(e.root,"prepend")},n._fillOut=function(e,t,i){},n._titlesFor=function(e){var i=[];return t.each(e,function(e){return e instanceof l?i.push(e):e&&e.title instanceof l?i.push(e.title):void 0}),i},s}),define("app/views/components/shelf/shelf-summary-block",["require","common","app/views/core/partial","app/views/core/block-strap","app/views/core/title-list"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/core/block-strap"),o=e("app/views/core/title-list");return n.become=function(e,i){this.displayOptions=t.absorb(i,{itemType:"tile",chainOptions:{}}),this._prepare(),this.dom.strap.configure({text:e}),this.dom.chain instanceof o||(t.try(this.dom.chain,"extract()"),this.dom.chain=new o(this.dom.list,this.displayOptions.itemType,this.displayOptions.itemClass)),this.dom.chain.configure(t.absorb(this.displayOptions.chainOptions,{ignoreScrolling:!0})),this._classify(this.dom.root,"hide-orphan-tiles",this.displayOptions.orphans===!1)},n.refresh=function(e){this._prepare(),e=t.absorb(e,{provenance:"shelf"});var i=e.titles||e.possessions||e.items||[];this._.empty=!i.length,this._classify(this.dom.root,"hide",this._.empty),this.dom.chain.populate(e)},n.isEmpty=function(){return this._.empty||!1},n._layout=function(e){this._build("shelf-summary-block .hide",{extending:e}," strap",r," list")},s}),define("app/views/components/shelf/shelf-magazine-rack",["require","common","app/views/core/partial","app/views/core/block-strap","app/views/core/title-list","shibui/src/components/spinner"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/core/block-strap"),o=e("app/views/core/title-list"),a=e("shibui/src/components/spinner");return n.POPULATE_DELAY_MS=200,n.refresh=function(){this._defer("refresh");var e=this._prepare(),t=this.isEmpty(),i=e.root.classList.contains("hide");if(t&&!i)return this._classify(e.root,"hide"),e.chain.reset();if(!t&&i)this._declassify(e.root,"hide"),this._unsuppress(),this._populateWithMagazines(APP.patron.magazines.all);else if(!APP.patron.magazines.all.length)return this._populateWithMagazines([]);APP.patron.magazines.refresh({callback:this._populateWithMagazinesSoon.bind(this)})},n.isEmpty=function(){return!APP.patron.isDismissed("magazine-rack:suppress")&&!APP.patron.magazines.all.length},n._layout=function(e){this._build("shelf-magazine-rack .hide",{extending:e}," strap",r," list","  spinner",a,"  chain",{construct:o,with:"stand"},"  empty .title-list-stands","   adder",{link:"shelf/newsstand",spoken:"a11y.shelf.magazine-rack.newsstand"}),this._element({graphic:"map-zoom-in",parentNode:e.adder.querySelector('[data-access="visual"]')}),e.strap.configure({text:"shelf.summary.magazine-rack"})},n._listen=function(e){this._handle("tag:subscriptions"),this._handle("magazine:update:all")},n._unsuppress=function(){APP.patron.isDismissed("magazine-rack:suppress")||APP.patron.dismiss("magazine-rack:suppress")},n._populateWithMagazinesSoon=function(e){var t=this._populateWithMagazines.bind(this,e);return this._defer("populate",t,this.POPULATE_DELAY_MS)},n._populateWithMagazines=function(e){this._defer("populate"),e=t.select(e,function(i){if(i.fulfiller)return i.fulfiller.use(function(i,s){i.isIdeal||i.isBroken||t.try(s.fulfillments,"length")||s.reuse(this._populateWithMagazinesSoon.bind(this,e))},this),i.fulfiller._fulfillmentsMatching("bifocal").length?i:void 0},this).sort(function(e,t){var i=e.isMarkedAsFinished(),s=t.isMarkedAsFinished();return i&&!s?1:s&&!i?-1:t.title.releaseTime-e.title.releaseTime});var i=!APP.patron.sync._.lastSyncTimestamp;!e.length&&i||this.dom.spinner.extract(),e.length?(this.dom.chain.impart(),this.dom.chain.configure({ignoreScrolling:!0}),this.dom.chain.populate({possessions:e,provenance:"shelf"}),t.last(this.dom.chain.dom.blocks).group.appendChild(this.dom.adder)):(this.dom.chain.extract(),this.dom.empty.appendChild(this.dom.adder))},n._onTagSubscriptions=function(e){this._defer("refresh",this.refresh.bind(this),100)},n._onMagazineUpdateAll=function(e){this._defer("refresh",this.refresh.bind(this),100)},s}),define("app/views/components/shelf/extras-banner",["require","common","app/views/core/title-partial"],function(e){var t=e("common"),i=e("app/views/core/title-partial"),s=i.new(),n=s.prototype;return n._layout=function(){this.dom=this._build("extras-banner",{button:!0}," flex","  provider-icon","  expiry {loading}")},n._specifyForLoan=function(e,i){var s=this._library();e.meta.libraryName=s.safeName(),e.meta.expiresInSeconds=Math.max(60,i.expireTime/1e3-t.epochSeconds()),s.catalog.extras.use(function(s,n){if(!s.isIdeal&&!s.isBroken)return n.reuse(this.refresh,this);var r=s.isIdeal?n.find(i.title.reserveId):null;e.meta.providerId=t.try(r,"providerId"),e.meta.providerName=t.safe(t.try(r,"name")),e.meta.providerIconURL=t.try(r,"icon.image.url"),e.meta.providerIconCaption=t.safe(t.try(r,"icon.caption")||e.meta.providerName||e.title)||this._phrase("extras.unnamed")},this)},n._executeSpecification=function(e,t){this._textify(e.expiry,{label:"shelf.extras.banner",substitutions:{TITLE:t.meta.providerName||t.meta.title,LIBRARY_NAME:t.meta.libraryName,EXPIRE_TIME:this.principal.distanceInTimeToExpiry()}}),this._textify(e.providerIcon),t.meta.providerIconURL&&this._element({tag:"img",parentNode:e.providerIcon,src:t.meta.providerIconURL,alt:t.meta.providerIconCaption})},n._onTap=function(e){this.principal.fulfiller.open({fftType:"ntc"})},s}),define("app/views/components/lectern/mini-player",["require","common","app/views/core/partial","app/views/popovers/popover-offline"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/popovers/popover-offline");return n.JUMP_SECONDS=15,n.become=function(e,t){this.title==e&&this.loan==t.loan&&this.library==t.library||this._setState("closed"),this.title=e,this.loan=t.loan,this.library=t.library,this.refresh()},n.refresh=function(){var e="audiobook"==t.try(this.title,"format");this._classify(this.dom.root,"is-available",e),this._setState(this._discoverState())},n._layout=function(e){this._build("mini-player",{extending:e}," jump-behind",{button:!0,spoken:"a11y.mini-player.jump-behind","data-halo-states":"focus"},"  .mini-player-icon","   jump-behind-icon",{icon:"mini-player-jump"},"   jump-behind-text <span>",{html:""+this.JUMP_SECONDS}," playback-toggle",{button:!0,"data-halo-states":"focus"},"  .mini-player-icon","   playback-toggle-icon",{icon:"mini-player-toggle"},"   playback-spinner .spinner",{icon:"spinner-12"}," jump-ahead",{button:!0,spoken:"a11y.mini-player.jump-ahead","data-halo-states":"focus"},"  .mini-player-icon","   jump-ahead-icon",{icon:"mini-player-jump"},"   jump-ahead-text <span>",{html:""+this.JUMP_SECONDS}," failure-info",{button:!0,spoken:"a11y.mini-player.failure-info"},"  .mini-player-icon","   failure-info-icon",{icon:"mini-player-failure"})},n._listen=function(){this._handle("bifocal:spool:state")},n._onBifocalSpoolState=function(e){this._.isOpening&&"failure"!=e.m.state||this._defer("update:state",function(){this._setState({playing:"playing",pending:"pending",closed:"closed",failure:"failure"}[e.m.state]||"paused")}.bind(this),300)},n._onTapPlaybackToggle=function(e){this._defer("state");var i=this._semaphore("state");if("closed"==i||"failure"==i){var s=function(){this._.isOpening=!0,this._setState("pending"),this._openTitleInBackground(this._onOpened.bind(this))}.bind(this),n=t.try(this.loan,"fulfiller")||this.title.fulfiller();n.isOpenableRightNow()?s():(new r).attempt(s,this.dom.playbackToggle)}else"paused"==i?(this._setState("pending"),this._defer("pending-timeout",this._setState.bind(this,"paused"),2e3),this._sendBifocalCommand("playback-play")):(this._setState("paused"),this._sendBifocalCommand("playback-pause"))},n._onTapJumpBehind=function(e){this._sendBifocalCommand("playback-rewind")},n._onTapJumpAhead=function(e){this._sendBifocalCommand("playback-advance")},n._onTapFailureInfo=function(e){this._openTitleInForeground()},n._setState=function(e){this._defer("pending-timeout"),this._dispatch("state",{state:e}),e!=this._semaphore("state")&&(this._semaphore("state",e),this._textify(this.dom.playbackToggle,{spoken:{paused:"a11y.mini-player.play",pending:"a11y.mini-player.pending",playing:"a11y.mini-player.pause"}[e]}))},n._discoverState=function(){var e="closed";return this.title&&APP.lectern.isOpen(this.title.titleId)&&(e="paused"),"paused"==e&&APP.lectern.bifocal.isPlaying&&(e="playing"),e},n._openTitleInBackground=function(e){var t={onReady:e,onAuthenticate:this._onFailedToOpen.bind(this),onFailure:this._onFailedToOpen.bind(this)};this.loan?APP.lectern.openLoan(this.loan.card.cardId,this.title.titleId,t):APP.lectern.openSample(this.library.key(),this.title.titleId,t)},n._openTitleInForeground=function(){this.loan?APP.nav.go("open/loan/"+this.loan.card.cardId+"/"+this.title.titleId):APP.nav.go("open/sample/"+this.library.key()+"/"+this.title.titleId)},n._sendBifocalCommand=function(e,t){var i={name:"command:execute",dest:"bifocal",command:e};"undefined"!=typeof t&&(i.arguments=t),APP.journal.debug("[MINIPLAYER] cmd -- ",i),APP.shell.transmit(i)},n._onOpened=function(){delete this._.isOpening,APP.lectern.bifocal.isPlaying?this._setState("playing"):this._sendBifocalCommand("playback-play")},n._onFailedToOpen=function(){delete this._.isOpening,this._setState("failure"),APP.lectern.close()},s}),define("app/views/core/reading-now",["require","common","app/views/core/partial","app/views/core/cover-box","app/views/components/lectern/mini-player","app/views/popovers/popover-offline","app/views/dialogs/dialog-manage-possession"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/core/cover-box"),o=e("app/views/components/lectern/mini-player"),a=e("app/views/popovers/popover-offline"),l=e("app/views/dialogs/dialog-manage-possession");return n.become=function(e){this._classify(this.dom.root,"hide",!e),e&&(this.title=e,this.library=APP.titles.libraryForNow()||APP.library,this.possession=APP.titles.possessionForNow(),this.library=t.try(this.possession,"library")||this.library,this.dom.coverBox.become(e,{cloneIfPossible:!0}),this.dom.miniPlayer.become(this.title,{loan:this.possession,library:this.library}),this._textify(this.dom.biblioStatus,{label:"footer.now."+(this.possession?"reading":"sampling")}),this._textify(this.dom.biblioTitle,{html:e.titleWithoutOrphans()||e.reuse()||""}),this._attr(this.dom.openButton,"aria-label",this._phrase({label:"a11y.reading-now.open-title",substitutions:{TITLE:e.title||""}})))},n._layout=function(e){this._build("reading-now",{extending:e}," open-button",{button:!0,spoken:"footer.now.reading"},"  action-desc",{describing:"open-button",spoken:{label:"a11y.reading-now.open-title.description",wrapper:!1}},"  cover","   cover-box",r,"  biblio","   biblio-status",{label:"footer.now.reading"},"   biblio-title"," buttons","  button-manage",{button:!0,spoken:"action.loan.manage","data-halo-states":"focus"},"   icon-manage",{icon:"now-bar-manage"},"  mini-player",o,"  button-dismiss",{button:!0,spoken:"footer.now.clear","data-halo-states":"focus"},"   icon-dismiss",{icon:"now-bar-dismiss"})},n._listen=function(e,t){this._handle("color",t.coverBox),this._handle("state",t.miniPlayer),this._handle("title:open:fulfill")},n._onColorCoverBox=function(e){APP.coverGuru.paint(this.dom.root,"cover",e.m.rgb,{delay:0})},n._onStateMiniPlayer=function(e){this._semaphore("mini-player-state",e.m.state)},n._onTapOpenButton=function(e){this._openTitle()},n._openTitle=function(){if(this.title){var e=t.try(this.possession,"fulfiller"),i=this.dom.coverBox.dom.root;e?e.open({offlinePromptTarget:i}):(new a).attempt(function(){this.title.fulfiller(this.library).use(function(e,t){return e.isIdeal||e.isBroken?void t.open():t.reuse()}.bind(this))}.bind(this),i)}},n._onTitleOpenFulfill=function(){this.dom.miniPlayer.refresh()},n._onTapButtonManage=function(){t.try(APP.arena.dom.popover,"close()");var e={};e.library=this.library,e.exclusions=["download"],this.title.parentMagazineId?e.forceType="magazine":this.possession||e.exclusions.push("journey"),(new l).become(this.title,e).present()},n._onTapButtonDismiss=function(){APP.titles.now(null)},s}),define("app/views/screens/shelf/screen-shelf-summary",["require","common","./screen-shelf-collation","shibui/src/view","shibui/src/components/chevron","app/views/components/shelf/shelf-summary-block","app/views/components/shelf/shelf-magazine-rack","app/views/components/shelf/extras-banner","app/views/core/restore-lists-button","app/views/core/reading-now","app/views/library/the-end-block"],function(e){var t=e("common"),i=e("./screen-shelf-collation"),s=i.new(),n=s.prototype,r=e("shibui/src/view"),o=e("shibui/src/components/chevron"),a=e("app/views/components/shelf/shelf-summary-block"),l=e("app/views/components/shelf/shelf-magazine-rack"),c=e("app/views/components/shelf/extras-banner"),h=e("app/views/core/restore-lists-button"),u=e("app/views/core/reading-now"),p=e("app/views/library/the-end-block");return n.ACTIONS=["sync","grc","dld","sus"],n._layout=function(e){this._classify(e.root,"screen-shelf-collation screen-shelf-summary"),this._layoutShelfStructure(e,"loans"),this._build("head .screen-shelf-summary-head",{extending:e,parentNode:e.intro,extensionClass:"screen-shelf-collation"}," heading <h1> {shelf.summary.head}"," nav <ul> .shelf-nav-list","  nav-loans <li> .shelf-nav-item","   nav-loans-link .shelf-nav-link",{link:"shelf/loans"},"    nav-loans-icon .shelf-nav-icon",{graphic:"shelf-nav-loans"},"    nav-loans-line .shelf-nav-line","     nav-loans-label <span> .shelf-nav-label {shelf.nav.loans}","     nav-loans-count <span> .shelf-nav-count","     nav-loans-chevron",o,"  nav-holds <li> .shelf-nav-item","   nav-holds-link .shelf-nav-link",{link:"shelf/holds"},"    nav-holds-icon .shelf-nav-icon",{graphic:"shelf-nav-holds"},"    nav-holds-line .shelf-nav-line","     nav-holds-label <span> .shelf-nav-label {shelf.nav.holds}","     nav-holds-count <span> .shelf-nav-count","     nav-holds-chevron",o,"  nav-timeline <li> .shelf-nav-item","   nav-timeline-link .shelf-nav-link",{link:"shelf/timeline/all,loans"},"    nav-timeline-icon .shelf-nav-icon",{graphic:"shelf-nav-timeline"},"    nav-timeline-line .shelf-nav-line","     nav-timeline-label <span> .shelf-nav-label {shelf.nav.activities}","     nav-timeline-chevron",o,"  nav-notifications <li> .shelf-nav-item","   nav-notifications-link .shelf-nav-link",{link:"shelf/notifications"},"    nav-notifications-icon .shelf-nav-icon",{graphic:"shelf-nav-notifications"},"    nav-notifications-line .shelf-nav-line","     nav-notifications-label <span> .shelf-nav-label {shelf.nav.notifications}","     nav-notifications-count <span> .shelf-nav-count","     nav-notifications-chevron",o),e.readingNow=new u,e.readingNow.impart(e.intro,"before"),this._readingNowTitle(APP.title),e.restoreListsButton=new h,e.restoreListsButton.become({keyPrefix:"shelf-summary"}),this._layoutBlocks(e)},n._layoutBlocks=function(e){e.restoreListsButton.reset(),this._.blockNames=this._.blockNames||[],t.each(this._.blockNames.splice(0),function(i){t.try(e["block"+t.capitalize(i)],"extract()")},this),this._.ntcSig=this._computeNTCSignature();var i=function(i,s,n){var o="extras"==i?"extras:"+this._.ntcSig:i;this._.blockNames.push(i);var l=e["block"+t.capitalize(i)];l?(l.impart(),this["_refresh"+t.capitalize(i)](l)):n instanceof r?(l=n,l.impart(e.list)):(l=new a(e.list),"string"==typeof n?l.become(n):"function"==typeof n&&n(l)),s&&(l.dom.strap.configure({circle:{icon:"block-strap-dismiss",spoken:"a11y.list.dismiss",button:function(t){e.restoreListsButton.dismissList(o,l,t.target)}.bind(this)}}),e.restoreListsButton.checkList(o)||l.extract()),e["block"+t.capitalize(i)]=l}.bind(this);i("extras",!0,function(e){e.become("shelf.summary.extras",{itemType:"extras-banner",itemClass:c})}),i("readyHolds",!1,"shelf.summary.ready-holds"),i("luckyDay",!0,"shelf.summary.lucky-day"),i("recentLoans",!0,"shelf.summary.recent-loans"),i("expiringLoans",!0,"shelf.summary.expiring-loans"),i("advisoryTitles",!0,"shelf.summary.advice"),i("loansWithProgress",!0,"shelf.summary.loans-with-progress"),i("otherLoans",!1,"shelf.summary.other-loans"),i("magazineRack",!0,new l)},n._listen=function(e,t){i.prototype._listen.apply(this,arguments),APP.events.on("notifications:update:all",this._onNotificationsUpdateAll.bind(this)),APP.events.on("patron:dismiss",this._onPatronDismiss.bind(this)),this._handle("title:switch"),this._handle("patron:choice"),this._handle("dismiss",t.restoreListsButton),this._handle("undismiss",t.restoreListsButton),t.header.actions(this.ACTIONS)},n._fillOut=function(e){this._computeNTCSignature()!=this._.ntcSig&&this._layoutBlocks(e),this._.usedIds=[],t.each(this._.blockNames,function(i){var s=e["block"+t.capitalize(i)];t.try(s,"_._extraction")||this["_refresh"+t.capitalize(i)](s)},this),this._textify(this.dom.navLoansCount,{number:APP.patron.loans.all.length}),this._textify(this.dom.navHoldsCount,{number:APP.patron.holds.all.length}),this._updateNotificationCount();var i=!0;t.each(this._.blockNames,function(s){var n=e["block"+t.capitalize(s)];n.isEmpty()||(i=!1,t.breakIteration())}),e.empty.toggle(i),e.finalBlock&&(e.finalBlock.extract(),delete e.finalBlock),i||(e.restoreListsButton._.dismissalKeys.length?e.finalBlock=e.restoreListsButton:e.finalBlock=new p,e.finalBlock.impart(e.pillar)),APP.imageDirector.recalculate()},n._onDismissRestoreListsButton=function(e){this._fillOut(this._prepare())},n._onUndismissRestoreListsButton=function(e){var t=this._prepare();this._layoutBlocks(t),this._fillOut(t)},n._refreshExtras=function(e){var t=APP.patron.extras.all.slice(0).sort(function(e,t){return t.createTime-e.createTime});e.refresh({possessions:t})},n._refreshReadyHolds=function(e){var t=["hold-borrow","hold-lucky-day"],i=APP.shelfAnalyst.cases(t),s=this._dedupe(i).sort(function(e,t){return e.createTime-t.createTime});e.refresh({titles:this._titlesFor(s),inclusions:["talker"],whispers:t})},n._refreshLuckyDay=function(e){var t=["loan-lucky-day"],i=this._dedupe(APP.shelfAnalyst.cases(t));i.sort(function(e,t){return e.createTime-t.createTime}),e.refresh({titles:this._titlesFor(i),whispers:t})},n._refreshRecentLoans=function(e){var t=["loan-recent"],i=APP.shelfAnalyst.cases(t);i.sort(function(e,t){return t.createTime-e.createTime}),i=this._dedupe(i,4),e.refresh({titles:this._titlesFor(i)})},n._refreshExpiringLoans=function(e){var t=["loan-extend"],i=this._dedupe(APP.shelfAnalyst.cases(t));i.sort(function(e,t){return e.expireTime-t.expireTime}),e.refresh({titles:this._titlesFor(i),whispers:t})},n._refreshAdvisoryTitles=function(e){var t=["loan-surplus","loan-cancel-holds","loan-finished","loan-waitlist"],i=APP.shelfAnalyst.cases(t);i=this._dedupe(i),e.refresh({titles:this._titlesFor(i),whispers:t})},n._refreshLoansWithProgress=function(e){var i=[];t.each(APP.patron.loans.all,function(e){e.journey.progress>=.01&&i.push(e)}),i.sort(function(e,t){return t.journey.progress-e.journey.progress}),i=this._dedupe(i,8),e.refresh({titles:this._titlesFor(i)})},n._refreshOtherLoans=function(e){var t=this._dedupe(APP.patron.loans.collate({sort:"due"}));e.refresh({titles:this._titlesFor(t)})},n._refreshOtherHolds=function(e){var t=this._dedupe(APP.patron.holds.collate({sort:"expected-next"}));e.refresh({titles:this._titlesFor(t),inclusions:["talker"]})},n._refreshMagazineRack=function(e){e.refresh()},n._onTitleSwitch=function(e){this._readingNowTitle(e.m.title)},n._onPatronChoice=function(e){"navigation:reading-now"==e.m.key&&this._readingNowTitle(APP.title)},n._dedupe=function(e,i,s){i=i||1/0;var n=[],r=this._.usedIds.slice(0);return t.each(e,function(e){if(e){var s="string"!=typeof e.title?e.title:e;r.indexOf(s.titleId)>=0||(r.push(s.titleId),n.push(e),n.length>=i&&t.breakIteration())}},this),(s||"undefined"==typeof s)&&(this._.usedIds=r),n},n._computeNTCSignature=function(){var e=t.compact(t.select(APP.patron.extras.all.slice(0).sort(function(e,t){return t.createTime-e.createTime}),function(e){return e.psnKey}));return e[0]},n._readingNowTitle=function(e){var t=this._prepare();e&&"shelf"==APP.patron.choice("navigation:reading-now")?(t.readingNow.impart(),t.readingNow.become(e)):t.readingNow.extract()},n._onNotificationsUpdateAll=function(e){this._updateNotificationCount()},n._onPatronDismiss=function(e){"notifications:seen"==t.try(e,"m.key")&&this._updateNotificationCount()},n._updateNotificationCount=function(){var e=APP.notifier.notifications.collate({titles:!0,dismissedAt:null,sort:"createdAt"}),t=this.dom.navNotificationsCount;if(e.length){var i=APP.patron.dismissedAt("notifications:seen")||0;this._textify(t,{number:e.length}),this._classify(t,"is-unseen",e[0].createdAt>i)}else this._textify(this.dom.navNotificationsCount)},s}),define("app/controllers/shelf/collation-controller",["require","common","app/controllers/train-controller"],function(e){var t=e("common"),i=e("app/controllers/train-controller"),s=i.new(),n=s.prototype;return n.configure=function(){this.realm=t.try(this.ancestor,"realm")||"shelf"},n.refine=function(e,t,i){return this.match(e.replace(/^ROLLBACK:/,""),t,i)},n.fill=function(){this._updateWaypointToArgs();var e=0;t.each(this.args.criteria,function(){e+=1}),e&&APP.patron.choose("shelf:criteria:"+this.args.state,this.args.criteria);var i={screenClass:this.args.screenClass};this.screen(i).become(this.args.collation,this.args.criteria),this._listenForCollationUpdate()},n.focus=function(){i.prototype.focus.apply(this,arguments),this._performPendingUpdate()},n._updateWaypointToArgs=function(){this.waypoint.configure({label:"shelf.nav."+this.args.state})},n._matchWithCriteria=function(e,i){if(i.state&&i.collation){var s=t.regExpEscape(i.state+(i.identifier?"/"+i.identifier:"")),n=e.match(new RegExp("^"+s+"(/([^/]*))?/?(.*)"));if(n){var r={head:i.state+(i.identifier?"/"+i.identifier:"")};this.args=t.absorb(i,{criteria:t.try(this.args,"criteria")});var o=n[2]||"";if(o.indexOf(",")<0&&o.match(/^\d+/)&&(o=""),this.args.criteria&&!o||(this.args.criteria=this._parseCriteria(this.args.state,this.args.collation,o),this.args.pins=[],this.args.pinScope=this.args.collation.ITEM_NAME,t.each(this.args.criteria,function(e,t){var i=APP.patron.pins.find({scope:this.args.pinScope,category:e});i&&(this.args.criteria[e]=i.value,this.args.pins.push(i))},this)),o||!n[3]&&t.try(this.args.pins,"length")){var a=this._criteriaToPathSegment(this.args.criteria);a&&(r.head+="/"+a),r.tail=n[3]}else r.tail=t.compact([n[1]||null,n[3]||null]).join("/")||void 0;return r}}},n._parseCriteria=function(e,i,s){var n={},r=i.criteria();if(t.each(r,function(e,t){n[e]=t[0]}),s){var o=s.split(/,/);t.each(r,function(e,t){var i=o.shift();t.indexOf(i)>=0&&(n[e]=i)})}return n},n._criteriaToPathSegment=function(e){var i=[];return t.each(this.args.criteria,function(e,t){i.push(t)}),i.join(",")},n._listenForCollationUpdate=function(){this._.updateHandler&&this.off(this._.updateHandler),this._.updateHandler=this.on(this.args.collation.ITEM_NAME+":update:all",this._onCollationUpdate.bind(this))},n._onCollationUpdate=function(){this._.pendingUpdate=!0,this._performPendingUpdate()},n._performPendingUpdate=function(){this._.pendingUpdate&&this._.hasFocus&&t.try(this,"args.collation")&&(t.defer(this,"performPendingUpdate",function(){return this._.hasFocus?void this.screen().become(this.args.collation,this.args.criteria):this._.pendingUpdate=!0}.bind(this),200),this._.pendingUpdate=!1)},s}),define("app/views/screens/shelf/screen-shelf-possessions",["require","common","./screen-shelf-collation","app/views/core/title-list","app/views/components/shelf/extras-banner"],function(e){var t=(e("common"),e("./screen-shelf-collation")),i=t.new(),s=i.prototype,n=e("app/views/core/title-list");return s.ACTIONS={loan:["sync","grc","dld"],hold:["sync","sus"]},s._layoutShelfList=function(t){this._classify(t.root,"screen-shelf-possessions");var i=[];"extras"==this.controller.args.state&&(i.push("extras-banner"),i.push(e("app/views/components/shelf/extras-banner"))),this._build("chain",{extending:t,parentNode:t.list,construct:n,with:i}).chain.claim(this).configure({theEndBlock:!0})},s._fillOut=function(e,t,i){this._textify(e.heading,"shelf.nav."+t.ITEM_NAME+"s"),e.header.actions(this.ACTIONS[t.type]),e.filterCloud.become(t,i);var s=t.collate(i);e.chain.populate({possessions:s,collation:t,inclusions:"hold"==t.ITEM_NAME?["talker"]:void 0}),e.empty.toggle(!s.length),APP.imageDirector.recalculate()},i}),define("app/views/screens/shelf/screen-possession-circ",["require","common","app/views/screens/library/screen-title-circ"],function(e){var t=e("common"),i=e("app/views/screens/library/screen-title-circ"),s=i.new(),n=s.prototype;return n.become=function(e,i){var s=this._prepare(),n=s.interview.become({fulfill:"circ/fulfill-loan",renew:"circ/renew-loan",return:"circ/return-loan",hold:"circ/hold-loan",borrow:"circ/borrow-hold",redeliver:"circ/redeliver-hold",suspend:"circ/suspend-hold",cancel:"circ/cancel-hold",open:"circ/open-extra"}[e.action],e,i).interview;this.title=t.try(n,"assignments.title"),t.try(n,"_setupStage()",s.stretch),this._colorizeScreen()},n._onTapTitleLink=function(){APP.nav.back(),APP.nav.go(this.title.path())},s}),define("app/controllers/shelf/possession-circ-controller",["require","common","app/controllers/train-controller","app/views/screens/shelf/screen-possession-circ"],function(e){var t=e("common"),i=e("app/controllers/train-controller"),s=i.new(),n=s.prototype;return n.SCREEN_CLASS=e("app/views/screens/shelf/screen-possession-circ"),n.configure=function(){this.realm=t.try(this.ancestor,"realm")||"shelf"},n.match=function(e,i,s){var n=e.match(/^([\w-]+)\/(fulfill|renew|return|hold|borrow|redeliver|suspend|cancel|open)$/);if(n)return this.args={},this.args.state=this.ancestor.args.state,this.args.psnType=(this.args.state||"").replace(/s$/,"")||"title",this.args.psnKey=n[1],this.args.action=n[2],this.args.parameters=t.queryStringToObject(i)||{},{head:this.args.psnKey+"/"+this.args.action+i}},n.fill=function(){this.screen().become({action:this.args.action,psnLongKey:this.args.psnType+"-"+this.args.psnKey},this.args.parameters)},n.focus=function(){i.prototype.focus.apply(this,arguments),APP.arena.dom.footer.lower()},n.blur=function(){i.prototype.blur.apply(this,arguments),APP.arena.dom.footer.raise()},s}),define("app/controllers/shelf/loans-controller",["require","common","./collation-controller","app/views/screens/shelf/screen-shelf-possessions","./possession-circ-controller"],function(e){var t=(e("common"),e("./collation-controller")),i=t.new(),s=i.prototype;return s.SCREEN_CLASS=e("app/views/screens/shelf/screen-shelf-possessions"),s.SUB_CONTROLLERS=[e("./possession-circ-controller")],s.match=function(e){return this._matchWithCriteria(e,{state:"loans",collation:APP.patron.loans})},s._listenForCollationUpdate=function(){t.prototype._listenForCollationUpdate.call(this),this._.networkHandler=this._.networkHandler||this.on("network:info",this._onCollationUpdate.bind(this)),this._.fftHandler=this._.fftHandler||this.on("patron:choice",function(e){0==e.m.key.indexOf("fulfillment:")&&this._onCollationUpdate()}.bind(this))},i}),define("app/controllers/shelf/holds-controller",["require","common","./collation-controller","app/views/screens/shelf/screen-shelf-possessions","./possession-circ-controller"],function(e){var t=(e("common"),e("./collation-controller")),i=t.new(),s=i.prototype;return s.SCREEN_CLASS=e("app/views/screens/shelf/screen-shelf-possessions"),s.SUB_CONTROLLERS=[e("./possession-circ-controller")],s.match=function(e){return this._matchWithCriteria(e,{state:"holds",collation:APP.patron.holds})},i}),define("app/controllers/shelf/extras-controller",["require","common","./collation-controller","app/views/screens/shelf/screen-shelf-possessions","./possession-circ-controller"],function(e){
var t=(e("common"),e("./collation-controller")),i=t.new(),s=i.prototype;return s.SCREEN_CLASS=e("app/views/screens/shelf/screen-shelf-possessions"),s.SUB_CONTROLLERS=[e("./possession-circ-controller")],s.match=function(e){return this._matchWithCriteria(e,{state:"extras",collation:APP.patron.extras})},i}),define("app/views/shelf/activity-plank",["require","common","app/views/core/title-plank","app/views/shelf/journey-timeline","shibui/src/components/chevron"],function(e){var t=e("common"),i=e("app/views/core/title-plank"),s=i.new(),n=s.prototype,r=e("app/views/shelf/journey-timeline"),o=e("shibui/src/components/chevron");return n.become=function(e,s){return this.act=e,s=t.absorb(s,{library:e.library,provenance:"shelf"}),s.library&&APP.libraries.paintColors(s.library,this._prepare().root),i.prototype.become.call(this,e.title,s)},n._layout=function(){i.prototype._layout.apply(this,arguments),this._classify(this.dom.root,"activity-plank"),this.dom.expando=this._element({button:this._onTapExpando.bind(this),parentNode:this.dom.gutter,classes:"activity-plank-expando","aria-expanded":"false"}),this.dom.expandoDate=this._element({tag:"time",parentNode:this.dom.expando,classes:"activity-plank-expando-date journey-timeline-calendar"}),this.dom.expandoArrow=new o(this.dom.expando).bearing("s"),this.dom.activities=this._element({parentNode:this.dom.flexCol,classes:"activity-plank-activities"})},n._specify=function(e,s){var n=i.prototype._specify.call(this,e,s);return this.act&&(n.journey=[this.act.createTime,this.act.action],"manual"==t.try(this.act,"meta.mode")?n.journey.push("manual"):n.journey.push(this.act.humanDuration())),this.title.acts.use(function(e,t){return e.isIdeal?void(n.timeline=t.all.length):t.reuse(this.refresh,this)},this),n},n._executeSpecification=function(e,s,n,r){var o=i.prototype._executeSpecification.apply(this,arguments);if(this._differs(s,"journey"))if(t.isList(s.journey)&&3==s.journey.length){var a=s.journey[1],l=s.journey[2];if(l&&"manual"!=l)this._textify(this.dom.journey,{label:"journey.timeline.act."+a+".with-time",substitutions:{META_TIME:l}});else{var c="journey.timeline.act."+a;l&&(c+="."+l),this._textify(this.dom.journey,c)}var h=new Date(s.journey[0]);this.dom.expandoDate.setAttribute("datetime",h.toISOString()),this._textify(this.dom.expandoDate,{date:h,month:void 0,year:void 0});var u=this._element({tag:"strong",parentNode:this.dom.expandoDate,html:this._phrase({date:h,day:void 0,month:"short",year:h.getFullYear()!=(new Date).getFullYear()?"2-digit":void 0})});SPARK.locale.isEnglish&&(u.innerHTML=u.innerHTML.replace(/ (\d\d)$/," '$1")),this._textify(this.dom.expandoDate,{spoken:{html:this._phrase({date:h})},visual:{html:this.dom.expandoDate.innerHTML}}),this._linkify(e.journey,this._linkTo("journey"))}else this._textify(this.dom.journey),this._textify(this.dom.expandoDate),this.dom.expandoDate.removeAttribute("datetime");return this._differs(s,"timeline")&&(this._textify(this.dom.expando,{spoken:{label:"a11y.timeline.acts.count",substitutions:{ACTS:s.timeline}}}),this.dom.timeline&&(this.dom.timeline.extract(),delete this.dom.timeline)),o},n._onTapExpando=function(){if(this.dom.root.classList.contains("is-expanded"))this.dom.expandoArrow.bearing("s"),this._attr(this.dom.expando,"aria-expanded","false"),this._declassify(this.dom.root,"is-expanded");else{if(!this.dom.timeline){var e=this.title.acts.all.slice(0).reverse();this.dom.timeline=new r(this.dom.activities),this.dom.timeline.become(this.title.journey(),e)}this.dom.expandoArrow.bearing("n"),this._attr(this.dom.expando,"aria-expanded","true"),this._classify(this.dom.root,"is-expanded")}},s}),define("app/views/components/shelf/history-migration-status",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.refresh=function(){var e=t.try(APP.summoner,"daemons.historyMigration.pollTask");return e?(this.undismiss(),void this._switchToState(e.announced||"migrating",e)):this.dismiss()},n.dismiss=function(){this.extract(),APP.events.off(this._.undismissHandler),this._.undismissHandler=APP.events.on("history:migration:progress",function(){APP.router.route==this.route&&this.undismiss()}.bind(this))},n.undismiss=function(){APP.events.off(this._.undismissHandler),this._switchToState("migrating"),this.impart()},n._layout=function(e){this._build("history-migration-status",{extending:e}," flex","  label <label>",{for:"history-migration-status-progress"},"   task <span>","   counts <em>","  controls","   cancel",{button:!0,label:"cancel"},"   dismiss",{button:!0,label:"history-migration-status.dismiss"}," advice <p>"," progress <progress> #history-migration-status-progress")},n._listen=function(e){this.route=APP.router.route,this._handle("history:migration:progress"),this._handle("history:migration:pause"),this._handle("history:migration:complete")},n._onHistoryMigrationProgress=function(e){this._switchToState("migrating",e.m.task)},n._onHistoryMigrationPause=function(e){this._switchToState("pause",e.m.task)},n._onHistoryMigrationComplete=function(e){this._switchToState("complete",e.m.task)},n._onTapCancel=function(e){APP.summoner.daemons.historyMigration.cancelPolling(),this._switchToState("canceled")},n._onTapDismiss=function(e){this.dismiss()},n._switchToState=function(e,i){var s,n,r,o=t.try(i,"progress.percent");if("migrating"==e)if(s={label:"history-migration-status.task.card",substitutions:{CARD_NAME:t.try(i,"job.card.safeName()")}},s.substitutions.CARD_NAME){var a=t.try(i,"job.progress")||{};n={label:"history-migration-status.counts",substitutions:{DONE:a.done,TOTAL:a.total}}}else s.label="history-migration-status.task.commence",o=null;else"pause"==e?s={label:"history-migration-status.task.paused"}:"complete"==e?(s={label:"history-migration-status.complete",substitutions:{ADDED:t.try(i,"progress.added")}},o=1):"canceled"==e&&(s={label:"history-migration-status.canceled"},r={label:"history-migration-status.retry"},o=null);this._semaphore("state",e),this._textify(this.dom.task,s),this._textify(this.dom.counts,n),this._textify(this.dom.advice,r),"undefined"!=typeof o&&this._attr(this.dom.progress,"value",o)},s}),define("app/views/screens/shelf/screen-shelf-timeline",["require","common","app/views/screens/shelf/screen-shelf-collation","app/views/popovers/popover-export","app/views/core/dynamic-list","app/views/core/block-strap","app/views/shelf/activity-plank","app/views/core/title-list","app/views/shelf/collation-empty-state","app/views/components/filters/filter-line-graph","app/views/components/filters/filter-line-graph-with-ranges","app/views/components/shelf/history-migration-status"],function(e){var t=e("common"),i=e("app/views/screens/shelf/screen-shelf-collation"),s=i.new(),n=s.prototype,r=e("app/views/popovers/popover-export"),o=e("app/views/core/dynamic-list"),a=e("app/views/core/block-strap"),l=e("app/views/shelf/activity-plank"),c=e("app/views/core/title-list"),h=(e("app/views/shelf/collation-empty-state"),e("app/views/components/filters/filter-line-graph")),u=e("app/views/components/filters/filter-line-graph-with-ranges"),p=e("app/views/components/shelf/history-migration-status");return n.become=function(e,t){this.collation=e,this.criteria=t,this.activities=this.collation.collate(this.criteria),this._fillOut(this._prepare(),this.collation,this.criteria)},n._layoutShelfList=function(e){this._classify(e.root,"screen-shelf-timeline"),e.viz=this._element({classes:"screen-shelf-timeline-viz"}),e.prompts=this._element({classes:"screen-shelf-timeline-prompts"}),e.toggles=this._element({classes:"screen-shelf-timeline-toggles",parentNode:e.prompts}),e.migrationStatus=new p(e.prompts),e.list.parentNode.insertBefore(e.viz,e.list),e.list.parentNode.insertBefore(e.prompts,e.list),e.chain=new o(e.list),e.chain.claim(this),e.chain.configure({itemFactory:this._addActivityPeriod.bind(this),itemSignature:this._activityPeriodSignature.bind(this),blockSize:1,theEndBlock:!0}),e.chain.SCROLL_DELAY_MS=400,e.migrationStatus.refresh()},n._fillOut=function(e,t,i){e.header.actions(this._optionsForActionsButton()),this._textify(e.heading,"footer.nav.timeline"),this._fillOutToggles(e),e.filterCloud.become(t,i,{only:{act:["loans","holds"]}}),this._classify(e.filterCloud.dom.root,"hide",!this.collation.all.length),this._fillOutViz(this.dom.viz),this._.usedIds=[],this.periods=this._activityPeriods(this.activities);for(var s=this.periods.slice(0);s.length&&s[0].month>(this.controller.args.month||1/0);)s.shift();e.chain.reset(),e.chain.populate(s)},n._fillOutToggles=function(e){var t=this.collation.isRecordingPaused();t?e.toggles.children.length||this._element({tag:"p",parentNode:e.toggles,label:"shelf.activities.recording-paused",enliven:{"#enable":this._toggleActivityRecording.bind(this,!0)}}):this._textify(e.toggles),e.empty.toggle(!this.activities.length&&!t)},n._activityPeriods=function(e){var i={},s=[];return t.each(e,function(e){if(e.title&&e.createTime){var t=this._activityPeriodSignatureForAct(e),n=i[t];n||(n={month:e.createTime,signature:t,acts:[]},i[t]=n,s.push(n)),n.acts.push(e)}},this),s.sort(function(e,t){return t.signature-e.signature})},n._activityPeriodSignatureForAct=function(e){var t=new Date(e.createTime),i=""+(t.getMonth()+1);return i.length<2&&(i="0"+i),t.getFullYear()+"-"+i},n._activityPeriodSignature=function(e){return e.signature},n._addActivityPeriod=function(e){var i=[];if(t.each(e.acts,function(e){t.among(e.title.titleId,this._.usedIds)||(i.push(e),this._.usedIds.push(e.title.titleId))},this),!i.length)return this._element();var s=this._element({classes:"activity-period","data-activities-period":e.signature}),n=new a(s);n.configure({text:{html:this._timestampToMonthAndYear(e.month),button:this._onTapJumpButton.bind(this)},circle:{icon:"block-strap-jump",button:this._onTapJumpButton.bind(this),spoken:"a11y.timeline.jump"}});var r=new c(s,"plank",l).claim(this);return r.configure({itemFactory:function(e){return(new l).become(e)},itemSignature:function(e){return e.title.titleId},itemDelete:this._deleteActsForItem.bind(this)}),r._itemsFromOptions=function(e){return e},r.populate(i),s},n._onTapJumpButton=function(e){APP.arena.popover(e.target).choices(function(e,i){t.each(this.periods,function(t){e.choice({html:this._timestampToMonthAndYear(t.month),button:function(){delete this.collation.subPathForCriteria,APP.nav.go([this.collation.pathWithCriteria(this.controller.args.criteria),t.signature].join(","))}.bind(this)})},this)}.bind(this))},n._timestampToMonthAndYear=function(e){return this._phrase({date:e,day:void 0,month:"long"})},n._optionsForActionsButton=function(){var e=["sync"],i=this.activities&&this.activities.length>0;return e.push({label:"action.activities.export",classes:i?null:"subtle",button:this._onTapActionsExport.bind(this,i)}),e.push({label:"action.activities.history-migrate",button:this._onTapActionsMigrate.bind(this)}),this.collation.isRecordingPaused()?e.push({label:"action.activities.resume-recording",button:this._onTapActionsResumeRecording.bind(this)}):e.push({label:"action.activities.pause-recording",button:this._onTapActionsPauseRecording.bind(this)}),e.push({label:"action.activities.clear-timeline",button:this._onTapActionsClearTimeline.bind(this)}),function(){var i=APP.summoner.daemons.historyMigration.evaluateCards(),s=(t.try(i,"eligible.length")||0)>0;return e[2].classes=s?void 0:"subtle",e}},n._onTapActionsExport=function(e){if(e){var t="libbytimeline-"+this.controller.path.replace(/.*\//,"");t=t.replace(",","-");var i=this.activities.slice(0);for(this.controller.args.month||i.createTime;i[0].createTime>=this.controller.args.month;)i.shift();(new r).become(t,{activities:i,count:i.length}).present()}else APP.arena.popover().notice({label:"action.export.list.empty"})},n._onTapActionsMigrate=function(){APP.interviews.dialog("interview/configure/history-migrate").present({springs:[.75],constrainToContentHeight:!1})},n._onTapActionsPauseRecording=function(e){this._confirmAction("shelf.activities.pause-recording",this._onConfirmPauseRecording.bind(this))},n._onConfirmPauseRecording=function(){this._toggleActivityRecording(!1)},n._onTapActionsResumeRecording=function(e){this._toggleActivityRecording(!0)},n._onTapActionsClearTimeline=function(e){this._confirmAction("shelf.activities.clear-timeline",this._onConfirmClearTimeline.bind(this))},n._onConfirmClearTimeline=function(){this.collation.wipe(),APP.events.dispatch("activities:actions:wipe")},n._confirmAction=function(e,t){APP.arena.popover().confirm({warningLabel:[{label:e+".warning"},{label:"shelf.activities.privacy",enliven:{"#privacy":APP.shell.bindOpenURL(APP.constants.URLS.privacy)}}],buttonLabel:e+".confirm",onSubmit:t})},n._toggleActivityRecording=function(e){e?this.collation.resumeRecording():this.collation.pauseRecording();var t=this._prepare();this._fillOutToggles(t),t.header.actions(this._optionsForActionsButton())},n._deleteActsForItem=function(e){var i=e.title;i.acts.use(function(e,s){return e.isIdeal?(t.each(s.all,function(e){e.collation.removeItem(e)}),void(i.acts.all=[])):s.reuse()},this)},n._fillOutViz=function(e){var t=APP.patron.activities._.creationYears.slice().sort()[0],i=(new Date).getFullYear()+"";t?t==i?this._fillOutVizForYear(e):this._fillOutVizForYears(e):this._emptyElement(e)},n._fillOutVizForYear=function(e){var i=[],s=[],n=this.activities||[];if(t.try(n[0],"createTime")){for(var r=new Date(n[0].createTime),o=r.getFullYear(),a=r.getMonth(),l=0;l<12;++l)i.push({html:this._phrase({date:new Date(0,l),day:void 0,month:"narrow",year:void 0})}),s.push(l>a?-1:0);t.each(n,function(e){if(t.try(e,"creation.month")){var i=parseFloat(e.creation.month);s[i]=(s[i]||0)+1}});var c=this._findViewWithin(e,h);return c||(c=new h(this._emptyElement(e)),c.configure({width:280,aspectRatio:.4,heading:{label:"filter.timeline.activity-in-year",substitutions:{YEAR:o}},labels:i})),c.become(s),c}},n._fillOutVizForYears=function(e){var i=new Map,s=new Date,n=t.absorb(this.criteria,{});this._.appliedYear=t.excise(n,"year"),"all"==this._.appliedYear&&delete this._.appliedYear;var r=APP.patron.activities.collate(n),o=APP.patron.activities._.creationYears.slice().sort();t.each(o,function(e){for(var t=parseFloat(e),n=t==s.getFullYear()?s.getMonth():12,r={value:e,isApplied:e==this._.appliedYear,scores:[],totalScore:0},o=0;o<12;++o)r.scores.push(o>n?-1:0);i.set(e,r)},this),t.each(r,function(e){if(e.creation){var t=i.get(e.creation.year);t&&(t.scores[parseFloat(e.creation.month)]+=1,t.totalScore+=1)}},this);var a=this._.appliedYear?"smooth":null,l=this._findViewWithin(e,u);l||(a="instant",l=new u(this._emptyElement(e)),l.configure({height:120,heading:{label:"filter.timeline.activity-by-year"},rangeWidth:Math.max(200,(Math.min(window.innerWidth,1366)-48)/o.length),onSelectRange:function(e){APP.haptics.select();var i=t.absorb({year:e==this._.appliedYear?"all":e},t.absorb(this.criteria,{}));APP.nav.go(this.collation.pathWithCriteria(i))}.bind(this)})),l.become(i),this._defer("graph-scroll",function(){a&&l.scrollTo(["applied","end"],a)})},s}),define("app/controllers/shelf/timeline-controller",["require","common","app/controllers/shelf/collation-controller","app/views/screens/shelf/screen-shelf-timeline"],function(e){var t=e("common"),i=e("app/controllers/shelf/collation-controller"),s=i.new(),n=s.prototype;return n.SCREEN_CLASS=e("app/views/screens/shelf/screen-shelf-timeline"),n.configure=function(){this.realm="shelf",this.waypoint.configure({label:"footer.nav.timeline"})},n.match=function(e){var t=this._matchWithCriteria(e.replace(/^timeline/,"activities"),{state:"activities",collation:APP.patron.activities});if(t){var i=e.match(/,([\d]+-[\d]+)/);if(i){var s=i[1],n=this._stringToEndOfMonth(s);if(n){var r=this.args.criteria.year||"all";"all"!=r&&""+n.getFullYear()!=""+r||(this.args.month=n.getTime(),this.args.collation.subPathForCriteria=s,t.head+=i[0])}}return this.args.month||delete this.args.collation.subPathForCriteria,t.head=t.head.replace(/^activities/,"timeline"),t}},n._updateWaypointToArgs=function(){},n._listenForCollationUpdate=function(){this._handle("activity:update:all",function(){this._.pendingUpdate=!0}.bind(this)),this._handle("history:migration:complete",function(e){t.try(e,"m.task.progress.added")&&(this._.pendingUpdate=!0,this._performPendingUpdate())}.bind(this)),this._handle("history:migration:abort",this._onCollationUpdate.bind(this)),this._handle("activities:actions:wipe",this._onCollationUpdate.bind(this))},n._handle=function(e,t){this._.handlers=this._.handlers||{},APP.events.off(this._.handlers[e]),APP.events.on(e,t)},n._stringToEndOfMonth=function(e){if("string"==typeof e){var t=e.split("-"),i=parseFloat(t[0]),s=parseFloat(t[1]);if(!(!i||!s||i<2015||s>12)){var n=new Date(i,s,0);return n.setHours(24,0,0,0),new Date(n.getTime()+60*n.getTimezoneOffset()*1e3-1)}}},s}),define("app/views/screens/shelf/screen-shelf-notifications",["require","common","app/views/screens/shelf/screen-shelf-collation","app/views/popovers/popover-export","app/views/core/dynamic-list","app/views/core/block-strap","app/views/components/shelf/notice-plank","app/views/shelf/collation-empty-state"],function(e){var t=e("common"),i=e("app/views/screens/shelf/screen-shelf-collation"),s=i.new(),n=s.prototype,r=(e("app/views/popovers/popover-export"),e("app/views/core/dynamic-list")),o=e("app/views/core/block-strap"),a=e("app/views/components/shelf/notice-plank");e("app/views/shelf/collation-empty-state");return n.become=function(e,i){this.collation=e;var s={titles:!0,dismissedAt:null,sort:"createdAt"};this.criteria=t.absorb(s,t.absorb(i,{})),this.notifications=this.collation.collate(this.criteria),this._fillOut(this._prepare(),this.collation,this.criteria),APP.patron.dismiss("notifications:seen",{overwrite:!0})},n._layoutShelfList=function(e){this._classify(e.root,"screen-shelf-notifications"),this._build("chain",{extending:e,parentNode:e.list,construct:r}),e.chain.claim(this),e.chain.configure({itemFactory:this._addPeriod.bind(this),itemSignature:function(e){return e.signature},blockSize:1,theEndBlock:!0}),e.chain.SCROLL_DELAY_MS=400},n._listen=function(e,t){i.prototype._listen.apply(this,arguments),this._handle("notification:dismiss")},n._fillOut=function(e,t,i){e.header.actions(this._optionsForActionsButton()),this._textify(e.heading,"shelf.nav.notifications"),e.filterCloud.become(t,i),this._classify(e.filterCloud.dom.root,"hide",!this.collation.all.length),this._.usedIds=[],this.periods=this._periods(this.notifications);for(var s=this.periods.slice(0);s.length&&s[0].month>(this.controller.args.month||1/0);)s.shift();e.chain.reset(),e.chain.populate(s)},n._periods=function(e){var i={},s=[];return t.each(e,function(e){if(e.createdAt){var t=this._periodSignatureForNotification(e),n=i[t];n||(n={month:e.createdAt,signature:t,items:[]},i[t]=n,s.push(n)),n.items.push(e)}},this),s.sort(function(e,t){return t.signature-e.signature})},n._periodSignatureForNotification=function(e){var t=new Date(e.createdAt),i=""+(t.getMonth()+1);return i.length<2&&(i="0"+i),t.getFullYear()+"-"+i},n._addPeriod=function(e){var t=this._element({classes:"notifications-period","data-notifications-period":e.signature}),i=new o(t);i.configure({text:{html:this._timestampToMonthAndYear(e.month),button:this._onTapJumpButton.bind(this)},circle:{icon:"block-strap-dismiss",button:this._onTapDismissPeriodButton.bind(this,e),spoken:"a11y.list.dismiss"}});var s=new r(t,"plank",a).claim(this);return s.configure({itemFactory:function(e){return(new a).become(e,{linkFirstRow:!0})},itemSignature:function(e){return[e.id,e.createdAt].join("-")},itemDelete:this._itemDelete.bind(this),itemRailActions:[{icon:"notif-pin",spoken:"notice-actions.pin",button:function(e,t){e.toggleVanishing(),t.refresh()},retain:!0},{icon:"notif-dismiss",spoken:"notice-actions.dismiss"}]}),s.populate(e.items),t},n._itemDelete=function(e){e.dismiss()},n._onNotificationDismiss=function(e){this._.dBatch=this._.dBatch||[],this._.dBatch.push(e.m.notification),this._defer("repop",function(){var e=t.excise(this._,"dBatch"),i=t.select(this.dom.chain.dom.root.querySelectorAll(".chaining-list"),function(e){return e._view});t.each(i,function(t,i){t.unpopulate(e),t._.population.length||this.dom.chain.unpopulate(this.dom.chain._.population[i])},this),this.dom.filterCloud.refresh()}.bind(this),200)},n._onTapJumpButton=function(e){APP.arena.popover(e.target).choices(function(e,i){t.each(this.periods,function(t){e.choice({html:this._timestampToMonthAndYear(t.month),button:function(){delete this.collation.subPathForCriteria,APP.nav.go([this.collation.pathWithCriteria(this.controller.args.criteria),t.signature].join(","))}.bind(this)})},this)}.bind(this))},n._onTapDismissPeriodButton=function(e,i){APP.arena.popover(i.target).confirm({warningLabel:"notice-actions.dismiss.month",buttonLabel:"list.confirm-dismiss.proceed",onSubmit:function(){t.each(e.items,function(e){"pin"!=e.vanishAt&&e.dismiss()})}})},n._timestampToMonthAndYear=function(e){return this._phrase({date:e,day:void 0,month:"long"})},n._optionsForActionsButton=function(){return["sync",{label:"notice-actions.dismiss.group",button:this._onTapDismissNotifications.bind(this),classes:this.notifications.length?"danger":"subtle"}]},n._onTapDismissNotifications=function(e){t.each(this.notifications,function(e){"pin"!=e.vanishAt&&e.dismiss()}),this.become(this.collation,this.criteria)},s}),define("app/controllers/shelf/notifications-controller",["require","common","app/controllers/shelf/collation-controller","app/views/screens/shelf/screen-shelf-notifications"],function(e){var t=(e("common"),e("app/controllers/shelf/collation-controller")),i=t.new(),s=i.prototype;return s.SCREEN_CLASS=e("app/views/screens/shelf/screen-shelf-notifications"),s.configure=function(){this.realm="shelf",this.waypoint.configure({label:"shelf.nav.notifications"})},s.match=function(e){var t=e.match(/^notifications\/?(.*)/);if(t){this.args={state:"notifications",collation:APP.notifier.notifications};var i=this._matchWithCriteria("notifications/"+t[1],this.args);if(this.args.criteria=this.args.criteria||{},i){var s=t[1].match(/,([\d]+-[\d]+)/);if(s){var n=s[1],r=this._stringToEndOfMonth(n);if(r){var o=this.args.criteria.year||"all";"all"!=o&&""+r.getFullYear()!=""+o||(this.args.month=r.getTime(),this.args.collation.subPathForCriteria=n,i.head+=s[0])}}return this.args.month||delete this.args.collation.subPathForCriteria,i}return{head:"notifications",tail:t[1]}}},s._updateWaypointToArgs=function(){},s._onCollationUpdate=function(){this._.pendingUpdate=!0},s._stringToEndOfMonth=function(e){if("string"==typeof e){var t=e.split("-"),i=parseFloat(t[0]),s=parseFloat(t[1]);if(!(!i||!s||i<2015||s>12)){var n=new Date(i,s,0);return n.setHours(24,0,0,0),new Date(n.getTime()+60*n.getTimezoneOffset()*1e3-1)}}},i}),define("app/controllers/shelf/summary-controller",["require","common","app/controllers/train-controller","app/views/screens/shelf/screen-shelf-summary","app/controllers/shelf/loans-controller","app/controllers/shelf/holds-controller","app/controllers/shelf/extras-controller","app/controllers/shelf/journey-controller","app/controllers/shelf/timeline-controller","app/controllers/shelf/notifications-controller","app/controllers/library/newsstand-controller","app/controllers/library/list-controller"],function(e){var t=(e("common"),e("app/controllers/train-controller")),i=t.new(),s=i.prototype;return s.SCREEN_CLASS=e("app/views/screens/shelf/screen-shelf-summary"),s.SUB_CONTROLLERS=[e("app/controllers/shelf/loans-controller"),e("app/controllers/shelf/holds-controller"),e("app/controllers/shelf/extras-controller"),e("app/controllers/shelf/journey-controller"),e("app/controllers/shelf/timeline-controller"),e("app/controllers/shelf/notifications-controller"),e("app/controllers/library/newsstand-controller"),e("app/controllers/library/list-controller")],s.configure=function(){this.realm="shelf",this.historical=!0,this.root=!0,this.waypoint.configure({label:"crumb.shelf"})},s.match=function(e){var t=e.match(/^shelf\/?(.*)/);if(t)return{head:"shelf",tail:t[1]}},s.enter=function(){this.screen(),this.on("loan:add",this._onChanges.bind(this,0)),this.on("loan:remove",this._onChanges.bind(this,0)),this.on("loan:update:all",this._onChanges.bind(this,1e3)),this.on("hold:update:all",this._onChanges.bind(this,1e3)),this.on("extra:update:all",this._onChanges.bind(this,1e3)),this.on("tag:update:all",this._onChanges.bind(this,300)),this.on("title:switch",this._onChanges.bind(this,300)),this.on("network:info",this._onChanges.bind(this,2e3)),this.on("patron:choice",this._onChanges.bind(this,100))},s.usher=function(){APP.arena.raise(this.realm),APP.arena.dom.footer.raise(this.realm)},s.fill=function(){this.screen().become()},s.focus=function(){t.prototype.focus.apply(this,arguments),this._performPendingUpdate(0)},s._onChanges=function(e){this._.pendingUpdate=!0,this._performPendingUpdate(e)},s._performPendingUpdate=function(e){this._.pendingUpdate&&this._.hasFocus&&(clearTimeout(this._.screenUpdateTimer),this._.screenUpdateTimer=setTimeout(this.fill.bind(this),e||0),this._.pendingUpdate=!1)},i}),define("app/views/screens/tags/screen-tags-list",["require","common","../shelf/screen-shelf-collation","app/views/core/dynamic-list","app/views/components/tags/tag-plank","app/views/components/interviews/interview-block","app/views/components/common/tutorial-balloon"],function(e){var t=(e("common"),e("../shelf/screen-shelf-collation")),i=t.new(),s=i.prototype,n=e("app/views/core/dynamic-list"),r=e("app/views/components/tags/tag-plank"),o=e("app/views/components/interviews/interview-block"),a=e("app/views/components/common/tutorial-balloon");return s._layoutShelfList=function(e){this._classify(e.root,"screen-tags-list"),e.prompt=this._element({parentNode:e.list,classes:"screen-tags-list-prompt"}),this._build("chain",{extending:e,parentNode:e.list,construct:n}).chain.claim(this).configure({itemFactory:this._addTagPlank.bind(this),itemRefresh:this._refreshTagPlank.bind(this),itemSignature:function(e){return e.uuid}})},s._fillOut=function(e,t,i){if(this._textify(e.heading,"shelf.nav.tags"),e.header.actions(["sync",{label:"action.tags.explain",button:this._onTapActionsExplainTags.bind(this)},{label:"tag.add.new-tag",classes:"screen-tags-list-new",button:this._onTapActionsNewTag.bind(this)}]),e.filterCloud.become(t,i),this._classify(e.filterCloud.dom.root,"hide",!APP.patron.tags.all.length),this._textify(this.dom.prompt),APP.patron.tags.requiresTutorial()){this.dom.interview=new o(this.dom.prompt),this.dom.interview.become("tutorial/what-are-tags");var s=new a;s.attach(this.dom.prompt.querySelector(".interview-answers"),"large"),s.whenDismissed("tutorial:what-are-tags","release")}e.chain.populate(t.collate(i))},s._addTagPlank=function(e){var t=this._build("screen-tags-list-item"," link",{link:e.path(),access:{role:"button"}},"  plank",r);return t.plank.become(e,{describe:"always"}),t.root},s._refreshTagPlank=function(e,t){this._linkify(e.firstChild,t.path());var i=this._findViewWithin(e,r);i&&i.refresh()},s._onTapActionsExplainTags=function(){APP.interviews.dialog("tutorial/creating-tags").present()},s._onTapActionsNewTag=function(){APP.interviews.dialog("configure/tag-name").present()},i}),define("app/views/screens/tags/screen-tags-tag",["require","common","../shelf/screen-shelf-collation","app/views/core/tag-line","app/views/components/filters/filter-cloud-for-collation","app/views/core/title-list","app/views/popovers/popover-export","app/views/components/interviews/interview-block"],function(e){var t=e("common"),i=e("../shelf/screen-shelf-collation"),s=i.new(),n=s.prototype,r=e("app/views/core/tag-line"),o=e("app/views/components/filters/filter-cloud-for-collation"),a=e("app/views/core/title-list"),l=e("app/views/popovers/popover-export"),c=e("app/views/components/interviews/interview-block");return n.become=function(e,t){this.tag=e,this.criteria=t,this._fillOut(this._prepare())},n._layoutShelfHead=function(e){this._classify(e.root,"screen-tags-tag"),this._build("head .screen-shelf-collation-head",{extending:e,parentNode:e.intro,extensionClass:"screen-tags-tag"}," tag-renamer",{button:!0},"  tag-line",r),this._build("description",{extending:e,parentNode:e.intro,extensionClass:"screen-tags-tag"}),this._build("smarts <h2>",{extending:e,parentNode:e.intro,extensionClass:"screen-tags-tag"}," behavior <span> {tag.behavior.regular}",{wrapper:!1}," behavior-button <span> {tag.behavior.change}",{button:!0,wrapper:!1}," behavior-details <p> {tag.behavior.regular.details}",{wrapper:!1}),this._build("prompt",{extending:e,parentNode:e.intro,extensionClass:"screen-tags-tag"}),this._build("filter-cloud",{construct:o,extending:e,parentNode:e.intro})},n._layoutShelfList=function(e){this._build("chain",{extending:e,parentNode:e.list,construct:a,with:"plank"}).chain.claim(this).configure({itemSignature:this._itemSignature.bind(this),itemDelete:this._itemDelete.bind(this),pageFactory:this._pageFactory.bind(this)})},n._listen=function(e,t){i.prototype._listen.apply(this,arguments),this._handle("tag:update:all"),this._handle("tagging:add"),this._handle("tagging:remove")},n._onTagUpdateAll=function(){this.tag&&this.isInDocument()&&this._fillOutHead(this._prepare(),this.tag)},n._onTaggingAdd=function(e){e.m.item.collation==this.tag&&(APP.journal.debug("onTaggingAdd",e.m),this._defer("repop",function(e){t.try(e,"populate()")}.bind(this,this.dom.chain),200))},n._onTaggingRemove=function(e){e.m.item.collation==this.tag&&this._defer("repop",function(i){t.try(i,"unpopulate()",e.m.item)}.bind(this,this.dom.chain),200)},n._fillOut=function(e){this._fillOutHead(e),this._defer("repop",function(e){t.try(e,"populate()")}.bind(this,e.chain),200),APP.imageDirector.recalculate()},n._fillOutHead=function(e){e.header.actions([{label:"action.tag.rename",classes:"screen-tags-tag-rename",button:this._onTapActionsRename.bind(this)},{label:"action.tag.export",classes:"screen-tags-tag-export",button:this._onTapActionsExport.bind(this)},{label:"action.tag.delete",classes:"screen-tags-tag-delete danger",button:this._onTapActionsDelete.bind(this)}]),e.tagLine.become(this.tag),this._textify(e.description,{html:t.safe(this.tag.description||"")}),this.tag.behavior?(this._textify(e.behavior,{label:"tag.behavior.smart."+this.tag.behavior.key,wrapper:!1}),this._textify(e.behaviorDetails,{label:"tag.behavior.smart."+this.tag.behavior.key+".details",wrapper:!1})):(this._textify(e.behavior,{label:"tag.behavior.regular",wrapper:!1}),this._textify(e.behaviorDetails,{label:"tag.behavior.regular.details",wrapper:!1})),"borrowed"==t.try(this.tag,"behavior.key")&&this.tag.behavior.withImportableActivities(function(t){if(!t.length)return this.tag.behavior.markAllActivitiesImported();var i=this.controller.args,s=this.tag.totalTaggings,n=new c(this._emptyElement(e.prompt));n.become("configure/tag-borrowed-import",{tag:this.tag,importables:t,callback:function(){n.extract(),this.tag.totalTaggings!=s&&this.become(i.collation,i.criteria)}.bind(this)})}.bind(this)),this._populateFilterCloud()},n._itemSignature=function(e){return e.title.titleId},n._itemDelete=function(e){this.tag.removeFromTitle(e.title)},n._pageFactory=function(e,i,s,n){this.tag.page(this.criteria,e,i,function(n){var r=[];t.each(n,function(e){r.push(e.title.possession()||e)},this),r._unfinished=i<this.tag.facetCount("availability","everything",this.criteria),s(r),e||this._populateFilterCloud()}.bind(this),n)},n._populateFilterCloud=function(){this.dom.filterCloud.become(this.tag,this.criteria,{only:{format:!0,availability:["available"]}})},n._onTapActionsExport=function(e){if(this.tag){var t="libbytag-"+this.tag.urlSafeName().toLowerCase(),i={tag:this.tag,criteria:this.criteria,count:this.dom.filterCloud._.appliedCount};i.count&&isFinite(i.count)||(i.count=this.tag.totalCount()),(new l).become(t,i).present()}},n._onTapActionsRename=function(){this.tag&&APP.interviews.dialog("configure/tag-name",{tag:this.tag}).present()},n._onTapTagRenamer=n._onTapActionsRename,n._onTapActionsDelete=function(){
this.tag&&APP.arena.popover().confirm({warningLabel:"tag.delete.warning",buttonLabel:"tag.delete.confirm",onSubmit:this._onTapDeleteConfirm.bind(this)})},n._onTapDeleteConfirm=function(){APP.patron.tags.removeItem(this.tag);var e=!1;t.each(APP.historian.history(),function(i){i.match(/^tags/)&&(APP.nav.go(i),t.breakIteration(e=!0))}),e||APP.nav.go("tags")},n._onTapBehaviorButton=function(e){APP.interviews.dialog("configure/tag-smarts",{tag:this.tag}).present()},s}),define("app/controllers/tags/tag-controller",["require","common","app/controllers/shelf/collation-controller","app/views/screens/tags/screen-tags-tag"],function(e){var t=e("common"),i=e("app/controllers/shelf/collation-controller"),s=i.new(),n=s.prototype;return n.SCREEN_CLASS=e("app/views/screens/tags/screen-tags-tag"),n.configure=function(){this.realm="tags"},n.match=n.refine=function(e){var i=e.match(/^tag\/([^\/]+)(.*)/);if(i)for(var s=i[1],n=s.replace(/%20/g,"+").replace(/\./g,"%2E"),r=0,o=APP.patron.tags.all.length;r<o;++r){var a=APP.patron.tags.all[r];if(t.among(a.urlSafeName(),s,n))return this._matchWithCriteria(e,{state:"tag",identifier:s,collation:a})}},n._updateWaypointToArgs=function(){this.waypoint.configure({name:this.args.collation.niceName()})},n._listenForCollationUpdate=function(){this._.updateHandler&&this.off(this._.updateHandler),this._.updateHandler=this.on("tag:update:all",function(){this._.pendingUpdate=!0}.bind(this))},s}),define("app/controllers/tags/tags-controller",["require","common","app/controllers/shelf/collation-controller","app/views/screens/tags/screen-tags-list","app/controllers/tags/tag-controller","app/controllers/library/list-controller","app/controllers/shelf/journey-controller"],function(e){var t=(e("common"),e("app/controllers/shelf/collation-controller")),i=t.new(),s=i.prototype;return s.SCREEN_CLASS=e("app/views/screens/tags/screen-tags-list"),s.SUB_CONTROLLERS=[e("app/controllers/tags/tag-controller"),e("app/controllers/library/list-controller"),e("app/controllers/shelf/journey-controller")],s.configure=function(){this.realm="tags",this.historical=!0,this.root=!0,this.waypoint.configure({label:"shelf.nav.tags"})},s.match=function(e){var t=this._matchWithCriteria(e,{state:"tags",collation:APP.patron.tags}),i=e.match(/^tags\/(tag\/.*)$/);if(i)return{head:"tags",tail:i[1]};var s=e.match(/^tags\/(.*\/page-\d.*)/);return s?{head:"tags",tail:s[1]}:t},s.usher=function(){APP.arena.raise(this.realm),APP.arena.dom.footer.raise(this.realm)},i}),define("app/views/components/showcase/app-header-showcase",["require","common","app/views/core/app-header","app/views/core/crumbs","app/views/components/library/library-logo"],function(e){var t=(e("common"),e("app/views/core/app-header")),i=t.new(),s=i.prototype,n=e("app/views/core/crumbs"),r=e("app/views/components/library/library-logo");return s.become=function(e){this.library=e,this._prepare().identity.become(this.library)},s._layoutControls=function(e){this._classify(e.root,"app-header-showcase"),this._build("",{extending:e,element:e.controls,extensionClass:"app-header-showcase"}," crumbs",{skip:!APP.shell.info.platform,construct:n}," identity",r),e.crumbs&&(e.crumbs.defaultCrumbs={},e.crumbs.defaultCrumbs[this._phrase("interview.menu")]="interview/menu")},i}),define("app/views/dialogs/dialog-showcase-explore",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.LISTS=[{addr:"spotlight-popular",head:"What’s Popular?",lede:"The hottest titles in the library right now. Tap a cover to start reading any book, audiobook, or magazine."},{addr:"curated-1345047",head:"Sit, Charge, Connect With Pioneer",lede:"Discover more than just a cozy seat. Magazines at our digital library are always available, without having to wait for others to return them."},{addr:"spotlight-popular/audiobooks/language-es/subject-26",head:"Audiolibros en Español",lede:"¡Escucha los títulos más populares en tu biblioteca, con narración en español!"},{addr:"spotlight-popular/audience-juvenile",head:"Popular With Kids",lede:"From nursery rhymes and classic tales to robots and pirates — young readers, come explore all the most popular titles at Pioneer Library!"},{addr:"curated-1363560",head:"Beginning To Read? Start Here!",lede:"These books contain the earliest phonics rules, short vowel sounds, and early sight words. They’re designed with decodable words and help build confidence in beginning readers."},{addr:"curated-1363538",head:"Getting Into Chapter Books",lede:"Short chapters, large fonts, and lots of illustrations helps young readers develop confidence and reading skills."},{addr:"curated-1419515",head:'Sports <span class="amp">&amp;</span> the Outdoors',lede:"Books that inspire you to get outside, get active, and find wonder in the natural world."}],n.become=function(e,i){this.address=e,this.list=i,this.library=i.library;var s,n=this._prepare(),r=this.LISTS.slice(0);t.each(r,function(i){i.addr==e&&(r.unshift(s=t.excise(r,i)),t.breakIteration())}),t.each(r,function(e){var t=e==s,i=this._build("dialog-showcase-explore-list <li>",{parentNode:n.lists}," strap <p> {showcase.explore.current-list}",{skip:!t}," link",{link:t?void 0:this._path(e.addr)},"  head <h2>",{html:e.head},"  lede <p>",{html:e.lede});this._classify(i.root,"dialog-showcase-explore-list-current",t)},this)},n.present=function(){return this.shade=APP.arena.shade(this,{springs:[.875]}),this.shade},n._layout=function(e){this._build("dialog-showcase-explore",{extending:e}," lists <ul>")},n._path=function(e){var t="showcase/"+this.library.baseKey;return e?t+"/"+e.replace(/^\//,""):t},s}),define("app/views/screens/showcase/screen-showcase-discovery",["require","common","app/views/screens/screen","app/views/components/showcase/app-header-showcase","shibui/src/components/form-input-search","shibui/src/components/spinner","app/views/core/cover-box","app/views/dialogs/dialog-showcase-explore"],function(e){var t=e("common"),i=e("app/views/screens/screen"),s=i.new(),n=s.prototype,r=e("app/views/components/showcase/app-header-showcase"),o=e("shibui/src/components/form-input-search"),a=e("shibui/src/components/spinner"),l=e("app/views/core/cover-box"),c=e("app/views/dialogs/dialog-showcase-explore");return n.become=function(e){this.library=e,this._prepare(),this.dom.header.become(this.library);var t=this.library.catalog.lists.produce(this.controller.args.address),i=t.params.withRefinements({supports:["bifocal"]}).address();this.list=this.library.catalog.lists.produce(i),this._fillOut(this.list),this._textify(this.dom.intro,{label:"showcase.discovery.welcome",substitutions:{LIBRARY_NAME:this.library.safeName()}})},n._layout=function(e){this._build("screen-showcase-discovery",{extending:e}," content .content .bumper-n .bumper-s","  pillar .pillar .bumper-e .bumper-w","   instrux","    cameo",{button:!0},"     .mascot-icon",{graphic:"mascot"},"    intro <p>","   controls","    explore",{button:!0},"     spinner",a,"     explore-label <span> {showcase.discovery.explore}",{wrapper:!1},"    search-form",{construct:o,with:{placeholder:"search.placeholder"}},"   covers","   afterword {showcase.discovery.afterword}",{button:!0}),this._.covers=[];for(var t=0;t<24;++t){var i=new l(this.dom.covers);this.dom["cover"+t]=i,this._.covers.push(i)}},n._layoutHeader=function(e){e.header=new r,e.header.impart(e.root,"prepend")},n._listen=function(e,t){this._handle("form:field:submit",t.searchForm),this._handle("form:field:reset",t.searchForm)},n._fillOut=function(e){this.dom.spinner.spin(),this._defer("covers-reset",function(){t.each(this._.covers,function(e){e.reset()},this)}.bind(this),20),e.freshen(0,24,function(e,i){this._defer("covers-reset"),t.each(this._.covers,function(e,t){var s=i[t];this._classify(e.dom.root,"hide",!s),s&&e.become(s,{link:this.controller.path+"/preview/"+s.titleId})},this),this.dom.spinner.stop()}.bind(this),function(){APP.journal.warn("[SHOWCASE-DISCOVERY] list failure:",arguments)}.bind(this))},n._onFormFieldSubmitSearchForm=function(e){var t="search/query-"+encodeURIComponent(e.m.value);APP.nav.go("showcase/"+this.controller.args.key+"/"+t)},n._onFormFieldResetSearchForm=function(e){var t="spotlight-popular";this.controller.args.address!=t&&APP.nav.go("showcase/"+this.controller.args.key+"/"+t)},n._onTapCameo=function(e){APP.arena.pickSkinTone(this.dom.cameo)},n._onTapExplore=function(e){var t=new c;return t.become(this.controller.args.address,this.list),t.present(),t},n._onTapAfterword=function(e){return this._onTapExplore(e)},s}),define("app/views/components/lectern/journalist",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.append=function(e,i){return"string"==typeof i?t.each(this.dom.output.querySelectorAll("."+i),function(e){e.parentNode.removeChild(e)}):(i=void 0,this._.entries=this._.entries||[],this._.entries.push(e)),this._element({tag:"p",parentNode:this.dom.output,pos:"prepend",classes:i,html:t.safe(e)})},n.copyOutputToClipboard=function(){var e="journalist-clipboard-result",i=this._element({parentNode:this.dom.root,classes:"journalist-clipboard-scratchpad",html:this._.entries.join("<br />")}),s=document.createRange();s.selectNodeContents(i);var n=window.getSelection();n.removeAllRanges(),n.addRange(s);try{document.execCommand("copy")?this.append(this._phrase("journalist.copy.success"),e):this.append(this._phrase("journalist.copy.failure"),e)}catch(i){this.append(this._phrase({label:"journalist.copy.error",substitutions:{ERROR:t.safe(i)}}),e)}n.removeAllRanges(),i.parentNode.removeChild(i),this.dom.output.scrollTop=0},n._layout=function(e){this._build("journalist",{extending:e}," output <pre>",{access:{tabindex:0}}," copy-output",{button:!0,label:"open.journalist.copy",spoken:"open.journalist.copy.clipboard"})},n._onTapCopyOutput=function(e){this.copyOutputToClipboard()},s}),define("app/views/screens/lectern/screen-lectern-open",["require","common","app/views/screens/screen","app/views/components/common/cover-3d","shibui/src/components/spinner","app/views/components/library/app-header-dismissive","app/views/components/lectern/journalist","app/views/components/interviews/interview-block"],function(e){var t=e("common"),i=e("app/views/screens/screen"),s=i.new(),n=s.prototype,r=e("app/views/components/common/cover-3d"),o=e("shibui/src/components/spinner"),a=e("app/views/components/library/app-header-dismissive"),l=e("app/views/components/lectern/journalist"),c=e("app/views/components/interviews/interview-block");return n.become=function(e,i){this.title=e,this.emergence=i,this._.becameAt=t.epochMilliseconds(),this.title?this.title.use(this._fillOut.bind(this,this._prepare())):this._fillOutEmpty(this._prepare())},n.emerge=function(){var e=this._prepare(),i=e.coverMechanism,s=t.excise(this,"emergence");if(!s)return this._declassify(i,"is-flat");var n=s.rect,r=e.cover3d.dom.bounds.getBoundingClientRect(),o=n.left-r.left+(n.width-r.width)/2,a=n.top-r.top+(n.height-r.height)/2,l=n.width/r.width;this._stylePrefix(i,"transition","none"),this._styleTransform(i,"translate3d("+o+"px,"+a+"px,0) scale("+l+")"),this._defer("emerge",function(){this._declassify(i,"is-flat"),this._stylePrefix(i,"transition"),this._styleTransform(i)}.bind(this))},n.handleReady=function(){this.dom.spinner.stop(),this._setFlags({vanishing:!0})},n.handleAuthentication=function(e){this.emerge(),this._enterInterview("authenticate/card",e)},n.handleUpdateLuggage=function(e){this.emerge(),this._enterInterview("lectern/updating",{luggage:e})},n.handleError=function(e){this.emerge(),this._enterInterview("lectern/error",{session:e,title:e.title,library:e.library,error:t.try(e.progress,"error")})},n._layout=function(e){this._build("screen-lectern-open",{extending:e}," color"," content .content","  upper","   pillar","    cover-mechanism .is-flat","     cover-3d",r,"  lower","   pillar .bumper-s","    status","     focal",{access:["spoken",{role:null}]},"      journalist",l,"     spinner",{construct:o,with:{variant:"small"}},"    interview",c)},n._listen=function(e,i){var s=0;e._onSpinnerTap=APP.events.onTap(i.spinner.dom.icon,function(){++s<3||(APP.events.off(e._onSpinnerTap),t.try(this.dom,"journalist.dom.output.focus()"))}.bind(this)),e._onJournalistFocus=APP.events.once(i.journalist.dom.root,"focusin",this.access.bind(this,i.focal,"normal")),this._handle("journal:write"),this._handle("bifocal:conceal")},n._layoutHeader=function(e){e.header=new a,e.header.impart(e.root,"prepend");var t=APP.historian.history(),i=this._phrase("popover.back");e.header.dom.crumbs.defaultCrumbs={},e.header.dom.crumbs.defaultCrumbs[i]=t[0]||"/"},n._fillOut=function(e,i,s){this.access(e.focal,["spoken",{role:null}]),this._colorizeWithBackground(),this._setFlags({loading:!this._.isInterviewing,exitable:!0});var n=t.try(this.emergence,"cover"),r=function(){e.cover3d.become(s,n),e.cover3d.interactive(!0)};this._semaphore("format",t.try(s,"format"))?r():s.reuse(r)},n._fillOutEmpty=function(e){this.access(e.focal,"normal"),this._colorizeWithBackground(),this._setFlags({loading:!1,exitable:!0}),e.cover3d.become(),this._semaphore("format",null)},n._colorizeWithBackground=function(){var e=this.dom.color,i=getComputedStyle(e).getPropertyValue("background-color");if(i){var s=t.rgbStringToHex(i);APP.arena.dom.elastiguard.colorize(s),APP.shell.colorize(s)}},n._enterInterview=function(e,i){this._defer("interview",function(){this._.isInterviewing=!0,this._classify(this.dom.status,"hide"),this._setFlags({loading:!1}),i=t.absorb(i,{inline:!0}),i.callback=this._exitInterview.bind(this,t.excise(i,"callback")),this.dom.interview.become(e,i)}.bind(this),this._delaySinceBecame(1e3))},n._exitInterview=function(e){if(this._.isInterviewing=!1,this.dom.interview.reset(),this._setFlags({loading:!0}),this._declassify(this.dom.status,"hide"),"function"==typeof e)return e(Array.prototype.slice.call(arguments,1))},n._onJournalWrite=function(e){e.m.journal==t.try(APP.lectern.session,"journal")&&this.dom.journalist.append(e.m.line)},n._onBifocalConceal=function(){this.dom.spinner.spin(),this._setFlags({vanishing:!1})},n._delaySinceBecame=function(e){var i=t.epochMilliseconds()-(this._.becameAt||0);return Math.max(0,e-i)},n._setFlags=function(e){t.each(e,function(e,t){this._defer("flag-"+e,this._classify.bind(this,this.dom.root,"is-"+e,!!t))},this)},s}),define("app/controllers/lectern/open-controller",["require","common","app/controllers/controller","app/views/screens/lectern/screen-lectern-open"],function(e){var t=e("common"),i=e("app/controllers/controller"),s=i.new(),n=s.prototype,r=e("app/views/screens/lectern/screen-lectern-open");return n.match=function(e){if("open"==e&&APP.title){var i=t.try(APP.titles.libraryForNow()||APP.library,"key()");if("magazine"==APP.title.format)return i=t.try(APP.titles.cardForNow(),"advantageKey")||i,{rewrite:"open/magazine/"+i+"/"+APP.title.titleId};var s=APP.titles.possessionForNow();return s&&"loan"==s.type?{rewrite:"open/loan/"+s.card.cardId+"/"+APP.title.titleId}:i?{rewrite:"open/sample/"+i+"/"+APP.title.titleId}:void 0}},n.configure=function(){this.root=!0,this.realm=APP.router.TRANSIENT_REALM,this.waypoint.configure({label:"crumb.open"})},n.enter=function(){APP.title&&APP.title.titleId!=this.args.titleId&&APP.titles.now(null),this.title=APP.titles.produce({titleId:this.args.titleId}),this.on("app:error:presenting",this._onPresentingError.bind(this))},n.fill=function(){var e=this._findCoverEmergenceInActiveSurface(this.args.titleId);this.screen=new r(this),APP.arena.surfaces.open.present(this.screen),this.screen.become(this.title,e)},n.focus=function(){APP.arena.raise("open"),APP.arena.dom.footer.lower("open"),this.screen.focus();var e={onReady:this._onLecternReady.bind(this),onAuthenticate:this._onLecternAuthenticate.bind(this),onFailure:this._onLecternError.bind(this),onClose:this._onLecternClose.bind(this)};this._tellLecternToOpenTitle(e),APP.lectern.bifocal.isRevealed||this.screen.emerge()},n.blur=function(){APP.lectern.bifocal.isRevealed?APP.lectern.concealBifocal({delay:100}):APP.lectern.close()},n._findCoverEmergenceInActiveSurface=function(e){var i=t.try(APP.arena.surface(),"dom.root");if(i)for(var s,n=0,r=0,o=i.querySelectorAll('[data-cover-id="'+e+'"]'),a=o.length-1;a>=0;--a){var l=o[a],c=l.getBoundingClientRect();c.width>n&&c.height>r&&c.x+c.width>=0&&c.x<window.innerWidth&&c.y+c.height>=0&&c.y<window.innerHeight&&(n=c.width,r=c.height,s={cover:l,rect:c})}return s},n._onLecternReady=function(e){this.screen&&(APP.titles.now(this.title,{websiteId:e.websiteId,cardId:e.cardId}),APP.lectern.revealBifocal(),this.screen.handleReady())},n._onLecternAuthenticate=function(e){t.try(this.screen,"handleAuthentication()",e)},n._onLecternUpdateLuggage=function(e){t.try(this.screen,"handleUpdateLuggage()",e)},n._onLecternError=function(e){t.try(this.screen,"handleError()",e)},n._onLecternClose=function(e){APP.router.route!=this||this._.exited||(APP.events.dispatch("investigate:record",{what:"lectern closed while open screen has focus",where:"OpenController#_onLecternClose",why:"INV-LECT-D",appSessionAgeMS:APP.summoner.daemons.engagement._msSince("launchedAt"),stackTrace:APP.investigator.stackTrace()}),APP.nav.go("shelf"))},n._onPresentingError=function(e){APP.journal.debug("Lectern::OpenController#onPresentingError",e.m),APP.lectern.error(t.try(e,"m.error")),APP.events.stop(e)},n._onDeniedAccess=function(e){t.defer(this,"unrecoverable-error",this._unrecoverableError.bind(this,{errorSource:"OpenController#_onDeniedAccess()",errorReason:e}))},n._unrecoverableError=function(e){t.defer(this,"unrecoverable-error"),e=t.absorb(e,{id:"title-unavailable",errorSource:"OpenController#_unrecoverableError",args:this.args,journal:this.journal.read()});var i=t.excise(e,"id");e.submissionContext=t.absorb(e.submissionContext,{title:this.title,library:t.try(this.loan,"library")}),APP.err(i,e).sendToSage().present()},s}),define("app/controllers/showcase/preview-controller",["require","common","app/controllers/lectern/open-controller"],function(e){var t=e("common"),i=e("app/controllers/lectern/open-controller"),s=i.new(),n=s.prototype;return n.match=function(e){var i=e.match(/^preview\/(\d+)$/);if(i){var s;if(t.each(t.flatten([t.try(APP,"router.route.path"),APP.historian.history()]),function(e){e.match(/^showcase/)&&(s=e)}),s)return this.args={},this.args.libraryKey=this.ancestor.args.library.baseKey,this.args.titleId=i[1],{head:e}}},n.blur=function(){this._.exited=!0,APP.lectern.close()},n._tellLecternToOpenTitle=function(e){APP.lectern.openShowcase(this.args.libraryKey,this.args.titleId,e)},n._onLecternReady=function(e){this.screen&&(APP.lectern.revealBifocal(),this.screen.handleReady())},s}),define("app/controllers/showcase/discovery-controller",["require","common","app/controllers/controller","app/views/screens/showcase/screen-showcase-discovery","./preview-controller"],function(e){var t=e("common"),i=e("app/controllers/controller"),s=i.new(),n=s.prototype,r=e("app/views/screens/showcase/screen-showcase-discovery");return n.SUB_CONTROLLERS=[e("./preview-controller")],n.configure=function(){this.realm="showcase",this.historical=!0,this.root=!0,this.waypoint.configure({label:"crumb.library"})},n.match=function(e){var i=e.match(/^showcase\/([\w\-]+)(\/(.*))?/);if(i){if(!t.among(i[1],"pioneerok","finch","canarylightning")&&"*"!=APP.flags.property("showcase"))return{rewrite:"library/"+i[1]};this.args={key:i[1]},this.args.library=APP.libraries.findActivatableLibrary(this.args.key);var s="showcase/"+t.try(this.args.library,"baseKey"),n=i[2];if(this.args.library){if(n){var r=n.match(/(\/preview\/.*$)/);return this.args.address=n.replace(/\/preview\/.*/,""),this.args.address=this.args.address.replace(/^\/+/,""),this.args.address=this.args.address||"spotlight-popular",s+="/"+this.args.address,n=r?r[1]:void 0,{head:s,tail:n}}return this.args.address="spotlight-popular",{head:s+"/"+this.args.address}}var o=t.parameterizeURL("interview/locate-library/resolve",{key:this.args.key,realm:"transient",nextPathPattern:"showcase/:key"+(n||"")});return{rewrite:o}}},n.refine=function(e){return this.path&&e=="showcase/"+t.try(this.args,"library.baseKey")?{head:this.path}:this.match(e.replace(/^ROLLBACK:/,""))},n.enter=function(){this.waypoint.configure({name:this.args.library.safeName()}),this.screen=new r,this.screen.controller=this},n.fill=function(){this.screen.become(this.args.library)},n.focus=function(){return APP.arena.raise("modal"),APP.arena.surfaces.modal.present(this.screen),APP.arena.dom.footer.lower(this.realm),i.prototype.focus.apply(this,arguments)},s}),define("app/controllers/lectern/open-sample-controller",["require","common","app/controllers/lectern/open-controller"],function(e){var t=e("common"),i=e("app/controllers/lectern/open-controller"),s=i.new(),n=s.prototype;return n.match=function(e){var i=e.match(/^open\/sample\/([^\/]+)\/([^\/]+)$/);if(i){if(this.args={accessMode:"sample",libraryKey:i[1],titleId:i[2]},APP.libraries.withKey(this.args.libraryKey)){var e="open/sample/"+this.args.libraryKey+"/"+this.args.titleId;return{head:e}}var s=t.parameterizeURL("interview/locate-library/resolve",{key:this.args.libraryKey,nextPathPattern:"open/sample/:key/"+this.args.titleId});return{rewrite:s}}},n._tellLecternToOpenTitle=function(e){APP.lectern.openSample(this.args.libraryKey,this.args.titleId,e)},s}),define("app/controllers/lectern/open-loan-controller",["require","common","app/controllers/lectern/open-controller"],function(e){var t=e("common"),i=e("app/controllers/lectern/open-controller"),s=i.new(),n=s.prototype;return n.match=function(e){var i=e.match(/^open\/loan\/([^\/]+)(\/([^\/]+))?$/);if(i){if(this.args={accessMode:"loan"},i[1]&&i[3])this.args.cardId=i[1],this.args.titleId=i[3];else{var s=APP.patron.loans.filter({"title.titleId":i[1]});s.sort(function(e,t){return t.expireTime-e.expireTime}),this.args.cardId=t.try(s[0],"card.cardId"),this.args.titleId=i[1]}if(this.args.cardId&&this.args.titleId)return{head:"open/loan/"+this.args.cardId+"/"+this.args.titleId}}},n._tellLecternToOpenTitle=function(e){e.onUpdateLuggage=this._onLecternUpdateLuggage.bind(this),APP.lectern.openLoan(this.args.cardId,this.args.titleId,e)},s}),define("app/views/components/lectern/curtain-magazine-exit",["require","common","app/views/core/partial","app/views/components/common/cover-3d","app/views/library/series-pedestal"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/components/common/cover-3d"),o=e("app/views/library/series-pedestal");return n.become=function(e,i){this.title=e,this.options=t.absorb(i,{});var s=this._prepare();s.cover3d.become(this.title),s.cover3d.interactive(!0),this._textify(s.title,{html:e.titleWithoutOrphans()}),this._updateSubscribeButtonLabel()},n._layout=function(e){i.prototype._layout.call(this,e),this._classify(this.dom.root,"curtain-magazine-exit"),this._build("curtain-magazine-exit",{extending:e}," prompt","  question {magazine.exit-prompt.question}","  row","   yes {magazine.exit-prompt.answer-keep}",{button:!0},"  row","   no {magazine.exit-prompt.answer-decline}",{button:!0},"  <hr>"," actions","  title","  row","   subscribe-button",{button:!0},"  row","   series-button {action.title.series.issues}",{button:!0},"  cover3d",r)},n._listen=function(e,t){this._handle("tag:subscriptions")},n._updateSubscribeButtonLabel=function(e){var e=APP.patron.magazines.isSubscribed(this.title);this._textify(this.dom.subscribeButton,e?"action.unsubscribe":"action.subscribe")},n._onTapYes=function(e){APP.patron.magazines.keepIssue(this.title,{library:this._library()}),APP.arena.activeCurtain.vanish()},n._onTapNo=function(e){APP.patron.magazines.stopKeepingIssue(this.title),APP.arena.activeCurtain.vanish()},n._onTapSubscribeButton=function(e){var t=APP.interviews.dialog("tutorial/title-subscribe",{title:this.title,library:this._library()}).present({constrainToContentHeight:!0,springs:[.8]}),i=APP.patron.magazines.isSubscribed(this.title);t.on("shade:invisible",function(){this.isInDocument()&&i!==APP.patron.magazines.isSubscribed(this.title)&&APP.arena.activeCurtain.vanish()}.bind(this))},n._onTapSeriesButton=function(e){var t=new o;t.PLANKS_PER_PAGE=t.STANDS_PER_PAGE=96,t.become(this.title,{library:this._library(),mini:!0}),APP.arena.shade(t,{constrainToContentHeight:!1,springs:[.8]})},n._onTagSubscriptions=function(){this._updateSubscribeButtonLabel()},n._library=function(){var e=APP.patron.magazines.find({"title.parentMagazineId":this.title.parentMagazineId});return t.try(e,"library")||this.options.library||APP.library},s}),define("app/controllers/lectern/open-magazine-controller",["require","common","app/controllers/lectern/open-controller","app/views/components/lectern/curtain-magazine-exit"],function(e){var t=e("common"),i=e("app/controllers/lectern/open-controller"),s=i.new(),n=s.prototype,r=e("app/views/components/lectern/curtain-magazine-exit");return n.match=function(e){var i=e.match(/^open\/magazine\/([^\/]+)\/([^\/]+)$/);if(i){if(this.args=this._computeRouteArgs(i[1],i[2]),APP.libraries.withKey(this.args.libraryKey)){var e="open/magazine/"+this.args.libraryKey+"/"+this.args.titleId;return{head:e}}var s=t.parameterizeURL("interview/locate-library/resolve",{key:this.args.libraryKey,nextPathPattern:"open/magazine/:key/"+this.args.titleId});return{rewrite:s}}},n.exit=function(){i.prototype.exit.apply(this,arguments);var e=t.try(APP.lectern,"session");if(this._.showCurtainOnExit=this._.showCurtainOnExit&&"sample"!=t.try(e,"accessMode"),this._.showCurtainOnExit){t.try(this.screen,"extract()");var s=this.title;APP.events.once("router:navigate",function(){t.defer(this,"curtain",function(){var i=new r;i.become(s,{library:t.try(e,"library")}),APP.arena.curtain(i)})}.bind(this))}},n._computeRouteArgs=function(e,i){for(var s,n=APP.patron.magazines.filter({"title.titleId":i}),r=0,o=n.length;r<o;++r){if(t.try(n[r].card,"advantageKey")==e){s=n[r];break}t.try(n[r].library,"baseKey")==e&&(s=n[r])}s||(s=n[0]);var a=t.try(APP.library,"card()");if(a&&a.isContentRestricted()||(a=t.try(s,"card")),a&&!a.removedFromCollation||(a=APP.patron.magazines.getCardForIssue(i)),!a||a.removedFromCollation){var l=APP.libraries.find({baseKey:e});if(a=t.try(l,"card()")){var c=a.advantageKey==e,h=a.isExpired();t.each(l.cards(),function(t){if(t!=a){var i=t.advantageKey==e,s=t.isExpired();(!c||i&&h)&&(a=t,c=i,h=s)}})}else{var u=APP.patron.cards.filter({advantageKey:e});t.each(u,function(e){return a?a.isExpired()&&!e.isExpired()?a=e:void 0:a=e})}}var p={accessMode:"magazine",libraryKey:t.try(a,"advantageKey")||e,titleId:i};return a&&(p.cardId=a.cardId),s&&(p.psnKey=s.psnKey),p},n._tellLecternToOpenTitle=function(e){this._.showCurtainOnExit=!APP.lectern.isOpen(this.title.titleId,"magazine")&&!APP.patron.magazines.isIssueInRack(this.title),t.absorb(this.args,e),delete e.libraryKey,delete e.titleId,e.onUpdateLuggage=this._onLecternUpdateLuggage.bind(this),APP.lectern.openMagazine(this.args.libraryKey,this.args.titleId,e)},n._onLecternError=function(e){return delete this._.showCurtainOnExit,i.prototype._onLecternError.apply(this,arguments)},n._onLecternReady=function(e){i.prototype._onLecternReady.apply(this,arguments),APP.patron.magazines.markIssueAsOpened(this.title)},s}),define("app/base/routing/router",["require","common","app/controllers/redirect-controller","app/controllers/interviews/topics-controller","app/controllers/search/catalog-controller","app/controllers/library/home-controller","app/controllers/shelf/summary-controller","app/controllers/tags/tags-controller","app/controllers/showcase/discovery-controller","app/controllers/lectern/open-controller","app/controllers/lectern/open-sample-controller","app/controllers/lectern/open-loan-controller","app/controllers/lectern/open-magazine-controller"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.ROOT_CONTROLLERS=[e("app/controllers/redirect-controller"),e("app/controllers/interviews/topics-controller"),e("app/controllers/search/catalog-controller"),e("app/controllers/library/home-controller"),e("app/controllers/shelf/summary-controller"),e("app/controllers/tags/tags-controller"),e("app/controllers/showcase/discovery-controller"),e("app/controllers/lectern/open-controller"),e("app/controllers/lectern/open-sample-controller"),e("app/controllers/lectern/open-loan-controller"),e("app/controllers/lectern/open-magazine-controller")],s.TRANSIENT_REALM="transient",s.$init=function(){this.realm=null,this.route=null,this.waypoints={},this._.controllerInstances=[]},s.start=function(){var e=location.pathname+location.search;"undefined"!=typeof window.localStorage&&(e=localStorage.getItem("SPARK:relaunch:path")||e,localStorage.removeItem("SPARK:relaunch:path")),this.navigate(e)},s.navigate=function(e){var t=this._chopSlashes(e);return"undefined"==typeof this.route?APP.historian.updateLocation(t):(APP.journal.info("🧭",t),APP.events.dispatch("router:navigating",{path:t}),void this._handlePathChange(t))},s.rebuild=function(e){var i=t.try(this.route,"path")||"/";if(APP.journal.debug("[ROUTER] rebuilding realms",e,i),"undefined"==typeof e)e=[],t.each(this.waypoints,function(t){e.push(t)});else if("string"==typeof e)e=[e];else if(!t.isArray(e))return APP.journal.warn("[ROUTER] invalid realms for rebuild()",e);t.among(this.realm,e)||(i=void 0),i&&(this.route=null),t.each(this.waypoints,function(i,s){if(t.among(i,e))for(;s.length;)this._exitRoute(s.pop().route)},this),i&&this._handlePathChange(i)},s.forget=function(e){t.each(this.waypoints,function(i,s){var n=[];t.each(s,function(t){t.route!=e&&n.push(t)}),this.waypoints[i]=n},this)},s._handlePathChange=function(e,i){if(i=t.absorb(i,{}),this.route&&this._routeRealm()!=e){var s,n=t.try(this.waypoints[e],"[0].route");if(n&&n.graftable!==!1&&(s=n),s)return this._switchToRoute(s),this._usherRoutes(s),this._completePathChange(i)}var r=this._reusableController(e);if(r.waypoint&&!r.tail){r.segments&&(this._unfillRoute(r.waypoint.route),r.waypoint.route.eject(),r.waypoint.route.segments=r.segments),this.route==r.waypoint.route&&(i.refocus=!0),this._switchToRoute(r.waypoint.route),this._usherRoutes(this.route);for(var o,a=this.waypoints[this._routeRealm()],l=0,c=a.length;l<c&&!a[l].rewriting;++l)if(a[l].path==this.route.waypoint.path){a[l]=this.route.waypoint,o=a.splice(0,l);break}for(var l=0,c=a.length;l<c;++l)if(a[l].rewriting&&(delete a[l].rewriting,!o)){o=a.splice(0,l);break}if(!o)for(var l=0,c=a.length;l<c;++l)if(a[l].route==this.route){o=[],a.unshift(this.route.waypoint);break}return t.each(o,function(e){this._exitRoute(e.route)},this),i.refocus||this._usherRoutes(this.route),this._completePathChange(i)}var h=r.waypoint?r.waypoint.route.SUB_CONTROLLERS:this.ROOT_CONTROLLERS,u=this._matchController(r,h);if(u.rewrite)return this.navigate(u.rewrite);if(u.chain&&u.chain.length){u.tail&&APP.journal.warn("[ROUTER] Unused segment:",u.tail),this._switchToRoute(t.last(u.chain));for(var a=this.waypoints[this._routeRealm()];u.chain.length;){var s=u.chain.shift();if(s.root){var o=a.slice(0);a.splice(0),t.each(o,function(e){this._exitRoute(e.route)},this)}this._enterRoute(s),(s.historical||s==this.route)&&(a=t.select(a,function(e){return e.path!=s.waypoint.path?e:void 0}),a.unshift(s.waypoint),this.waypoints[this._routeRealm()]=a)}return this._usherRoutes(this.route),this._completePathChange(i)}this._404(e)},s._completePathChange=function(e){this._fillRoute(this.route),e.refocus?this.route.refocus():this.route.focus(),APP.historian.updateLocation(this.route.path,{title:this.route.waypoint.name}),APP.semaphore.set("realm",this.realm),APP.events.dispatch("router:navigate",{realm:this.realm,path:this.route.path}),APP.scribe.record("navigation:view")},s._switchToRoute=function(e){this.realm=this._routeRealm(e),this.waypoints[this.realm]=this.waypoints[this.realm]||[];var i,s;if(this.route&&this.route!=e&&(i=this.route,s=this._routeRealm(i)),this.route=e,this.route.path=this._fullPathForRoute(this.route),this.route.waypoint.path=this.route.path,
i&&i!=e){i.blur();for(var n=[],r=this.route;r;)n.unshift(r),r=r.ancestor;for(r=i;r;)n.indexOf(r)<0&&r.eject(),r=r.ancestor;s==this.TRANSIENT_REALM&&this.realm!=this.TRANSIENT_REALM&&t.each(this.waypoints[s].splice(0),function(e){this._exitRoute(e.route)},this)}},s._reusableController=function(e){var t=this._pathToParts(e);if(this.realm)for(var i=this.waypoints[this.realm],s=0,n=i.length;s<n;++s){var r=this._matchExistingWaypoint(e,i[s],0===s);if(!r.tail)return r;r.tail.length<=t.tail.length&&(t=r)}for(var o in this.waypoints)if(this.realm!=o)for(var i=this.waypoints[o],s=0,n=i.length;s<n;++s){var r=this._matchExistingWaypoint(e,i[s],0===s);if(!r.tail)return r;r.tail.length<=t.tail.length&&(t=r)}return this._partsToParts(t)},s._matchExistingWaypoint=function(e,i,s){var n=this._pathToParts(e),r=i.path.replace(/#.*/,""),o=new RegExp("^"+t.regExpEscape(r)+"(/|$)(.*)"),a=(n.tail+n.query+n.fragment).match(o);if(a){if(t.try(i.route,"returnToWaypoint()",i),!a[2])return{waypoint:i};t.absorb(this._pathToParts(a[2]),n),n.waypoint=i}var l,c=i.route.ancestor;if(c?(r=c.path.replace(/[\?\#].*/,""),o=new RegExp("^"+t.regExpEscape(r)+"(/|$)(.*)"),a=e.match(o),a&&(l=a[2])):l=e,"string"==typeof l){l=l.replace(n.query,"").replace(n.fragment,""),s||(l="ROLLBACK:"+l);var h=i.route.refine(l,n.query,n.fragment);h&&!h.tail&&"string"==typeof h.head&&(n={waypoint:i,segments:h})}return n},s._matchController=function(e,i){for(var s=0;s<i.length;++s){var n=this._controllerInstance(i[s]);n.ancestor=e.route||t.try(e.waypoint,"route"),n.configure();var r=n.match(e.tail,e.query,e.fragment);if(r)return r.rewrite?{rewrite:r.rewrite}:(this._useControllerInstance(n),n.segments=r,n.path=this._fullPathForRoute(n),n.waypoint.path=n.path,e=this._partsToParts(t.absorb(r,{query:e.query,fragment:e.fragment,route:n,chain:(e.chain||[]).concat([n])})),e.tail&&r.head.indexOf("?")>=0?(APP.journal.warn("[ROUTER] controller.match: query in head; ignoring tail...",e.head,e.tail),e):e.tail&&r.head.indexOf("#")>=0?(APP.journal.warn("[ROUTER] controller.match: fragment in head; ignoring tail...",e.head,e.tail),e):e.tail?this._matchController(e,n.SUB_CONTROLLERS):e)}return e},s._controllerInstance=function(e){for(var t=0,i=this._.controllerInstances.length;t<i;++t){var s=this._.controllerInstances[t];if(s.class===e)return s.instance||(s.instance=new e),s.instance}var n={class:e,instance:new e};return this._.controllerInstances.push(n),n.instance},s._useControllerInstance=function(e){for(var t=0,i=this._.controllerInstances.length;t<i;++t){var s=this._.controllerInstances[t];s.instance===e&&(s.instance=null)}},s._fullPathForRoute=function(e){for(var t=[],i=e;i;)i.segments.head&&t.unshift(i.segments.head),i=i.ancestor;return t.join("/")},s._enterRoute=function(e){e.routeEntered||(e.enter(),e.routeEntered=!0)},s._usherRoutes=function(e){for(var i=[];e;)i.unshift(e),e=e.ancestor;t.each(i,function(e){e.usher()},this)},s._fillRoute=function(e){e.routeFilled||(e.fill(),e.routeFilled=!0)},s._exitRoute=function(e){for(var t=this.route;t;){if(t==e)return;t=t.ancestor}for(var i in this.waypoints)for(var s=this.waypoints[i],n=0,r=s.length;n<r;++n)if(e==s[n].route)return;this._unfillRoute(e),e.routeEntered=!1,e.exit(),APP.events.dispatch("router:exit",{route:e,path:e.path}),e.ancestor&&this._exitRoute(e.ancestor)},s._unfillRoutes=function(){this.route&&this._unfillRoute(this.route),t.each(this.waypoints,function(e,i){t.each(i,function(e){this._unfillRoute(e.route)},this)},this)},s._unfillRoute=function(e){e.routeFilled&&(e.off(),e.unfill(),e.routeFilled=!1)},s._404=function(e){APP.journal.error("[ROUTER] no controller matches path: "+e);var t=this.realm;"library"==t||"shelf"==t?(this.realm=null,APP.nav.go(t)):APP.nav.go("/"),APP.err("missing-route",{errorSource:e}).sendToSage().present()},s._routeRealm=function(e){return(e="undefined"==typeof e?this.route:e)?e.realm||this.DEFAULT_REALM:void APP.journal.warn("[ROUTER] no routeRealm because no this.route.")},s._chopSlashes=function(e){return(e||"").replace(/^\/+/,"").replace(/\/+$/,"")},s._pathToParts=function(e){var t=e.match(/([^\?#]*)?(\?[^#]*)?(#.*)?/);return{tail:this._chopSlashes(t[1]),query:t[2]||"",fragment:t[3]||""}},s._partsToParts=function(e){if(!e||!e.tail)return e;var t=this._pathToParts(e.tail);return e.tail=t.tail,e.query=t.query||e.query,e.fragment=t.fragment||e.fragment,e},i}),define("app/base/routing/nav",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.$init=function(){var e=this._onNavMessage.bind(this);APP.events.on("msg:nav:back",e),APP.events.on("msg:nav:library",e),APP.events.on("msg:nav:shelf",e),APP.events.on("msg:nav:library:root",e),APP.events.on("msg:nav:shelf:root",e),APP.events.on("msg:nav:title",e),APP.events.on("msg:nav:search",e),APP.events.on("msg:nav:go",e),APP.events.on("debug:command",this._onDebugCommand.bind(this))},s.go=function(e){APP.router.navigate(e)},s.back=function(){if(!APP.events.dispatch("nav:back:close",{},!0))return!0;try{return"string"==typeof APP.historian.rewind()}catch(e){}return!1},s._onNavMessage=function(e){var t=e.type.match(/nav:(.+(:root)?)$/);if(t){var i=t[1];if("back"==i)this._onNavBackMessage(e);else if("title"==i)APP.title&&this.go("open");else if("library:root"==i)this.go(APP.library?APP.library.path():"library");else if("shelf:root"==i)this.go("shelf");else if("search"==i&&e.m.query){if(e.m.query&&APP.library){var s=encodeURIComponent(e.m.query);this.go(APP.library.path("search/query-"+s+"/page-1"))}}else"go"==i?e.m.path&&this.go(e.m.path):this.go(i)}},s._onNavBackMessage=function(e){if("shell"==e.m.source&&APP.lectern.bifocal.isRevealed)return APP.shell.transmit({name:"nav:back",dest:"bifocal"});if(!this.back())return APP.lectern.bifocal.isRevealed?this.go("shelf"):void APP.shell.transmit({name:"nav:back:noop"})},s._onDebugCommand=function(e){var t=(e.m.command||"").match(/^go\s+([^\s]+)/i);t&&(e.m.output+="[NAV] "+t[1],this.go(t[1]))},i}),define("app/base/server",["require","common","./quirks"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("./quirks");return s.fetch=function(e,i,s){var r=this._toRequestOptions(e),o={req:new XMLHttpRequest,url:r.url,method:r.method||"GET",headers:r.headers||{},body:r.body,credentials:r.credentials};if(!o.headers["Accept-Language"]&&n("override-accept-language")&&(o.headers["Accept-Language"]=SPARK.locale.acceptTags.join(",")),o.onSuccess=function(){clearTimeout(o.timer),this._trackQueueCount(-1),i(o.req,r)}.bind(this),o.onFailure=function(e){clearTimeout(o.timer),this._trackQueueCount(-1),o.req.silentAbort||(APP.journal.warn("[SERVER] failure fetching: %s. %s",o.url,e),"function"==typeof s&&s(e,r))}.bind(this),APP.events.dispatch("network:request",o,!0)){var a=o.req;a.fetchTimestamp=t.epochMilliseconds(),a.open(o.method,o.url,!0),t.each(o.headers,a.setRequestHeader.bind(a)),o.credentials&&(a.withCredentials=!0),a.onreadystatechange=function(e){if(4==a.readyState)if(a.status>=200&&a.status<400)o.onSuccess(a);else{var t={status:a.status,response:{}};if(APP.network.reachable||a.status>0){t.failure=a.status?"unexpected-server-response":"unexpected-network-failure",t.response=a.responseText;try{t.response=JSON.parse(t.response)}catch(e){}}else t.failure="offline";o.onFailure(t)}}.bind(this),r.timeout!==!1&&(a.timeout=o.timeout=r.timeout||15e3,a.ontimeout=function(e){delete a.onreadystatechange,delete a.ontimeout,clearTimeout(o.timer),a.abort(),o.onFailure({failure:"timeout",response:{timeout:o.timeout}})},o.timer=setTimeout(function(){a.ontimeout&&a.ontimeout()},o.timeout+Math.min(1e3,o.timeout)));try{this._trackQueueCount(1),a.send(o.body)}catch(e){o.onFailure({failure:"client-error",status:0,response:e})}return a}},s._toRequestOptions=function(e){return"string"==typeof e?{url:e}:t.absorb(e,{})},s._trackQueueCount=function(e){this._.queueCount=(this._.queueCount||0)+(e||0),APP.events.dispatch("network:queue",{change:e,count:this._.queueCount})},i}),define("app/base/services/freshness",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.DEFAULT_TTL=36e5,s.$init=function(e,t){this.owner=e,t=t||{},"number"==typeof t.ttl?this.ttl=t.ttl:this.ttl=this.DEFAULT_TTL,this.freshAt=t.freshAt||0,this.failWithStale=t.failWithStale!==!1,this.callbacks={success:[],failure:[]},this.urls=[]},s.isFresh=function(){return!(this.freshAt<APP.freshHorizon)&&(!("function"==typeof this.owner._isFresh&&!this.owner._isFresh())&&this.freshAt+this.ttl>=t.epochMilliseconds())},s.isFreshening=function(){return this.urls.length>0},s.serviceAddCallbacks=function(e){e.onSuccess&&this.callbacks.success.push(e.onSuccess),e.onFailure&&this.callbacks.failure.push(e.onFailure)},s.serviceAddURL=function(e,t){this.urls.push([e,t])},s.servicePassURL=function(e){var t=this._deleteURL(e);t.length>0&&0==this.urls.length&&this.serviceSuccess()},s.serviceFailURL=function(e,t,i){var s=this._deleteURL(e);s.length>0&&this.serviceFailure(t,i)},s.serviceSuccess=function(){this.freshAt=t.epochMilliseconds(),this._invokeCallbacks("success")},s.serviceFailure=function(e,i){if(this.freshAt&&this.failWithStale){var s=[];t.each(this.urls,function(e){s.push(e[0])}),APP.journal.debug("... falling back to stale content for",s),APP.journal.debug("... due to service failure:",e),this._invokeCallbacks("success")}else this._invokeCallbacks("failure",e,i)},s._deleteURL=function(e){var i=[];return t.each(this.urls,function(t){t[0]==e&&i.push(t)}),t.each(i,function(e){t.excise(this.urls,e)},this),i},s._invokeCallbacks=function(e){var i=this.callbacks[e];this.callbacks.success=[],this.callbacks.failure=[];var s=this.urls;this.urls=[],t.each(s,function(e){e[1].abort()});var n=Array.prototype.slice.call(arguments,0);n[0]=this.owner,t.each(i,function(e){e.apply(n[0],n)})},s._resetFresheningState=function(){this.urls=[]},i}),define("app/base/services/service",["require","common","./freshness","shibui/src/phrasebook"],function(e){function t(e){var t="path",s=i.try(i.excise(e,t),"length");if("number"!=typeof s)return e;var n=function(e){return e.split("").reverse().join("")},r=function(e){return e.replace(/[^a-z]/g,"")},a=n("ld"+o.text(t+".a")+o.text(t+".b")),l=atob(a).split(","),c=r(APP.bank.get(l.splice(0,2).join("."))||a),h=n(c).slice(s,s+2);return e[l.shift()][l.shift()]=h,e}var i=e("common"),s=i.Class.new(),n=s.prototype,r=e("./freshness"),o=e("shibui/src/phrasebook");return n.$init=function(e,t,i){if(this.name=e,"function"==typeof t)this._rewriteURL=t;else{var s=new RegExp(t);this._rewriteURL=function(e){return e.replace(s,i)}}},n.fetch=function(e,s,n){var r=t(APP.server._toRequestOptions(e)),o=APP.server._toRequestOptions(this._rewriteURL(r.url));i.absorb(o,r);var a=APP.noop,l=APP.noop;return"function"==typeof s&&(a=function(e,t){s(e.responseText,e,t)}),"function"==typeof n&&(l=n),APP.journal.debug("[%s] ➜ %s",this.name,r.url),APP.server.fetch(r,a,l)},n.freshen=function(e,t,s){return this.freshmaker(e),e.freshness.serviceAddCallbacks(s),e.freshness.isFresh()?e.freshness.serviceSuccess():e.freshness.isFreshening()?void 0:(e.freshness.freshAt&&(e.freshness.freshAt=APP.freshHorizon-1),t&&"undefined"==typeof t.length&&(t=[t]),!t||t.length<1?e.freshness.serviceSuccess():void i.each(t,this.extendFreshenWithRequest.bind(this,e)))},n.extendFreshenWithRequest=function(e,t){"number"!=typeof t.retries&&(t.retries=1);var i=function(i){t.__aborted||(t.retries>0?(APP.journal.warn("[SERVICE] ↻",t.url,i),t.retries-=1,e.freshness._deleteURL(t.url),n()):e.freshness.serviceFailURL(t.url,i))},s=function(s){if(!t.__aborted){try{t.onFetch(s,e.freshness)}catch(e){APP.journal.warn("[SERVICE] ☠",e);var n={error:"fetch-failure",blame:"local",info:e};return i(n)}return e.freshness.servicePassURL(t.url)}},n=function(){var n=this.fetch(t,s,i);e.freshness.serviceAddURL(t.url,n),t.abort=function(){t.__aborted=!0,n.abort()}}.bind(this);n()},n.onServiceFailure=function(e,t){APP.network.reachable?APP.journal.warn("[SERVICE] unhandled failure:",t):APP.journal.warn("[SERVICE] could not complete request -- offline")},n.freshmaker=function(e,t){e.freshness=e.freshness||new r(e,t)},n.pathToURL=function(e){var t=APP.server._toRequestOptions(this._rewriteURL(e));return t.url},s}),define("app/base/services/service-vandal",["require","common","./service"],function(e){var t=e("common"),s=e("./service"),n=s.new(),r=n.prototype;return r.QUEUE_DELAY_MS=500,r.QUEUE_CONTINUE_MS=500,r.summaryOfTags=function(e,s,n){var r=function(s){var n=APP.patron.tags.taggingsLimitForPersistence(s.all.length),r=this._replayQueue();t.each(r,function(e){var r=this._findTagData(s.all,e.uuid,e.name);r?(r.totalTaggings=r.totalTaggings||r.all.length,t.each(e.all,function(e){for(i=0,ii=r.all.length;i<ii;++i)if(r.all[i].titleId==e.titleId)return;r.all.push(e),r.totalTaggings+=1},this),r.all.sort(function(e,t){return t.createTime-e.createTime}),r.all=r.all.slice(0,n)):(e.totalTaggings=e.all.length,e.all.sort(function(e,t){return t.createTime-e.createTime}),e.all=e.all.slice(0,n),s.all.push(e))},this),r.length&&(s.totalTaggings=0,t.each(s.all,function(e){s.totalTaggings+=e.totalTaggings||0})),e(s)}.bind(this);this.fetch({url:this._urlPath("tags")},function(e){var i=JSON.parse(e);i.all=t.excise(i,"tags"),t.each(i.all,function(e){e.all=t.excise(e,"taggings")},this),n.resetCollation=!0,r(i)}.bind(this),function(e){var i=APP.patron.tags.export();t.each(i.all,function(e){e.totalTaggings=e.all.length}),r(i)}.bind(this))},r.taggingsForTag=function(e,i,s,n){var r=this._replayQueue(),o=!(!i.range||!r.length),a=function(n){var a=this._findTagData(r,e.uuid,e.name),l=n.taggings||[];if(t.each(t.try(a,"all"),function(e){for(var t=0,i=l.length;t<i;++t)if(e.titleId==l[t].titleId)return;l.push(this._absorbWithout(e,{},"tagUUID"))},this),i.format&&"all"!=i.format){var c=[];t.each(l,function(e){e.titleFormat||c.push(e),e.titleFormat==i.format&&c.push(e)}),l=c}l.sort(function(e,t){return"title"==i.sort?e.sortTitle?t.sortTitle?e.sortTitle.localeCompare(t.sortTitle):1:-1:"author"==i.sort?e.sortAuthor?t.sortAuthor?e.sortAuthor.localeCompare(t.sortAuthor):1:-1:t.createTime-e.createTime}),o&&(l=l.slice(i.range[0],i.range[1])),s(t.absorb({taggings:l},n))}.bind(this),l={};i.range&&!o&&(l.range=i.range[0]+"..."+i.range[1]),i.format&&"all"!=i.format&&(l.format=i.format),i.sort&&(l.sort=i.sort),this.fetch({url:t.parameterizeURL(this._tagURLPath(e.uuid,e.name),l),timeout:6e3},function(e){var i=JSON.parse(e);a(t.try(i,"tag")||{taggings:[]})}.bind(this),function(t){o=!!i.range,a({taggings:e._serializeItems()})}.bind(this))},r.taggingsForTitles=function(e,i,s){var n={};t.each(e,function(e){n[e]=[]});var r=function(){t.each(this._replayQueue(),function(i){t.each(i.all,function(s){if(t.among(s.titleId,e)){var r=t.absorb(s,{tagData:i});n[s.titleId].push(r)}})},this);var s=this._deletionsInQueue();t.each(s.tags,function(e){t.each(n,function(i,s){var n=this._findTagData(s,e.uuid);n&&t.excise(s,n)},this)},this),t.each(s.taggings,function(e){var i=n[e.titleId];i&&(n[e.titleId]=[],t.each(i,function(t){t.tagUUID!=e.tagUUID&&n[e.titleId].push(t)},this))},this),t.each(n,function(e,t){t.sort(function(e,t){return e.createTime-t.createTime})},this),i(n)}.bind(this),o=function(){t.each(APP.patron.tags.all,function(i){t.each(i.all,function(s){if(t.among(s.titleId,e)){var r=s.export();r.tagUUID=i.uuid,r.tagName=i.name,n[s.titleId].push(r)}})}),r(n)}.bind(this),a=e;return APP.patron.tags.titleIds&&(a=t.select(e,function(e){if(t.among(e,APP.patron.tags.titleIds))return e})),a.length?void this.fetch({url:this._urlPath("taggings",a.join(",")),timeout:3e3},function(e){t.absorb(JSON.parse(e),n),r()}.bind(this),o):o()},r.syncDelta=function(e){var i=APP.patron.tags.syncPoint,s=t.epochSeconds();return i?void this.fetch({url:this._urlPath("tags","delta",i)},function(i){var n=JSON.parse(i);APP.journal.debug("[VANDAL] delta",n),APP.patron.tags.loadingLock(function(e){var i={source:"internal",integrity:"incomplete"};n.collection&&(n.collection.all=t.excise(n.collection,"tags"),e.import(n.collection,t.absorb(i,{resetCollation:!0}))),t.each(t.try(n,"ledgers"),function(s){var n=t.excise(s,"action");t.excise(s,"actionTime");if("tag:remove"==n){var r=e.find({uuid:s.tagUUID})||e.find({name:s.tagName});r&&r.collation.removeItem(r)}else if("tagging:add"==n||"tagging:update"==n){var r=this._findTagData(e.all,t.excise(s,"tagUUID"),t.excise(s,"tagName"));r&&r._deserializeItems([s],i)}else if("tagging:remove"==n){var r=this._findTagData(e.all,t.excise(s,"tagUUID"),t.excise(s,"tagName"));if(r){var o=r.find({"title.titleId":s.titleId});o&&r.removeItem(o)}}},this)}.bind(this)),APP.patron.tags.syncPoint=s,n.collection&&APP.patron.tags.save(),"function"==typeof e&&e()}.bind(this),function(t){"function"==typeof e&&e()}.bind(this)):("function"==typeof e&&e(),APP.patron.tags.syncPoint=s)},r.addTag=function(e){var i=e.export();delete i.all,this._pushToQueue(t.absorb(i,{action:"tag:add"}))},r.updateTag=function(e){var i=e.export();delete i.all,this._mergeToQueue(t.absorb(i,{action:"tag:update"}),{actions:["tag:add","tag:update"],matchOn:["uuid"]})},r.removeTag=function(e){this._pushToQueue({action:"tag:remove",name:e.name,uuid:e.uuid})},r.addTagging=function(e){var i=e.summarizeForVandal();this._pushToQueue(t.absorb(i,{action:"tagging:add"}))},r.updateTagging=function(e){var i=e.summarizeForVandal();this._mergeToQueue(t.absorb(i,{action:"tagging:update"}),{actions:["tagging:add","tagging:update"],matchOn:["tagUUID","titleId"]})},r.removeTagging=function(e){this._pushToQueue({action:"tagging:remove",tagUUID:e.collation.uuid,tagName:e.collation.name,titleId:e.title.titleId})},r.updateVisibility=function(e){this._mergeToQueue({action:"visibility:update",visibility:e},{actions:["visibility:update"]})},r.subscriptions=function(e,t){this.fetch({url:"subscriptions"},function(t){"function"==typeof e&&e(JSON.parse(t))}.bind(this),function(e){"function"==typeof t&&t(e)}.bind(this))},r.unsubscribe=function(e,t,i){var s=this._urlPath("subscription",e);this.fetch({url:s,method:"DELETE"},function(e){"function"==typeof t&&t(JSON.parse(e))}.bind(this),function(e){"function"==typeof i&&i(e)}.bind(this))},r.fetch=function(e,t,i){var n=function(){return APP.sentry.identity?(e.headers=e.headers||{},e.headers.Authorization="Bearer "+APP.sentry.identity,s.prototype.fetch.call(this,e,t,i)):i({status:0,message:"chip-not-acquired"})}.bind(this);return n()},r._replayQueue=function(){var e=[],i={},s=[],n={};return t.each(this._queue(),function(r){if("tag:add"==r.action){var o=this._absorbWithout(r,{},"action");o.all=[],e.push(o),i[o.uuid]=o}else if("tag:update"==r.action)this._absorbWithout(r,i[r.uuid],"action");else if("tag:remove"==r.action){var o=t.excise(i,r.uuid);t.excise(e,o)}else if("tagging:add"==r.action){var a=r.tagUUID+"-"+r.titleId,l=this._absorbWithout(r,{},"action");s.push(l),n[a]=l}else if("tagging:remove"==r.action){var a=r.tagUUID+"-"+r.titleId,l=t.excise(n,a);t.excise(s,l)}},this),t.each(s,function(s){var n=t.excise(s,"tagUUID"),r=t.excise(s,"tagName"),o=i[n];o||(o={uuid:n,name:r,all:[]},e.push(o),i[n]=o),o.all.push(s),o.totalTaggings=o.all.length},this),e},r._deletionsInQueue=function(){var e={},i={tags:[],taggings:[]};return t.each(this._queue(),function(s){if("tag:remove"==s.action)i.tags.push({uuid:s.uuid});else if("tagging:remove"==s.action){var n={tagUUID:s.tagUUID,titleId:s.titleId};i.taggings.push(n),e[s.tagUUID+s.titleId]=n}else if("tagging:add"==s.action){var n=e[s.tagUUID+s.titleId];n&&t.excise(i.taggings,n)}},this),i},r._findTagData=function(e,t,i){for(var s=0,n=e.length;s<n;++s)if(e[s].uuid==t)return e[s];for(var s=0,n=e.length;s<n;++s)if(e[s].name==i)return e[s]},r._queue=function(){return this._.queue||(this._.queue=APP.bank.get("vandal:queue")||[],this._resolveTaggingTitlesInQueue()),this._.queue},r._saveQueue=function(){APP.bank.set("vandal:queue",this._queue())},r._pushToQueue=function(e,t){this._queue().push(e),this._saveQueue(),this._resolveTaggingTitlesInQueue(this._scheduleQueueProcessing.bind(this))},r._mergeToQueue=function(e,i){var s=!1;t.each(this._queue(),function(n){if(t.among(n.action,i.actions)){var r=!0;if(t.each(i.matchOn,function(i){n[i]!=e[i]&&(r=!1,t.breakIteration())}),r){var o=n.action;t.absorb(e,n),n.action=o,s=!0,t.breakIteration(),this._saveQueue(),this._scheduleQueueProcessing()}}},this),s||this._pushToQueue(e)},r._resolveTaggingTitlesInQueue=function(e){this._.resolving=t.select(this._queue(),function(e){if("tagging:add"==e.action&&!e.titleFormat)return e});var i=function(){delete this._.resolving,"function"==typeof e&&e()}.bind(this);return this._.resolving.length?void t.each(this._.resolving,function(e){var s=APP.titles.produce({titleId:e.titleId});s.use(function(n){if(this._.resolving){if(!s.format)return s.reuse();e.titleFormat=s.format,e.titleSubjects=s.subjects,e.sortTitle=s.sortTitle,e.sortAuthor=s.sortAuthor,t.excise(this._.resolving,e),this._.resolving.length||(i(),this._saveQueue())}},this)},this):i()},r._scheduleQueueProcessing=function(e){clearTimeout(this._.queueTimer),this._.queueTimer=setTimeout(this._processQueue.bind(this),e||this.QUEUE_DELAY_MS)},r._processQueue=function(){var e=this._queue()[0];if(e){if(!APP.sentry.identity)return APP.sentry.acquireChip(this._processQueue.bind(this),function(t){APP.events.dispatch("investigate:record",{what:"vandal failure -- unable to acquire chip",where:"ServiceVandal#_processQueue",ledger:e,error:t}),this._processQueueWhenOnline()}.bind(this));if(!this._.resolving&&!this._.processing){var i={method:"POST",timeout:1e4,headers:{"Content-Type":"application/json",Accept:"application/json"}};if("tag:add"==e.action||"tag:update"==e.action){var s={tag:this._absorbWithout(e,{},"action")};i.url=this._tagURLPath(e.uuid,e.name),i.body=JSON.stringify(s)}else if("tag:remove"==e.action)i.method="DELETE",i.url=this._tagURLPath(e.uuid,e.name);else if("tagging:add"==e.action||"tagging:update"==e.action){var s={tagging:this._absorbWithout(e,{},["action","tagUUID","tagName"])};i.url=this._tagURLPath(e.tagUUID,e.tagName,"tagging",e.titleId),i.body=JSON.stringify(s)}else"tagging:remove"==e.action?(i.method="DELETE",i.url=this._tagURLPath(e.tagUUID,e.tagName,"tagging",e.titleId)):"visibility:update"==e.action&&(i.url=this._urlPath("tags","visibility"),i.body=JSON.stringify({visibility:e.visibility}));this._.processing=!0,this.fetch(i,function(){this._.processing=!1,t.excise(this._queue(),e),this._saveQueue(),this._scheduleQueueProcessing(this.QUEUE_CONTINUE_MS)}.bind(this),function(i){if(this._.processing=!1,404==i.status)t.excise(this._queue(),e),this._saveQueue(),this._scheduleQueueProcessing(this.QUEUE_CONTINUE_MS);else{var s=["offline","timeout","unexpected-network-failure"];t.among(i.failure,s)||APP.events.dispatch("investigate:record",{what:"vandal failure -- potential queue blockage",where:"ServiceVandal#_processQueue",ledger:e,error:i}),this._processQueueWhenOnline()}}.bind(this))}}},r._processQueueWhenOnline=function(){APP.network.reachable||this._.onlineHandler||(this._.onlineHandler=APP.events.on("network:info",function(e){e.m.network.reachable&&(delete this._.onlineHandler,this._scheduleQueueProcessing(this.QUEUE_CONTINUE_MS))}.bind(this)))},r._urlPath=function(e){var e=t.flatten(Array.prototype.slice.call(arguments,0)),i=[];return t.each(e,function(e){i.push(encodeURIComponent(e))}),i.join("/")},r._tagURLPath=function(e,i,s){var s=t.flatten(Array.prototype.slice.call(arguments,2));s.unshift(t.base64EncodeSafely(i)),s.unshift(e),s.unshift("tag");var n=this._urlPath.apply(this,s);return t.parameterizeURL(n,{enc:1})},r._absorbWithout=function(e,i,s){var n=t.absorb(e,i||{});return t.each(t.flatten([s]),function(e){delete n[e]}),n},n}),define("app/base/services/services",["require","common","./service","./service-vandal","app/base/quirks"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("./service"),r=e("./service-vandal"),o=e("app/base/quirks");return s.$init=function(){this._assembleFleet()},s._assembleFleet=function(){this.dewey=new n("DEWEY-SERVICE","^","/api/"),this.sentry=this._createYeOldeService("sentry"),this.sage=this._createYeOldeService("sage"),this.vandal=this._createYeOldeService("vandal",r),this.thunder=new n("THUNDER",function(e){var i=APP.constants.THUNDER_URI+"/v2/",s={"x-client-id":"dewey"};return{url:t.parameterizeURL(i+e,s)}}),this.autocomplete=new n("AUTOCOMPLETE",function(e){var i=APP.constants.AUTOCOMPLETE_URI+"/v1/",s={};return APP.constants.AUTOCOMPLETE_KEY&&(s["api-key"]=APP.constants.AUTOCOMPLETE_KEY),{url:t.parameterizeURL(i+e,s)}}),this.ntc=new n("NTC",function(e){var i=APP.constants.NTC_API_URI+"/v1/",s={"x-client-id":"dewey"};return{url:t.parameterizeURL(i+e,s)}})},s._createYeOldeService=function(e,t){var i=e.toUpperCase(),s=this._normalizeServiceURI(APP.constants[i+"_URI"]);return s?new(t=t||n)(i,this._corsifyServiceURI.bind(this,s,{})):void APP.journal.warn("["+i+"] URI not defined")},s._normalizeServiceURI=function(e){if("string"==typeof e)return e.replace(/\/$/,"")+"/"},s._corsifyServiceURI=function(e,i,s){return e=e.replace(/\/$/,"")+"/",i=i||{},o("send-nautilus-origin-for-cors")&&(i._nautilus_origin=location.origin),{url:t.parameterizeURL(e+s,i)}},i}),define("app/base/bosses/investigator",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.$init=function(){this._.queue=[],APP.events.on("investigate:record",this._onInvestigateRecord.bind(this)),APP.events.on("app:boss:sage",this._onAppBossSage.bind(this)),APP.events.on("investigate:dewey-bank-data-received",this._onInvestigateDeweyBankDataReceived.bind(this)),APP.events.on("investigate:dewey-bank-data-before-migration",this._onInvestigateDeweyBankDataBeforeMigration.bind(this)),APP.events.on("investigate:dewey-bank-data-after-migration",this._onInvestigateDeweyBankDataAfterMigration.bind(this))},s.record=function(e){e=t.absorb(e,{}),e.errorMessage="INVESTIGATION: "+t.excise(e,"what"),e.why&&(e.errorMessage+=" ["+t.excise(e,"why")+"]"),e.errorSource=t.excise(e,"where")||"Investigator#record",t.excise(e,"withStackTrace")&&(e.stackTrace=this._stackTrace()),APP.sage?this._sendFactsToSage(e):this._.queue.push(t.clone(e))},s.stackTrace=function(){var e="[unknown]";try{e=(new Error).stack}catch(t){e=t.stack||e}return e.split("\n")},s.isChipMissingFromBank=function(){var e=this._loadFromLocalStorage("forgotten-credentials");return!!(e&&e.chip&&e.identity)},s.recoverChipToBank=function(){var e=this._loadFromLocalStorage("forgotten-credentials");e&&e.chip&&e.identity?(APP.bank.set("sentry.chip",e.chip),APP.bank.set("sentry.identity",e.identity),delete APP.sentry.chip,delete APP.sentry.identity):APP.journal.warn("[INVESTIGATOR] no forgotten credentials to recover")},s._onInvestigateRecord=function(e){var i=t.absorb(e.m,{where:"Investigator#_onInvestigateRecord"});this.record(i)},s._onInvestigateDeweyBankDataReceived=function(e){var i=this._loadFromLocalStorage("bank-state")||{};if(this._.receivedChip=e.m.bankData?e.m.bankData["sentry.chip"]:null,this._.receivedChip)try{i.timestamp=i.timestamp||t.epochMilliseconds(),i.summary=this._summarizeBankData(e.m.bankData),i.byteSize=this._calculateBankDataSize(i.summary),i.chips=i.chips||[],t.among(this._.receivedChip,i.chips)||i.chips.unshift(this._.receivedChip),this._saveToLocalStorage("bank-state",i)}catch(e){this.record({what:"unserializable bank state",where:"Investigator#_onInvestigateDeweyBankDataReceived",why:"INV-BANK002 INV-BANK002-A",receivedChip:this._.receivedChip,error:e})}else if(i.timestamp){var s=this._loadFromLocalStorage("forgotten-credentials")||{};s.chip&&s.identity||(s.chip=t.try(i.summary["sentry.chip"],"value"),s.identity=t.try(i.summary["sentry.identity"],"value")),this._saveToLocalStorage("forgotten-credentials",s);var n={};n.timestamp=t.epochMilliseconds(),n.summary=this._summarizeBankData(e.m.bankData),n.byteSize=this._calculateBankDataSize(n.summary),this.record({what:"apparent erasure of bank",where:"Investigator#_onInvestigateDeweyBankDataReceived",why:"INV-BANK002 INV-BANK002-B",bankStateBeforeErasureDetected:i,bankStateAfterErasureDetected:n})}},s._onInvestigateDeweyBankDataBeforeMigration=function(e){e.m.bank&&(this._.chipBeforeMigration=e.m.bank.get("sentry.chip"),this._.bankSummaryBeforeMigration=this._summarizeBankData(e.m.bank._.data))},s._onInvestigateDeweyBankDataAfterMigration=function(e){if(e.m.bank&&this._.chipBeforeMigration){var i=t.excise(this._,"chipBeforeMigration"),s=e.m.bank.get("sentry.chip"),n=t.excise(this._,"bankSummaryBeforeMigration");i!=s&&this.record({what:"chip lost during bank migration",where:"Investigator#_onInvestigateDeweyBankDataAfterMigration",why:"INV-BANK002 INV-BANK002-C",chipBeforeMigration:i,chipAfterMigration:s,bankSummaryBeforeMigration:n,bankSummaryAfterMigration:this._summarizeBankData(e.m.bank._.data),journal:t.try(e.m,"migrator.journal.read()")})}},s._onAppBossSage=function(e){for(;this._.queue.length;)this._sendFactsToSage(this._.queue.shift())},s._sendFactsToSage=function(e){var i={shouldPersist:t.excise(e,"shouldPersist")||!1};APP.err("non-fatal",e).sendToSage(i)},s._loadFromLocalStorage=function(e){try{return JSON.parse(localStorage.getItem("investigator:"+e))||{}}catch(e){}},s._saveToLocalStorage=function(e,t){t?localStorage.setItem("investigator:"+e,JSON.stringify(t)):localStorage.removeItem("investigator:"+e)},s._summarizeBankData=function(e){if(e){var i={};return t.each(e,function(e,s){i[e]={byteSize:JSON.stringify(s).length},t.among(typeof s,"string","number")&&(i[e].value=s)}),i}},s._calculateBankDataSize=function(e){var i=0;return t.each(e,function(e,t){i+=t.byteSize||0}),i},i}),define("app/base/bosses/network",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.MIN_CHECK_INTERVAL_MS=1e3,s.prime=function(e){this._.onPrimedCallback=e,this.isPrecise=APP.shell.has("network:info")&&APP.shell.info.spec>=7,this.isPrecise||(APP.events.on(window,"online",this._webInfo.bind(this)),APP.events.on(window,"offline",this._webInfo.bind(this))),this.check()},s.check=function(e){if(!this._.checkPending)if(this.isPrecise){var i=t.epochMilliseconds(),s=i-(this._.lastCheckMS||0);e||s>this.MIN_CHECK_INTERVAL_MS?(this._.lastCheckMS=i,this._.checkPending=!0,APP.shell.transmit("network:info")):this._announce()}else this._webInfo()},s._onInfo=function(e){this._.lastCheckMS=t.epochMilliseconds(),this._.checkPending=!1;var i={reachable:[this.reachable,e.reachable],metered:[this.metered,e.metered],connection:[this.connection,e.connection]};this.reachable=e.reachable,this.metered=e.metered,this.connection=e.connection,APP.semaphore.set("network",e.reachable?e.metered?"metered":"unmetered":"unreachable"),this._announce(i)},s._webInfo=function(){var e={reachable:[this.reachable,navigator.onLine]};this.reachable=navigator.onLine,this.metered=!1,APP.semaphore.set("network",this.reachable?"unmetered":"unreachable"),this._announce(e)},s._announce=function(e){if(APP.events.dispatch("network:info",{network:this,delta:e||{}}),"function"==typeof this._.onPrimedCallback){var t=this._.onPrimedCallback;delete this._.onPrimedCallback,t(this)}},i}),define("app/base/bosses/version-valet",["require","common","app/base/quirks"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("app/base/quirks");return s.LATEST_FEATURES_VERSION="16.0.0",s.OVERRIDE_FLAG="version-valet-check",s.$init=function(){APP.events.on("debug:command",this._onDebugCommand.bind(this))},s.check=function(){if(this.entrapment)return this.entrapment;var e=APP.flags.property(this.OVERRIDE_FLAG);if(e&&e!=this._.lastReason)return this._.lastReason=e;if(!this._.lastReason){var t=this._checkForUpgradeReason();return this._.lastReason=t||"none",t}},s.entrap=function(e){this.entrapment=e},s.hasAcknowledgedLatestFeatures=function(){if(this._.checkedForLatestFeatures)return!0;this._.checkedForLatestFeatures=!0;var e=this.LATEST_FEATURES_VERSION;if(!e)return!0;var i=t.try(APP.bank.get("daemon:engagement"),"installedAt");return!i||t.epochMilliseconds()-i<864e5?(this.acknowledgeLatestFeatures(),!0):APP.bank.get("version:features:ack")==e},s.acknowledgeLatestFeatures=function(){
APP.bank.set("version:features:ack",this.LATEST_FEATURES_VERSION)},s._checkForUpgradeReason=function(){return n("discontinued-dst-root")?"discontinued.dst-root":n("discontinued-kitkat")?"discontinued.kitkat":n("discontinued-uwp")?"discontinued.uwp":n("incompatible")?"incompatible.generic":APP.shell.capability("ui:oauth")===!1?"update-required.generic":void 0},s._onDebugCommand=function(e){if(!e.m.output){var t=(e.m.command||"").trim();if(match=t.match(/^version-valet-check(\s+([\w\.-]+))?/i)){var i=(match[2]||"").trim();i&&"undefined"!=i||(i=void 0),delete this.entrapment,APP.flags.override(this.OVERRIDE_FLAG,i),e.m.output="VERSION VALET: "+APP.flags.property(this.OVERRIDE_FLAG)}}},i}),define("app/base/rosters/roster",["require","common","app/base/version","app/base/journal"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("app/base/version"),r=e("app/base/journal");return s.DEFAULT_ATTRIBUTES={role:"content",group:"unknown-group",id:"unknown-id",version:"0.0.0",health:"invalid"},s.DEFAULT_ENTRY_BYTES=1e3,s.$init=function(e){this.version=new n,this._fromDocument(t.absorb(e,t.absorb(this.DEFAULT_ATTRIBUTES,{})))},s.merge=function(e){return this._fromDocument(e),this},s.initialize=function(e){this.journal.debug("!! INITIALIZE"),this.health="pending",this._.callbacks=e,this._listen({"msg:roster:entry:progress":this._onEntryProgress,"msg:roster:entry:response":this._onEntryResponse,"msg:roster:finalize":this._onFinalize,"msg:roster:error":this._onError}),APP.shell.transmit({name:"roster:initialize",roster:this._toDocument()}),this._updateInitialized()},s.wipe=function(){this.journal.debug("!! WIPE"),this._deafen(),this.health="invalid",this.bytes.downloaded=0,t.each(this.entries,function(e){e.bytes.percent=0,e.bytes.downloaded=0}),APP.shell.transmit({name:"roster:wipe",roster:this._toDocument()})},s.invalidate=function(){this.journal.debug("!! INVALIDATE"),this.health="invalid",APP.shell.transmit({name:"roster:invalidate",roster:this._toDocument()})},s.serialize=function(){return{role:this.role,group:this.group,id:this.id,health:this.health,version:this.version.value,bytes:this.bytes}},s._configureJournal=function(){this.journal=this.journal||new r({consolePrefix:"[ROSTER]"}),this.journal.configure({linePrefix:"{"+this.id+":"+this.version.value+"}"})},s._listen=function(e){var i=this._.handlers={};t.each(e,function(e,t){i[e]=APP.events.on(e,t.bind(this))},this)},s._deafen=function(){APP.events.off(this._.handlers),delete this._.handlers},s._onEntryProgress=function(e){if(this._eventIsForThisRoster(e)&&e.m.entry&&e.m.entry.url&&e.m.progress){var t=this._entryForURL(e.m.entry.url);t&&(t.bytes.percent=e.m.progress,t.bytes.downloaded=t.bytes.total*t.bytes.percent,this._calculateProgress())}},s._onEntryResponse=function(e){if(this._eventIsForThisRoster(e)){var t=this._entryForURL(e.m.entry.url);if(!t)return this.journal.warn("entry not found:",e.m.entry.url);if("valid"==this.health)return this.journal.warn("cannot ack entry:response (roster is finalized)",t.url);var i=e.m.response.status;t&&i>=200&&i<300||410==i?this._onEntryFetched(t):this._onEntryFailed(t)}},s._onEntryFetched=function(e){e.bytes.percent=1,e.bytes.downloaded=e.bytes.total,this._calculateProgress()},s._onEntryFailed=function(e){this.journal.warn("fetch failed",e?e.url:"--"),this._onError({m:{reason:"fetch failed",url:e?e.url:"--"}})},s._onFinalize=function(e){this._eventIsForThisRoster(e)&&(this.journal.debug("!! FINALIZE"),this._deafen(),this.health="valid",t.each(this.entries,function(e){e.bytes.percent=1,e.bytes.downloaded=e.bytes.total}),this._calculateProgress(),this._updateFinalized())},s._onError=function(e){"pending"==this.health&&(this.journal.warn("invalidating due to error (while pending):",e.m),this._deafen(),this.health="invalid",this._updateInvalidated())},s._eventIsForThisRoster=function(e){return!(!this.id||!e.m.roster)&&(this.id===e.m.roster.id&&this.version.value===e.m.roster.version)},s._calculateProgress=function(){var e=0;"valid"==this.health&&this.bytes.total?e=this.bytes.total:(t.each(this.entries,function(t){e+=t.bytes.downloaded}),e=Math.min(e,this.bytes.total)),e!=this.bytes.downloaded&&(this.bytes.downloaded=e,this._updateProgress())},s._entryForURL=function(e){var i=[e];"Android"==APP.shell.info.platform&&i.push(encodeURI(e));for(var s=0,n=this.entries.length;s<n;++s)if(t.among(this.entries[s].url,i))return this.entries[s]},s._normalizeEntryURL=function(e){return e.match(/^https?:/)?e:APP.constants.ROOT_URI+t.relativeURL(e)},s._toDocument=function(){var e=t.absorb({role:this.role,group:this.group,id:this.id,version:t.try(this.version,"value"),entries:[]},t.absorb(this.DEFAULT_ATTRIBUTES,{}));return t.each(this.entries,function(i){var s=t.absorb(i,{});s.request=this._requestAttributesForEntry(i),s.bytes=i.bytes.total,e.entries.push(s)},this),e},s._fromDocument=function(e){var i=this.bytes||{total:0,downloaded:0};t.each(e,function(s,n){"version"==s?this.version.assign(n):"entries"==s?(i.total=0,this.entries=t.select(n,function(s){var n=t.absorb(s,{});return n.url=this._normalizeEntryURL(n.url),n.bytes={},n.bytes.total=s.bytes||this.DEFAULT_ENTRY_BYTES,i.total+=n.bytes.total,"valid"==e.health?(n.bytes.downloaded=n.bytes.total,n.bytes.percent=1,i.downloaded=i.total):n.bytes.downloaded=n.bytes.percent=0,n},this)):t.among(s,"role","group","id","health")&&(this[s]=n)},this),this.bytes=i,this._configureJournal()},s._requestAttributesForEntry=function(e){var t=e.request||{};return t.url=t.url||e.url,t.method=t.method||e.method||"GET","POST"==t.method&&(t.headers||(t.headers={}),t.headers["Content-Type"]||(t.headers["Content-Type"]="application/x-www-form-urlencoded")),t},s._updateInitialized=function(){this._invokeCallback("onInitialize")},s._updateProgress=function(){this._invokeCallback("onProgress")},s._updateFinalized=function(){this._invokeCallback("onFinalize")},s._updateInvalidated=function(){this._invokeCallback("onInvalidate")},s._invokeCallback=function(e){if(this._.callbacks){var t=this._.callbacks[e];"function"==typeof t&&t(this)}},i}),define("app/base/rosters/auditor",["require","common","app/base/quirks","app/base/rosters/roster","app/base/version"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("app/base/quirks"),r=(e("app/base/rosters/roster"),e("app/base/version"));return s.AUTO_DOWNLOAD_RULES=[["everything"],["byte-limited",20],["nothing"]],s.AUTO_DOWNLOAD_DEFAULT=s.AUTO_DOWNLOAD_RULES[0],s.AUTO_DOWNLOAD_MEGABYTE_LIMITS=[10,20,50,100,200,300],s.DOWNLOAD_QUEUE_RULES={go:"go",wifi:"wifi",stop:"stop"},s.DOWNLOAD_QUEUE_DEFAULT="wifi",s.$init=function(){this.rosters={},this._.pauseReasons=[],this._loadAutoDownloadRule(),this._loadDownloadQueueRule(),APP.events.on("msg:roster:audit",this._onRosterAudit.bind(this)),APP.events.on("network:info",this._onNetworkInfo.bind(this)),APP.events.on("patron:sync:complete",this.attemptAudit.bind(this)),APP.events.on("bifocal:downloads:pause",this._onBifocalDownloadsPause.bind(this)),APP.events.on("bifocal:downloads:resume",this._onBifocalDownloadsResume.bind(this)),this.resume(),this._conformToNetworkConditions(APP.network),this.attemptAudit(750)},s.attemptAudit=function(e){APP.shell.has("rosters")&&("number"!=typeof e&&(e=100),t.defer(this,"audit-attempt",function(){APP.shell.transmit("roster:audit")},e))},s.pause=function(e){this._.pauseReasons.length||t.defer(this,"pause-resume",function(){APP.shell.transmit({name:"roster:pause:role",role:"content"})}),t.among(e,this._.pauseReasons)||this._.pauseReasons.push(e)},s.resume=function(e){if((!e||this._.pauseReasons.length)&&(e&&t.excise(this._.pauseReasons,e),!this._.pauseReasons.length)){var i="wifi"!=this.downloadQueueRule;n("cellular-access-control-ignores-priority")&&(i=!0),t.defer(this,"pause-resume",function(){APP.shell.transmit({name:"roster:resume:role",role:"content",cellular:i})},500)}},s.isPaused=function(){return this._.pauseReasons.length>0},s.autoDownloadRules=function(){var e=[];return t.each(this.AUTO_DOWNLOAD_RULES,function(t){this.autoDownloadRule&&this.autoDownloadRule[0]==t[0]&&(t=this.autoDownloadRule),e.push(t)},this),e},s.setAutoDownloadRule=function(e){this.autoDownloadRule=e,this.autoDownloadRuleAt=t.epochMilliseconds(),APP.patron.choose("roster:auto-download",{rule:this.autoDownloadRule,at:this.autoDownloadRuleAt})},s.setDownloadQueueRule=function(e){t.excise(this._.pauseReasons,this.downloadQueueRule),t.excise(this._.pauseReasons,e),this.downloadQueueRule=e,this.downloadQueueRuleAt=t.epochMilliseconds(),APP.patron.choose("roster:download-queue",{rule:this.downloadQueueRule,at:this.downloadQueueRuleAt}),APP.network.check()},s._loadAutoDownloadRule=function(){var e=APP.patron.choice("roster:auto-download");if(e&&e.rule)for(var i=this.autoDownloadRules(),s=0,n=i.length;s<n;++s)if(e.rule[0]==i[s][0]){this.autoDownloadRule=e.rule,this.autoDownloadRuleAt=e.at||t.epochMilliseconds();break}this.autoDownloadRule||(this.autoDownloadRule=this.AUTO_DOWNLOAD_DEFAULT)},s._loadDownloadQueueRule=function(){var e=APP.patron.choice("roster:download-queue");if(e&&e.rule){var i=this.DOWNLOAD_QUEUE_RULES;this.downloadQueueRule=i[e.rule],this.downloadQueueRule&&(this.downloadQueueRuleAt=e.at||t.epochMilliseconds())}this.downloadQueueRule||(this.downloadQueueRule=this.DOWNLOAD_QUEUE_DEFAULT),APP.network.check()},s._onNetworkInfo=function(e){this._conformToNetworkConditions(e.m.network)},s._conformToNetworkConditions=function(e){APP.journal.debug("[AUDITOR] conform to network conditions",e),"stop"==this.downloadQueueRule&&this.pause("stop"),e.reachable&&t.among("offline",this._.pauseReasons)?this.resume("offline"):e.reachable||this.pause("offline"),"wifi"==this.downloadQueueRule&&("cellular"==e.connection?this.pause("wifi"):this.resume("wifi")),e.reachable&&t.each(APP.titles.luggages.all,function(e){e.refresh()},this)},s._onBifocalDownloadsPause=function(){t.defer(this,"bifocal-downloads"),this.pause("bifocal")},s._onBifocalDownloadsResume=function(){t.defer(this,"bifocal-downloads",this.resume.bind(this,"bifocal"),2e3)},s._onRosterAudit=function(e){this._performAudit(e.m.rosters)},s._performAudit=function(e){APP.events.dispatch("roster:audit",{documents:e,claimDocumentForId:this._claimDocumentForId.bind(this,e)}),t.each(e,function(e){e.id&&e.version&&APP.shell.transmit({name:"roster:wipe",roster:{role:e.role,group:e.group,id:e.id,version:e.version}})})},s._claimDocumentForId=function(e,i){var s,n=new r;return t.each(e,function(e){e.id==i&&(!s||"valid"==e.health&&"valid"!=s.health||n.assign(e.version)&&n.isNewerThan(s.version))&&(s=e)},this),e&&s&&t.excise(e,s),s},i}),define("app/base/rosters/updater",["require","common","app/base/rosters/roster"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("app/base/rosters/roster");return s.ROSTER_DEFAULTS={role:"system",group:"client",id:"dewey-js"},s.ROSTER_PATH="/roster.json",s.BANK_KEY_ROSTER="roster:dewey-js",s.UPDATE_READY_DELAY_MS=200,s.$init=function(){APP.events.on("debug:command",this._onDebugCommand.bind(this)),APP.events.on("app:update:check",this._onUpdateCheck.bind(this)),APP.events.on("app:update:available",this._onUpdateAvailable.bind(this)),APP.events.on("roster:audit",this._onRosterAudit.bind(this));var e=APP.bank.get(this.BANK_KEY_ROSTER),i=t.absorb(this.ROSTER_DEFAULTS,{version:APP.client.info.version.value});this.roster=new n(t.absorb(e,i))},s._onDebugCommand=function(e){var i=(e.m.command||"").match(/^(up|update)$/i);i&&(e.m.output+="[UPDATER] simulating update...",APP.journal.log("[UPDATER] simulating update..."),APP.scribe.record("app:update:simulate"),t.try(this.roster,"wipe()"),t.defer(this,"simulate",function(){APP.events.dispatch("app:update:available",{version:"0.0.0",silent:!1})},500))},s._onUpdateCheck=function(e){var i=APP.client.info.version,s=this.roster.version,n=e.m.version||i.value,r=e.m.relaunchIfOlderThan||i.value;if(n!=t.try(this.updating,"version")){var o=(s||i).isOlderThan(n);if(o=o||s&&s.isOlderThan(r)&&s.isNotSameAs(n),o=o||i.isOlderThan(r)&&i.isNotSameAs(n),i.isSameAs(n)&&i.isNotSameAs(s)&&(this.roster.wipe(),s=void 0,r=i,o=!0),o){var a=s&&s.isOlderThan(i.value)?s:i,l={version:n,current:i.value,prepped:t.try(s,"value"),relaunchIfOlderThan:r,silent:!a.isOlderThan(r)};!l.silent&&APP.lectern.bifocal.isRevealed||APP.events.dispatch("app:update:available",l)}}},s._onUpdateAvailable=function(e){t.defer(this,"update-ready"),this.updating=e.m||{version:APP.client.info.version.value},APP.journal.info("[UPDATER] preparing update:",this.updating),this._replaceRoster()||(this.roster.version.assign(this.updating.version),this._onUpdateReady())},s._onUpdateReady=function(){var e=t.excise(this,"updating");e&&(APP.journal.debug("[UPDATER] onUpdateReady",e),t.defer(this,"update-ready",function(){APP.events.dispatch("app:update:ready",e)},this.UPDATE_READY_DELAY_MS))},s._replaceRoster=function(){if(!APP.shell.has("rosters"))return!1;var e=t.try(this.updating,"version"),i=[APP.constants.ROOT_URI,this.ROSTER_PATH,"?"+(e||t.epochSeconds())].join("");return APP.events.off(this._.hMsgRosterResponse),this._.hMsgRosterResponse=APP.events.on("msg:roster:response",this._onMsgRosterResponse.bind(this,e,i)),APP.shell.transmit({name:"roster:request",url:i}),!0},s._onMsgRosterResponse=function(e,i,s){if(t.try(s.m,"url")==i&&t.try(this.updating,"version")==e)if(APP.events.off(this._.hMsgRosterResponse),s.m.rosters&&(t.try(s.m.response,"status")||600)<400){var r=t.flatten([s.m.rosters]).shift(),o=new n(r);o.initialize({onFinalize:this._onRosterFinalize.bind(this,e),onInvalidate:this._onRosterFailure.bind(this,e)})}else this._onRosterFailure(e)},s._onRosterFinalize=function(e,i){t.try(this.updating,"version")==e&&(this.roster=i,APP.bank.set(this.BANK_KEY_ROSTER,this.roster.serialize()),this._onUpdateReady())},s._onRosterFailure=function(e,i){t.try(this.updating,"version")==e&&t.excise(this,"updating")},s._onRosterAudit=function(e){var i=e.m.claimDocumentForId(this.ROSTER_DEFAULTS.id);this.updating||(this.roster.merge(t.absorb(i,{health:"invalid"})),"valid"!=this.roster.health&&(APP.journal.log("[UPDATER] roster-audit: replacing roster",this.roster),this._replaceRoster()))},i}),define("app/models/agents/library-agent",["require","common","./usage-agent"],function(e){var t=e("common"),i=e("./usage-agent"),s=i.new(),n=s.prototype;return n.TTL=864e5,n.MAX_BATCH_SIZE=24,n.BATCHING_MS=100,n._processBatch=function(e){APP.libraries.withBrandingOverrides(this._processBatchWithBranding.bind(this,e))},n._processBatchWithBranding=function(e){var i=[],s=[];if(t.each(e.queue,function(e){e.item.websiteId?i.push(e.item.websiteId):e.item.baseKey&&s.push(e.item.baseKey)}),e.requests=[],i.length){var n=APP.services.thunder.fetch("libraries/?websiteIds="+i.join(","),this._onRequestSuccess.bind(this,e),this._onRequestFailure.bind(this,e));e.requests.push(n)}if(s.length){var n=APP.services.thunder.fetch("libraries/?libraryKeys="+s.join(","),this._onRequestSuccessWithKeys.bind(this,e),this._onRequestFailure.bind(this,e));e.requests.push(n)}},n._onRequestSuccess=function(e,i,s){t.excise(e.requests,s);var n=JSON.parse(i);t.each(e.queue,function(i){var s;t.each(n.items,function(e){e.websiteId!=i.item.websiteId&&e.id!=i.item.baseKey&&e.preferredKey!=i.item.baseKey||(s=e,t.breakIteration())},this),s?(this._importTask(i,s),e.requests.length||this._succeedTask(i)):this._failTask(i)},this)},n._onRequestSuccessWithKeys=function(e,i,s){t.excise(e.requests,s);var n=JSON.parse(i),r=t.select(n.items,function(i){return t.each(e.queue,function(e){t.among(e.item.baseKey,i.id,i.preferredKey)&&(e.item.websiteId=i.websiteId)}),i.websiteId});if(t.each(e.queue,function(e){!e.item.websiteId&&e.item.baseKey&&e.item.baseKey.match(/^\d+$/)&&(t.among(e.item.baseKey,r)||r.push(e.item.websiteId=e.item.baseKey))}),r.length){var s=APP.services.thunder.fetch("libraries/?websiteIds="+r.join(","),this._onRequestSuccess.bind(this,e),this._onRequestFailure.bind(this,e));e.requests.push(s)}t.each(e.queue,function(e){e.item.websiteId||this._failTask(e)},this)},s}),define("app/models/agents/guides-agent",["require","common","./usage-agent"],function(e){var t=e("common"),i=e("./usage-agent"),s=i.new(),n=s.prototype;return n._processBatch=function(e){var t=e.queue[0].item,i=t.library.key(),s=APP.services.thunder.fetch("libraries/"+i+"/spotlights",this._onRequestSuccess.bind(this,e),this._onRequestFailure.bind(this,e)),n=APP.services.thunder.fetch("libraries/"+i+"/pages?useNew=true&includeCollectionDefinitions=true",this._onRequestSuccess.bind(this,e),this._onRequestFailure.bind(this,e));e.requests=[s,n]},n._onRequestSuccess=function(e,i,s){t.excise(e.requests,s),e.result=e.result||{};var n=e.queue[0],r=JSON.parse(i);if(r.Spotlights?e.result.spotlights=r.Spotlights:(t.excise("spotlights",r),t.absorb(r,e.result)),!e.requests.length){this._importTask(n,e.result);var o=e.queue[0].item;o.ensureSufficientGuides(this._succeedTask.bind(this,n))}},s}),define("app/models/agents/campaign-agent",["require","common","./usage-agent"],function(e){var t=(e("common"),e("./usage-agent")),i=t.new(),s=i.prototype;return s.TTL=864e5,s._processBatch=function(e){var t=e.queue[0].item,i=t.library.key(),s=APP.services.thunder.fetch("libraries/"+i+"/pages/home/campaigns/"+t.id,this._onRequestSuccess.bind(this,e),this._onRequestFailure.bind(this,e));e.requests=[s]},i}),define("app/models/items/campaign",["require","common","app/models/items/item","app/models/agents/usage","app/models/agents/campaign-agent"],function(e){var t=e("common"),i=e("app/models/items/item"),s=i.new(),n=s.prototype,r=e("app/models/agents/usage"),o=e("app/models/agents/campaign-agent");return n.$init=function(e,t,i){this.library=e,this.list=e.catalog.lists.produce("campaign-"+t),this.id=t,this.strapline=i,this.titles=[],this.startTime=0,this.endTime=1/0,this.data={},this.type=null,this.usage=new r(this,o)},n.isDisplayable=function(){return t.among(this.type,"campaign-book-club","campaign-call-to-action")&&!this.invalid&&!t.try(this.library.card(),"isVisiting")},n._transformAttributes=function(e,t){var i={};return i.startTime=this._utcStringToTime(e.start),i.endTime=this._utcStringToTime(e.end),i.data=this._descriptionMicrodata(e.description),i.titles=APP.titles.importAll(e.items,{source:"external",integrity:"incomplete"}),i},n._deserializeAttributes=function(e){i.prototype._deserializeAttributes.call(this,e),this._checkValidity()},n._checkValidity=function(){this.invalid=!1},n._descriptionMicrodata=function(e){var i,s={},n=t.element({html:e}),r=n.querySelector('[itemtype^="campaign-"]');if(s.type=r&&r.getAttribute("itemtype"),s.type){if((i=r.querySelector('[itemprop="campaign-strapline"]'))&&(s.strapline=i.innerHTML),(i=r.querySelector('[itemprop="campaign-article"]'))&&(s.article=i.innerHTML),i=r.querySelector('[itemprop="campaign-hook"]'))s.murmur=i.innerHTML;else if(i=r.querySelector('[itemprop="campaign-lede"]')){var o=t.try(s.article,"trim()")?"murmur":"article";s[o]=i.innerHTML}if((i=r.querySelector('img[itemprop="campaign-logo-image"][src]'))&&(s.images={logo:{src:i.src}},(i=r.querySelector('a[itemprop="campaign-logo-link"][href]'))&&(s.images.logo.link={href:i.href})),i=r.querySelector('meta[itemprop="campaign-color"]')){var a=(i.getAttribute("content")||"").trim();try{var l=t.hexToRGB(a);l&&l.length&&(s.colors={base:t.rgbToHex(l)})}catch(e){APP.journal.warn("[CAMPAIGN] invalid base color?",a)}}if(t.each(r.querySelectorAll('[itemprop="campaign-action-text"]'),function(e){var i={label:e.innerHTML},n=t.elementClosest(e,'a[itemprop="campaign-action-link"][href]');n&&(i.link={href:n.href}),s.actions=s.actions||[],s.actions.push(i)},this),i=r.querySelector('script[type="application/json"]'))try{t.absorb(JSON.parse(i.innerHTML),s)}catch(e){APP.journal.warn("[CAMPAIGN] could not parse JSON:",i.innerHTML)}return s.strapline&&(s.strapline=this._normText(s.strapline)),s.article&&(s.article=this._normText(s.article)),s.shout&&(s.shout=this._normText(s.shout)),s.murmur&&(s.murmur=this._normText(s.murmur)),t.each(s.actions,function(e){e.label&&(e.label=this._normText(e.label)),t.try(e.deadline,"label")&&(e.deadline.label=this._normText(e.deadline.label)),t.try(e.link,"href")&&(e.link.href=this._normURL(e.link.href))},this),t.each(s.images,function(e,i){i.src&&(i.src=this._normURL(i.src)),t.try(i.link,"href")&&(i.link.href=this._normURL(i.link.href))},this),t.each(s.colors,function(e,i){try{s.colors[e]=t.rgbToHex(t.hexToRGB(i),!0)}catch(t){s.colors[e]="#F0F"}},this),this.type=s.type,this.strapline=s.strapline||this.strapline,s}},n._normText=function(e){var i=(e||"").trim(),s=APP.arena._element({html:i}),n=s.querySelector("p");n&&(s.innerHTML=n.innerHTML),t.each(s.querySelectorAll("br"),function(e){e.parentNode.replaceChild(document.createTextNode(" "),e)}),t.each(s.querySelectorAll("a"),function(e){e.parentNode.replaceChild(APP.arena._element({tag:"span",html:e.innerText}),e)});var r=s.innerHTML;return r=r.replace(/eBook/,"ebook")},n._normURL=function(e){return"https://"+e.trim().replace(/^[^\/]*\/\//,"")},s}),define("app/models/items/guide",["require","common","app/models/items/campaign"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("app/models/items/campaign");return s.DEFAULT_LAYOUT_FLOW=["campaign","list","guides","campaign","extras"],s.THEMES={juvenile:{colors:{bg:"#FCDA60",ptn:"#F9C040",fg:"#F52386"},pattern:"hideout"},youngadult:{colors:{bg:"#9E23F5",ptn:"#6B21D8",fg:"#00B87D"},pattern:"graph-paper"},business:{colors:{bg:"#13293D",ptn:"#246",fg:"#006494"},pattern:"bank-note"},mystery:{colors:{bg:"#D90429",ptn:"#EF233C",fg:"#4B1D3F"},pattern:"random"},"language-es":{colors:{bg:"#941B0C",ptn:"#BC3908",fg:"#621708"},pattern:"temple"},"random-1":{colors:{bg:"#248232",ptn:"#2A8F3C",fg:"#2D3A3A"},pattern:"floor-tile"},"random-2":{colors:{bg:"#05342C",ptn:"#0B7465",fg:"#086C48"},pattern:"polka-dots"},"random-3":{colors:{bg:"#44B2F6",ptn:"#3CF",fg:"#133C55"},pattern:"hexagons"}},s.$init=function(e,s,r){if(this.library=e,this.parent=r,this.name=s.name,this.rank=(r||this.library.catalog).guides.length,this.filters=s.filters,this.thunderId=s.thunderId,this.introduction=s.introduction||"",this.layoutFlow=s.layoutFlow||[],t.isList(this.layoutFlow)&&this.layoutFlow.length||(this.layoutFlow=this.DEFAULT_LAYOUT_FLOW),t.among("guides",this.layoutFlow)||this.layoutFlow.push("guides"),t.among("extras",this.layoutFlow)||this.layoutFlow.push("extras"),this._.theme=s.theme,this.guideId=this.thunderId||this._.theme,this.lists=[],t.each(s.collections,function(e){e.source=e.source||"spotlight";var t=this.library.catalog.lists.produce(e.source+"-"+e.id);t.mergeAttributes(e),this.lists.push(t)},this),this.lists.sort(function(e,t){var i="number"==typeof e.priority?e.priority:1/0,s="number"==typeof t.priority?t.priority:1/0;return i-s}),this.filters){var o=t.absorb(this.filters,{name:this.name}),a=this.library.catalog.lists.produce("everything"),l=a.params.withRefinements({});l._applyThunderListDefinition(o),l=l.withRefinements(l.composite(!1,!0));var c=this.library.catalog.lists.produce(l.address());c._.name=this.name,this._.allTitlesList=c,this.lists.unshift(c)}this.campaigns=[],t.each(s.campaigns,function(e){this.campaigns.push(new n(this.library,e.id,e.name))},this),this.guides=[],t.each(s.guides,function(e){this.guides.push(new i(this.library,e,this))},this)},s.path=function(){return this.parent?this.parent.path()+"/"+this.guideId:this.library.path("guide/"+this.guideId)},s.theme=function(){var e=this.THEMES[this._.theme];if(e)return e;if(this.parent)return this.parent.theme();var t=(this.name+(this.introduction||"")).length%3+1;return this.THEMES["random-"+t]},i}),define("text!res/data/guides.json",[],function(){return'[\n  {\n    "theme": "home"\n  },\n  {\n    "theme": "juvenile",\n    "filters": {\n      "maturityLevels": ["juvenile"]\n    }\n  },\n  {\n    "theme": "youngadult",\n    "filters": {\n      "maturityLevels": ["youngadult"]\n    }\n  },\n  {\n    "theme": "mystery"\n  },\n  {\n    "theme": "business",\n    "filters": {\n      "subjects": ["8"]\n    }\n  }\n]\n'}),define("app/models/collations/guides",["require","common","app/models/agents/usage","app/models/agents/guides-agent","app/models/items/guide","shibui/src/phrasebook","text!res/data/guides.json"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("app/models/agents/usage"),r=e("app/models/agents/guides-agent"),o=e("app/models/items/guide"),a=e("shibui/src/phrasebook");return s.ARCHETYPES=JSON.parse(e("text!res/data/guides.json")),s.IGNORE_VIEWS=[/^EBOOKS$/i,/^AUDIOBOOKS$/i,/^VIDEOS$/i,/^PERIODICALS$/i],s.DEFAULT_GUIDE_THRESHOLD=4,s.DEFAULT_GUIDE_TITLE_MINIMUM=200,s.$init=function(e){this.usage=new n(this,r),this.library=e},s.find=function(e){for(var i,s=function(e,t){for(var i=0,s=t.length;i<s;++i)if(t[i].guideId==e)return t[i]},n=this.all,e=t.flatten(e);e.length;){if(i=s(e.shift(),n),!i)return;n=i.guides}return i},s.ensureSufficientGuides=function(e){var i=function(t){"function"==typeof e&&e(t)};if(this.all.length>=this.DEFAULT_GUIDE_THRESHOLD)return i(!0);var s=[];return t.each(this.ARCHETYPES.slice(1),function(e){for(var t=0,i=this.all.length;t<i;++t)if(this.all[t]._.theme==e.theme)return;s.push(e.theme)},this),s.length?void this.library.catalog.facets.freshen(function(e){var n=[];return t.each(s,function(i){var s=0;if("juvenile"==i||"youngadult"==i){var r=e.find({category:"audience",value:i})[0];r&&(s+=r.totalTitles)}else if("business"==i){var o=e.find({category:"subject",value:"8"})[0];o&&(s+=o.totalTitles)}else"mystery"==i&&t.each(["57","100"],function(t){var i=e.find({category:"subject",value:t})[0];i&&(s+=i.totalTitles)},this);s>=this.DEFAULT_GUIDE_TITLE_MINIMUM&&n.push(i)},this),t.each(n,function(e){if(!(this.all.length>=this.DEFAULT_GUIDE_THRESHOLD)){var t=this._transformRoomData({themeName:e});this.all.push(new o(this.library,t))}},this),i(!0)}.bind(this),i.bind(this,!1)):i(!1)},s._transformAttributes=function(e,i){var s={guides:[]};return this._.spotlightDefinitions=[],t.each(e.spotlights,function(e){return e.address?(this.library.catalog.lists.addListDefinition("spotlight",e),void this._.spotlightDefinitions.push(e)):APP.journal.warn("[GUIDES] spotlight missing address:",e)},this),t.each(e.items,function(e){var t=this._transformRoomData(e);t&&s.guides.push(t)},this),s},s._deserializeAttributes=function(e){this.home=null,this.all=[],t.each(e.guides,function(e){!this.home&&e.isDefault?this.home=new o(this.library,e):this.all.push(new o(this.library,e))},this)},s._transformRoomData=function(e){if(!this._shouldIgnoreRoom(e)){var i=this._deriveThemeFromRoomData(e),s=this._archetypeForTheme(i)||{},n={};n.isDefault=e.isDefault,n.layoutFlow=e.layoutFlow,n.theme=i,n.name=e.name||a.text("guide.info.name."+i),n.introduction=e.introduction||a.text("guide.info.introduction."+i,{},{okIfMissing:!0}),n.thunderId=e.id,n.filters=e.filters||s.filters||null,t.isEmpty(n.filters)&&(n.filters=null),n.campaigns=e.campaigns,n.collections=[];var r=e.views||[],o=r[0]||{};return t.each(o.collectionDefinitions,function(e){var t={};t.name=e.name,t.description=e.description,t.id=e.id,t.source=e.generatedCollectionDetails?"generated":"curated",this.library.catalog.lists.addListDefinition(t.source,e);for(var i=0,s=o.collections.length;i<s;++i)if(e.id==o.collections[i].id){t.priority=o.collections[i].order;break}n.collections.push(t)},this),this._addSpotlightsToGuideData(n,this._.spotlightDefinitions),n.guides=[],t.each(r.slice(1),function(e){var t=this._transformRoomData({name:e.name,theme:i,views:[e]});t&&(t.thunderId=t.thunderId||""+n.guides.length,n.guides.push(t))},this),n}},s._shouldIgnoreRoom=function(e){if(e.isEnabled===!1&&!e.isDefault)return!0;if(e.filters&&e.filters.mediaType&&!e.filters.mediaType.join().match(/magazine|periodical/))return!0;if(e.name)for(var t=0,i=this.IGNORE_VIEWS.length;t<i;++t){var s=this.IGNORE_VIEWS[t];if(e.name.match(s))return!0}return!1},s._deriveThemeFromRoomData=function(e){if(e.isDefault)return"home";for(var t=0,i=this.ARCHETYPES.length;t<i;++t){var s=this.ARCHETYPES[t];if(s.theme==e.themeName)return s.theme}var n,r=e.filters||{};if(n=r.subjects){if("8"==n.join())return"business";if(["57","100"].indexOf(n.join())>=0)return"mystery"}if(n=r.language)return"language-"+r.language[0];if(n=r.maturityLevels){if("juvenile"==n.join(","))return"juvenile";if("youngadult"==n.join(","))return"youngadult"}return e.themeName?e.themeName.replace(/-.*/,""):""},s._archetypeForTheme=function(e){for(var t=0,i=this.ARCHETYPES.length;t<i;++t){var s=this.ARCHETYPES[t];if(s.theme==e)return s}},s._addSpotlightsToGuideData=function(e,i){var s=[];t.each(i,function(t){t.isArchived||t.guidesWhitelist&&t.guidesWhitelist.indexOf(e.theme)<0||s.push(t.id)},this);var n=t.try(t.last(e.collections),"priority")||0;"home"==e.theme&&t.shuffle(s),t.each(s,function(t){e.collections.push({source:"spotlight",id:t,priority:++n})})},i}),define("app/models/items/list-facets",["require","common","shibui/src/phrasebook","app/models/collations/collation","app/models/items/title-fulfiller"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("shibui/src/phrasebook"),r=e("app/models/collations/collation");e("app/models/items/title-fulfiller");return s.CORE_FACET_CATEGORIES=["availability","mediaTypes","formats","maturityLevels","subjects","languages","boolean","addedDates"],s.SORT_RANKS=["languageformatreadingorder","relevance","mostpopular","newlyadded","releasedate","random"],s.FULFILLABLE_MAPPINGS={kindle:"ebook-kindle",epub:"ebook-epub-adobe",pdf:"ebook-pdf-adobe","ebook-epub-open":"ebook-epub-open","ebook-pdf-open":"ebook-pdf-open","media-do":"ebook-media-do"},s.VAGUE_SUBJECT_IDS=["26","111","49","43","45","44","127","128","129"],s.$init=function(e){this.list=e},s.isFresh=function(e){if(!t.try(this._.freshness,"timestamp"))return!1;if(t.try(e,"complete")&&!this._.freshness.complete)return!1;if(t.try(e,"withAlternatives")){if(!this._.freshness.ensured)return!1;var i=this._.freshness.ensured.slice(0).sort(),s=e.withAlternatives.slice(0).sort();if(i.join(",")!==s.join(","))return!1}return!0},s.freshen=function(e,i){var s=function(){return"function"==typeof i?i(this):APP.journal.warn("[LIST-FACETS] failure callback missing")}.bind(this);return this.list.isFaceted()?this.isFresh()?e(this):void this.list.params.freshen(function(i){var n=i.composite(!0);if(t.try(n,"invalidities.length"))return s();var r={maxItems:null};n.seed&&(r.seed=n.seed);var o=i.withRefinements(r).apiEndpoint({requiredFacets:this.CORE_FACET_CATEGORIES,perPage:0});APP.services.thunder.fetch(o,function(t){var i=JSON.parse(t),s=Math.min(i.totalItems,n.maxItems||1/0);this.import(i.facets,i.sortOptions,s),this._.freshness&&(this._.freshness.complete=!0),e(this)}.bind(this),s)}.bind(this),s):s()},s.withCountsForAlternatives=function(e,i){var s=["format","audience","language","fulfillable"];return this.isFresh({complete:!0,withAlternatives:s})?e(this):(this._.freshness&&(this._.freshness.complete||delete this._.freshness.timestamp,this._.freshness.ensured=[]),void this.freshen(function(){var i;this.format&&"readalong"==t.try(t.last(this.format),"value")&&(i=this.format.pop(),i.applied||t.each(this.format,function(e){e.applied&&"book"!=e.value&&(i=null)}));var n=function(n,r){var o=function(r){t.excise(s,n),r&&t.try(this._.freshness,"ensured.push()",n),s.length||(i&&this.format&&this.format.push(i),e(this))}.bind(this);if(!this[n])return o(!1);for(var a=t.select(r,function(e){return{category:n,value:e,totalTitles:1/0,applied:!1,innate:!1}}),l=0,c=r?r.length:1/0,h=0,u=this[n].length;h<u;++h){var p=this[n][h];if(p.innate)return o(!0);var d=r?r.indexOf(p.value):-1;d>=0?a[d]=p:a.push(p),l+=p.applied?1:0,c-=1}l>0&&(this[n]=a),l>0&&c>0?APP.patron.pins.pause(function(e){var i={};i[n+"s"]=null;var s=this.list.params.withRefinements(i).address(),a=this.list.library.catalog.lists.produce(s);a.facets.freshen(function(){e(),r?this[n]=t.select(this[n],function(e){if(e.totalTitles=t.try(t.select(a.facets[n],function(t){return t.value==e.value?t:void 0})[0],"totalTitles")||e.totalTitles,e.totalTitles&&isFinite(e.totalTitles))return e;
}):this[n]=t.select(a.facets[n],function(e){var i=t.select(this[n],function(t){return e.value==t.value?t:void 0}),s=i[0]||t.absorb({applied:!1,innate:!1},t.absorb(e,{}));return t.absorb({totalTitles:e.totalTitles},s)},this),o(!0)}.bind(this),function(){e(),o(!1)})}.bind(this),{scope:"title",category:n}):o(!0)}.bind(this);n("format",["book","audiobook","magazine"]),n("audience",["juvenile","youngadult","generalcontent","adultonly"]),n("language"),n("fulfillable",t.select(this.FULFILLABLE_MAPPINGS,function(e){return e}))}.bind(this),i))},s.import=function(e,i,s){var n=t.absorb(e,{});if(!t.isEmpty(n)&&(n.sorts={name:"Sort",items:i},this.totalTitles=this.totalTitles||this.list.totalTitles||s,this.list.totalTitles||(this.list.totalTitles=this.totalTitles),!this.list.invalidities&&!t.try(this._.freshness,"complete")&&(this._.facets=this._buildFacets(n)))){var r=t.excise(this._,"facets");t.absorb(r,this),this._.freshness={timestamp:t.epochMilliseconds(),complete:!(!r.sort||!r.format)}}},s.find=function(e){if(!this.isFresh())return[];var i;if(e.category){if(!this[e.category])return[];i=this[e.category].slice(0)}else i=t.flatten(t.select(this._.categories,function(e){return this[e]}.bind(this)));return r.prototype.filter.call(this,e,0,i)},s.hasAnyTitles=function(){return!(!this.totalTitles||!isFinite(this.totalTitles))},s._buildFacets=function(e){this._.categories=[];var i,s=this.list,r=s.params,o=r.composite(!0),a=t.try(r,"definition.refinements")||{},l=(s.library,function(e,s,n){t.among(e,this._.categories)||this._.categories.push(e),s.category=e,n.applied=n.applied||!1,n.encompass=!n.applied&&s.totalTitles==this.totalTitles,"sort"==e&&(n.encompass=t.excise(n,"innate")),n.innate=n.innate||!1;var r={scope:"title",category:e,value:s.value};s.pinnable=APP.patron.pins.isPinnable(r)&&("sort"==e||!a[e]),s.pinned=!!(n.applied&&s.pinnable&&APP.patron.pins.find(r)),t.absorb(n,s),i=i||{},i[e]=i[e]||[],i[e].push(s)}.bind(this));t.each(t.try(e,"sorts.items"),function(e){if("relevance"!=e.id||"search"==r.source.name){r.refinements.seed=e.seed||r.refinements.seed;var t={value:e.id,name:n.text("filter.sort-"+e.id,{},{okIfMissing:!0})};t.name&&(t.name=t.name.toLowerCase(),l("sort",t,{applied:e.isApplied,innate:e.isApplied&&r.refinements.sort!=t.value}))}}),t.each("spotlight"==s.params.source.name?{popular:"mostpopular",new:"newlyadded",random:"random"}:null,function(e,n){s.params.source.id==e&&(i.sort=t.select(i.sort,function(e){if(e.value==n)return e.innate=!0,e}))}),i&&i.sort&&i.sort.sort(function(e,t){var i=this.SORT_RANKS.indexOf(e.value),s=this.SORT_RANKS.indexOf(t.value);return i<0&&(i=1/0),s<0&&(s=1/0),i-s}.bind(this)),t.each(t.try(e,"mediaTypes.items"),function(e){var i=APP.constants.formats(e.id);i&&l("format",{value:i,totalTitles:e.totalItems},{applied:e.isApplied,innate:e.isApplied&&t.among(i,a.formats)})}),t.each(t.try(e,"boolean.items"),function(e){"t"!=e.id&&"Has audio synchronized text"!=e.id||l("format",{value:"readalong",totalTitles:e.totalItems,flagParam:"flagReadalong"},{applied:e.isApplied,innate:e.isApplied&&a.flagReadalong})},this);var c=t.try(e,"availability.items");if(c){var h={available:{thunderId:"available-now",flagParam:"flagAvailable"},prerelease:{thunderId:"prerelease",flagParam:"flagPrerelease"}},u=[];t.each(h,function(e,i){var n={value:e,totalTitles:0,flags:{applied:!1,innate:!1}};t.each(c,function(e){e.id==i.thunderId&&(n.totalTitles=e.totalItems||1/0,n.flagParam=i.flagParam,n.flags.applied=e.isApplied,t.breakIteration())}),n.totalTitles&&(u.push(n),"undefined"==typeof n.flags.applied&&i.flagParam&&(n.flags.applied=o[i.flagParam]),t.try(r,"definition.refinements."+i.flagParam)?n.flags.innate=!0:"available"==e&&s.isLuckyDay(o)&&(n.flags.innate=!0,n.flags.applied=!0),n.flags.innate&&n.flags.applied&&(u=[n],t.breakIteration()))}),t.each(u,function(e){l("availability",e,t.excise(e,"flags"))})}t.each(t.try(e,"addedDates.items"),function(e){l("days",{value:e.id.replace(/^days-/,""),totalTitles:e.totalItems},{applied:e.isApplied,innate:e.isApplied&&t.among(e.id,a.days)})}),t.each(t.try(e,"maturityLevels.items"),function(e){l("audience",{value:e.id,totalTitles:e.totalItems},{applied:e.isApplied,innate:e.isApplied&&t.among(e.id,a.audiences)})}),t.each(this.FULFILLABLE_MAPPINGS,function(i,s){var n=t.select(t.try(e,"formats.items"),function(e){if(e.id===s)return e})[0],r=t.try(n,"isApplied")||t.among(i,o.fulfillables);(n||r)&&l("fulfillable",{value:i,totalTitles:t.try(n,"totalItems")||1/0},{applied:r,innate:r&&t.among(i,a.fulfillables)})},this);var p=t.flatten(a.subjects||[]);t.each(t.try(e,"subjects.items"),function(e){var i=APP.constants.bestNameForSubject(e.id,e.name);i&&l("subject",{value:e.id,name:i,totalTitles:e.totalItems},{applied:e.isApplied,innate:e.isApplied&&(t.among(e.id,p)||e.id==r.source.id&&"subject"==r.source.name)})}),t.each(t.try(e,"languages.items"),function(e){var i=n.text("language.code-"+e.id,{},{okIfMissing:!0});i&&l("language",{value:e.id,name:i,totalTitles:e.totalItems},{applied:e.isApplied,innate:e.isApplied&&t.among(e.id,a.languages)})});var d;return"auto"==s.params.refinements.scope?d=!0:"deep"==s.params.refinements.scope?d=!this.hasAnyTitles():s.meetsDeepSearchCriteria({manualThreshold:!0})&&(d=!1),"boolean"==typeof d&&l("scope",{value:"deep",totalTitles:1/0},{applied:!!s.params.refinements.scope,innate:d}),i},i}),define("app/models/items/list",["require","common","app/models/items/list-parameters","app/models/items/list-facets"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("app/models/items/list-parameters"),r=e("app/models/items/list-facets");return s.PAGE_SIZE=24,s.MANUAL_DEEP_SCOPE_THRESHOLD=99,s.DEEP_SEARCHABLE_SOURCES=["search","creator","publisher","imprint","series","subject","award"],s.$init=function(e,t){this.library=e,this.params=new n(e,t),this.facets=new r(this),this._.pages=[],this._.ranges=[],APP.services.thunder.freshmaker(this,{failWithStale:!1})},s.resolve=function(){return this.library.catalog.lists.produce(this.params.address())},s.isPaginated=function(){return!t.among(this.params.source.name,["similar","campaign"])},s.isFaceted=function(){return!t.among(this.params.source.name,["similar","campaign","issues"])},s.freshen=function(e,i,s,n){var r=this._range(e,i);this._.ranges.push(r);var o={onSuccess:function(){t.excise(this._.ranges,r),s(this,this._titlesInRange(r))}.bind(this),onFailure:function(){t.excise(this._.ranges,r);var e=n||APP.services.thunder.onServiceFailure;e.apply(this,arguments)}.bind(this)};this.freshness.isFreshening()?(this._addRangeToFreshening(r),this.freshness.serviceAddCallbacks(o)):this.params.freshen(this._onFreshParams.bind(this,o),o.onFailure)},s.indexOf=function(e){for(var t=e.titleId,i=0,s=this._.pages.length;i<s;++i){var n=this._.pages[i];if(n&&n.titles&&n.titles.length)for(var r=0,o=n.titles.length;r<o;++r)if(n.titles[r]&&n.titles[r].titleId==t)return n.offset+r}return-1},s.getColor=function(e){var i=this.library.colors(),s=this.params.source.name,n=t.among(s,"spotlight","curated","search")?0:1;return e(i[n].hex)},s.mergeAttributes=function(e){e.basedOn&&APP.titles.produce({titleId:e.basedOn.id}).import(e.basedOn,{source:"external",integrity:"incomplete"}),delete this._.name,delete this._.description,this.library.catalog.lists.rubric(this,e),"number"==typeof e.priority&&(this.priority=e.priority),"number"==typeof e.totalItems?this.totalTitles=e.totalItems:this.totalTitles=this.totalTitles||t.try(e,"items.length")||0,e.breakpoint&&(this.params.refinements.breakpoint=e.breakpoint),this.facets.import(e.facets,e.sortOptions,e.totalItems)},s.name=function(){return this._.name=this._.name||this.library.catalog.lists.rubric(this).name()},s.description=function(){return this._.description=this._.description||this.library.catalog.lists.rubric(this).description()},s.path=function(e){return this._paramsToPath(this.params,e||1)},s.subpath=function(e){return this._paramsToPath(this.params.withRefinements(e||{}))},s.maxPages=function(){return"number"!=typeof this.totalTitles?1/0:Math.ceil(this.totalTitles/this.PAGE_SIZE)},s.isLuckyDay=function(e){return e=e||this.params.composite(),e.flagAvailableLuckyDay||e.flagAvailableLuckyDayOnly},s.meetsDeepSearchCriteria=function(e){if(!this.library.allowDeepSearch)return!1;if(t.among(this.params.refinements.scope,"deep","auto"))return!1;if(t.try(e,"searchOnly")){if(!this.params.refinements.query)return!1;if("search"!=this.params.source.name)return!1}else if(!t.among(this.params.source.name,this.DEEP_SEARCHABLE_SOURCES))return!1;var i=this.library.catalog.lists.produce(this.params.rootAddress());if("number"!=typeof i.totalTitles&&(i=this),i==this||t.try(e,"recursing")){if(!i.totalTitles)return 0===i.totalTitles;var s=0;return e&&"number"==typeof e.manualThreshold?s=e.manualThreshold:e&&e.manualThreshold&&(s=this.MANUAL_DEEP_SCOPE_THRESHOLD),!(i.totalTitles>s)}return i.meetsDeepSearchCriteria(t.absorb(e,{recursing:!0}))},s.banners=function(e){var i,s={};t.each(this.library.catalog.lists.BANNER_DATA,function(e){s[e.id]=e});var n=function(i,n){n&&!t.excise(s,i)||(n||(s[i]="-"),"function"==typeof e&&(n||t.select(s,function(e,t){if("-"!=t)return t}).length)&&(e(n?[n]:[]),e=null))};t.each(t.absorb(s,{}),function(e,r){if(t.try(r.content,SPARK.locale.tag)){var o=n.bind(this,e),a=["list-banner",this.library.websiteId,e].join(":");t.each(r.conditions,function(l){if(!s[e])return o();if(l.websiteIds&&"*"!=l.websiteIds&&!t.among(this.library.websiteId,l.websiteIds))return o();var c=t.epochMilliseconds();if(l.dateRange){if(l.dateRange[0]>c)return o();if(l.dateRange[1]<c)return o()}if(l.undismissAfterMS){var h=c-APP.patron.dismissedAt(a);if(h<l.undismissAfterMS)return o()}else if(APP.patron.isDismissed(a))return o();var u=t.select(l.parameters,function(e){i=i||this.params.composite(!0);var s=t.select(e.split(/\s*\|\s*/),function(e){var s=e.trim().match(/^(\!)?([^:]+):([^:]+)(:(.*))?$/);if(!s)return!1;var n=s[1],r=s[2],o=s[3],a=s[5],l=t.compact(t.flatten([i[r]])),c=!1;if("none"==o)c=!l.length;else if("is"==o&&a){var h=a.split(",").sort();c=h.join(",")==l.sort().join(",")}else if("has"==o&&"query"==r){var u=l.join(",").toLowerCase();c=u.indexOf(a.toLowerCase())>=0}else"has"==o&&a&&t.each(a.split(","),function(e){c=c||t.among(e,l)});return n?!c:!!c},this);return t.among(!0,s)},this);if(t.among(!1,u))return o();var p=t.absorb(r,{});if(p.conditions=[l],p.dismissKey=a,l.catalog){var d=this.library.catalog.lists.produce("everything");d.facets.freshen(function(i){var s=t.select(l.catalog,function(e){var s=t.select(e.split(/\s*\|\s*/),function(e){var s=e.trim().match(/^(\!)?([^:]+):([^:]+)(:(.*))?$/);if(!s)return!1;var n=!1,r=s[1],o=s[2],a=s[3],l=s[5],c=i.find({category:o,value:l});return"none"==a?n=!c.length:"has"==a?n=!!t.try(c,"[0].totalTitles"):"is"==a&&(n=1==c.length&&c[0].totalTitles>0),r?!n:!!n},this);return t.among(!0,s)},this);return t.among(!1,s)?o():void n(e,p)}.bind(this),o)}else n(e,p)},this)}},this)},s._range=function(e,t){!isFinite(t)&&this.totalTitles&&(t=this.totalTitles);for(var i,s={start:e,end:t,pages:[]},n=Math.floor(s.start/this.PAGE_SIZE);!i||i.offset+i.length<s.end;){i=this._.pages[n],i||(i={},i.index=n,i.offset=n*this.PAGE_SIZE,i.titles=[],i.length=0,this._.pages[n]=i);var r=Math.min(this.PAGE_SIZE,s.end-i.offset);if(i.length<r&&(i.length=r,i.freshAt=0),s.pages.push(i),!isFinite(s.end))break;n+=1}return s},s._isFresh=function(){if(!this.params.freshness.isFresh())return!1;for(var e=0,t=this._.ranges.length;e<t;++e)for(var i=0,s=this._.ranges[e].pages.length;i<s;++i)if(!this._isFreshPage(this._.ranges[e].pages[i]))return!1;return!0},s._isFreshPage=function(e){return!(e.freshAt<APP.freshHorizon)&&(e.pinSignature==APP.patron.pins.signature("title")&&e.freshAt+36e5>t.epochMilliseconds())},s._requestOptionsForPage=function(e,t){var i={},s=this.params.apiEndpoint();return this._.baseAPIURL==s&&this.facets.isFresh()?i.includeFacets=!1:i.includedFacets=this.facets.CORE_FACET_CATEGORIES,i.perPage=this.PAGE_SIZE,i.page=t.index+1,this._.baseAPIURL=s,{url:this.params.apiEndpoint(i),onFetch:this._parseFreshenPageResponse.bind(this,t)}},s._parseFreshenPageResponse=function(e,i){var s=JSON.parse(i),n=this.library.key();t.each(s.items,function(e){e.libraryKey=n}),e.titles=APP.titles.importAll(s.items,{source:"external",integrity:"incomplete"}),this.mergeAttributes(s),this._onFreshPage(e)},s._onFreshParams=function(e){var i=this.params.composite(!0);if(i.invalidities.length)return this.mergeAttributes({}),this.invalidities=i.invalidities,APP.journal.warn("[LIST] invalidities:",this.params.address(),this),e.onFailure();delete this.invalidities;var s=[];t.each(this._.ranges,function(e){t.each(e.pages,function(t){this._isFreshPage(t)||(t.request=this._requestOptionsForPage(e,t),s.push(t.request))},this)},this),APP.services.thunder.freshen(this,s,e)},s._onFreshPage=function(e){e.request=null,e.freshAt=t.epochMilliseconds(),e.pinSignature=APP.patron.pins.signature("title"),t.each(this._.ranges,function(e){if(isFinite(e.end)){if(this.totalTitles<e.end)for(t.absorb(this._range(e.start,this.totalTitles),e);this._.pages.length>this.maxPages();){var i=this._.pages.pop();i.request&&(this.freshness.servicePassURL(i.request.url),i.request.abort())}}else t.absorb(this._range(e.start,this.totalTitles),e),this._addRangeToFreshening(e)},this)},s._addRangeToFreshening=function(e){t.each(e.pages,function(t){t.request||this._isFreshPage(t)||(t.request=this._requestOptionsForPage(e,t),APP.services.thunder.extendFreshenWithRequest(this,t.request))},this)},s._titlesInRange=function(e){var i=[];return t.each(e.pages,function(t){var s=Math.max(e.start-t.offset,0),n=Math.min(t.length,e.end-t.offset);i=i.concat(t.titles.slice(s,n))},this),i},s._paramsToPath=function(e,t){var i=e.address()+"/page-"+(t||1);return"library"==APP.router.realm?this.library.path(i):"search"==APP.router.realm?this.library.path(i).replace(/^library/,"search"):APP.router.realm+"/"+i},i}),define("app/models/items/list-rubric",["require","common","shibui/src/phrasebook","app/models/items/campaign"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("shibui/src/phrasebook"),r=e("app/models/items/campaign");return s.keysForList=function(e){var i=t.try(e,"params.source")||{};if(i.name&&i.id)return[i.name,i.id];if("search"==i.name&&e.params.refinements.query)return["search"];if("search"==i.name&&!e.params.refinements.query){if(SPARK.locale.isEnglish){e.params.composite(!0);return["search","advanced","XXX"]}return["search","advanced"]}return t.try(e.params,"refinements.flagAvailableLuckyDayOnly")||t.try(e.params,"definition.refinements.flagAvailableLuckyDayOnly")?["skip-the-line"]:[i.name]},s.become=function(e,i){i&&(this._.name=this._normalizeName(i.name||i.title),this._.description=null);var s=t.try(e,"params.applyDefinition()");!this._.name&&t.try(s,"name")&&(this._.name=this._normalizeName(s.name)),t.try(s,"description")&&(this._.description=this._normalizeDescription(s.description));var o=this.keysForList(e),a=o[0],l=t.try(i,"queryKeys");if("subject"==a){var c=o[1];if(!c&&l){var h=e.params.composite(!0);t.each(l.subjects,function(e){e.id==h.subjects[0]&&(c=e.id)},this)}c&&(this._.name=this._.name||e._.name||n.text("list.source.subject"),this._.name=APP.constants.bestNameForSubject(c,this._.name))}else if("campaign"==a&&this._.description){var u=new r(e.library,this._.name),p=u._descriptionMicrodata(this._.description);this._.description=t.try(p,"lede")||this._.description}if(this._.name&&this._.description)return this;if(this._.name=this._.name||n.text("list.source."+a),"search"==a&&"advanced"==o[1]){if(this._.name=n.text("list.advanced-search"),o[2]){var d=[],h=e.params.composite(!0);t.each(["title","creator","series","identifier"],function(e){if(h[e]){var i={title:"that match",creator:"where a creator matches",series:"where the series matches",identifier:"where the ISBN is"}[e];i+=" &ldquo;"+t.safe(decodeURIComponent(h[e]))+"&rdquo;",d.push(i)}},this),this._.description="Listing titles "+t.listToSentence(d)+"."}}else if("search"==a)this._.name=n.text("search.results.crumb");else if("skip-the-line"==a)this._.name=n.text("lucky-day.list-name"),this._.description=n.text("lucky-day.list-description");else if("similar"==a){var m=APP.titles.produce({titleId:e.params.source.id});this._.description=n.text("list.desc.similar",{TITLE:m.titleWithoutOrphans()||void 0})}else if("award"==a){var f=this._awardFromTitles(e);this._.name=t.try(f,"description")||this._.name,this._.description=n.text("list.desc.award",{SOURCE:t.try(f,"source")})}else"creator"==a&&t.try(l,"creator")?this._.name=l.creator.name:"series"==a&&t.try(l,"series")?this._.name=l.series.name:"series"==a&&i?this._.name=t.try(i,"items[0].detailedSeries.seriesName")||this._.name:"publisher"==a&&t.try(l,"publisher")?this._.name=l.publisher.name:"imprint"==a&&t.try(l,"imprint")&&(this._.name=l.imprint.name);if(!this._.description&&this._.name){var g={"most-popular":"list.desc.most-popular","available-now":"list.desc.available-now","too-hot-to-hold":"list.desc.too-hot-to-hold","just-added":"list.desc.just-added","newly-added":"list.desc.just-added"}[this._.name.toLowerCase().trim().replace(/[^\w]+/,"-")];if(g){var h=e.params.composite(!0),b=1==h.formats.length?h.formats[0]:void 0;this._.description=n.text(g,{FORMAT:b})}}},s.name=function(){return this._.name},s.description=function(){return this._.description},s._normalizeName=function(e){return e?t.titleize(this._normalizeDescription(e)):""},s._normalizeDescription=function(e){return e=e||"",e=e.replace(/(^|[^\w\/])e-?book/gi,function(e){var t=RegExp.$1,i=!t||e.match("E")?"B":"b";return t+i+"ook"}),e=e.replace(/(^|[^\w\/])e-?audiobook/gi,function(e){var t=RegExp.$1,i=!t||e.match("E")?"A":"a";return t+i+"udiobook"})},s._awardFromTitles=function(e){var i=e.params.source.id,s=t.try(e._.pages,"[0].titles");if(s)for(var n=0,r=s.length;n<r;++n)for(j=0,jj=s[n].awards.length;j<jj;++j)if(i==s[n].awards[j].id)return s[n].awards[j]},i}),define("text!res/data/spotlights.json",[],function(){return'[\n  {\n    "id": "new",\n    "address": "everything/sort-newlyadded/max-1000",\n    "head": "What’s New?",\n    "lede": "Here are all the titles our librarians have recently added to the catalog.",\n    "i18n": {\n      "head": "whats-up.slice.new",\n      "lede": "list.desc.just-added"\n    }\n  },\n  {\n    "id": "popular",\n    "address": "everything/sort-mostpopular/max-1000",\n    "head": "What’s Popular?",\n    "lede": "The hottest titles in the library right now. If it’s not available, place a hold!",\n    "i18n": {\n      "head": "whats-up.slice.popular",\n      "lede": "list.desc.most-popular"\n    }\n  },\n  {\n    "id": "random",\n    "address": "everything/sort-random",\n    "head": "Random!",\n    "lede": "All the titles in our catalog, randomized for serendipitous discoveries.",\n    "i18n": {\n      "head": "whats-up.slice.random",\n      "lede": "list.desc.random"\n    }\n  },\n  {\n    "id": "available",\n    "address": "everything/available/sort-mostpopular",\n    "head": "What’s Available?",\n    "lede": "A selection of popular titles you don’t have to wait for. Borrow one and start reading right away!",\n    "i18n": {\n      "head": "whats-up.slice.available",\n      "lede": "list.desc.available-now"\n    }\n  },\n\n\n  {\n    "id": "books",\n    "address": "everything/books",\n    "head": "Books",\n    "i18n": {\n      "head": "format.book.plural"\n    }\n  },\n  {\n    "id": "audiobooks",\n    "address": "everything/audiobooks",\n    "head": "Audiobooks",\n    "i18n": {\n      "head": "format.audiobook.plural"\n    }\n  },\n  {\n    "id": "magazines",\n    "address": "everything/magazines/sort-mostpopular",\n    "head": "Magazines",\n    "i18n": {\n      "head": "format.magazine.plural"\n    }\n  },\n  {\n    "id": "readalongs",\n    "address": "everything/readalong/books",\n    "head": "Read-alongs",\n    "lede": "Everyone can relax and enjoy storytime with these narrated books. Let us read the words aloud and turn the pages for you. 🎶",\n    "i18n": {\n      "head": "list.name.spotlight-readalongs",\n      "lede": "list.desc.spotlight-readalongs"\n    }\n  },\n  {\n    "id": "kindle",\n    "address": "everything/fulfillable-kindle",\n    "head": "Read With Kindle",\n    "lede": "All the books in this list are compatible with Amazon’s ereaders. We’ve made it easy to borrow and send them to your Kindle!",\n    "i18n": {\n      "head": "list.name.spotlight-kindle",\n      "lede": "list.desc.spotlight-kindle"\n    }\n  },\n\n\n  {\n    "id": "newsstand",\n    "address": "everything/override-availability,format,fulfillable/magazines/sort-mostpopular",\n    "head": "Newsstand",\n    "i18n": {\n      "head": "crumb.newsstand"\n    }\n  }\n]\n'}),define("text!res/data/list-banners.json",[],function(){return'[{\n  "id": "2024-03-time-magazine",\n  "conditions": [{\n    "parameters": [\n      "query:has:time",\n      "formats:none | formats:is:magazine",\n      "audiences:none | audiences:has:generalcontent"\n    ],\n    "catalog": [\n      "format:has:magazine"\n    ],\n    "dateRange": [ 1711684800000, 1714536000000 ],\n    "undismissAfterMS": 600000\n  }],\n  "content": {\n    "en-US": {\n      "prompt": [\n        "Information about the availability of TIME Magazine at your library.",\n        "<strong>Learn more.</strong>"\n      ],\n      "details": [\n        "<p>",\n          "Effective March 29, 2024, you can no longer borrow",\n          "digital copies of TIME Magazine at your library through Libby.",\n          "We sincerely apologize for the inconvenience.",\n        "</p>",\n        "<h2>",\n          "Do you have alternatives?",\n        "</h2>",\n        "<p>",\n          "Yes, we have a number of periodicals on current affairs.",\n          "We invite you to explore these lists of similar titles",\n          "to TIME Magazine.",\n        "</p>"\n      ]\n    }\n  },\n  "exits": [{\n    "list": "subject-1176/language-en/sort-mostpopular",\n    "label": {\n      "en-US": "News <span class=\'amp\'>&amp;</span> Politics Magazines"\n    }\n  }]\n}, {\n  "id": "2023-02-economist",\n  "conditions": [{\n    "parameters": [\n      "query:has:economist",\n      "formats:none | formats:is:magazine",\n      "audiences:none | audiences:has:generalcontent"\n    ],\n    "catalog": [\n      "format:has:magazine"\n    ],\n    "dateRange": [ 1675227600000, 1678939200000 ],\n    "undismissAfterMS": 600000\n  }, {\n    "parameters": [\n      "formats:is:magazine",\n      "query:none",\n      "subjects:none | subjects:has:1176 | subjects:has:1197",\n      "audiences:none | audiences:has:generalcontent"\n    ],\n    "dateRange": [ 1675227600000, 1678939200000 ],\n    "undismissAfterMS": 86400000\n  }],\n  "content": {\n    "en-US": {\n      "prompt": [\n        "Information about the availability of The Economist at your library.",\n        "<strong>Learn more.</strong>"\n      ],\n      "details": [\n        "<img src=\'https://images.overdrive.com/misc/libby-list-banner/economist-header.png\' alt=\'Logo for The Economist magazine.\' />",\n        "<p>",\n          "Effective February 1, 2023, you can no longer borrow",\n          "digital copies of The Economist at your library through Libby.",\n          "We sincerely apologize for the inconvenience.",\n        "</p>",\n        "<h2>",\n          "Why did this happen?",\n        "</h2>",\n        "<p>",\n          "The removal is due to newly-required lending model changes",\n          "by The Economist that are not compatible with how other magazines",\n          "are made available in Libby.",\n        "</p>",\n        "<h2>",\n          "Do you have alternatives?",\n        "</h2>",\n        "<p>",\n          "Yes! We have a number of periodicals on current affairs in",\n          "global politics and finance. We invite you to explore these",\n          "lists of similar titles to The Economist.",\n        "</p>"\n      ]\n    }\n  },\n  "exits": [{\n    "list": "subject-1176/language-en/sort-mostpopular",\n    "label": {\n      "en-US": "News <span class=\'amp\'>&amp;</span> Politics Magazines"\n    }\n  }, {\n    "list": "subject-1197/language-en/sort-mostpopular",\n    "label": {\n      "en-US": "Business <span class=\'amp\'>&amp;</span> Finance Magazines"\n    }\n  }]\n}]\n'}),define("app/models/collations/lists",["require","common","app/models/items/list","app/models/items/list-rubric","text!res/data/spotlights.json","text!res/data/list-banners.json"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("app/models/items/list"),r=e("app/models/items/list-rubric");return s.SPOTLIGHT_DATA=JSON.parse(e("text!res/data/spotlights.json")),s.BANNER_DATA=JSON.parse(e("text!res/data/list-banners.json")),s.$init=function(e){this.library=e,this._reset(),APP.events.on("app:refresh",this._reset.bind(this)),t.each(this.SPOTLIGHT_DATA,this.addListDefinition.bind(this,"spotlight"))},s.produce=function(e){return this._lookup(e)||this.add(this.make(e),e)},s.make=function(e){return this._lookup(e)||new n(this.library,e)},s.add=function(e,t){return this.all.indexOf(e)<0&&(this.all.push(e),this._cache()[t||e.params.address()]=e),e},s.find=function(e){e.source&&e.id&&e.format&&APP.journal.warn("[LISTS] Use fetch(), not find() for this:",e);var i=[],s=",",n=e.source,r=e.id&&e.id.join?e.id.join(s):e.id,o=e.format;return"*"==o&&(o=""),o&&o.join&&(o=o.join(s)),t.each(this.all,function(e){if("string"!=typeof n||n==e.params.source.name){if("string"==typeof r){var t=e.params.source.id;if("subject"==e.params.source.name&&(t=e.params.refinements.subjects.join(s)),r!=t)return}"string"==typeof o&&o!=e.params.refinements.formats.join(s)||i.push(e)}}),i.sort(this._compareLists),i},s.listDefinition=function(e,t){if(this._.listDefinitions&&this._.listDefinitions[e]){var i=t+"";return this._.listDefinitions[e][i]}},s.addListDefinition=function(e,i){var s=JSON.parse(JSON.stringify(i));s[e+"CollectionDetails"]&&t.absorb(t.excise(s,e+"CollectionDetails"),s);var n=s.id+"";return this._.listDefinitions=this._.listDefinitions||{},this._.listDefinitions[e]=this._.listDefinitions[e]||{},this._.listDefinitions[e][n]=s},s.rubric=function(e,t){var i=new r,s=i.keysForList(e).join(":");return this._.rubrics[s]?(i=this._.rubrics[s],t&&i.become(e,t)):(i.become(e,t),this._.rubrics[s]=i),i},s._reset=function(){this.all=[],this._.cache={},this._.rubrics={}},s._compareLists=function(e,t){if("number"==typeof e.priority||"number"==typeof t.priority){var i="number"==typeof e.priority?e.priority:1/0,s="number"==typeof t.priority?t.priority:1/0;return i-s}return e.name<t.name?-1:1},s._lookup=function(e){return this._cache()[e]},s._cache=function(){var e=t.try(APP,"patron.pins.signature()","title")||"base";return this._.cache=this._.cache||{},this._.cache[e]=this._.cache[e]||{}},i}),define("app/models/agents/ntc-agent",["require","common","./usage-agent"],function(e){var t=(e("common"),e("./usage-agent")),i=t.new(),s=i.prototype;return s.TTL=864e5,s._processBatch=function(e){var t=e.queue[0].item,i=APP.services.ntc.fetch("provider-subscriptions?libraryKey="+t.library.key(),this._onRequestSuccess.bind(this,e),this._onRequestFailure.bind(this,e));e.requests=[i]},i}),define("app/models/items/ntc-provider",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.$init=function(e,t){this.library=e,this._deserializeAttributes(t)},s.colorize=function(e,i){i=t.absorb(i,{delay:1}),APP.coverGuru.paint(e,"extras-brand",t.try(this.colors,"brand"),i),APP.coverGuru.paint(e,"extras-background",t.try(this.colors,"background"),i)},s.optimizedAssetURL=function(e,i){var s=t.try(e,"image.url");if(s){if(!s.match("od-cdn"))return s;if(s.match(/svg$/i))return s;var n=APP.coverGuru.coverProxy.optimizationParameters({width:500,url:t.relativeURL(encodeURI(decodeURI(s)))});return t.parameterizeURL("https://ic.od-cdn.com/resize",n)}},s.open=function(){var e=APP.patron.extras.find({"title.reserveId":this.reserveId});e?e.fulfiller.open({fftType:"ntc"}):APP.nav.go(this.library.path("extras/"+this.providerId+"/request"))},s._deserializeAttributes=function(e){e.providerId=e.titleId=e.slug,t.absorb(e,this)},i}),define("app/models/collations/ntc-providers",["require","common","app/models/agents/usage","app/models/agents/ntc-agent","app/models/items/ntc-provider"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("app/models/agents/usage"),r=e("app/models/agents/ntc-agent"),o=e("app/models/items/ntc-provider");return s.$init=function(e){this.usage=new n(this,r),this.library=e},s.active=function(){var e=[];return t.each(this.all,function(i){"active"==t.try(i,"subscription.status")&&e.push(i)},this),e},s.hasActive=function(){return this.active().length>0},s.find=function(e){if(this.all)for(var t=0,i=this.all.length;t<i;++t)if(this.all[t].titleId==e||this.all[t].reserveId==e)return this.all[t]},s.produce=function(e){var t=this.find(e);return t?t:(this._.stubs=this._.stubs||{},this._.stubs[e]?this._.stubs[e]:this._.stubs[e]=new o(this.library,{slug:e}))},s._deserializeAttributes=function(e){this.all=t.select(e,function(e){var i=this._.stubs&&t.excise(this._.stubs,e.slug);return i?(i._deserializeAttributes(e),i):new o(this.library,e)},this)},i}),define("app/models/items/catalog",["require","common","app/models/collations/guides","app/models/collations/lists","app/models/collations/ntc-providers"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("app/models/collations/guides"),r=e("app/models/collations/lists"),o=e("app/models/collations/ntc-providers");return s.$init=function(e){this.library=e,this.guides=new n(this.library),this.lists=new r(this.library),this.extras=new o(this.library),this.facets=this.lists.produce("everything/override").facets},i}),define("app/models/items/library",["require","common","app/models/items/item","app/models/agents/usage","app/models/agents/library-agent","app/models/items/catalog"],function(e){var t=e("common"),i=e("app/models/items/item"),s=i.new(),n=s.prototype,r=e("app/models/agents/usage"),o=e("app/models/agents/library-agent"),a=e("app/models/items/catalog");return n.DEFAULT_COLORS=[{hex:"#006693",rgb:[0,102,147]},{hex:"#74CEE2",rgb:[116,206,226]}],n.HUMAN_TYPES={DLR:"Public Library",SDL:"School Library",CDL:"College Library",Corporate:"Corporate Library"},n.$init=function(){this.usage=new r(this,o),this.type="Public Library",this.catalog=new a(this),APP.events.on("card:load:all",this._computeActiveKey.bind(this)),APP.events.on("card:update:all",this._computeActiveKey.bind(this))},n.card=function(){return APP.patron.cards.find({"library.websiteId":this.websiteId})},n.cards=function(){return APP.patron.cards.filter({"library.websiteId":this.websiteId})},n.key=function(){return this._.activeKey||this.baseKey},n.path=function(e){var t=this.baseKey||this._.activeKey;return t?"library/"+t+(e?"/"+e:""):this.websiteId?APP.interviews.path("interview/locate-library/resolve",{websiteId:this.websiteId,next:e}):void 0},n.safeName=function(e){var i=this.rawName(e);return this._.userAssignedName?t.safe(i):i},n.rawName=function(e){if(this._.userAssignedName)return this._.userAssignedName;if("short"==e){if(this._.shortName)return this._.shortName;if(this._.name.length<20)return this._.shortName=this._.name;var i=[],s=this._.name.split(/\b/),n=this.baseKey.toLowerCase(),r=!1;return t.each(s,function(e){var t=e.toLowerCase();n.indexOf(t)<0||(i.push(e),r=r||["public","library","system"].indexOf(t)<0)}),r&&i.join(" ").length<20?this._.shortName=i.join(" "):this._.shortName=n.toUpperCase()}return this._.name},n.colors=function(){var e=(this._.userAssignedColors||[]).slice(0,2);for(!e.length&&this._.colors&&this._.colors.length&&(e[0]=this._.colors[0]||this._.colors[1],e[1]=this._.colors[1]||this._.colors[0]),e.length||this.reuse();e.length<2;)e.push(this.DEFAULT_COLORS[e.length]);var i,s,n=function(e,i,s){return e[1]=e[1]>10&&e[1]<95?Math.min(i[1],Math.max(i[0],e[1])):e[1],e[2]=Math.min(s[1],Math.max(s[0],e[2])),t.hsluvToRGB(e)},r=[];if(t.each(e,function(e,n){r[n]=t.rgbToHSLuv(APP.coverGuru.rgbForColor(e.rgb||e.hex));
var o=r[n][1]-50;o=o>0?.5*o:Math.abs(o);var a=o+Math.abs(r[n][2]-50);("number"!=typeof s||a<i)&&(s=n,i=a)},this),"number"==typeof s&&r[s][1]>20){var o=n(r[s],[35,75],[40,50]);e.push({hex:t.rgbToHex(o),rgb:o});var a=n(r[(s+1)%2],[10,85],[45,75]);e.push({hex:t.rgbToHex(a),rgb:a})}else t.each(APP.libraries.DEFAULT_COLORS,e.push.bind(e));return e},n.withProxiedLogoURL=function(e){this.use(function(t){var i=this._proxiedLogoURL();return i||t.isBroken||t.isIdeal?void e(i):this.reuse()},this)},n.systemAndBranchAttributes=function(){return{name:this._.name,websiteId:this.websiteId,branchCount:this.branchCount,branch:this.branch}},n.absorbBranchAttributes=function(e){"number"==typeof e.branchCount&&(this.branchCount=e.branchCount),e.branch&&(this.branch=e.branch),this.collation.save()},n.dereference=function(e){if("Merged"!=this.status||!this.mergerLibraryKey)return this;if(e=t.flatten([e]),t.among(this.mergerLibraryKey,e))return null;var i=APP.libraries.produce({baseKey:this.mergerLibraryKey});return i.dereference(e.concat([this.mergerLibraryKey]))},n._transformAttributes=function(e,i){var s={};s.websiteId=e.websiteId+"",s.baseKey=e.preferredKey,s.name=e.name,s.type=this.HUMAN_TYPES[e.type],s.status=e.status,"Merged"==s.status&&(s.mergerMessage=t.try(e,"messages[0].message"),s.mergerLibraryKey=e.mergedLibraryKey);var n=t.try(e,"links");if(n&&(s.urls=this.collation.consolidateURLs(n)),e.settings){s.colors=[];var r;(r=e.settings.primaryColor)&&s.colors.push({hex:r.hex,rgb:[r.rgb.red,r.rgb.green,r.rgb.blue]}),(r=e.settings.secondaryColor)&&s.colors.push({hex:r.hex,rgb:[r.rgb.red,r.rgb.green,r.rgb.blue]}),(s.logo=e.settings.logo140X60)&&(s.logo={url:s.logo.href})}return t.each(e.formats,function(e){"ebook-kindle"==e.id&&(s.promotesKindle=!0)}),s.hasInstantCards=e.isInstantAccessEnabled,s.visitableWebsiteIds=e.visitableLibraries,s.isLuckyDayEnabled=e.isLuckyDayEnabled,s.hasLuckyDayTitles=e.areLuckyDayTitlesAllocated,s.allowDeepSearch=e.allowDeepSearch||APP.flags.isOn("deep-search"),"undefined"==typeof e.allowAnonymousSampling&&"complete"!=i.integrity||(s.allowAnonymousSampling=e.allowAnonymousSampling!==!1),s.allowThunderHistory=e.isReadingHistoryEnabled,s},n._deserializeAttributes=function(e){this.logo=t.excise(e,"logo")||this.logo,this.urls=t.excise(e,"urls")||this.urls||{},t.each(["name","colors","userAssignedName","userAssignedColors"],function(i){var s=t.excise(e,i);s&&(this._[i]=s)},this),i.prototype._deserializeAttributes.call(this,e),this.websiteId&&(this.websiteId=this.websiteId+"",this.collation.applyBrandingOverrides(this),this._resolveBranch())},n._serializeAttributes=function(){var e={},i=function(t){if("undefined"!=typeof this[t])return e[t]=this[t]}.bind(this);return i("websiteId"),i("baseKey"),i("type"),i("logo"),i("urls"),i("promotesKindle"),i("hasInstantCards"),i("visitableWebsiteIds"),i("activatedAt"),e.name=this._.name,this._.userAssignedName&&(e.userAssignedName=this._.userAssignedName),e.colors=this._.colors,this._.userAssignedColors&&(e.userAssignedColors=this._.userAssignedColors),this.branch&&(e.branch=t.absorb(this.branch,{}),t.excise(e.branch,"system"),t.excise(e.branch,"systems"),t.excise(e.branch,"systemIds")),i("branchCount"),e},n._computeActiveKey=function(){var e=this.card(),i=this._.activeKey||this.baseKey,s=(e?e.advantageKey:null)||this.baseKey;if(s!=i)return this._.activeKey=s,i&&(APP.journal.warn('[LIBRARY] active key changed: "%s" <=> "%s"',i,s),this._.catalogs=this._.catalogs||{},this._.catalogs[i]=this.catalog,this.catalog=this._.catalogs[s]||new a(this),this==APP.library&&t.defer(this.collation,"refresh",APP.refresh.bind(APP,["library","search"]))),s},n._proxiedLogoURL=function(){var e=t.try(this.logo,"url");if(e){var i=t.relativeURL(encodeURI(decodeURI(e)));return["/thunder-assets",i].join("")}},n._resolveBranch=function(){t.try(this.branch,"id")&&"number"!=typeof this.branch.latitude&&"complete"!=this.branch.integrity&&APP.services.dewey.fetch("locate/branches/"+this.websiteId,function(e){try{var i=JSON.parse(e);t.each(i.branches,function(e){e.id==this.branch.id&&t.breakIteration(this.branch=e)},this),this.branch.integrity="complete",t.defer(this.collation,"resolve-branch",this.collation.save.bind(this.collation),3e3)}catch(e){APP.journal.warn("[LIBRARY] failed to parse branches",e)}}.bind(this))},s}),define("app/models/collations/libraries",["require","common","./collation","app/base/rosters/roster","app/models/items/library"],function(e){var t=e("common"),i=e("./collation"),s=i.new(),n=s.prototype,r=e("app/base/rosters/roster");return n.ITEM_CLASS=e("app/models/items/library"),n.ITEM_NAME="library",n.PERSIST_RECENT_LIBRARIES_LIMIT=5,n.DEFAULT_COLORS=[{hex:"#A81C49",rgb:[168,28,73]},{hex:"#631A35",rgb:[99,26,53]}],n.ROSTER_DEFAULTS={role:"system",group:"logos",id:"library-logos",version:"1.0.0"},n.$init=function(){i.prototype.$init.apply(this,arguments),APP.shell.has("rosters")&&(APP.events.on("roster:audit",this._onRosterAudit.bind(this)),APP.events.on("library:add",this._onChangeInItems.bind(this)),APP.events.on("library:remove",this._onChangeInItems.bind(this)))},n.now=function(e){if(e&&e!=APP.library){var i=APP.library;APP.library=e,APP.library.activatedAt=t.epochMilliseconds(),this.save(),i&&t.each(["search","library"],function(e){t.try(APP.router,"route.realm")!=e&&APP.router.rebuild(e)}),t.defer(this,"switch",this._announceSwitch.bind(this))}},n.restore=function(){return this.loadingLock(function(){this.now(this.all.slice(0).sort(this._byRecentActivation.bind(this))[0]),t.each(this.all,function(e){e.use(function(){e.reuse()})}),APP.library||this.paintColors()}.bind(this))},n.findActivatableLibrary=function(e){var i=this.withKey(e);if(i&&i.status&&!t.among(i.status,"Hidden","Merged","Deleted","Terminated"))return i},n.withKey=function(e){var t=this.find({baseKey:e});if(t)return t;for(var i=0,s=APP.patron.cards.all.length;i<s;++i)if(APP.patron.cards.all[i].advantageKey==e)return APP.patron.cards.all[i].library},n.withCards=function(){var e=[];return t.each(APP.patron.cards.all,function(t){e.indexOf(t.library)<0&&e.push(t.library)}),e},n.recent=function(e){var i=[],s=this.withCards();return t.each(this.all,function(e){e.safeName()&&e.activatedAt&&(s.indexOf(e)>=0||i.push(e))}),e=e||this.PERSIST_RECENT_LIBRARIES_LIMIT,i.sort(this._byRecentActivation.bind(this)).slice(0,e)},n.includingNow=function(e){if(!APP.library)return e;var t=this.excludingNow(e);return t.unshift(APP.library),t},n.excludingNow=function(e){if(!APP.library)return e;var i=[];return t.each(e,function(e){e!=APP.library&&i.push(e)}),i},n.byOldestCard=function(e){var i=function(e){var i=1/0;return t.each(e.cards(),function(e){i=Math.min(i,e.createTime)}),i};return e.slice(0).sort(function(e,t){return i(e)-i(t)})},n.paintColors=function(e,i,s){i=i||document.documentElement,s=s||{delay:0};var n=s.colors||t.try(e||APP.library,"colors()")||this.DEFAULT_COLORS.concat(this.DEFAULT_COLORS);return t.each(n,function(e,t){APP.coverGuru.paint(i,"library-"+(t+1),e.hex,s)},this),n},n.withBrandingOverrides=function(e){if(this._.brandingOverrides)return e();if(this._.brandingOverridesRequest)return this._.brandingOverridesQueue.push(e);var i=function(e){if(e)try{e=JSON.parse(e)}catch(t){e={}}this._.brandingOverrides=e||{},t.each(this._.brandingOverridesQueue,function(e){e()}),delete this._.brandingOverridesQueue,delete this._.brandingOverridesRequest}.bind(this);this._.brandingOverridesQueue=[e],this._.brandingOverridesRequest=APP.services.dewey.fetch({url:"branding/libraries.json",timeout:5e3},i,i.bind(this,{}))},n.applyBrandingOverrides=function(e){if(e._=e._||{},"function"!=typeof e.colors&&(e._.colors=e._.colors||e.colors||[],e.colors=function(){return e._.colors}),"function"!=typeof e.safeName&&(e._.name=e._.name||e.name||"",e.safeName=function(){return t.safe(name)}),e.styling){var i=t.excise(e,"styling");e.logo=e.logo||{url:t.try(i,"logos[0].sourceUrl")},i.secondaryColor&&(e._.colors[0]=e._.colors[0]||i.secondaryColor),i.secondaryColor&&(e._.colors[1]=e._.colors[1]||i.primaryColor)}if(e.links){var s=t.excise(e,"links");e.urls=this.branchAndLibraryURLs({links:s},e)}if(!this._.brandingOverrides)return e;if(!this._.brandingOverrides[e.websiteId])return e;var n=this._.brandingOverrides[e.websiteId];return!n.key||!e.baseKey||n.key==e.baseKey||n.keys&&t.among(e.baseKey,n.keys)?(e._.name=n.name||e._.name,e.logo=(n.logomarks||n.logos||[])[0]||e.logo,t.each(n.colors,function(t,i){e._.colors=e._.colors||[],e._.colors[i]=t}),t.each(n.urls,function(t,i){e.urls=e.urls||{},e.urls[t]=i||e.urls[t]}),e):(APP.journal.warn("[LIBRARIES] key mismatch in overrides",n,e),e)},n.libraryAndBranchURLs=function(e,i){e=e||APP.library||{},i=i||e.branch||{};var s=t.absorb(e.urls||e.links,{}),n={BranchSupportPhone:i.phoneNumber};return t.each(i.links,function(e){n[e.name]=e.url}),t.absorb(this.consolidateURLs(s),this.consolidateURLs(n))},n.branchAndLibraryURLs=function(e,i){i=i||APP.library||{},e=e||i.branch||{};var s=t.absorb(i.urls||i.links,{}),n={BranchSupportPhone:e.phoneNumber};return t.each(e.links,function(e){n[e.name]=e.url}),t.absorb(this.consolidateURLs(n),this.consolidateURLs(s))},n.consolidateURLs=function(e){e=t.absorb(e,{});var i={};return t.isEmpty(e)?i:(t.each({libraryHome:"home",librarySupportUrl:"support",librarySupportEmail:"supportEmailAddress",librarySupportPhone:"supportPhoneNumber",cardAcquisitionUrl:"cardAcquisition",BranchLibraryUrl:"home",BranchSupportUrl:"support",BranchSupportEmail:"supportEmailAddress",BranchSupportPhone:"supportPhoneNumber",BranchCardAcquisitionUrl:"cardAcquisition",home:"home",support:"support",supportEmailAddress:"supportEmailAddress",supportPhoneNumber:"supportPhoneNumber",cardAcquisition:"cardAcquisition"},function(s,n){var r=t.excise(e,s),o=r?r.href||r.url:null;return"string"==typeof r&&(o=r),o&&o.match(/frontline\.overdrive/)?i.hasFrontlineSupport=!0:void(o&&!o.match(/overdrive\.com/)&&(i[n]=o))}),i.support==i.home&&delete i.support,t.among(i.cardAcquisition,[i.home,i.support])&&delete i.cardAcquisition,i.supportEmailAddress&&!i.supportEmailAddress.match(/^mailto:/)&&(i.supportEmailAddress="mailto:"+i.supportEmailAddress),i.supportPhoneNumber&&!i.supportPhoneNumber.match(/^tel:/)&&(i.supportPhoneNumber="tel:"+i.supportPhoneNumber.replace(/[\s]+/g,"-").replace(/[\(\)]+/g,"")),i)},n._announceSwitch=function(){t.defer(this,"switch"),APP.library?APP.library.use(function(e,t){e.isIdeal||t.reuse(),this.paintColors()},this):this.paintColors(),APP.events.dispatch("library:switch",{library:APP.library})},n._serializeItems=function(){var e=[],i=function(t){e.push(t.export())};return t.each(this.withCards(),i),t.each(this.recent(),i),e},n._attributesToQuery=function(e){return e.websiteId?{websiteId:e.websiteId+""}:{baseKey:e.baseKey||e.libraryKey||e.key}},n._byRecentActivation=function(e,t){return t.activatedAt-e.activatedAt},n._onRosterAudit=function(e){var i=e.m.claimDocumentForId(this.ROSTER_DEFAULTS.id);i&&i.health&&this.roster&&(this.roster.health=i.health),t.defer(this,"roster",this._updateLogosRoster.bind(this),1e3)},n._onChangeInItems=function(){t.defer(this,"roster",this._updateLogosRoster.bind(this),1e3)},n._updateLogosRoster=function(){this._generateLogoRosterEntries(function(e){if(this.roster&&"invalid"!=this.roster.health){var i=t.select(this.roster.entries,function(e){return t.relativeURL(e.url)}),s=t.select(e,function(e){return t.relativeURL(e.url)});if(i.sort().join(",")==s.sort().join(","))return}this.roster=new r(this.ROSTER_DEFAULTS),this.roster.merge({entries:e}),this.roster.initialize({})}.bind(this))},n._generateLogoRosterEntries=function(e){var i=[],s=t.select(this.all,function(e){return e.websiteId});t.each(this.all,function(n){n.withProxiedLogoURL(function(r){t.excise(s,n.websiteId),r&&i.push(r),s.length||e(t.select(i.sort(),function(e){return{url:e,bytes:2e4}}))})})},s}),define("app/models/items/title-mirror",["require","common","./title"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("./title");return s.DEFAULT_SAMPLE_DURATION_MS=3e5,s.reflect=function(e,i,s){this.options=t.absorb(s,this.options||{library:APP.library});var r={titles:[],possessions:[],covers:[],infos:[],cycle:[],recycle:[],changed:!0,callback:i};this._.batches=this._.batches||[],this._.batches.push(r),t.each(e,function(e,i){var s=e instanceof n?e:e.title;r.titles.push(s),r.cycle.push(s.titleId),t.among(e.type,"loan","magazine")&&(r.possessions[i]=e)},this),t.each(r.titles,function(e,t){e.use(this._reflectTitle.bind(this,r,e,t))},this)},s._reflectTitle=function(e,i,s){if(!(this._.batches.indexOf(e)<0)){e.covers[s]=APP.coverGuru.coverURLForTitle(i,{proxied:!0,usage:"local"})||window.location.origin+APP.constants.filePath("images/cover-404.png");var n=function(t,n){!t.usage.state.isIdeal&&"failed"!=t.usage.state.work&&APP.network.reachable&&(n&&APP.journal.debug("[TITLE-MIRROR] recycling because:",n,i.title),t.reuse(this._reflectTitle.bind(this,e,i,s)),e.recycle.push(i.titleId))}.bind(this),r=e.possessions[s],o=this._prepareInfo(e,i,r,s,n);e.changed=e.changed||JSON.stringify(o)!=JSON.stringify(e.infos[s]),e.infos[s]=o,t.excise(e.cycle,i.titleId),e.cycle.length||this._recycleBatch(e)}},s._recycleBatch=function(e){e.cycle=[],e.recycle.length||t.excise(this._.batches,e),e.callback(e),e.cycle=e.recycle,e.recycle=[],e.changed=!1},s._prepareInfo=function(e,i,s,n,r){var o={};o.id=i.titleId,o.title=i.title||r(i,"missing title"),o.creator=i.attribution()||r(i,"missing attrib"),o.format=i.format||r(i,"missing format"),o.cover=e.covers[n]||r(i,"missing cover url");var a=i.cover.color;if(a||(r(i,"missing color"),a=APP.coverGuru.DEFAULT_COLOR_RGB),o.coverColor=t.rgbToHex(a),o.coverYIQ=t.colorYIQ(a),o.coverHSLuv=t.rgbToHSLuv(a),o.coverTint=o.coverHSLuv[2]>=70?"light":"dark","audiobook"==i.format&&(o.duration=i.duration||r(i,"missing duration")),"magazine"==i.format||t.try(s,"card")){o.sample=!1;var l=i.journey();o.createTime=o.accessTime=l.timestamp,o.createTime=t.try(s,"createTime")||o.createTime,t.try(s,"expireTime")&&(o.expireTime=s.expireTime),o.readingProgress=l.progress,o.downloadProgress=t.try(s,"luggage().status().bytes.percent")||0;var c=t.try(s,"card.advantageKey");c=c||t.try(s,"library.key()"),c=c||t.try(APP.library,"key()"),o.paths={openbook:t.try(s,"passport().urls.openbook")},"magazine"==i.format&&c?o.paths.open=["open","magazine",c,i.titleId].join("/"):"loan"==s.type&&(o.paths.open=["open","loan",i.titleId].join("/")),t.try(s,"library")&&(o.library={key:c,name:s.library.safeName(),colors:s.library.colors()})}else if(o.sample=!0,"audiobook"==i.format&&(o.duration=Math.min(this.DEFAULT_SAMPLE_DURATION_MS,.2*(o.duration||1/0))),o.paths={},this.options.library){var h=this.options.library.key();o.paths.open=["open/sample",h,i.titleId].join("/")}return o.active=i.titleId==t.try(APP.title,"titleId"),o},i}),define("app/base/multi-step-task",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.$init=function(e){this.uuid=t.generateUUID(),this.extend(e)},s.extend=function(e){return e=t.absorb(e,{}),this._.callbacks=this._.callbacks||{},"undefined"!=typeof e.timeout&&this.timeoutToFail(t.excise(e,"timeout")),t.each(e,function(e,i){return"undefined"==typeof i?t.excise(this,e):e.match(/^on[A-Z]\w*/)?void(("function"==typeof i||t.isList(i)&&"function"==typeof i[0])&&(this._.callbacks[e]=t.compact(t.flatten([this._.callbacks[e],i])))):this[e]=i},this),this.journal=this.journal||APP.journal,this},s.check=function(e){return!this._.aborted&&(!(arguments.length&&!e)&&(!e||e.uuid==this.uuid))},s.hasCallback=function(e){var i=t.try(this._.callbacks,e);return i&&i.length&&"function"==typeof i[0]},s.invoke=function(e,i){if(this._.invoking)return APP.journal.debug("[MST] invoke() during invocation?");this._.invoking=this._.lastInvoked=e,t.try(i,"length")||(i=[this]),t.each(t.try(this._.callbacks,e),function(e){e.apply(this,i)},this),delete this._.invoking;var s=["onSuccess","onFailure","onAborted","onOrphaned"];t.among(e,s)&&t.defer(this,"expiry")},s.timeoutToFail=function(e){var i=e;if("number"==typeof i&&isFinite(i)&&i){var s={id:"task-timeout",milliseconds:i};t.defer(this,"expiry",this.fail.bind(this,s),i)}else t.defer(this,"expiry")},s.succeed=function(){return this._.aborted?(this.journal.warn("[MST] success after abort?"),this._.result):(this._.result=this.invoke("onSuccess",arguments),delete this._.callbacks,this._.result)},s.fail=function(){return this._abortAndInvoke("onFailure",arguments)},s.abort=function(){return this._abortAndInvoke("onAborted",arguments)},s.orphan=function(){return this._abortAndInvoke("onOrphaned",arguments)},s.abortOnNextNavigation=function(e){APP.events.off(t.excise(this._,"hRouterNavigate")),e!==!1&&(this._.hRouterNavigate=APP.events.once("router:navigate",this.abort.bind(this)))},s._abortAndInvoke=function(e,i){if(!this._.aborted)return this._.aborted=!0,e&&(this._.result=this.invoke(e,i)),delete this._.callbacks,t.try(this.request,"abort()"),this._.result},i}),define("app/models/items/passport",["require","common","./item","app/base/multi-step-task"],function(e){var t=e("common"),i=e("./item"),s=i.new(),n=s.prototype,r=e("app/base/multi-step-task");return n.DEFAULT_REQUEST_TIMEOUT_MS=15e3,n.MESSAGE_RECENTLY_USED_MS=5e3,n.MESSAGE_STALE_MS=6e4,n.prepare=function(e){if(e=t.absorb(e,{timeout:this.DEFAULT_REQUEST_TIMEOUT_MS}),t.try(this._.taskTData,"check()"))this._.taskTData.extend(e),this._.taskTData.journal.log("Piggy-backing passport callbacks onto task");else if(this.tData)t.try(e,"onSuccess()",this);else{t.try(this._.taskTData,"abort()");var i=this._.taskTData=new r(e);this.title.use(this._prepareTitleDetails.bind(this,i))}},n.acquire=function(e){t.try(this._.taskURLs,"check()")?(this._.taskURLs.extend(e),this._.taskURLs.journal.log("Piggy-backing passport callbacks onto task")):this.prepare({journal:t.try(e,"journal"),timeout:t.try(e,"timeout"),onSuccess:this._acquireDervishURLs.bind(this,e),onFailure:t.try(e,"onFailure")})},n.urlFor=function(e,i){i="function"==typeof i?{onSuccess:i}:t.absorb(i,{}),i.onSuccess=i.onSuccess||function(){},i.onFailure=i.onFailure||i.onSuccess;var s=t.try(this.urls,e);if(s&&i.withMessage===!1)return i.onSuccess(s);var n=this.urlIsValidFor(e),r=this.message({markAsUsed:!0});if(n&&r)s+="?"+r;else if(!n||i.withMessage)return i.failIfMissing?i.onFailure(null):this.acquire({onSuccess:this.urlFor.bind(this,e,{withMessage:!0,failIfMissing:!0,onSuccess:i.onSuccess,onFailure:i.onFailure}),onFailure:i.onFailure.bind(this,null),timeout:i.timeout});i.onSuccess(s)},n.urlIsValidFor=function(e){if(!t.try(this.urls,e))return!1;var i=this.expiresAt||0;i+=t.try(this.collation,"gracePeriod")||0;var s=t.epochMilliseconds();if(i<s+1e3)return!1;if(this._.message){var n=t.try(this._.message,"usedAt")||0;if(!n&&this._.message.staleAt<s)return!1;if(s-n<this.MESSAGE_RECENTLY_USED_MS)return!1}return!0},n.message=function(e){if(this._.message){var i=t.epochMilliseconds();if(t.try(e,"markAsUsedAndAccepted")&&(this._.message.usedAt=Math.min(this._.message.usedAt,i-(this.MESSAGE_RECENTLY_USED_MS+1))),!(this._.message.usedAt||i>this._.message.staleAt))return t.try(e,"markAsUsed")&&(this._.message.usedAt=i),this._.message.m}},n.isInGoodStanding=function(){return!!this.urlIsValidFor("web")&&(!APP.shell.has("ui:bifocal-webview")||this.urlIsValidFor("openbook"))},n.possession=function(){if(this.cardId){var e={"title.titleId":this.titleId,"card.cardId":this.cardId};return APP.patron.loans.find(e)||APP.patron.magazines.find(e)}},n.save=function(){this.cardId&&this.collation.save({delay:0})},n.attemptFailure=function(){this._.attemptFailures=(this._.attemptFailures||0)+1},n.attemptSuccess=function(){delete this._.attemptFailures},n.reattempt=function(){this._.attemptFailures&&(t.try(t.excise(this._,"taskTData"),"abort()"),t.try(t.excise(this._,"taskURLs"),"abort()"),APP.network.reachable&&(delete this.tData,delete this.urls,delete this._.message,this.save()))},n._prepareTitleDetails=function(e,i,s){if(!e.check(this._.taskTData))return e.orphan();if(!s.format)return i.isBroken?(e.journal.warn("  ... could not use title to create codex"),this._preparationComplete(e,{error:"title-fetch-failure"})):(e.journal.log("Fetching title details for tData"),s.reuse());e.journal.log("  Title:",s.title),e.journal.log("  Format:",s.format),this.tData={codex:{title:{}}},this.tData.codex.title.titleId=s.titleId,this.tData.codex.title.slug=s.titleId,this.tData.codex.title.cover={},this.tData.codex.title.cover.imageURL=APP.coverGuru.coverURLForTitle(s,{proxied:!0,usage:"local"})||window.location.origin+APP.constants.filePath("images/cover-404.png");var n=t.rgbToHex(s.cover.color||APP.coverGuru.DEFAULT_COLOR_RGB);this.tData.codex.title.cover.color=n,e.journal.log("  Color:",n);var r=this.possession();r&&"loan"==r.type&&(this.tData.codex.loan={psnKey:r.psnKey},this.tData.codex.loan.slug=r.psnKey),this.library?this.library.use(this._prepareLibraryDetails.bind(this,e)):this._preparationComplete(e)},n._prepareLibraryDetails=function(e,i,s){if(!e.check(this._.taskTData))return e.orphan();if(!s.baseKey||!s.websiteId||!s.safeName())return i.isBroken?(e.journal.warn("  ... could not use library to create codex"),this._preparationComplete(e)):(e.journal.log("Fetching library details for tData"),s.reuse());e.journal.log("  Library:",s.safeName()),this.tData.codex.library={key:s.key(),name:s.safeName(),logoURL:t.try(s.logo,"url")};var n=s.colors(),r=[n[0].hex,n[1].hex];this.tData.codex.library.colors=r,this._preparationComplete(e)},n._preparationComplete=function(e,i){return e.check(this._.taskTData)?(t.excise(this._,"taskTData"),t.try(i,"error")?e.fail({id:i.error}):e.succeed(this),void this.save()):e.orphan()},n._acquireDervishURLs=function(e){APP.journal.info("[PASSPORT] acquiring URLs",e,this.title.titleId),e=t.absorb(e,{timeout:this.DEFAULT_REQUEST_TIMEOUT_MS});var i=this._.taskURLs=new r(e);i.request=APP.sentry.fetchDervishPassport({title:this.title,cardId:this.cardId,library:this.library,tData:this.tData,timeout:e.timeout},this._onAcquiredDervishURLs.bind(this,i),this._onAcquisitionFailure.bind(this,i))},n._onAcquiredDervishURLs=function(e,i){return e.check(this._.taskURLs)?(this.urls=t.absorb(i.urls,{}),this._.message={m:i.message,staleAt:t.epochMilliseconds()+this.MESSAGE_STALE_MS},this.expiresAt=parseFloat(i.expires)?1e3*i.expires:1/0,this.bankScope=i.bankscope,t.excise(this._,"taskURLs").succeed(this),"magazine"==this.title.format&&this.cardId&&APP.patron.magazines.setCardForIssue(this.title,this.cardId,this.expiresAt),void this.save()):e.orphan()},n._onAcquisitionFailure=function(e,i){return e.check(this._.taskURLs)?void t.excise(this._,"taskURLs").fail(i,this):e.orphan()},n._deserializeAttributes=function(e){t.absorb(this.collation._attributesToQuery(e),e),e.titleId&&!e.title&&(e.title=APP.titles.produce({titleId:e.titleId})),e.websiteId&&!e.library&&(e.library=APP.libraries.produce({websiteId:e.websiteId}));var s=t.compact([t.excise(e,"psnKey"),t.excise(e,"loanSlug")])[0];return!e.cardId&&s&&(e.cardId=s.replace(/-.*/,"")),e.tData&&t.excise(e.tData,"_task"),e.urls&&t.excise(e.urls,"_task"),e.bankScope&&(this.bankScope=t.excise(e,"bankScope"),this.bankScope=this.bankScope.replace(/^(title-)?/,"title-")),i.prototype._deserializeAttributes.call(this,e)},n._serializeAttributes=function(){var e={},t=function(t){this[t]&&(e[t]=this[t])}.bind(this);return t("titleId"),t("websiteId"),t("cardId"),t("psnKey"),t("bankScope"),t("expiresAt"),t("tData"),t("urls"),e},s}),define("app/models/collations/passports",["require","common","./collation","app/models/items/passport"],function(e){var t=e("common"),i=e("./collation"),s=i.new(),n=s.prototype;return n.ITEM_CLASS=e("app/models/items/passport"),n.ITEM_NAME="passport",n.BANK_PREFIX="title:",n.SAVE_DELAY=2e3,n.ANNOUNCE=!0,n.FIND_WITH_ATTRS_TO_QUERY=!0,n.load=function(){var e=i.prototype.load.apply(this,arguments);return APP.events.on("loan:remove",this._onPossessionRemove.bind(this)),APP.events.on("magazine:remove",this._onPossessionRemove.bind(this)),e},n._attributesToQuery=function(e){var i={};return i.titleId=e.titleId||t.try(e.title,"titleId"),i.websiteId=e.websiteId||t.try(e.library,"websiteId"),e.hasOwnProperty("cardId")&&(i.cardId=e.cardId),i},n._serializeItems=function(){return t.select(this.all,function(e){if(e.cardId&&this._isValidItem(e))return e.export()},this)},n._onPossessionRemove=function(e){this._removeForPossession(t.try(e,"m.item"))},n._removeForPossession=function(e){var i={titleId:t.try(e,"title.titleId"),cardId:t.try(e,"card.cardId")};i.titleId&&i.cardId&&t.try(this.find(i),"remove()")},n._isValidItem=function(e){return!(e&&e.cardId&&!APP.patron.cards.find({cardId:e.cardId}))&&i.prototype._isValidItem.apply(this,arguments)},s}),define("app/models/items/luggage",["require","common","./item","app/base/rosters/roster","app/base/multi-step-task"],function(e){var t=e("common"),i=e("./item"),s=i.new(),n=s.prototype,r=e("app/base/rosters/roster"),o=e("app/base/multi-step-task");return n.chooseStorage=function(e){this._assignStorageChoice(e)&&(this._executeStorageChoice(),this._announceStorageChoice())},n.refresh=function(e){if(t.defer(this,"refresh"),!this.title.format)return APP.journal.debug("[LUGGAGE] obtaining format...",this.title.title),this.title.use(function(t,i){if(!t.isBroken){if(!i.format)return i.reuse();APP.journal.debug("[LUGGAGE] ... format:",i.title,i.format),this.refresh(e)}},this);this._.bytes=this._calculateByteCounts();var i={};t.each(this.rosters,function(e,s){i[s.group]={isValid:"valid"==s.health,hasBytes:!!t.try(s.bytes,"total"),hasEntries:!!t.try(s.entries,"length")}}),e=t.absorb(e,{});var s=t.excise(e,"force")||e.withMessage;if("stream"==this._.storageChoice&&t.try(i,"title-map.hasBytes")&&t.try(i,"title-content.hasBytes"))return t.try(e,"onSuccess()");if("magazine"==this.title.format&&"download"!=this._.storageChoice&&!APP.patron.magazines.getCardForIssue(this.titleId))return t.try(e,"onSuccess()");if(this._.task)return this._fetchRosterDocuments(e);if(s)return this._fetchRosterDocuments(e);if("download"==this._.storageChoice){var n=this.passport();if(n&&!t.try(n,"urls.web"))return this._fetchRosterDocuments(e);if(t.try(i,"title-map.isValid")&&t.try(i,"title-content.isValid"))return t.try(e,"onSuccess()");if(t.try(i,"title-map.hasEntries")&&t.try(i,"title-content.hasEntries"))return this._initializeRosters(this._makeTask(e))}this._fetchRosterDocuments(e)},n.status=function(){var e=this._.bytes=this._.bytes||this._calculateByteCounts();(e.total=e.total||void 0)?(e.downloaded=e.downloaded||0,e.total?e.percent=Math.max(0,Math.min(1,e.downloaded/e.total)):e.percent=0):e.downloaded=e.percent=0;var i={};return i.isStreamed="download"!=this._.storageChoice,i.isInvalid=!1,!i.isStreamed&&t.isEmpty(this.rosters)?i.isInvalid=!this._.task||"undefined"!=typeof this._.task.retrying:i.isStreamed||(i.isInvalid=t.select(this.rosters,function(e,t){if("invalid"==t.health)return e}).length>0),i.isDownloaded=!i.isStreamed&&!i.isInvalid&&e.percent>=1,i.isDownloading=!i.isStreamed&&!i.isDownloaded&&!i.isInvalid,i.isPaused=i.isDownloading&&APP.auditor.isPaused(),i.isChecking=t.try(this._.task,"check()"),i.isPaused&&(i.pauseReasons=APP.auditor._.pauseReasons),i.bytes=t.absorb(e,{}),i},n.isDisabledByFulfillmentChoice=function(){if("book"!=this.title.format)return!1;var e=APP.patron.loans.filter({"title.titleId":this.titleId});if(!e.length)return!1;for(var i=0,s=e.length;i<s;++i){var n=t.try(e[i].fulfiller,"defaultFulfillmentType()");if(t.among(n,"choose","bifocal"))return!1}return!0},n.passport=function(){var e=APP.patron.loans.filter({"title.titleId":this.titleId});e.length?e.sort(function(e,t){return t.expireTime-e.expireTime}):e=APP.patron.magazines.filter({"title.titleId":this.titleId});for(var t=0,i=e.length;t<i;++t){var s=e[t].passport();if(s)return s}},n.removed=function(){t.each(this.rosters,function(e,t){t.wipe()}),this.rosters={},APP.events.dispatch("luggage:storage:choice",{luggage:this,title:this.title,choice:"stream"})},n._deduceStorageChoice=function(){if(t.among(this._.storageChoice,"stream","download"))return this._.storageChoice;var e,i=t.flatten([APP.auditor.autoDownloadRule]),s=i[0]||"nothing";if("nothing"==s)e="stream";else if(this.isDisabledByFulfillmentChoice())e="stream";else if("magazine"==this.title.format)e="auto";else if("byte-limited"==s){var n=this._.bytes=this._.bytes||this._calculateByteCounts(),r=1024*(i[1]||0)*1024;e=n.total<=r?"download":"stream"}else e="download";return this._assignStorageChoice(e)&&this._announceStorageChoice(e),this._.storageChoice},n._assignStorageChoice=function(e){var t={auto:"auto",stream:"stream",download:"download"}[e]||this._.storageChoice;return!!t&&(t!=this._.storageChoice&&(this._.storageChoice=t))},n._executeStorageChoice=function(){t.defer(this,"refresh",this.refresh.bind(this)),"stream"==this._.storageChoice&&(t.try(t.excise(this._,"task"),"abort()"),t.each(this.rosters,function(e,t){t.wipe()}),this._.bytes=this._calculateByteCounts())},n._announceStorageChoice=function(){APP.events.dispatch("luggage:storage:choice",{luggage:this,title:this.title,choice:this._.storageChoice}),this.collation.save()},n._fetchRosterDocuments=function(e){if(t.try(this._.task,"check()"))return this._.task.extend(e);var i=this._makeTask(e);i.passport&&i.passport.cardId?i.passport.urlFor("rosters",{journal:i.journal,withMessage:e.withMessage,onSuccess:this._onRosterURL.bind(this,i),onFailure:this._onTaskFailure.bind(this,i),timeout:e.timeout}):this._onTaskFailure(i)},n._onRosterURL=function(e,t){return e.check(this._.task)?t?(this.handlers=this.handlers||{},APP.events.off(this.handlers._onMsgRosterResponse),this.handlers._onMsgRosterResponse=APP.events.on("msg:roster:response",this._onMsgRosterResponse.bind(this,e,t)),void APP.shell.transmit({name:"roster:request",url:t})):this._onTaskFailure(e):e.orphan()},n._onMsgRosterResponse=function(e,i,s){return e.check(this._.task)?void(t.try(s.m,"url")==i&&(APP.events.off(this.handlers._onMsgRosterResponse),s.m.rosters&&s.m.response&&s.m.response.status<400?this._analyzeRosterDocuments(e,s.m.rosters):this._onTaskFailure(e))):e.orphan()},n._analyzeRosterDocuments=function(e,i){if(!e.check(this._.task))return e.orphan();if(t.try(e,"cbConsiderUpdate()",e),e.check()){t.each(i,function(e){var t=this.rosters[e.id];t&&!t.version.isOlderThan(e.version)?t.merge({entries:e.entries}):t=this.rosters[e.id]=new r(e)},this),this._.bytes=this._calculateByteCounts();var s=this._deduceStorageChoice();if("download"!=s)return t.excise(this._,"task").succeed(this);var n=this._initializeRosters(e);t.isList(n)&&!n.length&&this._onTaskSuccess(e)}},n._initializeRosters=function(e){if(!e.check(this._.task))return e.orphan();var i=t.select(this.rosters,function(i,s){return"valid"==s.health?void t.excise(s,"entries"):t.try(s.entries,"length")?(t.among(s.health,"invalid","pending")&&s.wipe(),s.initialize({onInitialize:this._onRosterInitialize.bind(this,e),onProgress:this._onRosterProgress.bind(this,e),onFinalize:this._onRosterFinalize.bind(this,e),onInvalidate:this._onRosterInvalidate.bind(this,e)}),i):void e.journal.warn("[LUGGAGE] roster without entries",i)},this);return i.length&&(t.try(e,"cbInitializeUpdate()",e),APP.events.dispatch("luggage:download:initialize",{luggage:this,title:this.title})),i},n._onRosterInitialize=function(e,t){return e.check(this._.task)?(e.journal.log("[LUGGAGE] roster initialize:",t.id),void this.collation.save()):e.orphan()},n._onRosterProgress=function(e,t){return e.check(this._.task)?(this._.bytes=this._calculateByteCounts(),void APP.events.dispatch("luggage:download:progress:"+this.titleId,{luggage:this,title:this.title,bytes:this._.bytes})):e.orphan()},n._onRosterFinalize=function(e,i){if(!e.check(this._.task))return e.orphan();this._onRosterProgress(e,i);var s=!!t.select(this.rosters,function(e,t){if("valid"!=t.health)return t.health}).length;s||(APP.events.dispatch("luggage:download:finalize",{luggage:this,title:this.title,bytes:this._.bytes}),this.collation.save(),this._onTaskSuccess(e))},n._onRosterInvalidate=function(e,t){
return e.check(this._.task)?(e.journal.log("[LUGGAGE] roster invalidate:",t.id),e.retrying=t.id,t.invalidate(),delete this._.bytes,APP.events.dispatch("luggage:download:invalidate",{luggage:this,title:this.title}),void this._onTaskFailure(e)):e.orphan()},n._onTaskSuccess=function(e){return e.check(this._.task)?void t.excise(this._,"task").succeed(this):e.orphan()},n._onTaskFailure=function(e){if(!e.check(this._.task))return e.orphan();var i=t.excise(e,"passport");if(t.try(i,"attemptFailure()"),"undefined"==typeof e.retrying){e.journal.log("[LUGGAGE] retrying..."),t.try(i,"reattempt()");var s=t.absorb({retrying:!0},t.excise(this._,"task"));this._fetchRosterDocuments(s)}else e.journal.warn("[LUGGAGE] failing..."),APP.events.dispatch("luggage:download:failure",{luggage:this,title:this.title}),this.collation.save(),t.excise(this._,"task").fail(this)},n._makeTask=function(e){return this._.task=new o(e),this._.task.passport=this.passport(),this._.task},n._totalBytesOfRosterEntries=function(e){var i=0;return t.each(e,function(e){t.each(e.entries,function(e){i+=e.bytes||r.prototype.DEFAULT_ENTRY_BYTES})}),i},n._calculateByteCounts=function(){var e={total:0,downloaded:0};return t.each(this.rosters,function(i,s){if(s&&s.id&&s.bytes)e.total+=s.bytes.total||0,"valid"==s.health?e.downloaded+=s.bytes.total:"pending"==s.health&&(e.downloaded+=Math.max(0,Math.min(s.bytes.downloaded,s.bytes.total)));else{var n=t.try(this._.task,"journal")||APP.journal;n.warn("[LUGGAGE] invalid roster while counting bytes")}},this),e.total?e.percent=Math.max(0,Math.min(1,e.downloaded/e.total)):e={total:0,downloaded:0,percent:0},e},n._deserializeAttributes=function(e){e.titleId&&!e.title?e.title=APP.titles.produce({titleId:e.titleId}):!e.titleId&&e.title&&(e.titleId=e.title.titleId),this._.storageChoice=t.excise(e,"storageChoice")||this._.storageChoice||"auto",this._.bytes=t.excise(e,"bytes")||this._.bytes,this.rosters=this.rosters||{};var s=t.excise(e,"rosters");return s&&"download"==this._.storageChoice&&t.each(s,function(e){this.rosters[e.id]=new r(e)},this),i.prototype._deserializeAttributes.call(this,e)},n._serializeAttributes=function(){var e={};return e.titleId=this.title.titleId,e.storageChoice=this._.storageChoice,e.bytes=this._.bytes,"download"==e.storageChoice&&(e.rosters=t.select(this.rosters,function(e,t){return t.serialize()})),e},s}),define("app/models/collations/luggages",["require","common","./collation","app/models/items/luggage"],function(e){var t=e("common"),i=e("./collation"),s=i.new(),n=s.prototype;return n.ITEM_CLASS=e("app/models/items/luggage"),n.ITEM_NAME="luggage",n.BANK_PREFIX="title:",n.FIND_WITH_ATTRS_TO_QUERY=!0,n.load=function(){var e=i.prototype.load.apply(this,arguments);return APP.events.on("roster:audit",this._onRosterAudit.bind(this)),e},n.createLuggageFor=function(e){this._.isLoaded&&this._ensureLuggageForOwner(e)},n.removeLuggageFor=function(e){this._.isLoaded&&this._removeLuggageUnlessAnotherOwner(e)},n._attributesToQuery=function(e){return e.titleId?{titleId:e.titleId}:e.title?{titleId:e.title.titleId}:e},n._ensureLuggageForOwner=function(e){if(t.try(e,"title")){var i=this.find({title:e.title});if(!APP.shell.has("rosters"))return t.try(i,"remove()");i=i||this.make({title:e.title},{source:"internal",integrity:"incomplete"}),i.refresh()}},n._removeLuggageUnlessAnotherOwner=function(e){var i=t.try(e,"title.titleId");if(i){var s=this.find({titleId:i});if(s){var n=APP.patron.loans.find({"title.titleId":i})||APP.patron.magazines.find({"title.titleId":i});if(!n)return s.remove();var r=s.passport();return r?void(r.isInGoodStanding()||(APP.journal.debug("[LUGGAGES] has another owner, repair passport",s),r.acquire())):s.remove()}}},n._onRosterAudit=function(e){var i=APP.patron.loans.all.concat(APP.patron.magazines.all),s=t.select(i,function(e){if(t.try(e,"title"))return this.produce({title:e.title}).titleId},this);t.each(this.all,function(i){t.each(i.rosters,function(i,s){var n=e.m.claimDocumentForId(i);s.merge(t.absorb(n,{health:"invalid"}))}),delete i._.bytes});var n=t.select(this.all,function(e){if(!t.among(e.titleId,s))return e});t.each(n,this.removeItem.bind(this)),t.each(this.all,function(e){e.refresh()}),this.save()},s}),define("app/models/collations/titles",["require","common","./collation","app/models/items/title","app/models/items/title-mirror","app/models/collations/passports","app/models/collations/luggages"],function(e){var t=e("common"),i=e("./collation"),s=i.new(),n=s.prototype,r=e("app/models/items/title"),o=e("app/models/items/title-mirror"),a=e("app/models/collations/passports"),l=e("app/models/collations/luggages");return n.ITEM_CLASS=r,n.ITEM_NAME="title",n.ITEM_KEY="titleId",n.ANNOUNCE=!1,n.PERSISTENCE="incomplete",n.$init=function(){i.prototype.$init.call(this),this.passports=new a,this.luggages=new l;var e=i.prototype.save.bind(this);APP.events.on("title:switch",e),APP.events.on("loan:add",e),APP.events.on("loan:remove",e),APP.events.on("hold:add",e),APP.events.on("hold:remove",e),APP.events.on("tagging:add",e),APP.events.on("tagging:remove",e),APP.events.on("tag:subscription",e),APP.events.on("activity:add",e),APP.events.on("activity:hidden",e),APP.events.on("notification:add",e),APP.events.on("notification:remove",e)},n.now=function(e,i){var s={was:t.try(APP.title,"titleId"),is:t.try(e,"titleId")};s.was!=s.is&&APP.events.dispatch("title:open:invalidate",s),APP.events.off(this._.mirrorHandler),e?(APP.title=e,this._.now={titleId:e.titleId,websiteId:t.try(i,"websiteId"),cardId:t.try(i,"cardId")},this._saveNow(),this._mirrorTitleInfo({switch:!0}),this._.mirrorHandler=APP.events.on("journey:update:"+e.titleId,this._mirrorTitleInfo.bind(this,{switch:!1}))):APP.title&&(APP.events.dispatch("title:switch"),APP.shell.transmit({name:"title:info"}),delete APP.title,delete this._.now)},n.cardForNow=function(){if(this._.now&&this._.now.cardId)return APP.patron.cards.find({cardId:this._.now.cardId})},n.libraryForNow=function(){if(this._.now){var e=this.cardForNow();if(e&&e.library)return e.library;if(this._.now.websiteId)return APP.libraries.produce({websiteId:this._.now.websiteId})}},n.possessionForNow=function(){if(this._.now&&this._.now.cardId){var e={"title.titleId":this._.now.titleId,"card.cardId":this._.now.cardId};return APP.patron.loans.find(e)||APP.patron.magazines.find(e)}},n.save=function(){},n.restore=function(){this.passports.load(),this.luggages.load(),t.try(this._.now,"titleId")&&this.loadingLock(function(){var e=this.produce({titleId:this._.now.titleId});this.now(e,this._.now)}.bind(this))},n.cleanTitleString=function(e){var t=e.replace(/(\(.*\)\s*)+$/g,"").replace(/--.*$/,"").trim();return t||e.trim()},n._saveNow=function(){var e=this.export();APP.bank.set(this._bankName(),e),APP.events.dispatch("title:save:eligible",{titles:e})},n._deferSaveNow=function(){clearTimeout(this._.saveTimer),this._.saveTimer=setTimeout(this._saveNow.bind(this),500)},n._serializeAttributes=function(){var e=i.prototype._serializeAttributes.call(this);if(t.try(this._.now,"titleId")){var s,n=e.now={titleId:this._.now.titleId};(s=this._.now.websiteId)&&(n.websiteId=s),(s=this._.now.cardId)&&(n.cardId=s)}return e},n._deserializeAttributes=function(e){(e.now||e["now:slug"])&&(this._.now=t.absorb(t.excise(e,"now"),{titleId:t.excise(e,"now:slug"),websiteId:t.excise(e,"now:library")})),i.prototype._deserializeAttributes.call(this,e)},n._serializeItems=function(){var e=[];return t.each(this._eligibleTitlesForStorage(),function(t){t.use(function(i){t.title?e.push(t.export()):i.isBroken||t.reuse(this._deferSaveNow.bind(this))},this)},this),e},n._eligibleTitlesForStorage=function(){var e=[],i=[],s=function(s){var n;s instanceof r?n=s:t.try(s,"title")instanceof r&&(n=s.title),!n||i.indexOf(n.titleId)>=0||(i.push(n.titleId),e.push(n))};s(APP.title),t.each(APP.patron.loans.all,s),t.each(APP.patron.holds.all,s),t.each(APP.patron.magazines.all,s),t.each(APP.patron.extras.all,s);var n=APP.notifier.notifications.collate({titles:!0,dismissedAt:null,sort:"createdAt"}).slice(0,24);return t.each(n,function(e){s(e.title())}),e},n._attributesToQuery=function(e,t){return{titleId:e["internal"==t.source?"titleId":"id"]}},n._mirrorTitleInfo=function(e){if(APP.title){e=t.absorb(e,{});var i=APP.title,s=this.possessionForNow(),n=new o;n.reflect([s||i],function(n){if(i===APP.title&&n.changed){var r=n.infos[0];e.switch&&APP.events.dispatch("title:switch",{title:i,info:r,owner:s||i}),APP.shell.transmit(t.absorb(r,{name:"title:info"}))}})}},s}),define("app/models/items/journey",["require","common","app/models/items/item","app/models/agents/usage","app/base/bank/bank-scope-native"],function(e){var t=e("common"),i=e("app/models/items/item"),s=i.new(),n=s.prototype,r=(e("app/models/agents/usage"),e("app/base/bank/bank-scope-native"));return n.TIMEOUT_BANK=1e3,n.TIMEOUT_SYNC=15e3,n.title=function(){return APP.titles.produce({titleId:this.titleId})},n.coalesce=function(e,i){i="function"==typeof i?i:function(){APP.journal.debug("[JOURNEY] coalesce failed",this)}.bind(this);var s=this.title(),n=[s.tags,s.acts],r=function(s,r){return"failed"==s.work?i(this):s.isIdeal?(t.excise(n,r),void(n.length||"function"==typeof e&&e(this))):r.reuse()}.bind(this);s.tags.use(r.bind(this)),s.acts.use(r.bind(this))},n.lastLoanAct=function(){for(var e=this._titleActs().slice(0).sort(function(e,t){return t.createTime-e.createTime}),i=0,s=e.length;i<s;++i)if(t.among(e[i].action,"borrow","loan-return","loan-expire"))return e[i]},n.mostRelevantCard=function(){var e=this.title(),t=this._loanForTitle(e);if(t)return t.card;var i=this._magazineForTitle(e);if(i)return i.card;var s=this._titleActs(e).slice();if(s.length){s.sort(function(e,t){return t.createTime-e.createTime});for(var n,r=0,o=s.length;r<o;++r)if(n=s[r].card||n,n&&"borrow"==s[r].action)return n;return n}},n.mostRelevantLibrary=function(){for(var e=this._titleActs().slice(0).sort(function(e,t){return t.createTime-e.createTime}),t=0,i=e.length;t<i;++t)if(e[t].library)return e[t].library},n.statisticalEstimatedTime=function(){if(t.try(this,"data.statistics.readingTime")){var e=this.data.statistics.readingTime;return Math.max(60,e/this.progress-e)}},n.timelines=function(){var e=this.title(),i=t.flatten(t.try(this.data,"marks")||[]);t.each(e.tags.taggings,function(e){e&&i.push(e)}),t.each(e.acts.all,function(e){"hidden"!=e.display&&i.push(e)}),i.sort(function(e,t){return e.createTime-t.createTime});var s=[],n=!1;return t.each(i,function(e){(!s.length||n&&e.action)&&(s.push([]),n=!1),t.last(s).push(e),"loan-return"!=e.action&&"loan-expire"!=e.action||(n=!0)}),t.each(s,function(e){e.reverse()}),s.reverse()},n.path=function(){var e=APP.router.route;if("search"==e.realm||"library"==e.realm){for(var t,i=e;i&&!t;)i.list&&"function"==typeof i.list.path&&(t=i.list),i=i.ancestor;return this.title().path(t,"journey")}return"tags"==e.realm?"tags/journey/"+this.titleId:"shelf/journey/"+this.titleId},n.sync=function(e){if(e=t.absorb(e,{}),this._.sync)return this._.sync.callbacks.push(e.callback);if(this._.sync={callbacks:[e.callback],freshness:e.freshness||0,tasks:{}},this._.sync.freshness&&this.isFresh(this._.sync.freshness))return this._finalizeSync();this._.sync.timeout=setTimeout(this._finalizeSync.bind(this),this.TIMEOUT_SYNC);var i=!1;APP.shell.has("bank")&&(i=this._.sync.tasks.bank=!0),e.bankSync||(i=this._.sync.tasks.sentry=!0),i?this.coalesce(function(){this._.sync&&(this._.sync.tasks.bank&&setTimeout(this._fetchPossessionFromBank.bind(this),0),this._.sync.tasks.sentry&&setTimeout(this._fetchPossessionFromSentry.bind(this),0))}.bind(this)):this._finalizeSync()},n.isFresh=function(e){var i=(this._.syncedAt||0)+e;return i>t.epochMilliseconds()},n.isSyncing=function(){return!!this._.sync},n.reset=function(){delete this.data,delete this._.syncedAt,this.timestamp=0,delete this.progress,this._announceUpdate()},n.wipe=function(e){var i=this.title(),s=function(){s=null,this.reset(),"function"==typeof e&&e()}.bind(this);APP.title&&APP.title.titleId==i.titleId&&APP.titles.now(null);var n=this._loanForTitle(i);n&&t.try(n.luggage(),"chooseStorage()","stream"),APP.titles.passports.removeAll({title:i}),this.coalesce(function(){s&&(t.each(this.timelines(),function(e){t.each(e,function(e){"function"==typeof t.try(e.collation,"removeFromTitle")?e.collation.removeFromTitle(i):e.collation&&e.collation.removeItem(e)},this)},this),i.tags.all=[],i.acts.all=[],APP.sentry.resetReadingData(i,function(e){if(s){var i=[];if(e.all?t.each(e.all,function(e){i.push(e.oldBankScope)}):e.oldBankScope&&i.push(e.oldBankScope),!i.length||!APP.shell.has("bank"))return s();APP.events.once("msg:bank:read",function(e){s&&(t.each(i,function(i){t.each(e.m.scopes[i],function(e){APP.shell.transmit({name:"bank:write",scope:i,key:e})})}),s())}.bind(this));APP.shell.transmit({name:"bank:read",scopes:i})}}.bind(this),s))}.bind(this))},n._serializeAttributes=function(){if(this._.bankScope){var e={};return e.titleId=this.titleId,e.bankScope=this._.bankScope,"number"==typeof this.progress&&(e.progress=this.progress),"number"==typeof this.timestamp&&(e.timestamp=Math.max(0,this.timestamp-1)),e}},n._deserializeAttributes=function(e){e&&(this.titleId=e.titleId||e.slug,this.timestamp=t.timestampAsMS(e.timestamp)||0,"number"==typeof e.progress&&(this.progress=e.progress),e.bankScope&&(this._.bankScope=e.bankScope))},n._completeSyncTask=function(e){this._.sync&&("string"==typeof e&&delete this._.sync.tasks[e],this._.sync.tasks.bank||this._.sync.tasks.sentry||this._finalizeSync())},n._finalizeSync=function(){var e=this._.sync;delete this._.sync,clearTimeout(e.timeout),t.each(e.callbacks,function(e){"function"==typeof e&&e(this)}),e.isUpdated&&(this._.syncedAt=t.epochMilliseconds(),this.collation.save("synced"),this._announceUpdate())},n._announceUpdate=function(){APP.events.dispatch("journey:update:"+this.titleId,{journey:this})},n._fetchPossessionFromBank=function(){return this._.bankScope=this._.bankScope||this._bankScopeForTitle(this.title()),this._.bankScope?(this._.bankHandler=this._.bankHandler||APP.events.on("msg:bank:read",this._consumePossessionFromBank.bind(this,this._.bankScope)),APP.events.on(this._.bankHandler),clearTimeout(this._.bankTimer),this._.bankTimer=setTimeout(this._completeSyncTask.bind(this,"bank"),this.TIMEOUT_BANK),void APP.shell.transmit({name:"bank:read",scopes:[this._.bankScope]})):this._completeSyncTask("bank")},n._consumePossessionFromBank=function(e,t){if(!this._.sync)return void APP.journal.debug("[JOURNEY] skipping bank merge because sync canceled");var i=t.m.scopes[e];if(!i)return APP.journal.debug("[JOURNEY] skipping bank merge because no bank data"),this._completeSyncTask("bank");APP.events.off(this._.bankHandler),clearTimeout(this._.bankTimer),this._.bank=new r(e,i);var s=this._interpretData({position:this._.bank.get("possession:position"),marks:this._.bank.get("possession:marks"),statistics:this._.bank.get("possession:statistics"),timestamps:this._.bank.get("possession:timestamps")},{bookmark:this._.bank.get("possession:bookmark:recordings"),highlight:this._.bank.get("possession:highlight:recordings"),audiomark:this._.bank.get("possession:audiomark:recordings")}),n=this._timestampOfLatestAct(s);s.position&&n>this.timestamp?(APP.journal.debug("[JOURNEY] ... accepting bank data (%s vs %s)",this._printableDate(n),this.timestamp?this._printableDate(this.timestamp):"--",s),this.timestamp=n,this.progress=s.position.percentageOfBook,this.data=s,this._.sync.isUpdated=!0):APP.journal.debug("[JOURNEY] ... ignoring bank data (%s vs %s)",this._printableDate(n),this.timestamp?this._printableDate(this.timestamp):"--",s),this._completeSyncTask("bank")},n._interpretData=function(e,i){var s=[],n=function(e,t){t.markType=t.trueType=e,"audiomark"==e&&(t.markType=t.extentMilliseconds?"highlight":"bookmark"),t.createTime=1e3*(t.timestamp||0)||t.syncStamp,s.push(t)},r=function(e){e&&e.markType&&t.excise(s,e)};return t.each(t.try(e.marks,"bookmarks"),n.bind(this,"bookmark")),t.each(t.try(e.marks,"highlights"),n.bind(this,"highlight")),t.each(t.try(e.marks,"audiomarks"),n.bind(this,"audiomark")),t.each(["bookmark","highlight","audiomark"],function(e){i[e]&&t.each(i[e],function(i){var o=t.try(i,"params.uuid");if(o){for(var a,l=0,c=s.length;l<c;++l)if(s[l].uuid==o){a=s[l];break}"delete"==i.operation?r(a):a?t.absorb(i.params,a):n(e,a=t.absorb(i.params,{}))}})}),e.marks=s,e},n._loanForTitle=function(e){return e=e||this.title(),APP.patron.loans.find({"title.titleId":e.titleId})},n._magazineForTitle=function(e){return e=e||this.title(),APP.patron.magazines.find({"title.titleId":e.titleId})},n._passportForTitle=function(e){e=e||this.title();var i=t.try(this._loanForTitle(e),"passport()");return i=i||t.try(this._magazineForTitle(e),"passport()"),i=i||APP.titles.passports.find({title:e})},n._bankScopeForTitle=function(e){var i=t.try(this._passportForTitle(e),"bankScope");if("string"==typeof i)return i.match(/^title-/)||(i="title-"+i),i},n._titleActs=function(e){var i=t.try(e||this.title(),"acts.all");return i||(console.trace("[JOURNEY] title acts undefined. Coalesce?"),i=[]),i},n._fetchPossessionFromSentry=function(){var e=this.mostRelevantCard();return e?void APP.sentry.fetchReadingData(e,this.title(),this._consumePossessionFromSentry.bind(this),this._completeSyncTask.bind(this,"sentry")):this._completeSyncTask("sentry")},n._consumePossessionFromSentry=function(e){if(this._.sync){var i=e.bankScope;i&&i!=this._.bankScope&&(this._.bankScope=i);var s=this._interpretData(e,{});t.excise(s.timestamps,"expires");var n=this._timestampOfLatestAct(s),r=n>this.timestamp,o=n>=this.timestamp;s.position&&o&&(this.timestamp=n,this.progress=s.position.percentageOfBook,this.data=this.data||s,this.data.position=s.position,this.data.marks=s.marks,this.data.statistics=s.statistics,this.data.timestamps=t.absorb(s.timestamps,this.data.timestamps||{}),r&&this._updatePossessionDataInBifocal(e),this._.sync.isUpdated=!0),this._completeSyncTask("sentry")}},n._updatePossessionDataInBifocal=function(e){APP.lectern.isOpen(this.titleId)&&APP.shell.transmit({name:"client:possession:transfer",dest:"bifocal",possession:e}),this._.bank&&t.each(["position","marks","statistics","timestamps"],function(t){this._.bank.get("possession:"+t);this._.bank.set("possession:transfer:"+t,e[t])},this)},n._timestampOfLatestAct=function(e){var i=t.timestampAsMS(t.try(e,"position.timestamp"))||0;return t.each(e.marks,function(e,s){t.each(s,function(e){i=Math.max(i,t.timestampAsMS(e.timestamp)||0)})}),i},n._printableDate=function(e){return new Date(e).toLocaleString()},s}),define("app/models/collations/journeys",["require","common","./collation","app/models/items/journey"],function(e){var t=(e("common"),e("./collation")),i=t.new(),s=i.prototype;return s.ITEM_CLASS=e("app/models/items/journey"),s.ITEM_NAME="journey",s.ITEM_KEY="titleId",s.ANNOUNCE=!1,s.PERSISTENCE="incomplete",s.$init=function(){t.prototype.$init.call(this),APP.events.on("tagging:add",this._onAddTagging.bind(this)),APP.events.on("tagging:remove",this._onRemoveTagging.bind(this)),APP.events.on("activity:add",this._onAddActivity.bind(this)),APP.events.on("activity:remove",this._onRemoveActivity.bind(this))},s.save=function(e){"synced"==e&&t.prototype.save.call(this)},s._onAddTagging=function(e){e.m.item.title.journey()._announceUpdate()},s._onRemoveTagging=function(e){e.m.item.title.journey()._announceUpdate()},s._onAddActivity=function(e){e.m.item.title.journey()._announceUpdate()},s._onRemoveActivity=function(e){e.m.item.title.journey()._announceUpdate()},s._deserializeAttributes=function(e){},i}),define("app/base/bosses/sync",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.SYNC_INTERVAL_FOREGROUND=12e4,s.SYNC_INTERVAL_PERIODIC=18e5,s.SYNC_INTERVAL_JOURNEYS=144e5,s.EXPIRED_POSSESSION_LEEWAY=144e5,s.$init=function(){this.status="pending",this.callbacks={success:[],failure:[]},this.ignorables=[],APP.events.on("network:info",this._onNetworkInfo.bind(this)),APP.events.on("msg:bifocal:relay:background",this._onBifocalBackgrounded.bind(this)),APP.events.on("msg:client:view:foreground",this._onClientForegrounded.bind(this))},s.commence=function(e){return APP.journal.debug("[SYNC] commence",e),t.defer(this,"schedule"),APP.sentry.chip?(e.onSuccess&&this.callbacks.success.push(e.onSuccess),e.onFailure&&this.callbacks.failure.push(e.onFailure),APP.network.reachable?this._.syncOptions?APP.journal.debug("[SYNC] ignored because of active sync"):(this._mergeSyncOptions(e),this._syncedSince(this._.syncOptions.freshness)?(this._.syncOptions=null,APP.journal.debug("[SYNC] ignored because of recent sync")):(this._.syncOptions.queue=[],this._.syncOptions.queue.push(this._syncCards.bind(this)),this._.syncOptions.syncTags!==!1&&(this._.syncOptions.queue.push(this._syncTags.bind(this)),this._.syncOptions.queue.push(this._syncSubscriptions.bind(this))),this._.syncOptions.syncJourneys===!1||!this._.syncOptions.syncJourneys&&t.try(APP.lectern.session,"check()")||(t.each(APP.patron.loans.all.concat(APP.patron.holds.all),function(e){e.title.tags.use(function(e,t){e.isIdeal||e.isBroken||t.reuse()})}),t.each(APP.patron.loans.all,function(e){var t=e.journey.sync.bind(e.journey,{freshness:this._.syncOptions.journeyFreshness,callback:this._workOff.bind(this)});this._.syncOptions.queue.push(t)},this)),this._setStatus("pending"),void this._workOff())):this._onSyncFailure("offline")):APP.journal.debug("[SYNC] ignored because chip not acquired yet")},s.consume=function(e){APP.journal.debug("[SYNC] consume:",e),this._.sentryJob=null,this._.lastSyncTimestamp=t.epochMilliseconds(),this._consumeSyncData(e),this._mergeSyncOptions(),this._workOff()},s._onNetworkInfo=function(e){"offline"==this.status&&e.m.network.reachable&&this.commence({freshness:0})},s._onBifocalBackgrounded=function(){this._syncActiveLoanJourney()},s._onClientForegrounded=function(){this.commence({freshness:this.SYNC_INTERVAL_FOREGROUND})},s._setStatus=function(e){this.status=e,APP.semaphore.set("sync",this.status),APP.events.dispatch("patron:sync:"+("pending"==e?"commence":"complete"),{status:e,options:this._.syncOptions})},s._mergeSyncOptions=function(e){this._.syncOptions=t.absorb(e,t.absorb(this._.syncOptions,{manual:!1,freshness:this.SYNC_INTERVAL_PERIODIC,journeyFreshness:this.SYNC_INTERVAL_JOURNEYS}))},s._workOff=function(){var e=t.try(this._.syncOptions,"queue.shift()");e?e():this._onSyncComplete()},s._syncCards=function(){this._.sentryJob=APP.sentry.synchronize(this._onSyncFetched.bind(this),this._onSyncFailure.bind(this))},s._onSyncFetched=function(e){var t=JSON.parse(e);this.consume(t)},s._onSyncFailure=function(e){for("offline"==e?this._setStatus("offline"):(this._setStatus("failure"),APP.scribe.record("sync:failure")),this._removeLongExpiredPossessions(),this.callbacks.success.splice(0);this.callbacks.failure.length;)this.callbacks.failure.shift()();this._.syncOptions=null,this._.sentryJob=null,this._scheduleNextSync()},s._syncTags=function(){APP.services.vandal.syncDelta(this._workOff.bind(this))},s._syncSubscriptions=function(){if(!APP.patron.magazines.subscriptions().length){var e;if(t.each(APP.patron.tags.all,function(i){"notify-me"==t.try(i,"behavior.key")&&t.breakIteration(e=i)}),!e)return this._workOff()}APP.services.vandal.subscriptions(function(e){this._.syncOptions&&(APP.events.dispatch("patron:sync:magazines",{subscriptions:e,loans:t.excise(this._.syncOptions,"magazinesData")}),this._workOff())}.bind(this),this._onSyncFailure.bind(this))},s._onSyncComplete=function(){for(this._setStatus("success"),APP.scribe.record("sync:success"),this.callbacks.failure.splice(0);this.callbacks.success.length;)this.callbacks.success.shift()();this._.syncOptions=null,this._.sentryJob=null,this._scheduleNextSync()},s._syncedSince=function(e){var i=t.epochMilliseconds()-(this._.lastSyncTimestamp||0);return i<=e},s._consumeSyncData=function(e){APP.notifier.syncNotificationService(e.notifications);var i={},s={},n={source:"external",integrity:"complete"};i.cards=APP.patron.cards.importAll(e.cards,n);var r=this._filterLoansAndHolds(e.loans),o=this._filterLoansAndHolds(e.holds);this._.syncOptions=this._.syncOptions||{},this._.syncOptions.magazinesData=this._filterMagazines(e.loans),i.loans=APP.patron.loans.importAll(r.compatible,n),i.holds=APP.patron.holds.importAll(o.compatible,n),i.extras=APP.patron.extras.importAll(r.extras,n),t.each(i.cards,function(s){if(s.mergedCardIds&&i.cards.length>1)return s.setExpiry(t.epochMilliseconds());var n=t.try(e,"summary."+s.cardId+".cards")||"done";"auth"!=n||s.isExpired()?"done"==n&&s.isExpired()&&s.setExpiry(null):s.setExpiry(t.epochMilliseconds())}),t.each(i,function(e,t){s[e]=this._filterMissingItems(APP.patron[e].all,t)},this),t.each(s.cards,function(i){if(i){var s=t.try(e,"summary."+i.cardId+".cards")||"done";"done"==s&&APP.patron.cards.removeItem(i),"auth"==s&&i.setExpiry(t.epochMilliseconds())}},this),t.each(s.loans,function(i){if(i.card){var s=t.try(e,"summary."+i.card.cardId+".loans")||"done";"done"==s&&APP.patron.loans.removeItem(i)}},this),t.each(s.holds,function(i){if(i.card){var s=t.try(e,"summary."+i.card.cardId+".holds")||"done";"done"==s&&APP.patron.holds.removeItem(i)}},this),t.each(s.extras,function(i){if(i.card){var s=t.try(e,"summary."+i.card.cardId+".loans")||"done";"done"==s&&APP.patron.extras.removeItem(i)}},this),t.try(e.warnings,"length")&&APP.events.dispatch("investigate:record",{what:"warnings in sync data",where:"Sync#_consumeSyncData",why:"INV-PS-7168",syncWarnings:e.warnings,syncSummary:e.summary})},s._filterLoansAndHolds=function(e){return this.ignorables.length&&(e=this._filterIgnorables(e)),e=this._filterLoansAndHoldsForMergedCards(e),e=this._filterLoansAndHoldsByFormat(e)},s._filterIgnorables=function(e){return t.select(e,function(e){return t.each(this.ignorables,function(i){var s=t.select(i,function(t,i){if(!e[t]||e[t]!==i)return t});s.length||t.breakIteration(e=void 0)}),e},this)},s._filterLoansAndHoldsByFormat=function(e){var i={compatible:[],extras:[],suppressed:[]};return t.each(e,function(e){e&&(e.isBundledChild||(this._isCompatibleItemByFormat(e)?i.compatible.push(e):this._isExtraItem(e)?i.extras.push(e):i.suppressed.push(e)))},this),i},s._filterMagazines=function(e){return t.select(e,function(e){var i=t.try(e,"overDriveFormat.id");if("magazine-overdrive"==i)return e})},s._isCompatibleItemByFormat=function(e){var t=APP.constants.discoverableFulfillmentSubtypes(),i=e.overDriveFormat;if(i&&t.indexOf(i.id)>=0)return"magazine-overdrive"!=i.id;var s=["ebook-epub-adobe","audiobook-mp3"],n=["ebook-media-do"];if(e.otherFormats)for(var r=0,o=e.otherFormats.length;r<o;++r){var a=e.otherFormats[r].id;if(n.indexOf(a)>=0)return!0;if(e.isPreReleaseTitle&&s.indexOf(a)>=0)return!0}return!1},s._isExtraItem=function(e){return"external service"==t.try(e,"type.id")},s._filterLoansAndHoldsForMergedCards=function(e){var i=[],s={};return t.each(e,function(e){if(s[e.cardId]===!1)return i.push(e);if(s[e.cardId]!==!0){var n=APP.patron.cards.find({cardId:e.cardId});if(n){if(!n.mergedCardIds)return s[n.cardId]=!1,i.push(e);var r=function(e){return e.authorizeTime||e.createTime||0},o=[n],a=r(n);return t.each(n.mergedCardIds,function(e){var t=APP.patron.cards.find({cardId:e});t&&(o.push(t),a=Math.max(r(t),a))}),t.each(o,function(e){s[e.cardId]=r(e)!==a}),s[e.cardId]?void 0:i.push(e)}}}),i},s._filterMissingItems=function(e,i){var s=[];return t.each(e,function(e){i.indexOf(e)<0&&s.push(e)}),s},s._syncActiveLoanJourney=function(e){if(APP.title){var i;if(i="magazine"==APP.title.format?APP.title.journey():t.try(APP.title.possession("loan"),"journey"))return i.sync({freshness:0,bankSync:!0})}},s._removeLongExpiredPossessions=function(){var e=APP.patron.loans.all.concat(APP.patron.holds.all),i=[];t.each(e,function(e){e.isExpired(this.EXPIRED_POSSESSION_LEEWAY)&&i.push(e)}),t.each(i,function(e){e.remove()})},s._scheduleNextSync=function(){var e=t.epochMilliseconds(),i=this.SYNC_INTERVAL_PERIODIC,s=APP.patron.loans.all.concat(APP.patron.holds.all);t.each(s,function(t){"number"==typeof t.expireTime&&(t.expireTime<=e||(i=Math.min(i,t.expireTime-e),i=Math.max(i,this.SYNC_INTERVAL_FOREGROUND)))},this);var n=6e4,r=Math.ceil(i/n);i=r*n,t.defer(this,"schedule",this.commence.bind(this,{freshness:0}),i),APP.journal.debug("[SYNC] schedule: %s minutes",r)},i}),define("app/base/bosses/search-history",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.$init=function(){this.import(APP.bank.get("catalog:search:history"))},s.add=function(e){t.excise(this.queries,e),this.queries.unshift(e),this._persist()},s.remove=function(e){t.excise(this.queries,e)&&this._persist()},s.reset=function(){this.queries.splice(0),this._persist(),APP.events.dispatch("catalog:search:history:reset")},s.export=function(){return{v:1,queries:this.queries.slice(0)}},s.import=function(e){this.queries=e?e.queries:[]},s._persist=function(){APP.bank.dump("catalog:search:history",this)},i}),define("app/models/items/library-card",["require","common","app/models/items/item","shibui/src/phrasebook"],function(e){var t=e("common"),i=e("app/models/items/item"),s=i.new(),n=s.prototype,r=e("shibui/src/phrasebook");return n.safeName=function(){return t.safe(this.cardName)},n.loans=function(){return this._possessions("loans")},n.holds=function(){return this._possessions("holds")},n.removed=function(){t.each(this.loans(),function(e){e.collation.removeItem(e)}),t.each(this.holds(),function(e){e.collation.removeItem(e)}),t.each(this._possessions("extras"),function(e){e.collation.removeItem(e)})},n.setExpiry=function(e){this.expireTime=e,this.collation.save()},n.isExpired=function(){return"number"==typeof this.expireTime&&t.epochMilliseconds()>=this.expireTime},n.isContentRestricted=function(){return"number"==typeof this.contentMask&&this.contentMask>=0},n.setLendingPeriodPreference=function(e,i){if(!this.lendingPeriods[e])return APP.journal.warn("[LIBRARY-CARD] invalid lendingPeriod format",e);if(!t.isList(i))return APP.journal.warn("[LIBRARY-CARD] invalid lendingPeriod preference",i);for(var s=this.lendingPeriods[e].options,n=0,r=s.length;n<r;++n){var o=s[n];if(o[0]==i[0]&&o[1]==i[1])return this.lendingPeriods[e].preference=i}APP.journal.warn("[LIBRARY-CARD] lendingPeriod preference does not match options",i,s)},n._transformAttributes=function(e,i){return e.cardName=e.cardName||r.text("library-card.default-name"),e.isVisiting=t.excise(e,"isVisitingCard"),t.excise(e,"canRecommendTitles"),e},n._deserializeAttributes=function(e,s){var n=t.excise(e,"library"),r=n?n.websiteId:t.excise(e,"websiteId"),o={websiteId:r};this.library=APP.libraries.produce(o),n&&this.library.import(n,{source:"internal",integrity:"incomplete"}),e.lendingPeriods&&this._mergeLendingPeriods(t.excise(e,"lendingPeriods")),this.createTime=this._utcStringToTime(t.excise(e,"createDate")),this.authorizeTime=this._utcStringToTime(t.excise(e,"authorizeDate")),this.mergedCardIds=t.excise(e,"mergedCardIds"),this.contentMask=t.excise(e,"contentMask")||void 0,this.thunderHistoryStartTime=this._utcStringToTime(this.library.allowThunderHistory&&t.excise(e,"allowReadingHistorySince")),this.mergedCardIds&&this.mergedCardIds.length||delete this.mergedCardIds,i.prototype._deserializeAttributes.call(this,e)},n._serializeAttributes=function(){return{cardId:this.cardId,cardName:this.cardName,createTime:this.createTime,expireTime:this.expireTime,puid:this.puid,websiteId:this.library.websiteId,advantageKey:this.advantageKey,accounts:this.accounts,ilsName:this.ilsName,username:this.username,lendingPeriods:this.lendingPeriods,isVisiting:this.isVisiting,canPlaceHolds:this.canPlaceHolds,contentMask:this.contentMask,thunderHistoryStartTime:this.thunderHistoryStartTime}},n._mergeLendingPeriods=function(e){this.lendingPeriods=this.lendingPeriods||{},t.each(e,function(e,i){if(this.lendingPeriods[e]=this.lendingPeriods[e]||{},t.isList(i.options)&&(this.lendingPeriods[e].options=i.options),"number"==typeof i.luckyDay?this.lendingPeriods[e].luckyDay=[i.luckyDay,"days"]:t.isList(i.luckyDay)&&(this.lendingPeriods[e].luckyDay=i.luckyDay),
t.isList(i.preference)){for(var s=this.lendingPeriods[e].preference||[],n=0,r=i.options.length;n<r;++n){var o=i.options[n];if(o[0]==s[0]&&o[1]==s[1])return}this.lendingPeriods[e].preference=i.preference}},this)},n._possessions=function(e){var i=[];return t.each(APP.patron[e].all,function(e){e.card.cardId==this.cardId&&i.push(e)},this),i},s}),define("app/models/collations/library-cards",["require","common","./collation","app/models/items/library-card"],function(e){var t=e("common"),i=e("./collation"),s=i.new(),n=s.prototype;return n.ITEM_CLASS=e("app/models/items/library-card"),n.ITEM_NAME="card",n.BANK_PREFIX="patron:",n.SAVE_DELAY=0,n.activateCard=function(e){t.excise(this.all,e),this.all.unshift(e),this.save()},n.signature=function(){var e=[];return t.each(this.all,function(t){e.push(t.cardId)}),e.sort().join(",")},n._attributesToQuery=function(e,i){if(t.try(e,"cardId"))return{cardId:e.cardId};if(t.try(e,"puid"))return APP.journal.trace("[LIBRARY-CARDS] card lookups by PUID are deprecated"),{puid:e.puid};throw["[LIBRARY-CARDS] _attributesToQuery: no card-identifying attributes:",JSON.stringify(e)].join(" ")},s}),define("app/models/items/possession",["require","common","app/models/items/item","app/models/items/title-fulfiller","app/models/items/title-holding"],function(e){var t=e("common"),i=e("app/models/items/item"),s=i.new(),n=s.prototype,r=e("app/models/items/title-fulfiller"),o=e("app/models/items/title-holding");return n.POSSESSION_TYPE="[unknown]",n.$init=function(){this.type=this.POSSESSION_TYPE},n.passport=function(){if("loan"==this.type||"magazine"==this.type)return APP.titles.passports.produce({title:this.title,cardId:t.try(this.card,"cardId"),library:this.library})},n.luggage=function(){if(APP.shell.has("rosters")&&this.title&&t.among(this.type,"loan","magazine"))return APP.titles.luggages.find({title:this.title})},n.holding=function(){if(this._.holding)return this._.holding;if(this.title){var e=t.try(this.card,"advantageKey")||t.try(this.library,"baseKey");return e?this._.holding=this.title.holdings.produce({libraryKey:e}):this._.holding=this.title.holding()}},n.pathToShelfAction=function(e){return"shelf/"+this.collation.type+"s/"+this.psnKey+(e?"/"+e:"")},n.isExpired=function(e){return("number"!=typeof e||e<0)&&(e=0),"number"==typeof this.expireTime&&this.expireTime<=t.epochMilliseconds()+e},n._generatePsnKey=function(){return[t.try(this.card,"cardId")||"xx",t.try(this.title,"titleId")||"yy"].join("-")},n._transformAttributes=function(e,i){var s={titleAttributes:e};return s.titleId=t.excise(e,"id"),s.titleId=t.excise(e,"titleId")||s.titleId,s.reserveId=t.excise(e,"reserveId"),s.websiteId=t.excise(e,"websiteId"),s.cardId=t.excise(e,"cardId"),(e.formats||e.sample)&&(s.fulfiller={formats:e.formats,otherFormats:e.otherFormats,sample:e.sample,isFormatLockedIn:t.excise(e,"isFormatLockedIn")}),s},n._deserializeAttributes=function(e){var i=(t.clone(e),t.excise(e,"cardId")),s=t.excise(e,"titleId"),n=t.excise(e,"websiteId");s&&(this.title=APP.titles.produce({titleId:s}));var a=t.absorb(t.excise(e,"titleAttributes"),{}),l=e.holding||t.absorb(a,{}),c=t.excise(e,"reserveId");c&&(a.reserveId=a.reserveId||c),this.title&&(i&&(a.cardId=a.cardId||i),n&&(a.websiteId=a.websiteId||n),this.title.import(a,{source:"external",integrity:"incomplete"})),i&&(this.card=APP.patron.cards.find({cardId:i})),this.card||"magazine"==this.type||APP.journal.warn("[POSSESSION] no library card for %s —",this.type,this.collation.name,t.try(this.title,"title")),this.psnKey=this._generatePsnKey(),this.library=t.try(this.card,"library")||this.library,this.library?n=this.library.websiteId||n:n&&(this.library=APP.libraries.produce({websiteId:n})),l.id=s||l.titleId||l.id,l.libraryKey=t.try(this.card,"advantageKey")||t.try(this.library,"baseKey");var h={source:"external",integrity:"complete"};if(e.holding&&(h.source="internal"),t.try(this._.holding,"possession")!=this&&(this._.holding=new o,this._.holding.possession=this),this._.holding.import(l,h),e.fulfiller){var u={source:"external",integrity:"complete"},p=t.absorb(t.excise(e,"fulfiller"),{});p.title=this.title,p.websiteId=n,p[this.type]=this,this.fulfiller&&this.fulfiller.isLoanFulfiller||(this.fulfiller=new r,this.fulfiller.isLoanFulfiller=!0),this.fulfiller.import(p,u),this.fulfiller.usage.markAsFetched(u.integrity)}!this.fulfiller&&this.title&&this.library&&(this.fulfiller=this.title.fulfiller(this.library)),"undefined"!=typeof e.createTime&&(this.createTime=e.createTime),"undefined"!=typeof e.expireTime&&(this.expireTime=e.expireTime)},n._serializeAttributes=function(){var e={};return t.try(this.title,"titleId")&&(e.titleId=this.title.titleId),t.try(this.title,"reserveId")&&(e.reserveId=this.title.reserveId),t.try(this.library,"websiteId")&&(e.websiteId=this.library.websiteId),t.try(this.card,"cardId")&&(e.cardId=this.card.cardId),this.fulfiller&&(e.fulfiller=this.fulfiller.export()),this.createTime&&(e.createTime=this.createTime),this.expireTime&&(e.expireTime=this.expireTime),e},s}),define("app/models/items/loan",["require","common","app/models/items/possession"],function(e){var t=e("common"),i=e("app/models/items/possession"),s=i.new(),n=s.prototype;return n.POSSESSION_TYPE="loan",n.isWithinReturnWindow=function(){var e=t.epochMilliseconds();return this.returnableTime>0&&this.returnableTime<e},n.isWithinRenewalWindow=function(){var e=t.epochMilliseconds();return this.renewableTime>0&&this.renewableTime<e},n.isOpenedRecently=function(){var e=Math.max(this.createTime,this.journey.timestamp),i=t.epochMilliseconds()-e;return i<2592e5},n.millisecondsRemaining=function(){return Math.max(0,(this.expireTime||0)-t.epochMilliseconds())},n.daysRemaining=function(){return Math.round(this.millisecondsRemaining()/864e5)},n.distanceInTimeToExpiry=function(e){if(this.expireTime){var i=(new Date).setHours(0,0,0,0),s=new Date(this.expireTime).setHours(0,0,0,0),n=t.epochSeconds();i<s&&(n=(i+(this.expireTime-s))/1e3);var r=Math.max(0,this.expireTime/1e3-n);return r?APP.arena._distanceInTime(r,1):void 0}},n.added=function(){APP.titles.luggages.createLuggageFor(this),APP.title==this.title&&(APP.journal.debug("[LOAN] clearing bifocal because title already open - sample?"),APP.titles.now(null))},n.removed=function(){APP.titles.luggages.removeLuggageFor(this),APP.title==this.title&&APP.titles.now(null)},n._transformAttributes=function(e,s){var n=i.prototype._transformAttributes.call(this,e,s);e=n.titleAttributes;var r=t.excise(e,"checkoutDate"),o=t.excise(e,"expireDate");return r&&(n.createTime=this._utcStringToTime(r)),o&&(n.expireTime=this._utcStringToTime(o)),n.checkoutId=t.excise(e,"checkoutId"),n.renewableTime=this._utcStringToTime(t.excise(e,"renewableOn")),n.returnableTime=t.excise(e,"isReturnable")?t.epochMilliseconds():null,n.isLuckyDayLoan=t.excise(e,"isLuckyDayCheckout")||!1,t.excise(e,"bundledContent"),t.excise(e,"isBundledChild"),t.excise(e,"isAssigned"),t.excise(e,"expires"),n},n._deserializeAttributes=function(e){var s=i.prototype._deserializeAttributes.call(this,e);return this.checkoutId=t.excise(e,"checkoutId"),this.renewableTime=t.excise(e,"renewableTime"),this.returnableTime=t.excise(e,"returnableTime"),this.isLuckyDayLoan=t.excise(e,"isLuckyDayLoan"),this.journey=this.title.journey(),s},n._serializeAttributes=function(){var e=i.prototype._serializeAttributes.call(this);return this.holding()&&(e.holding=this.holding().export()),this.isLuckyDayLoan&&(e.isLuckyDayLoan=!0),e.checkoutId=this.checkoutId,e.renewableTime=this.renewableTime,e.returnableTime=this.returnableTime,e},s}),define("app/models/items/hold",["require","common","app/models/items/possession"],function(e){var t=e("common"),i=e("app/models/items/possession"),s=i.new(),n=s.prototype;return n.POSSESSION_TYPE="hold",n.isSuspended=function(){return this.suspendTime>=t.epochMilliseconds()},n.suspendedDaysRemaining=function(){var e=(this.suspendTime-t.epochMilliseconds())/1e3;return Math.max(0,Math.ceil(e/86400))},n.redeliveryDate=function(){if(this.isRedeliverable&&this.isSuspended()){var e=this.suspendedDaysRemaining(),i=t.epochMilliseconds()+24*e*60*60*1e3;return new Date(i)}},n._transformAttributes=function(e,s){var n=i.prototype._transformAttributes.call(this,e,s);e=n.titleAttributes;var r=t.excise(e,"placedDate"),o=t.excise(e,"expireDate");r&&(n.createTime=this._utcStringToTime(r)),o&&(n.expireTime=this._utcStringToTime(o));var a=t.excise(e,"suspensionEnd");t.excise(e,"suspensionFlag")&&a?n.suspendTime=this._utcStringToTime(a):n.suspendTime=0,n.isAvailable=!!e.isAvailable,n.redeliverCounts={automated:e.redeliveriesAutomatedCount||0,requested:e.redeliveriesRequestedCount||0},n.isRedeliverable=!!(n.isAvailable||n.redeliverCounts.automated||n.redeliverCounts.requested);var l=t.epochMilliseconds();return n.isAvailable||n.suspendTime<=l?n.isRedeliveringAutomatically=!1:n.redeliverCounts.automated&&!n.redeliverCounts.requested?n.isRedeliveringAutomatically=!0:n.suspendTime>l+6048e5+6e4?n.isRedeliveringAutomatically=!1:n.isRedeliveringAutomatically=this.isRedeliveringAutomatically||!1,this.isRedeliveringAutomatically&&n.isRedeliveringAutomatically&&n.suspendTime!=this.suspendTime&&n.redeliverCounts.requested>this.redeliverCounts.requested&&n.redeliverCounts.automated==this.redeliverCounts.automated&&(n.isRedeliveringAutomatically=!1),t.excise(e,"emailAddress"),t.excise(e,"autoCheckoutFlag"),t.excise(e,"autoRenewFlag"),n},n._deserializeAttributes=function(e){var s=i.prototype._deserializeAttributes.call(this,e);return this.suspendTime=t.excise(e,"suspendTime"),this.isAvailable=t.excise(e,"isAvailable")||!1,this.isRedeliverable=t.excise(e,"isRedeliverable")||!1,this.isRedeliveringAutomatically=t.excise(e,"isRedeliveringAutomatically")||!1,this.redeliverCounts=t.excise(e,"redeliverCounts")||{},s},n._serializeAttributes=function(){var e=i.prototype._serializeAttributes.call(this);return this.holding()&&(e.holding=this.holding().export()),this.isAvailable&&(e.isAvailable=this.isAvailable),this.isRedeliverable&&(e.isRedeliverable=this.isRedeliverable),(t.try(this.redeliverCounts,"automated")||t.try(this.redeliverCounts,"requested"))&&(e.redeliverCounts=t.absorb(this.redeliverCounts,{})),this.isRedeliveringAutomatically&&(e.isRedeliveringAutomatically=this.isRedeliveringAutomatically),e.suspendTime=this.suspendTime,e.emailAddress=this.emailAddress,e},s}),define("app/models/collations/possessions",["require","common","./collation","app/models/items/loan","app/models/items/hold","app/models/items/loan"],function(e){var t=e("common"),i=e("./collation"),s=i.new(),n=s.prototype;return n.POSSESSION_CLASS={loan:e("app/models/items/loan"),hold:e("app/models/items/hold"),extra:e("app/models/items/loan")},n.BANK_PREFIX="patron:",n.$init=function(e,t,s){this.type=e,this.ITEM_NAME=this.type,this.ITEM_CLASS=this.POSSESSION_CLASS[this.type],this.PERSISTENCE=t,this.ANNOUNCE=s,i.prototype.$init.call(this)},n.criteria=function(){var e={};e.sort=["newest","oldest","title","author"],"loan"==this.type?(e.sort.unshift("due"),e.sort.unshift("activity")):"hold"==this.type&&e.sort.unshift("expected-next"),e.sort.unshift("default"),e.format=["all"].concat(APP.constants.formats());var i=["all"];return t.each(APP.libraries.withCards(),function(e){i.push(e.websiteId)},this),i.length>2&&(e.source=i),e},n.collate=function(e){var i={};e.format&&"all"!=e.format&&(i["title.format"]=e.format),e.source&&"all"!=e.source&&(i["library.websiteId"]=e.source);var s;s=t.isEmpty(i)?this.all.slice(0):this.filter(i);var n=e.sort;return n&&"default"!=n||(n=this.criteria().sort[1]),s.sort(this._compareItemsBy.bind(this,n))},n._attributesToQuery=function(e,t){var i={},s=e["internal"==t.source?"titleId":"id"];return s&&(i["title.titleId"]=s),e.cardId&&(i["card.cardId"]=e.cardId),i},n._isValidItem=function(e){return!(!e||!e.title)&&!(!e.card&&t.among(e.type,"loan","hold"))},n._compareItemsBy=function(e,t,s){if("activity"==e){var n=Math.max(t.createTime,t.journey.timestamp),r=Math.max(s.createTime,s.journey.timestamp);return n<r?1:-1}if("due"==e)return t.expireTime>s.expireTime?1:-1;if("expected-next"==e){if(t.isAvailable)return-1;if(s.isAvailable)return 1;var o=t.holding(),a=s.holding();return o&&a?o.estimatedWaitInDays()-a.estimatedWaitInDays():0}return i.prototype._compareItemsBy(e,t,s)},s}),define("app/models/items/magazine",["require","common","app/models/items/possession"],function(e){var t=e("common"),i=e("app/models/items/possession"),s=i.new(),n=s.prototype;return n.POSSESSION_TYPE="magazine",n.added=function(){APP.titles.luggages.createLuggageFor(this)},n.removed=function(){APP.titles.luggages.removeLuggageFor(this)},n.isMarkedAsFinished=function(){return"boolean"==typeof this._.markedAsFinished?this._.markedAsFinished:this.title.journey().progress>.95},n.isLatestIssueOfSubscription=function(){return!(!this.taggings||!this.latestIssueAt)},n.addSubscriptionTagging=function(e,t){if(!(e&&e.uuid&&t&&t.titleId))return APP.journal.warn("[MAGAZINE] invalid tag or title",e,t);t.format=t.format||"magazine",this.taggings=this.taggings||[];for(var i=0,s=this.taggings.length;i<s;++i)if(this.taggings[i].tag.uuid==e.uuid&&this.taggings[i].title.titleId==t.titleId)return;this.taggings.push({tag:e,title:t})},n.keepInRack=function(){this.expireTime=this.collation.keepUntilMS(),t.defer(this.collation,"undismiss-rack",function(){APP.patron.undismiss("shelf-summary:magazineRack")},100),this.collation._dispatchSubscriptions()},n.stopKeepingInRack=function(){this.taggings?t.excise(this,"expireTime"):this.remove(),this.collation._dispatchSubscriptions()},n.daysToKeepInRack=function(){var e=this.expiryDate();if(!e)return 0;var i=t.epochMilliseconds(),s=e.getTime();if(s<=i)return 0;var n=t.secondsToUnits((s-i)/1e3);return Math.max(1,7*(n.weeks||0)+n.days)},n.expiryDate=function(){if(this.expireTime){var e=new Date(this.expireTime).setHours(24,0,0,0);return new Date(e-1)}},n.associateBestCard=function(){var e=this.collation.getCardForIssue(this.title);if(e)return this._associateCard(e);var i=this._.genesis,s=i.cardId?APP.patron.cards.find({cardId:i.cardId}):null;if(s&&s==this.card)return this.card;if(s)return this._associateCard(s);if(this.card&&this.card.removedFromCollation)delete this.card;else if(this.card)return this.card;var n=APP.patron.cards.find({advantageKey:i.libraryKey});return n&&!n.isContentRestricted()?this._associateCard(n):void this.title.holdings.withBestCircAction(function(e){if("borrow"==e.action)for(var i=APP.patron.cards.filter({advantageKey:e.libraryKey}),s=0,n=i.length;s<n;++s)if(!i[s].isContentRestricted())return this._associateCard(i[s]),"stop";return"complete"!=e.status?"continue":(t.try(this.luggage(),"remove()"),"stop")}.bind(this),{libraries:{scope:APP.libraries.withCards()}})},n._associateCard=function(e){if(e&&this.card!=e)return this.card=e,this.library=this.card.library||this.library,this.psnKey=this._generatePsnKey(),this.card},n._generatePsnKey=function(){return[t.try(this._.genesis,"cardId")||t.try(this.card,"cardId")||"xx",t.try(this.title,"titleId")||"yy"].join("-")},n._transformAttributes=function(e,s){var n=t.excise(e,"loan");return n&&(e=t.absorb(e,i.prototype._transformAttributes.call(this,n,s))),e.titleAttributes=t.absorb(e.titleAttributes,{format:"magazine",title:t.excise(e,"title"),parentMagazineTitleId:t.excise(e,"parentMagazineTitleId")}),e},n._deserializeAttributes=function(e){"boolean"==typeof e.markedAsFinished&&(this._.markedAsFinished=t.excise(e,"markedAsFinished")),e.latestIssueAt&&(this.latestIssueAt=t.excise(e,"latestIssueAt"));var s=this._.genesis=t.excise(e,"genesis")||{},n=t.excise(e,"taggings"),r=t.excise(e,"fulfillments"),o=i.prototype._deserializeAttributes.call(this,e);return s.cardId=s.cardId||t.try(this.card,"cardId"),s.websiteId=s.websiteId||t.try(this.card,"library.cardId"),s.websiteId=s.websiteId||t.try(this.library,"websiteId"),s.libraryKey=t.try(this.card,"advantageKey"),t.each(n,function(e){var t=e.tag||APP.patron.tags.find({uuid:e.tagUUID});if(t){var i=e.title||APP.titles.produce({titleId:e.titleId});this.addSubscriptionTagging(t,i)}else APP.journal.warn("[MAGAZINE] tag not found:",e.tagUUID)},this),this.fulfiller=this.title.fulfiller(this.library),t.try(r,"length")&&!t.try(this.fulfiller,"fulfillments.length")&&(this.fulfiller.fulfillments=r.slice()),this.taggings&&this.isExpired()&&delete this.expireTime,o},n._serializeAttributes=function(){var e=i.prototype._serializeAttributes.call(this);"boolean"==typeof this._.markedAsFinished&&(e.markedAsFinished=this._.markedAsFinished),this.latestIssueAt&&(e.latestIssueAt=this.latestIssueAt),e.genesis=this._.genesis,t.each(this.taggings,function(t){e.taggings=e.taggings||[],e.taggings.push({tagUUID:t.tag.uuid,titleId:t.title.titleId})});var s=t.try(t.excise(e,"fulfiller"),"fulfillments");return s&&(e.fulfillments=s),e.titleAttributes={format:"magazine",title:this.title.title,parentMagazineTitleId:this.title.parentMagazineId,releaseTime:this.title.releaseTime},e},s}),define("app/models/collations/magazines",["require","common","./possessions","app/models/items/magazine"],function(e){var t=e("common"),i=e("./possessions"),s=i.new(),n=s.prototype;return n.REFRESH_TTL=144e5,n.REFRESH_BATCH_SIZE=96,n.OPEN_HISTORY_MAX=24,n.KEEP_MS=6048e5,n.$init=function(){i.prototype.$init.apply(this,arguments),this.ITEM_CLASS=e("app/models/items/magazine"),this._listen()},n.loaded=function(){var e=t.select(APP.patron.loans.all,function(e){if("magazine"==t.try(e,"title.format"))return e});e.length&&(APP.journal.log("[MAGAZINES] converting %s loans to kept issues",e.length),APP.patron.loans.loadingLock(function(){t.each(e,function(e){var i=this.keepIssue(e.title,{cardId:t.try(e,"card.cardId"),websiteId:t.try(e,"library.websiteId")});i&&e.remove()},this)}.bind(this)))},n.keepUntilMS=function(){var e=parseFloat(APP.flags.property("mag-keep-ms"))||this.KEEP_MS;return t.epochMilliseconds()+e},n.keepIssue=function(e,i){i=t.absorb(i,{});var s=this.find({"title.titleId":e.titleId}),n=t.try(i,"library.websiteId")||i.websiteId;if(s){if(i.cardId){var r=APP.patron.cards.find({cardId:i.cardId});s._associateCard(r)}n&&!t.try(s,"card.library")&&(s.library=APP.libraries.produce({websiteId:n}))}else{if(n=n||t.try(APP.library,"websiteId"),!n)return APP.journal.warn("[MAGAZINES] no active library to keep issue");s=this.make({titleId:e.titleId,cardId:i.cardId||t.try(APP.library,"card().cardId"),websiteId:n},{source:"internal",integrity:"complete"})}return t.try(s,"keepInRack()"),s},n.stopKeepingIssue=function(e){t.try(this.find({"title.titleId":e.titleId}),"stopKeepingInRack()")},n.isIssueInRack=function(e){return!!this.find({"title.titleId":e.titleId})},n.getCardForIssue=function(e){if(this.loanPairings){var i=t.try(e,"titleId")||e;if("string"==typeof i)for(var s=0,n=this.loanPairings.length;s<n;++s)if(this.loanPairings[s].titleId==i){var r=r||t.epochMilliseconds();if(this.loanPairings[s].expireTime>=r){var o=this.loanPairings[s].cardId;return APP.patron.cards.find({cardId:o})}}}},n.setCardForIssue=function(e,i,s){this.loanPairings=this.loanPairings||[];var n=t.try(e,"titleId")||e;if("string"==typeof n){if(null===i)return void(this.loanPairings=t.select(this.loanPairings,function(e){if(e.titleId!=n)return e}));var r=t.try(i,"cardId")||i;if("string"==typeof r||"number"==typeof r){s=s||this.keepUntilMS();for(var o=0,a=this.loanPairings.length;o<a;++o){var l=this.loanPairings[o];if(l.titleId==n)return l.cardId=r,l.expireTime=Math.max(s,l.expireTime),l}var l={titleId:n,cardId:r,expireTime:s};return this.loanPairings.push(l),this.save(),l}}},n.markIssueAsOpened=function(e){if("string"==typeof e&&(e=APP.titles.produce({titleId:e})),e&&e.parentMagazineId){var i=[e.titleId,e.parentMagazineId,t.epochMilliseconds()],s=[i].concat(this.openHistory||[]),n={},r=0;this.openHistory=t.select(s,function(e){if(r>=this.OPEN_HISTORY_MAX)return t.breakIteration();if(!n[e[0]])return n[e[0]]=r++,e}),this.save()}},n.isSubscribed=function(e){if(!e.parentMagazineId)return!1;for(var t=this.filter({"title.parentMagazineId":e.parentMagazineId}),i=0,s=t.length;i<s;++i)if(t[i].taggings)return!0;return!1},n.unsubscribe=function(e,i,s){if(e.parentMagazineId){var n=[e],r=this.filter({"title.parentMagazineId":e.parentMagazineId});t.each(r,function(e){t.each(t.excise(e,"taggings"),function(e){!e||!e.title||n.indexOf(e.title)>=0||n.push(e.title)}),e.daysToKeepInRack()||e.remove()}),n=t.select(n,function(e){var i=!1;return t.each(t.try(e,"tags.all"),function(s){"notify-me"==t.try(s,"behavior.key")&&(s.removeFromTitle(e,{skipVandal:!0}),i=!0)}),i?e:void 0}),APP.services.vandal.unsubscribe(e.parentMagazineId,function(e){var s={};t.each(e.taggings,function(e){var t=e.tagUUID,i=APP.patron.tags.find({uuid:t});if(!i)return APP.journal.warn("[MAGAZINES] tag not found",t);var n=APP.titles.find({titleId:e.titleId});n&&i.removeFromTitle(n,{skipVandal:!0}),s[i.uuid]=s[i.uuid]||[],s[i.uuid].push(n)},this),"function"==typeof i&&i({unsubscribe:s}),this._dispatchSubscriptions()}.bind(this),function(){t.each(n,function(e){e.tags.reset()}),"function"==typeof s&&s()}.bind(this))}},n.subscriptions=function(){return t.select(this.all,function(e){if(e.taggings)return e})},n.refresh=function(e){e=t.absorb(e,{refreshTTL:this.REFRESH_TTL});var i=!(e.refreshTTL!=this.REFRESH_TTL||!this._.refreshingCallbacks);if(this._.refreshingCallbacks=this._.refreshingCallbacks||[],e.callback&&this._.refreshingCallbacks.push(e.callback),!i){var s=t.epochMilliseconds(),n=s-e.refreshTTL,r=[],o=[],a=function(){for(;t.try(this._.refreshingCallbacks,"length");)this._.refreshingCallbacks.shift()(this.all,r);delete this._.refreshingCallbacks}.bind(this);if(APP.network.reachable){var l={};t.each(this.all,function(e){var i=t.try(e.title,"parentMagazineId");if(i&&e.taggings){var s=l[i],n=t.try(s,"latestIssueAt")||0;n<=(e.latestIssueAt||0)?l[i]=e:s=e,s&&(t.excise(s,"latestIssueAt"),t.excise(s,"taggings"))}}),t.each(l,function(e,t){(t.latestIssueAt||0)>n||(delete t.latestIssueAt,o.push(e))})}if(!o.length)return a();var c=function(e){var i=[];if(e)try{i=JSON.parse(e)}catch(t){APP.journal.warn("[MAGAZINES] invalid refresh response",t,e)}t.each(i,function(e){var i=e.parentMagazineTitleId;if(i){var n,o,a,l=this.filter({"title.parentMagazineId":i});if(t.each(l,function(i){APP.journal.debug("[MAGAZINES] refreshing...",{id:i.title.titleId,parentId:i.title.parentMagazineId,title:i.title.title}),i.title.titleId==e.id?n=i:(a=t.excise(i,"taggings")||a,o=o||i,i.daysToKeepInRack()||(o=i,t.try(o,"luggage().status().isDownloaded")?o.keepInRack():o.remove()))}),!n&&o){var c=APP.titles.produce({titleId:e.id});c.import(e,{source:"external",integrity:"complete"}),n=this.make({titleId:c.titleId,cardId:t.try(o,"card.cardId"),websiteId:t.try(o,"library.websiteId")},{source:"internal",integrity:"complete"}),n&&r.push(n)}n&&a&&(n.taggings=a),(n||o||{}).latestIssueAt=s}},this);var n=o.splice(0,this.REFRESH_BATCH_SIZE);if(n.length)APP.services.thunder.fetch("media/bulk?titleIds="+n.join(","),c,c);else{var l=t.select(this.all,function(e){if(!e.title.releaseTime)return e.title}),h=function(){t.defer(this,"refresh-fetch",function(){(r.length||l.length)&&this._dispatchSubscriptions(),a()}.bind(this))}.bind(this);t.each(l,function(e){e.use(function(e,t){return t.releaseTime||e.isBroken?void h():t.reuse()},this)},this),l.length||h()}}.bind(this);c()}},n._attributesToQuery=function(e,t){var i={};return e.titleId&&(i["title.titleId"]=e.titleId),e.parentMagazineId&&(i["title.parentMagazineId"]=e.parentMagazineId),i},n._isValidItem=function(e){return!!t.try(e,"title.parentMagazineId")&&i.prototype._isValidItem.apply(this,arguments)},n._listen=function(){APP.events.on("card:add",this._onCardAdd.bind(this)),APP.events.on("card:remove",this._onCardRemove.bind(this)),APP.events.on("patron:sync:magazines",this._onPatronSyncMagazines.bind(this)),APP.events.on("tagging:notify-me:attach",this._onTaggingNotifyMeAttach.bind(this)),APP.events.on("tagging:notify-me:detach",this._onTaggingNotifyMeDetach.bind(this))},n._onCardAdd=function(e){this._associateBestCardForEachMagazine()},n._onCardRemove=function(e){this._associateBestCardForEachMagazine()},n._associateBestCardForEachMagazine=function(){t.each(this.all,function(e){e.associateBestCard()})},n._onPatronSyncMagazines=function(e){var i=t.try(e,"m.subscriptions.taggings");i&&this.loadingLock(function(){var e={source:"external",integrity:"incomplete"},s=this.all.slice(),n=t.unique(t.select(i,function(t){var i=t.parentMagazineTitleId;if(i){var s=this._findMagazineWithSubscription(i)||this.find({"title.parentMagazineId":i});s&&s.title.titleId==t.titleId?s.import(t,e):s||(s=this._deserializeItems([t],e)[0]);var n=APP.patron.tags.find({uuid:t.tagUUID}),r=APP.titles.produce({titleId:t.titleId});return s.addSubscriptionTagging(n,r),s}},this));t.each(s,function(e){t.among(e,n)||(t.excise(e,"taggings"),e.daysToKeepInRack()||e.remove())})}.bind(this)),delete this.loanPairings,t.try(e,"m.loans")&&t.each(e.m.loans.slice().sort(function(e,t){return e.expireDate>t.expireDate?1:-1}),function(e){var t=this._utcStringToTime(e.expireDate);this.setCardForIssue(e.id,e.cardId,t)}.bind(this)),this._associateBestCardForEachMagazine(),this._dispatchSubscriptions()},n._onTaggingNotifyMeAttach=function(e){var i=t.try(e.m.tagging,"title.parentMagazineId");if(i){var s=this._findMagazineWithSubscription(i)||this.find({"title.parentMagazineId":i})||this.make({titleId:e.m.tagging.title.titleId,cardId:e.m.tagging.cardId,websiteId:e.m.tagging.websiteId},{source:"internal",integrity:"complete"});s.addSubscriptionTagging(e.m.tag,e.m.tagging.title),this._dispatchSubscriptions()}},n._onTaggingNotifyMeDetach=function(e){var i=t.try(e,"m.tag"),s=t.try(e.m,"tagging.title"),n=t.try(s,"parentMagazineId");if(i&&s&&n){var r=this._findMagazineWithSubscription(n);r&&r.taggings&&(r.taggings=t.select(r.taggings,function(e){return e.tag.uuid!=i.uuid?e:e.title.titleId!=s.titleId?e:void 0}),r.taggings.length||(delete r.taggings,r.daysToKeepInRack()||r.remove()),this._dispatchSubscriptions())}},n._findMagazineWithSubscription=function(e){for(var t=0,i=this.all.length;t<i;++t)if(this.all[t].title.parentMagazineId==e&&this.all[t].taggings)return this.all[t]},n._dispatchSubscriptions=function(){this.save(),t.defer(this,"tag-subs",function(){APP.events.dispatch("tag:subscriptions",{subscriptions:this.subscriptions()})}.bind(this),100)},n._serializeAttributes=function(){var e={};return this.openHistory&&(e.openHistory=this.openHistory),this.loanPairings&&(e.loanPairings=this.loanPairings),e},s}),define("app/models/agents/tags-agent",["require","common","./usage-agent"],function(e){var t=e("common"),i=e("./usage-agent"),s=i.new(),n=s.prototype;return n._processBatch=function(e){e.context={source:"internal",integrity:"complete"},APP.services.vandal.summaryOfTags(this._onRequestSuccess.bind(this,e),this._onRequestFailure.bind(this,e),e.context)},n._onRequestSuccess=function(e,i){var s=e.queue[0];this._importTask(s,t.clone(i),e.context),this._succeedTask(s)},s}),define("app/models/behaviors/tag-behavior",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.KEY="undefined",s.$init=function(){this.key=this.KEY,this.handlers={}},s.attachability=function(e){for(var i=0,s=APP.patron.tags.all.length;i<s;++i){var n=APP.patron.tags.all[i];if(n.uuid!=e.uuid&&t.try(n.behavior,"key")==this.key)return{usedBy:n}}return!0},s.attach=function(e){this.tag=e},s.detach=function(){APP.events.off(this.handlers),delete this.handlers,delete this.tag},s.import=function(e){},s.export=function(){return{}},s.addTagging=function(e){},s.removeTagging=function(e){},s._handle=function(e,t){APP.events.off(this.handlers[e]),this.handlers[e]=APP.events.on(e,function(e){return this._isAttached()?void t(e):this.detach()}.bind(this))},s._isAttached=function(){return!!this.tag&&(this.tag.behavior==this&&!!t.among(this.tag,APP.patron.tags.all))},i}),define("app/models/behaviors/tag-behavior-notify-me",["require","common","./tag-behavior"],function(e){var t=e("common"),i=e("./tag-behavior"),s=i.new(),n=s.prototype;return n.KEY="notify-me",n.POLLING_FREQUENCY_MS=864e5,n.POLLING_INTERVAL_MS=8e3,n.MAX_POLL_QUEUE_PER_SESSION=50,n.attachability=function(e){return!0},n.attach=function(e){this.tag=e,this.tag.collation&&(this.tag.page({},0,1/0,function(e){t.each(e,this._dispatchTaggingEvent.bind(this,"attach"))}.bind(this)),this._preparePollQueue())},n.detach=function(){clearTimeout(this._.pollingTimer),this.tag.page({},0,1/0,function(e){t.each(e,function(e){t.try(e.properties,"clientPolledAt")&&(delete e.properties.clientPolledAt,e.save()),this._dispatchTaggingEvent("detach",e)},this)}.bind(this)),i.prototype.detach.call(this)},n.import=function(e){t.try(e,"excludedTitleIds.length")&&(this._.excludedTitleIds=e.excludedTitleIds)},n.export=function(){var e={type:"subscription"};return t.try(this,"_.excludedTitleIds")&&(e.excludedTitleIds=this._.excludedTitleIds),e},n.addTagging=function(e){t.try(this._.pollingQueue,"unshift()",e),this._pollTaggings(),this._dispatchTaggingEvent("attach",e)},n.removeTagging=function(e){t.excise(this._.pollingQueue,e),this._dispatchTaggingEvent("detach",e)},n.isSubscribed=function(e,i){this.tag.page({},0,1/0,function(s){for(var n=0,r=s.length;n<r&&i;++n){t.try(s[n],"properties.queries")||this._computeQueriesForTagging(s[n]);var o=t.try(s[n],"properties.queries")||{};t.each(o,function(s){t.each(e,function(e,n){s.query[e]==n&&(i(!0),i=null,t.breakIteration())}),i||t.breakIteration()})}i&&i(!1)}.bind(this))},n._computeQueriesForTagging=function(e,i){e.title.use(function(s,n){if(!n.format)return n.reuse();var r={queries:[{notificationType:"notify-me-title",query:{id:n.titleId}}],satisfactions:t.try(e.properties,"satisfactions")||[]};if(n.parentMagazineId)r.queries.push({notificationType:"notify-me-series",query:{parentMagazineTitleId:n.parentMagazineId}});else{t.try(n,"series.name")&&r.queries.push({notificationType:"notify-me-series",query:{"series.id":n.series.id,"series.name":n.series.name,mediaType:APP.constants.mediaTypes(n.format),"languages.id":t.try(n,"languages[0].id")}});var o=n.authors();o&&o.length<=2&&t.each(o,function(e){r.queries.push({notificationType:"notify-me-author",query:{"creators.id":e.id,"languages.id":t.try(n,"languages[0].id")}})})}e.properties=r,APP.journal.debug("[TAG-NM] queries for %s -> %s",this.tag.name,e.title.titleId,r.queries),"function"==typeof i&&i(e)}.bind(this))},n._executeQueriesForTagging=function(e,i){if(i=i||this._executedQueriesForTagging.bind(this,e),!t.try(e.properties,"queries"))return i(e);var s=e.properties.queries.slice(0),n=function(){var t=s.shift();t?this._executeQueryForTagging(e,t,n):"function"==typeof i&&i(e)}.bind(this);n()},n._executeQueryForTagging=function(e,i,s){var n=this._.pollables.slice(0),r=function(){var o=i.query.id&&t.among(i.query.id,e.properties.satisfactions),a=n.shift();a&&!o?this._executeQueryAtPollable(e,i,a,r):"function"==typeof s&&s()}.bind(this);if(!n.length){var o=e.library();o&&o.use(function(e){return e.isBroken?r():o.key()?(n.push({key:o.key(),library:o}),void r()):o.reuse()})}r()},n._executeQueryAtPollable=function(e,i,s,n){if(i.query.id)e.title.holding(s.key).use(function(t,r){return t.isIdeal?(r.isOwned&&this._satisfyTagging(e,i,e.title,s),void n()):r.reuse()}.bind(this));else{var r,o=1/0;if(i.query.parentMagazineTitleId)r="issues-"+i.query.parentMagazineTitleId;else if(i.query["series.name"]){if(r=i.query["series.id"]?"series-"+i.query["series.id"]:"search/series-"+encodeURIComponent(i.query["series.name"]),i.query.mediaType){var a=i.query.mediaType,l=t.try(APP.constants.FORMAT_MAPPINGS[a],"plural");l&&(r+="/"+l)}i.query["languages.id"]&&(r+="/language-"+i.query["languages.id"]),r+="/sort-newlyadded",o=48}else i.query["creators.id"]&&(r="creator-"+i.query["creators.id"],i.query["languages.id"]&&(r+="/language-"+i.query["languages.id"]),r+="/sort-newlyadded",o=48);if(!r)return n();r+="/facets-false";var c=s.library.catalog.lists.produce(r);c.PAGE_SIZE=Math.min(o,96),c.freshen(0,o,function(r,o){var a=[];t.each(o,function(s){s.titleId!=t.try(e,"title.titleId")&&(a.length&&i.query.parentMagazineTitleId?s.publicationTime>a[0].publicationTime&&a.splice(0,1,s):a.push(s));
},this),t.each(a,function(t){this._satisfyTagging(e,i,t,s)},this),n()}.bind(this),n)}},n._satisfyTagging=function(e,i,s,n){if(this.tag&&t.try(e.properties,"satisfactions")&&!t.among(s.titleId,e.properties.satisfactions)&&!t.among(s.titleId,this._.excludedTitleIds)){if("notify-me-author"==i.notificationType){var r=!1;if(t.each(s.authors().slice(0,2),function(e){e.id==i.query["creators.id"]&&t.breakIteration(r=!0)}),!r)return}e.properties.satisfactions.push(s.titleId),APP.journal.debug("[TAG-NM] %s satisfied: %s -> %s",this.tag.name,s.title,n.library.safeName()),e.properties.clientPolledAt&&APP.notifier.post(i.notificationType,[{id:s.titleId,provisional:!1,details:{titleId:s.titleId,websiteId:n.library.websiteId,cardId:t.try(n.card,"cardId"),psnKey:e.title.titleId}}],{avoidOverwrites:!0,flush:{dismissed:!0}})}},n._executedQueriesForTagging=function(e){this.tag&&(e.properties=e.properties||{},e.properties.clientPolledAt=t.epochMilliseconds(),e.save())},n._preparePollQueue=function(){!this._.pollingQueue&&this.tag&&this.tag.page({},0,1/0,function(e){if(!this._.pollingQueue){var i=t.epochMilliseconds();this._.pollingQueue=[],t.each(e,function(e){var s=t.try(e.properties,"clientPolledAt")||0;i-s<=this.POLLING_FREQUENCY_MS||this._.pollingQueue.push(e)},this),this._.pollingQueue=this._.pollingQueue.sort(function(e,i){var s=t.try(e.properties,"clientPolledAt")||0,n=t.try(i.properties,"clientPolledAt")||0;return s-n}).slice(0,this.MAX_POLL_QUEUE_PER_SESSION),this._pollTaggings(),this._listenForNetworkReachability(),this._listenForDebugCommand()}}.bind(this),this._listenForNetworkReachability.bind(this))},n._pollTaggings=function(){if(this.tag){if(!this._.pollingQueue)return this._preparePollQueue();clearTimeout(this._.pollingTimer);var e=[],i=t.shuffle(APP.patron.cards.all.slice());this._.pollables=t.select(i,function(i){if(!t.among(i.advantageKey,e))return e.push(i.advantageKey),{key:i.advantageKey,card:i,library:i.library}},this),APP.journal.debug("[TAG-NM] Polling %s taggings...",this._.pollingQueue.length,new Date);var s=function(e){if(clearTimeout(this._.pollingTimer),this.tag){if(e&&this._executedQueriesForTagging(e),e=this._.pollingQueue.shift(),!e)return APP.journal.debug("[TAG-NM] completed polling:",this.tag.name);var i=this._executeQueriesForTagging.bind(this,e,s);this._.pollingTimer=setTimeout(function(){t.try(e.properties,"queries")?i():this._computeQueriesForTagging(e,i)}.bind(this),this.POLLING_INTERVAL_MS)}}.bind(this);s()}},n._listenForNetworkReachability=function(){this._.reachabilityHandler||(this._.reachabilityHandler=APP.events.on("network:info",function(e){this.tag&&e.m.network.reachable&&this._pollTaggings()}.bind(this)))},n._dispatchTaggingEvent=function(e,t){APP.events.dispatch("tagging:notify-me:"+e,{tag:this.tag,tagging:t})},n._listenForDebugCommand=function(){this._.debugCommandHandler||(this._.debugCommandHandler=APP.events.on("debug:command",function(e){if(this.tag){var t,i,s=e.m.command||"";s.match(/poll-notify-me/)||s.match(/poll-nm/)?t=this._debugCommandPollImmediately():(i=s.match(/unsatisfy-nm (.+)/))?t=this._debugCommandUnsatisfyTitle(i[1]):(i=s.match(/exclude-nm (.+)/))?t=this._debugCommandExcludeTitle(i[1]):s.match(/clear-nm/)&&(t=this._debugCommandClearNotifications()),t&&(e.m.output+="["+this.tag.niceName()+"] "+t+"\n")}}.bind(this)))},n._debugCommandPollImmediately=function(){return this.POLLING_FREQUENCY_MS=0,delete this._.pollingQueue,this._preparePollQueue(),"Polling..."},n._debugCommandUnsatisfyTitle=function(e){return this.tag.page({},0,1/0,function(i){t.each(i,function(i){var s=t.try(i.properties,"satisfactions");t.among(e,s)&&(t.excise(s,e),i.save())})}),"Unsatisfying "+e+" in taggings..."},n._debugCommandExcludeTitle=function(e){return this._.excludedTitleIds=this._.excludedTitleIds||[],t.among(e,this._.excludedTitleIds)?t.excise(this._.excludedTitleIds,e):(this._debugCommandUnsatisfyTitle(e),this._.excludedTitleIds.push(e)),this.tag.save(),"Excluding "+e+" from polling..."},n._debugCommandClearNotifications=function(){return APP.notifier.notifications.removeAll({category:"notify-me-title"}),APP.notifier.notifications.removeAll({category:"notify-me-series"}),APP.notifier.notifications.removeAll({category:"notify-me-author"}),"Cleared Notify Me notifications"},s}),define("app/models/behaviors/tag-behavior-borrowed",["require","common","./tag-behavior"],function(e){var t=e("common"),i=e("./tag-behavior"),s=i.new(),n=s.prototype;return n.KEY="borrowed",n.attach=function(e){i.prototype.attach.call(this,e),this._handle("loan:borrowed",this._onLoanBorrowed.bind(this)),this._handle("history:migration:complete",this._onHistoryMigrationComplete.bind(this))},n.import=function(e){t.isList(e.importedFromActivities)?this._.importedFromActivities=e.importedFromActivities:"boolean"==typeof e.importedFromActivities&&(this._.importedFromActivities=this._currentCardIds())},n.export=function(){return{type:"autonomous",importedFromActivities:this._.importedFromActivities}},n.withImportableActivities=function(e){var i=this._currentCardIds(),s=this._.importedFromActivities||[];if(i.length<=s.length){for(var n=[],r=0,o=i.length;r<o;++r)t.among(i[r],s)||n.push(i[r]);if(!n.length)return e([])}var a={},l=[];this.tag.page({},0,1/0,function(i){t.each(i,function(e){a[e.title.titleId]=e.createTime||1});var s=APP.patron.activities.collate({act:"loans"});s.sort(function(e,t){return e.createTime-t.createTime}),t.each(s,function(e){e.title&&e.library&&(a[e.title.titleId]||(a[e.title.titleId]=e.createTime||1,l.push({title:e.title,library:e.library,createTime:e.createTime})))}),e(l)})},n.markAllActivitiesImported=function(){this._.importedFromActivities=this._currentCardIds(),this.tag.save()},n._onLoanBorrowed=function(e){var i=t.try(e.m,"item.title");i&&this.tag.addToTitle(i,t.try(e.m,"item.library"))},n._currentCardIds=function(){var e=[];return t.each(APP.patron.cards.all,function(t){e.push(t.cardId)}),e.sort()},n._onHistoryMigrationComplete=function(e){if(this._.importedFromActivities){var i=t.try(e,"m.task");i&&i.done&&i.done.length&&t.each(i.done,function(e){e&&e.progress&&e.progress.added&&(t.excise(this._.importedFromActivities,e.card.cardId),this.tag.save())},this)}},s}),define("app/models/behaviors/tag-behavior-sampled",["require","common","./tag-behavior"],function(e){var t=e("common"),i=e("./tag-behavior"),s=i.new(),n=s.prototype;return n.KEY="sampled",n.attach=function(e){i.prototype.attach.call(this,e),this._handle("title:switch",this._onTitleSwitch.bind(this))},n.import=function(e){},n.export=function(){return{type:"autonomous"}},n._onTitleSwitch=function(e){t.try(e.m,"title")&&t.try(e.m,"info.sample")&&"magazine"!=t.try(e.m,"title.format")&&this.tag.addToTitle(e.m.title,APP.titles.libraryForNow()||APP.library)},s}),define("app/models/behaviors/tag-behavior-wish-list-sync",["require","common","./tag-behavior"],function(e){var t=e("common"),i=e("./tag-behavior"),s=i.new(),n=s.prototype;return n.KEY="wish-list-sync",n.attachability=function(e){return!!t.try(APP,"summoner.daemons.defaultTags.data.wish-list-sync.counts.total")&&i.prototype.attachability.call(this,e)},n.import=function(e){this.coordinatedAt=e.coordinatedAt||0},n.export=function(){return{type:"coordination",things:"wishlist",coordinatedAt:this.coordinatedAt||0}},s}),define("app/models/collations/tags",["require","common","app/models/collations/collation","app/models/agents/usage","app/models/agents/tags-agent","app/models/collations/tag","app/models/behaviors/tag-behavior-notify-me","app/models/behaviors/tag-behavior-borrowed","app/models/behaviors/tag-behavior-sampled","app/models/behaviors/tag-behavior-wish-list-sync"],function(e){var t=e("common"),i=e("app/models/collations/collation"),s=i.new(),n=s.prototype,r=e("app/models/agents/usage"),o=e("app/models/agents/tags-agent");return n.ITEM_CLASS=e("app/models/collations/tag"),n.ITEM_NAME="tag",n.ITEM_KEY="uuid",n.BANK_PREFIX="patron:",n.PERSISTENCE="incomplete",n.BEHAVIORS=[e("app/models/behaviors/tag-behavior-notify-me"),e("app/models/behaviors/tag-behavior-borrowed"),e("app/models/behaviors/tag-behavior-sampled"),e("app/models/behaviors/tag-behavior-wish-list-sync")],n.PATH_FOR_CRITERIA="tags",n.$init=function(){this.usage=new r(this,o),i.prototype.$init.apply(this,arguments)},n.criteria=function(){return{sort:["default","newest","oldest","activity","size","name"],behavior:["all","regular","smart"]}},n.collate=function(e){var i=[];if("regular"==e.behavior?t.each(this.all,function(e){e.behavior||i.push(e)}):"smart"==e.behavior?t.each(this.all,function(e){e.behavior&&i.push(e)}):i=this.all.slice(0),"activity"==e.sort){var s={};return t.each(i,function(e){var i=e.collate({sort:"newest"});s[e.uuid]=t.try(i,"[0].createTime")||e.createTime||0}),i.sort(function(e,t){return s[t.uuid]-s[e.uuid]})}if("size"==e.sort)return i.sort(function(e,t){return t.totalTaggings-e.totalTaggings});if("name"==e.sort)return i.sort(function(e,t){return e.name.localeCompare(t.name)});var n=e.sort;return n&&"default"!=n||(n="newest"),i.sort(this._compareItemsBy.bind(this,n))},n.tagNameInvalidities=function(e,i){if("string"!=typeof e)return{missing:!0};if(e=e.trim(),!e)return{missing:!0};if(i=i||{},t.try(i,"tag.name")!=e){var s=this.find({name:e});if(s)return{usedBy:s}}var n,r=i.measurer||APP.arena._element({parentNode:document.body,classes:"tag-name-measurer"});if(i.isEmoji){APP.arena._textify(r,{html:"🙂"});var o=r.offsetWidth;APP.arena._textify(r,{html:e}),r.offsetWidth!=o&&(n={badEmoji:!0})}else{APP.arena._textify(r,{html:t.safe(e)});var a=r.offsetWidth/72;a>1&&(n={overflow:a})}return i.measurer||r.parentNode.removeChild(r),n||!1},n.suggestTagNamesForBehavior=function(e,i,s){for(var n=APP.arena._element({parentNode:document.body,classes:"tag-name-measurer"}),r=[],o=1,a="tag.suggestion."+(e?e+".":"");o;){var l=t.absorb(s||{},{isEmoji:!0,measurer:n}),c=APP.arena._phrase({label:a+o+".emoji",okIfMissing:!0});if(!c&&(t.excise(l,"isEmoji"),c=APP.arena._phrase({label:a+o,okIfMissing:!0}),!c))break;if(this.tagNameInvalidities(c,l)||r.push(c),i&&r.length>=i)break;o+=1}return n.parentNode.removeChild(n),r},n.suggestTagForPurpose=function(e,i){if(!t.among(e,"notify-me-unowned","notify-me-subscribe"))return APP.journal.warn("[TAGS] unknown purpose",e,i);var s=APP.bank.get("tags:purpose:"+e+":uuid"),n={},r=this.collate({sort:"activity"}),o=t.select(r,function(i,r){if("notify-me"==t.try(i,"behavior.key")){var o=0;i.uuid==s&&(o+=100);var a=(i.name||"").toLowerCase(),l=(i.description||"").toLowerCase();if("notify-me-subscribe"==e?(a.indexOf("📬")>=0&&(o+=20),a.indexOf("subscri")>=0&&(o+=10),l.indexOf("issue")>0&&(o+=5),l.indexOf("subscri")>=0&&(o+=5)):"notify-me-unowned"==e&&(a.indexOf("🔔")>=0&&(o+=20),a.indexOf("notify")>=0&&(o+=10),l.indexOf("added to my")>0&&(o+=1)),o)return n[i.uuid]=o,i}},this),a=o.sort(function(e,t){return n[t.uuid]-n[e.uuid]})[0];if(!a&&t.try(i,"stub")){var l={};"notify-me-subscribe"==e?(l.name=APP.arena._phrase("tag.suggestion.notify-me.5.emoji"),l.description=APP.arena._phrase("tag.suggestion.notify-me.description.subscribe")):"notify-me-unowned"==e&&(l.name=APP.arena._phrase("tag.suggestion.notify-me.1.emoji"),l.description=APP.arena._phrase("tag.suggestion.notify-me.description.unowned"));var c={source:"internal",integrity:"incomplete"},h=new this.ITEM_CLASS;h.import(l,c),h.behave("notify-me"),this.titleId&&h.make({titleId:this.titleId},c),a=h}return a},n.taggingsLimitForPersistence=function(e){return"number"!=typeof e&&(e=this.all.length),e>30?3:e>10?6:12},n.requiresTutorial=function(){if(APP.patron.isDismissed("tutorial:what-are-tags"))return!1;for(var e=0,t=this.all.length;e<t;++e)if(!this.all[e].behavior)return!1;return!0},n._serializeAttributes=function(){return{totalTaggings:this.totalTaggings||0}},s}),define("app/models/items/activity",["require","common","app/models/items/item"],function(e){var t=e("common"),i=e("app/models/items/item"),s=i.new(),n=s.prototype;return n.remove=function(){this.display="removed",APP.events.dispatch("activity:hidden",{activity:this})},n.humanDuration=function(){var e=this.durationUnits();if(e)return APP.arena._phrase({label:"units."+t.excise(e,"UNIT"),substitutions:e})},n.durationUnits=function(){if(this.meta&&this.meta.time){var e=6e4,t=60*e,i=24*t,s={};return this.meta.time/i>=1?(s.units="days",s.quantity=this.meta.time/i):this.meta.time/t>=1?(s.units="hours",s.quantity=this.meta.time/t):(s.units="minutes",s.quantity=Math.max(1,this.meta.time/e)),{UNIT:s.units,N:Math.floor(s.quantity)}}},n._serializeAttributes=function(){var e={};return e.action=this.action,e.createTime=this.createTime,this.title&&(e.titleId=this.title.titleId),(this.card||this.cardId)&&(e.cardId=t.try(this.card,"cardId")||this.cardId),this.library&&(e.websiteId=this.library.websiteId),this.meta&&(e.meta=this.meta),e},n._deserializeAttributes=function(e){var s=t.excise(e,"titleId");s&&(this.title=APP.titles.produce({titleId:s}),this.title||(this.titleId=s));var n=t.excise(e,"cardId");n&&(this.card=APP.patron.cards.find({cardId:n}),this.card||(this.cardId=n));var r=t.excise(e,"websiteId");r&&(this.library=APP.libraries.produce({websiteId:r}),this.library||(this.websiteId=r));var o=i.prototype._deserializeAttributes.call(this,e);if(this.createTime&&this.createTime>14e11){var a=new Date(this.createTime);this.creation={month:""+a.getMonth(),year:""+a.getFullYear()},t.among(this.creation.year,this.collation._.creationYears)||this.collation._.creationYears.push(this.creation.year)}return o},s}),define("app/models/collations/activities",["require","common","./collation","app/models/items/activity"],function(e){var t=e("common"),i=e("./collation"),s=i.new(),n=s.prototype;return n.ITEM_CLASSES={default:e("app/models/items/activity"),info:null,"download-settings":null},n.ITEM_NAME="activity",n.BANK_PREFIX="patron:",n.PATH_FOR_CRITERIA="shelf/timeline",n.$init=function(){this._.creationYears=[],i.prototype.$init.call(this),this._listenForActivities()},n.make=function(e,t){e.createTime>(this.pauseRecordingTime||1/0)&&(e.display="removed");var i=this.ITEM_CLASSES[e.action];if(!i){if("undefined"!=typeof i)return;i=this.ITEM_CLASSES.default}var s=new i;return s.collation=this,s.import(e,t||{source:"internal",integrity:"complete"}),s.title&&s.title.acts.reset(),this.addItem(s)},n.visible=function(){var e=[];return t.each(this.all,function(t){"removed"!=t.display&&e.push(t)}),e},n.pathWithCriteria=function(e){var s=i.prototype.pathWithCriteria.apply(this,arguments);return t.compact([s,this.subPathForCriteria]).join(",")},n.criteria=function(){var e={};this._.creationYears.length>=1&&(e.year=["all"].concat(this._.creationYears.slice(0).sort())),e.act=["all","loans","holds","renewals","returns"];var i=["all"];return t.each(APP.libraries.withCards(),function(e){i.push(e.websiteId)},this),i.length>2&&(e.source=i),e},n.collate=function(e){var i=e.limit||1/0,s={};e.act&&"all"!=e.act&&(s.action={loans:"borrow",holds:"hold",renewals:"renew",returns:["loan-return","loan-expire"],expirations:"loan-expire"}[e.act]),e.source&&"all"!=e.source&&(s["library.websiteId"]=e.source),e.year&&"all"!=e.year&&(s["creation.year"]=""+e.year);var n=this.visible().sort(function(e,t){return t.createTime-e.createTime});return t.isEmpty(s)?n.slice(0,i):this.filter(s,i,n)},n.pauseRecording=function(){this.isRecordingPaused()||(this.pauseRecordingTime=t.epochMilliseconds(),this.save())},n.resumeRecording=function(){this.isRecordingPaused()&&(delete this.pauseRecordingTime,this.save())},n.isRecordingPaused=function(){return"number"==typeof this.pauseRecordingTime},n.wipe=function(){this._removeActivitiesCreatedAfter(0),this._exciseRemovedActivities(),this.save()},n._listenForActivities=function(){APP.events.on("loan:add",this._actionBorrow.bind(this)),APP.events.on("loan:renewed",this._actionRenew.bind(this)),APP.events.on("loan:remove",this._actionReturn.bind(this)),APP.events.on("hold:add",this._actionPlaceHold.bind(this)),APP.events.on("hold:remove",this._actionRemoveHold.bind(this))},n._actionBorrow=function(e){var i=e.m.item,s={action:"borrow",createTime:i.createTime},n=this.find(t.absorb(s,{"title.titleId":i.title.titleId}))||this.make(t.absorb(s,this._possessionData(i)));n&&"borrow"==n.action&&(n.meta={time:i.expireTime-i.createTime}),this.isRecordingPaused()&&n.remove()},n._actionRenew=function(e){var i=e.m.item,s={action:"renew",createTime:i.createTime},n=this.find(t.absorb(s,{"title.titleId":i.title.titleId}))||this.make(t.absorb(s,this._possessionData(i)));n&&"renew"==n.action&&(n.meta={time:i.expireTime-i.createTime})},n._actionReturn=function(e){var i,s=e.m.item,n=t.epochMilliseconds();if(this._patronHasCard(s.card)){var r=new Date(n).toLocaleDateString(),o=new Date(s.expireTime).toLocaleDateString();i=r==o||n+72e5>s.expireTime?{action:"loan-expire",createTime:s.expireTime}:{action:"loan-return",createTime:n};var a=this.find(t.absorb(i,{"title.titleId":s.title.titleId}))||this.make(t.absorb(i,this._possessionData(s)));a&&"loan-return"==a.action&&(a.meta={time:s.expireTime-n})}},n._actionPlaceHold=function(e){var i=e.m.item,s={action:"hold",createTime:i.createTime},n=(this.find(t.absorb(s,{"title.titleId":i.title.titleId})),this.make(t.absorb(s,this._possessionData(i))));this.isRecordingPaused()&&n.remove()},n._actionRemoveHold=function(e){var i,s=e.m.item,n=t.epochMilliseconds();if(this._patronHasCard(s.card)&&!APP.patron.loans.find({"title.titleId":s.title.titleId})&&s.expireTime<n){i={action:"hold-expire",createTime:s.expireTime};var r=this.find(t.absorb(i,{"title.titleId":s.title.titleId}))||this.make(t.absorb(i,this._possessionData(s)));r&&"hold-expire"==r.action&&(r.meta={time:s.expireTime-s.createTime})}},n._patronHasCard=function(e){return!!e&&!!APP.patron.cards.find({cardId:e.cardId})},n._possessionData=function(e){var t={};return e.title&&(t.title=e.title),e.card&&(t.card=e.card,t.library=e.card.library),t},n._saveNow=function(){this.isRecordingPaused()&&this._removeActivitiesCreatedAfter(this.pauseRecordingTime),this._exciseRemovedActivities(),i.prototype._saveNow.call(this)},n._serializeAttributes=function(){var e=i.prototype._serializeAttributes.call(this);return"number"==typeof this.pauseRecordingTime&&(e.pauseRecordingTime=this.pauseRecordingTime),e},n._deserializeAttributes=function(e){i.prototype._deserializeAttributes.call(this,e),"number"==typeof e.pauseRecordingTime&&(this.pauseRecordingTime=e.pauseRecordingTime)},n._attributesToQuery=function(e){var t={action:e.action,createTime:e.createTime};return e.titleId&&(t["title.titleId"]=e.titleId),e.cardId&&(t["card.cardId"]=e.cardId),t},n._isValidItem=function(e){return!(!e||!e.createTime)},n._removeActivitiesCreatedAfter=function(e){t.each(this.all,function(t){t.createTime>=e&&t.remove()})},n._exciseRemovedActivities=function(){var e=[];t.each(this.all,function(t){"removed"==t.display?(t.removedFromCollation=!0,"function"==typeof t.removed&&t.removed(),this._announce("remove",{item:t})):e.push(t)},this),this.all=e},s}),define("app/models/items/pin",["require","common","./item"],function(e){var t=(e("common"),e("./item")),i=t.new(),s=i.prototype;return s._transformAttributes=function(e,t){return this.collation._attributesToQuery(e)},s._serializeAttributes=function(){return{scope:this.scope,category:this.category,value:this.value}},i}),define("app/models/collations/pins",["require","common","./collation","shibui/src/phrasebook","app/models/items/pin"],function(e){var t=e("common"),i=e("./collation"),s=i.new(),n=s.prototype,r=e("shibui/src/phrasebook");return n.ITEM_CLASS=e("app/models/items/pin"),n.BANK_PREFIX="patron:",n.ITEM_NAME="pin",n.PINNABLES={loan:{sort:!0,format:!0},hold:{sort:!0,format:!0},tag:{sort:!0},tagging:{sort:!0,format:!0,availability:!0},activity:{act:!0},title:{sort:["mostpopular","newlyadded","releasedate"],availability:["available"],format:["book","audiobook","magazine"],audience:!0,language:!0,fulfillable:["kindle","epub"]}},n.isPinnable=function(e,i,s){e.scope&&e.category&&(i=e.category,s=e.value,e=e.scope);var n=t.try(this.PINNABLES[e],"["+i+"]");return n===!0||!(!t.isList(n)||!t.among(s,n))},n.produce=function(e){if(this.isPinnable(e))return this.find(e)||this.make(e,{source:"internal",integrity:"complete"})},n.signature=function(e){var i=e||"all";if(this._.signatures=this._.signatures||{},"string"==typeof this._.signatures[i])return this._.signatures[i];var s=e?this.filter({scope:e}):this.all,n=t.select(s,function(e){return[e.scope,e.category,e.value].join("|")});return this._.signatures[i]=n.sort().join(",")},n.addItem=function(e){return delete this._.signatures,i.prototype.addItem.apply(this,arguments)},n.removeItem=function(e){return delete this._.signatures,i.prototype.removeItem.apply(this,arguments)},n.asFacets=function(e){return e=t.absorb(e,{scope:"title"}),t.select(this.filter(e),function(e){var t={category:e.category,value:e.value,pinnable:!0,pinned:!0,applied:!0,totalTitles:1/0};if("language"!=e.category||(t.name=r.text("language.code-"+e.value,{},{okIfMissing:!0}),t.name))return t})},n.pause=function(e,i){if("function"==typeof e){var s,n=function(){return s?s:s=this.pause(!1,i)}.bind(this);return this.pause(!0,i),e(n),n()}this._.signatures={},this._.pausedPins=this._.pausedPins||[];var r;return e?(r=this.filter(i),t.each(r,function(e){t.excise(this.all,e),this._.pausedPins.push(e)},this)):(r=this.filter(i,null,this._.pausedPins),t.each(r,function(e){t.excise(this._.pausedPins,e),this.all.push(e)},this)),this._.pausedPins.length||delete this._.pausedPins,r},n._attributesToQuery=function(e){return{scope:e.scope,category:e.category,value:e.value}},n._isValidItem=function(e){return!!e&&(!!e.scope&&(!!e.category&&(!!e.value&&this.isPinnable(e.scope,e.category,e.value))))},s}),define("app/base/bosses/patron",["require","common","app/base/bosses/sync","app/base/bosses/search-history","app/models/collations/library-cards","app/models/collations/possessions","app/models/collations/magazines","app/models/collations/tags","app/models/collations/activities","app/models/collations/pins"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("app/base/bosses/sync"),r=e("app/base/bosses/search-history"),o=e("app/models/collations/library-cards"),a=e("app/models/collations/possessions"),l=e("app/models/collations/magazines"),c=e("app/models/collations/tags"),h=e("app/models/collations/activities"),u=e("app/models/collations/pins");return s.$init=function(){this.cards=new o,this.loans=new a("loan","incomplete",!0),this.holds=new a("hold","incomplete",!0),this.magazines=new l("magazine","incomplete",!0),this.extras=new a("extra","incomplete",!0),this.tags=new c,this.activities=new h,this.pins=new u,this.searchHistory=new r},s.load=function(){this.cards.load(),this.activities.load(),this.tags.load(),this.loans.load(),this.holds.load(),this.magazines.load(),this.extras.load(),this.pins.load(),this.sync=new n},s.name=function(){return this.choice("patron:name")},s.emailAddress=function(){var e=this.choice("patron:email:address");return"undefined"==typeof e&&(t.each(this.cards.all,function(t){e&&t.library!=APP.library||(e=t.emailAddress||e)}),e&&this.choose("patron:email:address",e)),e},s.timezoneOffset=function(){return 0-60*(new Date).getTimezoneOffset()*1e3},s.choices=function(){return this._.choices=this._.choices||APP.bank.get("patron:choices")||{}},s.choice=function(e){return this.choices()[e]},s.choose=function(e,t){var i=this.choices();"undefined"!=typeof t?i[e]=t:delete i[e],APP.bank.set("patron:choices",i),APP.events.dispatch("patron:choice",{key:e,value:t})},s.isDismissed=function(e){return!!this.dismissedAt(e)},s.dismissedAt=function(e){return this._loadDismissals(),1e3*(this._.dismissals[e]||0)},s.dismiss=function(e,i){this._loadDismissals(),this.isDismissed(e)&&!t.try(i,"overwrite")||(this._.dismissals[e]=t.epochSeconds(),APP.events.dispatch("patron:dismiss",{key:e}),APP.bank.set("patron:dismissals",this._.dismissals))},s.undismiss=function(e){var i;if("undefined"==typeof e)i=t.select(this._.dismissals,function(e,t){return e}),this._.dismissals={};else{if(!this.isDismissed(e))return;i=[e],delete this._.dismissals[e]}APP.events.dispatch("patron:undismiss",{keys:i}),APP.bank.set("patron:dismissals",this._.dismissals)},s._loadDismissals=function(){return this._.dismissals=this._.dismissals||APP.bank.get("patron:dismissals")||{}},i}),define("app/base/bosses/shelf-analyst",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.$init=function(){this.patron=APP.patron,this._.diagnoses={loans:{},holds:{}},APP.events.on("loan:update:all",this._deferUpdateDiagnoses.bind(this,"loans")),APP.events.on("hold:update:all",this._deferUpdateDiagnoses.bind(this,"holds")),this.refresh()},s.diagnose=function(e){var t=e.psnKey;return this._.diagnoses.holds[t]||this._.diagnoses.loans[t]},s.cases=function(e){e=t.flatten([e]);var i=[];return t.each(e,function(e){var s,n,r=[];e.match(/^loan/)?(s=this._.diagnoses.loans,n=this.patron.loans.all):e.match(/^hold/)&&(s=this._.diagnoses.holds,n=this.patron.holds.all),t.each(s,function(t,i){i&&0==i.indexOf(e)&&r.push(t)}),r.length&&t.each(n,function(e){r.indexOf(e.psnKey)>=0&&i.push(e)})},this),i},s.refresh=function(){this._updateDiagnoses("loans"),this._updateDiagnoses("holds")},s._deferUpdateDiagnoses=function(e){var i="update-diagnoses-"+e;t.defer(this,i,this._updateDiagnoses.bind(this,e),100)},s._updateDiagnoses=function(e){if(this.patron[e]){var i={};t.each(this.patron[e].all,function(t){i[t.psnKey]=this._.diagnoses[e][t.psnKey],t.holding().use(function(s,n){s.isIdeal||s.isBroken||n.reuse(this._deferUpdateDiagnoses.bind(this,e)),"loans"==e?i[t.psnKey]=this._analyzeLoan(t,n):"holds"==e&&(i[t.psnKey]=this._analyzeHold(t,n))},this)},this),this._.diagnoses[e]=i}},s._analyzeLoan=function(e,i){var s=e.isWithinRenewalWindow(),n=(this.patron.loans.filter({"title.titleId":e.title.titleId}),this.patron.holds.filter({"title.titleId":e.title.titleId})),r=t.try(i,"numberOfHoldsByOthers()"),o=t.epochMilliseconds()-e.createTime;if(e.journey.progress>=.95)return"loan-finished";if(s&&!n.length){var a=r||e.isLuckyDayLoan?"hold":"renew";return"loan-extend,"+a}if(e.isLuckyDayLoan)return"loan-lucky-day";if(o<144e5)return"loan-recent";if(i.hasPeopleWaiting()&&r&&!e.isOpenedRecently()){if(i.luckyDayCopiesAvailable>0)return;return"loan-waitlist,"+r+","+(i.copiesOwned||1)}},s._analyzeHold=function(e,t){return e.isAvailable?"hold-borrow":t&&t.isOnlyAvailableAsLuckyDayLoan()&&!e.isSuspended()&&!this.patron.loans.find({"title.titleId":e.title.titleId})?"hold-lucky-day":void 0},i}),define("text!res/data/notifications.json",[],function(){return'[\n  {\n    "category": "notifier-repair",\n    "groupId": "settings",\n    "level": "SYSTEM",\n    "priority": 100,\n    "dismissable": false,\n    "pushable": false\n  },\n  {\n    "category": "card-expired",\n    "groupId": "settings",\n    "level": "SYSTEM",\n    "priority": 90,\n    "dismissable": true,\n    "pushable": false\n  },\n  {\n    "category": "cards-expired",\n    "groupId": "settings",\n    "level": "SYSTEM",\n    "priority": 90,\n    "dismissable": true,\n    "pushable": false\n  },\n\n  {\n    "category": "loan-expiring",\n    "groupId": "circulation",\n    "level": "REMOTE",\n    "priority": 35,\n    "dismissable": true,\n    "pushable": true,\n    "actions": [{\n      "id": "renew-loan"\n    }, {\n      "id": "return-loan"\n    }, {\n      "id": "title-details"\n    }]\n  },\n  {\n    "category": "loan-expired",\n    "groupId": "circulation",\n    "level": "REMOTE",\n    "priority": 30,\n    "dismissable": true,\n    "pushable": true,\n    "actions": [{\n      "id": "view-journey"\n    }, {\n      "id": "borrow-title"\n    }, {\n      "id": "title-details"\n    }]\n  },\n  {\n    "category": "hold-ready",\n    "groupId": "circulation",\n    "level": "REMOTE",\n    "priority": 45,\n    "dismissable": true,\n    "pushable": true,\n    "actions": [{\n      "id": "borrow-hold"\n    }, {\n      "id": "redeliver-hold"\n    }, {\n      "id": "cancel-hold"\n    }, {\n      "id": "title-details"\n    }]\n  },\n  {\n    "category": "hold-lapsing",\n    "groupId": "circulation",\n    "level": "REMOTE",\n    "priority": 40,\n    "dismissable": true,\n    "pushable": true,\n    "actions": [{\n      "id": "borrow-hold"\n    }, {\n      "id": "redeliver-hold"\n    }, {\n      "id": "cancel-hold"\n    }, {\n      "id": "title-details"\n    }]\n  },\n  {\n    "category": "hold-lapsed",\n    "groupId": "circulation",\n    "level": "REMOTE",\n    "priority": 40,\n    "dismissable": true,\n    "pushable": true,\n    "actions": [{\n      "id": "hold-title"\n    }, {\n      "id": "view-journey"\n    }, {\n      "id": "title-details"\n    }]\n  },\n  {\n    "category": "hold-borrowed",\n    "groupId": "circulation",\n    "level": "REMOTE",\n    "priority": 40,\n    "dismissable": true,\n    "pushable": true,\n    "delegate": "hold-ready",\n    "actions": [{\n      "id": "open-loan"\n    }, {\n      "id": "return-loan"\n    }, {\n      "id": "title-details"\n    }]\n  },\n  {\n    "category": "hold-rescheduled",\n    "groupId": "circulation",\n    "level": "REMOTE",\n    "priority": 40,\n    "dismissable": true,\n    "pushable": true,\n    "delegate": "hold-lapsed",\n    "actions": [{\n      "id": "redeliver-hold"\n    }, {\n      "id": "cancel-hold"\n    }, {\n      "id": "title-details"\n    }]\n  },\n\n  {\n    "category": "notify-me-title",\n    "groupId": "tags",\n    "level": "REMOTE",\n    "priority": 40,\n    "dismissable": true,\n    "pushable": true,\n    "actions": [{\n      "id": "title-details"\n    }, {\n      "id": "borrow-title"\n    }]\n  },\n  {\n    "category": "notify-me-author",\n    "groupId": "tags",\n    "level": "REMOTE",\n    "priority": 40,\n    "dismissable": true,\n    "pushable": true,\n    "actions": [{\n      "id": "title-details"\n    }, {\n      "id": "borrow-title"\n    }]\n  },\n  {\n    "category": "notify-me-series",\n    "groupId": "tags",\n    "level": "REMOTE",\n    "priority": 40,\n    "dismissable": true,\n    "pushable": true,\n    "actions": [{\n      "id": "title-details"\n    }]\n  }\n]\n'}),define("app/models/items/notification",["require","common","app/models/items/item"],function(e){var t=e("common"),i=e("app/models/items/item"),s=i.new(),n=s.prototype;return n.VANISH_DELAY_MS=2592e5,n.isDismissable=function(){return this.dismissable},n.dismiss=function(){this.isDismissable()&&!this.dismissedAt&&(delete this.vanishAt,this.dismissedAt=t.epochMilliseconds(),this.dismissCorrespondingShellNotification(),this.collation.save(),APP.events.dispatch("notification:dismiss",{notification:this}))},n.undismiss=function(){this.dismissedAt&&(delete this.dismissedAt,this.collation.save())},n.dismissCorrespondingShellNotification=function(){t.try(this.details,"shellId")&&(APP.shell.transmit({name:"notifier:dismiss",dest:"shell",id:""+this.details.shellId}),delete this.details.shellId)},n.toggleVanishing=function(){return!this.isDismissable()||this.dismissedAt?void delete this.vanishAt:("string"==typeof this.vanishAt?this.vanishAt=t.epochMilliseconds()+this.VANISH_DELAY_MS:this.vanishAt="pin",this.collation.save(),this.vanishAt)},n.title=function(){if(t.try(this,"details.titleId"))return APP.titles.produce({titleId:this.details.titleId})},n.card=function(){var e;t.try(this,"details.websiteId")&&(e=APP.libraries.produce({websiteId:this.details.websiteId}));var i,s=t.try(this.details,"cardId")||this.id;if(s&&(i=APP.patron.cards.find({cardId:s})),e&&t.try(i,"library")!=e){i=e.card();var n=t.try(this,"details.accountId");n&&!t.among(n,t.try(i,"accounts"))&&t.each(e.cards(),function(e){t.among(n,e.accounts)&&(i=e,t.breakIteration())})}return i},n.library=function(){var e;return t.try(this,"details.websiteId")&&(e=APP.libraries.produce({websiteId:this.details.websiteId})),e||(e=t.try(this.card(),"library")),e},n.loan=function(){if(t.try(this,"details.psnKey"))return APP.patron.loans.find({psnKey:this.details.psnKey})},n.hold=function(){if(t.try(this,"details.psnKey"))return APP.patron.holds.find({psnKey:this.details.psnKey
})},n.color=function(){return this.priority>=50?"orange":this.priority>=40?"plum":this.priority>=30?"wine":this.priority>=20?"turquoise":"none"},n.labelNotice=function(){var e;e=APP.arena._phrase({label:"notification."+this.id+".notice",okIfMissing:!0})?"notification."+this.id+".notice":"notification."+this.category+".notice";var i={};return i.LIBRARY_NAME=t.try(this.library(),"safeName()"),{label:e,substitutions:i}},n.labelAction=function(e){var t="notification."+this.category+".action";return APP.arena._phrase({label:"notification."+this.id+".action",okIfMissing:!0})&&(t="notification."+this.id+".action"),"string"==typeof e&&(t+="."+e),{label:t}},n.instructionsForAction=function(e){e||(e=t.try(this.actions,"[0].id")||{circulation:"view-journey",tags:"view-journey"}[this.groupId]);var i=this.title(),s=this.loan(),n=this.hold(),r=this.library();return"view-journey"==e?i?i.journey().path():this._actionImpossible(e):"title-details"==e?i&&r?i.path(r):this._actionImpossible(e):"borrow-title"==e?!s&&i&&r?i.path(APP.library||r,"request?key="+r.key()):this._actionImpossible(e):"hold-title"==e?!n&&i&&r?i.path(APP.library||r,"request?key="+r.key()):this._actionImpossible(e):"return-loan"==e?s?s.pathToShelfAction("return"):this._actionImpossible(e):"renew-loan"==e?s?s.pathToShelfAction("renew"):this._actionImpossible(e):"borrow-hold"==e?n?n.pathToShelfAction("borrow"):this._actionImpossible(e):"redeliver-hold"==e?n?n.pathToShelfAction("redeliver"):this._actionImpossible(e):"cancel-hold"==e?n?n.pathToShelfAction("cancel"):this._actionImpossible(e):"open-loan"==e&&s?function(){s.fulfiller.open()}:this._actionImpossible(e)},n._serializeAttributes=function(){return{category:this.category,id:this.id,details:this.details,dismissable:this.dismissable,createdAt:this.createdAt,vanishAt:this.vanishAt,dismissedAt:this.dismissedAt,provisional:this.provisional}},n._deserializeAttributes=function(e){var s={};return e.category&&t.each(this.collation.ARCHETYPES,function(i){i.category==e.category&&(s=i,e=t.absorb(e,t.absorb(s,{})),t.breakIteration())}),e.createdAt||(e.createdAt=t.epochMilliseconds()),s.dismissable&&!e.dismissable&&(e.vanishAt="pin",e.dismissable=!0),i.prototype._deserializeAttributes.call(this,e)},n._actionImpossible=function(e){throw"notification:action:impossible:"+e},s}),define("app/models/collations/notifications",["require","common","app/models/collations/collation","text!res/data/notifications.json","app/models/items/notification"],function(e){var t=e("common"),i=e("app/models/collations/collation"),s=i.new(),n=s.prototype;return n.ARCHETYPES=JSON.parse(e("text!res/data/notifications.json")),n.ITEM_CLASS=e("app/models/items/notification"),n.ITEM_NAME="notification",n.BANK_PREFIX="notifier:",n.loaded=function(){APP.events.on("patron:dismiss",this._onPatronDismiss.bind(this)),this._scheduleVanishings()},n.criteria=function(){return{group:["all","loans","holds","notify-me","other"]}},n.collate=function(e){e=t.absorb(e,{dismissedAt:null});var i=t.excise(e,"group")||"all",s=t.excise(e,"titles"),n=t.excise(e,"sort")||"createdAt",r=this.filter(e);return"undefined"!=typeof s&&(r=t.select(r,function(e){var i=t.try(e,"details.titleId");if(s?i:!i)return e})),"all"!=i&&(r=t.select(r,function(e){return"loans"==i?e.category.match(/^loan-/)?e:void 0:"holds"==i?e.category.match(/^hold-/)?e:void 0:"notify-me"==i?e.category.match(/^notify-me-/)?e:void 0:"other"==i?e.category.match(/^(loan-|hold-|notify-me)/)?void 0:e:void 0})),"createdAt"==n?r.sort(function(e,t){return t.createdAt-e.createdAt}):"priority"==n&&r.sort(function(e,t){return t.priority-e.priority}),r},n.totalCount=function(){return this.filter({dismissedAt:null}).length},n.dismissAll=function(){t.each(this.all,function(e){e.dismiss()})},n.undismissAll=function(){t.each(this.all,function(e){e.undismiss()})},n.removeAll=function(e){var i=this.filter(e);return t.each(i,this.removeItem.bind(this)),i},n._onPatronDismiss=function(e){if("notifications:seen"==t.try(e,"m.key"))return this._onNotificationsSeen()},n._onNotificationsSeen=function(){var e=!!t.select(this.all,function(e){if(!e.vanishAt&&"SYSTEM"!=e.level)return e.toggleVanishing(e.vanishAt="seen")},this).length;e&&this.save()},n._saveNow=function(){return this._scheduleVanishings(),i.prototype._saveNow.apply(this,arguments)},n._scheduleVanishings=function(){t.defer(this,"vanishings");var e=t.epochMilliseconds(),i=1/0;if(t.each(this.all,function(t){t.isDismissable()&&!t.dismissedAt&&"number"==typeof t.vanishAt&&(i=Math.max(e,Math.min(i,t.vanishAt)))},this),isFinite(i)){var s=i-e;t.defer(this,"vanishings",this._performVanishings.bind(this),s)}},n._performVanishings=function(){t.defer(this,"vanishings");var e=t.epochMilliseconds()+1e3;t.each(this.all,function(t){t.isDismissable()&&!t.dismissedAt&&"number"==typeof t.vanishAt&&t.vanishAt<e&&t.dismiss()},this)},n._attributesToQuery=function(e){var t={id:e.id};return e.category&&(t.category=e.category),t},n._isValidItem=function(e){var i=t.try(e,"category");if(!i)return!1;for(var s=0,n=this.ARCHETYPES.length;s<n;++s)if(this.ARCHETYPES[s].category==i)return!0;return!1},s}),define("app/base/bosses/notifier",["require","common","app/models/collations/notifications"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("app/models/collations/notifications");return s.SUBSCRIBE_DELAY_MS=5e3,s.BANK_KEY_SERVICE="notifier:service",s.BANK_KEY_SUBSCRIPTIONS="notifier:subscriptions",s.BANK_KEY_SENTRY="notifier:sentry",s.LEVEL={IGNORE:0,MENU:1,REMOTE:2,SYSTEM:3},s.$init=function(){this.notifications=new n,this.notifications.load(),this._listen(),this._.permissionCallbacks=[],this._.service=APP.bank.get(this.BANK_KEY_SERVICE),this._.service||this._assignDefaultService(),this._.subscriptionLevels=APP.bank.get(this.BANK_KEY_SUBSCRIPTIONS),this._.subscriptionLevels||this._assignDefaultSubscriptionLevels(),this._assignAnyNewSubscriptionLevels(),this._requestCurrentShellNotifications(),this._.service.provider&&APP.events.once("environment:ready",function(){var e=this._.service;e&&e.provider&&this.setServiceProvider(e.provider,e.credentials)}.bind(this))},s.isPostable=function(e){var t=this._.subscriptionLevels[this.LEVEL.IGNORE];if(t.indexOf(e)>=0)return!1;for(var i=0,s=this.notifications.ARCHETYPES.length;i<s;++i)if(this.notifications.ARCHETYPES[i].category==e)return!0;return!1},s.post=function(e,i,s){s=t.absorb(s,{flush:{}});var n=[],r=this.isPostable(e),o=[];if(t.each(i,function(i){if(i.category=e,o.push(i),s.avoidOverwrites){var r=this.notifications.find({id:i.id,category:i.category});r&&(n.push(r),t.excise(o,i))}},this),o.length){var a=this.notifications.importAll(o,{source:"internal",integrity:"complete"});n=n.concat(a)}var l=this.notifications.filter({category:e});return t.each(l,function(e){s.flush.dismissed&&e.dismissedAt?e.remove():n.indexOf(e)<0&&("obsolete"==s.flush.omitted||s.flush.omitted&&e.isDismissable())?(e.dismiss(),e.remove()):r||e.dismiss()},this),n},s.subscribe=function(e,i){if(t.each(this._.subscriptionLevels,function(s,n){t.excise(s,e),i===n&&s.push(e)}),APP.bank.set(this.BANK_KEY_SUBSCRIPTIONS,this._.subscriptionLevels),i<this.LEVEL.MENU){var s=this.notifications.filter({category:e});t.each(s,function(e){e.dismissable=!0,e.dismiss()})}APP.events.dispatch("notifier:subscribe:"+e,{level:i}),clearTimeout(this._.subscribeTimer),this._.subscribeTimer=setTimeout(function(){this._postSubscriptionLevelsToSentry(!0);var e=t.clone(this._.subscriptionLevels);this._.state=t.absorb({subscriptions:e},this._.state||{}),APP.events.dispatch("notifier:subscriptions",this._.state)}.bind(this),this.SUBSCRIBE_DELAY_MS)},s.subscriptions=function(e){this._.permissionCallbacks.push(e),this._transmitPermission("check")},s.requestPermission=function(e){this._.permissionCallbacks.push(e),this._transmitPermission("request")},s.markAsConfigured=function(){this._.service.unconfigured&&(delete this._.service.unconfigured,APP.bank.set(this.BANK_KEY_SERVICE,this._.service),APP.events.dispatch("notifier:service",this._.service))},s.setServiceProvider=function(e,i){if("email"!=e||t.try(i,"emailAddress")||(e=null,i=null),!e){this._regradeEntireSubscriptionLevel(this.LEVEL.REMOTE,this.LEVEL.MENU);var s=APP.patron.emailAddress();s&&!i&&(e="email",i={emailAddress:s})}"email"==e&&(i.timezoneOffsetMS=APP.patron.timezoneOffset(),"undefined"==typeof i.name&&(i.name=APP.patron.name())),i&&(i.language=SPARK.locale.acceptTags.join(","));var n={provider:e,credentials:i};this._.service.unconfigured&&(n.unconfigured=!0);var r=this._hasServiceChanged(n);r&&(this._.service.invalidity&&(n.invalidity=!1),this._.service=n,APP.bank.set(this.BANK_KEY_SERVICE,this._.service),APP.events.dispatch("notifier:service",this._.service)),this._postServiceToSentry(r),this._postSubscriptionLevelsToSentry(r),this._transmitCategories()},s.performNotificationAction=function(e,i,s){s=t.absorb(s,{});try{if(!e)throw"notification:missing";var n=e.instructionsForAction(i);if("function"==typeof n)n();else{if("string"!=typeof n)throw"notification:action:unrecognized:"+i;t.isEmpty(s)?APP.nav.go(n):this._jumpToPath(n)}}catch(n){if(e&&!s.actionAttempts&&this._.syncing)s.actionAttempts=1,APP.arena.splash(!0),this._.syncCallback=function(){APP.arena.splash(!1),this.performNotificationAction(e,i,s)}.bind(this);else if(APP.investigator.isChipMissingFromBank())APP.events.dispatch("investigate:record",{what:"chip missing from bank when handling notification action",where:"Notifier#_onHandleShellNotification",actionId:s.actionId||i,shellData:s});else{s.actionId=s.actionId||i;var r=APP.err("missing-notification-action",t.absorb(s,{errorSource:"Notifier#_onHandleShellNotification",errorObject:n})).sendToSage(),o=t.try(s,"supplement.titleId");if(o){var a=APP.journeys.produce({titleId:o});APP.nav.go(a.path())}else r.present()}}},s.syncNotificationService=function(e){t.try(e,"service.invalidity")?(APP.journal.warn("[NOTIFIER] notification service invalidity",e.service),this._.service=t.absorb({invalidity:e.service.invalidity},this._.service||e.service),APP.bank.set(this.BANK_KEY_SERVICE,this._.service),APP.events.dispatch("notifier:service:invalid",this._.service)):t.try(this,"_.service.invalidity")&&(delete this._.service.invalidity,APP.bank.set(this.BANK_KEY_SERVICE,this._.service),APP.events.dispatch("notifier:service",this._.service))},s._listen=function(){APP.events.on("msg:notifier:permission",this._onShellNotificationPermission.bind(this)),APP.events.on("msg:notifier:receive",this._onReceiveShellNotification.bind(this)),APP.events.on("msg:notifier:handle",this._onHandleShellNotification.bind(this)),APP.events.on("msg:notifier:schedule:failure",this._onScheduleShellNotificationFailure.bind(this)),APP.events.on("msg:client:view:foreground",this._requestCurrentShellNotifications.bind(this)),APP.events.on("msg:notifier:list",this._onCurrentShellNotifications.bind(this))},s._assignDefaultService=function(){return this._.service={unconfigured:!0}},s._assignDefaultSubscriptionLevels=function(){var e=this._.subscriptionLevels=[[],[],[],[]];return t.each(this.notifications.ARCHETYPES,function(t){e[this.LEVEL[t.level]].push(t.category)},this),this.subscriptions(function(t){if(!APP.shell.info.platform){var i=e[this.LEVEL.REMOTE].splice(0);e[this.LEVEL.MENU]=e[this.LEVEL.MENU].concat(i)}APP.bank.set(this.BANK_KEY_SUBSCRIPTIONS,e)}.bind(this)),e},s._assignAnyNewSubscriptionLevels=function(){var e=this._.subscriptionLevels,i=t.flatten(e),s=!1;t.each(this.notifications.ARCHETYPES,function(n){if(!t.among(n.category,i)){var r=!APP.shell.info.platform,o=r&&"REMOTE"==n.level?"MENU":n.level;e[this.LEVEL[o]]&&(e[this.LEVEL[o]].push(n.category),s=!0)}},this),s&&(APP.bank.set(this.BANK_KEY_SUBSCRIPTIONS,e),this._postSubscriptionLevelsToSentry(!0))},s._hasServiceChanged=function(e){if(!this._.service)return!0;if(e.invalidity!==this._.service.invalidity)return!0;if(e.unconfigured!==this._.service.unconfigured)return!0;if(e.provider!==this._.service.provider)return!0;var i=!1;return t.each(e.credentials,function(e,s){t.try(this._.service,"credentials["+e+"]")!==s&&(i=!0,t.breakIteration())},this),!!i||(t.each(this._.service.credentials,function(s,n){e.credentials[s]!==n&&(i=!0,t.breakIteration())},this),i)},s._postServiceToSentry=function(e){var i=this.BANK_KEY_SENTRY+":service",s=APP.bank.get(i);if(e)APP.bank.set(i,0);else if(s)return;APP.sentry.notifyingService(this._.service.provider,this._.service.credentials,this._.service.invalidity,function(){APP.bank.set(i,t.epochMilliseconds())}.bind(this))},s._postSubscriptionLevelsToSentry=function(e){var i=this.BANK_KEY_SENTRY+":subscriptions",s=APP.bank.get(i);if(e)APP.bank.set(i,0);else if(s)return;var n={};if(this._.service.provider){var r="email"==this._.service.provider?"email":"push",o=this._.subscriptionLevels[this.LEVEL.REMOTE];t.each(o,function(e){n[e]=r})}APP.sentry.notifyingSubscriptions(n,function(){APP.bank.set(i,t.epochMilliseconds())}.bind(this))},s._regradeEntireSubscriptionLevel=function(e,i){var s=this._.subscriptionLevels[e].slice(0);t.each(s,function(e){this.subscribe(e,i)},this)},s._transmitCategories=function(){if(!this._.hasTransmittedCategories&&this._isPushPossible()){var e=[];t.each(this.notifications.ARCHETYPES,function(i){if(i.pushable){var s="notification."+i.category,n={};n.category=i.category,n.name=APP.arena._phrase(s),n.description=t.safe(APP.arena._phrase(s+".description")),n.group=APP.arena._phrase("notifications.group."+i.groupId),n.importance=i.importance||2,n.confidentiality=i.confidentiality||"private",n.actions=[],t.each(i.actions,function(e){n.actions.push({action:e.id,title:APP.arena._phrase(s+".action."+e.id)})}),e.push(n)}}),APP.shell.transmit({name:"notifier:categories",definitions:e}),this._.hasTransmittedCategories=!0}},s._isPushPossible=function(){return APP.shell.has("notifier:receive")||APP.shell.has("notifier:schedule")},s._transmitPermission=function(e){if(this._isPushPossible()){var t={name:"notifier:permission",dest:"shell",source:"client"};"string"==typeof e&&(t.name+=":"+e),APP.shell.transmit(t)}else this._invokePermissionCallbacks({pushability:{possible:!1}})},s._invokePermissionCallbacks=function(e){this._.permissionCallbacks.length&&(this._.state=t.absorb({service:this._.service,subscriptions:this._.subscriptionLevels},e||{}),t.each(this._.permissionCallbacks.splice(0),function(e){"function"==typeof e&&e(this._.state)},this))},s._onShellNotificationPermission=function(e){var t={pushability:{possible:!0,permit:e.m.permit}};"granted"==t.pushability.permit&&this.setServiceProvider(e.m.provider,e.m.credentials),this._invokePermissionCallbacks(t)},s._onScheduleShellNotificationFailure=function(e){APP.journal.warn("[NOTIFIER] schedule shell notification failure",e.m)},s._requestCurrentShellNotifications=function(){APP.shell.transmit("notifier:list")},s._onCurrentShellNotifications=function(e){t.try(e,"m.notifications.length")&&t.each(e.m.notifications,function(e){var t=this._processShellNotification(e);t&&t.dismissedAt&&t.dismissCorrespondingShellNotification()},this)},s._onReceiveShellNotification=function(e){var i=t.absorb(e.m,{});if(i.notification){var s=this._processShellNotification(i);if(!s||!s.dismissedAt){var n=t.clone(i);delete n.notification.ms,n.name="notifier:schedule",n.dest="shell",n.source="client",APP.shell.transmit(n)}}},s._onHandleShellNotification=function(e){var i=e.m,s=this._processShellNotification(i),n=t.try(i,"notification.action");this.performNotificationAction(s,n,i)},s._processShellNotification=function(e){APP.journal.info("[NOTIFIER] shell notification",e);var i=t.try(e,"notification"),s=t.try(e,"supplement");if(!i||!s)return APP.journal.warn("[NOTIFIER] unrecognized shell notification",e);s.supplement&&(s=s.supplement);var n,r=i.category;if(s.cardId&&(n=APP.patron.cards.find({cardId:s.cardId})),!n&&s.puid&&(n=APP.patron.cards.find({puid:s.puid})),!n&&(s.puid||s.cardId))return APP.journal.warn("[NOTIFIER] card not found:",e);var o=s.titleId,a=s.websiteId||t.try(n,"library.websiteId"),l=(n?n.cardId+"-"+o:o)||"null-notif-id";0==r.indexOf("notify-me")&&(l=o);var c=this.notifications.find({category:r,id:l});if(c)c.details=c.details||{},c.details.shellId!=i.id&&(c.details.shellId=i.id,this.notifications.save()),c.dismissedAt&&c.dismissCorrespondingShellNotification();else{var h={titleId:o,shellId:i.id};"null-notif-id"!=l&&(h.psnKey=l),a&&(h.websiteId=a),t.try(n,"cardId")&&(h.cardId=n.cardId),c=this.post(r,[{id:l,details:h,provisional:!0,dismissedAt:null}],{avoidOverwrites:!0})[0],c&&this._commenceVerifyingSync()}return c},s._commenceVerifyingSync=function(){this._.syncing=!0,this._.syncTimer=setTimeout(this._concludeVerifyingSync.bind(this),5e3),APP.patron.sync.commence({freshness:1e3,syncJourneys:!1,syncTags:!1,onSuccess:this._concludeVerifyingSync.bind(this),onFailure:this._concludeVerifyingSync.bind(this)})},s._concludeVerifyingSync=function(){this._.syncing=!1;var e=this._.syncCallback;delete this._.syncCallback,"function"==typeof e&&e()},s._jumpToPath=function(e){var i,s=e.match(/^(library|shelf)\//);return s&&(i=t.try(APP.arena.surfaces[s[1]],"dom.main")),i?i.skippingAnimations(APP.nav.go.bind(APP.nav,e)):APP.nav.go(e),e},i}),define("app/base/bosses/image-director",["require","common","shibui/src/illustrator"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("shibui/src/illustrator");return s.TASK_INTERVAL_MS=100,s.LIMIT_TO_SCROLL_REGION=!1,s.$init=function(){APP.events.on("router:navigate",this._onRouterNavigate.bind(this)),this.LIMIT_TO_SCROLL_REGION&&(APP.events.on("arena:scroll",this._onScrollArena.bind(this)),APP.events.on(window,"resize",this.recalculate.bind(this))),this._.thresholds={t:0,b:window.innerHeight},this._.murals={},this._.queue=[]},s.enqueue=function(e,t){if(!t)return void APP.journal.warn("[IMAGE-QUEUE] failed, bad url",t);e.classList.add("directed-image"),e.setAttribute("draggable",!1);var i={img:e,url:t,realm:APP.router.realm,path:APP.router.route?APP.router.route.path:null};this.LIMIT_TO_SCROLL_REGION?(this._.queue.push(i),this._scheduleProcessingOfQueue()):setTimeout(this._processTask.bind(this,i),0)},s.recalculate=function(){t.each(this._.queue,function(e){e.thresholds&&(e.thresholds=this._calculateThresholds(e.img))},this),this._.lastScroll&&this._updateToScrollPosition(this._.lastScroll)},s.expedite=function(e){if(this.LIMIT_TO_SCROLL_REGION){var i=[];t.each(this._.queue,function(t){e.contains(t.img)?this._processTask(t):i.push(t)},this),this._.queue=i}},s.mural=function(e,i,s){if(!t.try(e,"tagName"))return APP.journal.warn("[IMAGE] invalid mural element",e);var n=this._.murals[i];if(n)return this._injectSVG(e,n,s);var r='<svg xmlns="http://www.w3.org/2000/svg"></svg>',o=this._injectSVG(e,r,{classes:t.try(s,"classes")}),a=APP.constants.filePath("images/murals/"+i+".svg");APP.server.fetch(a,function(e){this._.murals[i]=e.responseText,this._injectSVG(o,e.responseText,s)}.bind(this))},s._scheduleProcessingOfQueue=function(){!this._.task&&this._.queue.length&&(clearTimeout(this._.timer),this._.timer=setTimeout(this._processQueue.bind(this),0))},s._processQueue=function(){if(this._.queue.length&&!this._.task){for(var e=0,t=this._.queue.length;e<t;++e){var i=this._.queue[e];if(!i.path||i.path==APP.router.route.path){if(i.thresholds||(i.thresholds=this._calculateThresholds(i.img),i.visible=this._calculateVisibility(i.thresholds)),!i.visible)continue;if(!document.body.contains(i.img))continue;this._.queue.splice(e,1),this._.task=i;break}}this._.task&&this._processTask(this._.task)}},s._processTask=function(e){try{"IMG"==e.img.nodeName?e.img.setAttribute("src",e.url):"OBJECT"==e.img.nodeName?e.img.setAttribute("data",e.url):e.img.style.backgroundImage="url("+e.url+")"}catch(t){"function"==e.img.onerror&&e.img.onerror(t)}clearTimeout(this._.timer),this._.timer=setTimeout(function(){this._.task=null,this._processQueue()}.bind(this),this.TASK_INTERVAL_MS)},s._winnowQueue=function(e){if(APP.router.route){var i=[APP.router.route.path];t.each(e.m.realm,function(e){i.push(e.path)});var s=[];t.each(this._.queue,function(e){(!e.path||e.realm!=APP.router.realm||i.indexOf(e.path)>=0)&&s.push(e)}),this._.queue=s}},s._onRouterNavigate=function(e){this._winnowQueue(e),this._processQueue()},s._injectSVG=function(e,i,s){if(!t.try(e,"tagName"))return APP.journal.warn("[IMAGE] invalid SVG injection",e);i=n.substituteUniqueIds(i);var r;if(e.parentNode&&"SVG"==e.tagName.toUpperCase()?(e.insertAdjacentHTML("beforebegin",i),r=e.previousElementSibling,e.parentNode.removeChild(e)):(e.insertAdjacentHTML("beforeend",i),r=e.lastElementChild),APP.arena._classify(r,"shibui-graphic"),s&&(s=t.absorb(s,{}),s.onLoad&&t.excise(s,"onLoad()",r),!t.isEmpty(s))){var o=APP.arena._normalizeElementOptions(s);APP.arena._applyNormalizedElementOptions(r,o)}return r},s._calculateThresholds=function(e){var t=e.getBoundingClientRect(),i={};return i.t=this._.thresholds.t+t.top,i.b=i.t+t.height,i},s._onScrollArena=function(e){!this._.task&&this._.queue.length&&this._updateToScrollPosition(e.m)},s._updateToScrollPosition=function(e){this._.lastScroll=e,this._.thresholds={t:e.y,b:e.y+2*e.h},t.each(this._.queue,function(e){e.thresholds&&(e.visible=this._calculateVisibility(e.thresholds))},this),this._scheduleProcessingOfQueue()},s._calculateVisibility=function(e){return!e.t&&!e.b||!(this._.thresholds.b<e.t)&&!(this._.thresholds.t>e.b)},i}),define("app/base/bosses/cover-proxy",["require","common","app/base/rosters/roster"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("app/base/rosters/roster");return s.OPTIMAL_IMG_WIDTH=536,s.OPTIMAL_IMG_QUALITY=80,s.BANK_KEY_CACHE_MAP="cover-proxy:cache-map",s.BANK_KEY_ROSTER="roster:shelf-covers",s.ROSTER_INIT_DELAY_MS=5e3,s.ROSTER_ENTRY_BYTES=5e4,s.ROSTER_DEFAULTS={role:"system",group:"covers",id:"shelf-covers",version:"4.0.0"},s.$init=function(){if(this.cacheMap=APP.bank.get(this.BANK_KEY_CACHE_MAP),this._.blurRadiusOverride=parseFloat(APP.flags.property("cover-blur"))||0,APP.shell.has("rosters")){var e=APP.bank.get(this.BANK_KEY_ROSTER),i=t.absorb(this.ROSTER_DEFAULTS,{});this.roster=new n(t.absorb(e,i)),APP.events.on("title:save:eligible",this._onSaveTitles.bind(this)),APP.events.on("roster:audit",this._onRosterAudit.bind(this))}},s.coverURLForTitle=function(e,i){return t.try(i,"force")?this._proxiedURLForTitle(e,i.params):this.cacheMap?this.cacheMap[t.try(e,"titleId")]:void 0},s.optimizationParameters=function(e,i){var s={type:"auto",width:this.OPTIMAL_IMG_WIDTH,quality:this.OPTIMAL_IMG_QUALITY,force:!0};return this._.blurRadiusOverride&&(s.width=200,s.quality=60,s.sigma=this._.blurRadiusOverride),t.each(e,function(e,t){"undefined"!=typeof t&&(s[e]=t)}),"audiobook"==i||"video"==i?s.height=s.width:i&&(s.height=Math.round(4*s.width/3)),s},s._proxiedURLForTitle=function(e,i){var s=t.try(e,"cover.url");if(s){var n=this.optimizationParameters(i,e.format);return n.url=t.relativeURL(encodeURI(decodeURI(s))),t.parameterizeURL("/covers/resize",n)}},s._onSaveTitles=function(e){t.defer(this,"compile-roster",this._compileRosteredCovers.bind(this,e.m.titles.all),this.ROSTER_INIT_DELAY_MS)},s._compileRosteredCovers=function(e){if(this.roster){var i={};if(t.each(e,function(e){var t=this._proxiedURLForTitle(e);t&&(i[e.titleId]=t)},this),this.cacheMap){var s=[],r=[],o=function(e,t,i){e.push(i)};t.each(i,o.bind(this,s)),t.each(this.cacheMap,o.bind(this,r));var a=s.sort().join(" | "),l=r.sort().join(" | ");if(a==l)return}var c=[];t.each(i,function(e,t){c.push({url:t,bytes:this.ROSTER_ENTRY_BYTES})},this),c.push({url:APP.constants.fileURL("images/cover-404.png"),bytes:14655});var h=new n(this.ROSTER_DEFAULTS);h.merge({entries:c}),h.initialize({onFinalize:function(){this.cacheMap=i,this.roster=h,APP.bank.set(this.BANK_KEY_CACHE_MAP,this.cacheMap),APP.bank.set(this.BANK_KEY_ROSTER,this.roster.serialize())}.bind(this)})}},s._onRosterAudit=function(e){var i=e.m.claimDocumentForId(this.ROSTER_DEFAULTS.id);this.roster.merge(t.absorb(i,{health:"invalid"})),"invalid"==this.roster.health&&t.excise(this,"cacheMap"),this.cacheMap||APP.titles._saveNow()},i}),define("shibui/src/colorizer",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.CONTRAST_THRESHOLD=72,s.$init=function(){this._.cache={}},s.colorize=function(e,i,s,n){n=t.absorb(n,{}),"reset"===n.cache&&delete this._.cache[i];var r=this._.cache[i];if(r&&n.cache!==!1||(r=this._findCustomColorProperties(e,i),n.cache!==!1&&(this._.cache[i]=r)),s){var o=t.rgbToHSLuv(s);t.each(r,function(t){var s=this._ruleToHSLA(t,o),n=t&&"true"!=t?i+"--"+t:i;e.style.setProperty("--c-h-"+n,s[0]),e.style.setProperty("--c-s-"+n,s[1]+"%"),e.style.setProperty("--c-l-"+n,s[2]+"%"),e.style.setProperty("--c-hsla-"+n,"hsla("+s[0]+","+s[1]+"%,"+s[2]+"%,"+s[3]+")")},this)}else t.each(r,function(t){var s=t&&"true"!=t?i+"--"+t:i;e.style.removeProperty("--c-h-"+s),e.style.removeProperty("--c-s-"+s),e.style.removeProperty("--c-l-"+s),e.style.removeProperty("--c-hsla-"+s)},this)},s._findCustomColorProperties=function(e,i){var s=[],n=new RegExp("^--c-h-"+t.regExpEscape(i)+"(--(.*))?$");if(e.computedStyleMap)e.computedStyleMap().forEach(function(e,t){var i=t.match(n);i&&s.push(i[2]||"true")});else for(var r=window.getComputedStyle(e),o=0,a=r.length;o<a;++o){var l=r.item(o).match(n);l&&s.push(l[2]||"true")}return s},s._ruleToHSLA=function(e,i){i=i.slice(0);var s=i[2];return t.each(e.split("--"),function(e){var s=e.split("-");if("contrast"==s[0])i=i[2]>this.CONTRAST_THRESHOLD?t.rgbToHSLuv([0,0,0]):t.rgbToHSLuv([255,255,255]);else if(t.among(s[0],"sat","lit")){var n=Math.max(0,Math.min(100,parseFloat(s[1])));i["sat"==s[0]?1:2]=n}else if("min"==s[0]){var n=Math.max(0,Math.min(100,parseFloat(s[1])));i[2]<n&&(i[2]=n)}else if("max"==s[0]){var n=Math.max(0,Math.min(100,parseFloat(s[1])));i[2]>n&&(i[2]=n)}else if("ggg"==s[0]){var r=5;i[2]>92?i[2]=r:i[2]=Math.max(r,Math.min(i[2],this.CONTRAST_THRESHOLD))}},this),Math.abs(s-i[2])>5&&(i=t.debloomHSLuv(i,s)),t.rgbToHSLA(t.hsluvToRGB(i))},i}),define("app/base/bosses/cover-guru",["require","common","app/base/bosses/cover-proxy","app/models/items/title","shibui/src/colorizer"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("app/base/bosses/cover-proxy"),r=e("app/models/items/title"),o=e("shibui/src/colorizer");return s.TINT_THRESHOLD=72,s.DEFAULT_COLOR_RGB=[128,128,128],s.$init=function(){this.coverProxy=new n},s.paint=function(e,i,s,n){s&&(s=this.rgbForColor(s)),n=t.absorb(n,{cache:!1});var r=function(){this._.colorizer=this._.colorizer||new o,this._.colorizer.colorize(e,i,s,n)}.bind(this);"number"==typeof n.delay?setTimeout(r,t.excise(n,"delay")):r()},s.paintWithCover=function(e,t,i,s){i=i||"cover",this.colorForCover(e,function(e){this.paint(t,i,e,s),s&&s.callback&&s.callback(e)}.bind(this))},s.tintForColor=function(e){if(!e)return"default";var i=t.rgbToHSLuv(this.rgbForColor(e));return i[2]>=this.TINT_THRESHOLD?"light":"dark"},s.rgbForColor=function(e){return e?"string"==typeof e?t.hexToRGB(e):e:this.DEFAULT_COLOR_RGB},s.cssColorForRGB=function(e,i){return"number"==typeof i&&i<1?"rgba("+e.join(",")+","+i+")":t.rgbToHex(e)},s.colorForCover=function(e,t){"function"==typeof t&&this._titleForOwner(e).use(function(e,i){i.cover.color||e.isBroken||i.reuse(),t(i.cover.color||this.DEFAULT_COLOR_RGB)},this)},s.altText=function(e,t){var i={label:"cover.alt.unknown"};return e.format&&e.title&&(i.label="cover.alt",i.substitutions={FORMAT:e.format,TITLE:e.title}),t?i:APP.arena._phrase(i)},s.applyCoverToImage=function(e,i,s){s=t.absorb(s,{}),i.classList.remove("is-error"),this._titleForOwner(e).use(function(e,t){e.isBroken||t.title&&t.format&&t.cover.color||t.reuse(),"function"==typeof s.onColor&&s.onColor(t.cover.color||this.DEFAULT_COLOR_RGB),s.description=this.altText(t),i.setAttribute("data-cover-id",t.titleId),s.title=t;var n=this.coverURLForTitle(t,s.parameters);n||!e.isIdeal&&!e.isBroken?n?i.src!=n&&(i=this._applySourceURLToImage(i,n,s),i.setAttribute("data-cover-id",t.titleId),this._labelImage(i,s.description)):(this._labelImage(i,s.description),t.reuse()):this._handleImageError(i,s)},this)},s.coverURLForTitle=function(e,i){i=t.absorb(i,{});var s,n={width:i.width,quality:i.quality,sigma:i.blurRadius,force:!0};if(i.proxied!==!1&&(s=this.coverProxy.coverURLForTitle(e,{force:!!i.proxied,params:n})),!s){var r=t.try(e,"cover.url");if(!r)return;var o=this.coverProxy.optimizationParameters(n,e.format);o.url=t.relativeURL(encodeURI(decodeURI(r))),s=t.parameterizeURL("https://ic.od-cdn.com/resize",o)}return s&&"global"==i.usage?i.proxied&&s.indexOf("//")<0&&(s=APP.constants.ROOT_URI+s):s&&"local"==i.usage?i.proxied&&s.indexOf("//")<0&&(s=window.location.origin+s):s&&"relative"==i.usage&&(s=s.replace(/^[^\/]*/,"")),s},s.cloneImageToCanvas=function(e,t){return t&&"function"==typeof t.getContext?(t.width=e.naturalWidth,t.height=e.naturalHeight,t.getContext("2d").drawImage(e,0,0),t):APP.journal.warn("[COVER-GURU] not a canvas:",t)},s._applySourceURLToImage=function(e,i,s){s=t.absorb(s,{});var n="function"==typeof e.getContext;if(n||s.cloneIfPossible)for(var r=document.querySelectorAll('img[src="'+i+'"]'),o=0,a=r.length;o<a;++o)if(r[o].complete&&r[o].naturalWidth&&r[o].getBoundingClientRect().width){var l=e;return n||(n=!0,l=t.element({tag:"canvas",parentNode:e.parentNode}),e.parentNode&&e.parentNode.removeChild(e)),this.cloneImageToCanvas(r[o],l),l.className=e.className,"function"==typeof s.onLoad&&s.onLoad(l),l}return e=e instanceof Image?e:t.element({tag:"img",parentNode:e.parentNode,classes:e.classes}),this._bindOnce(e,"error",function(){APP.events.off(t.excise(e,"__bindings")),this._handleImageError(e,s)}.bind(this)),this._bindOnce(e,"load",function(){APP.events.off(t.excise(e,"__bindings")),"function"==typeof s.onLoad&&s.onLoad(e)}),APP.imageDirector.enqueue(e,i),e},s._labelImage=function(e,t){if("undefined"!=typeof t){var i=e instanceof Image?"alt":"aria-label";e.setAttribute(i,t)}},s._handleImageError=function(e,i){var s=t.try(i,"onError()",e,i)||this._cover404(e,i);if(t.isElement(s))return e.parentNode&&(e.parentNode.insertBefore(s,e),e.parentNode.removeChild(e)),s},s._cover404=function(e,i){i=t.absorb(i,{});var s=t.element({classes:"cover-404"});if(i.composeOnError&&i.title)s.setAttribute("data-cover-id",i.title.titleId),t.element({tag:"cite",html:i.title.title,parentNode:t.element({parentNode:s,classes:"cover-404-title"})}),t.element({tag:"cite",html:i.title.attribution(),parentNode:t.element({parentNode:s,classes:"cover-404-attribution"})});else{var e=this._applySourceURLToImage(t.element({tag:"img",parentNode:s,classes:"is-error"}),APP.constants.filePath("images/cover-404.png"),t.absorb({onError:function(){return"abort"}},i));this._labelImage(e,i.description),e.setAttribute("data-cover-id",t.try(i.title,"titleId"))}return s},s._imgToPixelData=function(e){var t;this._.canvas?(t=this._.canvas.getContext("2d"),t.clearRect(0,0,this._.canvas.width,this._.canvas.height)):(this._.canvas=document.createElement("canvas"),t=this._.canvas.getContext("2d")),this._.canvas.width=e.naturalWidth,this._.canvas.height=e.naturalHeight,t.drawImage(e,0,0,this._.canvas.width,this._.canvas.height);try{var i=t.getImageData(2,2,1,1).data;return[i[0],i[1],i[2]]}catch(e){return APP.journal.warn("[COVERGURU] failed to read pixel data",e),null}},s._titleForOwner=function(e){return t.try(e,"title")instanceof r?e.title:e instanceof r?e:void 0},s._bindOnce=function(e,t,i,s){return s=s||t,e.__bindings=e.__bindings||{},APP.events.off(e.__bindings[s]),e.__bindings[s]=APP.events.once(e,t,i)},i}),define("app/base/bosses/keyboard-focus",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.$init=function(){"virtualKeyboard"in navigator&&(navigator.virtualKeyboard.overlaysContent=!0)},s.track=function(e){APP.shell.has("device:soft-keyboard")&&(APP.events.on(e,"focus",this._onFocusElement.bind(this,e)),APP.events.on(e,"blur",this._onBlurElement.bind(this,e)))},s.blur=function(){var e=document.activeElement;e&&"function"==typeof e.blur&&e.blur()},s.blurOnContactWith=function(e){APP.events.on(e,"touchstart",this.blur.bind(this));
},s._onFocusElement=function(e){this._.focus=e,this._scrollElementAboveKeyboard(e),clearTimeout(this._.contactTimer),this._.contactTimer=setTimeout(this._listenForBodyContact.bind(this),100),this._.windowScrollHandler=this._.windowScrollHandler||APP.events.on(window,"scroll",this._preventWindowScroll.bind(this)),APP.events.on(this._.windowScrollHandler)},s._onBlurElement=function(e){this._.focus==e&&(this._.focus=null,this._unpadScroller(),clearTimeout(this._.contactTimer),this._.contactTimer=setTimeout(this._deafenForBodyContact.bind(this),100))},s._onBodyContact=function(e){if(clearTimeout(this._.contactTimer),this._.focus&&this._.focus!=e.target){var t=this._.focus;this._.contactTimer=setTimeout(function(){this._.focus&&this._.focus==t&&this._.focus.blur()}.bind(this),100)}},s._listenForBodyContact=function(){clearTimeout(this._.contactTimer),this._.contactHandler=this._.contactHandler||APP.events.onContact(document.body,{start:this._onBodyContact.bind(this)}),APP.events.on(this._.contactHandler)},s._deafenForBodyContact=function(){clearTimeout(this._.contactTimer),APP.events.off(this._.contactHandler),APP.events.off(this._.windowScrollHandler)},s._scrollElementAboveKeyboard=function(e){if(this._unpadScroller(),this._.scroller=this._scrollerForElement(e),this._.scroller){this._padScroller();var t={};if(t.now=this._.scroller.element.scrollTop,t.topline=t.now+e.getBoundingClientRect().top,t.baseline=t.topline+e.offsetHeight,t.halfscreen=screen.availHeight/2,t.midline=t.now+t.halfscreen,t.ideal=t.baseline-(t.halfscreen+10),t.baseline>t.midline){if(t.target=Math.min(t.ideal,t.topline),Math.abs(t.target-t.now)<10)return;this._.scroller.scrollTo(t.target,500)}}},s._scrollerForElement=function(e){if(APP.arena.scroller&&APP.arena.scroller.element.contains(e))return APP.arena.scroller;for(;e=e.parentNode;){var i=t.try(e,"scroller")||t.try(e,"_.scroller");if(i)return i}},s._padScroller=function(){if(this._.scroller){var e=screen.availHeight/2;this._.scroller.element.scrollHeight<3*e&&this._.scroller.element.style.setProperty("padding-bottom",e+"px")}},s._unpadScroller=function(){this._.scroller&&(this._.scroller.element.style.removeProperty("padding-bottom"),this._.scroller=null)},s._preventWindowScroll=function(e){APP.events.stop(e),window.scrollTo(0,0)},i}),define("app/base/bosses/geolocator",["require","common","app/base/multi-step-task"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("app/base/multi-step-task");return s.BANK_KEY_CACHE="geolocation:cache",s.CACHE_RECENT_MS=2592e5,s.DEFAULT_PARAMETERS={km:50,limit:999},s.$init=function(){APP.events.on("msg:geolocation:coordinates",this._onShellResponse.bind(this))},s.coordinates=function(e){var t=this._produceTask("coordinates",e);this._performTask(t)},s.nearbyLibraryBranches=function(e){var t=this._produceTask("nearby",e);this._performTask(t)},s._produceTask=function(e,i){i=t.absorb(i,{purpose:e,result:{}});var s=t.excise(i,"onSuccess"),r=t.excise(i,"onFailure"),o=t.excise(i,"onAborted");return s&&(i.onSuccess=this._onTaskSuccess.bind(this,s)),r&&(i.onFailure=this._onTaskFailure.bind(this,r)),o&&(i.onAborted=this._onTaskAborted.bind(this,o)),i.timeout=3e4,new n(i)},s._performTask=function(e){if(e.result.coordinates){if("coordinates"==e.purpose)return e.succeed();if(e.result.branches)return e.succeed();if(e.request)return e.fail();var i=t.absorb(this.DEFAULT_PARAMETERS,{coordinates:e.result.coordinates});return this._requestNearbyLibraryBranches(e,i)}var s=t.try(e.strategies,"shift()");if(!s)return e.fail();var n=s.split(":");if("gps"==n[0])this._requestCoordinates(e,t.among("authorize",n));else if("cache"==n[0]){var r={};t.among(n,"recent")&&(r.maxAge=this.CACHE_RECENT_MS),t.among(n,"branch")&&(r.source="branch"),t.among(n,"gps")&&(r.source="gps"),t.absorb(this._cachedResult(r)||{},e.result),this._performTask(e)}else if("parameters"==n[0]){var i=t.absorb(this.DEFAULT_PARAMETERS,t.absorb(e.parameters,{}));this._requestNearbyLibraryBranches(e,i)}else"ip-address"==n[0]&&this._requestNearbyLibraryBranches(e,this.DEFAULT_PARAMETERS)},s._requestCoordinates=function(e,i){var s=APP.flags.property("geo-gps-coords");if(s)return e.result.coordinates=s,e.result.source="gps:override",e.result.timestamp=t.epochMilliseconds(),this._performTask(e);var n=APP.shell.capability("geolocation");if(t.try(n,"supported")===!0||n===!0){this._.pendingTasks=this._.pendingTasks||[],this._.pendingTasks.push(e);var r={name:"geolocation:coordinates"};i&&(r.authorize=!0),APP.shell.transmit(r)}else"navigator"===n?i?navigator.geolocation.getCurrentPosition(this._onNavigatorResponse.bind(this,e),this._onNavigatorError.bind(this,e)):navigator.permissions?navigator.permissions.query({name:"geolocation"}).then(function(t){return e.result.authorization={prompt:"required"}[t.state]||t.state,"granted"!=t.state?this._performTask(e):void navigator.geolocation.getCurrentPosition(this._onNavigatorResponse.bind(this,e),this._onNavigatorError.bind(this,e))}.bind(this)):this._performTask(e):this._performTask(e)},s._onShellResponse=function(e){"pending"!=e.m.authorization&&t.each(this._.pendingTasks.splice(0),function(i){i.check()&&(e.m.latitude&&e.m.longitude?(i.result.coordinates=[e.m.longitude,e.m.latitude],i.result.source="gps",i.result.timestamp=t.epochMilliseconds(),i.result.authorization="granted",this._performTask(i)):"required"==e.m.authorization?(i.result.authorization="required",this._performTask(i)):"authorization denied"==e.m.failure?(i.result.authorization="denied",this._performTask(i)):(i.result.authorization="error",this._performTask(i)))},this)},s._onNavigatorResponse=function(e,i){e.result.coordinates=[i.coords.longitude,i.coords.latitude],e.result.source="gps",e.result.timestamp=t.epochMilliseconds(),e.result.authorization="granted",this._performTask(e)},s._onNavigatorError=function(e,t){t.code==t.PERMISSION_DENIED?(e.result.authorization="denied",this._performTask(e)):(e.result.authorization="error",this._performTask(e))},s._requestNearbyLibraryBranches=function(e,i){i=t.absorb(i,{});var s=t.excise(i,"coordinates");!i.longitude&&s&&s[0]&&(i.longitude=s[0]),!i.latitude&&s&&s[1]&&(i.latitude=s[1]),e.request=APP.services.dewey.fetch(t.parameterizeURL("locate/nearby",i),this._onNearbyLibraryBranchesFound.bind(this,e),this._onNearbyLibraryBranchesFailed.bind(this,e))},s._onNearbyLibraryBranchesFound=function(e,i){var s;try{s=JSON.parse(i)}catch(t){return APP.journal.warn("[GEOLOCATOR] error parsing response",t,i),this._onNearbyLibraryBranchesFailed(e)}delete e.request,t.absorb({branches:s.branches||[],systems:s.systems||[]},e.result),!e.result.coordinates&&e.result.branches.length&&(e.result.coordinates=[e.result.branches[0].longitude,e.result.branches[0].latitude],e.result.timestamp=t.epochMilliseconds(),e.parameters?e.result.source="parameters":(e.result.source="branch",this._saveCoordinates(e.result.coordinates,e.result.source))),this._performTask(e)},s._onNearbyLibraryBranchesFailed=function(e,t){t&&APP.journal.warn("[GEOLOCATOR] nearby-library-branches failed",t),this._performTask(e)},s._onTaskSuccess=function(e,t){e(t.result)},s._onTaskFailure=function(e,i){t.try(i,"request.abort()"),e(i.result)},s._onTaskAborted=function(e,i){t.try(i,"request.abort()"),e(i.result)},s._saveCoordinates=function(e,i){APP.bank.set(this.BANK_KEY_CACHE,{coordinates:e,source:i,timestamp:t.epochMilliseconds()})},s._cachedResult=function(e){var i=APP.bank.get(this.BANK_KEY_CACHE);if(i&&i.coordinates){if(!i.source&&i.precision){var s=t.excise(i,"precision");i.source={fine:"gps",coarse:"branch"}[s]||"gps"}if(e=t.absorb(e,{}),!(e.source&&e.source!=i.source||e.maxAge&&e.maxAge<t.epochMilliseconds()-i.timestamp))return i}},i}),define("app/base/daemons/daemon",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.BANK_KEY_DATA=void 0,s.BANK_SAVE_MS=500,s.$init=function(){this._load(),this._listen()},s._listen=function(){},s._load=function(){this.BANK_KEY_DATA&&(this.data=t.absorb(APP.bank.get(this.BANK_KEY_DATA),{}))},s._save=function(){this.BANK_KEY_DATA&&(clearTimeout(this._.saveTimer),this._.saveTimer=setTimeout(this._saveNow.bind(this),this.BANK_SAVE_MS))},s._saveNow=function(){this.BANK_KEY_DATA&&(clearTimeout(this._.saveTimer),APP.bank.set(this.BANK_KEY_DATA,t.isEmpty(this.data)?null:this.data))},s._whenIdle=function(e,i){this._clearIdle(),this._.idle={options:t.absorb(i,{ms:1e3}),handlers:{scroll:APP.events.on("arena:scroll",this._resetIdle.bind(this))},callback:function(){e(),this._clearIdle()}.bind(this),timer:null},this._.idle.options.routeLock&&(this._.idle.handlers.navigate=APP.events.on("router:navigate",this._clearIdle.bind(this))),this._resetIdle()},s._resetIdle=function(){this._.idle&&(clearTimeout(this._.idle.timer),this._.idle.timer=setTimeout(this._.idle.callback,this._.idle.options.ms))},s._clearIdle=function(){this._.idle&&(clearTimeout(this._.idle.timer),APP.events.off(this._.idle.handler),delete this._.idle)},i}),define("app/base/daemons/daemon-user-language",["require","common","./daemon"],function(e){var t=e("common"),i=e("./daemon"),s=i.new(),n=s.prototype;return n.BANK_KEY_DATA="daemon:user-language",n.checkForLanguageChange=function(){var e=t.try(APP.shell,"traits.profile.language.app")||t.try(APP.shell,"traits.profile.language.system")||t.try(APP.shell,"traits.profile.language")||t.try(navigator,"languages[0]")||navigator.language,i=this.data.overrideLanguage||e;if(i&&"string"==typeof i){var s;if(i!=this.data.expectedLanguage){var n=this._negotiate(i);n&&n!=SPARK.locale.tag&&(s={sparkLanguage:SPARK.locale.tag,systemLanguage:n})}this.data.expectedLanguage=i,this._save(),s?(APP.journal.debug("[DAEMON-USER-LANGUAGE] switch?",s),APP.events.dispatch("app:language:prompt",s,!0)&&APP.interviews.dialog("configure/language",s).present()):this._negotiate(e)==SPARK.locale.tag&&t.try(localStorage,"removeItem()","SPARK:locale")}},n.changeLanguageAndRelaunch=function(e,i){localStorage.removeItem("SPARK:locale"),SPARK.locale.determine(),e&&SPARK.locale.tag!=e&&(localStorage.setItem("SPARK:locale",e),SPARK.locale.determine()),APP.bank.set("app:i18n:delta",SPARK.locale.available),t.defer(this,"relaunch",APP.relaunch.bind(APP,i),2e3)},n._load=function(){i.prototype._load.apply(this,arguments),this._greetUserIfLocaleAdded()},n._listen=function(){this.handlers={traits:APP.events.on("platform:traits",this._onPlatformTraits.bind(this)),windowLanguageChange:APP.events.on(window,"languagechange",this._onWindowLanguageChange.bind(this)),dollar:APP.events.on("debug:command",this._onDebugCommand.bind(this))},this._whenIdle(this.checkForLanguageChange.bind(this))},n._onPlatformTraits=function(e){t.try(APP.shell,"traits.profile.language")&&(APP.events.off(this.handlers.windowLanguageChange),this.checkForLanguageChange())},n._onWindowLanguageChange=function(e){this.checkForLanguageChange()},n._onDebugCommand=function(e){if(!e.m.output){var t=(e.m.command||"").trim(),i=t.match(/^override-system-language(\s+([\w\-]+))?$/i);if(i){var s=i[2];e.m.output+=["[DAEMON-USER-LANGUAGE]","override system-reported language:",s].join(" "),this._overrideSystemReportedLanguage(s),this.checkForLanguageChange()}}},n._overrideSystemReportedLanguage=function(e){e?this.data.overrideLanguage=e:delete this.data.overrideLanguage,this._save()},n._negotiate=function(e){if(e&&"string"==typeof e)return SPARK.locale.negotiate([e])[0]},n._greetUserIfLocaleAdded=function(){var e=SPARK.locale.available,i="app:i18n:delta",s=APP.bank.get(i);if(!s){var n=t.try(APP.bank.get("daemon:engagement"),"installedAt");n&&t.epochMilliseconds()-n>36e5&&(s=["en-US","de-DE","es-419","fr-CA","it-IT","ja-JP","ru-RU","sv-SE","zh-Hans-CN","zh-Hant-TW"],s.push("en-GB"))}if(s&&!t.among(SPARK.locale.tag,s)){var r=SPARK.locale.serverDefaultTag,o=SPARK.locale.acceptTags,a=SPARK.locale.negotiate(o,e);t.each(a.slice(1),function(e){t.among(e,s)&&t.breakIteration(r=e)}),APP.journal.debug('[DAEMON-USER-LANG] automatic language change! "%s" => "%s"',r,SPARK.locale.tag),this.isUsingNewLocale=r.match(/^en/)}this.isUsingNewLocale||s&&s.join(",")==e.join(",")||APP.bank.set(i,e)},s}),define("app/base/daemons/daemon-engagement",["require","common","./daemon"],function(e){var t=e("common"),i=e("./daemon"),s=i.new(),n=s.prototype;return n.MIN_MS_BETWEEN_PROMPTS=18144e5,n.MIN_MS_SINCE_INSTALL=864e5,n.MIN_MS_SINCE_LAUNCH=12e4,n.MIN_MS_SINCE_PROBLEM=1728e5,n.MIN_MS_SINCE_FOREGROUND=3e4,n.MIN_NPS_RATING=8,n.MIN_ACTIVITIES=5,n.BANK_KEY_DATA="daemon:engagement",n.isEngaged=function(){return!(this._msSince("ratingRequestedAt")<this.MIN_MS_BETWEEN_PROMPTS)&&(!(this._msSince("installedAt")<this.MIN_MS_SINCE_INSTALL)&&(!(this._msSince("launchedAt")<this.MIN_MS_SINCE_LAUNCH)&&(!(this._msSince("errorSeenAt")<this.MIN_MS_SINCE_PROBLEM)&&(!(this._msSince("supportContactedAt")<this.MIN_MS_SINCE_PROBLEM)&&(!(this._msSince("foregroundedAt")<this.MIN_MS_SINCE_FOREGROUND)&&(!(this.data.npsRating&&this.data.npsRating<this.MIN_NPS_RATING)&&!(APP.patron.activities.all.length<this.MIN_ACTIVITIES)))))))},n.requestRatingIfEngaged=function(e){this._whenIdle(function(){this.isEngaged()&&this._requestRating()}.bind(this),e)},n._listen=function(){APP.events.on("msg:client:view:foreground",this._onForegrounded.bind(this)),APP.events.on("sage:submit",this._onSageSubmit.bind(this)),APP.events.on("router:navigate",this._onNavigate.bind(this)),APP.events.on("loan:returned",this.requestRatingIfEngaged.bind(this,{})),APP.events.on("loan:renewed",this.requestRatingIfEngaged.bind(this,{}))},n._load=function(){i.prototype._load.call(this);var e=t.epochMilliseconds();this.data.installedAt=this.data.installedAt||e,this.data.launchedAt=e,this.data.foregroundedAt=e,this._save()},n._msSince=function(e){var i=this.data[e]||-(1/0);return t.epochMilliseconds()-i},n._requestRating=function(){APP.journal.log("[DAEMON-ENGAGEMENT] rating request"),APP.shell.transmit("feedback:store:rate"),this.data.ratingRequestedAt=t.epochMilliseconds(),this._save()},n._onNavigate=function(e){setTimeout(this._checkRouterPath.bind(this),100)},n._checkRouterPath=function(){var e=t.try(APP.router,"route.path");t.try(APP.patron,"loans.all.length")>=1?this.requestRatingIfEngaged({ms:5e3,routeLock:!0}):e.match(/^shelf\/timeline/)&&this.requestRatingIfEngaged({ms:2e3,routeLock:!0})},n._onForegrounded=function(){this.data.foregroundedAt=t.epochMilliseconds(),this._save()},n._onSageSubmit=function(e){var i=e.m.submission;"error"==i.category?this.data.errorSeenAt=t.epochMilliseconds():"problem"==i.category||"question"==i.category?this.data.supportContactedAt=t.epochMilliseconds():"idea"==i.category?this.requestRatingIfEngaged():"rating"==i.category&&(this.data.npsRating=i.appRating),this._save()},s}),define("app/base/daemons/daemon-karma",["require","common","./daemon"],function(e){var t=(e("common"),e("./daemon")),i=t.new(),s=i.prototype;return s.BANK_KEY_DATA="daemon:karma",s._listen=function(){APP.events.on("loan:returned",this._onLoanReturnedEarly.bind(this))},s._onLoanReturnedEarly=function(e){this.data.earlyReturnCount=(this.data.earlyReturnCount||0)+1,this._save()},i}),define("app/base/daemons/daemon-notifier-repair",["require","common","./daemon"],function(e){var t=e("common"),i=e("./daemon"),s=i.new(),n=s.prototype;return n.diagnoseNotifier=function(e){APP.notifier.subscriptions(this._diagnoseWithCallback.bind(this,e))},n._listen=function(){APP.events.on("environment:ready",this._onEnvironmentReady.bind(this)),APP.events.on("patron:sync:complete",this._onPatronSyncComplete.bind(this)),APP.events.on("notifier:service",this._onNotifierService.bind(this)),APP.events.on("notifier:service:invalid",this._onNotifierServiceInvalid.bind(this)),APP.events.on("notifier:subscriptions",this._onNotifierSubscriptions.bind(this))},n._onEnvironmentReady=function(){this.diagnoseNotifier()},n._onPatronSyncComplete=function(){this.diagnoseNotifier()},n._onNotifierService=function(){this.diagnoseNotifier()},n._onNotifierServiceInvalid=function(e){this.diagnoseNotifier()},n._onNotifierSubscriptions=function(e){this._diagnoseNotifierState(e.m)},n._diagnoseWithCallback=function(e,t){this._diagnoseNotifierState(t),"function"==typeof e&&e(t,this.diagnosis)},n._diagnoseNotifierState=function(e){this.diagnosis={},this._isShellPermissionRequired(e)?this._isAnyRemoteCategories(e)&&this._isAnyPossessions()&&(this.diagnosis.action="request-permission"):this._isConfigurationRecommended(e)?this._isAnyRemoteCategories(e)&&this._isAnyPossessions()&&(this.diagnosis.action="recommend-configuration"):this._isPushBroken(e)?this.diagnosis.action="repair-push":this._isEmailBroken(e)?this.diagnosis.action="repair-email":this._isEmailInvalid(e)&&(this.diagnosis.action="invalid-email"),this._postNotification()},n._postNotification=function(){var e=[];this.diagnosis.action&&e.push({id:"notifier-repair",dismissedAt:null,details:{action:this.diagnosis.action}}),APP.notifier.post("notifier-repair",e,{avoidOverwrites:!0,flush:{omitted:"obsolete"}})},n._isShellPermissionRequired=function(e){return"required"==e.pushability.permit},n._isConfigurationRecommended=function(e){return e.pushability.possible&&e.service.unconfigured},n._isAnyPossessions=function(){return!(!t.try(APP,"patron.loans.all.length")&&!t.try(APP,"patron.holds.all.length"))},n._isPushBroken=function(e){return e.pushability.possible&&this._isEmailBroken(e)},n._isEmailBroken=function(e){return"granted"!=e.pushability.permit&&"email"!=e.service.provider&&this._isAnyRemoteCategories(e)},n._isEmailInvalid=function(e){return"email"==e.service.provider&&e.service.invalidity},n._isAnyRemoteCategories=function(e){return!!e.subscriptions[2].length},s}),define("app/base/daemons/daemon-notifier-possessions",["require","common","./daemon"],function(e){var t=e("common"),i=e("./daemon"),s=i.new(),n=s.prototype;return n.HOLD_LAPSING_MS=216e5,n.HOLD_RESCHEDULED_MS=6048e5,n._listen=function(){APP.events.on("environment:ready",this._onEnvironmentReady.bind(this)),APP.events.on("loan:update:all",this._onPossessionChange.bind(this)),APP.events.on("hold:update:all",this._onPossessionChange.bind(this)),APP.events.on("loan:remove",this._onPossessionRemove.bind(this)),APP.events.on("hold:remove",this._onPossessionRemove.bind(this)),APP.events.on("patron:sync:complete",this._onPatronSyncComplete.bind(this)),APP.events.on("notifier:subscribe:loan-expiring",this._onSubscriptionChange.bind(this)),APP.events.on("notifier:subscribe:loan-expired",this._onSubscriptionChange.bind(this)),APP.events.on("notifier:subscribe:hold-ready",this._onSubscriptionChange.bind(this)),APP.events.on("notifier:subscribe:hold-lapsing",this._onSubscriptionChange.bind(this)),APP.events.on("notifier:subscribe:hold-lapsed",this._onSubscriptionChange.bind(this)),APP.events.on("notifier:subscribe:hold-rescheduled",this._onSubscriptionChange.bind(this))},n._onEnvironmentReady=function(e){this._deferScan(500)},n._onPossessionChange=function(e){this._deferScan(500)},n._onPossessionRemove=function(e){this._verifyNotifications({possession:e.m.item,includeProvisionalNotifications:!0}),this._postNotificationForPossession(e.m.item)},n._onPatronSyncComplete=function(e){t.each(APP.notifier.notifications.all,function(e){e.dismissedAt&&e.category.match(/-(expired|lapsed)$/)?(APP.journal.debug('[PSN-DAEMON] removing "%s" because synced and dismissed',e.category,e),e.remove()):e.dismissedAt&&"hold-rescheduled"==e.category&&e.dismissedAt<(t.try(e,"hold().suspendTime")||1/0)-this.HOLD_RESCHEDULED_MS&&(APP.journal.debug('[PSN-DAEMON] removing "%s" to allow new hold-scheduled notifications',e),e.remove())}),this._deferScan(0,{includeProvisionalNotifications:!0})},n._onSubscriptionChange=function(e){this._deferScan(1e3)},n._verifyNotifications=function(e){e=t.absorb(e,{});t.epochMilliseconds();t.each(APP.notifier.notifications.all,function(i){if(i.category.match(/^(loan|hold)-/)&&(!i.provisional||e.includeProvisionalNotifications)&&(!e.possession||e.possession.psnKey==t.try(i,"details.psnKey")))if(t.among(i.category,"loan-expired","hold-lapsed")){var s=i.title()?i.title().possession():null;if(s&&"loan"==s.type)return APP.journal.debug('[PSN-DAEMON] removing "%s": a loan exists for this title',i.category,i),this._notificationFailedVerification(i);if(s&&"hold-rescheduled"!=this._bestNotificationCategoryForPossession(s))return APP.journal.debug('[PSN-DAEMON] removing "%s": a notifying hold exists for this title',i.category,i),this._notificationFailedVerification(i)}else{var s=i.loan()||i.hold();if(!s)return APP.journal.debug('[PSN-DAEMON] removing "%s": possession does not exist',i.category,i),this._keepPinForPossession(i),this._notificationFailedVerification(i);if("hold-rescheduled"==i.category&&!s.isRedeliveringAutomatically)return APP.journal.debug('[PSN-DAEMON] removing "%s": hold no longer auto-redelivering',i.category,i),this._notificationFailedVerification(i);var n=this._bestNotificationCategoryForPossession(s);if(n!=i.category)return APP.journal.debug('[PSN-DAEMON] removing "%s": notifying category is now "%s"',i.category,n||"nothing",i),this._keepPinForPossession(i),this._notificationFailedVerification(i)}},this)},n._postNotificationsForPossessions=function(){clearTimeout(this._.rescanTimer),t.each(APP.patron.loans.all.concat(APP.patron.holds.all),this._postNotificationForPossession.bind(this))},n._postNotificationForPossession=function(e){var i=this._bestNotificationCategoryForPossession(e),s=this._.pins?t.excise(this._.pins,e.psnKey):null;if(i){var n={id:e.psnKey,provisional:!1,details:{titleId:e.title.titleId,websiteId:e.library.websiteId,cardId:e.card.cardId,psnKey:e.psnKey}};t.among(i,"loan-expiring","hold-ready","hold-lapsing")?(n.vanishAt=e.expireTime,n.createdAt=e.expireTime-2592e5):t.among(i,"hold-lapsing")?(n.vanishAt=e.expireTime,n.createdAt=e.expireTime-this.HOLD_LAPSING_MS):t.among(i,"hold-rescheduled")&&(n.createdAt=e.suspendTime-this.HOLD_RESCHEDULED_MS),s&&(n.vanishAt="pin"),n.createdAt&&(n.createdAt=Math.max(t.try(e,"createTime")||0,Math.min(t.epochMilliseconds(),n.createdAt)));var r=APP.notifier.post(i,[n],{avoidOverwrites:!0});t.each(r,function(e){e.provisional=!1})}},n._scan=function(e){this._verifyNotifications(e),this._postNotificationsForPossessions(),delete this._.pins},n._deferScan=function(e,i){var s=t.epochMilliseconds(),n=s+(e||0);this._.rescanTimestamp&&this._.rescanTimestamp>s&&this._.rescanTimestamp<n||(this._.rescanTimestamp=n,this._.rescanTimer=setTimeout(this._scan.bind(this,i),e||0))},n._bestNotificationCategoryForPossession=function(e){var i=APP.patron.cards.find({cardId:t.try(e,"card.cardId")});if(i)if("loan"==e.type){var s=APP.patron.loans.find({psnKey:e.psnKey});if(s&&s.isWithinRenewalWindow())return"loan-expiring";if(!s&&e.expireTime<t.epochMilliseconds())return"loan-expired"}else if("hold"==e.type){var n=APP.patron.holds.find({psnKey:e.psnKey});if(n&&n.isRedeliveringAutomatically)return"hold-rescheduled";if(n&&n.isAvailable){var r=n.expireTime-t.epochMilliseconds();return r>this.HOLD_LAPSING_MS?"hold-ready":"hold-lapsing"}if(!n&&e.expireTime<t.epochMilliseconds()&&e.isAvailable&&e.title&&!APP.patron.loans.find({"title.titleId":e.title.titleId}))return"hold-lapsed"}},n._keepPinForPossession=function(e){"pin"==e.vanishAt&&(this._.pins=this._.pins||[],this._.pins.push(e.details.psnKey))},n._notificationFailedVerification=function(e){e.dismissedAt?e.dismissCorrespondingShellNotification():e.dismiss(),e.remove()},s}),define("app/base/daemons/daemon-card-expiry",["require","common","./daemon"],function(e){var t=e("common"),i=e("./daemon"),s=i.new(),n=s.prototype;return n._listen=function(){APP.events.listen("card:update:all",this._scan.bind(this))},n._scan=function(){var e=[];t.each(APP.patron.cards.all,function(t){t.isExpired()&&e.push(t.cardId)});var i={"card-expired":[],"cards-expired":[]};e.length>1?i["cards-expired"].push({id:e.sort().join(",")}):t.each(e,function(e){i["card-expired"].push({id:e})}),t.each(i,function(e,t){APP.notifier.post(e,t,{avoidOverwrites:!0,flush:{omitted:!0}})})},s}),define("app/base/daemons/daemon-fulfillment-choices",["require","common","./daemon"],function(e){var t=e("common"),i=e("./daemon"),s=i.new(),n=s.prototype;return n.prefer=function(e,i){var s=APP.patron.choice("fulfillment:preferences")||{};i?s[e]=i:delete s[e],APP.patron.choose("fulfillment:preferences",s),APP.patron.choose("fulfillment:choices"),this._wipeDisabledDownloads(),"bifocal"!=i&&e==t.try(APP.title,"format")&&APP.titles.now(null)},n.preference=function(e){var t=APP.patron.choice("fulfillment:preferences")||{};return t[e||"book"]},n.choose=function(e,i){if(!this.preference(e.format)){var s=APP.patron.choice("fulfillment:choices")||{};s[i]=s[i]||[],t.among(e.titleId,s[i])||(s[i].push(e.titleId),APP.patron.choose("fulfillment:choices",s)),"bifocal"!=i&&e==APP.title&&APP.titles.now(null)}},n.choice=function(e){var i=this.preference(e.format);if(i)return i;var s=APP.patron.choice("fulfillment:choices")||{};return t.each(s,function(s,n){t.among(e.titleId,n)&&(i=s,t.breakIteration())}),i},n.isChoiceToMake=function(e){if(this.preference(e))return!0;for(var i=0,s=APP.patron.loans.all.length;i<s;++i){var n=APP.patron.loans.all[i];if(n.fulfiller.isFulfillable("kindle"))return!0}var r=APP.patron.choice("fulfillment:choices");if(t.try(r,"kindle.length"))return!0;for(var o=APP.libraries.includingNow(APP.libraries.withCards()),i=0,s=o.length;i<s;++i)if(o[i].promotesKindle)return!0;return!1},n.countDownloadsFulfillableAs=function(e){if(!APP.shell.has("rosters"))return 0;var i=0;return t.each(APP.patron.loans.all,function(s){t.try(s.luggage(),"status().bytes.percent")&&s.fulfiller.isFulfillable(e)&&(i+=1)}),i},n._wipeDisabledDownloads=function(){APP.shell.has("rosters")&&t.each(APP.patron.loans.all,function(e){var t=e.luggage();t.isDisabledByFulfillmentChoice()&&t.chooseStorage("stream")})},s}),define("app/base/daemons/daemon-content-visibility",["require","common","./daemon"],function(e){var t=e("common"),i=e("./daemon"),s=i.new(),n=s.prototype;return n._listen=function(){APP.events.on("tag:load:all",this._onTagLoadAll.bind(this)),APP.events.on("tag:update:all",this._onTagUpdateAll.bind(this)),APP.events.on("card:update:all",this._onCardUpdateAll.bind(this))},n._onTagLoadAll=function(e){this._hasSubscriptionTypeTag()&&(this.state=this._computeVisibilityState())},n._onTagUpdateAll=function(e){var t=this._hasSubscriptionTypeTag();t&&!this.state?this._publishVisibilityState(this._computeVisibilityState()):!t&&this.state&&delete this.state},n._onCardUpdateAll=function(e){if(this.state){var t=this._computeVisibilityState();JSON.stringify(t)!=JSON.stringify(this.state)&&this._publishVisibilityState(t)}},n._hasSubscriptionTypeTag=function(){for(var e=0,i=APP.patron.tags.all.length;e<i;++e){var s=APP.patron.tags.all[e];if("notify-me"==t.try(s.behavior,"key"))return!0}return!1},n._computeVisibilityState=function(){var e=[],i=APP.libraries.withCards();return i.sort(function(e,t){return(e.websiteId||"").localeCompare(t.websiteId||"")}),t.each(i,function(i){var s={websiteId:i.websiteId,libraryName:i.safeName(),cards:[]},n=i.cards().slice(0);n.sort(function(e,t){return e.cardId.localeCompare(t.cardId)}),t.each(n,function(e){s.cards.push({cardId:e.cardId,accounts:e.accounts})}),e.push(s)}),e},n._publishVisibilityState=function(e){APP.journal.debug("[DAEMON-VISIBILITY] state change:",this.state,e),this.state=e,APP.services.vandal.updateVisibility(this.state)},s}),define("app/base/daemons/daemon-default-tags",["require","common","./daemon"],function(e){var t=e("common"),i=e("./daemon"),s=i.new(),n=s.prototype;return n.BANK_KEY_DATA="daemon:default-tags",n._listen=function(){APP.events.on("patron:sync:complete",this._onPatronSyncComplete.bind(this)),APP.events.on("card:authenticated",this._onCardAuthenticated.bind(this)),APP.events.on("title:switch",this._onTitleSwitch.bind(this)),APP.events.on("loan:add",this._onLoanAdd.bind(this))},n._onPatronSyncComplete=function(e){"success"==e.m.status&&(this._maybeCreateBorrowedTag(),this._maybeCoordinateWishList(t.try(e,"m.options.manual")))},n._onCardAuthenticated=function(e){this._countWishListItems()},n._onTitleSwitch=function(e){if(t.try(e.m,"title")&&t.try(e.m,"info.sample")){var i=APP.titles.libraryForNow()||APP.library;this._maybeCreateSampledTag(e.m.title,i)}},n._onLoanAdd=function(){this._maybeCreateBorrowedTag()},n._countWishListItems=function(){APP.services.vandal.fetch({url:"tags/coordinate/counts/wishlist"},function(e){this.data["wish-list-sync"]={counts:JSON.parse(e)},this._save()}.bind(this))},n._maybeCoordinateWishList=function(e){e&&APP.patron.tags.find({"behavior.key":"wish-list-sync"})&&APP.services.vandal.fetch({url:"tags?coordinate=force"})},n._maybeCreateBorrowedTag=function(){APP.patron.loans.all.length&&(t.try(this.data,"borrowed.used")||(this.data.borrowed=this.data.borrowed||{},this.data.borrowed.used=!0,this._save(),APP.patron.tags.use(function(e,i){if(!i.find({"behavior.key":"borrowed"})){if(!e.isIdeal)return i.reuse();var s=this._createTagWithBehavior("borrowed");s&&(t.each(APP.patron.loans.collate({sort:"newest"}),function(e){s.addToTitle(e.title,e.library)},this),s.save())}}.bind(this))))},n._maybeCreateSampledTag=function(e,i){"magazine"!=e.format&&(t.try(this.data,"sampled.used")||(this.data.sampled=this.data.sampled||{},this.data.sampled.used=!0,this._save(),APP.patron.tags.use(function(t,s){if(!s.find({"behavior.key":"sampled"})){if(!t.isIdeal)return s.reuse();var n=this._createTagWithBehavior("sampled");n&&(n.addToTitle(e,i),n.save())}}.bind(this))))},n._createTagWithBehavior=function(e,t){var i=APP.patron.tags.suggestTagNamesForBehavior(e,1)[0];if(i){var s=APP.patron.tags.produce({name:i,description:APP.arena._phrase({label:"tag.behavior.smart."+e+".default-description",substitutions:{DATE:new Date},okIfMissing:!0})});return s.behave(e),s}},s}),define("app/base/daemons/daemon-history-migration",["require","common","./daemon","app/base/multi-step-task"],function(e){var t=e("common"),i=e("./daemon"),s=i.new(),n=s.prototype,r=e("app/base/multi-step-task");return n.BANK_KEY_DATA="daemon:history-migrate",n.MAX_PER_CARD=1e3,n.MAX_STAGGER_DATE=new Date("2023-06-30").getTime(),n.evaluateCards=function(e,i,s){var n={expired:[],noLibraryHistory:[],noCardHistory:[],eligible:[]};if(t.each(e||APP.patron.cards.all,function(e){e.isExpired()?n.expired.push(e):e.library&&!e.library.allowThunderHistory?n.noLibraryHistory.push(e):e.thunderHistoryStartTime?(n.eligible.push(e),i&&i.counts&&!e.thunderHistoryCount&&(n.uncounted=n.uncounted||[],n.uncounted.push(e))):n.noCardHistory.push(e)}),n.uncounted){var r=t.excise(n,"uncounted");APP.sentry.countHistoryForCards(r,function(e){var i=JSON.parse(e)||{};t.each(r,function(e){e.thunderHistoryTrueCount=t.try(i[e.cardId],"total")||0,e.thunderHistoryCount=Math.min(this.MAX_PER_CARD,e.thunderHistoryTrueCount)},this),"function"==typeof s&&s(n)}.bind(this),function(e){APP.journal.warn("[HISTORY-MIGRATION] error fetching counts",e),"function"==typeof s&&s(n)}.bind(this))}else"function"==typeof s&&s(n);return n},n.pollAllCards=function(e){if(!APP.patron.activities.isRecordingPaused()){var e=t.absorb(e,{});if(this.pollTask){if("auto"==e.mode)return;if("manual"==this.pollTask.mode){if(e.cards=e.cards||this.evaluateCards(),!e.cards.eligible.length)return;var i=t.select(t.try(this.pollTask,"cards.eligible"),function(e){return e.cardId||""}).sort(),s=t.select(e.cards.eligible,function(e){return e.cardId||""}).sort();if(i.join(",")==s.join(","))return}}t.try(this.pollTask,"abort()"),e.cards=e.cards||this.evaluateCards(),e.cards.eligible.length&&this._commencePolling(e)}},n.cancelPolling=function(){this.pollTask&&this.pollTask.abort()},n._listen=function(){APP.events.once("card:load:all",this._onCardLoadAll.bind(this));var e=function(){t.defer(this,"poll",this._considerAutomaticPolling.bind(this),1e3)}.bind(this);APP.events.once("patron:sync:complete",e),APP.events.on("card:add",e),APP.events.on("activity:remove",this._onActivityRemove.bind(this)),APP.events.on("debug:command",this._onDebugCommand.bind(this))},n._onCardLoadAll=function(e){if(this.data.cardPolls=this.data.cardPolls||{},
"number"!=typeof this.data.staggerDate){var i=0,s=6048e5;e.m.collation.all.length&&(i=t.epochMilliseconds()+Math.random()*s),this.data.staggerDate=Math.min(i,this.MAX_STAGGER_DATE),this._save()}},n._onActivityRemove=function(e){var i=e.m.item,s=t.try(i,"card.cardId")||t.try(i,"cardId");if(s&&"borrow"==t.try(i,"action")){this.data.cardPolls=this.data.cardPolls||{};var n=this.data.cardPolls[s]=this.data.cardPolls[s]||{};n.timestamp=i.createTimestamp+1e3,n.addedCount=n.addedCount||0}},n._considerAutomaticPolling=function(){if(this.pollTask)return!1;var e=t.epochMilliseconds(),i=864e5,s=7*i,n=this.data.staggerDate||0;return!(n>e)&&(this.data.cardPolls=this.data.cardPolls||{},void this.evaluateCards(APP.patron.cards.all,{counts:!0},function(n){var r=this._firstActTimestamps();n.eligible=t.select(n.eligible,function(t){var n=this.data.cardPolls[t.cardId]||{};if(n.timestamp){var o=e-(n.timestamp||0);if(o<i)return;if(o<s&&!n.addedCount)return}else{var a=r[t.cardId]||1/0,l=a-(t.thunderHistoryStartTime||1/0);if(l<s)return void(this.data.cardPolls[t.cardId]={timestamp:e,addedCount:0})}return t},this),n.eligible.length&&(APP.journal.debug("[HISTORY-MIGRATION] automatic polling - %s cards",n.eligible.length),this.pollAllCards({cards:n,mode:"automatic",fats:r}))}.bind(this)))},n._commencePolling=function(e){var i=t.epochMilliseconds(),s=this.pollTask=new r(t.absorb(e,{onSuccess:this._onPollTaskSuccess.bind(this),onFailure:this._onPollTaskFailure.bind(this),onAborted:this._onPollTaskAbort.bind(this)}));s.borrowActs=s.borrowActs||this._borrowActs(),s.cards=s.cards||this.evaluateCards(),s.queue=t.select(s.cards.eligible,function(e){var n={card:e};return n.progress={total:e.thunderHistoryCount||1,done:0,added:0},n.consumeOlderThan=i,n.consumeNewerThan=0,"automatic"==s.mode&&(n.consumeNewerThan=t.try(this.data,"cardPolls."+e.cardId+".timestamp")||n.consumeNewerThan,n.consumeNewerThan||(s.fats=s.fats||this._firstActTimestamps(),n.consumeOlderThan=s.fats[e.cardId]||n.consumeOlderThan)),n},this),t.excise(s,"fats"),s.done=[],this._announceTaskState(s,"commence"),this.data.cardPolls=this.data.cardPolls||{},this.data.staggerDate=Math.min(i,this.data.staggerDate||1/0);var n=function(e){this._abortTaskUnlessActive(s)||(s.job&&(s.done.push(s.job),e&&(this.data.cardPolls[s.job.card.cardId]={timestamp:e,addedCount:t.try(s.job,"progress.added")||0},this._save())),s.job=s.queue.shift(),this._announceTaskState(s,"progress"),s.job?this._importHistory(s.job,s,n):s.succeed())}.bind(this);n()},n._importHistory=function(e,i,s){var n=e.card;if(!n.thunderHistoryStartTime)return APP.journal.debug("[HISTORY-MIGRATION] card has no history",n.cardId),s();if(n.isExpired())return APP.journal.debug("[HISTORY-MIGRATION] card is expired",n.cardId),s();var r=t.epochMilliseconds(),o=function(l){this._abortTaskUnlessActive(i)||APP.sentry.migratingHistoryForCard(n,{page:l},function(o){if(!this._abortTaskUnlessActive(i)){var l=!1;try{var c=JSON.parse(o);e.progress.total=Math.min(this.MAX_PER_CARD,c.total||e.progress.total),l=c.pages>c.page;for(var h=0,u=c.acts.length;h<u;++h){var p=c.acts[h];if(e.consumeOlderThan>p.createTime){if(e.consumeNewerThan>p.createTime)return APP.journal.debug("[HISTORY-MIGRATION] reached job horizon",n.cardId,p.createTime,e.consumeNewerThan),s(r);var d=!1;t.each(i.borrowActs[p.titleId],function(e){d=d||Math.abs(e-p.createTime)<36e5},this),d||(p.title=APP.titles.produce({titleId:t.excise(p,"titleId")}),p.card=n,p.library=n.library,delete p.cardId,delete p.websiteId,p.meta=p.meta||{},p.meta.migrated=r,APP.patron.activities.make(p),e.progress.added+=1)}if(e.progress.done+=1,e.progress.done>=e.progress.total){l=!1;break}}}catch(e){APP.journal.warn("[HISTORY-MIGRATION] local error",e),r=void 0}l?(this._announceTaskState(i,"progress"),a(c.page+1)):s(r)}}.bind(this),function(e){APP.journal.warn("[HISTORY-MIGRATION] server error",e),e.status?s():(APP.events.once("network:info",o.bind(this,l)),this._announceTaskState(i,"pause"))}.bind(this))}.bind(this),a=function(e){var s=1e3;"automatic"==i.mode&&"activities"!=t.try(APP.router.route,"args.state")&&(s*=10),t.defer(this,"request-page",o.bind(this,e),s)}.bind(this);o(1)},n._firstActTimestamps=function(e){var i={};return t.each(e||APP.patron.activities.all,function(e){if("borrow"==e.action){var s=t.try(e,"card.cardId")||t.try(e,"cardId");s&&e.createTime&&(i[s]=Math.min(e.createTime,i[s]||1/0))}},this),i},n._borrowActs=function(e){var i={};return t.each(e||APP.patron.activities.all,function(e){var s=t.try(e,"title.titleId");e.createTime&&s&&"borrow"==e.action&&(i[s]=i[s]||[],i[s].push(e.createTime))},this),i},n._announceTaskState=function(e,i){e.progress={mode:e.mode||"manual",total:0,done:0,added:0},e.job&&t.absorb(e.job.progress,e.progress),t.each(e.done,function(t){e.progress.total+=t.progress.total||0,e.progress.done+=t.progress.total||0,e.progress.added+=t.progress.added||0}),t.each(e.queue,function(t){e.progress.total+=t.progress.total||0}),e.progress.percent=e.progress.done/(e.progress.total||1),e.announced=i,APP.events.dispatch("history:migration:"+i,{task:e})},n._abortTaskUnlessActive=function(e){return!e.check(this.pollTask)&&(e.orphan(),!0)},n._onPollTaskSuccess=function(e){e==this.pollTask&&delete this.pollTask,this._announceTaskState(e,"complete")},n._onPollTaskFailure=function(e){e==this.pollTask&&delete this.pollTask,this._announceTaskState(e,"abort")},n._onPollTaskAbort=function(e){e==this.pollTask&&delete this.pollTask,this._announceTaskState(e,"abort")},n._onDebugCommand=function(e){if(!e.m.output){var i=(e.m.command||"").trim(),s=i.match(/^tl-history-auto-poll( -?\d+)?/);if(s){var n=s[1]?parseFloat(s[1]||"0"):null,r=t.epochMilliseconds();("number"==typeof n||this.data.staggerDate>r)&&(this.data.staggerDate=r+60*(n||0)*1e3,this._save()),this._considerAutomaticPolling(),e.m.output=["[DAEMON-HISTORY-MIGRATION]","Considering auto polling. Stagger date:",new Date(this.data.staggerDate)].join(" ")}else if(i.match(/^tl-history-stamp-14?d/)){var o=i.indexOf("4")?14:1,a=24*o*60*60*1e3+1;t.each(this.data.cardPolls,function(e,t){t.timestamp&&(t.timestamp-=a)}),this._save(),e.m.output=["[DAEMON-HISTORY-MIGRATION]","Pushed back last-poll timestamps by",1==o?"1 day":o+" days"].join(" ")}}},s}),define("app/base/daemons/daemon-playable-titles",["require","common","./daemon","app/models/items/title-mirror"],function(e){var t=e("common"),i=e("./daemon"),s=i.new(),n=s.prototype,r=e("app/models/items/title-mirror");return n.BANK_KEY_DATA="daemon:playable-titles",n.BANKING_TTL=2592e3,n.recomputePlayableTitles=function(e){t.defer(this,"recompute"),t.defer(this,"recompute:luggage"),t.defer(this,"recompute:journey");var i=APP.patron.loans.collate({format:"audiobook",sort:"activity"});return i.length?void this.mirror.reflect(i,function(t){this._processBatchOfInfos(t,e)}.bind(this)):APP.shell.transmit({name:"title:list:playable",titles:[]})},n._load=function(){i.prototype._load.call(this),this.mirror=new r,this.data.banking&&this.data.banking<t.epochSeconds()-this.BANKING_TTL&&t.excise(this.data,"banking"),this._.lastBatch=APP.bank.get("title:list:playable")},n._listen=function(){APP.events.on("msg:title:list:playable",this._onTitleListPlayable.bind(this)),APP.events.on("loan:update:all",this._onLoanUpdateAll.bind(this)),APP.events.on("luggage:storage:choice",this._onLuggageStorageChoice.bind(this)),APP.events.on("luggage:download:finalize",this._onLuggageDownloadFinalize.bind(this)),APP.events.on("title:switch",this._onTitleSwitch.bind(this)),APP.events.once("environment:ready",this._onTitleSwitch.bind(this))},n._onTitleListPlayable=function(e){e.m.subscribe?(this.transmitting=!0,this.data.banking=t.epochSeconds()):e.m.subscribe===!1&&(t.excise(this.data,"banking"),this._save()),t.defer(this,"recompute",this.recomputePlayableTitles.bind(this,!0),100)},n._scheduleRecomputeIfTracking=function(e,i){if(this.transmitting||this.data.banking){"number"!=typeof i&&(i=1e3);var s,n=t.compact(["recompute",e]).join(":");s="luggage"==e?this._recomputePlayableTitleLuggages.bind(this):"journey"==e?this._recomputePlayableTitleJourneys.bind(this):this.recomputePlayableTitles.bind(this,!1),t.defer(this,n,s,i)}},n._onLoanUpdateAll=function(e){this._scheduleRecomputeIfTracking()},n._onLuggageStorageChoice=function(e){this._scheduleRecomputeIfTracking("luggage")},n._onLuggageDownloadFinalize=function(e){this._scheduleRecomputeIfTracking("luggage")},n._onTitleSwitch=function(e){APP.events.off(this._.journeyHandler),APP.title&&(this._.journeyHandler=APP.events.on("journey:update:"+APP.title.titleId,this._scheduleRecomputeIfTracking.bind(this,"journey",100)))},n._recomputePlayableTitleLuggages=function(){var e=this._.lastBatch;e&&(e=t.select(e,function(e){var i=APP.titles.luggages.find({titleId:e.id}),s=t.try(i,"status().bytes.percent")||0;return e.downloadProgress==s?e:t.absorb({downloadProgress:s},t.absorb(e,{}))}),this._deliverInfos(e))},n._recomputePlayableTitleJourneys=function(){var e=this._.lastBatch;e&&(e=t.select(e,function(e){var i=APP.journeys.find({titleId:e.id}),s=t.try(i,"progress")||0;return e.readingProgress==s?e:t.absorb({readingProgress:s},t.absorb(e,{}))}),this._deliverInfos(e))},n._processBatchOfInfos=function(e,i){if(!e.recycle.length){var s=[];t.each(e.infos,function(e){e.readingProgress=e.readingProgress||0;for(var t=0,i=s.length;t<i;++t)if(s[t].id==e.id)return;e.active?s.unshift(e):s.push(e)}),this._deliverInfos(s,i)}},n._deliverInfos=function(e,t){this.data.banking&&APP.bank.set("title:list:playable",e),(this.transmitting||t)&&APP.shell.transmit({name:"title:list:playable",titles:this._infosWithDelta(e)}),this._.lastBatch=e},n._infosWithDelta=function(e){var i=this._.lastBatch;return i?t.select(e,function(e,s){if(e.id!=t.try(i[s],"id"))return e;var n=JSON.stringify(e),r=JSON.stringify(i[s]);return n!=r?e:t.absorb(e,{"title:list:playable:unchanged":!0})}):e},s}),define("app/base/bosses/summoner",["require","common","app/base/daemons/daemon-user-language","app/base/daemons/daemon-engagement","app/base/daemons/daemon-karma","app/base/daemons/daemon-notifier-repair","app/base/daemons/daemon-notifier-possessions","app/base/daemons/daemon-card-expiry","app/base/daemons/daemon-fulfillment-choices","app/base/daemons/daemon-content-visibility","app/base/daemons/daemon-default-tags","app/base/daemons/daemon-history-migration","app/base/daemons/daemon-playable-titles"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("app/base/daemons/daemon-user-language"),r=e("app/base/daemons/daemon-engagement"),o=e("app/base/daemons/daemon-karma"),a=e("app/base/daemons/daemon-notifier-repair"),l=e("app/base/daemons/daemon-notifier-possessions"),c=e("app/base/daemons/daemon-card-expiry"),h=e("app/base/daemons/daemon-fulfillment-choices"),u=e("app/base/daemons/daemon-content-visibility"),p=e("app/base/daemons/daemon-default-tags"),d=e("app/base/daemons/daemon-history-migration"),m=e("app/base/daemons/daemon-playable-titles");return s.$init=function(){this._summonDaemons()},s._summonDaemons=function(){this.daemons={},this.daemons.userLanguage=new n,this.daemons.engagement=new r,this.daemons.karma=new o,this.daemons.notifierRepair=new a,this.daemons.notifierPossessions=new l,this.daemons.cardExpiry=new c,this.daemons.fulfillmentChoices=new h,this.daemons.contentVisibility=new u,this.daemons.defaultTags=new p,this.daemons.historyMigration=new d,this.daemons.playableTitles=new m},i}),define("app/base/bosses/sage",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.MAX_ERRORS_PER_MINUTE=5,s.$init=function(){this._.history=[],APP.events.listen("msg:sage:submit:error",this._submitErrorFromEvent.bind(this)),APP.events.listen("msg:diagnostics:shell:error",this._submitErrorFromEvent.bind(this))},s.submit=function(e,i,s,n){var r=this._fillOutSubmission(e,i),o=t.absorb(r,{category:e,createdAt:t.epochSeconds()});if(this._.history.unshift(o),APP.events.dispatch("sage:submit",{submission:o}),"error"==e&&this.history(60,"error").length>this.MAX_ERRORS_PER_MINUTE)return APP.journal.warn("[SAGE] throttled - did not submit",r),n?n("throttled"):null;var a=function(e){var t;try{var i=JSON.parse(e);t=i.submission.id,o.sageId=t}catch(e){}APP.journal.info("[SAGE] submitted (%s):",t,r),s&&s(t)},l=function(e){APP.journal.warn("[SAGE] submission failed:",r,e),n&&n(e)};this._postToSage("submit/"+e,r,a,l)},s.analyze=function(e,t,i,s){this._postToSage("analyze/"+e,this._fillOutSubmission(e,t),i,s)},s.history=function(e,i){for(var s=e?t.epochSeconds()-e:0,n=[],r=i?t.flatten([i]):[],o=0,a=this._.history.length;o<a;++o){var l=this._.history[o];if(l.createdAt<s)break;r.length&&r.indexOf(l.category)<0||n.push(l)}return n},s._fillOutSubmission=function(e,i){var s=i;try{s=this._expandSubmissionContext(i),s.chip=this._getChip();var n=t.absorb(t.try(APP.patron,"_.choices"),{});t.each(["patron:name","patron:email:address","fulfillment:choices"],function(e){delete n[e]}),n["ui:language"]=SPARK.locale.tag,n.notifier=this._getNotifierData(),n["library:allowDeepSearch"]=t.try(APP.library,"allowDeepSearch"),t.each(APP.patron.pins.all,function(e){n.pins=n.pins||[],n.pins.push(e.scope+"→"+e.category+"="+e.value)}),s.patronPreferences=n,s.libraryCards=this._getLibraryCardData(),s.navigation=this._getNavigationData(),s.appClientName=t.try(APP.client,"name"),s.appClientVersion=t.try(APP.client,"info.version.value"),s.appShellVersion=t.try(APP.shell,"info.version.value"),s.appShellMode=t.try(APP.shell,"info.mode"),s.appSessionAgeMS=t.try(APP.summoner,"daemons.engagement._msSince()","launchedAt"),s.deviceTraits=t.try(APP.shell,"traits"),s.userAgentString=this._getUserAgentString(),s.userAgentWidth=window.innerWidth,s.userAgentHeight=window.innerHeight,t.each(["errorData","deviceTraits","libraryCards"],function(e){if("string"==typeof s[e])try{s[e]=JSON.parse(s[e])}catch(t){s[e]={value:s[e]}}})}catch(t){APP.journal.warn("[SAGE] error filling out submission",e,i,t)}return s},s._expandSubmissionContext=function(e){var i=t.absorb(e,{});try{var s=t.excise(i,"submissionContext")||{},n=s.loan?s.loan.title:s.title;if(n&&"string"!=typeof n){i.titleId=n.titleId,i.titleName=n.title,i.titleCreator=n.attribution(),i.titlePublisher=n.publisher?n.publisher.name:null,i.titleFormat=n.format;var r=s.loan||s.magazine;r?(i.titleAccess="full",i.titleDownloadStatus=t.try(r.luggage(),"status().bytes.percent")||0):i.titleAccess="sample"}var o=s.library||APP.library;o&&(i.activeLibraryName=o.safeName(),i.activeLibraryKey=o.key(),i.activeLibraryWebsiteId=o.websiteId,o.branch&&(i.activeBranchId=o.branch.id,i.activeBranchName=o.branch.name,i.activeBranchCity=o.branch.city,i.activeBranchRegion=o.branch.region,i.activeBranchCountry=o.branch.country,i.activeBranchLatitude=o.branch.lat,i.activeBranchLongitude=o.branch.lng))}catch(t){APP.journal.warn("[SAGE] error expanding submission",e,t)}return i},s._sendErrorToShell=function(e){try{var t=function(e){return e.slice(0,100).replace(/\n.*/,"")},i={message:t(e.errorMessage),source:t(e.errorSource||"[unknown source]")};APP.shell.transmit({name:"diagnostics:client:error",error:i})}catch(t){APP.journal.warn("[SAGE] error sending error to shell",e,t)}},s._postToSage=function(e,t,i,s){if(!APP.services.sage)return APP.journal.warn("[SAGE] Sage URI undefined. Did not send:",t),s?s():null;try{return APP.services.sage.fetch({url:e,method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json",Accept:"application/json"}},i,s)}catch(e){APP.journal.warn("[SAGE] Error submitting to Sage:",t,e),s&&s()}},s._getChip=function(){var e;return(e=t.try(APP.sentry,"chip"))?e:(e=t.try(APP.bank,"get()","sentry.chip"))?e:(e=t.try(window.localStorage,"getItem()","anonchip"))?e:(e="anonchip"+t.generateUUID().substr(8),t.try(window.localStorage,"setItem()","anonchip",e),e)},s._getNotifierData=function(){var e={timestampOfLastSentryUpdateToService:APP.bank.get("notifier:sentry:service"),timestampOfLastSentryUpdateToSubscriptions:APP.bank.get("notifier:sentry:subscriptions")};return e.service=t.try(APP,"notifier._.service"),e.subscriptions=t.try(APP,"notifier._.subscriptionLevels[2]"),e},s._getLibraryCardData=function(){var e=[];return t.each(t.try(APP.patron,"cards.all"),function(t){var i={};i.cardId=t.cardId,i.cardName=t.cardName,i.createTime=new Date(t.createTime),i.puid=t.puid,i.libraryName=t.library.safeName(),i.libraryWebsiteId=t.library.websiteId,i.libraryAdvantageKey=t.advantageKey,i.limits=t.limits||{},i.counts=t.counts,e.push(i)}),e},s._getNavigationData=function(){var e={origin:location.origin,current:t.try(APP.router.route,"path")||"",history:APP.historian.history()};return APP.historian.future.length&&(e.future=APP.historian.future.slice(),e.future[0]==e.current&&e.future.shift),e},s._getUserAgentString=function(){return(window.BRIDGE?window.BRIDGE.userAgent:"")||navigator.userAgent},s._submitErrorFromEvent=function(e){var i=t.clone(e.m);i.errorMessage=i.errorMessage||i.message;var s=t.excise(i,"error")||{};return s.message&&(i.errorMessage=s.message),s.source&&(i.errorSource=s.source),s.humanReadable&&(i.errorHumanReadable=s.humanReadable),s.data&&(i.errorData=s.data),i.errorSource=i.errorSource||t.excise(i,"source"),this.submit("error",i)},i}),define("app/base/bosses/scribe",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.BANK_KEY="scribe:state",s.FLUSH_MIN_MS=3e3,s.FLUSH_MAX_MS=15e3,s.REQUEST_TIMEOUT_MS=3e3,s.LIMITS={hi:{sessions:16,acts:128},lo:{sessions:2,acts:16}},s.$init=function(){var e=this._.state=APP.bank.get(this.BANK_KEY)||{};e.tid||(e.tid=t.generateUUID());var i=(new Date).getMonth()+1;(!e.cohort||e.period&&e.period!=i)&&(e.cohort=Math.floor(101+98.99*Math.random()).toString().substr(-2),e.period=i),e.sessions||(e.sessions=[]),this._.streamProperties={v:1},window.BRIDGE&&window.BRIDGE.userAgent&&(this._.streamProperties.ua=window.BRIDGE.userAgent),this._.sendCount=0,this._.session=this._generateSession(),this._revertSending(),this.toggleInscribing(!1),APP.events.on("network:info",this._onNetworkInfo.bind(this)),APP.events.on("debug:command",this._onDebugCommand.bind(this))},s.toggleInscribing=function(e){this.isInscribing=e,this._.flushSoon&&!t.isEmpty(this._.state.sessions)&&this._.flushSoon(!0);var i=this.isInscribing?1:10;this._.flushSoon=t.staggerInvocation(this._flushNow.bind(this),this.FLUSH_MIN_MS*i,this.FLUSH_MAX_MS*i)},s.record=function(e,i){var s=[],n={};if(this.isInscribing||this.isDispatchingRecordEvents){var r={sessionId:this._.session.id,view:{path:this._anonymize(APP.router.route.path),title:this._anonymize(t.try(APP.router.route.waypoint,"name"))},activity:{name:e,properties:t.absorb(i,{})},timestamp:t.epochMilliseconds()};APP.events.dispatch("scribe:activity:record",r)}this.isInscribing&&(s.push([r.view.path,{title:r.view.title},[[r.activity.name,r.activity.properties,r.timestamp]]]),t.absorb(this._.session.properties,n)),this._absorbSessionsData([[this._.session.id,n,[s]]]),this._.sendCount?this._.flushSoon():this._flushNow()},s._generateSession=function(){var e={};return e.timestamp=t.epochMilliseconds(),e.id=[this._.state.cohort+(100+this._.state.period).toString().substr(-2),this._.state.tid.replace(/-.*$/,""),e.timestamp].join("-"),e.properties={screen:[screen.width,screen.height],client:APP.client.info.version.value},e},s._anonymize=function(e){if(!e)return"";if(!t.try(APP,"patron.cards.all.length"))return e;var i=[];t.each(APP.patron.cards.all,function(e){i.push(e.cardId)});var s=new RegExp(i.join("|"),"gi");return e.replace(s,"XXXXX")},s._absorbSessionsData=function(e){t.each(e,function(e){for(var i=null,s=0,n=this._.state.sessions.length;s<n;++s)if(this._.state.sessions[s][0]==e[0]){i=this._.state.sessions[s];break}if(i){var r=null;if(t.each(e[2],function(e){i[2]=i[2]||[];for(var s=0,n=i[2].length;s<n;++s)if(i[2][s][0]==e[0]){r=i[2][s];break}r?t.each(e[2],function(e){for(var t=0,i=r[2].length;t<i;++t)if(r[2][t][2]==e[2])return r[2][t]=e;r[2].push(e),r[2].sort(function(e,t){return e[2]-t[2]})}):i[2].unshift(e)},this),i[3]&&e[3]){i[3].overflow+=e[3].overflow;var o=existingSession[3].timeRange.concat(session[3].timeRange).sort();i[3].timeRange=[o[0],t.last(o)]}else e[3]&&(i[3]=e[3])}else e[0]==this._.session.id?this._.state.sessions.push(e):this._.state.sessions.unshift(e)},this),this._enforceDataLimits()},s._enforceDataLimits=function(){var e=this.LIMITS[APP.shell.has("bank")?"hi":"lo"],i=[];t.each(this._.state.sessions,function(e){t.each(e[2],function(e){t.each(e[2],function(e){i.push(e[2])})})});var s=i.length-e.acts;if(s>0){i=i.sort().slice(s);var n=i[0];t.each(this._.state.sessions,function(e){if(e[2]){var i=[];t.each(e[2],function(s){for(;s[2]&&s[2][0]&&s[2][0][2]<n;){e[3]=e[3]||{overflow:0,timeRange:[s[2][0][2],t.last(s[2])[2]]};s[2].shift();e[3].overflow+=1}s[2]&&s[2][0]||i.push(s)}),t.each(i,function(i){t.excise(e[2],i)})}})}var r=this._.state.sessions.length-e.sessions;r>0&&(this._.state.sessions=this._.state.sessions.slice(r))},s._saveState=function(){var e=t.absorb(this._.state,{});this.isInscribing||(t.excise(e,"sessions"),t.excise(e,"sending"));var i=JSON.stringify(this._.state);i!=this._.strState&&(this._.strState=i,APP.bank.set(this.BANK_KEY,e))},s._flushNow=function(){if(APP.network.reachable)if(this._.state.sending)this._.flushSoon(),this._saveState();else{var e=this._.state.sending=this._.state.sessions||[];t.isEmpty(e)&&e.push([this._.session.id,this._.session.properties,[]]),t.each(e,function(e){t.isEmpty(e[1])&&t.absorb(this._.session.properties,e[1])},this),this._.state.sessions=[],this._saveState(),this._sendActivity()}else this._saveState()},s._commitSending=function(){t.excise(this._.state,"sending")&&this._saveState()},s._revertSending=function(){this._.state.sending&&(this._absorbSessionsData(t.excise(this._.state,"sending")),this._saveState())},s._sendActivity=function(){var e=[];e.push(this.isInscribing?this._.state.tid:"noop"),e.push(this._.streamProperties),e.push(this._.state.sending);var t=[e];APP.services.dewey.fetch({url:"inscribe",method:"POST",timeout:this.REQUEST_TIMEOUT_MS,body:JSON.stringify({scribe:t}),headers:{"Content-Type":"application/json",Accept:"application/json"}},this._onScribeResponse.bind(this),this._onScribeFailure.bind(this)),this._.sendCount+=1},s._onScribeResponse=function(e,i){var s;try{s=JSON.parse(e).dewey}catch(t){APP.err("scribe-response-unparseable",{url:i.responseURL,status:i.status,headers:i.getAllResponseHeaders(),response:e}).sendToSage()}t.try(s,"version")&&APP.events.dispatch("app:update:check",s),this._commitSending()},s._onScribeFailure=function(e){if(APP.journal.warn("[SCRIBE] failed to send activity",e),e.status>=400&&e.status<=500){var i=[];t.each(this._.state.sending,function(e){return e[2]?(e[3]=e[3]||{overflow:0},t.each(e[2],function(i){e[3].overflow+=i[2].length;var s=[i[2][0][2],t.last(i[2])[2]];s=s.concat(e[3].timeRange||[]).sort(),e[3].timeRange=[s[0],t.last(s)]}),void(e[2]=[])):i.push(e)},this),t.each(i,function(e){t.excise(this._.state.sending,e)},this)}this._revertSending()},s._onNetworkInfo=function(e){e.m.network.reachable&&(t.isEmpty(this._.state.sessions)||this._.flushSoon())},s._onDebugCommand=function(e){var i=e.m.command||"",s=i.match(/^version-rollout( (reset|0.\d+))?$/i);if(s&&!e.m.output&&"string"==typeof t.try(this._,"session.id")){if("reset"==s[2])this._.state.cohort=Math.floor(101+98.99*Math.random()).toString().substr(-2),this._.state.period=(new Date).getMonth()+1,this._.session=this._generateSession(),this._.state.sessions=[],this._saveState();else if(s[2]){var n=parseFloat(s[1]);this._.state.cohort=Math.floor(100+100*n).toString().substr(-2),this._.state.period=0,this._.session=this._generateSession(),this._.state.sessions=[],this._saveState()}var n=parseFloat(this._.state.cohort)/100;e.m.output="[UPDATER] version-rollout: "+n}},i}),define("app/base/bosses/sentry",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.BANK_KEY_CHIP="sentry.chip",s.BANK_KEY_IDENTITY="sentry.identity",s.SYNC_DELAY_AFTER_CHIP=3e3,s.$init=function(){this._.queue=[],this.chip=APP.bank.get(this.BANK_KEY_CHIP),this.identity=APP.bank.get(this.BANK_KEY_IDENTITY),APP.shell.convey(this.BANK_KEY_CHIP,this.chip),APP.shell.convey(this.BANK_KEY_IDENTITY,this.identity)},s.addJobToQueue=function(e,i,s){s=t.absorb(s,{}),s.unique?(this._.jobSeq=(this._.jobSeq||0)+1,e+=":"+this._.jobSeq):this.removeJobFromQueue(e);var n={key:e,definition:i,options:s||{}};return s.prioritize?this._.queue.unshift(n):this._.queue.push(n),this._workOffQueue(),n},s.removeJobFromQueue=function(e){if(e){var i=[];return t.each(this._.queue,function(t){return t.key!==e?i.push(t):void("success"==t.outcome||t.request&&(t.request.silentAbort=!0,t.request.abort()))}),i.length<this._.queue.length&&(this._.queue=i,!0)}},s.getJobsInQueue=function(){var e=[];return t.each(this._.queue,function(t){e.push(t.key)}),e},s.forgetIdentity=function(){this.identity=void 0},s.acquireChip=function(e,i){var s={c:"d:"+APP.client.info.version.value.replace(/-.*/,""),s:"0"};APP.shell.has("ui:bifocal-webview")&&(s.s=t.compact(["n-"+(t.try(APP.shell.info,"platform[0]")||"x"),t.try(APP.shell.info,"version.value")||null]).join(":").toLowerCase());var n=this._requestOptions(t.parameterizeURL("chip",s));n.path="chip";var r=APP.bank.get(this.BANK_KEY_IDENTITY);return r&&(n.headers.Authorization="Bearer "+r),this.addJobToQueue("chip:acquire",n,{onSuccess:this._onChip.bind(this,e,i),onFailure:this._onChipFailure.bind(this,i),prioritize:!0}).key},s.destroyChip=function(e,t){var i=this._requestOptions("chip","DELETE");return this.addJobToQueue("chip:destroy",i,{onSuccess:e,onFailure:t,chip:!0}).key},s.synchronize=function(e,t){var i=this._requestOptions("chip/sync","GET");return this.addJobToQueue("sync",i,{onSuccess:e,onFailure:t,chip:!0}).key},s.borrowTitle=function(e,i,s,n,r){var o,a=APP.patron.holds.find({"title.titleId":i.titleId,"card.cardId":e.cardId});o=a&&a.isAvailable?a.holding():i.holdings.produce({libraryKey:e.advantageKey});var r=t.absorb(r,{method:"POST"}),l=this._requestOptions("card/"+e.cardId+"/loan/"+i.titleId,r.method),c={},h=e.lendingPeriods[i.format];return h&&(c.period=h.preference[0],c.units=h.preference[1]),c.lucky_day=o.isOnlyAvailableAsLuckyDayLoan()?1:null,c.title_format=APP.constants.mediaTypes(i.format),r.reportingContext&&(c.reporting_context=r.reportingContext),this._requestBody(l,c),this.addJobToQueue("circ:borrow:"+l.url,l,{onSuccess:this._onBorrowed.bind(this,s),onFailure:this._onSentryFailure.bind(this,n),chip:!0}).key},s.renewLoan=function(e,t,i){var s=this._onRenewed.bind(this,e,t),n=i;return this.borrowTitle(e.card,e.title,s,n,{method:"PUT"})},s.fulfillLoan=function(e,t,i,s){var n=this._requestOptions(["card/"+e.card.cardId,"loan/"+e.title.titleId,"fulfill/"+t.fulfillmentSubtype].join("/"),"GET");return this.addJobToQueue("circ:fulfill:"+n.url,n,{onSuccess:this._onFulfilled.bind(this,e,i),onFailure:this._onSentryFailure.bind(this,s),chip:!0}).key},s.returnLoan=function(e,t,i){var s=this._requestOptions("card/"+e.card.cardId+"/loan/"+e.title.titleId,"DELETE");return this.addJobToQueue("circ:return:"+s.url,s,{onSuccess:this._onReturned.bind(this,t,e),onFailure:this._onSentryFailure.bind(this,i),chip:!0}).key},s.holdTitle=function(e,i,s,n,r){var o=this._requestOptions("card/"+e.cardId+"/hold/"+i.titleId),a={email_address:"",days_to_suspend:0};return t.try(r,"reportingContext")&&(a.reporting_context=r.reportingContext),this._requestBody(o,a),this.addJobToQueue("circ:hold:"+o.url,o,{onSuccess:this._onHeld.bind(this,s),onFailure:this._onSentryFailure.bind(this,n),chip:!0}).key},s.updateHold=function(e,t,i,s){var n=this._requestOptions("card/"+e.card.cardId+"/hold/"+e.title.titleId,"PUT"),r={};return"string"==typeof t.emailAddress&&(r.email_address=t.emailAddress),"number"==typeof t.daysToSuspendHolds&&(r.days_to_suspend=t.daysToSuspendHolds),this._requestBody(n,r),this.addJobToQueue("circ:hold:update:"+n.url,n,{onSuccess:this._onEditedHold.bind(this,e,i),onFailure:this._onSentryFailure.bind(this,s),chip:!0}).key},s.cancelHold=function(e,t,i){var s=this._requestOptions("card/"+e.card.cardId+"/hold/"+e.title.titleId,"DELETE");return this.addJobToQueue("circ:hold:cancel:"+s.url,s,{onSuccess:this._onCanceled.bind(this,t,e),onFailure:this._onSentryFailure.bind(this,i),chip:!0}).key},s.getNTCCode=function(e,t,i){var s=this._requestOptions("auth/card/"+e.cardId+"/ntc/"+APP.constants.NTC_TARGET_CLIENT,"GET");return this.addJobToQueue("circ:ntc:code:"+s.url,s,{onSuccess:function(e){t(JSON.parse(e).code)},onFailure:this._onSentryFailure.bind(this,i),chip:!0})},s.fetchDervishPassport=function(e,i,s){e=t.absorb(e,{});var n=t.excise(e,"tData")||{};n["dewey-url"]=APP.constants.ROOT_URI,n.spec="V"+(APP.shell.info.spec||APP.client.info.spec),SPARK.locale.isUserAgentDefault||(n.locale=SPARK.locale.tag);var r=t.excise(e,"title"),o=e.cardId?"card/"+e.cardId:"sample",a={t:btoa(unescape(encodeURIComponent(JSON.stringify(n)))),website_id:t.try(t.excise(e,"library"),"websiteId")};r.reportingContext&&(a.reporting_context=JSON.stringify(t.excise(r,"reportingContext")));var l=["open",r.format,o,"title/"+r.titleId].join("/"),c=t.parameterizeURL(l,a);e=t.absorb(e,this._requestOptions(c,"GET"));var h=function(e,t){var n;try{n=JSON.parse(e)}catch(e){return this._onSentryFailure(s,e)}i(n,t)}.bind(this);return this.addJobToQueue("dervish:passport",e,{onSuccess:h,onFailure:this._onSentryFailure.bind(this,s),unique:!0,chip:!0}).key},s.fetchReadingData=function(e,t,i,s){if(!t.format)return this._onSentryFailure(s);var n=this._requestOptions("card/"+e.cardId+"/"+t.format+"/data/"+t.titleId,"GET",5e3);return this.addJobToQueue("dervish:data:"+n.url,n,{onSuccess:this._onSentrySuccess.bind(this,i),onFailure:this._onSentryFailure.bind(this,s),chip:!0}).key},s.resetReadingData=function(e,t,i){var s=this._requestOptions("card/any/"+e.format+"/data/"+e.titleId,"DELETE");return this.addJobToQueue("dervish:data:reset:"+s.url,s,{onSuccess:this._onSentrySuccess.bind(this,t),onFailure:this._onSentryFailure.bind(this,i),chip:!0}).key},s.authenticationForms=function(e,i,s,n){var r=this._requestOptions(t.parameterizeURL("auth/forms/"+e.websiteId,i),"GET");return this.addJobToQueue("auth:forms:"+e.websiteId,r,{onSuccess:s,onFailure:n}).key},s.submitLocalAuthentication=function(e,t,i,s){var n=this._requestOptions("auth/link/"+e.websiteId,"POST");return this._requestBody(n,t),this.addJobToQueue("auth:link:"+e.websiteId,n,{onSuccess:i,onFailure:s,chip:!0}).key},s.completeExternalAuthentication=function(e,i,s){e=e.replace(/^(?:\/\/|[^\/]+)*\//,"");var n=this._requestOptions(t.parameterizeURL(e),"POST");return this.addJobToQueue("auth:external",n,{onSuccess:i,onFailure:s,unique:!0,chip:!0}).key},s.submitIDCIdentification=function(e,t,i,s){var n;if(t.phone_number)n="phone";else{if(!t.email_address)return APP.journal.warn("[SENTRY] unrecognized IDC identification",t),s();n="email"}var r=this._requestOptions("auth/link/"+n+"/"+e.websiteId,"POST");return this._requestBody(r,t),this.addJobToQueue("auth:idc:id",r,{onSuccess:i,onFailure:s,unique:!0,chip:!0}).key},s.registerForIDC=function(e,t,i,s){var n=this._requestOptions("auth/register/"+e.websiteId,"POST");return this._requestBody(n,t),this.addJobToQueue(n.url.replace(/\//g,":"),n,{onSuccess:i,onFailure:s,chip:!0}).key},s.renameCard=function(e,i){var s=this._requestOptions(t.parameterizeURL("card/"+e.cardId,{card_name:i}),"PUT"),n=function(t){e.cardName=t,APP.patron.cards.save()},r=n.bind(this,i),o=this._onSentryFailure.bind(this,function(e){n(e.response.cardName),this._handleSentryError(e)}.bind(this));return this.addJobToQueue("card:rename:"+e.cardId,s,{onSuccess:r,onFailure:o,chip:!0}).key},s.unlinkCard=function(e,t,i){var s=this._requestOptions("card/"+e.cardId,"DELETE"),n=function(){APP.patron.cards.removeItem(e),"function"==typeof t&&t()};return this.addJobToQueue("card:unlink:"+e.cardId,s,{onSuccess:n,onFailure:this._onSentryFailure.bind(this,i),chip:!0}).key},s.revokeCards=function(e,t){var i=this._requestOptions("chip/revoke","POST"),s=function(){
APP.patron.sync.commence({freshness:0}),"function"==typeof e&&e()};return this.addJobToQueue("cards:revoke",i,{onSuccess:s,onFailure:this._onSentryFailure.bind(this,t),chip:!0}).key},s.notifyingService=function(e,t,i,s,n){var r=this._requestOptions("chip/notifying/service","PUT"),o={provider:e,credentials:t};return"undefined"!=typeof i&&null!==i&&(o.invalidity=i),this._requestBody(r,o),this.addJobToQueue("notifying:service",r,{onSuccess:s,onFailure:n,chip:!0}).key},s.notifyingSubscriptions=function(e,t,i){var s=this._requestOptions("chip/notifying/subscriptions","PUT");return this._requestBody(s,{subscriptions:e}),this.addJobToQueue("notifying:subscriptions",s,{onSuccess:t,onFailure:i,chip:!0}).key},s.notifyingEmailUnsubscribe=function(e,t,i,s){var n=this._requestOptions("chip/notifying/email","DELETE");return this._requestBody(n,{address:e,identifiers:t}),this.addJobToQueue("notifying:email:unsubscribe",n,{onSuccess:i,onFailure:s,chip:!0}).key},s.stashData=function(e,i,s){var n=t.excise(e,"property"),r=this._requestOptions("chip/stash/"+n,"PUT");return this._requestBody(r,e),this.addJobToQueue("stash:property:put:"+n,r,{onSuccess:i,onFailure:s,chip:!0}).key},s.permitHistoryForCards=function(e,i,s,n){var r=t.select(e,function(e){return e.cardId}),o={cards:r.join(",")},a=this._requestOptions(t.parameterizeURL("chip/migrating/history/permission",o),"allow"==i?"PUT":"DELETE");return this.addJobToQueue("migrating:history:permission",a,{onSuccess:s,onFailure:n,chip:!0}).key},s.countHistoryForCards=function(e,i,s){var n=t.select(e,function(e){return e.cardId}),r={cards:n.join(",")},o=this._requestOptions(t.parameterizeURL("chip/migrating/history/counts",r),"GET");return this.addJobToQueue("migrating:history:counts",o,{onSuccess:i,onFailure:s,chip:!0}).key},s.migratingHistoryForCard=function(e,i,s,n){var r=this._requestOptions(t.parameterizeURL("chip/migrating/"+e.cardId+"/history",i),"GET");return this.addJobToQueue("migrating:history:"+e.cardId,r,{onSuccess:s,onFailure:n,chip:!0}).key},s.get=function(e,i,s,n){var r="get-"+e.replace(/[\?\#].*/,"").replace(/[\/_\s]+/g,"-");i&&(e=t.parameterizeURL(e,i));var o=this._requestOptions(e,"GET");return this.addJobToQueue(r,o,{onSuccess:this._onSentrySuccess.bind(this,s),onFailure:this._onSentryFailure.bind(this,n),chip:!0}).key},s.post=function(e,t,i,s){var n="post-"+e.replace(/[\?\#].*/,"").replace(/[\/_\s]+/g,"-"),r=this._requestOptions(e,"POST");return t&&this._requestBody(r,t),this.addJobToQueue(n,r,{onSuccess:this._onSentrySuccess.bind(this,i),onFailure:this._onSentryFailure.bind(this,s),chip:!0}).key},s.delete=function(e,t,i){var s="delete-"+e.replace(/[\?\#].*/,"").replace(/[\/_\s]+/g,"-"),n=this._requestOptions(e,"DELETE");return this.addJobToQueue(s,n,{onSuccess:this._onSentrySuccess.bind(this,t),onFailure:this._onSentryFailure.bind(this,i),chip:!0}).key},s._onChip=function(e,i,s,n,r){var o;try{o=JSON.parse(s)}catch(e){o={response:s,error:""+e}}return"string"!=typeof o.chip||"string"!=typeof o.identity?(APP.journal.error("[SENTRY] chip acquisition invalidity",o),APP.events.dispatch("investigate:record",{what:"chip acquisition invalidity",where:"Sentry#_onChip",onChipAttrs:o,requestOptions:r}),void("function"==typeof i&&i(this.chip))):this.chip&&this.chip!=o.chip?(APP.events.dispatch("investigate:record",{what:"rejecting chip replacement",where:"Sentry#_onChip",currentChip:this.chip,onChipAttrs:o,requestOptions:r}),void("function"==typeof i&&i(this.chip))):(this.identity!=o.identity&&(this.identity=o.identity,APP.bank.set(this.BANK_KEY_IDENTITY,this.identity),APP.shell.convey(this.BANK_KEY_IDENTITY,this.identity)),this.chip!=o.chip&&(this.chip=o.chip,APP.bank.set(this.BANK_KEY_CHIP,this.chip),APP.shell.convey(this.BANK_KEY_CHIP,this.chip),APP.events.dispatch("patron:chip:acquired",{chip:this.chip})),setTimeout(function(){APP.investigator.isChipMissingFromBank()||(t.try(APP,"patron.sync")?APP.patron.sync.commence({freshness:0}):APP.events.dispatch("investigate:record",{what:"cannot commence sync",where:"Sentry#_onChip",cardCount:t.try(APP,"patron.cards.all.length"),onChipAttrs:o}))},this.SYNC_DELAY_AFTER_CHIP),void("function"==typeof e&&e(this.chip)))},s._onChipFailure=function(e){APP.journal.error("[SENTRY] remote chip acquisition failed"),"function"==typeof e&&e(this.chip)},s._onBorrowed=function(e,i){var s=[JSON.parse(i)],n=APP.patron.loans.importAll(s,{source:"external"})[0];APP.events.dispatch("loan:borrowed",{item:n});var r=APP.patron.holds.find({psnKey:n.psnKey});r&&!n.isLuckyDayLoan&&(APP.patron.holds.removeItem(r),APP.events.dispatch("hold:satisfied",{item:n})),"magazine"!=n.title.format&&"number"==typeof t.try(n,"card.counts.loan")&&(n.card.counts.loan+=1),e&&e(n)},s._onRenewed=function(e,t,i){t(e),APP.events.dispatch("loan:renewed",{item:e})},s._onHeld=function(e,i){var s=[JSON.parse(i)],n=APP.patron.holds.importAll(s,{source:"external"})[0];e(n),APP.events.dispatch("hold:placed",{item:n}),"number"==typeof t.try(n,"card.counts.hold")&&(n.card.counts.hold+=1)},s._onEditedHold=function(e,t,i){var s=JSON.parse(i);e.import(s,{source:"external"}),APP.patron.holds.save(),t(e),APP.events.dispatch("hold:edited",{item:e})},s._onFulfilled=function(e,t,i){var s=JSON.parse(i);t(s.fulfill.href),APP.events.dispatch("loan:fulfilled",{item:e})},s._onReturned=function(e,i){APP.patron.loans.removeItem(i),e(),APP.events.dispatch("loan:returned",{item:i}),"magazine"!=i.title.format&&"number"==typeof t.try(i,"card.counts.loan")&&(i.card.counts.loan=Math.max(0,i.card.counts.loan-1))},s._onCanceled=function(e,i){APP.patron.holds.removeItem(i),"function"==typeof e&&e(i),"number"==typeof t.try(i,"card.counts.hold")&&(i.card.counts.hold=Math.max(0,i.card.counts.hold-1))},s._onSentrySuccess=function(e,t){"function"==typeof e&&e(JSON.parse(t))},s._onSentryFailure=function(e,i){APP.journal.warn("[SENTRY] request failure",i),(e=e||this._handleSentryError.bind(this))(t.absorb(i,{origin:"Sentry"}))},s._handleSentryError=function(e){APP.router.rebuild(),APP.err("sentry-failure",e).sendToSage().present()},s._requestOptions=function(e,t,i){return{url:e,method:t||"POST",timeout:i||32e3,credentials:!0,headers:{Accept:"application/json"}}},s._requestBody=function(e,t){return e.headers=e.headers||{},e.headers["Content-Type"]="application/json",e.body=JSON.stringify(t),e},s._requestWithChip=function(e,i,s){s=s||function(){};var n=0,r=function(e){return n+=1,n>3?s(e):void this.acquireChip(void 0,r)}.bind(this),o=function(i){"missing_chip"==t.try(i,"response.result")?(delete e.request,r(i)):s(i)}.bind(this);if(this.identity){var a=t.absorb(e.definition,{});return a.headers=a.headers||{},a.headers.Authorization="Bearer "+this.identity,APP.services.sentry.fetch(a,i,o)}r()},s._workOffQueue=function(){var e=this._.queue[0];if(e&&!e.request){var t=function(){e.outcome="success",this.removeJobFromQueue(e.key),"function"==typeof e.options.onSuccess&&e.options.onSuccess.apply(e,arguments),this._workOffQueue()}.bind(this),i=function(){e.outcome="failure",this.removeJobFromQueue(e.key),"function"==typeof e.options.onFailure&&e.options.onFailure.apply(e,arguments),this._workOffQueue()}.bind(this);e.options.chip?e.request=this._requestWithChip(e,t,i):e.request=APP.services.sentry.fetch(e.definition,t,i)}},i}),define("app/base/bosses/stasher",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.cap=function(){var e=APP.flags.property("export-cap");return e&&(e=Math.floor(parseFloat(e))),"number"==typeof e&&isFinite(e)?e:5e3},s.stash=function(e,t,i,s,n){APP.sentry.stashData({property:e,value:t,exportable:!(!i||!i.exportable)},s,n)},s.share=function(e,i,s,n,r){if(i.export)return this._export(i.export,function(t){this.share(e,t,s,n,r)}.bind(this),r);var s=t.absorb(s,{}),o=t.absorb(s,{exportable:!0});this.stash(e,i,o,function(e){var t=JSON.parse(e),i=s.representation||"data",r=APP.constants.SHARE_URI+"/"+i+"/"+t.uuid;s.filename&&(r+="/"+s.filename),n(r)},r)},s.shareTitle=function(e,i){var s=this.shareableTitleURL(e);if(this._canShellShare("url")){var n={name:"nav:share:url",url:s,title:e.title,subtitle:e.authorNames(),image:{url:APP.coverGuru.coverURLForTitle(e,{proxied:!1})}};if(i=i||t.try(APP.arena,"dom.popover.anchor"),i&&i.getBoundingClientRect){var r=i.getBoundingClientRect();n.popAt={left:Math.round(r.left),top:Math.round(r.top),width:Math.round(r.width),height:Math.round(r.height)}}APP.shell.transmit(n)}else navigator.share?navigator.share({title:e.title,url:s}):APP.shell.openURL(s)},s.shareableTitleURL=function(e){return APP.constants.SHARE_URI+"/title/"+e.titleId},s._export=function(e,t,i){var s={data:{},count:0,callback:t,onFailure:i};e.tag?this._exportTag(s,e.tag,e.criteria||{}):e.journey?this._exportJourney(s,e.journey):e.activities?this._exportActivities(s,e.activities):(APP.journal.warn("[STASHER] unknown exportable",e),this._completeJob(s))},s._exportTag=function(e,i,s){e.data.version=1,e.data.tag={name:i.niceName(),description:i.description,timestamp:i.createTime,UUID:i.uuid},e.data.titles=[],i.page(s,0,this.cap(),function(i){t.each(i,function(t){var i={};this._exportTitle(e,t.title,i),i.timestamp=t.createTime,this._exportLibrary(e,t.library(),i),e.data.titles.push(i)},this),this._completeJob(e)}.bind(this),e.onFailure)},s._exportJourney=function(e,i){e.data.version=1,e.data.readingJourney={},e.data.bookmarks=[],e.data.highlights=[],e.data.circulation=[],i.coalesce(function(){t.try(e,"data.circulation")&&(t.each(i.timelines(),function(i){t.each(i,function(t){if("bookmark"==t.markType)e.data.bookmarks.push(this._exportMark(e,t));else if("highlight"==t.markType)e.data.highlights.push(this._exportMark(e,t));else{var i={timestamp:t.createTime};"tagging"==t.type?(i.activity="Tagged",i.details=t.collation.niceName(),this._exportLibrary(e,t.library(),i)):(this._exportActivity(e,t,i),this._exportLibrary(e,t.library,i)),e.data.circulation.push(i)}},this)},this),t.each(e.data,function(t,i){0===i.length&&delete e.data[t]}),this._exportTitle(e,i.title(),e.data.readingJourney),e.data.readingJourney.percent=i.progress,this._completeJob(e))}.bind(this))},s._exportActivities=function(e,i){return e.data.version=1,e.data.timeline=[],t.each(i.slice(0,this.EXPORT_ITEMS_CAP),function(t){var i={};this._exportTitle(e,t.title,i),i.timestamp=t.createTime,this._exportActivity(e,t,i),this._exportLibrary(e,t.library,i),e.data.timeline.push(i)},this),this._completeJob(e)},s._exportLibrary=function(e,t,i){t&&(i.library={},this._incrementJob(e),t.use(function(s){return this._isStateFinal(s)?(i.library.text=t.safeName(),i.library.url=APP.constants.ROOT_URI+"/"+t.path(),i.library.key=t.baseKey,void this._decrementJob(e)):t.reuse()},this))},s._exportTitle=function(e,i,s){i&&(s.cover={},s.title={},s.author="",s.publisher="",s.isbn="",this._incrementJob(e),i.use(function(n){if(!this._isStateFinal(n))return i.reuse();var r=i.cover;r&&r.url&&(s.cover.contentType="image/jpeg",s.cover.url=r.url,s.cover.title=i.title,s.cover.color=t.rgbToHex(r.color||APP.coverGuru.DEFAULT_COLOR_RGB),s.cover.format={book:"ebook"}[i.format]||i.format),s.title.text=i.title,s.title.url=this.shareableTitleURL(i),s.title.titleId=i.titleId,s.author=i.authorNames(),s.publisher=t.try(i.publisher,"name"),s.isbn=i.isbn,this._decrementJob(e)}.bind(this)))},s._exportActivity=function(e,t,i){if(i=i||{},i.activity=t.action,i.details=t.details,"hold"==t.action)i.activity="Placed on hold";else if("hold-expire"==t.action)i.activity="Hold expired";else if("borrow"==t.action||"renew"==t.action){i.activity={borrow:"Borrowed",renew:"Renewed"}[t.action];var s=t.durationUnits();s&&(i.details=APP.arena._phrase({label:"export.en.time",substitutions:s}))}else if("loan-expire"==t.action)i.activity="Returned",i.details="on due date";else if("loan-return"==t.action){i.activity="Returned";var s=t.durationUnits();s&&(i.details=APP.arena._phrase({label:"export.en.time.early",substitutions:s}))}else i.activity=t.action;return i},s._exportMark=function(e,i,s){return s=s||{},s.timestamp=i.createTime,s.chapter=i.chapterTitle,s.percent=i.percentageOfBook,t.each(["color","quote","note"],function(e){i[e]&&(s[e]=i[e])}),s},s._incrementJob=function(e){e.count+=1},s._decrementJob=function(e){return e.data?(e.count-=1,void(e.invokeWhenZero&&e.count<=0&&this._invokeCallbackForJob(e))):void APP.journal.warn("[STASHER] job decremented, but callback already invoked",e)},s._completeJob=function(e,t){e.morphback=t,e.count<=0?this._invokeCallbackForJob(e):e.invokeWhenZero=!0},s._invokeCallbackForJob=function(e){e.morphback&&e.morphback(e.data),e.callback(e.data),e.data=null},s._isStateFinal=function(e){return e.isIdeal||e.isBroken},s._canShellShare=function(e){return!!APP.shell.has("nav:share")&&APP.shell.capability("nav:share").indexOf(e)>=0},i}),define("focus-visible/focus-visible",["require","common","gala"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("gala");return s.INPUT_TYPES_WHITELIST={text:!0,search:!0,url:!0,tel:!0,email:!0,password:!0,number:!0,date:!0,month:!0,week:!0,time:!0,datetime:!0,"datetime-local":!0},s.$init=function(e){this.scope=e,this.hadKeyboardEvent=!1,this.hadFocusVisibleRecently=!1,this.hadFocusVisibleRecentlyTimeout=null,this._.docHandlers=[n.on(document,"keydown",this._onKeyDown.bind(this),!0),n.on(document,"mousedown",this._onPointerDown.bind(this),!0),n.on(document,"pointerdown",this._onPointerDown.bind(this),!0),n.on(document,"touchstart",this._onPointerDown.bind(this),!0),n.on(document,"visibilitychange",this._onVisibilityChange.bind(this),!0)],this._.pointerHandlers=[n.on(document,"mousemove",this._onInitialPointerMove.bind(this),!0),n.on(document,"mousedown",this._onInitialPointerMove.bind(this),!0),n.on(document,"mouseup",this._onInitialPointerMove.bind(this),!0),n.on(document,"pointermove",this._onInitialPointerMove.bind(this),!0),n.on(document,"pointerdown",this._onInitialPointerMove.bind(this),!0),n.on(document,"pointerup",this._onInitialPointerMove.bind(this),!0),n.on(document,"touchmove",this._onInitialPointerMove.bind(this),!0),n.on(document,"touchstart",this._onInitialPointerMove.bind(this),!0),n.on(document,"touchend",this._onInitialPointerMove.bind(this),!0)],this._.scopeHandlers=[n.on(this.scope,"focus",this._onFocus.bind(this),!0),n.on(this.scope,"blur",this._onBlur.bind(this),!0)]},s._isValidFocusTarget=function(e){return!!(e&&e!==document&&"HTML"!==e.nodeName&&"BODY"!==e.nodeName&&"classList"in e&&"contains"in e.classList)},s._focusTriggersKeyboardModality=function(e){var t=e.tagName,i=e.type;return!("INPUT"!==t||!this.INPUT_TYPES_WHITELIST[i]||e.readOnly)||("TEXTAREA"===t&&!e.readOnly||!!e.isContentEditable)},s._addFocusVisibleClass=function(e){e.classList.contains("focus-visible")||(e.classList.add("focus-visible"),e.setAttribute("data-focus-visible-added",""))},s._removeFocusVisibleClass=function(e){e.hasAttribute("data-focus-visible-added")&&(e.classList.remove("focus-visible"),e.removeAttribute("data-focus-visible-added"))},s._onKeyDown=function(e){e.metaKey||e.altKey||e.ctrlKey||(this._isValidFocusTarget(this.scope.activeElement)&&this._addFocusVisibleClass(this.scope.activeElement),this.isTyping||(this.hadKeyboardEvent=!0))},s._onPointerDown=function(e){this.hadKeyboardEvent=!1},s._onFocus=function(e){this._isValidFocusTarget(e.target)&&(this.isTyping=this._focusTriggersKeyboardModality(e.target),(this.hadKeyboardEvent||this.isTyping)&&this._addFocusVisibleClass(e.target))},s._onBlur=function(e){this._isValidFocusTarget(e.target)&&(this.isTyping=!1,(e.target.classList.contains("focus-visible")||e.target.hasAttribute("data-focus-visible-added"))&&(this.hadFocusVisibleRecently=!0,window.clearTimeout(this.hadFocusVisibleRecentlyTimeout),this.hadFocusVisibleRecentlyTimeout=window.setTimeout(function(){this.hadFocusVisibleRecently=!1}.bind(this),100),this._removeFocusVisibleClass(e.target)))},s._onVisibilityChange=function(e){"hidden"===document.visibilityState&&(this.hadFocusVisibleRecently&&(this.hadKeyboardEvent=!0),n.on(this._.pointerHandlers))},s._onInitialPointerMove=function(e){e.target.nodeName&&"html"===e.target.nodeName.toLowerCase()||(this.hadKeyboardEvent=!1,n.off(this._.pointerHandlers))},i}),define("focus-visible",["focus-visible/focus-visible"],function(e){return e}),define("app/base/bosses/aide",["require","common","app/base/quirks","focus-visible"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("app/base/quirks"),r=e("focus-visible");return s.LIGHT_BRIGHT="bright",s.LIGHT_DARK="dark",s.HUES_NORMAL="normal",s.HUES_INVERT="invert",s.HUES_ROTATE="rotate",s.$init=function(){new r(document),this.queryPrefersDark=window.matchMedia("(prefers-color-scheme: dark)"),this.queryInvertedColors=window.matchMedia("(inverted-colors: inverted)"),this.queryPrefersDark.addListener(this._updateLighting.bind(this)),this.queryInvertedColors.addListener(this._updateLighting.bind(this)),this.queryReduceMotion=window.matchMedia("(prefers-reduced-motion: reduce)"),this.queryReduceMotion.addListener(this._updateMotion.bind(this)),this._listen(),this._updateLighting(),this._updateContentScale(),this._updateMotion()},s.setContentScale=function(e){e!=this.contentScale&&(this.contentScale=e,APP.semaphore.set("aide-content-scale",e),APP.events.dispatch("aide:content-scale",{aide:this,contentScale:e}))},s.setLighting=function(e){this._.userLighting=e,this._updateLighting()},s._listen=function(){APP.events.on("environment:ready",this._onEnvironmentReady.bind(this)),APP.events.on("platform:traits",this._onPlatformTraits.bind(this)),APP.events.on("patron:choice",this._onPatronChoice.bind(this))},s._onEnvironmentReady=function(){this._updateColorVariation(),this._updateTextVariation(),this._updateMotion(),this._updateHaptics(),APP.orient.update({aide:APP.patron.choice("aide:orientation:locking")})},s._onPlatformTraits=function(){this._updateLighting(),this._updateContentScale(),this._updateMotion()},s._updateLighting=function(){var e=t.try(APP.shell,"traits.profile")||{},i=this.LIGHT_BRIGHT;this._.userLighting?i=this._.userLighting:e.darkMode||e.darkTheme?i=this.LIGHT_DARK:this.queryPrefersDark.matches?i=this.LIGHT_DARK:(e.invertColors||this.queryInvertedColors.matches)&&(i=this.LIGHT_DARK);var s=this.HUES_NORMAL,r=e.invertColors||this.queryInvertedColors.matches,o=e.invertColors&&n("color-inversion-is-rotated"),a=e.darkMode||this.queryPrefersDark.matches;i==this.LIGHT_DARK?a||!r?s=this.HUES_INVERT:o&&(s=this.HUES_ROTATE):i==this.LIGHT_BRIGHT&&!a&&r&&(s=this.HUES_INVERT);var l;APP.semaphore.get("aide-lighting")!=i&&(APP.semaphore.set("aide-lighting",i),l=!0),APP.semaphore.get("aide-lighting-hues")!=s&&(APP.semaphore.set("aide-lighting-hues",s),l=!0),l&&APP.events.dispatch("aide:lighting",{lighting:i,hues:s})},s._updateContentScale=function(){var e=t.try(APP.shell,"traits.profile")||{};if("number"==typeof e.fontScale){var i;e.fontScale>=1.3?i=500:e.fontScale>=1.2?i=400:e.fontScale>=1.1?i=300:e.fontScale>=1.05?i=200:e.fontScale<=.9?i=70:e.fontScale<=.95?i=80:e.fontScale<1&&(i=90),this.setContentScale(i)}else this.setContentScale({UICTContentSizeCategoryXS:70,UICTContentSizeCategoryS:80,UICTContentSizeCategoryM:90,UICTContentSizeCategoryXL:200,UICTContentSizeCategoryXXL:300,UICTContentSizeCategoryXXXL:400,UICTContentSizeCategoryAccessibilityM:600,UICTContentSizeCategoryAccessibilityL:700,UICTContentSizeCategoryAccessibilityXL:800,UICTContentSizeCategoryAccessibilityXXL:900,UICTContentSizeCategoryAccessibilityXXXL:1e3}[e.contentSize])},s._updateMotion=function(){var e=t.try(APP.shell,"traits.profile")||{},i=!1;APP.patron&&(i=APP.patron.choice("aide:reduce:motion")),i||"boolean"!=typeof e.reduceMotion||(i=e.reduceMotion),i||(i=this.queryReduceMotion.matches),this.reduceMotion!==i&&(this.reduceMotion=i,this.reduceMotion?APP.semaphore.set("aide-motion","reduce"):APP.semaphore.clear("aide-motion"))},s._updateColorVariation=function(){APP.patron.choice("aide:reduce:color-variation")?APP.semaphore.set("aide-color-variation","reduce"):APP.semaphore.clear("aide-color-variation")},s._updateTextVariation=function(){APP.patron.choice("aide:reduce:text-variation")?APP.semaphore.set("aide-text-variation","reduce"):APP.semaphore.clear("aide-text-variation")},s._updateHaptics=function(){APP.patron.choice("aide:reduce:haptics")?APP.haptics.detach():APP.haptics.attach(APP.shell)},s._onPatronChoice=function(e){"aide:reduce:color-variation"==e.m.key?this._updateColorVariation():"aide:reduce:text-variation"==e.m.key?this._updateTextVariation():"aide:reduce:motion"==e.m.key?this._updateMotion():"aide:reduce:haptics"==e.m.key?this._updateHaptics():"aide:orientation:locking"==e.m.key&&APP.orient.update({aide:e.m.value})},i}),define("app/base/bosses/orient",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.THRESHOLD_WIDTH_PX=500,s.$init=function(){this.update()},s.update=function(e){this.lock=t.absorb(e,this.lock||{});var i=this.lock.aide||this.lock.bifocal;t.among(i,"auto","portrait","landscape")||(i=this._orientationFromScreenDimensions()),this._transmitOrientation(i)},s._transmitOrientation=function(e){e!==this._.lastOrientation&&(this._.lastOrientation=e,APP.shell.transmit({name:"surface:orientation",orientation:e}))},s._orientationFromScreenDimensions=function(){var e=Math.min(screen.width,screen.height);return e<this.THRESHOLD_WIDTH_PX?"portrait":"auto"},i}),define("app/base/bosses/display-area",["require","common","gala","quirkbase"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("gala"),r=e("quirkbase");return s.$init=function(e){this._.shell=e,this._.traitsHandler=n.on("platform:traits",this._onPlatformTraits.bind(this)),this._deweyExtraSetup(),this._.displayAreas=this._defaultDisplayAreas(),this.adjustBumpers()},s.adjustBumpers=function(e){var t=this.computeStyleRules(e);this._updateStylesheet(t.join("\n"))},s.computeStyleRules=function(e){var i=[],s=this._.displayAreas,n=s.screenArea,r=s.safeArea,o=s.prettySafeArea||{},a=s.immersiveArea||{};if(n&&r){e=e||"border-_-width";var l=function(t,i){return e.replace(/_/,t)+":"+i+"px;"};"iOS"==t.try(this._.shell,"info.platform")&&(r.top=Math.max(20,r.top));var c;"number"==typeof r.top&&(c=r.top-(n.top||0),i.push(".bumper-n, .bumper-p-n { "+l("top",c)+" }")),"number"==typeof r.left&&(c=r.left-(n.left||0),i.push(".bumper-w, .bumper-p-w { "+l("left",c)+" }")),"number"==typeof n.bottom&&"number"==typeof r.bottom&&(c=n.bottom-r.bottom,i.push(".bumper-s, .bumper-p-s { "+l("bottom",c)+" }")),"number"==typeof n.right&&"number"==typeof r.right&&(c=n.right-r.right,i.push(".bumper-e, .bumper-p-e { "+l("right",c)+" }")),"number"==typeof o.top&&(c=o.top-(n.top||0),i.push(".bumper-p-n { "+l("top",c)+" }")),"number"==typeof o.left&&(c=o.left-(n.left||0),i.push(".bumper-p-w { "+l("left",c)+" }")),"number"==typeof n.bottom&&"number"==typeof o.bottom&&(c=n.bottom-o.bottom,i.push(".bumper-p-s { "+l("bottom",c)+" }")),"number"==typeof n.right&&"number"==typeof o.right&&(c=n.right-o.right,i.push(".bumper-p-e { "+l("right",c)+" }")),this._.immersed&&("number"==typeof a.top&&(c=a.top-(n.top||0),i.push(".bumper-i-n { "+l("top",c)+" }")),"number"==typeof a.left&&(c=a.left-(n.left||0),i.push(".bumper-i-w { "+l("left",c)+" }")),"number"==typeof n.bottom&&"number"==typeof a.bottom&&(c=n.bottom-a.bottom,i.push(".bumper-i-s { "+l("bottom",c)+" }")),"number"==typeof n.right&&"number"==typeof a.right&&(c=n.right-a.right,i.push(".bumper-i-e { "+l("right",c)+" }")))}return i},s._updateStylesheet=function(e){if(this._.rules!=e){this._.rules=e;var t=document.querySelector("style#SPARK-display-area");if(t&&t.styleSheet)t.styleSheet.cssText=e;else if(t){for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},s._defaultDisplayAreas=function(){var e=t.try(this._.shell,"traits.displayAreas");return t.try(e,"notchArea")&&(e=null),e||"iOS"!=t.try(this._.shell,"info.platform")||(e=this._iOSDefaultAreas()),!e&&r.ask("ios-standalone")&&(e=this._iOSDefaultAreas(),document.documentElement.style.width=e.screenArea.right+"px",document.documentElement.style.height=e.screenArea.bottom+"px"),e||{}},s._iOSDefaultAreas=function(e){var e={screenArea:{},safeArea:{}},t=window.innerWidth>window.innerHeight;e.screenArea.top=0,e.screenArea.left=0,t?(e.screenArea.right=screen.height,e.screenArea.bottom=screen.width):(e.screenArea.right=screen.width,e.screenArea.bottom=screen.height,e.safeArea.top=20);var i=375==screen.width&&812==screen.height||414==screen.width&&896==screen.height;return i&&t?(e.safeArea.left=44,e.safeArea.right=e.screenArea.right-44,e.safeArea.bottom=e.screenArea.bottom-21):i&&(e.safeArea.top=44,e.safeArea.bottom=e.screenArea.bottom-34,e.prettySafeArea={},e.prettySafeArea.top=30,e.prettySafeArea.bottom=e.screenArea.bottom-21),e},s._onPlatformTraits=function(e){var i=t.try(e,"m.traits.displayAreas");i&&!i.notchArea&&(n.off(this._.resizeHandler),this._.displayAreas=i,this.adjustBumpers(),APP.orient.update())},s._onResize=function(e){this._.displayAreas=this._defaultDisplayAreas(),this.adjustBumpers(),APP.orient.update()},s._deweyExtraSetup=function(){this._.resizeHandler=n.on(window,"resize",this._onResize.bind(this))},i}),define("shibui/src/halos",["require","common","./view","gala","./colorizer"],function(e){var t=e("common"),i=e("./view"),s=i.new(),n=s.prototype,r=e("gala"),o=e("./colorizer");return n.$init=function(){return this._.groups=[],this._.colorizer=new o,this._observeMutations(),i.prototype.$init.apply(this,arguments)},n.refresh=function(e){this._defer("refresh");var i=this._findAngelInScope(),s=t.try(this._.pointer,"angel");t.each(this._.groups,function(e){t.each(e.wires,function(e){e.angel&&e.angel!=i&&(e.angel==s&&t.isInDOM(e.angel,this.scope)||this._setHaloState({blur:!0},e.angel))},this)},this),i&&i==s?this._setHaloState({active:!0},i):i&&this._setHaloState({focus:!0,active:!1},i),this._repositionHalos()},n._layout=function(e){this._build("shibui-halos",{extending:e,access:"visual"})},n._listen=function(e,t){this.enableEvents(),this._handle("view:impart",this),this._handle("view:extract",this)},n._onViewImpartSelf=function(){this.dom.root.parentNode!=this.scope&&(r.off(this.handlers._onFocusInDocument),r.off(this.handlers._onFocusOutDocument),r.off(this.handlers._onContact),r.off(this.handlers._onKeyDown),r.off(this.handlers._onResizeWindow),r.off(this.handlers._onManualRefresh),this.scope=this.dom.root.parentNode,this.scope&&(this._classify(this.scope,"halos-attached"),this.handlers._onFocusInDocument=r.on(document,"focusin",this._onFocusInDocument.bind(this),{capture:!0}),this.handlers._onFocusOutDocument=r.on(document,"focusout",this._onFocusOutDocument.bind(this),{capture:!0}),this.handlers._onContact=r.onContact(this.scope,{start:this._onContactStart.bind(this),move:this._onContactMove.bind(this),end:this._onContactEnd.bind(this),cancel:this._onContactEnd.bind(this)}),this.handlers._onKeyDown=r.on(document,"keydown",this._onKeyDownDocument.bind(this),{capture:!0}),this.handlers._onResizeWindow=r.on(window,"resize",this._onResizeWindow.bind(this)),this.handlers._onManualRefresh=r.on("halos:refresh",this.refresh.bind(this,"halos:refresh"))))},n._onViewExtractSelf=function(){this.scope&&(this._declassify(this.scope,"halos-attached"),this.scope=null)},n._onFocusInDocument=function(e){this._.pointer||this._defer("refresh",this.refresh.bind(this,"focusin"))},n._onFocusOutDocument=function(e){this._.pointer||this._defer("refresh",this.refresh.bind(this,"focusout"))},n._onContactStart=function(e){this._.pointer={target:e.target,x:e.clientX,y:e.clientY},this.refresh("contactstart")},n._onContactMove=function(e){if(t.try(this._.pointer,"angel")){this._.pointer.region||(this._.pointer.region=this._.pointer.angel.getBoundingClientRect());var i=this._.pointer.region,s={x:e.clientX,y:e.clientY};return s.x<i.left||s.x>i.right||s.y<i.top||s.y>i.bottom?this._onContactEnd(e):void 0}},n._onContactEnd=function(e){var i=t.excise(this._,"pointer");i&&i.angel&&this.refresh("contactend")},n._onKeyDownDocument=function(e){13==e.keyCode&&t.each(this._.groups,function(e){t.each(e.wires,function(e){this._isFocusVisible(e.angel)&&this._setHaloState({active:!0},e.angel)},this)},this)},n._onResizeWindow=function(e){this._defer("refresh",this.refresh.bind(this,"resize"))},n._observeMutations=function(){"undefined"!=typeof MutationObserver&&(this._.observatory={observer:new MutationObserver(this._onObserveMutation.bind(this)),mutant:null})},n._onObserveMutation=function(e){var i=this._.observatory.mutant;return i?void t.each(e,function(e){if(e.removedNodes)for(var s=0,n=e.removedNodes.length;s<n;++s)e.removedNodes[s]==i&&(this._.observatory.observer.disconnect(),this._.observatory.mutant=null,this.refresh("angel-removed"),t.breakIteration())},this):this._.observatory.observer.disconnect()},n._isFocusVisible=function(e){return t.try(e,"matches()",".focus-visible")},n._findAngelInScope=function(){if(this.scope){var e=this._findActiveAngelInScope()||this._findFocusAngelInScope();if(e&&t.elementClosest(e,".halos-attached")==this.scope)return e}},n._findActiveAngelInScope=function(){if(t.try(this._.pointer,"angel"))return this._.pointer.angel;var e=t.try(this._.pointer,"target");if(e){var i=t.elementClosest(e,".halo, [data-halo-delegate]");return this._.pointer.angel=this._resolveAngelInScope(i)}},n._findFocusAngelInScope=function(){if(this._isFocusVisible(document.activeElement)&&t.isInDOM(document.activeElement,this.scope))return this._resolveAngelInScope(document.activeElement)},n._resolveAngelInScope=function(e){if(e){var t=this._attr(e,"data-halo-delegate");return t?document.getElementById(t):e.classList.contains("halo")?e:void 0}},n._setHaloState=function(e,i){if(i){var s=this._acquireHalo(i);this._declassify(s,"is-blur"),r.off(s._onAnimationEnd),t.each(e,function(e,n){if(!t.among(e,"focus","active","blur"))return console.warn("[HALOS] invalid halo state:",e,n);var o="is-"+e;if(!n)return this._declassify(s,o);var a="blur "+(this._attr(i,"data-halo-states")||"focus active"),l=t.among(e,a.split(/\s+/)),c=l&&s.classList.contains(o);this._classify(s,o,l),"blur"==e&&(s._onAnimationEnd=r.once(s,"animationend",this._renounceHalo.bind(this,i))),"active"==e&&c&&(s.firstChild.style.setProperty("display","none"),s.offsetWidth,s.firstChild.style.removeProperty("display")),"focus"==e&&!c&&this._.observatory&&(this._.observatory.mutant=i,this._.observatory.observer.observe(i.parentNode,{childList:!0}))},this)}},n._acquireHalo=function(e){for(var i=0,s=this._.groups.length;i<s;++i)for(var n=0,r=this._.groups[i].wires.length;n<r;++n){var o=this._.groups[i].wires[n];if(o.angel==e)return o.halo}var a,l,c=t.elementClosest(e,".halos-anchor");c?(t.each(this._.groups,function(e){if(e.anchor==c)return t.breakIteration(l=e)}),l||(a=c.querySelector(":scope > .shibui-halos")||this._element({tag:{OL:"li",UL:"li",TR:"td"}[c.tagName]||"div",parentNode:c,classes:"shibui-halos"}))):(c=this.scope,a=this.dom.root,t.each(this._.groups,function(e){if(e.anchor==c)return t.breakIteration(l=e)})),l||this._.groups.push(l={uuid:t.generateUUID(),anchor:c,cluster:a,wires:[]});var h;return t.each(l.wires,function(e){e.angel||t.breakIteration(h=e)}),h||(h={},h.haloDOM=this._build("shibui-halo",{parentNode:l.cluster}," ripple","  scalar"),h.halo=h.haloDOM.root,l.wires.push(h)),h.angel=e,this._customizeHaloForAngel(e,h.halo),h.halo},n._customizeHaloForAngel=function(e,i){this._declassify(i,"hide");var s=this._attr(e,"data-halo-class");if(!s&&e.classList.contains("shibui-button")&&(s="pill"),!s)return s=e.classList[0]||"",this._classify(i,"halo-for-"+s,!!s);if(this._classify(i,"halo-for-"+s),"pill"==s){var n=window.getComputedStyle(e);this._classify(i,"halo-for-"+s);var r=t.rgbStringToHex(n.backgroundColor||""),o=r?t.hexToRGB(r):null;this._.colorizer.colorize(i,"halo-pill",o)}else this._classify(i,"halo-for-"+s)},n._renounceHalo=function(e){t.each(this._.groups,function(i){t.each(i.wires,function(i){i.angel==e&&(t.excise(i,"angel"),this._attr(i.halo,"class","shibui-halo hide"))},this)},this)},n._repositionHalos=function(){if(this.scope){var e,i,s=[];t.each(this._.groups,function(n){
t.isInDOM(n.cluster)&&(s.push(n),e=i=null,t.each(n.wires,function(s){if(s.angel){e=e||{w:n.anchor.scrollWidth,h:n.anchor.scrollHeight},i=i||n.cluster.getBoundingClientRect();var r=parseFloat(this._attr(s.angel,"data-halo-inset")||"3"),o=s.angel.getBoundingClientRect();e.w=e.w||window.innerWidth,e.h=e.h||window.innerHeight;var a={t:Math.max(r,o.top-i.top-r),l:Math.max(r,o.left-i.left-r),b:Math.min(e.h-r,o.top-i.top+o.height+r),r:Math.min(e.w-r,o.left-i.left+o.width+r)};if(a.w=a.r-a.l,a.h=a.b-a.t,a.w<=0||a.h<=0)return this._renounceHalo.bind(s.angel);this._styleTransform(s.halo,"translate3d("+a.l+"px,"+a.t+"px,0)"),s.halo.style.setProperty("width",Math.round(a.w)+"px"),s.halo.style.setProperty("height",Math.round(a.h)+"px");var l=window.getComputedStyle(s.angel),c=function(e){var i=l["border-"+e+"-radius"];i&&!t.among(i,"0px","1px","2px")||(i="3px");var n="calc("+Math.max(0,r)+"px + "+i+")";s.halo.style.setProperty("border-"+e+"-radius",n)};c("top-left"),c("top-right"),c("bottom-right"),c("bottom-left");var h=s.halo.firstChild,u=Math.max(a.w,a.h);if(h.style.setProperty("width",u+"px"),h.style.setProperty("height",u+"px"),this._.pointer){var p={x:this._.pointer.x-i.left,y:this._.pointer.y-i.top};if(p.x<a.l||p.x>a.r||p.y<a.t||p.y>a.b)this._styleTransform(h);else{var d=p.x-(a.l+a.w/2),m=p.y-(a.t+a.h/2);this._styleTransform(h,"translateX("+d+"px) translateY("+m+"px)")}}}},this))},this),t.each(this._.groups,function(e){t.among(e,s)||t.each(e.wires,function(t){e.cluster.removeChild(t.halo)})},this),this._.groups=s}},s}),define("app/views/core/surface",["require","common","app/views/core/partial"],function(e){var t=(e("common"),e("app/views/core/partial")),i=t.new(),s=i.prototype;return s.DEFAULT_NAME="anonymous",s.$init=function(e,i){this.name=i||this.DEFAULT_NAME,t.prototype.$init.call(this,e)},s.raise=function(){this._.raised||(this._.raised=!0,this.access("normal"),this._classify(this.dom.root,"active show raise"))},s.lower=function(){this._.raised&&(this._.raised=!1,this.access("inert"),this._declassify(this.dom.root,"active raise show"))},s.present=function(e){this.dom.main&&this.dom.main.extract(),this.dom.main=e,this.dom.main.impart(this._prepare().root)},s._layout=function(){this.dom=this._build("surface <section>",{classes:this.name+"-surface",access:"inert"})},i}),define("app/views/core/edge-pulley",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.HOT_EDGE_PX=24,s.$init=function(e,t){this._.edge=e,this._.callbacks=t,this._.touchHandler=APP.events.on(this._.edge,"touchmove",this._onTouchMove.bind(this),!0),this._.slideHandler=new APP.events.onContact(this._.edge,{start:this._onSlideStart.bind(this),move:this._onSlideMove.bind(this),end:this._onSlideEnd.bind(this),cancel:this._onSlideCancel.bind(this)},{capture:!0})},s._onTouchMove=function(e){this._.state&&APP.events.stop(e)},s._onSlideStart=function(e){if(this._invokeCallback("check")!==!1&&!(e.pageX>this.HOT_EDGE_PX)){APP.events.stop(e),this._.vessel=this._invokeCallback("start")||this._.edge;var t=this._.state={};t.startX=e.pageX,t.startY=e.pageY,t.startPosition=this._.vessel.getBoundingClientRect().left,t.slidePosition=t.startPosition}},s._onSlideMove=function(e){if(this._.state){APP.events.stop(e);var t=e.pageX-this._.state.startX,i=e.pageY-this._.state.startY;if(!this._.state.captured){if(Math.abs(i)>Math.abs(t))return this._invokeCallback("cancel"),this._.state=null;t&&this._captureContact()}this._.state.captured&&this._slideToPosition(this._.state.startPosition+t)}},s._onSlideEnd=function(e){this._.state&&(APP.events.stop(e),this._.state.prevPosition>this._.state.startPosition&&this._.state.slidePosition>=this._.state.prevPosition&&this._.state.slidePosition-this._.state.startPosition>this.HOT_EDGE_PX?(this._invokeCallback("complete"),this._releaseContact()):(this._invokeCallback("cancel"),this._releaseContact()))},s._onSlideCancel=function(e){this._.state&&(this._invokeCallback("cancel"),this._releaseContact())},s._captureContact=function(){this._.state.captured||(this._.slideHandler.capture(),this._.state.captured=!0)},s._releaseContact=function(){this._.slideHandler.release(),this._.state=null},s._slideToPosition=function(e){var i=this._.state;i.slidePosition!=e&&(i.prevPosition=i.slidePosition,i.slidePosition=e,t.prefixProperty(this._.vessel.style,"transform","translate3d("+e+"px, 0, 0)"))},s._invokeCallback=function(e){var t=this._.callbacks[e];if(t)return t(this)},i}),define("app/views/core/view-train",["require","common","app/views/core/partial","app/views/core/edge-pulley"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/core/edge-pulley");return n.BASE_ANIM_MS=150,n.$init=function(e){i.prototype.$init.call(this,e),this.segments=[],this._.removers=[],this._.tasks=[],this._.preventAnimationForPlatform=!APP.shell.info.platform&&!APP.shell.has("device:ios-web-app")&&!APP.flags.isOn("animate-train"),this._.preventAnimationUntilReady="ready"!=APP.semaphore.get("client")},n.firstCar=function(e){e.train=this,this._enqueue(function(){this.skippingAnimations(function(){for(;this.segments.length;)this._removeSegment(t.last(this.segments))}.bind(this))}.bind(this)),this.add(e)},n.add=function(e){e.train=this;var i=this._prepare();this._enqueue(function(){var s=this._findSegmentByScreen(e)||{};for(t.excise(this.segments,s),s.car=this._elem(i.cars,"view-train-car"),s.screen=e,s.screen.impart(s.car),this.segments.push(s),this._shunt(s.car),this._animSpeed(1),this._shunt(i.cars,-1);this._.removers.length;)this._.removers[0]()}.bind(this))},n.replace=function(e,t){this.remove(e),this.add(t)},n.restore=function(e){var i=this._findSegmentByScreen(e);i&&i!=t.last(this.segments)&&this._enqueue(this._removeToSegment.bind(this,i))},n.remove=function(e){var t=this._findSegmentByScreen(e);t&&this._enqueue(function(){this._removeToSegment(t),this._removeSegment(t),this._animSpeed(1)}.bind(this))},n.focus=function(){var e=t.last(this.segments);"function"==typeof e.screen.focus&&e.screen.focus()},n.skippingAnimations=function(e){var t=this._.immediate;this._.immediate=!0,e(),this._.immediate=t},n._layoutPartial=function(e){e.box.classList.add("view-train"),e.cars=this._element({parentNode:e.box,classes:"view-train-cars"})},n._listenPartial=function(e){e.edgePulley=new r(e.cars,{check:this._onPulleyCheck.bind(this),start:this._onPulleyStart.bind(this),complete:this._onPulleyComplete.bind(this),cancel:this._onPulleyCancel.bind(this)})},n._enqueue=function(e){this._.tasks.push(e),this._continue()},n._continue=function(){for(;this._.tasks.length;){if(this._.frozen)return;var e=this._.tasks.shift();"function"==typeof e&&e()}},n._findSegmentByScreen=function(e){for(var t=0,i=this.segments.length;t<i;++t){var s=this.segments[t];if(s.screen==e)return s}},n._removeToSegment=function(e){for(var i=[],s=this.segments.length-1;s>=0&&this.segments[s]!=e;--s)i.push(this.segments[s]);i.length&&this._animSpeed(i.length),t.each(i,this._removeSegment.bind(this)),this._activateLastSegment()},n._removeSegment=function(e){delete e.screen.train,t.excise(this.segments,e),this._shunt(this._.parts.cars,-1);var i=function(){clearTimeout(i.timer),this._.removers.indexOf(i)<0||(t.excise(this._.removers,i),"function"==typeof e.screen.extract&&e.screen.extract(),e.car&&e.car.parentNode&&e.car.parentNode.removeChild(e.car),this._continue())}.bind(this);this._.removers.push(i),this._.immediate?i():i.timer=setTimeout(i,500),e.screen&&e.screen.controller&&APP.router._unfillRoute(e.screen.controller)},n._shunt=function(e,i){var s=100*Math.max(0,this.segments.length-1)*(i||1),n=s?"translateX("+s+"%)":null;t.prefixProperty(e.style,"transform",n),this._activateLastSegment()},n._activateLastSegment=function(){this._.activeSegment&&this.access(this._.activeSegment.car,"inert"),this._.activeSegment=t.last(this.segments),this._.activeSegment&&this.access(this._.activeSegment.car,"normal")},n._animSpeed=function(e){this._isAnimated()&&e?(this._.parts.box.classList.remove("is-immediate"),this._setTransitionDuration(Math.log(3.5*e)*this.BASE_ANIM_MS)):(this._.parts.box.classList.add("is-immediate"),this._setTransitionDuration(0))},n._isAnimated=function(){return!!this._.isPulling||!this._.immediate&&(!t.try(APP.aide,"reduceMotion")&&(!this._.preventAnimationForPlatform&&(!this._.preventAnimationUntilReady||(this._.preventAnimationUntilReady="ready"!=APP.semaphore.get("client"),!this._.preventAnimationUntilReady))))},n._onPulleyCheck=function(){return this.segments.length>=2},n._onPulleyStart=function(){this._setTransitionDuration(0),this._defer("pulling",this._setPulling.bind(this,!0))},n._onPulleyComplete=function(){this._setTransitionDuration("default"),APP.nav.back(),this._defer("pulling",this._setPulling.bind(this,!1),300)},n._onPulleyCancel=function(){this._setTransitionDuration("default"),this._shunt(this._.parts.cars,-1),this._defer("pulling",this._setPulling.bind(this,!1),300)},n._setPulling=function(e){this._.isPulling=e},n._setTransitionDuration=function(e){"number"==typeof e&&"default"!=e||(e=this.BASE_ANIM_MS),t.prefixProperty(this._.parts.cars.style,"transition-duration",e+"ms")},s}),define("app/views/core/surface-for-view-train",["require","app/views/core/surface","app/views/core/view-train"],function(e){var t=e("app/views/core/surface"),i=t.new(),s=i.prototype,n=e("app/views/core/view-train");return s._layout=function(e){t.prototype._layout.apply(this,arguments),this.dom.main=new n(this)},i}),define("app/views/about/app-notice-error",["require","common","app/views/core/partial"],function(e){var t=(e("common"),e("app/views/core/partial")),i=t.new(),s=i.prototype;return s.present=function(e){this.err=e,this._textify(this.dom.label,{html:e.title()}),this.access("normal"),APP.arena.dom.notices.refresh(),this._defer("a11y-focus",this._focusElement.bind(this,this.dom.expando),300)},s.dismiss=function(){this._defer("a11y-focus"),this.access("inert"),this._textify(this.dom.label),APP.arena.dom.notices.refresh()},s.expand=function(){this.dismiss(),APP.interviews.dialog("feedback/present-error",{error:this.err}).present()},s._layout=function(e){this.dom=this._build("app-notice-error .app-notice .dismissable",{access:"inert"}," info","  expando",{button:!0},"   label <span>",{labeling:"expando"},"   desc <span> {a11y.app.error.details}",{describing:"expando",access:"spoken"}," dismiss-button",{button:!0,spoken:"a11y.app.error.dismiss"},"  dismiss-icon",{icon:"app-notice-dismiss"})},s._listen=function(e){this._handle("router:navigate")},s._onTapExpando=function(){this.expand()},s._onTapDismissButton=function(){this.dismiss(),APP.arena.resetElementFocus()},s._onRouterNavigate=function(){this.dom.label.innerHTML&&this.dismiss()},i}),define("app/views/about/app-notice-update",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.RELAUNCH_DELAY_MS=3e3,n.present=function(){this.access("normal"),APP.arena.dom.notices.refresh(),this._defer("a11y-focus",this._focusElement.bind(this,this.dom.expando),300)},n.expand=function(){if(!this._.expanded){this._.expanded=!0;var e=APP.interviews.dialog("about/updating",{updateNotice:this}),t=e.present();t.on("shade:invisible",this.shrink.bind(this))}},n.shrink=function(){this._.expanded=!1},n.controlUpdate=function(){return this._.relaunchDelay<=0?this._relaunchApp():this._togglePause(!this._.paused),this._.paused},n._layout=function(e){this.dom=this._build("app-notice-update .app-notice",{access:"inert"}," info","  expando",{button:!0},"   label <span> {app.update.updating}",{labeling:"expando"},"   desc <span> {a11y.app.update.details}",{describing:"expando",access:"spoken"},"  track",{attributes:{role:"progressbar","aria-valuemin":0,"aria-valuemax":1}},"   progress"," control-button",{button:!0,spoken:"a11y.app.update.pause"},"  control-icon",{icon:"app-notice-pause"})},n._listen=function(e){this._handle("app:update:available"),this._handle("app:update:ready")},n._onTapExpando=function(e){this._.expanded?this.shrink():this.expand()},n._onTapControlButton=function(e){this.controlUpdate()},n._onAppUpdateAvailable=function(e){t.try(e.m,"silent")||(this.present(),this._.updateStartedAt=t.epochMilliseconds(),this._.updateReady||this._updateProgress(.5,5e3))},n._onAppUpdateReady=function(e){APP.events.off(this.handlers.onMsgClientViewForeground);var i=t.try(e,"m")||{};i.silent&&i.version==i.current||(this.handlers.onMsgClientViewForeground=APP.events.on("msg:client:view:foreground",this._relaunchApp.bind(this))),i.silent||"inert"!=this._attr("data-access")&&(this._.updateReady||(this._.updateReady=!0,this._togglePause(this._.paused)))},n._updateProgress=function(e,i){var s=this.dom.progress.style;t.prefixProperty(s,"transform","scaleX("+e+")"),"undefined"!=typeof i?t.prefixProperty(s,"transition-duration",i+"ms"):t.prefixProperty(s,"transition-duration"),this.access(this.dom.track,{tabindex:0}),this._attr(this.dom.track,"aria-valuenow",t.smoothFloat(e,2)),this._attr(this.dom.track,"aria-valuetext",this._phrase({label:"a11y.app.update.progress",substitutions:{PROGRESS:Math.round(100*e)}}))},n._updateRelaunchable=function(){this._.relaunchDelay=0,this._.expanded||APP.lectern.bifocal.isRevealed||APP.lectern.bifocal.isPlaying?(this._togglePause(!0),this._.relaunchable=!0,this._textify(this.dom.label,{label:"app.update.ready"}),this._attr(this.dom.controlButton,"aria-label",this._phrase({label:"a11y.app.update.relaunch"})),this.dom.controlButton.removeChild(this.dom.controlIcon),this.dom.controlIcon=this._element({icon:"app-notice-launch",parentNode:this.dom.controlButton}),this._updateProgress(1,0),APP.events.dispatch("app:update:relaunchable")):this._relaunchApp()},n._togglePause=function(e){if(this._.paused=e,this._stopRelaunch(),this._.paused){this._semaphore("updating","paused"),this._textify(this.dom.label,{label:"app.update.paused"}),this._attr(this.dom.controlButton,"aria-label",this._phrase({label:"a11y.app.update.resume"}));var t=this.dom.progress.offsetWidth,i=this.dom.progress.getBoundingClientRect().width,s=i/t;this._updateProgress(s,0),APP.events.dispatch("app:update:pause")}else this._semaphore("updating",null),this._textify(this.dom.label,{label:"app.update.updating"}),this._attr(this.dom.controlButton,"aria-label",this._phrase({label:"a11y.app.update.pause"})),APP.events.dispatch("app:update:resume"),this._.updateReady?this._scheduleRelaunch():APP.events.dispatch("app:update:recover")},n._scheduleRelaunch=function(){if(this._stopRelaunch(),!this._.paused){if(this._.relaunchDelay<=0)return this._relaunchApp();this._.timer=setTimeout(this._updateRelaunchable.bind(this),this._.relaunchDelay),this._updateProgress(1,this._.relaunchDelay)}},n._stopRelaunch=function(){clearTimeout(this._.timer);var e=t.epochMilliseconds()-this._.updateStartedAt;"number"!=typeof this._.relaunchDelay&&(this._.relaunchDelay=Math.max(500,this.RELAUNCH_DELAY_MS-e))},n._relaunchApp=function(){this._.relaunched||(this._.relaunched=!0,APP.relaunch())},s}),define("app/views/about/app-notices",["require","common","app/views/core/partial","./app-notice-error","./app-notice-update"],function(e){var t=(e("common"),e("app/views/core/partial")),i=t.new(),s=i.prototype,n=e("./app-notice-error"),r=e("./app-notice-update");return s.refresh=function(){var e=this.dom.bumper.querySelectorAll('.app-notice[data-access="inert"]');APP.semaphore.set("app-notices",2-e.length)},s._layout=function(e){this.dom=this._build("app-notices",{element:e.root}," bumper .bumper-n .bumper-e .bumper-w","  error",n,"  update",r," silhouette"),this.refresh()},i}),define("app/views/core/elastiguard",["require","common","app/views/core/partial"],function(e){var t=(e("common"),e("app/views/core/partial")),i=t.new(),s=i.prototype;return s.colorize=function(e){APP.coverGuru.paint(this.dom.root,"waypoint-raw",e)},s._layout=function(e){this._build("elastiguard .bumper-n",{extending:e}," skirt")},i}),define("app/views/core/app-footer-now-bar",["require","common","shibui/src/view","app/views/core/reading-now"],function(e){var t=(e("common"),e("shibui/src/view")),i=t.new(),s=i.prototype,n=e("app/views/core/reading-now");return s.become=function(e){return this.dom.readingNow.become(e),this._classify(this.dom.root,"hide",!e)},s.setVisibility=function(e){"scrolled"==e?this.handlers.scroll?APP.events.on(this.handlers.scroll):this.handlers.scroll=APP.events.on("arena:scroll",this._onArenaScroll.bind(this)):(APP.events.off(this.handlers.scroll),this._stylePrefix(this.dom.root,"transition"),this._styleTransform(this.dom.root))},s._layout=function(e){this._build("app-footer-now-bar .hide",{extending:e}," clipper","  border"," field","  reading-now",n)},s._listen=function(e,t){e._onCoverColor=APP.events.on(t.readingNow._prepare().coverBox.dom.root,"color",this._onColorCover.bind(this))},s._onArenaScroll=function(e){var t=e.m.y-(this._.scrollY||0);if(this._.scrollY=e.m.y,!(e.m.y>30&&1===this._.scrollProgress||e.m.y<=0&&0===this._.scrollProgress)){var i=Math.max(0,Math.min(e.m.y/30,1)),s=Math.abs(t)<2?"none":void 0;this._stylePrefix(this.dom.root,"transition",s),this._styleTransform(this.dom.root,"translateY("+100*i+"%)"),this._.scrollProgress=i}},s._onColorCover=function(e){APP.coverGuru.paint(this.dom.root,"cover",e.m.rgb)},i}),define("app/views/popovers/popover-interview",["require","common","app/views/core/partial","app/views/components/interviews/interview-block"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/components/interviews/interview-block");return n.become=function(e,t,i){return this.dom?this.dom.block.become(e,t,i):this._.pending=[e,t,i],this},n.present=function(e){return APP.arena.popover(e).build(this._buildPopover.bind(this))},n._buildPopover=function(e,i){this.dom=e._build("popover-interview",{element:i}," inner","  block",r),this.dom.cameo=this._element({parentNode:i.parentNode,classes:"popover-interview-cameo mascot-neg",access:"visual"});var s=this._element({graphic:"mascot",parentNode:this.dom.cameo,classes:"mascot-icon"});this.dom.block.on("interview-block:yield",function(t){this._defer("reposition",function(){e.reposition()}),this._classify(this.dom.cameo,"is-interview-backable",!!this.dom.root.querySelector(".is-interview-backable"))}.bind(this)),this.dom.block.on("interview-block:characteristics",function(e){var i=t.absorb(e.m.characteristics,{episode:{}});i.episode.mascot?t.DataClass.set(s,"character",i.episode.mascot):t.DataClass.clear(s,"character")}),this._.pending&&this.dom.block.become.apply(this.dom.block,t.excise(this._,"pending"))},s}),define("app/views/core/app-footer-nav-bar",["require","common","shibui/src/view","app/views/popovers/popover-interview"],function(e){var t=e("common"),i=e("shibui/src/view"),s=i.new(),n=s.prototype,r=e("app/views/popovers/popover-interview");return n._layout=function(e){this._swapElement(e.root,{tag:"nav"}),this._build("app-footer-nav-bar",{extending:e}," clipper","  border","  mantle",{icon:"footer-mantle",access:"visual"}," field","  controls",{attributes:{role:"tablist","aria-owns":"footer-nav-search footer-nav-library footer-nav-menu footer-nav-shelf footer-nav-tags"}},"   button-search",{button:!0,id:"footer-nav-search",attributes:{role:"tab","data-halo-states":"focus"}},"    button-search-icon",{icon:"footer-search"},"    <span>.app-footer-nav-label",{label:"footer.nav.search",labeling:"button-search"},"   button-library",{button:!0,id:"footer-nav-library",attributes:{role:"tab","data-halo-states":"focus"}},"    button-library-icon",{icon:"footer-library"},"    <span>.app-footer-nav-label",{label:"footer.nav.library",labeling:"button-library"},"   button-menu",{button:!0,id:"footer-nav-menu",attributes:{role:"tab","data-halo-states":"focus"}},"    icon-menu",{icon:"footer-menu-hamburger"},"    <span>.app-footer-nav-label",{label:"footer.nav.menu",labeling:"button-menu"},"   button-shelf",{button:!0,id:"footer-nav-shelf",attributes:{role:"tab","data-halo-states":"focus"}},"    button-shelf-icon",{icon:"footer-shelf"},"    <span>.app-footer-nav-label",{label:"footer.nav.shelf",labeling:"button-shelf"},"   button-tags",{button:!0,id:"footer-nav-tags",attributes:{role:"tab","data-halo-states":"focus"}},"    button-tags-icon",{icon:"footer-tags"},"    <span>.app-footer-nav-label",{label:"shelf.nav.tags",labeling:"button-tags"},"   anchor-academy",{skip:!this._shouldShowAnchorAcademy(),access:{role:"alert"}},"    anchor-academy-button",{button:!0,spoken:"tutorial-footer-tags.popover.hint"},"     anchor-academy-icon",{icon:"anchor-academy"}),this._toggleLabels(APP.patron.choice("navigation:labels"))},n._listen=function(e){this._handle("patron:choice"),this._handle("router:navigate")},n._onTapButtonSearch=function(){return APP.library?void APP.nav.go("search"):this._promptOnboarding(this.dom.buttonSearch,"footer.nav.search.no-library")},n._onTapButtonLibrary=function(){return APP.library?void APP.nav.go("library"):this._promptOnboarding(this.dom.buttonLibrary,"footer.nav.library.no-library")},n._onTapButtonMenu=function(){APP.nav.go("interview")},n._onTapButtonShelf=function(){APP.nav.go("shelf")},n._onTapButtonTags=function(){APP.nav.go("tags")},n._shouldShowAnchorAcademy=function(){var e="footer:tags:tutorial";return!APP.patron.isDismissed(e)&&(!!t.try(APP,"patron.activities.all.length")||(APP.patron.dismiss(e),!1))},n._onTapAnchorAcademyButton=function(){var e=this.dom.anchorAcademyButton,t=e.parentNode;t&&(t.removeChild(e),this._defer("tutorial",function(){var e="footer:tags:tutorial";APP.bank.get(e)?(APP.bank.set(e),APP.patron.dismiss(e)):APP.bank.set(e,!0),(new r).become("tutorial/footer-tags").present(t)},100))},n._onPatronChoice=function(e){"navigation:labels"==e.m.key&&this._toggleLabels(e.m.value)},n._onRouterNavigate=function(e){var i={interview:"menu"}[e.m.realm]||e.m.realm,s=this.dom.controls.querySelectorAll("button[aria-selected]"),n=this.dom.controls.querySelector("#footer-nav-"+i);t.each(s,function(e){n!=e&&this._attr(e,"aria-selected",null)},this),n&&this._attr(n,"aria-selected","true")},n._promptOnboarding=function(e,t){APP.arena.popover(e).confirm({warningLabel:t,buttonLabel:"menu.library.response.add-library",onSubmit:function(){APP.nav.go("interview/welcome")}})},n._toggleLabels=function(e){e=e&&SPARK.locale.isEnglish,this._classify(document.documentElement,"has-nav-labels",!!e)},s}),define("app/views/popovers/popover-navigation",["require","common","shibui/src/view","app/views/core/reading-now"],function(e){var t=e("common"),i=e("shibui/src/view"),s=i.new(),n=s.prototype,r=e("app/views/core/reading-now");return n.present=function(e){return this.pop=APP.arena.popover(e),this.pop.choices(this._popoverChoices.bind(this)),this.handlers=this.handlers||{},this.handlers._onTitleSwitch=APP.events.on("title:switch",this._onTitleSwitch.bind(this)),APP.events.once("popover:close",function(){APP.events.off(this.handlers._onTitleSwitch)}.bind(this)),this.pop.choices(this._popoverChoices.bind(this)),this.pop},n._popoverChoices=function(e,i){if(document.querySelector('.app-footer[data-access="inert"]'))return this._element({tag:"p",parentNode:i,classes:"popover-explanation",label:"popover.navigation.unavailable",wrapper:!1});APP.title&&"shelf"!=APP.patron.choice("navigation:reading-now")&&(this.readingNow=new r(i),this.readingNow.become(APP.title));var s=["interview","shelf","tags"];APP.library&&(s.unshift("library"),s.unshift("search")),t.each(s,function(t){var i="interview"==t?"menu":t,s=["popover-navigation-"+i];APP.router.realm==t&&s.push("emph");var n=e.choice({link:"/"+t,label:"footer.nav."+i,icon:"footer-"+("menu"==i?"menu-hamburger":t),classes:s.join(" ")});APP.router.realm==t&&this._attr(n,"aria-current","true")},this)},n._onTitleSwitch=function(){this._defer(function(){this.readingNow&&this.pop&&(this.readingNow.become(APP.title),this.pop.reposition())}.bind(this))},s}),define("app/views/core/app-footer-menu-button",["require","common","app/views/core/partial","app/views/popovers/popover-navigation"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/popovers/popover-navigation");return n.LINKS=["search","library","shelf","tags"],n.become=function(e){e&&APP.coverGuru.colorForCover(e,function(e){APP.coverGuru.paint(this.dom.root,"cover",e)}.bind(this))},n._layout=function(e){this._build("app-footer-menu-button .bumper-p-s",{extending:e}," grip","  orb",{button:!0,"data-halo-states":"focus","aria-label":this._phrase("a11y.quick-nav")},"   field","    mascot",{graphic:"mascot"},"    hamburger",{graphic:"footer-menu-hamburger"},"  badge",{access:"visual"},"   badge-count"),this._defer("updateBadge",this._updateBadge.bind(this),3e3)},n._listen=function(e,t){this._handle("notification:update:all"),this._handle("patron:choice"),this.handlers.menuContact=APP.events.onContact(t.orb,{start:this._onMenuContactStart.bind(this),move:this._onMenuContactMove.bind(this),end:this._onMenuContactEnd.bind(this),cancel:this._onMenuContactCancel.bind(this)}),this.handlers.windowResize=APP.events.on(window,"resize",this._onWindowResize.bind(this)),this._defer("compactness",function(){this._initCompactness(APP.patron.choice("navigation:compact"))}.bind(this))},n._onNotificationUpdateAll=function(){this._updateBadge()},n._onTapOrb=function(e){APP.arena.dom.footer.isCompact()?this._showPopover():this._showMenu()},n._showMenu=function(){APP.nav.go("interview")},n._showPopover=function(){return(new r).present(this.dom.orb)},n._updateBadge=function(e){var t=APP.notifier.notifications.collate({titles:!1,dismissedAt:null,sort:"priority"});t.length?(this._textify(this.dom.badgeCount,{number:t.length}),this._attr(this.dom.badge,"data-badge-color",t[0].color()),this._classify(this.dom.orb,"is-notifying")):(this._textify(this.dom.badgeCount),this._attr(this.dom.badge,"data-badge-color",null),this._declassify(this.dom.orb,"is-notifying"))},n._onPatronChoice=function(e){"navigation:compact"==e.m.key&&this._initCompactness(e.m.value)},n._initCompactness=function(e){e=e||"disable",APP.events["disable"!=e?"on":"off"](this.handlers.menuContact),this._toggleCompactness(!1)},n._toggleCompactness=function(e){"undefined"==typeof e&&(e=!APP.arena.dom.footer.isCompact()),"enable"==APP.patron.choice("navigation:compact")&&(e=!0),window.innerHeight<=460&&(e=!0),APP.arena.dom.footer.setCompactness(e)},n._toggleGrip=function(e){e=!!e,this._classify(this.dom.root,"is-gripping",e),APP.arena.dom.footer.setCompactness(void 0,e)},n._onMenuContactStart=function(e){"mouse"!=e.pointerType&&(this._.menuContactState={startX:e.pageX,startY:e.pageY,x:e.pageX,y:e.pageY},APP.haptics.prepare())},n._onMenuContactMove=function(e){var t=this._.menuContactState;if(t){t.x=e.pageX,t.y=e.pageY;var i=t.x-t.startX,s=t.y-t.startY;if(!t.axis&&Math.abs(i)-Math.abs(s)>10?(t.axis="X",this._defer("grip"),this._toggleGrip(!0)):!t.axis&&Math.abs(s)-Math.abs(i)>10&&(t.axis="Y",this._toggleGrip(!0)),"X"==t.axis){if(!APP.arena.dom.footer.isCompact())return;if(this._styleTransform(this.dom.grip,"translateX("+i+"px)"),!t.exit&&i<-20?(this._whirligig(!0),t.origin=this._linkInDir(0),t.exit=this._linkInDir(1),APP.nav.go(t.exit)):!t.exit&&i>20?(this._whirligig(!0),t.origin=this._linkInDir(0),t.exit=this._linkInDir(-1),APP.nav.go(t.exit)):t.exit&&i>-20&&i<20&&(APP.nav.go(t.origin),delete t.exit,APP.haptics.select()),t.origin){var n=i>0?Math.max(0,i-20):Math.min(0,i+20),r=Math.max(-90,Math.min(90,.5*n));t.cubeDest=r>0?90:r<0?-90:0,this._styleTransform(APP.arena.dom.cube,"translateZ(-50vw) rotateY("+r+"deg)")}}else"Y"==t.axis&&(this._styleTransform(this.dom.grip,"translateY("+s+"px)"),s>25||s<-50?t.exit||(t.exit="toggle-compact",this._toggleCompactness(),APP.haptics.select()):t.exit&&(delete t.exit,this._toggleCompactness(),APP.haptics.select()))}},n._onMenuContactEnd=function(e){if(this._.menuContactState){if("number"==typeof this._.menuContactState.cubeDest){var t=this._.menuContactState.cubeDest;this._stylePrefix(APP.arena.dom.cube,"transition","transform 300ms"),this._styleTransform(APP.arena.dom.cube,"translateZ(-50vw) rotateY("+t+"deg)"),this._defer("whirligig",function(){this._whirligig(!1),t&&APP.haptics.select()}.bind(this),300)}this._.menuContactState.axis&&(this._defer("grip",function(){this._toggleGrip(!1),this._styleTransform(this.dom.grip)}.bind(this),100),APP.events.stop(e)),delete this._.menuContactState}},n._onMenuContactCancel=function(e){this._.menuContactState&&(this._.menuContactState.axis&&this._defer("grip",function(){this._whirligig(!1),this._toggleGrip(!1),this._styleTransform(this.dom.grip)}.bind(this),100),"toggle-compact"==this._.menuContactState.exit&&this._toggleCompactness(),delete this._.menuContactState)},n._onWindowResize=function(e){this._defer("compactness",function(){this._initCompactness(APP.patron.choice("navigation:compact"))}.bind(this),300)},n._linkInDir=function(e){var t=Math.max(0,this.LINKS.indexOf(APP.router.realm));return this.LINKS[(this.LINKS.length+(t+e))%this.LINKS.length]},n._whirligig=function(e){var i=Math.max(0,this.LINKS.indexOf(APP.router.realm)),s=["f","r","b","l"];t.each(s,function(s,n){var r=this.LINKS[(i+n)%this.LINKS.length],o=APP.arena.surfaces[r].dom.root;e?t.DataClass.set(o,"side",s):t.DataClass.clear(o,"side")},this),this._classify(APP.arena.dom.root,"is-cubed",!!e),this._styleTransform(APP.arena.dom.cube),this._stylePrefix(APP.arena.dom.cube,"transition")},s}),define("app/views/core/app-footer-tutorial",["require","common","shibui/src/view"],function(e){var t=e("common"),i=e("shibui/src/view"),s=i.new(),n=s.prototype;return n._layout=function(){this.dom=this._build("app-footer-tutorial"," labels","  label-left {footer.nav.menu}","  label-right {footer.nav.menu}"," instruction {footer.tutorial.used.instruction.1}"," next-button .shibui-button {mascot.next}",{button:!0})},n._onTapNextButton=function(e){APP.haptics.select(),this._.phase=(this._.phase||1)+1,this._semaphore("phase",this._.phase),2==this._.phase?this._phase2():3==this._.phase?this._phase3():this._dismiss()},n._phase2=function(){this._textify(this.dom.instruction,"footer.tutorial.used.instruction.2"),this._relabel(this.dom.labelLeft,{label:"footer.nav.library",morph:!0}),this._relabel(this.dom.labelRight,{label:"footer.nav.shelf",morph:!0})},n._phase3=function(){this._textify(this.dom.instruction,"footer.tutorial.used.instruction.3"),this._textify(this.dom.labelLeft,{label:"footer.nav.search",morph:!0}),this._textify(this.dom.labelRight,{label:"footer.nav.tags",morph:!0}),this._textify(this.dom.nextButton,{label:"mascot.done"})},n._relabel=function(e,i){var s=t.excise(i,"offset");this._textify(e,t.absorb({morph:!0},i)),this._styleTransform(e,"translateX("+s+"px)")},n._dismiss=function(){this._classify(this.dom.root,"is-dismissed"),this._defer(this.extract.bind(this),300)},s}),define("app/views/core/app-footer",["require","common","shibui/src/view","./app-footer-now-bar","./app-footer-nav-bar","./app-footer-menu-button","./app-footer-tutorial"],function(e){var t=(e("common"),e("shibui/src/view")),i=t.new(),s=i.prototype,n=e("./app-footer-now-bar"),r=e("./app-footer-nav-bar"),o=e("./app-footer-menu-button"),a=e("./app-footer-tutorial");return s.setSurface=function(e){this._semaphore("surface",e)},s.raise=function(e){return"string"==typeof e&&this.setSurface(e),"raise"!=APP.semaphore.get("footer")&&(APP.semaphore.set("footer","raise"),this._updateFooterCountSemaphore(),this.access("normal"),!0)},s.lower=function(){return this.dom.root.classList.contains("is-tutoring")||this.access("inert"),"lower"!=APP.semaphore.get("footer")&&(APP.semaphore.set("footer","lower"),this._updateFooterCountSemaphore(),!0)},s.isCompact=function(){return this.dom.root.classList.contains("is-compact")},s.setCompactness=function(e,t){"undefined"!=typeof e&&(this._classify(this.dom.root,"is-compact",!!e),this.access(this.dom.bars,e?"inert":"normal"),this.access(this.dom.menuButton.dom.root,e?"normal":"visual")),"undefined"!=typeof t&&this._classify(this.dom.root,"is-compact-gripping",!!t);
},s._layout=function(e){var t=this._shouldShowTutorial();this._build("app-footer .bumper-e .bumper-w",{extending:e}," drawbridge","  bars",{classes:"pillar"},"   now-bar",n,"   nav-bar",r,"  tutorial",{construct:a,skip:!t},"  bumper .bumper-p-s"," .pillar","  menu-button",o),this._classify(e.root,"is-tutoring",t)},s._listen=function(e,t){this._handle("title:switch"),this._handle("patron:choice"),t.tutorial&&this._handle("view:extract",t.tutorial),this._updateNowVisibility(APP.patron.choice("navigation:reading-now"))},s._shouldShowTutorial=function(){return!1},s._onTitleSwitch=function(e){this._prepare(),this._classify(this.dom.root,"has-title",!!e.m.title),this.dom.nowBar.become(e.m.title),this.dom.menuButton.become(e.m.title),this._updateFooterCountSemaphore()},s._onPatronChoice=function(e){"navigation:reading-now"==e.m.key&&this._updateNowVisibility(e.m.value)},s._onViewExtractTutorial=function(){this._declassify(this.dom.root,"is-tutoring"),APP.patron.dismiss("footer:tutorial")},s._updateNowVisibility=function(e){e=e||"always",this._semaphore("now-vis",e),this.dom.nowBar.setVisibility(e),this._updateFooterCountSemaphore()},s._updateFooterCountSemaphore=function(){"raise"!=APP.semaphore.get("footer")?APP.semaphore.set("footer-count",0):"shelf"!=this._semaphore("now-vis")&&this.dom.root.classList.contains("has-title")?APP.semaphore.set("footer-count",2):APP.semaphore.set("footer-count",1)},i}),define("app/views/components/layout/curtain",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.vanish=function(){return t.try(this.dom,"root.parentNode")?void this.extract():APP.journal.warn("[CURTAIN] ignoring vanish — not yet imparted")},n._layout=function(e){this._build("curtain",{extending:e}," pillar .pillar .bumper-n .bumper-s .bumper-e .bumper-w","  close-button",{button:!0},"   close-graphic",{graphic:"nav-close"},"  appendix"),this._defer(this._classify.bind(this,e.closeButton,"is-showing"),300)},n._onTapCloseButton=function(){this.vanish()},s}),define("shibui/src/components/shield",["require","common","../view","gala"],function(e){var t=e("common"),i=e("../view"),s=i.new(),n=s.prototype,r=e("gala");return n.down=function(){delete this._.deflection,this.disabled=!0,this.access("inert")},n.up=function(){this.disabled=!1,this.access("normal")},n.label=function(e){e=t.try(e,"spoken")||e,this._textify(this._prepare().root,{spoken:e})},n.fit=function(e){if(this.dom.root.style.removeProperty("top"),this.dom.root.style.removeProperty("height"),!this.disabled&&e){var i=this.dom.root.getBoundingClientRect(),s=e.north,n=e.south,r=t.try(e,"options.bearing");"n"==r?s=e.dom.blind:"s"==r&&(n=e.dom.blind);var o=0,a=0;s&&(o=s.getBoundingClientRect().bottom-i.top),n&&(a=n.getBoundingClientRect().top-i.top-(o||0)),o&&o>0&&this.dom.root.style.setProperty("top",o+"px"),a&&a>0&&this.dom.root.style.setProperty("height",a+"px")}},n._layout=function(e){this._swapInteractiveElement(e.root,{button:this._onTap.bind(this)}),this._attr(e.root,"data-halo-class","shield"),this._attr(e.root,"data-halo-inset","-1"),this._build("shibui-shield .halo",{extending:e}," grip"),r.setTouchAction(this.dom.grip,"pan-x pan-y")},n._listen=function(e,t){e._onGrip=r.onContact(t.grip,{start:this._onGripStart.bind(this),cancel:this._onGripCancel.bind(this),end:this._onGripEnd.bind(this)})},n._onGripStart=function(e){this._.gripping=!0},n._onGripCancel=function(e){t.excise(this._,"gripping")},n._onGripEnd=function(e){e.preventDefault(),t.excise(this._,"gripping")&&this._defer("deflect",this._deflect.bind(this),300)},n._deflect=function(){this._defer("deflect"),this._dispatch("shield:deflect",{shield:this})},n._onTap=function(e){return this.disabled?console.warn("[SHIELD] tap disabled"):(e.preventDefault(),void this._deflect())},s}),define("shibui/src/components/focal-point",["require","common","../view"],function(e){var t=e("common"),i=e("../view"),s=i.new(),n=s.prototype;return n.say=function(e,i){i=t.absorb(i,{}),e=this._phrase(e);var s=this._prepare();return e!=s.speech.innerHTML&&(APP.journal.info("🎤",e),this._textify(s.speech,{html:e}),!0)},n.focus=function(e){return e=t.absorb(e,{preventScroll:!0}),this._focusElement(this.dom.speech,e)},n._layout=function(e){this._build("shibui-focal-point",{extending:e,access:{role:"region"}}," speech",{access:{role:"text",tabindex:-1,"aria-live":"assertive"}})},s}),define("shibui/src/components/shade",["require","common","../view","gala","quirkbase","./shield","./chevron","./focal-point","../scroll-animator"],function(e){var t=e("common"),i=e("../view"),s=i.new(),n=s.prototype,r=e("gala"),o=e("quirkbase"),a=e("./shield"),l=e("./chevron"),c=e("./focal-point"),h=e("../scroll-animator");return n.TAP_PX=8,n.DEFAULT_BEARING="s",n.SPRINGS=[.8],n.DEFAULT_THRESHOLD=72,n.DEFAULT_SPEED=72,n.$init=function(e,i){this.options=t.absorb(i,{bearing:this.DEFAULT_BEARING,springs:this.SPRINGS,constrainToContentHeight:"once"}),"string"==typeof this.options.heading&&(this.options.heading={label:this.options.heading}),this.impart(e)},n.bearing=function(e){this.options.bearing=e||this.DEFAULT_BEARING,"n"==this.options.bearing?(this._declassify(this.dom.root,"shibui-shade-s"),this._classify(this.dom.root,"shibui-shade-n"),this._declassify(this.dom.appendix,"bumper-s"),this._classify(this.dom.content,"bumper-n"),this.dom.blind.appendChild(this.dom.controls)):(this._declassify(this.dom.root,"shibui-shade-n"),this._classify(this.dom.root,"shibui-shade-s"),this._declassify(this.dom.content,"bumper-n"),this._classify(this.dom.appendix,"bumper-s"),this.dom.blind.insertBefore(this.dom.controls,this.dom.content)),this._resetY(),this._handleGrip()},n.grow=function(e){this._reveal();var t=this._computeBoundary(),i=this._higherSpringPoint(t.start,t);this.springToPoint(i,t,e),this._focusOnFocalPoint()},n.shrink=function(e){this._reveal();var t=this._computeBoundary(),i=this._lowerSpringPoint(t.start,t);this.springToPoint(i,t,e)},n.maximize=function(e){this._reveal();var t=this._computeBoundary();this.springToPoint(t.constraint,t,e)},n.minimize=function(e){this.springToPoint(0,void 0,e)},n.overtake=function(e){if(this.options.bearing==e.options.bearing){var t=e._.yPoint,i=this._computeBoundary();this.springToPoint(t,i,{duration:0}),(t>i.constraint||i.maximize)&&this._defer(this.maximize.bind(this),30),e._conceal({silent:!0}),this._focusOnFocalPoint()}else e.minimize();e._dispatch("shade:overtaken",{overtakingShade:this}),e._dispatch("shade:invisible",{overtakingShade:this})},n.springToPoint=function(e,t,i){if(!this._.isMinimizing){if("number"!=typeof e&&(e=this._yToPoint(e.y,t)),e>0)this._reveal();else{if(!this._.isVisible)return;this._.isMinimizing=!0,this.handlers.grip.deafen(),this.access("inert"),this._dispatch("shade:invisible"),r.dispatch("shade:invisible",{shade:this})}t=t||this._computeBoundary(),t.end=this._pointToY(e,t),t.start!=t.end&&(this._commenceResizing(t.start,{spring:i||{}}),this._conductResizing(t.end),this._announceResize("resizing",t))}},n.scrollTo=function(e,t){this._.scrollAnimator.scrollTo(e,t),this._setScrolled(e>0)},n.deflect=function(){return!this._.resizing&&(this.minimize(),!0)},n._layout=function(e){this._build("shibui-shade",{extending:e,classes:this.options.classes}," fog","  fog-gloom"," shield",{construct:a,skip:this.options.shield===!1}," blind","  controls .halos-anchor","   splitter",{button:!0,access:"visual"},"    splitter-chevron",l,"  content","   banner .halos-anchor","    heading <h1>",{skip:!this.options.heading},"     scroll-to-top",t.absorb(this.options.heading,{button:!0,access:"visual"}),"     <div>",t.absorb(this.options.heading,{access:"spoken"}),"   ruler <hr>",{access:"visual"},"   scroller .halos-anchor","    focal-point",c,"    appendix"," exit-controls","  dismiss-button",{button:!0,html:"&times;",spoken:"a11y.shade.minimize"}),e.shield&&e.shield.label("a11y.shade.minimize"),e.splitterChevron.bearing(this.options.bearing).sharpness(0),this._.scrollAnimator=new h(e.scroller),this._layoutViews(e)},n._layoutViews=function(e){},n._listen=function(e,t){this._handle("transitionend",t.blind),this._handle("scroll",t.scroller),this._handle("touchmove",t.scroller),this._handle("shade:remeasure"),this._handle("msg:ui:scroll-to-top"),e.resize=r.on(window,"resize",this._onWindowResize.bind(this)),t.shield&&this._handle("shield:deflect",t.shield),this._listenViews(e)},n._listenViews=function(e){},n._reveal=function(){this.dom.root.parentNode||this.impart(),this._.isVisible||(this._.isVisible=!0,t.excise(this._,"isMinimizing")&&this.access("normal"),this.bearing(this.options.bearing),this._dispatch("shade:visible"),r.dispatch("shade:visible",{shade:this}))},n._conceal=function(e){this._completeResizing(),delete this._.y,this._.isVisible=!1,e&&e.silent||(this._dispatch("shade:invisible"),r.dispatch("shade:invisible",{shade:this})),this.extract()},n._onTransitionendBlind=function(e){(e===!0||!e.pseudoElement&&e.target==this.dom.blind)&&(this._.grip||(this._defer("spring-transition"),this._checkResizing("resting")))},n._onShadeRemeasure=function(){this._measureInnerScrolling()},n._onMsgUiScrollToTop=function(e){this.scrollTo(0)},n._onWindowResize=function(e){this._defer("resize",function(){this.springToPoint(this._.yPoint||t.last(this.options.springs))}.bind(this),150)},n._onShieldDeflectShield=function(e){this.deflect()},n._onTapDismissButton=function(e){this.deflect()},n._onTapSplitter=function(e){"function"==typeof this._.splitterAction&&(r.stop(e),this._.splitterAction())},n._onTapScrollToTop=function(e){this.scrollTo(0)},n._onScrollScroller=function(e){this._.resizing||this._setScrolled(this.dom.scroller.scrollTop>0)},n._onTouchmoveScroller=function(e){if(this._.grip&&this._.grip.captured)return r.stop(e)},n._handleGrip=function(){this.handlers.grip&&this.handlers.grip.deafen();var e=this.dom.blind;return("n"==this.options.bearing||o("forgets-how-to-scroll"))&&(e=this.dom.controls),this.handlers.grip=r.onContact(e,{start:this._onGripStart.bind(this),move:this._onGripMove.bind(this),end:this._onGripEnd.bind(this),cancel:this._onGripCancel.bind(this)})},n._onGripStart=function(e){if(!this._isElementGrippy(e.target)){if(t.try(this._.resizing,"innerScrolling"))return r.stop(e),this._completeResizing();this._.resizing&&this._defer("spring-transition"),this._.grip={x:e.pageX,y:e.pageY,withins:{target:e.target}}}},n._onGripMove=function(e){if(this._.grip){if(!this._.grip.captured){var i=!1;if("n"==this.options.bearing){if(this._isResizingWithin(this.dom.content))return this._.grip=void 0}else if(this._isResizingWithin(this.dom.scroller)){var s=this.dom.scroller;if(this._.isMaximized){var n=t.try(this._.resizing,"initialScrollTop");"undefined"==typeof n&&(n=s.scrollTop);var o=s.scrollHeight-s.clientHeight;if(n>0)return this._.grip=void 0;if(s.scrollTop<=0&&e.pageY>this._.grip.y)i=!0;else if(s.scrollTop>=o&&e.pageY<this._.grip.y)i=!0;else if(Math.abs(e.pageY-this._.grip.y)>this.TAP_PX)return this._.grip=void 0}else if(this._.grip.y-e.pageY>this.TAP_PX)i=!0;else if(0!=s.scrollTop&&e.pageY-this._.grip.y>this.TAP_PX)return this._.grip=void 0}if(!i){var a=Math.abs(this._.grip.x-e.pageX)+Math.abs(this._.grip.y-e.pageY);i=a>this.TAP_PX}i&&(this._captureGrip(),this._commenceResizing(this._.grip.y,{friction:.875,boundaryFrictionBase:{x:0,y:.9},bounceAcceleration:.1,bounceDeceleration:.225,decayThreshold:3}))}this._.grip.captured&&this._.resizing&&(r.stop(e),this._.resizing.velocity.trackNext(e.pageX,e.pageY))}},n._onGripEnd=function(e){this._.grip&&(this._releaseGrip(),this._.resizing&&!this._.resizing.spring&&this._.resizing.velocity.trackLast(e.pageY,e.pageY))},n._onGripCancel=function(e){this._.grip&&(this._releaseGrip(),this._.resizing&&!this._.resizing.spring&&this._checkResizing("resting"))},n._captureGrip=function(){this._.grip&&(this._.grip.captured||(this.handlers.grip.capture(),this.dom.splitterChevron.sharpness(0),this._classify(this.dom.root,"is-gripping"),this._.grip.captured=!0))},n._releaseGrip=function(){this.handlers.grip.release(),this._declassify(this.dom.root,"is-gripping"),delete this._.grip},n._isResizingWithin=function(e){var i=t.try(this._.resizing||this._.grip,"withins");return!!i&&("boolean"==typeof i[e.className]?i[e.className]:i[e.className]=e===i.target||e.contains(i.target))},n._commenceResizing=function(e,i){this._defer("resize"),this._classify(this.dom.root,"is-resizing");var s=t.absorb(this._.resizing,{});return s.boundary=t.excise(i,"boundary")||this._computeBoundary(),s.spring=t.excise(i,"spring")||!1,this._resetY(s.boundary.start,s.boundary.height),s.spring?delete s.withins:(s.withins=t.try(this._.grip,"withins"),s.velocity=new r.Velocity,s.velocity.configure(t.absorb(i,{position:{x:0,y:s.boundary.start},boundary:s.boundary})),s.velocity.onUpdate=this._updateResizing.bind(this,s),s.velocity.trackFirst(0,e)),s.initialScrollTop=this.dom.scroller.scrollTop,this.dom.scroller.style.setProperty("max-height",s.boundary.height+"px"),this.dom.shield&&this.dom.shield.fit(),this._.resizing=s,this._announceResize("resizing",s.boundary),s},n._updateResizing=function(e,i,s,n){if(this._.resizing===e){var r=e.phase=n.phase,o=this._.y||0;if(this._conductResizing(s),this._.resizing===e){var a=t.deltaMilliseconds();if(e.deltaMS&&"decelerating"==r){var l=e.boundary,c=a-e.deltaMS;if(c){if(e.speed=Math.abs(s-e.deltaY)/c,e.speed>1&&this._isBetween(this._.y,o,l.minimize))return this.minimize({curve:"cubic-bezier(0.2,1.35,0.8,1)"});if(e.speed<.02||e.speed<.06&&!this._isBetween(this._.y,l.maximize,l.upperLimit)){r="resting";for(var h=0,u=this.options.springs.length;h<u;++h){var p=this._pointToY(this.options.springs[h]);if(Math.abs(p-this._.y)<6){this._setY(p,l);break}}}}}e.deltaY=s,e.deltaMS=a,this._checkResizing(r)}}},n._conductResizing=function(e){if(this._.resizing){var i=this._.resizing.boundary;if(this._.resizing.spring&&!this._.resizing.spring.conducted){var s=this._.resizing.spring.duration;if("number"!=typeof s){s=this.DEFAULT_SPEED;var n=Math.log(Math.max(1,Math.abs(i.start-e)-s));s+=n*n*n}if(s){var r=this._.resizing.spring.curve||"cubic-bezier(0.3,0.6,0.4,1.05)",o="transform "+s+"ms "+r;this.dom.fog.style.setProperty("transition",o),this.dom.blind.style.setProperty("transition",o),this.dom.content.style.setProperty("transition",o),this._defer("spring-transition",this._onTransitionendBlind.bind(this,!0),s+100)}else this._defer("spring-transition",this._onTransitionendBlind.bind(this,!0),100);this._.resizing.spring.conducted=!0}else!this._.resizing.innerScrolling&&!this._.isMaximized&&"s"==this.options.bearing&&this._isResizingWithin(this.dom.scroller)&&e<i.maximize&&i.contentHeight-(i.height-i.maximize)>60&&(this._startInnerScrolling(),this._announceResize("resizing",t.absorb(i,{end:i.maximize})));if(!this._.resizing.spring&&this._.resizing.innerScrolling){if(e<i.maximize){var a=this._.resizing.initialScrollTop+(i.maximize-e);this.dom.scroller.scrollTop=a,this._setScrolled(this.dom.scroller.scrollTop>0),e=i.maximize}if(this.dom.scroller.scrollTop>=this.dom.scroller.scrollHeight-this.dom.scroller.clientHeight)return this._completeResizing()}this._setY(e,i)}},n._resetY=function(e,t){if(this.dom.content.style.removeProperty("transition"),this.dom.blind.style.removeProperty("transition"),this.dom.fog.style.removeProperty("transition"),"number"==typeof e?this._styleTransform(this.dom.blind,"translate3d(0,"+e+"px, 0)"):this._styleTransform(this.dom.blind),"number"==typeof e&&t){var i="n"==this.options.bearing?-1:1;this._styleTransform(this.dom.fog,"scaleY("+e/t*i+")")}else this._styleTransform(this.dom.fog);"n"!=this.options.bearing?this._styleTransform(this.dom.content):this._.y||(t=t||0,this._styleTransform(this.dom.content,"translate3d(0,"+t+"px,0)"))},n._setY=function(e,i){i=i||t.try(this._.resizing,"boundary")||this._computeBoundary(),this._.y=Math.max(i.upperLimit,Math.min(i.lowerLimit,e)),this._.yPoint=this._yToPoint(this._.y,i),this._.y<=i.upperLimit&&"n"==this.options.bearing?this._declassify(this.dom.root,"is-visible"):this._.y>=i.lowerLimit&&"s"==this.options.bearing?this._declassify(this.dom.root,"is-visible"):this.dom.root.classList.contains("is-visible")||this._classify(this.dom.root,"is-visible"),this._styleTransform(this.dom.blind,"translate3d(0,"+this._.y+"px, 0)");var s="n"==this.options.bearing?-1:1;this._styleTransform(this.dom.fog,"scaleY("+e/i.height*s+")"),"n"==this.options.bearing&&this._styleTransform(this.dom.content,"translate3d(0,"+(0-this._.y)+"px,0)")},n._checkResizing=function(e){if(this._.resizing){var t=this._.resizing.boundary;if("decelerating"==e||"resting"==e)if("n"==this.options.bearing){if(this._.y<=t.minimize)return this._conceal();if("resting"==e&&this._.y<t.minimize+t.threshold)return this.minimize(50)}else{if(this._.y>=t.minimize)return this._conceal();if("resting"==e&&this._.y>t.minimize-t.threshold)return this.minimize(50)}"resting"==e&&this._completeResizing()}},n._completeResizing=function(){if(this._.resizing){var e=this._.resizing.boundary;this._.isMaximized=this._isCloseEnoughTo(e,"maximize");var t="shrink",i=this.options.bearing;this._higherSpringPoint(this._.y,e)-.025>this._.yPoint?(t="grow",i="n"==this.options.bearing?"s":"n"):this._lowerSpringPoint(this._.y,e)&&(i=null),this._.splitterAction=this[t].bind(this),this._textify(this.dom.splitter,{spoken:"a11y.shade."+t}),this.dom.splitterChevron.bearing(i||"n"),this.dom.splitterChevron.sharpness(i?.5:0),this.dom.scroller.style.setProperty("max-height",this._computeScrollMaxHeight()+"px"),this._stopInnerScrolling(),this._setScrolled(this.dom.scroller.scrollTop>0),o("forgets-how-to-scroll")&&r.ScrollManager.jiggle(this.dom.scroller),"once"==this.options.constrainToContentHeight&&(this.options.constrainToContentHeight=!1),this.dom.shield&&this.dom.shield.fit(this),this._declassify(this.dom.root,"is-resizing"),delete this._.resizing,this._defer("resize",this._announceResize.bind(this,"resize"),100)}},n._startInnerScrolling=function(){this._.resizing&&(this._.resizing.innerScrolling=this._.resizing.innerScrolling||{y:0},this._.resizing.innerScrolling.y+=this.dom.scroller.scrollTop,this._measureInnerScrolling())},n._measureInnerScrolling=function(){if(this.dom.scroller.style.setProperty("max-height",this._computeScrollMaxHeight()+"px"),t.try(this._.resizing,"innerScrolling")){var e=this.dom.scroller.getBoundingClientRect(),i=this.dom.scroller.scrollHeight-(this._.resizing.boundary.height-e.top)-this._.resizing.initialScrollTop;this._.resizing.velocity.configure({friction:.935,boundary:{top:this._.resizing.boundary.maximize-i,bottom:this._.resizing.boundary.maximize}})}},n._stopInnerScrolling=function(){t.try(this._.resizing,"innerScrolling")&&delete this._.resizing.innerScrolling},n._computeBoundary=function(){var e={left:0,right:0};e.height=this.dom.blind.offsetHeight||window.innerHeight||window.screen.height,e.threshold=this.options.threshold||this.dom.banner.offsetHeight||this.DEFAULT_THRESHOLD;var i=this.dom.content.getBoundingClientRect(),s=this.dom.scroller.getBoundingClientRect();return e.contentHeight=Math.max(this.dom.scroller.scrollHeight+(i.height-s.height),e.threshold),e.constraint=t.last(this.options.springs),this.options.constrainToContentHeight&&(e.constraint=Math.min(e.constraint,e.contentHeight/e.height)),"n"==this.options.bearing?(e.upperLimit=0-e.height,e.lowerLimit=0,e.top=e.upperLimit,e.bottom=e.upperLimit*(1-e.constraint),e.minimize=e.top,e.maximize=e.bottom):(e.upperLimit=0,e.lowerLimit=e.height,e.bottom=e.lowerLimit,e.top=e.lowerLimit*(1-e.constraint),e.minimize=e.bottom,e.maximize=e.top),e.start="number"==typeof this._.y?this._.y:e.minimize,e},n._computeScrollMaxHeight=function(){if(this.dom.blind.offsetParent){var e,t=this.dom.scroller.getBoundingClientRect(),i=this.dom.blind.offsetParent.getBoundingClientRect();if("n"==this.options.bearing){var s=this.dom.blind.getBoundingClientRect();e=s.bottom-t.top}else e=i.height-(t.top-i.top);return this._.lastComputedScrollMaxHeight=e,e}},n._isElementGrippy=function(e){for(var i;t.isElement(e);){if(t.among(e,this.dom.scroller,this.dom.content))return!!i;i=i||this._attr(e,"touch-action"),e=e.parentNode}return!1},n._isCloseEnoughTo=function(e,t){e=e||this._computeBoundary();var i="number"==typeof this._.y?this._.y:e.start;return Math.abs(i-e[t])<=this.TAP_PX},n._isBetween=function(e,t,i){return e>Math.min(t,i)&&e<Math.max(t,i)},n._yToPoint=function(e,t){return t=t||this._computeBoundary(),Math.abs((t.minimize-e)/t.height)},n._pointToY=function(e,t){return t=t||this._computeBoundary(),t.minimize+(t.maximize-t.minimize)*e/t.constraint},n._lowerSpringPoint=function(e,t){t=t||this._computeBoundary(),"number"!=typeof e&&(e=t.start);for(var i=this._yToPoint(e,t)-.001,s=this.options.springs.length;s>=0;--s){var n=this.options.springs[s];if(n<i)return n}return 0},n._higherSpringPoint=function(e,t){t=t||this._computeBoundary(),"number"!=typeof e&&(e=t.start);for(var i=this._yToPoint(e,t)+.001,s=0;s<this.options.springs.length;++s){var n=this.options.springs[s];if(n>i&&n<=t.constraint)return n}return t.constraint},n._setScrolled=function(e){if(e!=this._.scrolled){this._.scrolled=e,this._classify(this.dom.root,"is-scrolled",e),this.dom.scrollToTop&&(this.dom.scrollToTop.disabled=!e);var i={top:!e};this._dispatch("shade:scroll",i),r.dispatch("shade:scroll",t.absorb(i,{shade:this}))}},n._focusOnFocalPoint=function(){this.dom.focalPoint.say("a11y.announce.shade")&&this.dom.focalPoint.focus({delay:200})},n._announceResize=function(e,i){var s=this._.lastComputedScrollMaxHeight;i=i||this._computeBoundary(),i.scrollMaxHeight=this._computeScrollMaxHeight(),s&&s>0&&s!=i.scrollMaxHeight&&(this.dom.scroller.style.setProperty("max-height",i.scrollMaxHeight+"px"),t.try(this.dom.shield,"fit()",this)),this._dispatch("shade:"+e,i),r.dispatch("shade:"+e,t.absorb(i,{shade:this}))},s}),define("app/views/popovers/popover",["require","common","app/views/core/partial","shibui/src/components/focal-point","shibui/src/components/shield"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("shibui/src/components/focal-point"),o=e("shibui/src/components/shield");return n.$init=function(e){this._.history=[],e&&this.impart(e)},n.build=function(e){var i=t.element();return this._assignContent(i),e(this,i),this._open()},n.notice=function(e){var i=t.element({classes:"popover-scroller"}),s=this._elem(i,"popover-notice");return APP.events.setTouchAction(i,"pan-y"),this._assignContent(i),this._populateFromOptions(s,e),e.backButton&&this.backButton(e.backButton),this._open()},n.confirm=function(e){var i=this._build("popover-danger .popover-danger-container"," warning .popover-scroller"," confirm",{button:function(t){this._closeUnlessChangedBy(e.onSubmit,t),t.defaultPrevented||APP.haptics.select()}.bind(this),visual:e.buttonLabel,classes:"popover-danger-confirm"});return t.each(t.flatten(e.warningLabel),function(e){this._element({tag:"p",parentNode:i.warning,visual:e})},this),APP.events.setTouchAction(i.warning,"pan-y"),this._assignContent(i.root),e.backButton&&this.backButton(e.backButton),this._open()},n.form=function(e){var i=t.element({classes:"popover-form-container"}),s=this._tag("form",i,"popover-form");s.setAttribute("method","GET"),s.setAttribute("action","#"),this._assignContent(i);var n=e(this,s);return"function"!=typeof n&&APP.journal.warn("[POPOVER] no onSubmit callback supplied by form builder"),APP.events.on(s,"submit",function(e){try{this._closeUnlessChangedBy(n,e)}catch(e){}APP.events.stop(e)}.bind(this)),this._open()},n.choices=function(e){var i=t.element({classes:"popover-choices popover-scroller"});return APP.events.setTouchAction(i,"pan-y"),this._assignContent(i),e(this,i),this._open()},n.choice=function(e){e=t.absorb(e,{});var i=e.tag||"a",s=t.element({tag:i,parentNode:this.content,classes:t.excise(e,"classes")}),n=t.excise(e,"link")||t.excise(e,"button");return"a"==i?s.setAttribute("href","string"==typeof n?n:"#"):"string"==typeof n&&(n=APP.nav.go.bind(APP.nav,n)),this._populateFromOptions(s,e),this._classify(s,"halo",!!n),"string"!=typeof n&&APP.events.onTap(s,function(e){"function"==typeof n&&(this._closeUnlessChangedBy(n,e),e.defaultPrevented||APP.haptics.select()),APP.events.stop(e)}.bind(this)),s.classList.contains("innate")&&this._attr(s,"aria-current","true"),s},n.spinner=function(e){var t=this._element({classes:"popover-spin-box"});this._symbol("spinner-12",t,{classes:"spinner"});return this._assignContent(t),this._.history.pop(),"function"==typeof e&&e(this),this._open()},n.backButton=function(e){if(!(this._.history.length<2)){e=t.absorb(e,{});var i=this._element({button:this.back.bind(this),parentNode:this.content,classes:"popover-back-button",pos:"prepend"}),s=this._element({parentNode:i});e.html||e.label||(e.label="popover.back",this._classify(s,"popover-back-label-left")),this._populateFromOptions(s,e),this._element({parentNode:s,icon:"chevron-left",classes:"popover-back-icon",pos:"prepend"});var n=this._element({id:!0,tag:"span",parentNode:s,access:"spoken",label:"a11y.popover.back",wrapper:!1});return this._attr(i,"aria-label",this._phrase(e)),this._attr(i,"aria-describedby",n.id),i}},n.back=function(){if(this._.history.length<2)return!1;var e=(this._.history.pop(),this._.history.pop());return this._assignContent(e),this.reposition(),APP.haptics.select(),APP.events.dispatch("popover:open"),!0},n.reposition=function(e){"undefined"!=typeof e&&(!e||t.isElement(e)?this.anchor=e:APP.journal.warn("[POPOVER] ignoring non-element anchor",e)),this.open&&this._positionBox()},n.close=function(){this.open&&this._close()},n._layout=function(e){this._build("popover",{extending:e}," fixture .arena-vert .bumper-n .bumper-s","  ruler","  bounds","   arrow","    arrow-tip"," focal-point",r," shield",o),e.shield.label("a11y.close-popover"),this._defer(e.shield.down.bind(e.shield))},n._listenPopover=function(){this._.handlers=this._.handlers||{resize:APP.events.on(window,"resize",this._close.bind(this)),scroll:APP.events.on("arena:scroll",this._close.bind(this)),nav:APP.events.on("router:navigate",this._close.bind(this)),error:APP.events.on("error:present",this._close.bind(this)),shield:this.dom.shield.on("shield:deflect",this._onShieldDeflectShield.bind(this))},APP.events.on(this._.handlers)},n._deafenPopover=function(){APP.events.off(this._.handlers)},n._assignContent=function(e){this.content&&this.content.parentNode&&(this.content.parentNode.removeChild(this.content),t.each(this.dom.bounds.children,function(e){t.among(e,this.dom.arrow)||this.dom.bounds.removeChild(e)},this)),this.content=e,this.content.classList.add("popover-content"),this.content.classList.add("halos-anchor"),this.dom.focalPoint.impart(this.content,"prepend"),this.dom.bounds.appendChild(this.content),this._.history.push(this.content)},n._open=function(){if(this.open||(this.open=!0,this._listenPopover(),APP.semaphore.set("scrollfocus","modal"),this.access(APP.arena.dom.pitch,"inert"),APP.arena.activeShade&&this.access(APP.arena.activeShade.dom.root,"inert"),this.access("normal"),APP.haptics.prepare()),this.dom.root.classList.add("popover-prepare"),!this.content||(this._positionBox(),this.open))return this._focusOnFocalPoint(),this._defer("transition",function(){this.dom.shield.up(),this.dom.root.classList.add("popover-animate"),this.dom.root.classList.add("popover-appear")}.bind(this)),this},n._close=function(){this.open=!1,this.anchor=void 0,this._.history.splice(0),delete this._.lastPreferBelow,this._deafenPopover(),APP.keyboardFocus.blur(),APP.semaphore.clear("scrollfocus"),this.access("inert"),APP.arena.activeShade?this.access(APP.arena.activeShade.dom.root,"normal"):this.access(APP.arena.dom.pitch,"normal"),this.dom.shield.down(),APP.events.dispatch("popover:close"),this.dom.root.classList.remove("popover-appear"),this._defer("transition",function(){this.dom.root.classList.remove("popover-animate"),this.dom.root.classList.remove("popover-prepare"),this._unpositionBox()}.bind(this),2e3)},n._closeUnlessChangedBy=function(e,t){if("string"==typeof e&&(e=APP.nav.go.bind(APP.nav,e)),"function"==typeof e){var i=this.content;if(e(t),this.content!=i)return}t&&t.defaultPrevented||this._close()},n._obtainAnchor=function(){for(var e,t=this.anchor;t;){if("function"==typeof t.getBoundingClientRect){if(e=t.getBoundingClientRect(),e&&0!==e.width)break;return void APP.journal.warn("[POPOVER] anchor is invisible",t,e)}t=t.parentNode}return t},n._unpositionBox=function(){this.dom.bounds.style.removeProperty("top"),this.dom.bounds.style.removeProperty("left"),this.dom.bounds.style.removeProperty("right"),this.dom.bounds.style.removeProperty("height"),this.dom.bounds.style.removeProperty("width"),this.dom.bounds.style.removeProperty("transform-origin"),this.dom.arrow.style.removeProperty("left"),this._declassify(this.dom.bounds,"popover-measured"),this._semaphore("popover",null)},n._positionBox=function(){this._unpositionBox();var e=this._measureBox();"number"==typeof e.top&&this.dom.bounds.style.setProperty("top",e.top+"px"),"number"==typeof e.height&&this.dom.bounds.style.setProperty("height",e.height+"px"),"number"==typeof e.left?(e.right=e.widths.total-(e.left+e.widths.inner+1),this.dom.bounds.style.setProperty("left",e.left+"px"),this.dom.bounds.style.setProperty("right",e.right+"px")):this.dom.bounds.style.setProperty("width",e.widths.inner+"px"),this._semaphore("popover",e.popClass),this._colorizeArrow(e.popClass),"number"==typeof e.arrowLeft&&(this.dom.arrow.style.setProperty("left",e.arrowLeft+"px"),this.dom.bounds.style.setProperty("transform-origin",[e.arrowLeft+"px ","above"==e.popClass?e.height+"px":0].join(" ")),this._classify(this.dom.root,"popover-arrow-edge",!!e.arrowEdge)),this._.lastPreferBelow=e.preferBelow,t.each(this.content.querySelectorAll(".popover-scroller"),APP.events.scrollable.bind(APP.events)),e.forceScroller&&(this.content.classList.add("popover-scroller"),APP.events.scrollable(this.content)),this._classify(this.dom.bounds,"popover-measured")},n._measureBox=function(){var e=this.dom.ruler.getBoundingClientRect(),t=this.content.contains(document.activeElement),i=this.dom.bounds.querySelector(".popover-scroller"),s=APP.shell.has("device:soft-keyboard"),n={width:document.documentElement.clientWidth,height:document.documentElement.clientHeight};s&&window.innerWidth==window.screen.width?(n.width=window.innerWidth,n.height=Math.min(n.height,window.screen.height)):s&&window.innerWidth==window.screen.height&&(n.width=window.innerWidth,n.height=Math.min(n.height,window.screen.width));var r={};r.total=n.width,r.inner=this.content.offsetWidth,r.edges=r.total>360?16:10,r.avail=r.total-2*r.edges;var o={};o.total=n.height-e.top,o.inner=this.content.scrollHeight,o.edges=50,o.avail=o.total-2*o.edges,o.fold=o.avail/2;var a={};a.widths=r,a.height=Math.min(o.inner,o.avail),a.popClass="central",a.preferBelow=!1,!i&&o.inner>o.avail?(a.top=o.edges,a.forceScroller=!0):a.top=(o.total-a.height)/2;var l=this._obtainAnchor();if(!l)return APP.journal.debug("[POPOVER] missing anchor => centralizing"),a;var c=l.getBoundingClientRect(),h={top:c.top-e.top,bottom:c.bottom-e.top,left:c.left,right:c.left,width:c.width,height:c.height};o.above=h.top-o.edges,o.below=o.total-h.bottom-o.edges,o.below>325&&(o.below-=o.edges),a.preferBelow=o.inner<o.below||o.below>o.above,this._.lastPreferBelow===!1&&o.inner<o.above&&(a.preferBelow=!1);var u;if(s&&t?h.bottom+o.inner<o.fold?a.preferBelow=!0:o.above>o.fold?u="half":o.inner<o.above?a.preferBelow=!1:u="half":i||o.inner>o.above&&o.inner>o.below&&(u="full"),"full"==u)return a;if("half"==u)return a.forceScroller=!i,a.height=Math.min(o.inner,o.avail/2),a.top=Math.max(o.edges,o.total/2-(a.height+16)),a;a.forceScroller=!1,a.preferBelow?(a.top=h.bottom+10,a.height=Math.min(o.inner,o.below),a.popClass="below"):(a.height=Math.min(o.inner,o.above),a.top=h.top-(a.height+10),a.popClass="above"),a.left=h.left+h.width/2-r.inner/2;var p=a.left-r.edges,d=a.left+r.inner-(r.total-r.edges);return p<0?(a.left-=p,a.arrowOffset=p):d>0&&(a.left-=d,a.arrowOffset=d),a.arrowLeft=r.inner/2+a.arrowOffset,
a.arrowLeft<20?(a.arrowLeft=Math.max(a.arrowLeft,12),a.arrowEdge=!0):a.arrowLeft>r.inner-20&&(a.arrowLeft=Math.min(a.arrowLeft,r.inner-12),a.arrowEdge=!0),a},n._focusOnFocalPoint=function(){this.dom.focalPoint.say("a11y.announce.popover"),this.dom.focalPoint.focus({delay:200})},n._populateFromOptions=function(e,i){i="string"==typeof i?{label:i}:t.absorb(i,{});var s=t.excise(i,"indicator"),n=t.excise(i,"icon"),r=t.excise(i,"html");this._textify(e,i),"string"==typeof r?this._element({tag:"span",parentNode:e,html:r}):"function"==typeof r&&r(e),s?this._populateFromOptions(this._element({tag:"span",parentNode:e,classes:("popover-choice-indicator "+(s.classes||"")).trim()}),s):n&&this._element({icon:n,parentNode:e,classes:("popover-choice-icon "+(i.iconClasses||"")).trim()})},n._colorizeArrow=function(e){this.dom.arrowTip.style.removeProperty("background-color");for(var t=this.content;e&&t;){var i=t.getAttribute("data-popover-arrow-color");if(i)return void("none"!=i&&this.dom.arrowTip.style.setProperty("background-color",i));if(i=getComputedStyle(t).getPropertyValue("background-color"),i&&"transparent"!=i&&!i.match(/rgba.*0\)/))return void this.dom.arrowTip.style.setProperty("background-color",i);t=t["below"==e?"firstElementChild":"lastElementChild"],t&&t.classList.contains("shibui-halos")&&(t=t.previousSibling)}},n._onShieldDeflectShield=function(e){this._close()},s}),define("app/views/popovers/skin-tone-picker",["require","common","app/views/core/partial","shibui/src/components/focal-point"],function(e){var t=e("common"),s=e("app/views/core/partial"),n=s.new(),r=n.prototype,o=e("shibui/src/components/focal-point");return r.appear=function(e){this.open||(APP.semaphore.set("scrollfocus","modal"),this.anchor=e,this.impart(APP.arena.dom.popovers),this._positionPin(),this._setTheTone(),this._defer("appear",function(){this.open=!0,this._classify(this.dom.root,"show"),this.access(APP.arena.dom.pitch,"inert"),this.dom.focalPoint.say("a11y.announce.skin-tone-picker"),this.dom.focalPoint.focus()}.bind(this)))},r.refresh=function(){this._positionPin()},r.close=function(){this.open&&(APP.semaphore.clear("scrollfocus"),this._declassify(this.dom.root,"show"),this._defer("appear",function(){this.open=!1,this.extract(),this.access(APP.arena.dom.pitch,"normal")}.bind(this),500))},r._layout=function(e){for(this._build("skin-tone-picker",{extending:e}," focal-point",o," pin"," shield",{button:!0,spoken:"a11y.skin-tone-picker.close","data-halo-class":"shield"}),i=0;i<4;++i){var t=this._build("skin-tone-picker-option",{element:e.pin}," limb","  elbow","   arm","    hand",{button:this._onTapTone.bind(this,i)},"     face",{id:!0},"      cameo .mascot-icon",{icon:"mascot"});this._attr(t.hand,"data-halo-delegate",t.face.id)}},r._listen=function(e,t){e._onWindowResize=APP.events.on(window,"resize",this._onWindowResize.bind(this)),this._handle("router:navigate")},r._onWindowResize=function(){this._positionPin()},r._onRouterNavigate=function(){this.close()},r._onTapShield=function(){this.close()},r._positionPin=function(){var e=this.anchor.getBoundingClientRect(),i=e.left+e.width/2,s=e.top+e.height/2;this.dom.pin.style.left=i+"px",this.dom.pin.style.top=s+"px";var n=[];s<.333*window.innerHeight?n.push("south"):s>.667*window.innerHeight&&n.push("north"),i<.333*window.innerWidth?n.push("east"):i>.667*window.innerWidth&&n.push("west"),n.length&&t.DataClass.set(this.dom.pin,"winds",n.join("-"))},r._onTapTone=function(e,t){APP.patron.choose("mascot:skin-tone",this._.tones[e]||void 0),APP.haptics.select(),this.close()},r._setTheTone=function(){var e=APP.semaphore.get("skin-tone"),i=0;this._.tones=[],t.each(["","a","b","c","d"],function(s){if(s!=e&&(s||e)){this._.tones.push(s);var n=this.dom.pin.children[i++].querySelector("button"),r=s||"default";t.DataClass.set(n.firstChild,"skin-tone",r),this._textify(n,{spoken:{label:"a11y.skin-tone-picker.option",substitutions:{TONE:r.toUpperCase()}}})}},this)},n}),define("app/views/components/layout/quick-nav",["require","common","shibui/src/view","app/views/popovers/popover-navigation"],function(e){var t=(e("common"),e("shibui/src/view")),i=t.new(),s=i.prototype,n=e("app/views/popovers/popover-navigation");return s.presentNavigationPopover=function(){(new n).present(null)},s._layout=function(e){this._build("quick-nav",{extending:e}," button {a11y.quick-nav}",{button:!0})},s._onTapButton=function(e){this.presentNavigationPopover()},i}),define("app/views/components/layout/cover-zoom",["require","common","shibui/src/view","app/views/components/common/cover-3d"],function(e){var t=e("common"),i=e("shibui/src/view"),s=i.new(),n=s.prototype,r=e("app/views/components/common/cover-3d");return n.attach=function(e,i,s){this.detach(e);var n=function(t){e.handlers.coverZoomMove||(e.handlers.coverZoomNext=APP.events.on(document.body,"touchstart",r),e.handlers.coverZoomMove=APP.events.on(document.body,"touchmove",o),e.handlers.coverZoomEnd=APP.events.on(document.body,"touchend",a))}.bind(this),r=function(e){e.touches.length<2||(APP.semaphore.set("scrollfocus","interaction"),APP.events.stop(e))},o=function(t){t.touches.length<2||(this._.revealingView!=e&&(this._.revealingView=e,this.reveal(i,s)),this.update(t.scale,t.rotation),APP.events.stop(t))}.bind(this),a=function(i){i.touches.length>0||(this._.revealingView==e&&(delete this._.revealingView,this.conceal()),APP.semaphore.clear("scrollfocus"),APP.events.off(t.excise(e.handlers,"coverZoomNext")),APP.events.off(t.excise(e.handlers,"coverZoomMove")),APP.events.off(t.excise(e.handlers,"coverZoomEnd")))}.bind(this);e.handlers.coverZoomStart=APP.events.on(i,"touchstart",n,{passive:!0})},n.detach=function(e){this._.revealingView==e&&this.conceal(),APP.events.off(t.excise(e.handlers,"coverZoomStart")),APP.events.off(t.excise(e.handlers,"coverZoomNext")),APP.events.off(t.excise(e.handlers,"coverZoomMove")),APP.events.off(t.excise(e.handlers,"coverZoomEnd"))},n.reveal=function(e,t){this.dom.cover3d.become(t,e.querySelector("img")),this._declassify(this.dom.root,"hide");var i=e,s=i.getBoundingClientRect(),n=this.dom.cover3d.dom.bounds.getBoundingClientRect(),r=s.left-n.left+(s.width-n.width)/2,o=s.top-n.top+(s.height-n.height)/2,a=s.width/n.width;this._.shrunk="translate3d("+r+"px,"+o+"px,0) scale("+a+")",this._stylePrefix(this.dom.scaler,"transition","none"),this._styleTransform(this.dom.scaler,this._.shrunk),this._defer("scaling",function(){this._classify(this.dom.root,"is-interactive"),this._stylePrefix(this.dom.scaler,"transition");var e=Math.min(3.5,.85*this.dom.root.offsetWidth/n.width,.85*this.dom.root.offsetHeight/n.height);this._styleTransform(this.dom.scaler,"scale("+e+")")}.bind(this))},n.update=function(e,t){var i=t;i>180&&(i-=360),i<-180&&(i+=360),this._styleTransform(this.dom.cover3d.dom.bounds,"translateZ(-300px) rotateY("+i+"deg)")},n.conceal=function(){this._defer("scaling"),this._declassify(this.dom.root,"is-interactive"),this._styleTransform(this.dom.scaler,this._.shrunk),this._styleTransform(this.dom.cover3d.dom.bounds),this._defer(function(){this._styleTransform(this.dom.scaler),this._classify(this.dom.root,"hide")}.bind(this),300)},n._layout=function(e){this._build("cover-zoom .hide",{extending:e}," scaler .bumper-n .bumper-s .bumper-e .bumper-w","  container","   cover-3d",r)},s}),define("app/views/core/arena",["require","common","app/views/core/partial","shibui/src/halos","shibui/src/key-manager","app/views/core/surface","app/views/core/surface-for-view-train","app/views/core/scroller","app/views/about/app-notices","app/views/core/elastiguard","app/views/core/app-footer","app/views/components/layout/curtain","shibui/src/components/shade","app/views/popovers/popover","app/views/popovers/skin-tone-picker","shibui/src/components/focal-point","app/views/components/layout/quick-nav","app/views/components/layout/cover-zoom"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("shibui/src/halos"),o=e("shibui/src/key-manager"),a=e("app/views/core/surface"),l=e("app/views/core/surface-for-view-train"),c=e("app/views/core/scroller"),h=e("app/views/about/app-notices"),u=e("app/views/core/elastiguard"),p=e("app/views/core/app-footer"),d=e("app/views/components/layout/curtain"),m=e("shibui/src/components/shade"),f=e("app/views/popovers/popover"),g=e("app/views/popovers/skin-tone-picker"),b=e("shibui/src/components/focal-point"),v=e("app/views/components/layout/quick-nav"),y=e("app/views/components/layout/cover-zoom");return n.splash=function(e){e?(APP.semaphore.set("splash","animate"),this._defer("splash",function(){APP.semaphore.set("splash","show")},100),this.resetElementFocus()):(APP.semaphore.set("splash","animate"),this._defer("splash",function(){APP.semaphore.set("splash","hide")},1200))},n.raise=function(e,i){this._.activeSurfaceName!=e&&(this._.activeSurfaceName=e,t.each(this.surfaces,function(e,t){e==this._.activeSurfaceName?t.raise():t.lower()},this),APP.events.dispatch("arena:surface",{surface:this._.activeSurfaceName}))},n.surface=function(){return this.surfaces[this._.activeSurfaceName]},n.curtain=function(e){return t.try(this.activeCurtain,"vanish()"),this.activeCurtain=new d(this.dom.curtains),e.impart(this.activeCurtain),this.access(this.dom.pitch,"inert"),this.activeCurtain.access("normal"),this.activeCurtain.on("view:extract",function(e){e.m.view==this.activeCurtain&&(this.access(this.dom.pitch,"normal"),delete this.activeCurtain)}.bind(this)),this.activeCurtain},n.shade=function(e,i){var s=this.activeShade;s||this._saveFocus(),this.activeShade=new m(this.dom.shades,t.absorb(i,{bearing:"s",shield:!0,constrainToContentHeight:!0})),e.impart(this.activeShade);var n=this.activeShade.dom.scroller;return n.scroller=new c(n),s?this.activeShade.overtake(s):this.activeShade.grow(),APP.semaphore.set("scrollfocus","modal"),this.access(this.dom.pitch,"inert"),this.activeShade.access("normal"),this.activeShade.on("shade:invisible",function(e,t){e==this.activeShade&&(delete this.activeShade,this.access(this.dom.pitch,"normal"),APP.semaphore.clear("scrollfocus"),this._restoreFocus())}.bind(this,this.activeShade)),this.activeShade},n.popover=function(e){return APP.haptics.prepare(),this.dom.popover?e&&this.dom.popover.reposition(e):(this.dom.popover=new f(this.dom.popovers),this.dom.popover.reposition(e)),this._saveFocus(),APP.events.once("popover:close",this._restoreFocus.bind(this)),APP.events.dispatch("popover:open"),this.dom.popover},n.pickSkinTone=function(e,t){return this.dom.skinTonePicker||(this.dom.skinTonePicker=new g),this.dom.skinTonePicker.appear(e),this.dom.skinTonePicker},n.resetElementFocus=function(){this._.focalTargets=[];var e={preventScroll:!1};t.try(this.dom,"focalPoint.focus()",e)||this._focusElement(this.dom.root,e)},n.closeTopmostModal=function(){return t.try(this.dom,"skinTonePicker.open")?(this.dom.skinTonePicker.close(),!0):t.try(this.dom,"popover.open")?(this.dom.popover.close(),!0):this.activeShade?(this.activeShade.minimize(),!0):!!this.activeCurtain&&(this.activeCurtain.vanish(),!0)},n._layout=function(){this.dom=this._build("arena"," alerts","  notices",h," pitch .halos-anchor","  accessibility .bumper-n","   focal-point",b,"   quick-nav",v,"  surfaces .arena-vert","   elastiguard",u,"   interview",{construct:a,with:"interview"},"   modal",{construct:a,with:"modal"},"   perspective","    cube","     search",{construct:l,with:"search"},"     library",{construct:l,with:"library"},"     shelf",{construct:l,with:"shelf"},"     tags",{construct:l,with:"tags"},"   open",{construct:a,with:"open"},"  footer",p," overlay","  curtains","  shades","  popovers","  cover-zoom",y," halos",r),this.surfaces={interview:this.dom.interview,modal:this.dom.modal,search:this.dom.search,library:this.dom.library,shelf:this.dom.shelf,tags:this.dom.tags,open:this.dom.open},this._loadSkinTone(),this._loadRibbonEffect(),APP.shell.traits&&this._adjustToPlatformTraits(APP.shell.traits)},n._listen=function(){this._.keyHandler=new o,this._.keyHandler.addBinding("ESC up",this._onKeyEscape.bind(this)),this._.keyHandler.addBinding("shift-? up",this._onKeyQuestionMark.bind(this)),this._handle("nav:back:close"),this._handle("router:navigating"),this._handle("router:navigate"),this._handle("msg:ui:scroll-to-top"),this._handle("patron:choice"),this._handle("platform:traits"),this._handle("aide:content-scale"),APP.events.on(window,"resize",this._onWindowResize.bind(this)),APP.events.on(document.body,"click",this._onClickBody.bind(this)),APP.events.on(document.body,"dragstart",APP.events.stop)},n._onKeyEscape=function(e){e.defaultPrevented||this._defer("key-escape",APP.nav.back.bind(APP.nav),100)},n._onKeyQuestionMark=function(e){e.defaultPrevented||this.dom.quickNav.presentNavigationPopover()},n._onNavBackClose=function(e){e&&e.defaultPrevented||this.closeTopmostModal()&&APP.events.stop(e)},n._onRouterNavigating=function(e){this._saveFocalTargetForActiveScreen(document.activeElement)},n._onRouterNavigate=function(){t.try(this.activeShade,"minimize()"),t.try(this.activeCurtain,"vanish()"),this.activeScreen="function"==typeof APP.router.route.screen?APP.router.route.screen():APP.router.route.screen,this.scroller=t.try(this.activeScreen,"scroller")||t.try(this.activeScreen,"dom.main.dom.scroller");var e=t.try(this.scroller,"element")||this.scroller||this.dom.pitch;e.firstChild&&e.firstChild!=this.dom.accessibility?e.insertBefore(this.dom.accessibility,e.firstChild):e.firstChild||e.appendChild(this.dom.accessibility),this.access(this.dom.accessibility,"normal"),this.dom.focalPoint.impart(),this.dom.quickNav.impart();var i=t.try(APP.router.route,"waypoint");if(i){var s,n=function(){if(s!=i.name){this.dom.focalPoint.say({label:"a11y.announce.waypoint",substitutions:{WAYPOINT:s=i.name}});var e=t.excise(this.activeScreen,"restoreFocalTarget");e?this._focusElement(e,{preventScroll:!0}):this.dom.focalPoint.focus()}}.bind(this);i.onChange(n),n()}this._dispatch("arena:scroller",{scroller:this.scroller}),t.try(this.scroller,"announce()")},n._onMsgUiScrollToTop=function(e){if(this.activeShade&&this.activeShade.minimize(),"open"==this._.activeSurfaceName)APP.shell.transmit({name:"ui:scroll-to-top",dest:"bifocal",possession:e.m});else if(this.scroller){if(APP.semaphore.get("scrollfocus"))return;this.scroller.scrollToTop(),this.resetElementFocus()}},n._onPatronChoice=function(e){"mascot:skin-tone"==e.m.key&&this._loadSkinTone()},n._onAideContentScale=function(e){APP.events.dispatch("arena:layout")},n._onWindowResize=function(e){this._defer("window-resize",function(){APP.events.dispatch("arena:layout")},100)},n._onClickBody=function(e){if(!e.defaultPrevented){for(var i,s=e.target;t.isElement(s)&&!(i=this._attr(s,"href"));)s=s.parentNode;if(this._saveFocalTargetForActiveScreen(s||e.target),i)return i.match(/^#/)?APP.events.stop(e):void(i.match("://")?APP.shell.openURL(i)?APP.events.stop(e):this._attr(s,"target")&&this._attr(s,"target","_blank"):i.match(/^\w+:/)||(APP.events.stop(e),APP.nav.go(i.replace(/^\//,""))))}},n._saveFocus=function(){this._.focalTargets||(this._.focalTargets=[]);var e=document.activeElement;e&&!t.among(e,this._.focalTargets)||(e=null),this._.focalTargets.push(e)},n._restoreFocus=function(){if(this._.focalTargets){var e=this._.focalTargets.pop();return this._focusElement(e,{preventScroll:!0})}},n._saveFocalTargetForActiveScreen=function(e){return!!t.try(this.activeScreen,"dom.root")&&(!this.activeScreen.restoreFocalTarget&&(!!this.activeScreen.dom.root.contains(e)&&(this.activeScreen.restoreFocalTarget=e)))},n._loadSkinTone=function(){var e=APP.patron.choice("mascot:skin-tone");e?APP.semaphore.set("skin-tone",e):APP.semaphore.clear("skin-tone")},n._loadRibbonEffect=function(e){"string"!=typeof e&&"charlie"!=APP.constants.ENV&&(e=APP.constants.ENV),this._.ribbonEffect!=e&&(this._.ribbonEffect=e||null,e?APP.semaphore.set("libby-ribbon",e):APP.semaphore.clear("libby-ribbon"))},n._onPlatformTraits=function(e){this._adjustToPlatformTraits(e.m.traits)},n._adjustToPlatformTraits=function(e){if(e&&e.profile){var t=!!e.profile.fingerprints;this._.fingerprinting=this._.fingerprinting||!1,t!=this._.fingerprinting&&(this._.fingerprinting=t,this._loadRibbonEffect(t?"fingerprints":null),APP.shell.colorize(t?"none":null,"force"))}},s}),define("app/views/components/lectern/bifocal-frame",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.transmit=function(e){if(this.dom.frame){var t={name:APP.shell._bridgeMessageEventType("receive"),dest:"bifocal",detail:e};this.dom.frame.contentWindow.postMessage(JSON.stringify(t),"*")}},n._layout=function(e){this._build("bifocal-frame",{extending:e})},n._doOpen=function(e){e.urlFor("web",{onSuccess:function(e){var i=this._prepare();i.frame?i.frame.setAttribute("src",e):i.frame=t.iframe({parentNode:i.root,src:e,width:"100%",height:"100%",attributes:{tabindex:-1}})}.bind(this),onFailure:function(e){APP.lectern.error({id:"bifocal-failure-acquiring-url:web",cause:e})}})},n._doReload=n._doOpen,n._doReveal=function(){var e=this._prepare();this.transmit({name:"bifocal:iframe:reveal"}),this._classify(e.root,"is-revealed"),this._attr(e.frame,"tabindex",-1),this._defer("focus",function(){e.frame.focus()})},n._doConceal=function(){this._defer("focus"),this.transmit({name:"bifocal:iframe:conceal"}),this._declassify(this.dom.root,"is-revealed")},n._doClear=function(){var e=t.excise(this.dom,"frame");e&&e.parentNode.removeChild(e)},s}),define("app/views/components/lectern/bifocal-proxy",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.transmit=function(e){APP.shell._dispatchMessageObject(t.absorb(e,{dest:"bifocal"}))},s._listenForNetwork=function(){this._.networkHandler?APP.events.on(this._.networkHandler):this._.networkHandler=APP.events.on("network:info",this._onNetworkInfo.bind(this))},s._deafenForNetwork=function(){APP.events.off(this._.networkHandler)},s._onNetworkInfo=function(){this._transmitNetworkInfo()},s._transmitNetworkInfo=function(){this.transmit({name:"network:info",source:"client",reachable:APP.network.reachable})},s._doOpen=function(e,i){i=t.absorb(i,{}),APP.shell.convey("bifocal.tdata",e.tData),e.urlFor("openbook",{withMessage:!i.useCache&&void 0,onSuccess:function(s){var n=t.try(e,"urls.web");n||APP.lectern.error({id:"bifocal-failure-acquiring-url:web"}),t.defer(this,"opening",function(){APP.shell.transmit(t.absorb(i,{name:"bifocal:view:open",url:n,openbookURL:s,format:{audiobook:"audiobook"}[e.title.format]||"book",reload:!1})),this._listenForNetwork()}.bind(this),50)}.bind(this),onFailure:function(e){APP.lectern.error({id:"bifocal-failure-acquiring-url:openbook",cause:e})}})},s._doReload=function(e,i){return this._doOpen(e,t.absorb(i,{reload:!0}))},s._doReveal=function(){APP.shell.transmit({name:"bifocal:view:reveal"}),this._transmitNetworkInfo()},s._doConceal=function(){t.defer(this,"opening"),APP.shell.transmit({name:"bifocal:view:conceal"})},s._doClear=function(){t.defer(this,"opening"),APP.shell.convey("bifocal.tdata"),APP.shell.transmit({name:"bifocal:view:clear"}),this._deafenForNetwork()},i}),define("app/base/bosses/lectern",["require","common","app/base/journal","app/base/multi-step-task","app/views/components/lectern/bifocal-frame","app/views/components/lectern/bifocal-proxy"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("app/base/journal"),r=e("app/base/multi-step-task"),o=e("app/views/components/lectern/bifocal-frame"),a=e("app/views/components/lectern/bifocal-proxy");return s.$init=function(){APP.shell.has("ui:bifocal-webview")?this.bifocal=new a:this.bifocal=new o(APP.arena.surfaces.open.dom.root),this._listen()},s.isOpen=function(e,t){return!(!this.session||this.session.progress)&&((!t||t==this.session.accessMode)&&(!e||e==this.session.title.titleId))},s.openLoan=function(e,i,s){var n=APP.titles.produce({titleId:i}),r=APP.patron.cards.find({cardId:e}),o=t.try(r,"library")||s.library||APP.library;return s=t.absorb({accessMode:"loan",cardId:e,psnKey:[e,i].join("-")},t.absorb(s,{})),this.open(n,o,s)},s.openMagazine=function(e,i,s){var n=APP.titles.produce({titleId:i}),r=APP.libraries.withKey(e);return s=t.absorb({accessMode:"magazine"},t.absorb(s,{})),this.open(n,r,s)},s.openSample=function(e,i,s){var n=APP.titles.produce({titleId:i}),r=APP.libraries.withKey(e);return s=t.absorb({accessMode:"sample"},t.absorb(s,{})),t.excise(s,"psnKey"),t.excise(s,"cardId"),this.open(n,r,s)},s.openShowcase=function(e,i,s){var n=APP.libraries.withKey(e),r=APP.patron.loans.find({"library.websiteId":n.websiteId,"title.titleId":i});if(r)return this.openLoan(r.card.cardId,i,s);var o=APP.titles.produce({titleId:i});return s=t.absorb({accessMode:"showcase"},t.absorb(s,{})),t.excise(s,"psnKey"),t.excise(s,"cardId"),this.open(o,n,s)},s.open=function(e,i,s){var n={accessMode:"sample",title:e,library:i};if(s=t.absorb(s,n),!e)return this._configError(s,{reason:"open() - invalid title",id:"invalid-title"});if(!i)return this._configError(s,{reason:"open() - invalid library",id:"invalid-library"});if(i&&!APP.library&&APP.libraries.now(i),this._optionsMatchActiveSession(s)&&this._continueSession(s))return this.session;this.session?this._endSession(t.excise(this,"session")):delete this._.detachedAfterFailure;var r="ready"==APP.semaphore.get("client")?0:400;return t.defer(this,"session",this._startSession.bind(this,s),r),s},s.revealBifocal=function(e){if("number"==typeof t.try(e,"delay"))t.defer(this,"bif-vis",this.concealBifocal.bind(this),e.delay);else{if(t.defer(this,"bif-vis"),!t.try(this.session,"check()"))return;APP.events.dispatch("bifocal:reveal"),this.bifocal._doReveal(),this.bifocal.isRevealed=!0,this._tintShellChrome(),APP.orient.update({bifocal:this.session.orientation}),"audiobook"!=this.session.title.format&&this._throttleDownloads("pause")}},s.concealBifocal=function(e){if("number"==typeof t.try(e,"delay"))t.defer(this,"bif-vis",this.concealBifocal.bind(this),e.delay);else{if(t.defer(this,"bif-vis"),!t.try(this.session,"check()"))return;APP.events.dispatch("bifocal:conceal"),this.bifocal._doConceal(),this.bifocal.isRevealed=!1,APP.shell.colorize(null,"bifocal"),APP.orient.update({bifocal:null}),this._throttleDownloads("resume")}},s.close=function(){var e=t.excise(this,"session");e&&e.invoke("onClose",[e]),this._clearBifocal(),this._endSession(e)},s.error=function(e){t.try(this.session,"fail()",e)},s._startSession=function(e){var t=this.session=new r(e);this._bindSessionFailure(t,e.onFailure);var i=t.title.titleId+":"+t.uuid.substr(0,6);t.journal=new n({consolePrefix:"[OPEN]["+i+"]"}),t.journal.log("Reticulating splines"),t.journal.log("  titleId",t.title.titleId),t.journal.log("  websiteId",t.library.websiteId),t.progress={stage:"reticulating"},this._preparePassport(t)},s._continueSession=function(e){var t=new r(this.session);return t._.callbacks={},t.extend(e),this._bindSessionFailure(t,e.onFailure),t.progress?"authenticate"==t.progress.stage?(this._verifyAccess(t),this.session=t):void 0:(this._readyBifocal(t),this.session=t)},s._optionsMatchActiveSession=function(e){return!!this.session&&(!("function"==typeof e.check&&!e.check(this.session))&&(e.accessMode==this.session.accessMode&&(e.title.titleId==this.session.title.titleId&&(e.library.websiteId==this.session.library.websiteId&&t.try(e,"cardId")==this.session.cardId))))},s._abortUnlessActiveSession=function(e){return!e.check(this.session)&&(e.journal.warn("Aborted because no longer the active session"),e.abort(),e.progress={reason:"aborted",by:t.try(this.session,"uuid")})},s._preparePassport=function(e){e.journal.log("Preparing passport");var t={title:e.title,library:e.library};e.cardId&&(t.cardId=e.cardId),e.passport=APP.titles.passports.produce(t),e.passport.reattempt();var i=e.passport.isInGoodStanding()?3e3:1e4;"magazine"==e.accessMode&&(i=15e3),e.passport.prepare({journal:e.journal,timeout:i,onSuccess:this._onPassportPrepared.bind(this,e),onFailure:this._onPassportPreparationFailure.bind(this,e)})},s._onPassportPrepared=function(e){var i=t.try(e.passport.tData,"codex.title.cover.color");e.coverColor=t.hexToRGB(i),t.excise(e.passport.tData,"theme"),"showcase"==e.accessMode&&(e.passport.tData.theme="dewey-showcase"),this._verifyAccess(e)},s._onPassportPreparationFailure=function(e,i){if(!this._abortUnlessActiveSession(e)){var s=this._findAnyPassportInGoodStanding();s?this._onPassportPrepared(t.absorb({passport:s},e)):e.fail(i)}},s._findAnyPassportInGoodStanding=function(){for(var e=APP.titles.passports.filter({titleId:this.titleId}),t=0,i=e.length;t<i;++t)if(e[t].isInGoodStanding())return e[t]},s._verifyAccess=function(e,i){if(!this._abortUnlessActiveSession(e)){if(i!=e.accessMode&&(e.firstAccessMode=e.firstAccessMode||e.accessMode,e.accessMode=i||e.accessMode),"loan"==e.accessMode){e.journal.log("Verifying loan access");var s=APP.patron.loans.find({psnKey:e.psnKey});return s&&s.card?s.card.isExpired()&&APP.network.reachable?(e.journal.log("  card is expired, so authenticating"),this._verifyByAuthenticating(e)):this._acquirePassport(e):(e.journal.log("  loan not found, so synchronizing shelf"),e.progress={stage:"synchronize"},e.timeoutToFail(1e4),APP.patron.sync.commence({freshness:0,onSuccess:this._onVerificationSyncSuccess.bind(this,e),onFailure:this._onVerificationSyncFailure.bind(this,e),journeys:!1}))}if("magazine"==e.accessMode){var n;if(e.psnKey&&(n=APP.patron.magazines.find({psnKey:e.psnKey}),t.try(n,"card.cardId"))){var r=APP.patron.cards.find({cardId:n.card.cardId});if(r)return e.cardId=n.card.cardId,e.library=n.card.library,r.isExpired()?this._verifyByAuthenticating(e):this._acquirePassport(e)}var r=APP.patron.cards.find({cardId:e.cardId}),o=t.try(r,"advantageKey")||e.library;return e.title.holding(o).use(function(i,s){s.isAvailable?r&&r.isExpired()?this._verifyByAuthenticating(e):r?this._acquirePassport(e):n?(t.excise(e,"cardId"),t.try(t.excise(e,"passport"),"remove()"),this.error({id:"missing-card-for-magazine",origin:"client"})):this._verifyAccess(e,"sample"):i.isIdeal||i.isBroken?this._verifyAccess(e,"sample"):s.reuse()},this)}return"sample"==e.accessMode?(e.journal.log("Verifying sample access"),e.library.card()?this._acquirePassport(e):e.library.use(function(t,i){if(!this._abortUnlessActiveSession(e))return"failed"==t.work?e.fail({id:"lectern-verify-library-failure"}):"boolean"!=typeof i.allowAnonymousSampling?i.reuse():void(i.allowAnonymousSampling?this._acquirePassport(e):(e.journal.log("  sample requires authentication"),e.accessMode=e.firstAccessMode||"sample",this._verifyByAuthenticating(e)))},this)):void("showcase"==e.accessMode&&(e.journal.log("Verifying showcase access"),this._acquirePassport(e)))}},s._verifyByAuthenticating=function(e){return e.hasCallback("onAuthenticate")?(t.try(t.excise(e,"passport"),"remove()"),e.progress={stage:"authenticate",params:{intent:{sample:"ask:sampling",magazine:"ask:one-tap-magazine"}[e.accessMode]||"verify",library:e.library,card:APP.patron.cards.find({cardId:e.cardId}),callback:this._onVerifyAuthenticated.bind(this,e)}},void e.invoke("onAuthenticate",[e.progress.params])):e.fail({id:"lectern-verify-by-authenticating"})},s._onVerifyAuthenticated=function(e,i){"authenticate"==t.try(e,"progress.stage")&&(e.progress={stage:"authenticated"},"sample"!=e.accessMode&&(e.cardId&&"magazine"!=e.accessMode||(e.cardId=t.try(i,"[0].card.cardId"))),this._preparePassport(e))},s._onVerificationSyncSuccess=function(e){if(!this._abortUnlessActiveSession(e)&&(e.timeoutToFail(1/0),"synchronize"==t.try(e,"progress.stage"))){e.progress={stage:"synchronized"},t.try(e.passport,"attemptFailure()");var i=APP.patron.loans.find({psnKey:e.psnKey});t.try(i,"card.library")&&t.try(e.passport,"_.attemptFailures")<=3?(e.library=i.card.library,this._preparePassport(e)):e.fail({id:"lectern-sync-success-but-no-such-loan"})}},s._onVerificationSyncFailure=function(e){this._abortUnlessActiveSession(e)||(e.timeoutToFail(1/0),"synchronize"==t.try(e,"progress.stage")&&e.fail({id:"lectern-sync-failure-and-no-such-loan"}))},s._acquirePassport=function(e){return e.passport.message()?(e.journal.log("Using pre-acquired passport URLs"),this._onPassportAcquired(e)):(e.journal.log("Acquiring passport URLs"),void e.passport.acquire({journal:e.journal,timeout:e.passport.isInGoodStanding()?2e3:1e4,onSuccess:this._onPassportAcquired.bind(this,e),onFailure:this._onPassportAcquisitionFailure.bind(this,e)}))},s._onPassportAcquired=function(e){this._abortUnlessActiveSession(e)||this._refreshLuggage(e)},s._onPassportAcquisitionFailure=function(e,i){if(!this._abortUnlessActiveSession(e)){if("loan"==e.accessMode){var s=(new Date).setHours(24,0,0,0)-t.epochMilliseconds();APP.titles.passports.gracePeriod+=s}else"magazine"==e.accessMode&&(APP.titles.passports.gracePeriod=1/0);var n,r;try{n=i.response.result}catch(e){}try{r=i.response.upstream.errorCode}catch(e){}if("unauthorized"==n){e.journal.warn("unauthorized - card must be verified");var o=APP.patron.cards.find({cardId:e.cardId});o&&(o.setExpiry(t.epochMilliseconds()),this._verifyAccess(e))}else if(t.among(r,"PatronDoesNotHaveTitleCheckedOut","TitleNotFound")&&"loan"==e.accessMode)t.try(APP.patron.loans.find({psnKey:e.psnKey}),"remove()"),e.journal.warn("unauthorized - loan not found"),e.journal.log("-> "+r),this._verifyAccess(e);else if(e.passport.isInGoodStanding())e.journal.warn("  failed, but passport is in good standing"),this._refreshLuggage(e);else{var a=this._findAnyPassportInGoodStanding();a?(e.journal.warn("  falling back to a passport in good standing"),this._onPassportAcquired(t.absorb({passport:a},e))):e.fail(i)}}},s._refreshLuggage=function(e){if(!e.luggage&&e.psnKey){var i;"loan"==e.accessMode?i=APP.patron.loans.find({psnKey:e.psnKey}):"magazine"==e.accessMode&&(i=APP.patron.magazines.find({psnKey:e.psnKey})),e.luggage=t.try(i,"luggage()")}return e.isStreaming=!e.luggage||e.luggage.status().isStreamed,e.isStreaming||!e.passport.message()?this._launchBifocal(e):(e.journal.log("Checking for reader update"),e.progress={stage:"refreshing-luggage"},e.luggage.refresh({force:!0,cbConsiderUpdate:this._onLuggageDownloadConsider.bind(this,e),cbInitializeUpdate:this._onLuggageDownloadInitialize.bind(this,e),onSuccess:this._afterLuggageRefresh.bind(this,e,"success"),onFailure:this._afterLuggageRefresh.bind(this,e,"failure")}),void t.defer(e,"luggage-timeout",this._afterLuggageRefresh.bind(this,e,"timeout"),3e3))},s._onLuggageDownloadConsider=function(e,i){this._abortUnlessActiveSession(e)||(t.defer(e,"luggage-timeout"),e.hasCallback("onUpdateLuggage")&&"cellular"!=APP.network.connection&&!APP.auditor.isPaused()||(this._afterLuggageRefresh(e,"veto"),i.abort()))},s._onLuggageDownloadInitialize=function(e,i){this._abortUnlessActiveSession(e)||"refreshing-luggage"==t.try(e,"progress.stage")&&(e.journal.log("Reader update in progress..."),e.progress={stage:"updating-luggage"},e.invoke("onUpdateLuggage",[e.luggage]),t.defer(e,"luggage-timeout",this._afterLuggageRefresh.bind(this,e,"timeout"),15e3))},s._afterLuggageRefresh=function(e,i){if(!this._abortUnlessActiveSession(e)){t.defer(e,"luggage-timeout");var s=t.try(e.progress,"stage");if("refreshing-luggage"==s)"success"==i?e.journal.log("No reader update needed"):"veto"==i?e.journal.log("Reader update vetoed by network state"):"timeout"==i?e.journal.log("Non-fatal timeout checking for reader update"):e.journal.log("Non-fatal failure checking for reader update");else{if("updating-luggage"!=s)return;"success"==i?e.journal.log("Reader update succeeded"):"timeout"==i?e.journal.warn("Non-fatal timeout updating reader…"):e.journal.warn("Non-fatal failure updating reader…")}"success"==i&&e.passport.message({markAsUsedAndAccepted:!0}),e.progress={stage:"pre-launch"},this._launchBifocal(e)}},s._launchBifocal=function(e){this._abortUnlessActiveSession(e)||(e.journal.log("Launching reader"),e.journal.log("  from "+(e.isStreaming?"stream":"luggage")),e.progress={stage:"launching"},e.timeoutToFail(3e4),"audiobook"!=e.title.format&&this._throttleDownloads("pause"),this._.debug=this._.debug||{},this._.debug.launchedAt=t.epochMilliseconds(),
this.bifocal._doOpen(e.passport,{useCache:!e.isStreaming}))},s._relaunchBifocal=function(e,t){return e?void(this._abortUnlessActiveSession(e)||(this._clearBifocal(),e.journal.log("Relaunching reader..."),e.progress={stage:"relaunching"},e.timeoutToFail(6e4),this.bifocal._doReload(e.passport,t))):APP.journal.warn("[LECTERN] no session to relaunch")},s._onBifocalReadying=function(e){this.session&&this.session.progress&&this.session.journal.log("Reader is readying…")},s._onBifocalReady=function(e){if(!this.session){if(!t.try(this._.debug,"launchedAt"))return;var i=t.epochMilliseconds();return APP.events.dispatch("investigate:record",{what:"no active session",where:"Lectern#_onBifocalReady",why:"INV-LECT-C",stackTrace:t.try(this._.debug,"trace")||[],stackTraceAgeMS:i-(t.try(this._.debug,"tracedAt")||i),bifLaunchAgeMS:i-(t.try(this._.debug,"launchedAt")||i),appSessionAgeMS:APP.summoner.daemons.engagement._msSince("launchedAt")})}this.session.orientation=t.try(e,"m.orientation"),this._readyBifocal(this.session)},s._readyBifocal=function(e){this._abortUnlessActiveSession(e)||(e.progress=null,e.timeoutToFail(1/0),e.passport.attemptSuccess(),e.journal.log("Reader is ready"),e.invoke("onReady",[e]))},s._onBifocalReload=function(e){this._relaunchBifocal(this.session)},s._onBifocalViewFailure=function(e){if(this.session)return this.session.progress?"launching"==this.session.progress.stage?(this.session.journal.warn("Reader failure DURING launch"),this._relaunchBifocal(this.session)):void this.error(t.absorb(t.try(e,"m.error"),{origin:"Nautilus"})):(this.session.journal.warn("Reader failure AFTER launch"),this.bifocal.isRevealed&&APP.nav.go("/"),this.bifocal.isPlaying&&(this.bifocal.isPlaying=!1,this._.detachedAfterFailure=!0),APP.events.dispatch("bifocal:spool:state",{state:"closed"}),t.try(t.excise(this,"session"),"abort()"))},s._clearBifocal=function(){this.concealBifocal(),this.bifocal._doClear(),this.bifocal.isPlaying&&(this.bifocal.isPlaying=!1,APP.events.dispatch("bifocal:spool:state",{state:"closed"}))},s._listen=function(){APP.events.on("title:open:invalidate",this._onTitleOpenInvalidate.bind(this)),APP.events.on("msg:bifocal:readying",this._onBifocalReadying.bind(this)),APP.events.on("msg:bifocal:ready",this._onBifocalReady.bind(this)),APP.events.on("msg:bifocal:reload",this._onBifocalReload.bind(this)),APP.events.on("msg:bifocal:view:failure",this._onBifocalViewFailure.bind(this)),APP.events.on("msg:bifocal:amreading",this._onBifocalAmReading.bind(this)),APP.events.on("msg:bifocal:amnotreading",this._onBifocalAmNotReading.bind(this)),APP.events.on("msg:bifocal:spool:state",this._onBifocalSpoolState.bind(this)),APP.events.on("msg:title:open:background",this._onTitleOpenBackground.bind(this))},s._onTitleOpenInvalidate=function(e){this.session?e.m.is!=this.session.title.titleId&&this.close():this._.detachedAfterFailure&&APP.shell.transmit("audioproxy:pause")},s._onBifocalAmReading=function(e){this._tintShellChrome("none")},s._onBifocalAmNotReading=function(e){this._tintShellChrome("dark"==e.m.lighting?"#000000":"#FFFFFF")},s._onBifocalSpoolState=function(e){this.bifocal.isPlaying="paused"!=e.m.state,APP.events.dispatch("bifocal:spool:state",e.m)},s._tintShellChrome=function(e){this.session&&(e?this.session.tint=e:this.session.tint||(this.session.tint=t.rgbToHex(this.session.coverColor)),this.bifocal.isRevealed&&APP.shell.colorize(this.session.tint,"bifocal"))},s._throttleDownloads=function(e){if(t.among(e,"pause","resume"))APP.events.dispatch("bifocal:downloads:"+e);else{var i=t.try(this.session,"journal")||APP.journal;i.warn("[LECTERN] throttleDownloads invalid arg:",e)}},s._bindSessionFailure=function(e,t){var i=this._onSessionFailure.bind(this,e,t);return e._.callbacks.onFailure=[i]},s._onSessionFailure=function(e,i,s){s=s||{id:"undefined-error"};var n=t.try(s,"response.result");return"card_reauthentication_required"==n?this._verifyByAuthenticating(e):("Dervish"==s.origin?e.journal.warn("Dervish error:",s.status):"Sentry"==s.origin?(e.journal.warn("Sentry error:",s.id||s.status),e.journal.warn("  ",s.failure)):"Nautilus"==s.origin?e.journal.warn("Shell error:",s):s.id?e.journal.warn("Client error:",s.id):e.journal.warn("Unidentified error",s),e.progress={stage:"failure",error:s},void(e==this.session&&(t.try(e.passport,"attemptFailure()"),this._clearBifocal(),"function"==typeof i&&i(e))))},s._configError=function(e,i){var s=this.session=new r(e);s.journal=new n({consolePrefix:"[OPEN][💀]"}),this._bindSessionFailure(s,e.onFailure),i.retryable=!1,t.try(s,"fail()",i)},s._endSession=function(e){if(t.defer(this,"session"),t.defer(this,"luggage-update"),delete APP.titles.passports.gracePeriod,!this.session)try{this._.debug=t.absorb({trace:APP.investigator.stackTrace(),tracedAt:t.epochMilliseconds()},this._.debug||{})}catch(e){}e&&e.progress&&e.abort()},s._onTitleOpenBackground=function(e){var i=function(e,i){var s=t.absorb(r,{name:"title:open:background:"+e});"string"==typeof i&&(s.reason=i),APP.shell.transmit(s)},s=function(e,t){i.call(this,e,t),this.close()}.bind(this),n=t.absorb(t.try(e,"m.options"),{onReady:i.bind(this,"ready",null),onAuthenticate:s.bind(this,"failure","authenticate"),onFailure:s.bind(this,"failure","unknown")}),r=t.absorb(t.try(e,"m"),{});if(r.loan)r={loan:r.loan};else if(r.sample)r={sample:r.sample};else if(r.magazine)r={magazine:r.magazine};else if(r.path){var o=r.path.match(/open\/([^\/]+)\/([^\/]+)\/?([^\/]+)?/);if(o&&"loan"==o[1]){if(r={loan:{cardId:o[2],titleId:o[3]}},!r.loan.titleId){r.loan.titleId=r.loan.cardId;var a=APP.patron.loans.filter({"title.titleId":r.loan.titleId});a.sort(function(e,t){return t.expireTime-e.expireTime}),r.loan.cardId=t.try(a[0],"card.cardId")}}else o&&"sample"==o[1]?r={sample:{libraryKey:o[2],titleId:o[3]}}:o&&"magazine"==o[1]&&(r={magazine:{libraryKey:o[2],titleId:o[3]}})}APP.journal.debug("[LECTERN] title:open:background",r);var l;r.loan?l=this.openLoan(r.loan.cardId,r.loan.titleId,n):r.sample?l=this.openSample(r.sample.libraryKey,r.sample.titleId,n):r.magazine&&(l=this.openMagazine(r.magazine.libraryKey,r.magazine.titleId,n)),l&&(APP.titles.now(l.title,{websiteId:l.websiteId,cardId:l.cardId}),APP.router.route.path.match(/^open\//)&&APP.nav.go(""))},i}),define("app/views/dialogs/dialog-interview",["require","common","app/views/components/interviews/interview-block","shibui/src/components/spinner","shibui/src/components/chevron"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview-block"),s=i.new(),n=s.prototype,r=e("shibui/src/components/spinner"),o=e("shibui/src/components/chevron");return n.present=function(e){return this.shade=APP.arena.shade(this,t.absorb(e,{classes:"shade-interview",springs:[.8],constrainToContentHeight:!0})),this._dispatch("interview:shade",{owner:this,shade:this.shade}),this.shade},n._layout=function(e){this._build("interview-block .dialog-interview",{extending:e}," appendix"," spinner",r)},n._listen=function(e){this._handle("view:impart",this)},n._continueInterview=function(){i.prototype._continueInterview.apply(this,arguments),this.interview.assignments.callback||this.interview.assign({callback:function(){this.shade&&this.shade.minimize()}.bind(this)}),this.shade&&this._defer("grow",this.shade.grow.bind(this.shade),50)},n._updateBackability=function(){i.prototype._updateBackability.apply(this,arguments),this.shade&&(this._classify(this.shade.dom.root,"is-interview-backable",this.dom.root.classList.contains("is-interview-backable")),this._classify(this.shade.dom.root,"was-interview-backable",this.dom.root.classList.contains("was-interview-backable")))},n._onViewImpartSelf=function(e){var i=t.try(e,"m.parentView.dom.banner");i&&this._build("controls",{extending:this.dom,parentNode:i}," back-button",{button:!0},"  back-chevron",o,"  back-label <span> {shade.back}",{labeling:"back-button"}," cameo .mascot-icon",{graphic:"mascot",access:"visual"}).backChevron.bearing("w")},s}),define("app/views/components/interviews/interview-answer",["require","common","app/views/core/partial","shibui/src/view"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("shibui/src/view");return n.$init=function(e,i){this.interview=e,this.impart(t.excise(i,"parentNode")),this._fillOut(this.dom,i)},n.emphasize=function(e){return e===!1||null===e?t.DataClass.clear(this.dom.root,"emphasis"):"string"==typeof e?t.DataClass.set(this.dom.root,"emphasis",e):(t.DataClass.set(this.dom.root,"emphasis","reset"),t.DataClass.set(this.dom.root,"emphasis")),this},n.indicator=function(e){return e instanceof r?(this.dom.indicator=e,this._classify(this.dom.indicator.dom.root,"interview-answer-indicator"),this.dom.indicator.impart(this.dom.actionFlex)):(t.each(this.dom.root.querySelectorAll(".interview-answer-indicator"),function(e){e.parentNode.removeChild(e)}),e=this._withOptions(e,{parentNode:this.dom.actionFlex}),e.icon||e.graphic||e.tag||(e.tag="span"),this.dom.indicator=this._element(e),this._classify(this.dom.indicator,"interview-answer-indicator")),this},n.explanation=function(e){return t.each(this.dom.root.querySelectorAll(".interview-answer-explanation"),function(e){e.parentNode.removeChild(e)}),"string"==typeof e&&(e={label:e}),this.dom.explanation=this._element(this._withOptions(e,{tag:"p",parentNode:this.dom.action,classes:"interview-answer-explanation"})),this},n.compact=function(){return this._classify(this.dom.root.parentNode,"is-compact"),this},n.stack=function(){return this._classify(this.dom.root.parentNode,"is-stacked"),this},n.adjunct=function(e){var i,s=this._withOptions(e,{parentNode:this.dom.root,classes:"interview-answer-adjunct-action"}),n=t.compact([t.excise(s,"graphic"),t.excise(s,"icon")])[0];n&&(i={graphic:n,classes:e.classes});var r=this._element(s);return i&&(i.parentNode=r,this._element(i)),r},n.with=function(e){return"function"==typeof e&&e(this),this},n.label=function(e){return"string"==typeof e&&(e={label:e}),this._textify(this.dom.actionFlex.firstChild,t.absorb(e,{wrapper:!1})),this},n.classify=function(e,t){this._classify(this.dom.root,e,t)},n._layout=function(e){this._swapElement(e.root,{tag:"li"}),this._build("interview-answer",{extending:e})},n._fillOut=function(e,i){this._textify(e.root),this._classify(e.root,i.classes);var s=this._withOptions(i,{parentNode:e.root,classes:"interview-answer-action"}),n=t.excise(s,"indicator"),r=t.excise(s,"emphasis");e.action=this._element(s),e.actionFlex=this._element({tag:"span",classes:"interview-answer-action-flex"}),t.each(e.action.childNodes,function(t){e.actionFlex.appendChild(t)}),e.action.appendChild(e.actionFlex),r&&this.emphasize(r),n&&this.indicator(n)},n._withOptions=function(e,i){var s=t.absorb(i,t.absorb(e,{}));if(s.next&&(s.label=s.label||"mascot.next",s.indicator={html:"→"},s.link=t.excise(s,"next"),"function"==typeof s.link&&(s.button=t.excise(s,"link"))),s.done&&(s.emphasis="done",s.label=s.label||"mascot.done",s.link=t.excise(s,"done"),"MENU"==s.link?(s.link="interview/menu",s.indicator=s.indicator||{icon:"footer-menu-hamburger"}):"function"==typeof s.link?s.button=t.excise(s,"link"):"string"!=typeof s.link&&(delete s.link,s.button=this.interview.thenYieldBack(t.excise(s,"assign")))),s.link&&s.link.match(/^#[^\s]+$/)&&(s.yield=t.excise(s,"link")),s.yield){var n=t.excise(s,"yield"),r=t.excise(s,"assign");"BACK"==n?s.button=s.button||this.interview.thenYieldBack(r):s.button=this.interview.thenYield(n,r)}return s.button&&t.excise(s,"link"),(s.button||s.link)&&(s["data-halo-class"]=s["data-halo-class"]||"subtle"),s.wrapper="span",s},s}),define("app/views/components/interviews/interview-episode",["require","common","app/views/core/partial","shibui/src/components/spinner","app/views/components/interviews/interview-answer"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("shibui/src/components/spinner"),o=e("app/views/components/interviews/interview-answer");return n.say=function(e){var t=this._element({tag:"p",classes:"interview-episode-say"});return this._textify(t,e),this._spawn("interview-episode-sayings").appendChild(t),t},n.construct=function(e,i){return this.dom[t.camelize(e)]=i,"function"==typeof i.impart?i.impart(this):this.dom.appendix.appendChild(i),i},n.answer=function(e){var i=this._spawn("interview-answers","ul");return e=t.absorb({parentNode:i},t.absorb(e,{})),new o(this.interview,e)},n.response=function(e,i,s){var n={};"string"==typeof s?n.classes=s:s&&t.absorb(s,n);var r;n.classes&&n.classes.match(/\bemph\b/)&&(r=!0,n.classes=n.classes.replace(/\bemph\b/,"").trim()||null),"string"==typeof e?n.label=e:t.absorb(e,n),"string"==typeof i?(n.link=i,n.link.match(/^#[^\s]+$/)&&(n.yield=t.excise(n,"link"))):"function"==typeof i&&(n.button=i);var o=this.answer(n).compact();return r&&o.emphasize(),o},n.spin=function(e){return this.markAsRewritable(t.try(e,"rewritable")),this.construct("spin-bubble",this._spinBubble().root)},n.characterize=function(e){this==t.last(this.interview.episodes)&&this.interview.characterize({episode:e})},n.divider=function(){var e=this._element({tag:"hr",classes:"shibui-form-rule"});return this.dom.appendix.appendChild(e),e},n.refresh=function(){this.isInDocument()&&(t.each(this.dom,function(e,i){t.try(i,"refresh()")}),this._dispatch("interview:episode:refresh"))},n.markAsRewritable=function(e){this._.rewriteIf=e},n.isRewritable=function(e){return this._.rewriteIf===e||this._.rewriteIf===!0||"undefined"==typeof this._.rewriteIf},n.rewrite=function(e,i){return this._.rewriteIf!=e&&(this._.rewriteIf=!1),this._discardScrollState(),this.name=e,this._textify(this.dom.appendix),this.dom.root.className=["interview-episode","interview-episode-"+t.dasherize(e)].join(" "),i(this),this},n.focusFirstElement=function(){this._.scrollState||this._defer("shift-focus",function(){var e=t.try(this.dom,"appendix.querySelector()","*:first-child .interview-episode-say:first-child,.interview-episode-spin-bubble:first-child");e&&(this._focusElement(e),APP.events.dispatch("halos:refresh"))}.bind(this),200)},n._layout=function(e){this._build("interview-episode",{extending:e}," appendix")},n._listen=function(e,t){this._handle("view:extract",this),e.onArenaScroller=APP.arena.on("arena:scroller",this._onArenaScroller.bind(this))},n._onViewExtractSelf=function(){this._recordScrollState(APP.arena.scroller)},n._onArenaScroller=function(e){this._restoreScrollState(e.m.scroller)},n._spawn=function(e,i){var s=this.dom.appendix.lastChild;return t.try(s,"classList.contains()",e)||(s=this._element({tag:i||"div",parentNode:this.dom.appendix,classes:e})),s},n._spinBubble=function(){var e=this._build("interview-episode-spin-bubble"," spinner",r);return e.spinner.spin(),e},n._recordScrollState=function(e){if(this.isInDocument()&&t.elementClosest(this.dom.root,".screen-interview")){var i=t.try(e,"_recomputeScrollData()");i&&(this._.scrollState=t.absorb(i,{focus:this.dom.root.querySelector("*:focus,*:active")}))}},n._restoreScrollState=function(e){if(!this._.scrollState||!this.isInDocument())return!1;var i=t.excise(this._,"scrollState");i&&i.focus&&t.isInDOM(i.focus)&&i.focus.focus();var s=t.try(i,"y")||0;e.scrollTo(s,{duration:0})},n._discardScrollState=function(){delete this._.scrollState},s}),define("app/views/components/interviews/interview",["require","common","app/views/core/partial","./interview-episode"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("./interview-episode");return n.claimOwnership=function(e){this.owner=e},n.configure=function(e,i,s){var n=e.split("/");this.characteristics={topic:n.shift(),path:n.join("/")};var r=this._prepare();return this._classify(r.root,"interview-topic-"+this.characteristics.topic),this._classify(r.root,"interview-path-"+this.characteristics.path.replace(/\//g,"_")),this.assign(i),"function"==typeof this._configure&&this._configure(this.assignments,s||{}),this.address=t.parameterizeURL("interview/"+e,this.parameters),this},n.commence=function(e){},n.become=function(e,i){this._.becoming=e=e.replace("#","");var s=this._bindingForEpisode(e);this.episodes=this.episodes||[];var n,o=t.excise(this.characteristics,"episode"),a=this.characteristics.episode={};return t.each(this.episodes,function(i){this._isEpisodeCurrent(i)&&(i._._characteristics=o),i.extract();var s=t.try(this._._extraction,"views");s&&t.excise(s,i),i.name==e?n=i:!n&&i.isRewritable()&&(n=i)},this),n?(n.access("normal"),n.impart(this.dom.episodes),this.episodes.splice(this.episodes.indexOf(n)+1)):(n=new r(this.dom.episodes),n.interview=this,this.episodes.push(n)),n.isRewritable(e)?n.rewrite(e,s):(a=t.excise(n._,"_characteristics")||{},n.refresh()),(t.try(i,"focusFirstElement")||this.assignments.focusFirstElement)&&n.focusFirstElement(),this._.becoming==e&&(delete this._.becoming,a.episodeName=e,this.characterize({episode:a})),n},n.refresh=function(){this._dispatch("interview:refresh"),t.try(t.last(this.episodes||[]),"refresh()")},n.recommence=function(){this.yield(this.commence())},n.characterize=function(e){if(t.try(e,"episode")&&this.characteristics.episode&&(e=t.absorb(e,{}),t.absorb(t.excise(e,"episode"),this.characteristics.episode)),e&&t.absorb(e,this.characteristics),!this._.becoming){var i=t.absorb(this.characteristics,{interview:this});i.episode&&(i.episode=t.absorb(i.episode,{})),this._dispatch("interview:characteristics",i)}},n.assign=function(e){this.assignments&&t.isEmpty(e)||(this.assignments=t.absorb(e,this.assignments||{}))},n.yield=function(e,t){if(e&&"string"!=typeof e)return this._dispatch("interview:yield",e);var i=this._argsToYieldData(t);i.path=0==e.indexOf("#")?this.address+e:e,this._dispatch("interview:yield",i)},n.yieldBack=function(e){var i=t.last(this.episodes||[]);t.try(i,"isRewritable()")&&i.markAsRewritable(!1);var s=t.excise(this.assignments,"callback");return this._.yieldBackCallback=s||this._.yieldBackCallback,"function"==typeof this._.yieldBackCallback&&(this._.yieldBackCallback(e||{}),!0)},n.thenYield=function(e,i){var s=this._argsToYieldData(i);return function(i){if(i&&!i.tappedElement){var n=this._argsToYieldData(i);t.absorb(n.assignments,s.assignments),t.absorb(n.parameters,s.parameters),s.callback=n.callback||s.callback}this._defer("yielder",this.yield.bind(this,e,s),0)}.bind(this)},n.thenYieldBack=function(e){return function(){this.yieldBack(e)||APP.nav.go("interview/menu")}.bind(this)},n.callbackToYield=function(e){if("function"==typeof e)return e;if(e){var t;if(e===!0)t=this.address;else if("string"==typeof e&&e.match(/^#.*$/))t=this.address+e;else if("string"==typeof e&&e.match(/^interview\//))t=e;else if("string"==typeof e)return APP.nav.go.bind(APP.nav,e);if(t)return this.yield.bind(this,t);throw e}},n.boundary=function(){this._dispatch("interview:forget")},n.episodeName=function(){var e=t.try(t.last(this.episodes||[]),"name");if(e)return"#"+e},n._layout=function(e){this._build("interview",{extending:e}," episodes")},n._isEpisodeValid=function(e){var i=!0;return t.each(e.dom.root.querySelectorAll("*"),function(e){e._view&&"function"==typeof e._view.validate?i=e._view.validate()&&i:"function"==typeof e.validate&&(i=e.validate()&&i)}),i||this._focusFirstInvalidity(e.dom.root),i},n._isEpisodeCurrent=function(e){return e==t.last(this.episodes)&&!!this.isInDocument()},n._rewriteEpisode=function(e){return t.last(this.episodes).rewrite(e.replace("#",""),this._bindingForEpisode(e))},n._bindingForEpisode=function(e){var e=e.replace("#",""),t=this["_"+e];return console.assert("function"==typeof t,"[INTERVIEW] no such episode: #%s",e),t.bind(this)},n._extractLibraryParameters=function(e,i){var s=t.absorb(e,t.absorb(i,{}));if(s.library&&s.library.baseKey)return{key:s.library.baseKey};if(s.library&&s.library.websiteId)return{websiteId:s.library.websiteId};if(s.websiteId)return{websiteId:s.websiteId};if(s.key||s.baseKey||s.libraryKey){var n={key:s.key||s.baseKey||s.libraryKey};return n.key=n.key.replace(/-visitor$/,""),n}},n._argsToYieldData=function(e){e=t.absorb(e,{});var i={},s={};return e.assignments&&t.absorb(t.excise(e,"assignments"),i),e.parameters&&t.absorb(t.excise(e,"parameters"),s),t.absorb(e,i),{callback:t.excise(i,"callback"),assignments:i,parameters:s}},n._missingArgs=function(e){e.say("interview.missing-args.intro"),e.answer({done:"MENU",label:"interview.menu"})},s}),define("app/views/components/common/app-store-tout",["require","common","app/views/core/partial","app/base/quirks"],function(e){var t=(e("common"),e("app/views/core/partial")),i=t.new(),s=i.prototype,n=e("app/base/quirks");return s.recommendPlatform=function(){return n.ask("android")?"google":n.ask("ios")?"apple":n.ask("macosx")&&(navigator.maxTouchPoints||1)>1?"apple":void 0},s.become=function(e){return this._prepare(),this._semaphore("platform",e),this},s._layout=function(e){this._build("app-store-tout",{extending:e}," flex .app-store-tout-platform-apple","  cameo .data-character_app",{graphic:"mascot",access:{role:"img","aria-label":this._phrase("app-store-tout.app-icon.label")}},"  plus",{graphic:"tout-join-plus",access:"visual"},"  logo",{graphic:"store-logo-apple",access:{role:"img","aria-label":this._phrase("app-store-tout.ios-store-logo.label")}},"  arrow",{graphic:"tout-join-arrow",access:"visual"},"  link",{label:"app-store-tout.ios-store-action",link:APP.constants.URLS["upgrade:apple"]}," flex .app-store-tout-platform-google","  cameo .data-character_app",{graphic:"mascot",access:{role:"img","aria-label":this._phrase("app-store-tout.app-icon.label")}},"  plus",{graphic:"tout-join-plus",access:"visual"},"  logo",{graphic:"store-logo-google",access:{role:"img","aria-label":this._phrase("app-store-tout.play-store-logo.label")}},"  arrow",{graphic:"tout-join-arrow",access:"visual"},"  link",{label:"app-store-tout.play-store-action",link:APP.constants.URLS["upgrade:google"]}," pitch <p> {app-store-tout.pitch}")},i}),define("app/views/interviews/interview-welcome",["require","common","app/views/components/interviews/interview","app/views/components/common/app-store-tout"],function(e){var t=(e("common"),e("app/views/components/interviews/interview")),i=t.new(),s=i.prototype,n=e("app/views/components/common/app-store-tout");return s.commence=function(e){return"#doYouHaveACard"},s._doYouHaveACard=function(e){e.say("welcome.greeting"),e.say("onboarding.question.card"),e.answer({label:"onboarding.answer.card.yes",yield:"#iHaveCards"}),e.answer({label:"onboarding.answer.card.no",yield:"#iHaveNoCards"});var t=new n,i=!APP.shell.info.platform&&t.recommendPlatform();i?e.construct("app-store-tout",t.become(i)):(e.construct("mural",this._element({classes:"welcome-mural",access:"visual"})),APP.imageDirector.mural(e.dom.mural,"welcome-specs",{classes:"welcome-mural-graphic"}))},s._iHaveCards=function(e){e.say("welcome.strategy.intro"),e.answer({label:"interview.locate-library-guess",yield:"interview/locate-library/guess"}).explanation("welcome.strategy.guess").emphasize("turquoise"),e.answer({label:"interview.locate-library-search",yield:"interview/locate-library/search"}).explanation("welcome.strategy.search"),e.answer({label:"interview.authenticate-recover",yield:"interview/authenticate/recover",assign:{callback:"#onChipCloned"}}).explanation("welcome.strategy.code").emphasize("done")},s._iHaveNoCards=function(e){e.say("onboarding.question.join.1"),e.say("onboarding.question.join.2"),e.answer({label:"onboarding.answer.join",yield:"interview/locate-library/map"}).emphasize()},s._onChipCloned=function(e){this.assignments.library?APP.nav.go(this.assignments.library.path()):(e.markAsRewritable(),this.yield("#iHaveNoCards"))},i}),define("app/views/components/common/instructive-button",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.become=function(e){this.options=t.absorb(e,this.options||{});var i=this._prepare();this._textify(i.intro,this.options.intro),t.isList(t.try(this.options.intro,"rotate"))&&this._rotateLabels(i.intro,this.options.intro.rotate),this._textify(i.target,this.options.target),this._textify(i.icon),"string"==typeof this.options.icon&&this._element({icon:this.options.icon,parentNode:i.icon}),this.options.link?this._swapInteractiveElement(i.target,{link:this.options.link}):this.options.button?this._swapInteractiveElement(i.target,{button:this.options.button}):this._swapInteractiveElement(i.target,{tag:"div"}),this.options.classes&&this._classify(this.dom.root,this.options.classes)},n._layout=function(){this.dom=this._build("instructive-button"," intro"," target",{link:"#"}," icon"," underline")},n._rotateLabels=function(e,i){var s,n=0,r=function(t){(this.isInDocument()||t)&&this._textify(e.querySelector(".rotator")||e,{html:i[n++%i.length],morph:t!==!0})}.bind(this);r(!0),s=setInterval(r,2e3);var o=t.elementClosest(this.dom.root,".native-scrollable");o&&(APP.events.off(this.handlers._rotateScroll),this.handlers._rotateScroll=APP.events.on(o,"scroll",function(){clearTimeout(s),this.isInDocument()&&(s=setInterval(r,2e3))}.bind(this))),APP.events.off(this.handlers._rotateExtract),this.handlers._rotateExtract=APP.events.on(this.dom.root,"view:extract",function(){clearTimeout(s)}),APP.events.off(this.handlers._rotateImpart),this.handlers._rotateImpart=APP.events.on(this.dom.root,"view:impart",function(){r(!0),s=setInterval(r,2e3)})},s}),define("app/views/support/enter-commands-form",["require","common","shibui/src/view","shibui/src/components/form-input-search"],function(e){var t=e("common"),i=e("shibui/src/view"),s=i.new(),n=s.prototype,r=e("shibui/src/components/form-input-search");return n.$init=function(e){this.ownerView=e,this._._extraction=t.absorb(e._._extraction,{}),delete this._._extraction.views},n.run=function(e){this._prepare(),this.dom.inputCommand.setValue(e),this._runCommand(e)},n._layout=function(e){this._build("enter-commands-form",{extending:e}," incoming","  input-command",{construct:r,with:{placeholder:{html:"..."},submitIcon:"input-command",attributes:{autocorrect:"off",autocomplete:"off"}}}," outgoing <pre>"," controls","  copy-output-button .shibui-button",{button:!0,html:"Copy"})},n._listen=function(e){e.submit=this.dom.inputCommand.on("form:field:submit",this._submitCommand.bind(this)),e.reset=this.dom.inputCommand.on("form:field:reset",this._resetCommand.bind(this))},n._submitCommand=function(e){var t=e.m.value.replace(/[“”]/g,'"').replace(/[‘’]/g,"'");e.m.control.setSelectionRange(0,t.length),e.m.control.blur(),this._runCommand(t)},n._runCommand=function(e){return APP.journal.info("[$] =>",e),e.match(/^\$\s*$/)&&this.ownerView?(this.extract(),void this.ownerView.impart()):(e=e.replace(/^\$\s*/,""))?void APP.$(e,function(e){this._output(t.isNullish(e)?"NO RESULT":e)}.bind(this)):this._output("TO LEAVE THE ROCKETSHIP: $")},n._resetCommand=function(){this._output("")},n._output=function(e){var t=e;try{"string"!=typeof t&&(t=JSON.stringify(t,null,2))}catch(i){return t="UNSERIALIZABLE RESULT: "+t,this._textify(this.dom.outgoing,{html:t}),APP.journal.warn("[$] UNSERIALIZABLE RESULT",e,i)}APP.journal.info("[$] <=",e),this._textify(this.dom.outgoing,{html:t})},n._onTapCopyOutputButton=function(e){var t=document.createRange();t.selectNodeContents(this.dom.outgoing);var i=window.getSelection();i.removeAllRanges(),i.addRange(t);try{document.execCommand("copy")?APP.journal.debug("[$] copied!",i.toString()):APP.journal.debug("[$] unable to copy")}catch(e){APP.journal.debug("[$] error while copying:",e)}i.removeAllRanges()},s}),define("app/views/support/help-search-form",["require","common","app/views/core/partial","shibui/src/components/form-input-search","./enter-commands-form"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("shibui/src/components/form-input-search"),o=e("./enter-commands-form");return n._layout=function(e){if(this._build("fdb-help-search-form",{extending:e}," incoming","  input-search",{construct:r,with:{placeholder:"fdb.help.search.placeholder"}}," instructions <p>",{label:"fdb.help.search.instructions",enliven:{"#help-site":this._goToHelpSite.bind(this)}}," results <ul>"," continuation <p>"," spinner .spinner",{icon:"spinner-12"}),APP.flags.isOn("quick-tips"))this._enliven(e.instructions,"#quick-tips",function(e){APP.arena.popover(e.target).spinner(this._fetchQuickTips.bind(this))}.bind(this));else{for(var t=e.instructions.querySelector('a[href="#quick-tips"]');t&&t.childNodes.length;)t.parentNode.insertBefore(t.firstChild,t);t&&t.parentNode.removeChild(t)}},n._listen=function(e,t){this._.shownIntents=[],this._handle("form:field:submit",t.inputSearch),this._handle("form:field:reset",t.inputSearch)},n._fillOutContinuation=function(e,t){return this._textify(e,{label:["fdb.help.search."+(t?"":"un")+"answered","fdb.help.search.continuation"],enliven:{"#request-support":function(){APP.interviews.go("interview/feedback/support",{draftMessage:this.dom.inputSearch.value(),ignoreIntents:this._.shownIntents})}.bind(this),"#help-site-search":function(){this._goToHelpSite(this.dom.inputSearch.value())}.bind(this)}}),e},n._onFormFieldSubmitInputSearch=function(e){this._clearResults();var t=e.m.value;return e.m.control.setSelectionRange(0,t.length),e.m.control.blur(),t.match(/^\$/)?(this.dom.inputSearch.setValue(""),this._runCommand(t.replace(/\$\s*/,""))):(this._classify(this.dom.root,"is-searching"),void APP.services.sage.fetch("help/search?q="+encodeURIComponent(t),this._onSearchSuccess.bind(this),this._onSearchFailure.bind(this)))},n._onFormFieldResetInputSearch=function(){this._clearResults()},n._onSearchSuccess=function(e){this._declassify(this.dom.root,"is-searching");var i=[];t.each(JSON.parse(e),function(e,t){if(!(t>=4&&"search"==e.matching)){var s=this._processQuickTip(e);s&&i.push(s)}},this),1===i.length?this._dispatchQuickTip(i[0]):(this._classify(this.dom.root,"is-results"),this._fillOutContinuation(this.dom.continuation,i.length),t.each(i,function(e){this._build("",{element:this.dom.results}," <li>","  <button>",{button:this._dispatchQuickTip.bind(this,e),html:e.tip.title})},this))},n._onSearchFailure=function(){this._declassify(this.dom.root,"is-searching"),this._goToHelpSite(this.dom.inputSearch.value())},n._clearResults=function(){this._declassify(this.dom.root,"is-results"),this._textify(this.dom.results)},n._fetchQuickTips=function(e){s.QUICK_TIP_INTENTS?this._processQuickTips(e,s.QUICK_TIP_INTENTS):APP.services.sage.fetch("help/matrix",function(t){s.QUICK_TIP_INTENTS=JSON.parse(t),this._processQuickTips(e,s.QUICK_TIP_INTENTS)}.bind(this),function(){e.notice({html:this._phrase("fdb.quick-tips.failed")})}.bind(this))},n._processQuickTips=function(e,i){e.choices(function(e,s){s.classList.add("fdb-quick-tip-choices"),t.each(i,function(t){var i=this._processQuickTip(t);i&&e.choice({html:i.tip.title,button:this._dispatchQuickTip.bind(this,i)})},this)}.bind(this))},n._processQuickTip=function(e){var i={intent:e.intent,attachments:[]};if(t.each(e.resources,function(e){"quick-tip"==e.type?i.tip=e:i.attachments.push(e)}),i.tip)return i},n._dispatchQuickTip=function(e){this._.shownIntents.push(e.intent),this._dispatch("quick-tip",{tip:e,continuation:this._fillOutContinuation(this._element({tag:"p",classes:"fdb-help-search-form-continuation"}),1)})},n._goToHelpSite=function(e){var t=APP.constants.URLS.help;if(e&&"string"==typeof e){var i=SPARK.locale.tag;i={"en-GB":"en-US","es-419":"es","is-IS":"is","ms-SG":"ms","ta-SG":"ta","zh-Hans-CN":"zh-CN","zh-Hant-TW":"zh-TW"}[i]||i,t=[t.replace(/\/+$/,""),i.toLowerCase(),"search.htm?q="+encodeURIComponent(e)].join("/")}APP.shell.openURL(t)},n._runCommand=function(e){this.extract(),this._.commander=this._.commander||new o(this),this._.commander.impart(),this._.commander.run(e)},s}),define("app/views/support/robot-answer",["require","common","app/views/core/partial","shibui/src/components/chevron"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("shibui/src/components/chevron");return n.$init=function(e,i){this.tip=e,this.attachments=i?t.flatten([i]):[]},n._layout=function(e){this._build("robot-answer",{
extending:e}," title <h2>",{html:this.tip.title}," tip",{html:this.tip.html,enliven:this._liveLinks()}),t.each(this.attachments,this._layoutAttachment.bind(this))},n._layoutAttachment=function(e){var t=this._phrase("fdb.robots.attachment."+e.type);if(t){var i=this._build("robot-attachment",{parentNode:this.dom.root}," label",{html:t});"help-article"==e.type?this._fillOutHelpArticle(i.root,e):"illustration"==e.type&&this._fillOutIllustration(i.root,e)}},n._fillOutHelpArticle=function(e,t){this._build("robot-attachment-help-title",{button:APP.shell.bindOpenURL(t.url),parentNode:e}," <span>",{html:t.title}," >",function(e){return new r(e).bearing("e")})},n._fillOutIllustration=function(e,t){this._build("robot-attachment-illustration-frame",{parentNode:e}," <img>",{attributes:{src:t.url}})},n._liveLinks=function(){return{"#reset-application":"interview/reset/libby","#configure-downloads":"interview/configure/downloads","#manage-notifications":"interview/configure/notifications","#suspend-holds":"interview/configure/suspend-holds","#list-cards":"interview/configure/cards","#add-library":"interview/locate-library/search","#authenticate":"interview/authenticate/card"}},s}),define("app/views/about/flower-fountain",["require","common","shibui/src/view"],function(e){var t=(e("common"),e("shibui/src/view")),i=t.new(),s=i.prototype;return s.LIFESPAN=1e4,s.$init=function(e){this._explode(e)},s._explode=function(e){var t=e.getBoundingClientRect(),i=this._element({parentNode:APP.arena.dom.overlay,classes:"flower-fountain"});i.style.left=t.left+t.width/2+"px",i.style.top=t.top+t.height/2+"px";for(var s=0;s<this._countFlowers();++s)this._makeFlower(i,s);setTimeout(function(){i.parentNode.removeChild(i)},this.LIFESPAN)},s._countFlowers=function(){for(var e=7,t=.5,i=0,s=APP.summoner.daemons.karma.data.earlyReturnCount||0;s>0;)s-=i=Math.min(s,7),e+=t*i,t*=.95;return e},s._makeFlower=function(e,t){var i=["🌷","🌸","🌹","🌺","🌻","🌼"],s=i[t%i.length],n=this._element({parentNode:e,classes:"flower"}),r=this._element({parentNode:n,classes:"flower-x"}),o=this._element({parentNode:r,classes:"flower-y"});this._element({parentNode:o,classes:"flower-glyph",html:s});setTimeout(function(){this._classify(n,"fly");var e=Math.round(320*Math.random())*(t%2?-1:1);r.style.setProperty("transform","translateX("+e+"px)");var i=280+Math.round(320*Math.random());o.style.setProperty("transform","translate3d(0,"+i+"px,0)")}.bind(this),80*t)},i}),define("app/views/interviews/interview-menu",["require","common","app/views/components/interviews/interview","app/views/components/shelf/notice-plank","app/views/components/library/summary-list-of-libraries","app/views/core/block-strap","app/views/components/common/instructive-button","app/views/support/help-search-form","app/views/support/robot-answer","app/views/components/common/app-store-tout","app/views/about/flower-fountain"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("app/views/components/shelf/notice-plank"),o=e("app/views/components/library/summary-list-of-libraries"),a=e("app/views/core/block-strap"),l=e("app/views/components/common/instructive-button"),c=e("app/views/support/help-search-form"),h=e("app/views/support/robot-answer"),u=e("app/views/components/common/app-store-tout"),p=e("app/views/about/flower-fountain");return n.commence=function(e){return"#mainMenu"},n._mainMenu=function(e){this.handlers._onEpisodeRefresh=e.on("interview:episode:refresh",this._refreshMainMenu.bind(this,e)),e.dom.introSaying=e.say("blank"),this._classify(e.dom.introSaying,"menu-intro-saying"),APP.imageDirector.mural(e.dom.introSaying,"menu-phone",{classes:"menu-intro-saying-mural",access:"visual"}),e.construct("system-notices",this._element({tag:"section",classes:"menu-system-notices"})),e.construct("library-list",new o),e.dom.libraryList.become([{strap:{text:"menu.library.heading"},actions:{addLibrary:!0,manageCards:!!APP.library},options:{indicator:!0}}]),e.construct("settings-strap",new a),e.dom.settingsStrap.configure({text:"interview.configure-settings"}),e.construct("row-notifications",new l),e.dom.rowNotifications.become({intro:"menu.settings.intro.notifications",target:"menu.settings.target.notifications",icon:"menu-settings-notifications",link:"interview/configure/notifications"}),e.construct("row-accessibility",new l),e.dom.rowAccessibility.become({intro:"menu.settings.intro.accessibility",target:"menu.settings.target.accessibility",icon:"menu-settings-accessibility",link:"interview/configure/accessibility"}),APP.summoner.daemons.fulfillmentChoices.isChoiceToMake()&&(e.construct("row-fulfiller",new l),e.dom.rowFulfiller.become({intro:"menu.settings.intro.fulfiller",target:"menu.settings.target.fulfiller",icon:"menu-settings-fulfiller",link:"interview/configure/fulfillment"})),APP.shell.has("rosters")&&(e.construct("row-downloads",new l),e.dom.rowDownloads.become({intro:"menu.settings.intro.downloads",target:"menu.settings.target.downloads",icon:"menu-settings-downloads",link:"interview/configure/downloads"})),e.construct("row-navigation",new l),e.dom.rowNavigation.become({intro:"menu.settings.intro.navigation",target:"menu.settings.target.navigation",icon:"menu-settings-navigation",link:"interview/configure/navigation"});var i=this._languageLabels();e.construct("row-language",new l),e.dom.rowLanguage.become({intro:{label:"menu.settings.intro.language",substitutions:{LANGUAGE_COUNT:i.length},rotate:i},target:"menu.settings.target.language",icon:"menu-settings-language",link:"interview/configure/language"}),this._classify(e.dom.rowLanguage.dom.root,"is-last"),e.construct("info-strap",new a),e.dom.infoStrap.configure({text:"menu.your-info.heading"}),e.construct("row-backup",new l),e.dom.rowBackup.become({intro:"menu.settings.intro.back-up",target:"interview.authenticate-back-up",icon:"menu-data-back-up",link:"interview/authenticate/back-up",classes:"menu-instructive-button-data"}),e.construct("row-transfer",new l),e.dom.rowTransfer.become({intro:"menu.your-info.intro.setup-code",target:"menu.your-info.target.setup-code",icon:"menu-data-setup-code",link:"interview/authenticate/setup-code",classes:"menu-instructive-button-data"}),e.construct("row-reset-app",new l),e.dom.rowResetApp.become({intro:"menu.settings.intro.reset-libby",target:"interview.reset-libby",icon:"menu-data-reset",link:APP.flags.isOn("reset-steps")?"interview/reset/steps":"interview/reset/libby",classes:"menu-instructive-button-data"}),this._classify(e.dom.rowResetApp.dom.root,"is-last"),e.construct("help-strap",new a),e.dom.helpStrap.configure({text:"menu.help-support.heading"}),this._attr(e.dom.helpStrap.dom.heading,"aria-label",e.dom.helpStrap.dom.heading.innerText),this.access(e.dom.helpStrap.dom.text,{role:"text"});var s=e.construct("row-auth-help",new l);e.dom.rowAuthHelp.become({intro:"menu.settings.intro.auth-help",target:"settings.auth-help.button",icon:"menu-help-contact-library",link:"interview/feedback/library",classes:"menu-instructive-button-help"});var n=APP.flags.property("menu-feedback");t.among(n,"appraisal","survey")||(n="beta"==APP.constants.ENV?"appraisal":"survey"),"appraisal"==n?(s=e.construct("row-appraisal",new l),e.dom.rowAppraisal.become({intro:"menu.settings.intro.beta-appraisal",target:"interview.feedback-beta",icon:"menu-help-feedback",link:"interview/feedback/beta",classes:"menu-instructive-button-help"})):(s=e.construct("row-survey",new l),e.dom.rowSurvey.become({intro:"menu.settings.intro.survey",target:"interview.feedback-survey",icon:"menu-help-survey",link:"interview/feedback/survey",classes:"menu-instructive-button-help"})),this._classify(s.dom.root,"is-last"),e.construct("help-search-form",new c(this)),e.dom.helpSearchForm.on("quick-tip",function(e){this.assign(e.m),this.yield("#quickTip")}.bind(this));var r=new u,h=!APP.shell.info.platform&&r.recommendPlatform();h?e.construct("app-store-tout",r.become(h)):(e.construct("divider",this._element({classes:"menu-library-divider",access:"visual"})),APP.imageDirector.mural(e.dom.divider,"menu-tablet",{classes:"menu-library-divider-mural"}),e.construct("logo",this._build("menu-logo"," wordmark","  <strong> {app.name}").root));var p=this._build("menu-colophon"," line"," dedication <p> {menu.colophon.reason}"," info-links","  .menu-colophon-row <p>","   version-shell <span>",{skip:!APP.shell.info.spec},"    version-shell-spec <span>",{html:"V"+APP.shell.info.spec},"    version-shell-number <span>",{html:t.try(APP.shell.info,"version.value")},"     version-shell-build <span>",{skip:!APP.shell.info.build,html:" b"+APP.shell.info.build},"    <span> .menu-colophon-disc",{html:" • "},"   version-client <span>","    version-client-spec <span>",{html:"V"+APP.client.info.spec},"    version-client-number <span>",{html:APP.client.info.version.value},"    version-download-button",{button:function(){APP.relaunch()}},"  .menu-colophon-row <p>","   info-link-legal {interview.about-legal}",{link:"interview/about/legal"},"   <span> .menu-colophon-disc",{html:" • "},"   info-link-tech {interview.about-technical}",{link:"interview/about/technical"},"  .menu-colophon-row <p>","   info-link-whats-new {menu.colophon.whats-new}",{link:"interview/about/whats-new"},"   <span> .menu-colophon-disc",{html:" • "},"   info-link-libby-life {menu.colophon.libby-life}",{link:"https://libbylife.com"},"   <span> .menu-colophon-disc",{html:" • "},"   bouquet",{access:"visual",button:this._onTapFlowerBouquet.bind(this),html:"💐"}," logos","  overdrive-link",{link:"https://overdrive.com",title:this._phrase("menu.colophon.overdrive.link-destination")},"   overdrive-logo",{graphic:"overdrive-logo"},"  b-corp-link",{link:"https://www.bcorporation.net/en-us/find-a-b-corp/company/overdrive-inc",title:this._phrase(["menu.colophon.bcorp.alt",{html:"-"},"menu.colophon.bcorp.link-destination"])},"   b-corp-logo .is-invertible <img>",{src:APP.constants.filePath("images/b-corp-logo.png"),alt:this._phrase("menu.colophon.bcorp.alt")});e.construct("colophon",p.root);var d=function(){var e,i=t.try(APP.updater,"roster.version");i&&i.isNotSameAs(APP.client.info.version)&&(e={html:i.value}),this._textify(p.versionDownloadButton,e)}.bind(this);APP.router.route.on("app:update:ready",d),d()},n._refreshMainMenu=function(e){if(APP.library){var i=0;t.each(APP.patron.cards.all,function(e){e.library.websiteId==APP.library.websiteId&&(i+=1)}),this._textify(e.dom.introSaying.firstChild,{label:"menu.library.intro",substitutions:{LIBRARY_NAME:APP.library.safeName(),LIBRARY_CARDS:i,OTHER_CARDS:Math.max(0,APP.patron.cards.all.length-i)},enliven:{"#authenticate":"interview/authenticate/card?key="+APP.library.baseKey},wrapper:!1})}else this._textify(e.dom.introSaying.firstChild,"menu.library.missing");this._refreshSystemNotices(e.dom.systemNotices),e.dom.libraryList.refresh([APP.libraries.byOldestCard(APP.libraries.withCards())])},n._refreshSystemNotices=function(e){var i=APP.notifier.notifications.collate({titles:!1,dismissedAt:null,sort:"priority"});if(t.try(this._.lastSystemNotices,"length")==i.length){if(!i.length)return;for(var s=!0,n=0,o=i.length;n<o;++n)s=i[n]===this._.lastSystemNotices[n];if(s)return}this._.lastSystemNotices=i,this._emptyElement(e);var l="_onNotificationDismiss";if(APP.events.off(this.handlers[l]),i.length){var c=new a(e);c.configure({text:"menu.notices.heading",circle:{icon:"block-strap-alert"}});var h=t.select(i,function(t){return new r(e).become(t)},this);this.handlers[l]=APP.events.on("notification:dismiss",function(i){h=t.select(h,function(e){return e.notification!=i.m.notification?e:void e.extract()}),h.length||this._emptyElement(e)}.bind(this))}},n._languageLabels=function(){return["English"].concat(t.select(APP.constants.LANGUAGE_ENDONYMS,function(e,t){return e.match(/^en-/)?void 0:t}))},n._quickTip=function(e){e.markAsRewritable(e.name),this.assignments.tip&&e.construct("robot-answer",new h(this.assignments.tip.tip,this.assignments.tip.attachments)),this.assignments.continuation&&e.construct("robot-continuation",this.assignments.continuation)},n._onTapFlowerBouquet=function(e){new p(e.target),this.access(e.target,{disabled:!0})},s}),define("app/views/account/library-card-view",["require","common","app/views/core/partial","shibui","app/views/account/library-colors","app/views/components/library/library-logo","shibui/src/components/form-input"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=(e("shibui"),e("app/views/account/library-colors")),o=e("app/views/components/library/library-logo"),a=e("shibui/src/components/form-input");return n.become=function(e,i){var s=this._prepare();this.card=e,this.options=t.absorb(i,{}),this._updateCardDetails(),s.colors.become(this.card.library),s.logo.become(this.card.library,{invertible:!1}),this._textify(s.name,{html:this.card.safeName(),spoken:{label:"a11y.library-card",substitutions:{CARD_NAME:this.card.safeName(),LIBRARY_NAME:this.card.library.safeName()}}})},n._layout=function(e){this._build("library-card",{extending:e}," backdrop","  colors",r," content","  row-1",{access:"visual"},"   logo",o,"  row-2","   name","  row-3","   spoken-counts .aria-spoken","   counts <table>",{access:"visual"},"    count-heads <tr>","     count-head-loans <th> {library-card.limits.loans}","     count-head-holds <th> {library-card.limits.holds}","    count-cells <tr>","     count-cell-loans <td>",{html:"--"},"     count-cell-holds <td>",{html:"--"},"   actions",{button:!0},"    actions-icon",{graphic:"card-actions"},"    expired-icon",{graphic:"card-expired"})},n._listen=function(e,t){this._handle("patron:sync:complete")},n._updateCardDetails=function(){var e=this._prepare();this._textify(e.spokenCounts),t.each(["loan","hold"],function(i){var s=this.card.counts?this.card.counts[i]:null;"number"!=typeof s&&(s="--");var n=this.card.limits?this.card.limits[i]:null;"number"!=typeof n&&(n="--"),this._textify(e["countCell"+t.capitalize(i+"s")],{label:"library-card.limits.value",substitutions:{COUNT:s,LIMIT:n}}),n&&this._element({tag:"span",parentNode:e.spokenCounts,label:"a11y.library-card.limits",substitutions:{COUNT:s,LIMIT:n,ITEM_TYPE:i}})},this),this.options.expired=this.card.isExpired(),this.options.deactivated=this.card!=this.card.library.card(),this._classify(e.root,"is-activatable",!!this.options.activatable),this._classify(e.root,"is-deactivated",!!this.options.deactivated),this._classify(e.root,"is-verifiable",!!this.options.verifiable),this._classify(e.root,"is-expired",!!this.options.expired),this._classify(e.root,"is-editable",!!this.options.editable),this.options.activatable?this.options.deactivated&&!this.options.expired?this._actOnTap(function(){APP.patron.cards.activateCard(this.card),APP.haptics.select()}.bind(this)):this._actOnTap(null):this.options.verifiable&&this.options.expired?this._actOnTap(this._onTapVerify.bind(this)):this._actOnTap(null)},n._onPatronSyncComplete=function(){this.card&&this._updateCardDetails()},n._onTapActions=function(){APP.arena.popover(this.dom.actions).choices(function(e){this.options.expired||this.options.activatable&&this.options.deactivated&&e.choice({label:"library-card.activate",classes:"library-card-action-activate",button:this._onTapActivate.bind(this)}),this.options.verifiable&&e.choice({label:"library-card.action.verify",classes:"library-card-action-verify",button:this._onTapVerify.bind(this)}),this.options.editable&&(e.choice({label:"library-card.action.rename",classes:"library-card-action-rename",button:this._onTapRename.bind(this)}),e.choice({label:"library-card.action.unlink",classes:"library-card-action-unlink",button:this._onTapUnlink.bind(this)}))}.bind(this))},n._onTapActivate=function(){APP.patron.cards.activateCard(this.card)},n._onTapVerify=function(){APP.interviews.go("interview/authenticate/card",{card:this.card,intent:"verify",origination:APP.router.route.path})},n._onTapRename=function(){APP.arena.popover(this.dom.name).form(function(e,t){var i=this._build("library-card-name-form",{element:t}," input",{construct:a,with:{form:t,value:this.card.cardName,placeholder:"library-card.rename.placeholder",explanation:"library-card.rename.label",required:!0,control:{autofocus:!0,maxlength:50}}}," submit",{tag:"button",type:"submit",classes:"popover-form-submit shibui-button halo",label:"library-card.rename.submit","data-popover-arrow-color":"none"});return this._onSubmitRename.bind(this,e,i.input)}.bind(this))},n._onSubmitRename=function(e,t){var i=t.value().trim();i&&(this.card.cardName=i,APP.patron.cards.save(),APP.sentry.renameCard(this.card,this.card.cardName)),e.close()},n._onTapUnlink=function(){APP.arena.popover().confirm({warningLabel:"library-card.unlink.warning",buttonLabel:"library-card.unlink.confirm",onSubmit:this._onConfirmUnlink.bind(this)})},n._onConfirmUnlink=function(){this._classify(this.dom.root,"is-removing"),APP.sentry.unlinkCard(this.card)},n._actOnTap=function(e){e?this._.tapAction=e:delete this._.tapAction,APP.events.off(this.handlers.onMouseDown),APP.events.off(this.handlers.onMouseUp),this._.tapAction&&(this.handlers.onMouseDown=this.handlers.onMouseDown||APP.events.on(this._prepare().root,"mousedown",this._onMouseDown.bind(this)),APP.events.on(this.handlers.onMouseDown))},n._onMouseDown=function(e){t.elementClosest(e.target,".library-card-actions")||(this.handlers.onMouseUp=this.handlers.onMouseUp||APP.events.on(document.documentElement,"mouseup",this._onMouseUp.bind(this)),APP.events.on(this.handlers.onMouseUp))},n._onMouseUp=function(e){APP.events.off(this.handlers.onMouseUp),t.elementClosest(e.target,".library-card-actions")||t.elementClosest(e.target,".library-card")==this.dom.root&&t.try(this._,"tapAction()",e)},s}),define("app/views/account/library-cards-list",["require","common","app/views/core/partial","./library-card-view"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("./library-card-view");return n.configure=function(e){this.options=t.absorb(e,{}),this.cards&&this.cards.length&&this.become(this.cards)},n.refresh=function(){delete this.cache,this._rearrange(this._prepare())},n.become=function(e){var i=this._prepare();this._classify(i.root,"is-compact",!!this.options.compact),this._declassify(i.root,"is-animating"),this._semaphore("card-count",""+e.length),i.list.style.removeProperty("visibility"),t.each(this.cards,function(s){t.among(s,e)||t.try(t.excise(i,"card"+s.cardId),"extract()")},this),this.cards=e,this.options=this.options||{},i.list.firstChild||delete this.cache,this._rearrange(i)},n._layout=function(e){this._build("library-cards",{extending:e}," list")},n._rearrange=function(e){var i=[];t.each(this.cards,function(t,s){var n="card"+t.cardId;e[n]=e[n]||new r,e[n].impart(e.list),e[n].become(t,this.options),i.push(n)},this);var s=APP.aide.reduceMotion?0:1;this.cache?this.cache.join(",")!=i.join(",")&&(this.cache=i,this._defer("animate",function(){this._classify(e.root,"is-animating"),this._yPositionCards(e),this._defer("animate",function(){this._zPositionCards(e),this._defer("animate",function(){this._declassify(e.root,"is-animating"),this._indexCards(e)}.bind(this),300*s)}.bind(this),150*s)}.bind(this))):(this.cache=i,t.try(e.list,"firstChild.offsetHeight")?(this._yPositionCards(e),this._zPositionCards(e),this._indexCards(e)):(e.list.style.setProperty("visibility","hidden"),this._defer("animate",function(){e.list.style.removeProperty("visibility"),this._yPositionCards(e),this._zPositionCards(e),this._indexCards(e)}.bind(this))))},n._yPositionCards=function(e){var i,s;t.each(e.list.children,function(e,t){s=s||e.offsetHeight,s||(s=200,this._refreshOnScreenFocus()),i=s*t,this.options.compact?i-=70*t:i+=17*t,this._styleTransform(e,"translateY("+i+"px)")},this),i||s?(e.root.style.setProperty("height",i+s+"px"),this._refreshOnLayoutChange(!0)):(e.root.style.removeProperty("height"),this._refreshOnLayoutChange(!1))},n._zPositionCards=function(e){t.each(e.list.children,function(t,i){t.style.setProperty("z-index",e.list.children.length-i)})},n._indexCards=function(e){t.each(e.list.children,function(e,t){e.style.setProperty("--card-index",t)})},n._refreshOnScreenFocus=function(){this.handlers._onScreenFocus||(this.handlers._onScreenFocus=APP.events.on("screen:focus",function(){var e=t.try(this.dom,"list.firstChild");e&&!e.offsetHeight||(e&&this.refresh(),APP.events.off(t.excise(this.handlers,"_onScreenFocus")))}.bind(this)))},n._refreshOnLayoutChange=function(e){return e?void(this.handlers._onArenaLayout||(this.handlers._onArenaLayout=APP.events.on("arena:layout",function(){if(this.isInDocument()){var e=t.try(this.dom,"list.firstChild");if(e&&!e.offsetHeight)return;if(e)return this.refresh()}APP.events.off(t.excise(this.handlers,"_onArenaLayout"))}.bind(this)))):APP.events.off(t.excise(this.handlers,"_onArenaLayout"))},s}),define("app/views/interviews/interview-ensure",["require","common","app/views/components/interviews/interview","app/views/account/library-cards-list"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("app/views/account/library-cards-list");return n.commence=function(e){return"#assuredState"},n._configure=function(e,i){var s=t.absorb(i,t.absorb(e,{}));if(this.parameters={key:s.key,title:s.title,subpath:s.subpath},s.key){var n=APP.patron.cards.filter({advantageKey:s.key});n.length?this.assign({library:n[0].library,cards:n}):this.assign({library:APP.libraries.find({baseKey:s.key})})}s.title&&this.assign({title:APP.titles.produce({titleId:s.title})}),this.assign({origination:s.origination})},n._assuredState=function(e){e.markAsRewritable(),this.assignments.library&&this.assignments.cards?t.among(this.assignments.library.card(),this.assignments.cards)?this._exitToDestination(e):this.yield("#promptToActivateCard"):!this.assignments.library&&this.parameters.key?this.yield("interview/locate-library/resolve",{parameters:{key:this.parameters.key},callback:"#exitToDestination"}):this._exitToDestination(e)},n._promptToActivateCard=function(e){e.say("ensure.prompt-to-activate-card"),e.construct("cards-list",new r),e.dom.cardsList.configure({compact:!0,activatable:!0}),e.dom.cardsList.become(this.assignments.cards),e.handlers._onCardUpdateAll=APP.events.on("card:update:all",function(){t.among(this.assignments.library.card(),this.assignments.cards)&&this.yield("#exitToDestination")}.bind(this))},n._exitToDestination=function(e){this.assignments.library&&this.assignments.title?APP.nav.go(this.assignments.title.path(this.assignments.library,this.parameters.subpath)):this.assignments.library?APP.nav.go(this.assignments.library.path(this.parameters.subpath)):APP.nav.go("")},s}),define("text!shibui/res/countries.json",[],function(){return'{ "AD": ["🇦🇩", "376", ["ca"]], "AE": ["🇦🇪", "971", ["ar"]], "AF": ["🇦🇫", "93", ["ps", "uz", "tk"]], "AG": ["🇦🇬", "1268", ["en"]], "AI": ["🇦🇮", "1264", ["en"]], "AL": ["🇦🇱", "355", ["sq"]], "AM": ["🇦🇲", "374", ["hy", "ru"]], "AO": ["🇦🇴", "244", ["pt"]], "AQ": ["🇦🇶", "672", []], "AR": ["🇦🇷", "54", ["es", "gn"]], "AS": ["🇦🇸", "1684", ["en", "sm"]], "AT": ["🇦🇹", "43", ["de"]], "AU": ["🇦🇺", "61", ["en"]], "AW": ["🇦🇼", "297", ["nl", "pa"]], "AX": ["🇦🇽", "358", ["sv"]], "AZ": ["🇦🇿", "994", ["az"]], "BA": ["🇧🇦", "387", ["bs", "hr", "sr"]], "BB": ["🇧🇧", "1246", ["en"]], "BD": ["🇧🇩", "880", ["bn"]], "BE": ["🇧🇪", "32", ["nl", "fr", "de"]], "BF": ["🇧🇫", "226", ["fr", "ff"]], "BG": ["🇧🇬", "359", ["bg"]], "BH": ["🇧🇭", "973", ["ar"]], "BI": ["🇧🇮", "257", ["fr", "rn"]], "BJ": ["🇧🇯", "229", ["fr"]], "BL": ["🇧🇱", "590", ["fr"]], "BM": ["🇧🇲", "1441", ["en"]], "BN": ["🇧🇳", "673", ["ms"]], "BO": ["🇧🇴", "591", ["es", "ay", "qu"]], "BQ": ["🇧🇶", "5997", ["nl"]], "BR": ["🇧🇷", "55", ["pt"]], "BS": ["🇧🇸", "1242", ["en"]], "BT": ["🇧🇹", "975", ["dz"]], "BV": ["🇧🇻", "47", ["no", "nb", "nn"]], "BW": ["🇧🇼", "267", ["en", "tn"]], "BY": ["🇧🇾", "375", ["be", "ru"]], "BZ": ["🇧🇿", "501", ["en", "es"]], "CA": ["🇨🇦", "1", ["en", "fr"]], "CC": ["🇨🇨", "61", ["en"]], "CD": [ "🇨🇩", "243", ["fr", "ln", "kg", "sw", "lu"] ], "CF": ["🇨🇫", "236", ["fr", "sg"]], "CG": ["🇨🇬", "242", ["fr", "ln"]], "CH": ["🇨🇭", "41", ["de", "fr", "it"]], "CI": ["🇨🇮", "225", ["fr"]], "CK": ["🇨🇰", "682", ["en"]], "CL": ["🇨🇱", "56", ["es"]], "CM": ["🇨🇲", "237", ["en", "fr"]], "CN": ["🇨🇳", "86", ["zh"]], "CO": ["🇨🇴", "57", ["es"]], "CR": ["🇨🇷", "506", ["es"]], "CU": ["🇨🇺", "53", ["es"]], "CV": ["🇨🇻", "238", ["pt"]], "CW": ["🇨🇼", "5999", ["nl", "pa", "en"]], "CX": ["🇨🇽", "61", ["en"]], "CY": ["🇨🇾", "357", ["el", "tr", "hy"]], "CZ": ["🇨🇿", "420", ["cs", "sk"]], "DE": ["🇩🇪", "49", ["de"]], "DJ": ["🇩🇯", "253", ["fr", "ar"]], "DK": ["🇩🇰", "45", ["da"]], "DM": ["🇩🇲", "1767", ["en"]], "DO": ["🇩🇴", "1809,1829,1849", ["es"]], "DZ": ["🇩🇿", "213", ["ar"]], "EC": ["🇪🇨", "593", ["es"]], "EE": ["🇪🇪", "372", ["et"]], "EG": ["🇪🇬", "20", ["ar"]], "EH": ["🇪🇭", "212", ["es"]], "ER": ["🇪🇷", "291", ["ti", "ar", "en"]], "ES": ["🇪🇸", "34", ["es", "eu", "ca", "gl", "oc"]], "ET": ["🇪🇹", "251", ["am"]], "FI": ["🇫🇮", "358", ["fi", "sv"]], "FJ": ["🇫🇯", "679", ["en", "fj", "hi", "ur"]], "FK": ["🇫🇰", "500", ["en"]], "FM": ["🇫🇲", "691", ["en"]], "FO": ["🇫🇴", "298", ["fo"]], "FR": ["🇫🇷", "33", ["fr"]], "GA": ["🇬🇦", "241", ["fr"]], "GB": ["🇬🇧", "44", ["en"]], "GD": ["🇬🇩", "1473", ["en"]], "GE": ["🇬🇪", "995", ["ka"]], "GF": ["🇬🇫", "594", ["fr"]], "GG": ["🇬🇬", "44", ["en", "fr"]], "GH": ["🇬🇭", "233", ["en"]], "GI": ["🇬🇮", "350", ["en"]], "GL": ["🇬🇱", "299", ["kl"]], "GM": ["🇬🇲", "220", ["en"]], "GN": ["🇬🇳", "224", ["fr", "ff"]], "GP": ["🇬🇵", "590", ["fr"]], "GQ": ["🇬🇶", "240", ["es", "fr"]], "GR": ["🇬🇷", "30", ["el"]], "GS": ["🇬🇸", "500", ["en"]], "GT": ["🇬🇹", "502", ["es"]], "GU": ["🇬🇺", "1671", ["en", "ch", "es"]], "GW": ["🇬🇼", "245", ["pt"]], "GY": ["🇬🇾", "592", ["en"]], "HK": ["🇭🇰", "852", ["zh", "en"]], "HM": ["🇭🇲", "61", ["en"]], "HN": ["🇭🇳", "504", ["es"]], "HR": ["🇭🇷", "385", ["hr"]], "HT": ["🇭🇹", "509", ["fr", "ht"]], "HU": ["🇭🇺", "36", ["hu"]], "ID": ["🇮🇩", "62", ["id"]], "IE": ["🇮🇪", "353", ["ga", "en"]], "IL": ["🇮🇱", "972", ["he", "ar"]], "IM": ["🇮🇲", "44", ["en", "gv"]], "IN": ["🇮🇳", "91", ["hi", "en"]], "IO": ["🇮🇴", "246", ["en"]], "IQ": ["🇮🇶", "964", ["ar", "ku"]], "IR": ["🇮🇷", "98", ["fa"]], "IS": ["🇮🇸", "354", ["is"]], "IT": ["🇮🇹", "39", ["it"]], "JE": ["🇯🇪", "44", ["en", "fr"]], "JM": ["🇯🇲", "1876", ["en"]], "JO": ["🇯🇴", "962", ["ar"]], "JP": ["🇯🇵", "81", ["ja"]], "KE": ["🇰🇪", "254", ["en", "sw"]], "KG": ["🇰🇬", "996", ["ky", "ru"]], "KH": ["🇰🇭", "855", ["km"]], "KI": ["🇰🇮", "686", ["en"]], "KM": ["🇰🇲", "269", ["ar", "fr"]], "KN": ["🇰🇳", "1869", ["en"]], "KP": ["🇰🇵", "850", ["ko"]], "KR": ["🇰🇷", "82", ["ko"]], "KW": ["🇰🇼", "965", ["ar"]], "KY": ["🇰🇾", "1345", ["en"]], "KZ": ["🇰🇿", "76,77", ["kk", "ru"]], "LA": ["🇱🇦", "856", ["lo"]], "LB": ["🇱🇧", "961", ["ar", "fr"]], "LC": ["🇱🇨", "1758", ["en"]], "LI": ["🇱🇮", "423", ["de"]], "LK": ["🇱🇰", "94", ["si", "ta"]], "LR": ["🇱🇷", "231", ["en"]], "LS": ["🇱🇸", "266", ["en", "st"]], "LT": ["🇱🇹", "370", ["lt"]], "LU": ["🇱🇺", "352", ["fr", "de", "lb"]], "LV": ["🇱🇻", "371", ["lv"]], "LY": ["🇱🇾", "218", ["ar"]], "MA": ["🇲🇦", "212", ["ar"]], "MC": ["🇲🇨", "377", ["fr"]], "MD": ["🇲🇩", "373", ["ro"]], "ME": ["🇲🇪", "382", ["sr", "bs", "sq", "hr"]], "MF": ["🇲🇫", "590", ["en", "fr", "nl"]], "MG": ["🇲🇬", "261", ["fr", "mg"]], "MH": ["🇲🇭", "692", ["en", "mh"]], "MK": ["🇲🇰", "389", ["mk"]], "ML": ["🇲🇱", "223", ["fr"]], "MM": ["🇲🇲", "95", ["my"]], "MN": ["🇲🇳", "976", ["mn"]], "MO": ["🇲🇴", "853", ["zh", "pt"]], "MP": ["🇲🇵", "1670", ["en", "ch"]], "MQ": ["🇲🇶", "596", ["fr"]], "MR": ["🇲🇷", "222", ["ar"]], "MS": ["🇲🇸", "1664", ["en"]], "MT": ["🇲🇹", "356", ["mt", "en"]], "MU": ["🇲🇺", "230", ["en"]], "MV": ["🇲🇻", "960", ["dv"]], "MW": ["🇲🇼", "265", ["en", "ny"]], "MX": ["🇲🇽", "52", ["es"]], "MY": ["🇲🇾", "60", ["ms"]], "MZ": ["🇲🇿", "258", ["pt"]], "NA": ["🇳🇦", "264", ["en", "af"]], "NC": ["🇳🇨", "687", ["fr"]], "NE": ["🇳🇪", "227", ["fr"]], "NF": ["🇳🇫", "672", ["en"]], "NG": ["🇳🇬", "234", ["en"]], "NI": ["🇳🇮", "505", ["es"]], "NL": ["🇳🇱", "31", ["nl"]], "NO": ["🇳🇴", "47", ["no", "nb", "nn"]], "NP": ["🇳🇵", "977", ["ne"]], "NR": ["🇳🇷", "674", ["en", "na"]], "NU": ["🇳🇺", "683", ["en"]], "NZ": ["🇳🇿", "64", ["en", "mi"]], "OM": ["🇴🇲", "968", ["ar"]], "PA": ["🇵🇦", "507", ["es"]], "PE": ["🇵🇪", "51", ["es"]], "PF": ["🇵🇫", "689", ["fr"]], "PG": ["🇵🇬", "675", ["en"]], "PH": ["🇵🇭", "63", ["en"]], "PK": ["🇵🇰", "92", ["en", "ur"]], "PL": ["🇵🇱", "48", ["pl"]], "PM": ["🇵🇲", "508", ["fr"]], "PN": ["🇵🇳", "64", ["en"]], "PR": ["🇵🇷", "1787,1939", ["es", "en"]], "PS": ["🇵🇸", "970", ["ar"]], "PT": ["🇵🇹", "351", ["pt"]], "PW": ["🇵🇼", "680", ["en"]], "PY": ["🇵🇾", "595", ["es", "gn"]], "QA": ["🇶🇦", "974", ["ar"]], "RE": ["🇷🇪", "262", ["fr"]], "RO": ["🇷🇴", "40", ["ro"]], "RS": ["🇷🇸", "381", ["sr"]], "RU": ["🇷🇺", "7", ["ru"]], "RW": ["🇷🇼", "250", ["rw", "en", "fr"]], "SA": ["🇸🇦", "966", ["ar"]], "SB": ["🇸🇧", "677", ["en"]], "SC": ["🇸🇨", "248", ["fr", "en"]], "SD": ["🇸🇩", "249", ["ar", "en"]], "SE": ["🇸🇪", "46", ["sv"]], "SG": ["🇸🇬", "65", ["en", "ms", "ta", "zh"]], "SH": ["🇸🇭", "290", ["en"]], "SI": ["🇸🇮", "386", ["sl"]], "SJ": ["🇸🇯", "4779", ["no"]], "SK": ["🇸🇰", "421", ["sk"]], "SL": ["🇸🇱", "232", ["en"]], "SM": ["🇸🇲", "378", ["it"]], "SN": ["🇸🇳", "221", ["fr"]], "SO": ["🇸🇴", "252", ["so", "ar"]], "SR": ["🇸🇷", "597", ["nl"]], "SS": ["🇸🇸", "211", ["en"]], "ST": ["🇸🇹", "239", ["pt"]], "SV": ["🇸🇻", "503", ["es"]], "SX": ["🇸🇽", "1721", ["nl", "en"]], "SY": ["🇸🇾", "963", ["ar"]], "SZ": ["🇸🇿", "268", ["en", "ss"]], "TC": ["🇹🇨", "1649", ["en"]], "TD": ["🇹🇩", "235", ["fr", "ar"]], "TF": ["🇹🇫", "262", ["fr"]], "TG": ["🇹🇬", "228", ["fr"]], "TH": ["🇹🇭", "66", ["th"]], "TJ": ["🇹🇯", "992", ["tg", "ru"]], "TK": ["🇹🇰", "690", ["en"]], "TL": ["🇹🇱", "670", ["pt"]], "TM": ["🇹🇲", "993", ["tk", "ru"]], "TN": ["🇹🇳", "216", ["ar"]], "TO": ["🇹🇴", "676", ["en", "to"]], "TR": ["🇹🇷", "90", ["tr"]], "TT": ["🇹🇹", "1868", ["en"]], "TV": ["🇹🇻", "688", ["en"]], "TW": ["🇹🇼", "886", ["zh"]], "TZ": ["🇹🇿", "255", ["sw", "en"]], "UA": ["🇺🇦", "380", ["uk"]], "UG": ["🇺🇬", "256", ["en", "sw"]], "UM": ["🇺🇲", "1", ["en"]], "US": ["🇺🇸", "1", ["en"]], "UY": ["🇺🇾", "598", ["es"]], "UZ": ["🇺🇿", "998", ["uz", "ru"]], "VA": ["🇻🇦", "39066,379", ["it", "la"]], "VC": ["🇻🇨", "1784", ["en"]], "VE": ["🇻🇪", "58", ["es"]], "VG": ["🇻🇬", "1284", ["en"]], "VI": ["🇻🇮", "1340", ["en"]], "VN": ["🇻🇳", "84", ["vi"]], "VU": ["🇻🇺", "678", ["bi", "en", "fr"]], "WF": ["🇼🇫", "681", ["fr"]], "WS": ["🇼🇸", "685", ["sm", "en"]], "XK": ["🇽🇰", "377,381,383,386", ["sq", "sr"]], "YE": ["🇾🇪", "967", ["ar"]], "YT": ["🇾🇹", "262", ["fr"]], "ZA": [ "🇿🇦", "27", ["af", "en", "nr", "st", "ss", "tn", "ts", "ve", "xh", "zu"] ], "ZM": ["🇿🇲", "260", ["en"]], "ZW": ["🇿🇼", "263", ["en", "sn", "nd"]] }'}),define("shibui/src/components/form-input-phone-number",["require","common","./form-input","text!shibui/res/countries.json"],function(e){var t=e("common"),i=e("./form-input"),s=i.new(),n=s.prototype;return n.PATTERN_COUNTRY_CODE="\\+\\d+",n.PATTERN_PHONE_NUMBER="[\\d\\-\\(\\)\\.\\s]+",n.COUNTRIES=JSON.parse(e("text!shibui/res/countries.json")),n.value=function(){return this.dom.countryCodeControl.value+" "+this.dom.control.value},n.setValue=function(e){var i,s=(e||"").trim(),n=this._possibleCountries();if(0==s.indexOf("+")){var r=s.indexOf(" ");if(r>0&&r<=4){var o=s.substr(0,r);t.each(this.COUNTRIES,function(e,n){"+"+n[1]==o&&(i=o,s=s.substr(r+1),t.breakIteration())})}i||(t.each(n,function(e,t){var n="+"+t[1];0==s.indexOf(n)&&(i=n)},this),i&&(s=s.substr(i.length).trim()))}if(!i&&this.options.countryCodes){var a=n[this.options.countryCodes[0]];
a&&(i="+"+a[1])}i||(i="+1"),s=s.replace("+",""),10==s.length&&(s=[s.substring(0,3),s.substring(3,6),s.substring(6)].join(" ")),this.dom.control.value=s,this._setCountryCode(i)},n.blur=function(){i.prototype.blur.apply(this,arguments),this.dom.countryCodeControl&&this.dom.countryCodeControl.blur()},n._expandOptions=function(e){return i.prototype._expandOptions.call(this,t.absorb(e,{type:"tel",lines:1,attributes:{autocomplete:"mobile tel-national tel",pattern:this.PATTERN_PHONE_NUMBER,"data-validation":"phone"}}))},n._layout=function(e){i.prototype._layout.apply(this,arguments),this._build("shibui-form-input-phone-number",{extending:e,classes:"shibui-form-input-phone-number"}," hidden-submit .shibui-form-field-hidden-submit <input>",{type:"submit",skip:this.options.form}),this._build("",{extending:e,element:e.rim,extensionClass:"shibui-form-input-phone-number"}," country-code",{pos:"prepend"},"  country-code-flag","  country-code-control <input>",{id:!0,spoken:"form.phone-number.country-code",attributes:{type:"tel",autocomplete:"mobile tel-country-code",minlength:2,maxlength:6,required:!0,pattern:this.PATTERN_COUNTRY_CODE,"aria-describedby":t.try(e,"explanation.id")}})},n._listen=function(e,t){i.prototype._listen.apply(this,arguments),this._handleTap(t.countryCode)},n._onTapCountryCode=function(e){this.dom.countryCodeControl.blur(),APP.arena.popover(this.dom.countryCode).choices(function(e){var i=this.dom.countryCodeControl.value.trim(),s=[];t.each(this._possibleCountries(),function(e,i){var n=i[1].split(","),r=this._phrase("country.name."+e);t.each(n,function(e){s.push([i[0],parseFloat(e),r])})},this),s.sort(function(e,t){return e[1]==t[1]?e[2]>t[2]?-1:1:e[1]<t[1]?-1:1}),t.each(s,function(t){var s="+"+t[1];e.choice({html:function(e){this._build("",{tag:"span",parentNode:e}," shibui-form-input-phone-number-country-code-flag <code>",{html:t[0]}," <span>",{html:s}," <span>",{html:t[2]})}.bind(this),classes:"shibui-form-input-phone-number-country-choice"+(s==i?" innate":""),button:this._setCountryCode.bind(this,s,t[0])})},this)}.bind(this))},n._possibleCountries=function(){if(!this.options.countryCodes)return this.COUNTRIES;var e={};return t.each(this.options.countryCodes,function(t){t=t.toUpperCase();var i=this.COUNTRIES[t];i?e[t]=i:console.warn("[SHIBUI] phone input field -- country not found:",t)},this),e},n._setCountryCode=function(e,i){if(this.dom.countryCodeControl.value=e,this.dom.countryCodeControl.style.setProperty("width",.6*(e.length+1)+"em"),!i){var s=e.replace(/[^\d]/g,"");t.each(this.COUNTRIES,function(e,t){var n=t[1].split(",");n.indexOf(s)>=0&&(i=t[0])})}this.dom.countryCodeFlag.innerHTML=i},s}),define("shibui/src/components/form-input-email-address",["require","common","./form-input"],function(e){var t=e("common"),i=e("./form-input"),s=i.new(),n=s.prototype;return n.PATTERN_EMAIL_ADDRESS="[^@\\s]+@[^@\\s]+\\.[^@\\s]+",n._expandOptions=function(e){return i.prototype._expandOptions.call(this,t.absorb(e,{type:"email",lines:1,explanation:"form.email-address.age-disclaimer",placeholder:"form.email-address.placeholder"}))},n._layout=function(e){i.prototype._layout.apply(this,arguments),this._classify(e.root,"shibui-form-input-email-address"),this._attr(e.control,"pattern",this.PATTERN_EMAIL_ADDRESS),this._attr(e.control,"data-validation","email")},n._listen=function(e,t){i.prototype._listen.apply(this,arguments),this.on("form:field:blur",this._fixObviousMistakesInEmailAddress.bind(this)),this.on("form:field:enter",this._fixObviousMistakesInEmailAddress.bind(this))},n._fixObviousMistakesInEmailAddress=function(){var e=this.value().trim();e.match(/@gmail$/)&&this._.fixedEmailAddress!=e&&(this._.fixedEmailAddress=e,this.setValue(e+".com"),this.validate({ambient:!0}),this._dispatchFieldEvent("change"))},s}),define("app/views/components/interviews/interview-quote",["require","common","app/views/core/partial","app/views/components/library/library-logo"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/components/library/library-logo");return n.$init=function(e,i){this.message=e,this.options=t.absorb(i,{})},n._layout=function(e){this._build("interview-quote <blockquote>",{extending:e}," mark <figure>",{html:"“",access:"visual"}," text <p>",{html:t.safe(this.message)}," logo",{construct:r,skip:!this.options.library}),t.try(e.logo,"become()",this.options.library),this.options.quotable&&"string"==typeof this.options.quotable&&this._semaphore("quotable",this.options.quotable)},s}),define("app/views/interviews/authenticate/interview-authenticate-card",["require","common","app/views/components/interviews/interview","app/views/core/block-strap","shibui/src/components/form-input","shibui/src/components/form-input-phone-number","shibui/src/components/form-input-email-address","app/views/account/library-cards-list","app/views/account/library-card-icon","app/views/components/interviews/interview-quote"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("app/views/core/block-strap"),o=e("shibui/src/components/form-input"),a=e("shibui/src/components/form-input-phone-number"),l=e("shibui/src/components/form-input-email-address"),c=e("app/views/account/library-cards-list"),h=e("app/views/account/library-card-icon"),u=e("app/views/components/interviews/interview-quote");return n.commence=function(e){return this.assignments.library||!this.parameters.key&&!this.parameters.websiteId?(this.assignments.library||this.assign({library:APP.library}),this.assignments.library?"#fetchForms":"#missingArgs"):(this._saveState(),{path:"interview/locate-library/resolve",parameters:{websiteId:this.parameters.websiteId,key:this.parameters.key},callback:!0})},n._configure=function(e,i){this.parameters={continuation:i.continuation,captcha:i.captcha},t.excise(this.assignments,"websiteId"),t.excise(this.assignments,"key");var s=t.absorb(e,t.absorb(i,{}));s.origination&&(t.excise(this.assignments,"origination"),this.parameters.origination=s.origination),s.intent&&(t.excise(this.assignments,"intent"),this.parameters.intent=s.intent),!this.assignments.possession&&s.psnKey&&this.assign({possession:APP.patron.loans.find({psnKey:s.psnKey})||APP.patron.holds.find({psnKey:s.psnKey})}),this.assignments.possession&&(this.parameters.psnKey=this.assignments.possession.psnKey,this.assign({card:this.assignments.possession.card})),!this.assignments.card&&s.cardId&&this.assign({card:APP.patron.cards.find({cardId:s.cardId})}),this.assignments.card&&(this.parameters.cardId=this.assignments.card.cardId,this.assign({library:this.assignments.card.library})),t.absorb(this._extractLibraryParameters(this.assignments,i),this.parameters),this.assign(t.absorb(APP.bank.get("auth:assignments:restore"),{userIdentifierKey:"username",userIdentifier:""})),APP.bank.set("auth:assignments:restore"),!this.parameters.captcha&&this.assignments.captcha&&(this.parameters.captcha=t.excise(this.assignments,"captcha"))},n._listen=function(e,t){i.prototype._listen.apply(this,arguments),e._onAuthenticatedElsewhere=APP.events.on("card:authenticated",function(e){var t=e.m.card;t.library==this.assignments.library&&(this.parameters.cardId&&t.cardId!=this.parameters.cardId||this.yield("#authenticatedElsewhere",{card:t}))}.bind(this))},n._authenticatedElsewhere=function(e){e.say("authenticate.success.elsewhere"),this._presentCard(e)},n._fetchForms=function(e){return e.spin(),this.assignments.ilsAnswers?this._continueWithForms():void this.assignments.library.use(function(e,t){if(e.isIdeal){var i={};APP.events.dispatch("auth:forms:params",{params:i}),APP.sentry.authenticationForms(t,i,this._parseForms.bind(this),this.thenYield("#failedForms"))}else e.isBroken?this.yield("#failedForms"):t.reuse()},this)},n._parseForms=function(e){try{var i=JSON.parse(e);APP.events.dispatch("auth:forms:result",{result:i}),this.assign({ilsList:t.try(i,"forms")||[],recaptchaSiteKey:t.try(i,"captcha.key")});var s=t.try(i,"getACard.primary");s&&(s.type=s.type||"MobileCode",this.assignments.ilsList.unshift(s))}catch(e){return APP.journal.warn("[AUTH] error parsing forms:",e),this.yield("#failedForms")}var n=function(e){if(!this.assignments.library.branch||!e.displayName)return!1;var t=this.assignments.library.branch.name,i=e.displayName.slice(0,t.length);return t==i}.bind(this),r={home:[],idc:[],rla:[],homeCount:0,idcCount:0,idcCountWithRegistration:0,rlaCount:0,ilsCount:0,ghost:null,branch:null,isComplex:!1,isIDCExclusive:!1},o={};t.each(this.assignments.ilsList,function(e){r.ilsCount+=1;var t={ilsType:e.type,html:e.displayName||e.ilsName,ils:e};if(e.isGhost)r.ghost=t;else if(e.visitorHomeWebsiteId){var i=e.visitorHomeWebsiteId,s=o[i];s||(s=o[i]={websiteId:i,answers:[]},r.rla.push(s)),s.answers.push(t),r.rlaCount+=1}else["MobileCode","EmailRegistration"].indexOf(e.type)>=0?(t.withRegistration=t.ils.signUp!==!1,r.idc.push(t),r.idcCount+=1,r.idcCountWithRegistration+=t.withRegistration?1:0):(r.home.push(t),r.homeCount+=1);!r.branch&&n(e)&&(r.branch=t)},this),r.homeCount>3&&(r.isComplex=!0),r.rlaCount>1&&(r.isComplex=!0),r.isIDCExclusive=r.idcCount&&!r.homeCount&&!r.rlaCount,this.assign({ilsAnswers:r}),this.assignments.card&&t.each(this.assignments.ilsList,function(e){e.ilsName==this.assignments.card.ilsName&&this.assign({ils:e})},this),this._continueWithForms()},n._continueWithForms=function(){this.parameters.continuation?this.yield("#ilsIsExternalAndContinuing"):this.parameters.captcha?this.yield("#ilsIsLocalAndCaptchaSolved"):"create"==this.parameters.intent?this.yield("#iWouldLikeACard"):this.assignments.ilsAnswers.ilsCount?this.assignments.card?this.assignments.ils&&"verify"==this.parameters.intent?this._continueWithILS():this.assignments.ils?this.yield("#verifyCard"):this._continueWithIntentToLogin():"login"==this.parameters.intent?this._continueWithIntentToLogin():this.yield("#discoverIntent"):this.yield("#failedForms")},n._continueWithIntentToLogin=function(){var e=this.assignments.ilsAnswers;if(e.isIDCExclusive)this.yield("#iWouldLikeACard");else if(1==e.homeCount&&0==e.rlaCount)this._continueWithILS(this.assignments.ilsAnswers.home[0].ils);else if(this.assignments.inline&&e.isComplex){var i=t.absorb({inline:!1,intent:"login"},t.absorb(this.assignments,{})),s=t.absorb(this.parameters,{origination:APP.router.route.path});i.callback=function(e){APP.nav.go(s.origination),this._completeAuthentication(t.try(e,"card")||null)}.bind(this),APP.interviews.go("interview/authenticate/card",i,s)}else this.yield("#chooseILS")},n._continueWithILS=function(e){"undefined"!=typeof e&&this.assign({ils:e});var t=this.assignments.ils.type;"Local"==t?this.yield("#ilsIsLocal"):"Moved"==t?this.yield("#ilsIsMoved"):"MobileCode"==t?this.yield("#ilsIsMobile"):"EmailRegistration"==t?this.yield("#ilsIsEmail"):this.yield("#ilsIsExternal")},n._failedForms=function(e){e.say("authenticate.failure.auth-forms"),this._suggestHelpOrRetry(e)},n._discoverIntent=function(e){var i=this.assignments.ilsAnswers||{};e.markAsRewritable(e.name);var s="authenticate.intro",n=t.try(this.parameters.intent,"match()",/^ask:(.+)/);if(n&&(s+="."+n[1]),this.assignments.returning&&(s="authenticate.return.card-acquisition",delete this.assignments.returning),e.say({label:s,substitutions:{LIBRARY_NAME:this.assignments.library.safeName()}}),e.answer({label:"authenticate.response.show-form",button:this._continueWithIntentToLogin.bind(this)}).emphasize(),!i.isIDCExclusive){var r=this.assignments.library;(i.ghost||i.idcCountWithRegistration||r.urls.cardAcquisition||!t.among(r.type,"Corporate Library","College Library"))&&e.answer({label:"authenticate.response.need-card",yield:"#iWouldLikeACard"})}},n._iWouldLikeACard=function(e){var i={LIBRARY_NAME:this.assignments.library.safeName()};this.assignments.ilsAnswers.idcCountWithRegistration?(e.say({label:"authenticate.idc.exclusive",substitutions:i}),t.each(this.assignments.ilsAnswers.idc,function(i,s){if(i.withRegistration){var n=t.dasherize(i.ilsType);e.answer({label:"authenticate.idc.response."+n,button:this._continueWithILS.bind(this,i.ils)}).indicator({icon:{"mobile-code":"answer-code","email-registration":"answer-email"}[n]}).explanation("authenticate.idc.explain."+(s?"also.":"")+n)}},this)):this.assignments.library.urls.cardAcquisition?(e.say({label:"authenticate.suggest.card-acquisition",substitutions:i}),e.answer({label:"authenticate.response.card-acquisition",yield:"#openCardAcquisitionURL"}).explanation("authenticate.explain.card-acquisition")):(e.say("authenticate.sign-up-branch.1"),e.answer({label:"authenticate.sign-up-branch.response.branch-map",button:function(){APP.interviews.go("interview/locate-library/branches",{library:this.assignments.library})}.bind(this)}).explanation("authenticate.sign-up-branch.2")),this.assignments.ilsAnswers.ghost&&e.answer({label:"authenticate.idc.response.ghost",button:this._continueWithILS.bind(this,this.assignments.ilsAnswers.ghost.ils)}).indicator({icon:"ghost-authentication"}).explanation("authenticate.idc.explain.ghost").emphasize("turquoise")},n._openCardAcquisitionURL=function(e){e.spin(),APP.shell.openURL(this.assignments.library.urls.cardAcquisition),this._defer(this.thenYield("#discoverIntent",{returning:!0}),2e3)},n._verifyCard=function(e){e.say("authenticate.intro.verify"),this._showCard(e,this.assignments.card),e.answer({label:"library-card.action.verify",button:this._continueWithILS.bind(this,this.assignments.ils)}).emphasize()},n._chooseILS=function(e){var i=this.assignments.ilsAnswers,s=i.homeCount>=7,n=3;if(i.homeCount){e.say({label:"authenticate.intro.choose-ils"}),e.construct("home-list-promoted",this._element({tag:"ul",classes:"auth-ils-list auth-ils-list-home"})),e.construct("home-list-expanded",this._element({tag:"ul",classes:"auth-ils-list auth-ils-list-home"})),e.construct("home-list-expando",this._element());var o=i.home.slice(0),a=i.branch||1==o.length&&o[0];a&&(t.excise(o,a),n-=1,this._build("",{tag:"li",parentNode:e.dom.homeListPromoted}," ils-choice-button",{button:this._continueWithILS.bind(this,a.ils)},"  ils-choice-star",{icon:"star-indicator"},"  <span>",{html:a.html},"  <span>",{describing:"ils-choice-button",access:["spoken",{"aria-hidden":"true"}],label:"authenticate-card.ils-choice.best-answer"})),t.each(o,function(t,i){var r=e.dom.homeListPromoted;s&&i>=n&&(r=e.dom.homeListExpanded),this._element({button:this._continueWithILS.bind(this,t.ils),html:t.html,parentNode:this._element({tag:"li",parentNode:r})})},this),this._configureILSExpando(e.dom.homeListExpando,e.dom.homeListPromoted,e.dom.homeListExpanded)}if(i.rlaCount){e.construct("strap-rla",new r),e.dom.strapRla.configure({text:"authenticate.rla.head"}),e.construct("whisper-rla",this._element({tag:"p",classes:"auth-rla-explanation",label:"authenticate.rla.explain"})),e.construct("rla-list-promoted",this._element({tag:"ul",classes:"auth-ils-list auth-ils-list-rla"})),e.construct("rla-list-expanded",this._element({tag:"ul",classes:"auth-ils-list auth-ils-list-rla"})),e.construct("rla-list-expando",this._element()),t.each(i.rla,function(e){delete e.library});var l=function(s){var n=!0;if(t.each(i.rla,function(e){e.websiteId==s.websiteId&&(e.library=s),e.library||(n=!1)},this),!n)return!1;var r=[],o=[];t.each(i.rla,function(e){var i=e.library.cards();t.each(e.answers,function(e){var s=null;t.each(i,function(t){t.ilsName==e.ils.ilsName&&(s=t)});var n=this._element({button:this._continueWithILS.bind(this,e.ils),html:e.html,wrapper:"div"});s?(this._element({html:s.safeName(),classes:"auth-ils-list-card-name",parentNode:n}),new h(n).become({card:s}),r.push(n)):o.push(n)},this)},this),r.length?(t.each(r,function(t){var i=e.dom.rlaListPromoted;this._element({tag:"li",parentNode:i}).appendChild(t)},this),t.each(o,function(t){var i=e.dom.rlaListExpanded;this._element({tag:"li",parentNode:i}).appendChild(t)},this)):t.each(o,function(t,i){var s=e.dom.rlaListExpanded;(i<3||o.length<7)&&(s=e.dom.rlaListPromoted),this._element({tag:"li",parentNode:s}).appendChild(t)},this),this._configureILSExpando(e.dom.rlaListExpando,e.dom.rlaListPromoted,e.dom.rlaListExpanded)}.bind(this);t.each(i.rla,function(e){var t=APP.libraries.produce({websiteId:e.websiteId});t.use(function(e){t.safeName()?l(t):t.reuse()})})}s&&e.answer({label:"authenticate.response.help-ils",button:this._yieldToHelpInterview.bind(this)}).indicator({icon:"answer-contact"}).explanation({label:"authenticate.explain.help-ils"})},n._configureILSExpando=function(e,t,i){if(this._classify(e,"auth-ils-expando"),t.children.length&&i.children.length){var s,n=!0,r=function(){n?(this._classify(i,"is-collapsed"),this._textify(s,{label:"authenticate.ils-list.expand",substitutions:{ILS_COUNT:i.children.length}})):(this._declassify(i,"is-collapsed"),this._textify(s,"authenticate.ils-list.collapse"),this._focusElement(i.querySelector("button"))),n=!n,APP.events.dispatch("halos:refresh")}.bind(this);return s=this._element({button:r,parentNode:e,classes:"shibui-button"}),r(),s}},n._ilsIsLocal=function(e){this._markEpisodeAsRetryable(e),this.assign({localPhase:null}),e.say({label:"authenticate.intro.form"+(this.assignments.ils.loginHintUrl?".with-link":""),enliven:{"#help":this._yieldToHelpInterview.bind(this),"#login-hint":APP.shell.bindOpenURL(this.assignments.ils.loginHintUrl)}});var i=this._validateLocalUserData.bind(this,e);this._form(e,"local-credentials-form",i);var s=(this.assignments.card||{}).username;t.try(this.assignments.card,"mergedCardIds.length")&&(s=null);var n=[t.try(this.assignments.ils,"local.username.key"),"card-number"];if(this._field(e,"username-field",n,{value:s,attributes:{autocorrect:"off",autocapitalize:"none",autocomplete:"username"},form:e.dom.localCredentialsForm}),t.try(this.assignments.ils,"local.password.enabled")){n=[this.assignments.ils.local.password.key,"pin"],this._field(e,"password-field",n,{type:"password",required:!1,attributes:{autocomplete:"current-password"},form:e.dom.localCredentialsForm}),e.dom.usernameField.on("form:field:tab",function(t){1==this.assignments.localPhase&&e.dom.usernameField.validate()&&(t.m.event.preventDefault(),i())}.bind(this));var r,o=function(){clearTimeout(r),r=setTimeout(function(){e.dom.passwordField.value()&&this._updateLocalPhase(e,2)}.bind(this),20)}.bind(this);e.dom.passwordField.on("form:field:focus",function(){document.querySelector(".auth-field-hide-except-to-password-managers")&&i()}),e.dom.passwordField.on("form:field:change:immediate",o),e.dom.usernameField.on("form:field:change:immediate",o)}else delete e.dom.passwordField;e.dom.submitButton=e.answer({label:"blank",button:i}).emphasize().compact();var a=e.dom.passwordField&&s?2:1;this._updateLocalPhase(e,a)},n._validateLocalUserData=function(e){var i={username:e.dom.usernameField.validate()};2==this.assignments.localPhase&&e.dom.passwordField&&(i.password=e.dom.passwordField.validate()),i.username!==!0?e.dom.usernameField.focus():1==this.assignments.localPhase&&e.dom.passwordField?this._updateLocalPhase(e,2,!0):i.password!==!1&&(e.dom.usernameField.blur(),e.dom.passwordField&&e.dom.passwordField.blur(),this.yield("#ilsIsLocalAndSubmitting",{userIdentifierKey:"username",userIdentifier:e.dom.usernameField.value(),password:t.try(e.dom.passwordField,"value()")}))},n._updateLocalPhase=function(e,i,s){if(this.assignments.localPhase!=i){var n=e.dom.usernameField.dom.explanation,r=t.try(e.dom.passwordField,"dom.root");2==i?(this.assign({localPhase:2}),n&&this._classify(n,"hide"),r&&(r.classList.remove("auth-field-hide-except-to-password-managers"),this.access(r,"normal")),setTimeout(function(){e.dom.passwordField.dom.control.required=!0,s&&e.dom.passwordField.focus()}.bind(this),100)):(this.assign({localPhase:1}),n&&n.classList.remove("hide"),r&&(r.classList.add("auth-field-hide-except-to-password-managers"),this.access(r,"inert")),s&&e.dom.usernameField.focus()),2!=i&&e.dom.passwordField?e.dom.submitButton.label("mascot.next"):e.dom.submitButton.label("authenticate.response.sign-in")}},n._ilsIsLocalAndSubmitting=function(e){e.say("authenticate.pending"),e.spin();var i={};i.ils=this.assignments.ils.ilsName,i[this.assignments.userIdentifierKey]=this.assignments.userIdentifier,i.password=this.assignments.password,i.captcha=t.excise(this.parameters,"captcha"),APP.sentry.submitLocalAuthentication(this.assignments.library,i,this._parseCardSynchronizationData.bind(this),this._parseLocalFailure.bind(this))},n._parseLocalFailure=function(e){var i=t.try(e,"response");APP.journal.warn("[AUTH] parseLocalFailure",i);var s=t.try(i,"result"),n=t.try(i,"upstream")||{};"communication_failure"==s?this.yield("#ilsIsLocalAndCommunicationFailed"):"captcha_required"==s?this.yield("#ilsIsLocalAndCaptchaRequired"):this.yield("#ilsIsLocalAndCredentialsFailed",{failureExplanation:t.safe(n.userExplanation||"")})},n._ilsIsLocalAndCaptchaRequired=function(e){e.say("authenticate.pending"),e.spin(),this._saveState(),APP.shell.oauthRequest({navigate:t.parameterizeURL(APP.services.sentry.pathToURL("auth/captcha"),{key:this.assignments.recaptchaSiteKey}),callback:t.parameterizeURL("interview/authenticate/card",{key:this.assignments.library.baseKey,cardId:t.try(this.assignments.card,"cardId"),origination:this.parameters.origination||APP.router.route.path}),onSuccess:function(e){this.parameters.captcha=e.captcha,this.yield("#ilsIsLocalAndCaptchaSolved")}.bind(this),onFailure:this._parseLocalFailure.bind(this)})},n._ilsIsLocalAndCaptchaSolved=function(e){this.assignments.userIdentifierKey?this._ilsIsLocalAndSubmitting(e):this.yield("#ilsIsLocal")},n._ilsIsLocalAndCommunicationFailed=function(e){e.say("authenticate.failure.comms"),this._markEpisodeAsRetryable(e,{retryEpisode:"#ilsIsLocal"}),this._suggestHelpOrRetry(e)},n._ilsIsLocalAndCredentialsFailed=function(e){this.assignments.failureExplanation?(e.say("authenticate.failure.sign-in.explained"),e.construct("error-quote",new u(this.assignments.failureExplanation,{library:this.assignments.library}))):e.say("authenticate.failure.sign-in"),this._suggestHelpOrRetry(e)},n._ilsIsMoved=function(e){e.spin();var i=t.try(this.assignments.ils,"moved.websiteId");return i?void APP.libraries.produce({websiteId:i}).use(function(e,t){e.isBroken?this.yield("#ilsIsMovedAndRetry"):t.key()?this.yield("#ilsIsMovedToLibrary",{redirect:t}):t.reuse()},this):this.yield("#ilsIsMovedAndRetry")},n._ilsIsMovedAndRetry=function(e){e.say({label:"authenticate.moved.failure",enliven:{"#request-help":this._yieldToSupportRequestInterview.bind(this)}}),e.markAsRewritable(),e.response("mascot.retry","#ilsIsMoved","emph")},n._ilsIsMovedToLibrary=function(e){var t=this.assignments.redirect;e.say({label:"authenticate.moved",substitutions:{LIBRARY_NAME:t.safeName()}}),e.response({html:t.safeName()},this._ilsIsMovedAndExitToLibrary.bind(this,t),"emph")},n._ilsIsMovedAndExitToLibrary=function(e){t.each(this.assignments.library.cards(),function(e){e.ilsName==this.assignments.ils.ilsName&&APP.sentry.unlinkCard(e)},this),APP.nav.go(e.path())},n._ilsIsMobile=function(e){this._markEpisodeAsRetryable(e),e.say("authenticate.intro.mobile-code");var t=this._ilsIsInstantAndValidate.bind(this,e);e.construct("mobile-number-field",new a({placeholder:"authenticate.field.mobile-number",explanation:"authenticate.field.mobile-number.explanation",countryCodes:this.assignments.ils.phoneCountryCodes,value:(this.assignments.card||{}).cardName||"",required:!0})),e.dom.mobileNumberField.on("form:field:submit",t),e.answer({next:t}).emphasize()},n._ilsIsEmail=function(e){this._markEpisodeAsRetryable(e),e.say("authenticate.intro.email-registration");var t=this._ilsIsInstantAndValidate.bind(this,e);e.construct("email-address-field",new l({placeholder:"authenticate.field.email-address",explanation:"email-address.age-disclaimer",value:(this.assignments.card||{}).cardName||"",required:!0})),e.dom.emailAddressField.on("form:field:submit",t),e.answer({next:t}).emphasize()},n._ilsIsInstantAndValidate=function(e){this._isEpisodeValid(e)&&(e.dom.mobileNumberField?this.yield("#ilsIsInstantAndSubmittingIdentification",{userIdentifierKey:"phone_number",userIdentifier:e.dom.mobileNumberField.value()}):e.dom.emailAddressField&&this.yield("#ilsIsInstantAndSubmittingIdentification",{userIdentifierKey:"email_address",userIdentifier:e.dom.emailAddressField.value()}))},n._ilsIsInstantAndSubmittingIdentification=function(e){e.say("authenticate.pending"),e.spin();var t={};t.ils=this.assignments.ils.ilsName,t[this.assignments.userIdentifierKey]=this.assignments.userIdentifier,APP.sentry.submitIDCIdentification(this.assignments.library,t,this.thenYield("#ilsIsInstantAndAwaitingCode"),this.thenYield("#ilsIsInstantAndFailed"))},n._ilsIsInstantAndAwaitingCode=function(e){e.say("authenticate.field.security-code."+t.dasherize(this.assignments.ils.type));var i=function(){this._isEpisodeValid(e)&&this.yield("#ilsIsInstantAndSubmittingCode",{securityCode:e.dom.securityCodeField.value()})}.bind(this);this._field(e,"security-code-field","security-code",{type:"tel",explanation:null,attributes:{autocorrect:"off",autocomplete:"one-time-code"}}),e.dom.securityCodeField.on("form:field:submit",i),e.response("authenticate.response.sign-in",i,"emph")},n._ilsIsInstantAndSubmittingCode=function(e){e.say("authenticate.pending"),e.spin();var t={};t.ils=this.assignments.ils.ilsName,t[this.assignments.userIdentifierKey]=this.assignments.userIdentifier,t.security_code=this.assignments.securityCode,APP.sentry.submitIDCIdentification(this.assignments.library,t,this._parseCardSynchronizationData.bind(this),this._parseInstantFailure.bind(this))},n._ilsIsInstantAndRequiresRegistration=function(e){this._markEpisodeAsRetryable(e),e.say("authenticate.intro.register");var t=this._validateInstantUserData.bind(this,e);this._form(e,"idc-registration-form",t),this._classify(e.dom.idcRegistrationForm,"authenticate-idc-registration-form"),this._.registrationFields=this._registrationFields(e,e.dom.idcRegistrationForm,this.assignments.registrationFieldNames.required,this.assignments.registrationFieldValues,!0),this.assignments.registrationFieldNames.optional?e.answer({next:t}).emphasize():(e.say({label:"authenticate.intro.register.legal",enliven:{"#terms":APP.shell.bindOpenURL(APP.constants.URLS.terms),"#privacy":APP.shell.bindOpenURL(APP.constants.URLS.privacy)}}),e.response("authenticate.response.sign-up",t,"emph"))},n._ilsIsInstantAndHasOptionalFields=function(e){e.say("authenticate.intro.register.optional-fields");var i=(this._ilsIsInstantAndRegistering,this._validateInstantUserData.bind(this,e));this._form(e,"idc-optional-fields-form",i),this._classify(e.dom.idcOptionalFieldsForm,"authenticate-idc-registration-form"),t.absorb(this._registrationFields(e,e.dom.idcOptionalFieldsForm,this.assignments.registrationFieldNames.optional,this.assignments.registrationFieldValues,!1),this._.registrationFields),e.say({label:"authenticate.intro.register.legal",enliven:{"#terms":APP.shell.bindOpenURL(APP.constants.URLS.terms),"#privacy":APP.shell.bindOpenURL(APP.constants.URLS.privacy)}}),e.response("authenticate.response.sign-up",i,"emph")},n._validateInstantUserData=function(e){this._isEpisodeValid(e)&&(e.dom.idcRegistrationForm&&this.assignments.registrationFieldNames.optional?this.yield("#ilsIsInstantAndHasOptionalFields"):this.yield("#ilsIsInstantAndRegistering"))},n._ilsIsInstantAndRegistering=function(e){e.say("authenticate.pending"),e.spin();var i={};t.each(this._.registrationFields,function(e,t){"function"==typeof t.value?i[e]=t.value():i[e]=t.value});var s={};s.ils=this.assignments.ils.ilsName,s.card_name=this.assignments.userIdentifier,s.user_data=i,APP.sentry.registerForIDC(this.assignments.library,s,this._parseCardSynchronizationData.bind(this),this._parseInstantFailure.bind(this))},n._parseInstantFailure=function(e){var i=t.try(e,"response.result");"idc_registration_required"==i?this.yield("#ilsIsInstantAndRequiresRegistration",{registrationFieldNames:e.response.fields,registrationFieldValues:e.response.values}):this.yield("#ilsIsInstantAndFailed")},n._ilsIsInstantAndFailed=function(e){var i=t.dasherize(this.assignments.ils.type);e.say("authenticate.failure."+i),this._suggestHelpOrRetry(e)},n._ilsIsExternal=function(e){this.assignments.card&&this.assignments.ils?this._ilsIsExternalAndCommencing(e):this._ilsIsExternalAndForeshadowing(e)},n._ilsIsExternalAndForeshadowing=function(e){e.say("authenticate.intro.external"),e.answer({next:"#ilsIsExternalAndCommencing"}).emphasize()},n._ilsIsExternalAndCreating=function(e){e.spin(),this._commenceExternalAuthentication({intent:"create"})},n._ilsIsExternalAndCommencing=function(e){e.spin(),this._commenceExternalAuthentication()},n._ilsIsExternalAndContinuing=function(e){e.say("authenticate.pending"),e.spin(),APP.patron.sync._.sentryJob=APP.sentry.completeExternalAuthentication(this.parameters.continuation,this._parseCardSynchronizationData.bind(this),this._parseExternalFailure.bind(this))},n._parseExternalFailure=function(e){this.yield("#ilsIsExternalAndFailed",{failureResult:t.try(e,"response.result"),failureState:t.try(e,"response.state")})},n._ilsIsExternalAndFailed=function(e){var t=this.assignments.failureResult,i=this.assignments.failureState;i&&i.instant_digital_card?this._markEpisodeAsRetryable(e,{retryEpisode:"#ilsIsExternalAndCreating"}):this._markEpisodeAsRetryable(e,{retryEpisode:"#ilsIsExternalAndCommencing"}),"authentication_canceled"==t?e.say("authenticate.failure.canceled"):"create"==this.parameters.intent?e.say("authenticate.failure.mobile"):e.say("authenticate.failure.sign-in"),this._suggestHelpOrRetry(e)},n._parseCardSynchronizationData=function(e){APP.sentry.removeJobFromQueue(APP.patron.sync._.sentryJob),delete APP.patron.sync._.sentryJob;var i=JSON.parse(e);APP.patron.sync.consume(i);var s;t.each(i.cards,function(e){var t=APP.patron.cards.find({cardId:e.cardId});(!s||t.authorizeTime>=s.authorizeTime)&&(s=t)},this),APP.events.off(this.handlers._onAuthenticatedElsewhere),this._deduplicateMergedCards(s),APP.events.dispatch("card:authenticated",{card:s}),APP.patron.cards.activateCard(s),this.yield("#synchronizedCard",{card:s})},n._synchronizedCard=function(e){this.assignments.possession&&this.assignments.possession.card!=this.assignments.card?(e.markAsRewritable(),this.yield("#youAuthenticatedTheWrongCard")):(e.say("authenticate.success.cards"),this._presentCard(e))},n._deduplicateMergedCards=function(e){t.each(e.mergedCardIds,function(t){var i=APP.patron.cards.find({cardId:t});i&&i!=e&&(APP.sentry.unlinkCard(i),i==this.assignments.card&&this.parameters.origination&&this.parameters.origination.match(i.cardId)&&(this.parameters.origination=this.parameters.origination.replace(i.cardId,e.cardId),delete this.assignments.possession,this.origin&&delete this.origin.callback))},this),delete e.mergedCardIds},n._presentCard=function(e){this._showCard(e,this.assignments.card),e.answer({next:this._completeAuthentication.bind(this,this.assignments.card)}).emphasize()},n._youAuthenticatedTheWrongCard=function(e){e.say("authenticate.wrong-card."+this.assignments.possession.type),this._showCard(e,this.assignments.card),e.response("mascot.yes",this._restartAuthentication.bind(this),"emph"),e.response("mascot.no",function(){APP.nav.back()||APP.nav.go("shelf")})},n._restartAuthentication=function(e){APP.events.on(this.handlers._onAuthenticatedElsewhere),this.assign({card:APP.patron.cards.find({cardId:this.parameters.cardId})}),this.yield("#fetchForms")},n._showCard=function(e,i){e.construct("library-cards-list",new c),e.dom.libraryCardsList.configure({editable:!0}),e.dom.libraryCardsList.become([i]),e.handlers._onCardUpdateAll=APP.events.on("card:update:all",function(){t.among(i,APP.patron.cards.all)?e.dom.libraryCardsList.become([i]):this._completeAuthentication(null)}.bind(this))},n._onTapRenameCard=function(e,t){try{APP.arena.popover(t.target),e._.parts.cardViews[0]._onTapRename(t)}catch(e){}},n._markEpisodeAsRetryable=function(e,i){i=t.absorb(i||{},{retryEpisode:"#"+e.name}),APP.events.off(e.handlers._onEpisodeRefresh),e.handlers._onEpisodeRefresh=e.on("interview:episode:refresh",function(){
this.assign(i)}.bind(this)),this.assign(i)},n._suggestHelpOrRetry=function(e){var t="#fetchForms",i=this.assignments.retryEpisode||t;this.assign({retryEpisode:t}),e.say({label:"authenticate.failure.help",enliven:{"#help":this._yieldToHelpInterview.bind(this)}}),e.markAsRewritable(),e.answer({label:"mascot.retry",yield:i}).emphasize()},n._yieldToHelpInterview=function(e){this.yield("interview/authenticate/help",{library:this.assignments.library,ils:this.assignments.ils,ilsCount:this.assignments.ilsList.length,login:this.assignments.userIdentifier,origination:APP.router.route.path})},n._yieldToSupportRequestInterview=function(e){this.yield("interview/authenticate/help#writeSupportRequest",{library:this.assignments.library,ils:this.assignments.ils,ilsCount:this.assignments.ilsList.length,login:this.assignments.userIdentifier,origination:APP.router.route.path})},n._commenceExternalAuthentication=function(e){e=t.absorb(e,t.absorb(this.parameters,{})),this._saveState(),APP.shell.oauthRequest({navigate:t.parameterizeURL(APP.services.sentry.pathToURL(["auth",e.create?"create":"link",this.assignments.library.websiteId].join("/")),{ils:!e.create&&this.assignments.ils?this.assignments.ils.ilsName:null}),callback:t.parameterizeURL("interview/authenticate/card",{key:this.assignments.library.baseKey,cardId:t.try(this.assignments.card,"cardId"),origination:this.parameters.origination||APP.router.route.path}),onSuccess:function(e){this.parameters.continuation=e.continuation,this.yield("#ilsIsExternalAndContinuing")}.bind(this),onFailure:this.thenYield("#ilsIsExternalAndFailed")})},n._completeAuthentication=function(e){this.boundary(),this.yieldBack({card:e})||(this.parameters.origination?APP.nav.go(this.parameters.origination):e?APP.nav.go(this.assignments.library.path()):APP.interviews.go("interview/configure/cards"))},n._form=function(e,t,i){var s=this._element({tag:"form",method:"GET",action:"#"});return this._element({tag:"input",type:"submit",parentNode:s,classes:"squish",access:{tabindex:-1}}),APP.events.on(s,"submit",function(e){APP.events.stop(e),"function"==typeof i&&i()}),e.construct(t,s)},n._field=function(e,i,s,n){s=t.flatten(s);var r,a,c=function(e){return!!this._phrase({label:e,okIfMissing:!0})}.bind(this);t.each(s,function(e,i){if("string"==typeof e){var s="authenticate.field."+t.dasherize(e);!r&&c(s)&&(r=s),!a&&t.try(this.assignments.ils,"pinHelpUrl")&&c(s+".explanation.with-link")&&(a={label:s+".explanation.with-link",enliven:{"#pin-help":APP.shell.bindOpenURL(this.assignments.ils.pinHelpUrl)}}),!a&&c(s+".explanation")&&(a=s+".explanation"),r&&a&&t.breakIteration()}},this),n=t.absorb(n,{parentNode:n.form,lines:1,required:!0,placeholder:r,explanation:a});var h;return h=t.excise(n,"emailAddress")?new l(n):new o(n),n.form?e.dom[t.camelize(i)]=h:e.construct(i,h)},n._registrationFields=function(e,i,s,n,r){var o={};return t.each(s,function(s){var a={GivenName:"first-name",Surname:"last-name",Email:"email-address"}[s]||t.dasherize(s),l={required:r,attributes:{autocorrect:"off",autocomplete:a},form:i};"email-address"==a&&(l.emailAddress=!0);var c;c=n[s]?this._element({parentNode:i,tag:"input",attributes:{type:"hidden",value:n[s]}}):this._field(e,a,a,l),o[s]=c},this),o},n._saveState=function(){APP.bank.set("auth:assignments:restore",{ils:this.assignments.ils,userIdentifierKey:this.assignments.userIdentifierKey,userIdentifier:this.assignments.userIdentifier,password:this.assignments.password,recaptchaSiteKey:this.assignments.recaptchaSiteKey,captcha:this.parameters.captcha})},s}),define("app/views/interviews/authenticate/interview-authenticate-verify-cards",["require","common","app/views/components/interviews/interview","app/views/account/library-cards-list"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("app/views/account/library-cards-list");return n.commence=function(e){return this.assign({cards:this._findExpiredCards()}),this.assignments.cards.length?"#listExpiredCards":"#noExpiredCards"},n._listExpiredCards=function(e){e.say("library-cards.verify-multiple"),e.construct("library-cards-list",new r),e.dom.libraryCardsList.configure({verifiable:!0,editable:!0}),e.handlers._onEpisodeRefresh=e.on("interview:episode:refresh",this._refreshList.bind(this,e)),e.handlers._onCardUpdateAll=APP.events.on("card:update:all",this._refreshList.bind(this,e))},n._noExpiredCards=function(e){e.say("library-cards.verify-multiple.done"),e.response("interview.menu","interview/menu")},n._refreshList=function(e){this.assign({cards:this._findExpiredCards()}),this.assignments.cards.length&&"listExpiredCards"==e.name?e.dom.libraryCardsList.become(this.assignments.cards):this.assignments.cards.length?(e.markAsRewritable(),this.yield("#listExpiredCards")):"noExpiredCards"!=e.name&&(e.markAsRewritable(),this.yield("#noExpiredCards"))},n._findExpiredCards=function(){var e=[];return t.each(APP.patron.cards.all,function(t){t.isExpired()&&e.push(t)}),e.sort(function(e,t){var i=function(e){return e.authorizeTime||e.createTime||0};return i(e)-i(t)}),e},s}),define("app/views/interviews/authenticate/interview-authenticate-help",["require","common","app/views/components/interviews/interview","shibui/src/components/form-input"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("shibui/src/components/form-input");return s.HELP_ATTEMPTS={},n.commence=function(e){return this.assignments.library||!this.parameters.key&&!this.parameters.websiteId?(this.assignments.library||this.assign({library:APP.library}),this.assignments.library?"#writeSupportRequest"==e?"#writeSupportRequest":"#helpContactOptions":"#missingArgs"):{path:"interview/locate-library/resolve",parameters:this.parameters,callback:!0}},n._configure=function(e,i){this.parameters=this._extractLibraryParameters(e,i),this.parameters=t.absorb(this.parameters,{origination:e.origination||i.origination})},n._helpContactOptions=function(e){var i=this.assignments,s={};if(i.ils&&i.ils.loginHintUrl&&(s["login-hint"]=i.ils.loginHintUrl),i.ils&&i.ils.pinHelpUrl){var n=t.try(this._,"ils.local.password.key")||"pin";"pin"==n?s["pin-help"]=i.ils.pinHelpUrl:s["password-help"]=i.ils.pinHelpUrl}var r=APP.libraries.libraryAndBranchURLs(i.library);r.support?s["library-support"]=r.support:s["library-support-email"]=r.supportEmailAddress,s["library-home"]=r.home||r.cardAcquisition;var o=["emph"],a=function(t){if(s[t])return e.answer({label:"authenticate.help.action."+t,button:APP.shell.bindOpenURL(s[t])}).emphasize("emph"==o.shift())}.bind(this);(s["login-hint"]||s["pin-help"]||s["password-help"])&&(e.say("authenticate.help.instructions"),a("login-hint"),a("pin-help"),a("password-help")),e.say("authenticate.help.library"),a("library-support"),a("library-home"),a("library-support-email"),e.answer({label:"authenticate.help.action.branches-map",button:APP.interviews.go.bind(APP.interviews,"interview/locate-library/branches",{library:i.library},{websiteId:i.library.websiteId})}).emphasize("emph"==o.shift()),(o.length||this._shouldShowSupportOption(s))&&(e.divider(),s["libby-help"]=APP.constants.URLS.help,e.say("authenticate.help.libby-help"),a("libby-help"),e.answer({label:"authenticate.help.action.libby-support",yield:"#writeSupportRequest"}))},n._writeSupportRequest=function(e){var t=this.assignments;e.say("authenticate.intro.support-request"),e.construct("support-request-field",new r({lines:5,maxlength:1e3,showLimit:!0,required:!0,attributes:{"aria-label":this._phrase("fdb.support.problem.a11y-label")}}));var i=["Library: "+t.library.safeName()];t.ils&&t.ilsCount>1&&i.push("Location: "+(t.ils.displayName||t.ils.ilsName)),t.login&&i.push("Login: "+t.login),e.construct("support-context-field",new r({lines:Math.max(2,i.length),maxlength:500,value:i.join("\n").trim(),placeholder:"authenticate.placeholder.support-context",classes:"auth-support-context-field"})),e.answer({label:"mascot.next",button:this._submitSupportRequest.bind(this,e)}).emphasize()},n._submitSupportRequest=function(e){if(this._isEpisodeValid(e)){var t={};t.patronMessage=[e.dom.supportRequestField.value(),e.dom.supportContextField.value()].join("\n\n").trim(),this.yield("interview/feedback/submit-to-sage",{category:"problem",submission:t,preview:!0})}},n._shouldShowSupportOption=function(e){var t=this.assignments.library.websiteId,i=e["library-support"]||e["library-support-email"]?3:2;this.assignments.library.hasFrontlineSupport&&(i=2);var n=s.HELP_ATTEMPTS;return n[t]=(n[t]||0)+1,n[t]>=i},s}),define("app/models/items/passkey",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return i.isSupported=function(e){return!!navigator.credentials&&(!!window.PublicKeyCredential&&(!!PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable&&(!!PublicKeyCredential.isConditionalMediationAvailable&&("function"==typeof e&&Promise.all([PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable(),PublicKeyCredential.isConditionalMediationAvailable()]).then(function(i){e(!!t.select(i,function(e){if(!e)return!0}).length)}),!0))))},i.strategy=function(){if(APP.shell.has("ui:passkey"))return"bridge";if(!t.among(APP.shell.info.platform,"iOS","Android"))return this.isSupported()?APP.shell.has("ui:oauth")?"oauth":"navigator":void 0},i.devicePrint=function(){return(t.try(APP.shell.traits,"device.uuid")||APP.sentry.chip||"").substr(-8)},s.$init=function(e,t){this.purpose=e,this.name=t,this.strategy=i.strategy()},s.creatorSummary=function(){if(!this.creatorDevice)return"other-browser";var e=this.creatorPrint==i.devicePrint()?"this":"other",t={iPhone:"iphone",iPad:"ipad",iOS:"iphone",Samsung:"android",Google:"android",Android:"android"}[this.creatorDevice]||"browser";return[e,t].join("-")},s.getChallenges=function(e,i){var s="auth/"+this.purpose+"/passkey/challenges",n={};this.id?n.passkey_id=this.id:this.name&&(n.passkey_name=this.name);var r=function(i){this.challenges=t.absorb({expiresAt:new Date(i.expiresAt)},i),e(i)}.bind(this);return APP.sentry.get(s,n,r,i)},s.register=function(e,t){this._performCeremony("register",e,t)},s.authenticate=function(e,t){this._performCeremony("authenticate",e,t)},s.useBlessing=function(e,t,i){if("failure"==e)return i?i():null;var s="auth/"+this.purpose+"/blessing";return APP.sentry.post(s,{blessing:e},t,i)},s.destroy=function(){this.id&&APP.sentry.delete("auth/"+this.purpose+"/passkey/"+this.id)},s._performCeremony=function(e,i,s){var n=t.try(this.challenges,"expiresAt");if(n&&n<t.epochMilliseconds())return delete this.challenges,void("function"==typeof s&&s());var r={register:t.try(this.challenges,"optionsForRegistration"),authenticate:t.try(this.challenges,"optionsForAuthentication")}[e];if(!r&&this.challenges)return void("function"==typeof s&&s());if(!r)return this.getChallenges(this._performCeremony.bind(this,e,i,s),s);var o=function(t){var n={register:this._postRegistration,authenticate:this._postAuthentication}[e];n&&t&&n.call(this,t,i,s)}.bind(this);if("bridge"==this.strategy)return APP.events.once("msg:ui:passkey:"+e,function(e){o(e.m.credential)}.bind(this)),APP.events.once("msg:ui:passkey:failure",function(t){APP.journal.warn('[PASSKEY] "%s" error (ui:passkey:failure):',e,t.m),"function"==typeof s&&s()}.bind(this)),APP.shell.transmit({name:"ui:passkey:"+e,webauthnRequest:r});if("oauth"==this.strategy){var a=APP.constants.STATUS_URI+"/auth/passkey/"+e;return a=a.replace(/^http:/,"https:"),APP.shell.oauthRequest({navigate:t.parameterizeURL(a,{uuid:this.challenges.uuid,purpose:this.purpose}),callback:APP.router.route.path.replace(/#.*/,""),onSuccess:i,onFailure:s})}return"navigator"==this.strategy?navigator.credentials["register"==e?"create":"get"]({publicKey:this._decodeWebauthnOptions(r)}).then(function(t){t?o(t):"function"==typeof s&&(APP.journal.warn('[PASSKEY] "%s" error (promise resolved):',e,"no credential"),s())}.bind(this)).catch(function(t){APP.journal.warn('[PASSKEY] "%s" error (promise rejected):',e,t),"function"==typeof s&&s()}):void("function"==typeof s&&s())},s._postRegistration=function(e,s,n){var r="auth/"+this.purpose+"/passkey/register",o={};return o.credential={type:e.type||"public-key",id:e.id||this._bufferToBase64URL(e.rawId),rawId:this._bufferToBase64URL(e.rawId),response:{clientDataJSON:this._bufferToBase64URL(e.response.clientDataJSON),attestationObject:this._bufferToBase64URL(e.response.attestationObject)}},o.creator_device_platform=t.try(APP.shell.info,"platform"),o.creator_device_brand=t.try(APP.shell.traits,"device.brand"),o.creator_device_model=t.try(APP.shell.traits,"device.model"),o.creator_device_print=i.devicePrint(),APP.sentry.post(r,o,s,n)},s._postAuthentication=function(e,t,i){var s="auth/"+this.purpose+"/passkey/authenticate",n={};return n.credential={type:e.type||"public-key",id:e.id||this._bufferToBase64URL(e.rawId),rawId:this._bufferToBase64URL(e.rawId),response:{authenticatorData:this._bufferToBase64URL(e.response.authenticatorData),clientDataJSON:this._bufferToBase64URL(e.response.clientDataJSON),signature:this._bufferToBase64URL(e.response.signature),userHandle:this._bufferToBase64URL(e.response.userHandle)}},APP.sentry.post(s,n,t,i)},s._decodeWebauthnOptions=function(e){var i=t.clone(e);return t.try(i,"user.id")&&(i.user.id=this._base64URLToBuffer(i.user.id)),t.try(i,"challenge")&&(i.challenge=this._base64URLToBuffer(i.challenge)),t.each(i.excludeCredentials,function(e){e.id=this._base64URLToBuffer(e.id)},this),t.each(i.allowCredentials,function(e){e.id=this._base64URLToBuffer(e.id)},this),i},s._base64URLToBuffer=function(e){var t=e;t=t.replace(/-/g,"+"),t=t.replace(/_/g,"/"),t+="==".slice(0,(4-e.length%4)%4);for(var i=atob(t),s=new ArrayBuffer(i.length),n=new Uint8Array(s),r=0,o=i.length;r<o;++r)n[r]=i.charCodeAt(r);return s},s._bufferToBase64URL=function(e){if("string"==typeof e)return e;var t=new Uint8Array(e),i="";t.forEach(function(e){i+=String.fromCharCode(e)});var s=btoa(i),n=s;return n=n.replace(/\+/g,"-"),n=n.replace(/\//g,"_"),n=n.replace(/=/g,"")},i}),define("app/views/interviews/authenticate/interview-authenticate-back-up",["require","common","app/views/components/interviews/interview","app/models/items/passkey","shibui/src/components/form-input"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("app/models/items/passkey"),o=e("shibui/src/components/form-input");return n.PASSKEY_NAME="Libby",n.PASSKEY_PURPOSE="recovery",n.PASSKEY_LIMIT=4,n.commence=function(){return this.assignments.blessing?"#registeredPasskey":r.strategy()?"#fetchPasskeys":"#passkeysUnsupported"},n._configure=function(e,i){i.blessing&&this.assign({blessing:t.excise(i,"blessing")})},n._passkeysUnsupported=function(e){e.say({label:"back-up.passkeys-unsupported.hint-upgrade",substitutions:{PLATFORM:APP.shell.info.platform}}),e.construct("mural",this._element({tag:"svg"})),APP.imageDirector.mural(e.dom.mural,"passkey-scene",{classes:"passkeys-unsupported-mural"}),e.answer({label:"mascot.learn-more.dot-dot-dot",link:APP.constants.URLS["help:passkeys"]}).emphasize("done"),e.answer({done:"MENU"})},n._fetchPasskeys=function(e){e.spin(),APP.sentry.get("auth/recovery/passkeys",{},function(e){t.try(e,"recovery.passkeys.length")?this.yield("#listPasskeys",{management:e.recovery}):this.yield("#introducePasskeys")}.bind(this),this.thenYield("#fetchPasskeysFailure"))},n._fetchPasskeysFailure=function(e){e.say("back-up.fetch-passkeys-failure"),e.answer({label:"mascot.retry",yield:"#fetchPasskeys"}),e.answer({done:"MENU"})},n._introducePasskeys=function(e){e.say("back-up.introduce-passkeys"),e.construct("mural",this._element({tag:"svg"})),APP.imageDirector.mural(e.dom.mural,"passkey-scene",{classes:"introduce-passkeys-mural"}),this.assign({passkey:new r(this.PASSKEY_PURPOSE,this.PASSKEY_NAME)}),e.answer({label:"back-up.introduce-passkeys.create",yield:"#registerPasskey"}).emphasize().explanation("back-up.introduce-passkeys.create.explanation").adjunct({icon:"cog",classes:"interview-answer-adjunct-cog",yield:"#chooseNameForPasskey"}),e.answer({label:"mascot.learn-more.dot-dot-dot",link:APP.constants.URLS["help:passkeys"]}).emphasize("done")},n._chooseNameForPasskey=function(e){var i=t.try(this.assignments,"management.passkeys")||[],s=t.select(i,function(e){return e.name?e.name.toLowerCase():void 0});s.length?e.say("passkeys.choose-name-for-passkey"):e.say("back-up.choose-name-for-passkey"),e.construct("name-field",new o({placeholder:"back-up.choose-name-for-passkey.placeholder",maxlength:32,value:t.try(this.assignments.passkey,"name"),required:!0,invalidations:function(e){if(!e.trim())return"required";if(t.among(e.trim().toLowerCase(),s))return"duplicate-passkey-name"},explanation:"back-up.choose-name-for-passkey.explanation"}));var n=function(){if(this._isEpisodeValid(e)){var t=e.dom.nameField.value().trim(),i=new r(this.PASSKEY_PURPOSE,t);this.yield("#registerPasskey",{passkey:i})}}.bind(this);e.dom.nameField.on("form:field:submit",n),e.response("mascot.next",n,"emph")},n._registerPasskey=function(e){e.spin(),e.construct("mural",this._element({tag:"svg"})),APP.imageDirector.mural(e.dom.mural,"passkey-floor",{classes:"authenticate-passkey-floor-mural"}),this.assignments.passkey.register(this.thenYield("#registeredPasskey"),this.thenYield("#registrationFailed"))},n._registeredPasskey=function(e){var i=t.excise(this.assignments,"blessing");if(i&&"failure"!=i&&this.assignments.passkey){var s=t.excise(this.assignments,"passkey");s.useBlessing(i),e.say("back-up.registered-passkey"),e.construct("mural",this._element({tag:"svg"})),APP.imageDirector.mural(e.dom.mural,"passkey-arm",{classes:"passkeys-success-mural"}),e.answer({done:"MENU"})}else this._registrationFailed(e)},n._registrationFailed=function(e){e.say("back-up.registration-failed");var i=t.try(this.assignments.management,"passkeys.length");e.answer({label:"mascot.retry",yield:i?"#chooseNameForPasskey":"#fetchPasskeys"}).emphasize(),e.answer({done:"MENU"})},n._listPasskeys=function(e){e.markAsRewritable(e.name),e.say("back-up.list-passkeys.intro"),e.construct("passkey-list",this._element({tag:"ul",classes:"authenticate-back-up-passkeys-list"})),t.each(this.assignments.management.passkeys,function(i){i=t.absorb(i,new r(this.PASSKEY_PURPOSE,i.name));var s=this._element({tag:"li",parentNode:e.dom.passkeyList});APP.imageDirector.mural(s,"passkey-scene"),this._element({tag:"p",parentNode:s,label:"passkeys.passkey-properties.sentence",substitutions:{PASSKEY_NAME:t.safe(i.name),CREATE_TIME:new Date(i.createTime),DEVICE:i.creatorSummary()},substitutionTags:!0}),this._element({button:this.thenYield("#authenticatePasskey",{passkey:i}),parentNode:s,label:"passkeys.manage-passkeys.test"})},this),e.construct("learn-link",this._element());var i=this._element({link:APP.constants.URLS["help:passkeys"],parentNode:e.dom.learnLink,label:"mascot.learn-more.dot-dot-dot",classes:"authenticate-back-up-passkeys-list-learn-link"});SPARK.locale.isEnglish&&this._textify(i,{html:"Learn More About Passkeys"}),e.construct("manage-button",this._element()),this._element({button:this.thenYield("#managePasskeys"),parentNode:e.dom.manageButton,label:"back-up.manage-passkeys",classes:"authenticate-back-up-passkeys-list-manage-button"})},n._authenticatePasskey=function(e){e.spin(),e.construct("mural",this._element({tag:"svg"})),APP.imageDirector.mural(e.dom.mural,"passkey-floor",{classes:"authenticate-passkey-floor-mural"}),this.assignments.passkey.authenticate(this.thenYield("#authenticatedPasskey"),this.thenYield("#authenticationFailed"))},n._authenticatedPasskey=function(e){var i=t.excise(this.assignments,"blessing");if(i&&"failure"!=i&&this.assignments.passkey){var s=t.excise(this.assignments,"passkey");s.useBlessing(i),e.say("passkeys.authenticated-passkey"),e.construct("mural",this._element({tag:"svg"})),APP.imageDirector.mural(e.dom.mural,"passkey-arm",{classes:"passkeys-success-mural"}),e.answer({done:"MENU"})}else this._authenticationFailed(e)},n._authenticationFailed=function(e){var i=t.excise(this.assignments,"passkey");e.say("passkeys.authentication-failed.1"),e.say("passkeys.authentication-failed.2"),e.answer({label:"passkeys.manage-passkeys.remove",yield:"#deletePasskey",assign:{deletingPasskey:i}}).emphasize("danger"),e.answer({label:"mascot.retry",yield:"#listPasskeys"}).emphasize("done")},n._managePasskeys=function(e){var i=t.try(this.assignments,"management.passkeys")||[];e.markAsRewritable(e.name),e.say("back-up.manage-passkeys.intro"),e.construct("passkeys-list",this._element({tag:"ul",classes:"authenticate-back-up-manage-passkeys interview-erasable-list"}));var s=e.answer({label:"passkeys.manage-passkeys.create",yield:"#chooseNameForPasskey"}).indicator({icon:"tag-add"}),n=e.say("passkeys.manage-passkeys.add-limit"),o=function(){var e=i.length>=this.PASSKEY_LIMIT;this._classify(n.parentNode,"hide",!e),this._classify(s.dom.root,"hide",e)}.bind(this);o(),t.each(i,function(i){i=t.absorb(i,new r(this.PASSKEY_PURPOSE,i.name));this._build("interview-erasable-item <li>",{parentNode:e.dom.passkeysList}," portrayal",{label:"passkeys.passkey-properties.itemized",substitutions:{PASSKEY_NAME:t.safe(i.name),CREATE_TIME:new Date(i.createTime),DEVICE:i.creatorSummary()},substitutionTags:!0}," button",{button:this.thenYield("#deletePasskey",{deletingPasskey:i})},"  icon",{graphic:"trash"})},this)},n._deletePasskey=function(e){var i=t.excise(this.assignments,"deletingPasskey");e.say("passkeys.manage-passkeys.remove.warning.1"),e.construct("passkey-summary",this._element({classes:"authenticate-passkeys-delete-summary"})),APP.imageDirector.mural(e.dom.passkeySummary,"passkey-scene"),this._element({tag:"p",parentNode:e.dom.passkeySummary,label:"passkeys.passkey-properties.itemized",substitutions:{PASSKEY_NAME:t.safe(i.name),CREATE_TIME:new Date(i.createTime),DEVICE:i.creatorSummary()},substitutionTags:!0}),e.say("passkeys.manage-passkeys.remove.warning.2"),e.answer({label:"passkeys.manage-passkeys.remove",button:function(){var e=t.try(this.assignments,"management.passkeys")||[],s=t.select(e,function(e){if(e.id==i.id)return e});t.each(s,function(i){t.excise(e,i)}),i.destroy(),this.boundary(),this.yield("#fetchPasskeys")}.bind(this)}).emphasize("danger")},s}),define("app/views/account/chip-code-control",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.configure=function(e){this.options=t.absorb(e,{})},n.set=function(e){return this._.value="",t.each(this._prepare().fields.children,function(t,i){var s=e[i]||"";this._textify(t,{html:""+s}),this._.value+=s},this),this._.value},n.get=function(){return this._.value},n.clear=function(){this.set("")},n._layout=function(e){this._build("chip-code-control",{extending:e}," fields","  field-1 .chip-code-control-field","  field-2 .chip-code-control-field","  field-3 .chip-code-control-field","  field-4 .chip-code-control-field","  field-5 .chip-code-control-field","  field-6 .chip-code-control-field","  field-7 .chip-code-control-field","  field-8 .chip-code-control-field"," status"),this.codeLength=e.fields.children.length},n._setStatus=function(e){this._textify(this._prepare().status,e)},s}),define("app/views/account/chip-code-input",["require","common","./chip-code-control"],function(e){var t=e("common"),i=e("./chip-code-control"),s=i.new(),n=s.prototype;return n.focus=function(){APP.sentry.removeJobFromQueue(this._.sentryJob);var e=this._prepare();e.input.value=this.set(""),this._focusElement(e.input),t.each(e.fields.children,function(e){this._declassify(e,"incorrect")},this),this._setStatus({html:""})},n._layout=function(e){i.prototype._layout.call(this,e),e.input=this._element({tag:"input",parentNode:e.root,classes:"chip-code-control-input",position:"prepend",type:"text",value:"",pattern:"[0-9]*",inputmode:"numeric",autocomplete:"off",required:"",size:this.codeLength,minlength:this.codeLength,maxlength:this.codeLength}),this._setStatus("cloning.cue")},n._listen=function(e,t){this._buttonify(t.root,this._onTap.bind(this)),APP.keyboardFocus.track(t.input),this._handle("focus",t.input),this._handle("blur",t.input),this._handle("keyup",t.input)},n._onTap=function(e){APP.events.stop(e),this.dom.root.querySelector(".focus")?this.dom.input.blur():this.focus()},n._onFocusInput=function(e){this._updateFocus()},n._onBlurInput=function(e){this._updateFocus()},n._onKeyupInput=function(e){var t=this.dom.input,i=this.set(t.value);i.length==this.codeLength&&(t.blur(),this._checkCode()),this._updateFocus()},n._updateFocus=function(){var e=null,i=this.dom.input==document.activeElement;t.each(this.dom.fields.children,function(t){!i||e||t.innerHTML?this._declassify(t,"focus"):(e=t,this._classify(t,"focus"))},this)},n._checkCode=function(){var e={code:this.get()};e.code.length<this.codeLength||(this.options&&this.options.role&&(e.role=this.options.role),this._setStatus("cloning.checking"),this._.sentryJob=APP.sentry.post("chip/clone/code",e,this._onCodeDoesMatch.bind(this),this._onCodeDoesNotMatch.bind(this)))},n._onCodeDoesMatch=function(e){this._setStatus("cloning.synchronizing"),t.each(this.dom.fields.children,function(e){this._classify(e,"fulfilled")},this);var i={};try{i.blessing=e.blessing}catch(e){}this._dispatch("chip-code:bless",i)},n._onCodeDoesNotMatch=function(){this._setStatus("cloning.incorrect-code"),t.each(this.dom.fields.children,function(e){this._classify(e,"incorrect")},this)},s}),define("app/views/account/chip-code-output",["require","common","./chip-code-control"],function(e){var t=e("common"),i=e("./chip-code-control"),s=i.new(),n=s.prototype;return n.CHECK_INTERVAL_MS=3e3,n.start=function(){this.clear(),this._fetchNewCode()},n.stop=function(){this._polling(null),this.clear(),this._setStatus("cloning.generate.status.stopped")},n._listen=function(e,t){i.prototype.listen.apply(this,arguments),this._handle("view:impart",this),this._handle("view:extract",this)},n._fetchNewCode=function(){this.clear(),this._setStatus("cloning.generate.status.fetching"),this._.codeExpiry=null,this._.lastCheck=null,this._polling(this._pollSentry.bind(this))},n._pollSentry=function(){var e={code:this.get()};this.options&&this.options.role&&(e.role=this.options.role),APP.sentry.get("chip/clone/code",e,function(e){"fulfilled"==e.result?this._onCodeFulfilled(e.blessing):e.code!=this.get()&&this._onFetchedNewCode(e.code,1e3*e.expiry)}.bind(this),function(){this._.codeExpiry||this._setStatus("cloning.generate.status.retrying"),this._polling(this._fetchNewCode.bind(this),{delay:1e3})}.bind(this))},n._onFetchedNewCode=function(e,i){var s=t.epochMilliseconds();this.set(e),this._.codeExpiry=i||s+6e4,this._.lastCheck=s,this._updateCountdownStatus(s),this._polling(this._onInterval.bind(this),{interval:1e3}),this._declassify(this.dom.status,"colorize")},n._onInterval=function(){var e=t.epochMilliseconds();this._.codeExpiry&&this._.codeExpiry<=e?this._fetchNewCode():this._.codeExpiry&&(this._updateCountdownStatus(e),e-this._.lastCheck>=this.CHECK_INTERVAL_MS&&(this._.lastCheck=e,this._pollSentry()))},n._onCodeFulfilled=function(e){this._polling(null),this.clear(),this._setStatus("cloning.generate.status.success"),t.each(this.dom.fields.children,function(e){this._classify(e,"fulfilled")},this),this._dispatch("chip-code:bless",{blessing:e})},n._polling=function(e,i){clearTimeout(t.excise(this._,"timer")),e&&i&&i.delay?this._.timer=setTimeout(e,i):e&&i&&i.interval?this._.timer=setInterval(e,i.interval):e&&e()},n._updateCountdownStatus=function(e){if(this._.codeExpiry){var t=Math.round((this._.codeExpiry-e)/1e3);this._setStatus({label:"cloning.generate.status.countdown",substitutions:{COUNTDOWN:t}}),this.dom.status.classList.contains("colorize")||this._classify(this.dom.status,"colorize")}},n._onViewImpartSelf=function(){t.excise(this._,"restartOnImpart")&&this.start()},n._onViewExtractSelf=function(){this._.restartOnImpart=!!this._.timer,this.stop()},s}),define("app/views/interviews/authenticate/interview-authenticate-setup-code",["require","common","app/views/components/interviews/interview","app/models/items/passkey","app/views/account/chip-code-input","app/views/account/chip-code-output"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("app/models/items/passkey"),o=e("app/views/account/chip-code-input"),a=e("app/views/account/chip-code-output");return n.commence=function(){return"#enterCode"},n._configure=function(e,i){i.blessing&&this.assign({blessing:t.excise(i,"blessing")})},n._enterCode=function(e){e.say("back-up.enter-code.intro");var t=e.construct("chip-code-input",new o);t.on("chip-code:bless",this.thenYield("#codeMatched")),t.configure({role:"primary"});var i=this._build("authenticate-setup-code-hints"," <hr> .shibui-form-rule"," <h2> {authenticate.setup-code.orator-hints}"," sonos",{button:this.thenYield("#displayCodeForSonos")},"  <p> {back-up.enter-code.hint-sonos}","  sonos-logo <img>"," aaos",{button:this.thenYield("#displayCodeForAAOS")},"  <p> {back-up.enter-code.hint-aaos}","  aaos-logo <img>");if(e.construct("chip-code-hint",i.root),APP.imageDirector.enqueue(i.sonosLogo,APP.constants.filePath("images/chip-cloning-logo-sonos.png")),APP.imageDirector.enqueue(i.aaosLogo,APP.constants.filePath("images/chip-cloning-logo-aaos.png")),r.strategy()){var s=this._build("authenticate-setup-code-passkey"," <hr> .shibui-form-rule"," mural"," prompt <p> {authenticate.setup-code.passkey-prompt}",{enliven:{"#back-up":this.thenYield("interview/authenticate/back-up")}});APP.imageDirector.mural(s.mural,"passkey-scene"),e.construct("passkey-prompt",s.root)}},n._displayCodeForSonos=function(e){e.say("back-up.display-code-for-sonos"),this._displayCode(e)},n._displayCodeForAAOS=function(e){e.say("back-up.display-code-for-aaos"),this._displayCode(e)},n._displayCode=function(e){var t=e.construct("chip-code-output",new a(e));e.on("interview:episode:refresh",t.start.bind(t)),e.on("view:extract",t.stop.bind(t)),t.on("chip-code:bless",this.thenYield("#codeMatched")),t.configure({role:"primary"}),t.start()},n._codeMatched=function(e){e.say("back-up.code-matched"),e.answer({done:"MENU"})},s}),define("app/views/interviews/authenticate/interview-authenticate-recover",["require","common","app/views/components/interviews/interview","app/models/items/passkey","app/views/account/chip-code-output","app/views/account/chip-code-input"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("app/models/items/passkey"),o=e("app/views/account/chip-code-output"),a=e("app/views/account/chip-code-input");return n.commence=function(){return"failure"==this.assignments.blessing?"#authenticationFailed":this.assignments.blessing?{path:"interview/authenticate/transfer",assignments:{blessing:this.assignments.blessing},callback:this._transferCallback.bind(this)}:r.strategy()?"#chooseMethod":"#passkeysUnsupported"},n._configure=function(e,i){i.blessing&&this.assign({blessing:t.excise(i,"blessing")})},n._passkeysUnsupported=function(e){if(e.say("recover.passkeys-unsupported"),e.answer({label:"recover.display-setup-code",yield:"#displayCode"}),APP.shell.info.platform){var t=this._build("authenticate-recover-passkey-support"," <hr> .shibui-form-rule"," prompt <p>",{label:"recover.passkeys-unsupported.hint-upgrade",substitutions:{PLATFORM:APP.shell.info.platform}}," link {mascot.learn-more.dot-dot-dot}",{link:APP.constants.URLS["help:passkeys"]}," mural");APP.imageDirector.mural(t.mural,"passkey-scene"),e.construct("passkey-support",t.root)}},n._chooseMethod=function(e){e.say("recover.choose-method"),e.answer({label:"recover.choose-method.with-passkey",yield:"#authenticatePasskey",classes:"authenticate-recover-passkey-answer"}).explanation("recover.choose-method.with-passkey.explanation").emphasize().with(function(e){APP.imageDirector.mural(e.dom.action,"passkey-scene")}.bind(this)),e.answer({label:"recover.display-setup-code",yield:"#displayCode"}).explanation("recover.choose-method.display-code.explanation")},n._authenticatePasskey=function(e){
e.spin(),e.construct("mural",this._element({tag:"svg"})),APP.imageDirector.mural(e.dom.mural,"passkey-floor",{classes:"authenticate-passkey-floor-mural"}),this.assign({passkey:new r("recovery")}),this.assignments.passkey.authenticate(function(e){e.blessing&&"failure"!=e.blessing?this._yieldToTransferWithBlessing(e.blessing):this.yield("#authenticationFailed")}.bind(this),this.thenYield("#authenticationFailed"))},n._authenticationFailed=function(e){e.say("recover.authentication-failed"),e.answer({label:"mascot.retry",button:function(){t.excise(this.assignments.passkey,"challenges"),this.yield("#authenticatePasskey")}.bind(this)}).emphasize(),e.divider(),e.answer({label:"recover.display-setup-code",yield:"#displayCode"}).explanation("recover.choose-method.display-code.explanation"),e.answer({label:"interview.locate-library-search",yield:"interview/locate-library/search"}).explanation("welcome.strategy.search").stack()},n._displayCode=function(e){e.markAsRewritable(e.name),e.say("recover.display-code.intro");var t=e.construct("chip-code-output",new o(e));e.on("interview:episode:refresh",t.start.bind(t)),e.on("view:extract",t.stop.bind(t)),t.on("chip-code:bless",this._onChipCodeBless.bind(this)),t.configure({role:"pointer"}),t.start(),e.divider(),e.construct("chip-code-hint",this._element({label:"recover.display-code.hint-help",classes:"authenticate-recover-chip-code-hint",button:function(){this._textify(e.dom.chipCodeHint,"recover.display-code.hint-help.explanation"),this._buttonify(e.dom.chipCodeHint,this.thenYield("#enterCode"))}.bind(this)}))},n._enterCode=function(e){e.say("recover.enter-code.intro");var t=e.construct("chip-code-input",new a);t.on("chip-code:bless",this._onChipCodeBless.bind(this)),t.configure({role:"pointer"})},n._onChipCodeBless=function(e){e.m.blessing&&"failure"!=e.m.blessing?this._yieldToTransferWithBlessing(e.m.blessing):this.yieldBack({library:void 0})},n._yieldToTransferWithBlessing=function(e){this.boundary(),this.assign({blessing:e}),this.yield("interview/authenticate/transfer",{realm:APP.router.realm,blessing:this.assignments.blessing,callback:this._transferCallback.bind(this)})},n._transferCallback=function(e){if(e&&this.assign(e),this.assignments.library){if(this.yieldBack({library:this.assignments.library}))return;APP.nav.go(this.assignments.library.path())}else this.assignments.passkey?this.yield("#authenticationFailed"):this.yieldBack({library:void 0})},s}),define("app/views/interviews/authenticate/interview-authenticate-transfer",["require","common","app/views/components/interviews/interview","app/views/account/library-cards-list"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("app/views/account/library-cards-list");return n.commence=function(e){return this.assignments.blessing?"#cloneWithBlessing":"#transferSuccess"},n._configure=function(e,t){this.assign({blessing:e.blessing||t.blessing})},n._cloneWithBlessing=function(e){e.spin(),APP.sentry.post("chip/clone",{blessing:this.assignments.blessing},this.thenYield("#transferSync"),this.thenYield("#transferFailure"))},n._transferSync=function(e){e.spin(),APP.sentry.forgetIdentity(),APP.patron.sync.commence({freshness:0,syncJourneys:!1,onSuccess:this.thenYield("#transferSuccess"),onFailure:this.thenYield("#transferFailure")})},n._transferSuccess=function(e){var i=APP.libraries.withCards();return i.length?(e.say("authenticate-transfer.complete.cards"),t.each(i,function(t){var i=e.construct("cards-list-"+t.websiteId,new r);i.configure({compact:!0,activatable:!0,editable:!0}),i.become(t.cards());var s=e.construct("link-"+t.websiteId,this._element({button:function(){this.yieldBack({library:t})||APP.nav.go(t.path())}.bind(this),classes:"authenticate-transfer-library-link",html:t.safeName()}));t.use(function(e){return e.isIdeal||e.isBroken?(i.become(t.cards()),void this._textify(s,{html:t.safeName()})):t.reuse()},this),e.divider()},this),void(e.handlers._onCardUpdateAll=APP.events.on("card:update:all",function(){t.each(i,function(t){var i=e.dom["cardsList"+t.websiteId];i.become(t.cards())},this)}))):(e.say("authenticate-transfer.complete.no-cards"),void e.answer({done:!0}))},n._transferFailure=function(e){APP.events.dispatch("investigate:record",{what:"device transfer sync failed",where:"InterviewConfigureDeviceSync#transferFailure",response:this.assignments.response}),this.yieldBack()||APP.nav.go("/")},s}),define("app/views/about/app-info-table",["require","common","shibui/src/view","app/views/core/block-strap"],function(e){var t=e("common"),i=e("shibui/src/view"),s=i.new(),n=s.prototype,r=e("app/views/core/block-strap");return n.become=function(e){this._fillOut(this._prepare(),e)},n._layout=function(e){this.dom=this._build("app-info",{element:e.root}," strap",r," table <table>")},n._fillOut=function(e,i){e.strap.configure({text:i.shift()}),this._textify(e.table),t.each(i,function(i){var s=this._element({tag:"tr",parentNode:e.table});this._element(t.absorb(this._stringify(i.shift()),{tag:"th",parentNode:s})),this._element(t.absorb(this._stringify(i.shift()),{tag:"td",parentNode:s}))},this)},n._stringify=function(e){return t.isNullish(e)?{label:"blank"}:e.label||e.html?e:{html:t.safe(""+e)}},s}),define("app/views/interviews/about/interview-about-legal",["require","common","app/views/components/interviews/interview","app/views/about/app-info-table"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("app/views/about/app-info-table");return n.commence=function(e){return"#aboutLegalInfo"},n._aboutLegalInfo=function(e){e.say({label:"app.legal.copyright",substitutions:{COPYRIGHT_YEAR:(new Date).getFullYear()}}),e.construct("policy-table",new r),e.dom.policyTable.become(this._policyInfo()),e.construct("attrib-table",new r),e.dom.attribTable.become(this._attributionInfo())},n._attributionInfo=function(){var e=[{label:"app.legal.attribution.head"}];return t.each(["maps","fonts","patterns"],function(t){e.push([{label:"app.legal.attribution.name."+t},{label:"app.legal.attribution.data."+t}])}),e},n._policyInfo=function(){var e=[{label:"app.legal.policies.head"}];return e.push([{label:"app.legal.policies.usage.name"},{label:"app.legal.policies.usage.data",enliven:{"#usage":APP.shell.bindOpenURL(APP.constants.URLS.terms)}}]),e},s}),define("app/views/about/app-capabilities-table",["require","common","./app-info-table"],function(e){var t=e("common"),i=e("./app-info-table"),s=i.new(),n=s.prototype;return n.become=function(e){this._fillOut(this._prepare(),this._capabilitiesInfo(e)),this._classify(this.dom.table,"app-capabilities-table")},n._listen=function(e,t){this._handle("platform:capabilities")},n._capabilitiesInfo=function(e){var i=[],s="DEBUG"==t.try(APP,"shell.info.mode");return t.each(e,function(e,n){if(n||s){var r=this._phrase({label:"app.capabilities."+e,okIfMissing:!0});(r||s)&&("geolocation"==e&&"boolean"==typeof t.try(n,"supported")?n={authorized:"🟢",undetermined:"🟡",denied:"🔴"}[n.authorization]||n.supported:"ui:oauth"==e&&n?n=!0:"audio:speech-synthesis"==e&&n?n=!0:"diagnostics:platform-settings"==e&&t.isList(n)&&(n=n.length),i.push([r||e,n]))}},this),i.sort(function(e,t){return e[0].localeCompare(t[0])}),i.unshift({label:"app.technical.head.capabilities"}),i},n._stringify=function(e){return e===!0?{html:"&#x2705;"}:e===!1?{html:"&#x274e;"}:i.prototype._stringify.call(this,e)},n._onPlatformCapabilities=function(e){return this.isInDocument()?void this.become(e.m.capabilities):this.extract()},s}),define("app/views/interviews/about/interview-about-technical",["require","common","app/views/components/interviews/interview","app/views/about/app-info-table","app/views/about/app-capabilities-table"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("app/views/about/app-info-table"),o=e("app/views/about/app-capabilities-table");return n.commence=function(e){return"#aboutTechnicalInfo"},n._aboutTechnicalInfo=function(e){e.say("app.technical.intro"),e.construct("client-table",new r),e.dom.clientTable.become(this._clientInfo()),e.construct("shell-table",new r),e.dom.shellTable.become(this._shellInfo()),APP.shell.transmit("platform:capabilities");var i=t.try(APP,"shell.capabilities");i&&t.try(APP,"shell.info.platform")&&(e.construct("capabilities-table",new o),e.dom.capabilitiesTable.become(i)),APP.shell.has("diagnostics:log")&&(e.divider(),e.answer({label:"settings.send-logs.button",button:this._onTapSendLogs.bind(this)}).indicator({icon:"answer-email"}))},n._clientInfo=function(){var e=[];return e.push({label:"app.technical.head.client"}),e.push([{label:"app.technical.name.spec"},"V"+APP.client.info.spec]),e.push([{label:"app.technical.name.version"},APP.client.info.version.value]),e.push([{label:"app.technical.name.url"},APP.constants.ROOT_URI]),e},n._shellInfo=function(){var e=[];return e.push({label:"app.technical.head.shell"}),t.try(APP,"shell.info.platform")?(e.push([{label:"app.technical.name.shell-type"},{label:"app.technical.data.shell-type.native"}]),e.push([{label:"app.technical.name.platform"},APP.shell.info.platform]),e.push([{label:"app.technical.name.spec"},"V"+APP.shell.info.spec]),e.push([{label:"app.technical.name.version"},APP.shell.info.version.value]),APP.shell.info.build&&e.push([{label:"app.technical.name.build"},APP.shell.info.build]),e.push([{label:"app.technical.name.mode"},APP.shell.info.mode])):e.push([{label:"app.technical.name.shell-type"},{label:"app.technical.data.shell-type.none"}]),e},n._onTapSendLogs=function(){APP.shell.transmit({name:"diagnostics:log:email",toAddress:"logreview@libbyapp.com",subject:"Libby App Log — "+APP.shell.info.platform,body:["Please find attached the Libby diagnostic log for analysis.","","Platform: "+t.try(APP.shell.info,"platform"),"Env: "+APP.constants.ENV,"Version: "+t.try(APP.shell.info,"version.value"),"Build: "+t.try(APP.shell.info,"build"),"Client: "+t.try(APP.client.info,"version.value"),"Date: "+new Date].join("\n")})},s}),define("app/views/interviews/about/interview-about-whats-new",["require","common","app/views/components/interviews/interview","app/base/version","app/views/core/block-strap"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("app/base/version"),o=e("app/views/core/block-strap");return n.commence=function(e){return"#fetchHistory"},n._fetchHistory=function(e){e.spin(),APP.services.dewey.fetch("about/history",this._fetchedHistory.bind(this),this.thenYield("#failedHistory"))},n._fetchedHistory=function(e){var i=this._parseHistoryFromResponse(e);i&&this.assign({history:i}),t.try(this.assignments.history,"length")?this.yield("#showRecentHistory"):this.yield("#failedHistory")},n._failedHistory=function(e){e.markAsRewritable(),e.say("app.changes.failure"),e.response("mascot.retry","#fetchHistory")},n._showRecentHistory=function(e){var t=[this.assignments.history.shift()];e.say("app.changes.intro"),e.construct("history-block",this._historyBlock(t)),e.response("app.changes.response.more","#showAllHistory")},n._showAllHistory=function(e){e.say("app.changes.intro.more"),e.construct("history-block",this._historyBlock(this.assignments.history))},n._historyBlock=function(e){var i=this._element({classes:"app-changes"});return t.each(e,function(e){var s=e[0],n=e[1];new o(i).configure({text:{html:s}});var r=this._element({tag:"ul",parentNode:i});t.each(n,function(e){this._element({tag:"li",parentNode:r,html:e})},this)},this),i},n._parseHistoryFromResponse=function(e){var i;try{i=t.try(JSON.parse(e),"dewey.history")}catch(e){}if(i){var s=[];t.each(i,function(e,t){s.push([e,t])});var n=new r;return s.sort(function(e,t){return n.compareVersionStrings(t[0],e[0])}),s}},s}),define("app/views/support/technical-output",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.become=function(e){if("string"!=typeof e)try{e=JSON.stringify(e,null,3)}catch(e){}this._prepare(),this._textify(this.dom.root,{html:t.safe(e)})},n._layout=function(){this.dom=this._build("technical-output <pre>")},n._listen=function(e){APP.events.scrollable(this.dom.root,"x"),this._handleTap()},n._onTap=function(){try{var e=window.getSelection();if(!e.isCollapsed)return;var t=document.createRange();t.selectNodeContents(this.dom.root.firstChild),e.addRange(t)}catch(e){}},s});define("app/views/interviews/about/interview-about-updating",["require","common","app/views/interviews/about/interview-about-whats-new","app/views/support/technical-output"],function(e){var t=e("common"),i=e("app/views/interviews/about/interview-about-whats-new"),s=i.new(),n=s.prototype,r=e("app/views/support/technical-output");return n._configure=function(e,t){this._.updateNotice=e.updateNotice,this._.buttons={}},n._listen=function(e,t){this._handle("app:update:pause"),this._handle("app:update:resume"),this._handle("app:update:relaunchable")},n._fetchHistory=function(e){e.say("app.changes.updating"),e.construct("app-changes",this._element()),e.dom.appChanges.appendChild(e._spinBubble().root),APP.shell.has("rosters")&&(this._.buttons.journal=e.answer({html:"👀",yield:"#revealJournal"}).compact()),this._.buttons.action=e.answer({label:"app.changes.pause",button:this._takeAction.bind(this),classes:"app-info-changes-action"}).emphasize().compact(),this._.updateNotice._.relaunchable?this._onAppUpdateRelaunchable():this._.updateNotice._.paused&&this._onAppUpdatePause(),APP.services.dewey.fetch("about/history",this._fetchedHistory.bind(this,e),this._fetchedHistory.bind(this,e))},n._fetchedHistory=function(e,i){var s=this._parseHistoryFromResponse(i);s&&this.assign({history:s}),this._textify(e.dom.appChanges);var n=t.try(this.assignments,"history[0]");n&&n.length?e.dom.appChanges.appendChild(this._historyBlock([n])):this._element({parentNode:e.dom.appChanges,classes:"app-changes-failure",label:"app.changes.failure"})},n._revealJournal=function(e){var t=APP.updater.roster.journal.read().join("\n");e.say("app.changes.journal.intro"),e.construct("journal",new r),e.dom.journal.become(t)},n._takeAction=function(){this._.actionInvoked=!0,this._.updateNotice.controlUpdate(),this._.actionInvoked=!1},n._onAppUpdatePause=function(){this._changeActionButtonLabel("app.changes.resume")},n._onAppUpdateResume=function(){this._changeActionButtonLabel("app.changes.pause")},n._onAppUpdateRelaunchable=function(){this._changeActionButtonLabel("app.changes.relaunch"),t.try(this._.buttons,"journal.extract()")},n._changeActionButtonLabel=function(e){var i=this._.buttons.action;i&&(i.label(e),!this._.actionInvoked&&t.isInDOM(i.dom.root)?(i.access("inert"),this._defer("action-button",function(){i.access("normal")},500)):this._defer("action-button"))},s});define("app/views/interviews/lectern/interview-lectern-updating",["require","common","app/views/components/interviews/interview"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype;return n.commence=function(){return"#downloadProgressBar"},n._downloadProgressBar=function(e){"audiobook"==t.try(this.assignments.luggage,"title.format")?e.say("lectern.updating.listen"):e.say("lectern.updating.read"),e.construct("progress-bar",this._build("lectern-updating-progress-bar"," fill").root);var i=t.try(this.assignments.luggage,"status()"),s=t.try(i,"bytes.downloaded")||0,n=0;if(this.handlers.onDownloadProgress=APP.events.on("luggage:download:progress:"+this.assignments.luggage.titleId,function(i){var r=e.dom.progressBar.firstChild,o=t.try(i,"m.bytes")||{},a=Math.max(1,(o.total||0)-s),l=Math.max(1,(o.downloaded||0)-s),c=t.smoothFloat(l/a,2);n=Math.min(1,Math.max(n,c)),this._styleTransform(r,"scaleX("+n+")"),n>=1&&this._defer("yield-back",this.thenYieldBack(),50)}.bind(this)),APP.flags.isOn("qa-roster-pause")){var r,o;r=e.answer({label:"blank",button:function(){APP.auditor[o()?"pause":"resume"]("qa"),o()}}).emphasize(),o=function(){var e=t.among("qa",APP.auditor._.pauseReasons);return r.label({html:e?"▶️":"⏸"}),!e}.bind(this),o()}},s}),define("app/views/interviews/lectern/interview-lectern-error",["require","common","app/views/components/interviews/interview","app/views/components/lectern/journalist","app/views/shelf/journey-timeline","app/views/components/library/library-logo","app/views/account/library-cards-list"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("app/views/components/lectern/journalist"),o=e("app/views/shelf/journey-timeline"),a=e("app/views/components/library/library-logo"),l=e("app/views/account/library-cards-list");return n.commence=function(){var e=[t.try(this.assignments,"error.response.result"),t.try(this.assignments,"error.response.upstream.errorCode"),t.try(this.assignments,"error.id")];return APP.journal.debug("[LECTERN-ERROR]",e),t.among("lectern-sync-success-but-no-such-loan",e)?"#explainNoSuchLoan":t.among("title_disallowed_for_card",e)?"#explainDisallowedForCard":t.among("TitleNoLongerAvailable",e)&&"magazine"==this.assignments.session.accessMode?"#explainTitleNotAvailable":t.among("missing-card-for-magazine",e)?"#explainMissingCardForMagazine":"#explainLecternError"},n._explainNoSuchLoan=function(e){if(e.say("lectern.error.no-such-loan"),this.assignments.title){var i=this.assignments.title,s=this.assignments.library||APP.library,n=this._build("lectern-no-such-loan-head",{link:i.path(s)}," biblio","  author <span>","  title <strong>"," library",a);e.construct("head",n.root),i.use(function(e){i.title||e.isBroken||i.reuse(),this._textify(n.title,{html:i.titleWithoutOrphans(),wrapper:!1}),this._textify(n.author,{html:i.attribution(),wrapper:!1})},this),n.library.become(s),e.construct("timelines",this._element({classes:"lectern-no-such-loan-timelines"})),i.journey().coalesce(function(i){t.each(i.timelines(),function(t){new o(e.dom.timelines).become(i,t)})})}},n._explainDisallowedForCard=function(e){e.say("magazines.title-disallowed-for-card");var i=t.try(this.assignments,"session")||{},s=i.title,n=APP.patron.cards.find({cardId:i.cardId}),r=t.try(n,"library")||i.library||APP.library;n&&APP.patron.magazines.getCardForIssue(s)!=n||APP.patron.magazines.setCardForIssue(s,null),e.construct("library-cards-list",new l),e.dom.libraryCardsList.configure({compact:!0,activatable:!0,verifiable:!0}),e.dom.libraryCardsList.become(r.cards()),e.construct("add-library-cards-button",this._element({button:this.thenYield("interview/authenticate/card",{library:r,origination:APP.router.route.path+"?retry="+t.epochSeconds()}),classes:"shibui-button",label:"library-cards.add-another-card"})),e.handlers._onCardUpdateAll=APP.events.on("card:update:all",function(){e.dom.libraryCardsList.become(r.cards()),r.card()!=n&&this._defer("retry",function(){APP.router.rebuild(APP.router.realm)},500)}.bind(this))},n._explainTitleNotAvailable=function(e){e.say("lectern.error.magazine-not-available");var t=this.assignments.title;APP.patron.magazines.isSubscribed(t)?e.answer({label:"lectern.error.magazine-not-available.manage-subscription",yield:"interview/tutorial/title-subscribe",assign:{title:t,library:this.assignments.library,callback:this._exitBack.bind(this)}}).emphasize():APP.patron.magazines.isIssueInRack(t)&&e.answer({label:"magazine.keep-prompt.answer-remove",button:function(){APP.patron.magazines.stopKeepingIssue(t),this._exitBack()}.bind(this)}).emphasize(),e.answer({done:this._exitBack.bind(this)})},n._explainMissingCardForMagazine=function(e){var i=t.try(this.assignments,"session")||{},s=i.titleId||t.try(i.title,"titleId"),n=t.try(i.library,"key()");e.say("lectern.error.magazine-is-missing-card"),n&&e.answer({label:"authenticate.response.show-form",yield:"interview/authenticate/card",assign:{intent:"login",library:i.library,origination:APP.router.route.path+"?retry="+t.epochSeconds()}}).emphasize(),e.answer({label:"action.sample.magazine",link:"open/sample/"+n+"/"+s}).emphasize(!n)},n._explainLecternError=function(e){e.markAsRewritable(!0);var i=t.try(this.assignments.title,"format")||"book",s=e.say({label:"lectern.error.generic",substitutions:{FORMAT:i}}),n=t.try(this.assignments.session,"journal.read()");APP.flags.isOn("inspect-errors")&&(e.construct("journalist",new r),t.each(n,function(t){e.dom.journalist.append(t.replace(/^.{1}\s/,""))})),t.try(this.assignments.sageError,"reportedToSupport")||(this.assign({sageError:APP.err("error-while-opening-title",{errorSource:"InterviewLecternError#_explainLecternError",errorHumanReadable:s.innerText,errorObject:this.assignments.error||{},attempts:t.try(this.assignments.session,"passport._.attemptFailures")||0,journal:n||[],title:t.try(this.assignments.title,"titleId"),library:t.try(this.assignments.library,"websiteId"),luggage:t.try(this.assignments.session,"loan.luggage().status()")||"--"})}),this.assignments.sageError.sendToSage(),APP.flags.isOn("inspect-errors")&&e.answer({label:"error.action.report",yield:"interview/feedback/report-error",assigns:{error:this.assignments.sageError,callback:"#explainLecternError"}}));var o=t.try(this.assignments.error,"retryable");o||"undefined"==typeof o?e.answer({label:"list-chain.retry",button:function(){APP.router.rebuild(APP.router.realm)}}).emphasize():e.answer({done:"MENU"})},n._exitBack=function(){APP.nav.back()||APP.nav.go("/")},s}),define("app/views/components/locate-library/library-guess-map",["require","common","app/views/core/partial","./library-branches-map","./library-branch-details"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("./library-branches-map"),o=e("./library-branch-details");return n.guess=function(){this._prepare().map.spin(),APP.libraries.withBrandingOverrides(function(){this.task=APP.geolocator.nearbyLibraryBranches({strategies:["gps","cache:recent:gps","ip-address"],onSuccess:this._onNearbyLibraryFound.bind(this),onFailure:this._onNearbyLibraryFailed.bind(this)})}.bind(this))},n._layout=function(e){this._build("library-guess-map",{extending:e}," map",r," hoist"),e.map.HOIST_TOP=160,e.map.on("map:branches:loaded",this._onMapLoaded.bind(this)),e.map.on("map:branches:failed",this._onMapFailed.bind(this)),this._declassify(e.root,"loaded failed")},n._listen=function(e,t){this._handle("aide:lighting")},n._onNearbyLibraryFound=function(e){var i=t.try(e,"branches[0]");i?(this._.branch=i,this._.branch.systems[0].branches=[i],this.dom.map.load([i.longitude,i.latitude],{zoomable:!1})):this._onNearbyLibraryFailed()},n._onNearbyLibraryFailed=function(){this._handleFailure()},n._onMapLoaded=function(){this._classify(this.dom.root,"loaded"),this.dom.map.spun();var e=this._.branch,t=this._.branch.systems[0];this.dom.map.populate([e],[t]),this.dom.map.select(e,{deselectable:!1,offsetY:-50}),this.dom.details=new o(this.dom.hoist),this.dom.details.become(t,e,{colors:!0,names:["system","branch"]});var i=this.dom.details.libraryAttributes();this._dispatch("map:guess:library",{attributes:i})},n._onMapFailed=function(){this._handleFailure()},n._handleFailure=function(){this.dom.map.spun(),this._classify(this.dom.root,"failed"),this._dispatch("map:guess:failure")},n._onAideLighting=function(){return this.isInDocument()?(this.dom.map.extract(),this.dom.map.impart(),this.dom.map.spin(),void(this._.branch?this._onNearbyLibraryFound({branches:[this._.branch]}):this.guess())):this.extract()},s}),define("app/views/interviews/locate-library/interview-locate-library-guess",["require","common","app/views/components/interviews/interview","app/views/components/locate-library/library-guess-map"],function(e){var t=(e("common"),e("app/views/components/interviews/interview")),i=t.new(),s=i.prototype,n=e("app/views/components/locate-library/library-guess-map");return s.commence=function(e){return"#guessLibrary"},s._guessLibrary=function(e){e.markAsRewritable(e.name),e.dom.intro=e.say("onboarding.guessing"),e.construct("map",new n),e.dom.map.on("map:guess:library",this._guessed.bind(this,e)),e.dom.map.on("map:guess:failure",this._failed.bind(this,e)),e.dom.map.guess()},s._guessed=function(e,t){this._textify(e.dom.intro,"onboarding.guessed"),this._clearEpisodeAnswers(e),e.answer({label:"onboarding.answer.guessed.yes",button:this._selected.bind(this,t.m.attributes)}).emphasize(),e.answer({label:"onboarding.answer.guessed.no",button:function(){APP.interviews.go("interview/locate-library/map")}}).stack()},s._failed=function(e){this._textify(e.dom.intro,"onboarding.guess.failed"),this._clearEpisodeAnswers(e),e.answer({label:"mascot.retry",button:this._retry.bind(this,e)}).emphasize(),e.answer({label:"onboarding.guess.search",yield:"interview/locate-library/search"}).stack()},s._retry=function(e){this._textify(e.dom.intro,"onboarding.guessing"),this._clearEpisodeAnswers(e),this._defer("retry",function(){e.dom.map.guess()},500)},s._selected=function(e){this.yieldBack(e)||this.yield("interview/locate-library/resolve",e)},s._clearEpisodeAnswers=function(e){var t=e._spawn("interview-answers");t.parentNode.removeChild(t)},i}),define("app/base/services/library-finder-query",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.CACHE_LIMIT=3,s.$init=function(){this.fetch=null,this.cache=[]},s.find=function(e,t){for(var i=this._normalizeQuery(e),s=0,n=this.cache.length;s<n;++s){var r=this.cache[s];if(r.query==i)return r.callback=t,this._deliverResults(r)}if(this.fetch){if(this.fetch.query===i)return;this._abortFetch()}this.fetch={},this.fetch.query=i,this.fetch.callback=t,this.fetch.request=APP.services.dewey.fetch("locate/autocomplete/"+encodeURIComponent(this.fetch.query),this._onFetchSuccess.bind(this,this.fetch),this._onFetchFailure.bind(this,this.fetch))},s.cancel=function(){this.fetch&&this._abortFetch()},s._normalizeQuery=function(e){return e.trim().replace(".","")},s._onFetchSuccess=function(e,t){delete e.request,e.responseText=t,this.fetch===e&&(this.fetch=null),this.cache.push(e),this.cache=this.cache.slice(0,this.CACHE_LIMIT),APP.libraries.withBrandingOverrides(this._deliverResults.bind(this,e))},s._onFetchFailure=function(e,t){this._deliverResults(e)},s._abortFetch=function(){var e=this.fetch;this.fetch=null,e&&e.request&&(APP.journal.debug("[LIBRARY-QUERY] aborting request for ",e.query),e.request.silentAbort=!0,e.request.abort())},s._deliverResults=function(e){var t=[];e&&e.responseText&&(t=this._findLibrariesInResponse(e.query,e.responseText)),e.callback(t)},s._findLibrariesInResponse=function(e,i){var s;new RegExp(t.regExpEscape(e),"i");try{s=JSON.parse(i)}catch(e){return APP.journal.warn("[LIBRARY-QUERY] error parsing response",e,i),[]}return t.select(this._branchesToSystems(s.branches)||s.systems,APP.libraries.applyBrandingOverrides.bind(APP.libraries))},s._narrowsQuery=function(e,t){return 0==e.indexOf(t)},s._branchesToSystems=function(e){if(e){var i=[],s={};return t.each(e,function(e){t.each(e.systemIds,function(t,n){var r=s[t];if(!r){if(r=e.systems[n],!r)return;i.push(r),s[t]=r}r.branches=r.branches||[],r.branches.push(e)})}),i}},i}),define("app/views/components/locate-library/library-autocomplete-result",["require","common","app/views/core/partial","./library-branch-details"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("./library-branch-details");return n.MAX_POSSIBLE_MATCHING_BRANCHES=30,n.$init=function(e,t){this._.options=t||{},i.prototype.$init.call(this,e)},n.become=function(e){var i=e.branch||(e.branches||[])[0];t.try(this.system,"websiteId")==e.websiteId&&t.try(this.branch,"id")==t.try(i,"id")||(this.system=e,this.branch=i,this.branchCount=e.branchCount||(e.branchIds||[]).length,this._fillOut(this._prepare()))},n.show=function(){this.hidden&&(this.hidden=!1,this._scheduleVisibility())},n.hide=function(){this.hidden||(this.hidden=!0,this._scheduleVisibility())},n.cull=function(){return!!this.hidden&&(this.extract(),!0)},n._layout=function(e){this._swapInteractiveElement(e.root,{button:this._onTap.bind(this)}),this._build("library-autocomplete-result",{extending:e,classes:"halo"}," branch-details",r," branches")},n._fillOut=function(e){e.branchDetails.become(this.system,this.branch,{colors:!0,names:this.branchCount>1?["system","branch"]:["system"]}),this._emptyElement(this.dom.branches),this.branchCount>1&&this._textify(this.dom.branches,{label:"library-result.branches-count",substitutions:{TOTAL_BRANCHES:Math.max(2,this.branchCount-1)}})},n._onTap=function(e){this.system&&!this.hidden&&this._dispatch("library:select",{attributes:this.dom.branchDetails.libraryAttributes()})},n._scheduleVisibility=function(){this._defer("vis",function(){this._classify(this.dom.root,"hide",this.hidden)}.bind(this))},s}),define("app/views/components/locate-library/library-autocomplete",["require","common","app/views/core/partial","app/base/services/library-finder-query","shibui/src/components/form-input-search","app/views/components/library/summary-list-of-libraries","app/views/core/block-strap","./library-autocomplete-result"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/base/services/library-finder-query"),o=e("shibui/src/components/form-input-search"),a=e("app/views/components/library/summary-list-of-libraries"),l=e("app/views/core/block-strap"),c=e("./library-autocomplete-result");return n.UPDATE_DELAY_MS=100,n.CLEANUP_DELAY_MS=1e3,n.MANUAL_PATTERN=/^id:(\S*)$/,n.$init=function(e){this.libraryFinderQuery=new r,this.results={state:null,query:null,matches:{}},e&&this.impart(e)},n.refresh=function(){this._buildSummary(),this.dom.field.value()&&(this.dom.field.setValue(""),this._findWithQuery(""))},n.focus=function(){this.dom.field.focus()},n._layout=function(e){this._build("library-autocomplete",{extending:e}," field",{construct:o,with:{placeholder:"search.placeholder",explanation:"library-autocomplete.instructions",attributes:{autocorrect:"off",autocapitalize:"off"}}}," output","  summary","  results","   strap",l,"   matches"),this._buildSummary(),this._updateResults()},n._listen=function(){this._handle("form:field:focus",this.dom.field),this._handle("form:field:blur",this.dom.field),this._handle("form:field:change:immediate",this.dom.field),this._handle("form:field:submit",this.dom.field),this._handle("form:field:reset",this.dom.field),this._.findWithQuerySoon=t.staggerInvocation(function(){this._findWithQuery(this.dom.field.value())}.bind(this),500,1e3)},n._buildSummary=function(){var e={};e.owned=APP.libraries.byOldestCard(APP.libraries.withCards()),e.partners=null,e.recent=APP.libraries.recent(),this.dom.summaryList?this.dom.summaryList.refresh([e.owned,e.partners,e.recent]):(this.dom.summaryList=new a(this.dom.summary),this.dom.summaryList.become([{strap:{text:"library-autocomplete.owned"},libraries:e.owned,options:{indicator:!0}},{strap:{text:"authenticate.rla.head"},libraries:e.partners},{strap:{text:"library-autocomplete.recent"},libraries:e.recent,actions:{clearRecent:!0}}]),this.dom.summaryList.on("summary:library:select",function(e){APP.events.stop(e),this._announceLibraryAttributes(e.m.library.systemAndBranchAttributes())}.bind(this)))},n._onFormFieldFocusField=function(e){this._.focused||(this._.focused=!0,this._scheduleUpdate())},n._onFormFieldBlurField=function(e){this._.focused&&(this._.focused=!1)},n._onFormFieldChangeImmediateField=function(e){this._.findWithQuerySoon(),this._scheduleCleanup()},n._onFormFieldSubmitField=function(e){this.dom.field.blur(),this._findWithQuery(this.dom.field.value()),this.results.manual&&this._announceLibraryAttributes({baseKey:this.results.manual})},n._onFormFieldResetField=function(e){this.refresh()},n._findWithQuery=function(e){this.results.query=e.replace(/^\s+/,"");var t=e.match(this.MANUAL_PATTERN);this.results.manual=t?t[1]:null,this.results.query&&null===this.results.manual?this.libraryFinderQuery.find(this.results.query,this._onLibraryMatches.bind(this)):(this.libraryFinderQuery.fetch&&this.libraryFinderQuery.cancel(),this._onLibraryMatches([])),this._updateResults()},n._onLibraryMatches=function(e){var i=[];
t.each(e,function(e){var t=this.results.matches[e.websiteId];t?t.become(e):(t=this._result(e,this.dom.matches),this.results.matches[e.websiteId]=t),t.show(),i.push(t)},this),t.each(this.results.matches,function(e,t){i.indexOf(t)<0&&t.hide()}),this._updateResults()},n._result=function(e,t){var i=new c(t);return i.on("library:select",this._onLibrarySelect.bind(this,i)),i.become(e),i},n._scheduleUpdate=function(e){"number"!=typeof e&&(e=this.UPDATE_DELAY_MS),this._defer("update-results",this._updateResults.bind(this),e)},n._updateResults=function(){var e=!!this.results.query,i=!t.isEmpty(this.results.matches);e?e&&null!==this.results.manual?this._setState("manual"):this.libraryFinderQuery.fetch?this._setState("finding"):i?this._setState("results"):this._setState("noresults"):this._setState("summary")},n._setState=function(e){if("selected"==this.results.state&&"selected"!=e){var t=this.dom.matches.querySelector('[aria-current="true"]');t&&this._attr(t,"aria-current",null)}this.results.state!=e&&(this.results.state=e,this._semaphore("library-autocomplete-state",this.results.state),"summary"==this.results.state?this.dom.field.explain("library-autocomplete.instructions"):"manual"==this.results.state?this.dom.field.explain("library-autocomplete.manual"):this.dom.strap.configure({text:"library-autocomplete."+e}))},n._onLibrarySelect=function(e,t){var i=this.dom.matches.querySelector('[aria-current="true"]');i&&this._attr(i,"aria-current",null),this._attr(e.dom.root,"aria-current","true"),APP.arena.scroller.scrollToTop(),this._setState("selected"),this._announceLibraryAttributes(t.m.attributes)},n._announceLibraryAttributes=function(e){this._dispatch("library:attributes",{attributes:e})},n._scheduleCleanup=function(){this._defer("cleanup",this._cleanup.bind(this),this.CLEANUP_DELAY_MS)},n._cleanup=function(){var e={};t.each(this.results.matches,function(t,i){i.cull()||(e[t]=i)}),this.results.matches=e},s}),define("app/views/interviews/locate-library/interview-locate-library-search",["require","common","app/views/components/interviews/interview","app/views/components/locate-library/library-autocomplete"],function(e){var t=(e("common"),e("app/views/components/interviews/interview")),i=t.new(),s=i.prototype,n=e("app/views/components/locate-library/library-autocomplete");return s.commence=function(e){return{path:"#searchForLibrary",action:this._action.bind(this)}},s._action=function(e){return this._element({link:"interview/locate-library/map",parentNode:e,label:"interview.locate-library-search.map-action"})},s._searchForLibrary=function(e){e.construct("library-autocomplete",new n),e.dom.libraryAutocomplete.on("library:attributes",function(e){this.yieldBack(e.m.attributes)||this.yield("interview/locate-library/resolve",e.m.attributes)}.bind(this))},i}),define("app/views/interviews/locate-library/interview-locate-library-map",["require","common","app/views/components/interviews/interview","app/views/components/locate-library/library-branch-details"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("app/views/components/locate-library/library-branch-details");return n.MAX_KM=50,n.DEFAULT_COORDINATES=[-77.00472,38.88885],n.claimOwnership=function(e){i.prototype.claimOwnership.call(this,e),this._listenForMapEvents(this.handlers,this.dom)},n.commence=function(e){return{path:"#locateLibraryOnMap",map:!0,action:this._action.bind(this)}},n._listen=function(e,t){this._handle("view:extract",this),this._handle("interview:map:reload",this),this._listenForMapEvents(e,t)},n._listenForMapEvents=function(e,i){if(delete this._.branches,delete this._.systems,delete this._.existingBounds,APP.events.off(this._.mapEventListeners),i.map=t.try(this.owner,"dom.map")){var s=[];s.push(this._handle("map:branches:loaded",i.map)),s.push(this._handle("map:branches:failed",i.map)),s.push(this._handle("map:branches:move",i.map)),s.push(this._handle("map:branches:marker",i.map)),s.push(this._handle("map:branches:find-me",i.map)),this._.mapEventListeners=t.compact(t.flatten(s))}},n._onInterviewMapReloadSelf=function(){this._listenForMapEvents(this.handlers,this.dom),this.yield("#locateLibraryOnMap")},n._action=function(e){return this._element({link:"interview/locate-library/search",label:"interview.locate-library-map.search-action",parentNode:e})},n._locateLibraryOnMap=function(e){t.try(t.excise(this,"task"),"abort()"),e.say("locate-map.locating"),e.markAsRewritable(),APP.libraries.withBrandingOverrides(this._fetchNearbyBranches.bind(this))},n._mapLoading=function(e){e.say("locate-map.loading"),e.markAsRewritable()},n._mapTooHigh=function(e){this._classify(this.dom.root,"too-high"),e.say("locate-map.too-high")},n._mapFailed=function(e){this.dom.map.spun(),this._classify(this.dom.root,"failed"),e.say("locate-map.failed")},n._mapFetching=function(e){this._declassify(this.dom.root,"selected too-high"),e.say("locate-map.fetching")},n._mapHasResults=function(e){this.dom.map.spun(),this._classify(this.dom.root,"loaded"),this._declassify(this.dom.root,"selected too-high"),e.say("locate-map.results")},n._mapHasNoResults=function(e){this.dom.map.spun(),this._classify(this.dom.root,"loaded"),this._declassify(this.dom.root,"selected too-high"),e.say("locate-map.no-results")},n._rewriteEpisodeToResultsOrNoResults=function(){var e=this._.branches&&this._.branches.length,t=e?"#mapHasResults":"#mapHasNoResults";this.episodeName()!=t&&this._rewriteEpisode(t)},n._selectedBranch=function(e){this._classify(this.dom.root,"selected");var t=this._build("interview-episode-dismiss",{button:this._deselectBranch.bind(this),spoken:"a11y.welcome.guess.no"}," icon",{graphic:"input-reset",id:!0});this._attr(t.root,"data-halo-delegate",t.icon.id),e.construct("dismiss",t.root),e.construct("branch-details",new r),e.dom.branchDetails.become(this.assignments.system,this.assignments.branch,{names:["system","branch"]}),e.divider(),e.answer({label:"locate-map.select",spoken:"a11y.welcome.guess.yes",button:function(){var t=e.dom.branchDetails.libraryAttributes();this._onLibraryAttributes({m:{attributes:t}})}.bind(this)}).emphasize()},n._onMapBranchesLoadedMap=function(e){var t=e.m.situation,i=this._boundsToKilometers(t.bounds[0],t.bounds[1]);i>this.MAX_KM||(this._.existingBounds={coordinates:t.coordinates,km:2*i},this._.branches?(this.dom.map.populate(this._.branches,this._.systems),this._rewriteEpisodeToResultsOrNoResults()):this._rewriteEpisode("#mapFetching"))},n._onMapBranchesFailedMap=function(e){this._rewriteEpisode("#mapFailed")},n._onMapBranchesMoveMap=function(e){this._updateLibraries(e.m.situation)},n._onMapBranchesMarkerMap=function(e){this._mapMarker(e.m)},n._onMapBranchesFindMeMap=function(e){this._declassify(this.dom.map.dom.findMe,"has-cue")},n._onViewExtractSelf=function(e){t.try(t.excise(this,"task"),"abort()")},n._updateLibraries=function(e){var t=this._boundsToKilometers(e.bounds[0],e.bounds[1]);t>this.MAX_KM?(delete this._.existingBounds,this._.branches=[],this._.systems=[],"#mapTooHigh"!=this.episodeName()&&(this.dom.map.populate(this._.branches,this._.systems),this._rewriteEpisode("#mapTooHigh"))):this._isWithinExistingBounds(e.coordinates,t)||(this._.existingBounds={coordinates:e.coordinates,km:2*t},this._fetchNearbyBranches({coordinates:e.coordinates,km:2*t}),"#mapFetching"!=this.episodeName()&&this._rewriteEpisode("#mapFetching"))},n._fetchNearbyBranches=function(e){t.try(t.excise(this,"task"),"abort()");var i={strategies:["gps","cache:recent:gps","ip-address","cache"],onSuccess:this._onNearbyBranchesFound.bind(this),onFailure:this._onNearbyBranchesFailed.bind(this)};return e&&e.coordinates&&(i.strategies.unshift("parameters"),i.parameters=e),this.task=APP.geolocator.nearbyLibraryBranches(i)},n._onNearbyBranchesFound=function(e){if(!this._.branches){if(!e.coordinates)return this._onNearbyBranchesFailed();delete this._.existingBounds,this.dom.map.load(e.coordinates,{buttons:{zoom:!0,findMe:!0}}),this._rewriteEpisode("#mapLoading");var i=t.among(e.authorization,"granted","required"),s="required"==e.authorization;this._classify(this.dom.map.dom.findMe,"emph",i),this._classify(this.dom.map.dom.findMe,"has-cue",s)}var n=!this._.branches||t.try(e,"branches[0]");this._.branches=t.try(e,"branches")||[],this._.systems=t.try(e,"systems")||[],this.dom.map&&this._.existingBounds&&n&&this.dom.map.populate(this._.branches,this._.systems),this._rewriteEpisodeToResultsOrNoResults()},n._onNearbyBranchesFailed=function(){this._.branches?this._.existingBounds&&APP.journal.warn("[LOCATE-MAP] failed to find libraries"):(this.dom.map.load(this.DEFAULT_COORDINATES,{buttons:{zoom:!0,findMe:!0},zoom:4}),this.dom.map.spun(),this._classify(this.dom.root,"loaded"),this._declassify(this.dom.root,"too-high"),this._rewriteEpisode("#mapTooHigh"))},n._boundsToKilometers=function(e,t){var i=function(e){return e*(Math.PI/180)},s=6371,n=i(t[0]-e[0]),r=i(t[1]-e[1]),o=Math.sin(r/2)*Math.sin(r/2)+Math.cos(i(e[1]))*Math.cos(i(t[1]))*Math.sin(n/2)*Math.sin(n/2),a=2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o));return s*a},n._isWithinExistingBounds=function(e,t){if(this._.existingBounds){var i=this._boundsToKilometers(e,this._.existingBounds.coordinates),s=i+t,n=.9*this._.existingBounds.km;if(s<n)return!0}return!1},n._mapMarker=function(e){e=e||{};var t=this.assignments.branch;this.assign({system:e.system,branch:e.branch}),this.dom.map.select(this.assignments.branch,{offsetY:80}),this.assignments.branch!=t&&(this.assignments.branch?this._rewriteEpisode("#selectedBranch"):t&&this._rewriteEpisodeToResultsOrNoResults())},n._deselectBranch=function(){this.dom.map.select(),this._mapMarker()},n._onLibraryAttributes=function(e){this.yieldBack(e.m.attributes)||APP.interviews.go("interview/locate-library/resolve",e.m.attributes)},s}),define("app/views/interviews/locate-library/interview-locate-library-branches",["require","common","app/views/components/interviews/interview","app/views/core/block-strap","app/views/components/locate-library/library-branch-details","app/views/account/library-card-icon","app/views/dialogs/dialog-library-picker"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=(e("app/views/core/block-strap"),e("app/views/components/locate-library/library-branch-details")),o=e("app/views/account/library-card-icon"),a=e("app/views/dialogs/dialog-library-picker");return n.FIT_BRANCHES_OPTIONS={padding:60,duration:0,maxZoom:12},n.claimOwnership=function(e){i.prototype.claimOwnership.call(this,e),this._listenForMapEvents(this.handlers,this.dom)},n.commence=function(e){return!this.assignments.library&&this.parameters?{path:"interview/locate-library/resolve",parameters:this.parameters,callback:!0}:(this.assignments.library||this.assign({library:APP.library}),this.assignments.library?{path:"#fetchBranches",map:!0,action:this._action.bind(this)}:"#missingArgs")},n._configure=function(e,t){this.parameters=this._extractLibraryParameters(e,t)},n._listen=function(e,t){this._handle("interview:map:reload",this),this._listenForMapEvents(e,t)},n._listenForMapEvents=function(e,i){if(i.map=t.try(this.owner,"dom.map")){var s=[];s.push(this._handle("map:branches:loaded",i.map)),s.push(this._handle("map:branches:failed",i.map)),s.push(this._handle("map:branches:marker",i.map)),this._.mapEventListeners=t.compact(t.flatten(s))}},n._onInterviewMapReloadSelf=function(){this.assign({mapLoaded:!1}),this._listenForMapEvents(this.handlers,this.dom),this._rewriteEpisode("#fetchBranches")},n._action=function(e){return this._.actionButton=this._element({button:this._selectLibrarySystem.bind(this),parentNode:e}),this._.libraryCardIcon=new o(this._.actionButton),this._.libraryCardIcon.become({library:this.assignments.library,card:this.assignments.library.card()}),this._.actionButton},n._fetchBranches=function(e){return this.assignments.branches&&this.assignments.mapLoaded?this._rewriteEpisode("#displayBranches"):(e.say("library.branches.loading"),e.markAsRewritable(),this.assignments.mapLoaded?this.dom.map.populate([],[]):this.dom.map.spin(),this.dom.map.defaultLibraryColors=this.assignments.library.colors(),void APP.services.dewey.fetch("locate/branches/"+this.assignments.library.websiteId,this._parseBranches.bind(this),this._rewriteEpisode.bind(this,"#failedBranches")))},n._displayBranches=function(e){e.say("library.branches.results"),this.assignments.resumeDisplayBranches||(this.dom.map.spun(),this.dom.map.populate(this.assignments.branches,[this.assignments.library]),this.dom.map.fitBranches()),t.excise(this.assignments,"resumeDisplayBranches")},n._displaySelectedBranch=function(e){e.markAsRewritable(e.name);var t=this._build("interview-episode-dismiss",{button:this._deselectBranch.bind(this),spoken:"a11y.welcome.guess.no"}," icon",{graphic:"input-reset",id:!0});this._attr(t.root,"data-halo-delegate",t.icon.id),e.construct("dismiss",t.root),e.construct("branch-details",new r),e.dom.branchDetails.become(this.assignments.library,this.assignments.branch,{names:["branch"],links:["🗺️","📬","📞"],logo:!0}),e.divider(),e.answer({label:"locate-library-branches.prefer-branch",button:this._rewriteEpisode.bind(this,"#preferSelectedBranch")})},n._preferSelectedBranch=function(e){this.assignments.library.branch=this.assignments.branch,APP.libraries.save(),e.say({label:"locate-library-branches.preferred-branch",substitutions:{BRANCH_NAME:t.safe(this.assignments.branch.name),LIBRARY_NAME:this.assignments.library.safeName()}});var i=(new r).become(this.assignments.library,this.assignments.branch,{links:["home","help"]});e.construct("library-links",i.dom.links),e.answer({label:"locate-library-branches.go-to-library",link:this.assignments.library.path()}).indicator({icon:"footer-library",classes:"branch-button-indicator-library"}).emphasize()},n._failedBranches=function(e){APP.journal.warn("[INTERVIEW-BRANCHES] failed to fetch branches"),e.markAsRewritable(),e.say("library.branches.failed"),e.response("mascot.retry","#fetchBranches"),this.dom.map.spun()},n._parseBranches=function(e){var t;try{t=JSON.parse(e)}catch(t){return APP.journal.warn("[INTERVIEW-BRANCHES] error parsing response",t,e),this._rewriteEpisode("#failedBranches")}for(var i,s=0,n=t.branches.length;s<n;++s)if(parseFloat(t.branches[s].longitude)){i=t.branches[s];break}i?(this.assign({branches:t.branches}),this.assignments.mapLoaded?this._rewriteEpisode("#displayBranches"):this.dom.map.load([i.longitude,i.latitude],{buttons:{zoom:!0,findMe:!0,fitBranches:!0}})):this._rewriteEpisode("#failedBranches")},n._onMapBranchesFailedMap=function(e){APP.journal.warn("[INTERVIEW-BRANCHES] failed to load map"),this._rewriteEpisode("#failedBranches")},n._onMapBranchesLoadedMap=function(e){this.assign({mapLoaded:!0}),this._rewriteEpisode("#displayBranches")},n._onMapBranchesMarkerMap=function(e){this.assign({branch:e.m.branch}),this.dom.map.select(this.assignments.branch,{offsetY:80}),this.assignments.branch?this._rewriteEpisode("#displaySelectedBranch"):(this.assign({resumeDisplayBranches:!0}),this._rewriteEpisode("#displayBranches"))},n._rewriteEpisode=function(e){for(;this.episodes.length>1;)this.episodes.pop().extract();this.episodes[0].impart(),i.prototype._rewriteEpisode.apply(this,arguments),this.episodes[0].focusFirstElement()},n._selectLibrarySystem=function(){APP.haptics.select();var e=[],t=APP.libraries.includingNow(APP.libraries.withCards());t.length&&e.push({strap:{text:"menu.library.heading"},libraries:APP.libraries.byOldestCard(t),options:{indicator:!0}});var i=new a;i.become(e),i.handle({"summary:library:select":this._onSummaryLibrarySelect.bind(this,i)}),i.present()},n._onSummaryLibrarySelect=function(e,i){APP.events.stop(i),APP.haptics.select(),t.try(e,"shade.minimize()"),t.excise(this.assignments,"branch"),t.excise(this.assignments,"branches"),this.assign({library:i.m.library}),this._.libraryCardIcon.become({library:this.assignments.library,card:this.assignments.library.card()}),this._rewriteEpisode("#fetchBranches")},n._deselectBranch=function(){this.dom.map.select(),this.assign({resumeDisplayBranches:!0}),this._rewriteEpisode("#displayBranches")},s}),define("app/views/interviews/locate-library/interview-locate-library-resolve",["require","common","app/views/components/interviews/interview"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype;return n.commence=function(e){return this.parameters.websiteId||this.parameters.key?"#resolveLibraryFromAttributes":"#missingArgs"},n._configure=function(e,i){this.parameters=t.absorb({next:e.next||i.next,realm:e.realm||i.realm||"library",nextPathPattern:e.nextPathPattern||i.nextPathPattern},this._extractLibraryParameters(e,i)||{}),this.assignments={branch:e.branch,branchCount:e.branchCount,callback:e.callback}},n._resolveLibraryFromAttributes=function(e){this._defer("resolve"),e.spin();var t=APP.libraries._attributesToQuery(this.parameters),i=APP.libraries.produce(t);i.usage.reset(),i.use(function(t){t.isIdeal?(this.assign({library:i}),this._libraryResolved(e)):t.isBroken||!APP.network.reachable?(this._.attempts=(this._.attempts||0)+1,this._.attempts<3?this._rewriteEpisode("#resolveLibraryFromAttributes"):this.yield("#libraryUnresolved")):i.reuse()},this)},n._libraryResolved=function(e){var t=this.assignments.library;return t.branch||this.assignments.branch||!t.websiteId?((this.assignments.branch||this.assignments.branchCount)&&t.absorbBranchAttributes({branch:this.assignments.branch,branchCount:this.assignments.branchCount}),void this._exit()):APP.services.dewey.fetch("locate/branches/"+t.websiteId,this._fetchedBranches.bind(this),this._exit.bind(this))},n._libraryUnresolved=function(e){e.markAsRewritable(),APP.journal.warn("[LOCATE-LIBRARY-RESOLVE] unresolved:",this.parameters),APP.err("library-unresolved",this.parameters).sendToSage(),e.say("onboarding.library.unresolved.1"),e.say("onboarding.library.unresolved.2"),e.response("mascot.retry","#tryAgain","emph")},n._tryAgain=function(e){e.spin(),this._.attempts=0,this._defer("resolve",this.thenYield("#resolveLibraryFromAttributes"),500)},n._fetchedBranches=function(e){try{var t=JSON.parse(e);this.assignments.library.absorbBranchAttributes({branch:t.branches[0],branchCount:t.branches.length})}catch(t){APP.journal.warn("[LOCATE-LIBRARY-RESOLVE] error parsing response",{error:t,response:e})}this._exit()},n._exit=function(){var e=this.assignments.library;if(!e||!e.status||"Hidden"==e.status)return this.yield("#libraryUnresolved");if(this.boundary(),!this.yieldBack({library:e})&&APP.router.realm==this.parameters.realm)if("Merged"==e.status)APP.interviews.go("interview/status/merged",{library:e});else if(t.among(e.status,"Terminated","Deleted"))APP.interviews.go("interview/status/shelved",{library:e});else if(this.parameters.nextPathPattern)APP.nav.go(this.parameters.nextPathPattern.replace(":key",e.baseKey));else if(this.parameters.realm){var i=[this.parameters.realm,e.baseKey,this.parameters.next];APP.nav.go(t.compact(i).join("/"))}else APP.nav.go(e.path(this.parameters.next||void 0))},s}),define("app/views/interviews/circ/interview-circ-prepare-title",["require","common","app/views/components/interviews/interview"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype;return n.PREFIXES=t.flatten(["circ-prepare-title",i.prototype.PREFIXES]),n.commence=function(){return this.assignments.card&&this.assign({userCirc:{card:t.excise(this.assignments,"card")}}),this.assignments.title?"#spin":"#titleIsUnknown"},n._configure=function(e,i){var s={},n=e.key=e.key||i.key;n&&(s.key=n),n=t.excise(e,"card"),n&&(s.card=n),n=t.excise(e,"library"),n&&(s.library=n),n=t.excise(e,"holding"),n&&(s.holding=n),n=e.action=e.action||i.action,n&&(s.action=n),e.userCirc||t.isEmpty(s)||(e.userCirc=s),e.titleId&&(e.title=APP.titles.produce({titleId:e.titleId}))},n._circChoices=function(){return this.assignments.userCirc||this.assignments.bestCirc},n._spin=function(e){return"title-language-unknown-to-user"==this.assignments.exception?APP.nav.back()||this.assignments.title.path():(e&&e.spin(),void this.assignments.title.use(function(e,t){return e.isBroken?APP.network.reachable?this.yield("#titleIsUnknown"):this.yield("#youAreOffline"):e.isIdeal||t.title&&t.format?void this._triage():t.reuse()},this))},n._youAreOffline=function(e){e.markAsRewritable(),e.characterize({status:"error",mascot:"failure"}),e.say("circ-prepare-title.offline"),e.handlers._onNetworkInfo=APP.events.on("network:info",function(e){e.m.network.reachable&&this.yield("#spin")}.bind(this))},n._titleIsUnknown=function(e){e.say("circ-prepare-title.unknown")},n._titleIsUnowned=function(e){var i=this._circChoices();e.say({label:"circ-prepare-title.unowned",substitutions:{FORMAT:t.try(this.assignments.title,"format"),LIBRARY_NAME:t.try(i,"library.safeName()")}}),e.markAsRewritable(e.name)},n._triage=function(){if(!this.assignments.bestCirc)return this._prepareBestCirc();if(!this.assignments.userCirc||this._prepareUserCirc()){this.boundary();var e=this._circChoices(),i=[t.try(e,"card.cardId"),this.assignments.title.titleId].join("-");return(this.assignments.loan=APP.patron.loans.find({psnKey:i}))?this.yield("interview/circ/borrow-title",this.assignments):void this.owner.checkRelevance("tutorial/title-language",{title:this.assignments.title},function(s,n){s?n(this.thenYield("#spin")):t.among(e.action,"borrow","lucky-day")?this.yield("interview/circ/borrow-title",this.assignments):(this.assignments.hold=APP.patron.holds.find({psnKey:i}))?this.yield("interview/circ/hold-title",this.assignments):"hold"==e.action?this.yield("interview/circ/hold-title",this.assignments):this.yield("#titleIsUnowned")}.bind(this))}},n._prepareBestCirc=function(){this.assignments.title.holdings.withBestCircAction(function(e){if(!this.assignments.bestCirc&&t.among(e.status,"complete","failed")){var i=APP.patron.cards.find({advantageKey:e.libraryKey}),s=t.try(i,"library")||APP.libraries.find({websiteId:e.websiteId});this.assign({bestCirc:{card:i,library:s,key:e.libraryKey,holding:e.holding,action:e.action}}),this._triage()}}.bind(this),{libraries:{preferred:APP.library}})},n._prepareUserCirc=function(){var e=this.assignments.userCirc;return e.card&&e.card==this.assignments.bestCirc.card&&e.action==this.assignments.bestCirc.action?(this.assignments.userCirc=null,!0):!!(e.key&&e.library&&e.holding&&e.action)||(e.card?e.key=e.card.advantageKey:e.holding?e.key=e.holding.libraryKey:e.library&&(e.key=e.library.baseKey),e.key?(e.card=e.card||APP.patron.cards.find({advantageKey:e.key}),e.library=t.try(e.card,"library")||APP.libraries.find({baseKey:e.key}),e.library?(e.card||e.library.baseKey!=e.key||(e.card=e.library.card()),this.assignments.title.holding(e.key).use(function(t,i){return t.isIdeal||t.isBroken?(e.holding=i,"borrow"==e.action&&e.holding.isAvailable||"hold"==e.action&&e.holding.isHoldable||"lucky-day"==e.action&&e.holding.luckyDayCopiesAvailable>0?e.action=e.action:e.holding.isOnlyAvailableAsLuckyDayLoan()?e.action="lucky-day":e.holding.isAvailable?e.action="borrow":e.holding.isHoldable?e.action="hold":e.action="unowned",void this._defer(this._triage.bind(this))):i.reuse()},this)):this.yield("interview/locate-library/resolve",{parameters:{key:e.key},callback:!0}),!1):(this.assignments.userCirc=null,!0))},s}),define("app/views/interviews/circ/interview-circ-base",["require","common","app/views/components/interviews/interview","app/views/components/library/library-logo","app/views/account/library-card-icon","app/views/account/library-card-limits","app/views/core/title-availability","app/views/components/interviews/interview-quote"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("app/views/components/library/library-logo"),o=e("app/views/account/library-card-icon"),a=e("app/views/account/library-card-limits"),l=e("app/views/core/title-availability"),c=e("app/views/components/interviews/interview-quote");return n.PREFIXES=["circ-base"],n.commentate=function(e,t){this._textify(t,{html:this._circPhrase("commentary."+e)})},n._configure=function(e,i){var s={action:this.PREFIXES[0].split("-")[1]},n=t.compact([t.excise(e,"psnLongKey"),t.excise(i,"psnLongKey")])[0];if(n){var r=n.split("-");3==r.length&&(s.collation=e.collation||APP.patron[r.shift()+"s"]),s.possession=e.possession||s.collation.find({psnKey:r.join("-")}),s.cardId=t.try(e,"card.cardId")||t.try(s.possession,"card.cardId"),s.library=e.library||t.try(s.card,"library")||t.try(s.possession,"library"),s.title=e.title||t.try(s.possession,"title"),!s.title&&t.last(r).match(/^\d+$/)&&(s.title=APP.titles.produce({titleId:t.last(r)}))}this.assign(s)},n._circChoices=n._possessionCircChoices=function(){var e=t.absorb(this.assignments,{});return e.holding=t.try(e.possession,"holding()"),(e.cardId=e.cardId||t.try(e.card,"cardId"))&&(e.card=APP.patron.cards.find({cardId:e.cardId})),e},n._circPhrase=function(e){e="string"==typeof e?{label:e}:t.absorb(e,{});for(var i=[],s=0,n=this.PREFIXES.length;s<n;++s){i.push(t.absorb({label:this.PREFIXES[s]+"."+e.label,okIfMissing:!0},t.absorb(e,{})));var r=this._phrase(i[s]);if(r)return r}return this._phrase(t.absorb({label:i[0].label},e))},n._missingArgs=function(e){e.say("interview.missing-args.intro"),e.response("mascot.next",this._exitBack.bind(this))},n._chooseLibrary=function(e){e.characterize({semaphores:{sayings:"square"}}),e.say({label:"circ-base.choose-library.intro",substitutions:{FORMAT:this.assignments.title.format}});var i=this.assignments.title,s=this._circChoices();t.each(this._selectableLibraries(),function(t){var n=t==s.library;e.construct("option-"+t.baseKey,this._circOption(["library-choice",{button:this._chooseCircOption.bind(this,{key:t.key()}),"aria-current":""+n}," title-availability",l],function(e){e.titleAvailability.become(i,t),n&&e.titleAvailability.dom.action.insertBefore(this._icon("star-indicator",null,{classes:"circ-option-indicator",access:"visual"}),e.titleAvailability.dom.icon.dom.root)}.bind(this)))},this)},n._chooseLibraryCard=function(e){e.characterize({semaphores:{sayings:"square"}}),e.say({label:"circ-base.choose-card.intro",substitutions:{FORMAT:t.try(this.assignments,"title.format")}});var i=this._circChoices();t.each(this._selectableCards(),function(t){var s=t==i.card;e.construct("option-"+t.cardId,this._circOption(["flex .circ-option-card-choice",{button:this._chooseCircOption.bind(this,{card:t}),"aria-current":""+s}," card-icon",o," card-name <strong>",{html:t.safeName()}," indicator",{icon:"star-indicator",skip:!s,access:"visual"}," card-limits",a],function(e){e.cardIcon.become({library:t.library}),e.cardLimits.become(t)},"tappy"))},this)},n._explainError=function(e){e.characterize({status:"error",mascot:"failure",semaphores:{sayings:"square"}});var i=t.excise(this.assignments,"error");i||(i={label:"circ.error.unrecognized"}),"string"==typeof i&&(i={label:i}),i.substitutions=t.absorb(i.substitutions,{TITLE:t.try(this.assignments.title,"titleWithoutOrphans()"),LIBRARY_NAME:t.try(this._circChoices(),"library.safeName()")}),i.enliven=t.absorb(i.enliven,{"#feedback":this._exitSupport.bind(this,{errorMessage:i.label||i.html})}),e.say(i);var s=t.excise(this.assignments,"errorExits");t.each(t.compact(t.flatten([s])),function(t,i){this._constructExit(e,t,!i)},this)},n._explainErrorWithMessage=function(e){e.characterize({status:"error",mascot:"failure"}),e.say("circ.error.generic.1"),e.construct("error-quote",new c(this.assignments.message,{quotable:"error"})),e.say({label:"circ.error.generic.2",enliven:{"#feedback":this._exitSupport.bind(this,{errorMessage:this.assignments.message})}});var i=t.excise(this.assignments,"errorExits");t.each(t.compact(t.flatten([i])),function(t,i){this._constructExit(e,t,!i)},this)},n._libraryErrorMessage=function(e){e.characterize({status:"error",mascot:"failure"}),e.say("circ.error.library-auth-message"),e.construct("error-quote",new c(this.assignments.message,{library:t.try(this._circChoices(),"library")})),e.divider(),this._constructExit(e,{label:"settings.auth-help.button",action:this.thenYield("interview/authenticate/help")},"emph"),this._constructExit(e,{label:"library-card.verify",action:this._yieldToCardVerification.bind(this,this._circChoices().card,!0)}),this._constructExit(e,"retry")},n._circOptionLibrary=function(e,i){var s=this._circChoices(),n=this._selectableLibraries().length>1;return e.construct("option-library",this._circOption(["library-name <strong>",{html:s.library.safeName()},"explainer <p>"],function(e){if(n){e.libraryName=this._swapInteractiveElement(e.libraryName,{button:this.thenYield("#chooseLibrary")}),this._classify(e.libraryName,"halo");var r="circ-base.option-library.",o={FORMAT:this.assignments.title.format};"hold"==s.action?(r+="hold.",s.library!=this.assignments.bestCirc.library?(r+="not-best.",o.LIBRARY_NAME=this.assignments.bestCirc.library.safeName(),r+=t.among(this.assignments.bestCirc.action,"borrow","lucky-day")?"borrow":"hold"):s.library==APP.library&&s.holding.copiesOwned>0?r+="is-best.active":this.assignments.bestCirc.holding.copiesOwned>0&&(r+="is-best.inactive",o.LIBRARY_NAME=APP.library.safeName())):t.among(s.action,"borrow","lucky-day")&&(r+="loan.",s.library!=APP.library&&s.library==this.assignments.bestCirc.library&&(r+="is-best.inactive",o.LIBRARY_NAME=APP.library.safeName())),"."!=t.last(r)&&this._textify(e.explainer,{label:r,substitutions:o}),this._classify(e.root,"tappy",n),this._classify(e.root,"emph",!!i)}}.bind(this)))},n._circOptionCard=function(e,i){var s=this._circChoices();if(s.card){var n=this._selectableCards().length>1;return e.construct("option-card",this._circOption(["flex .circ-option-card-details"," card-target .circ-option-flex","  card-icon",o,"  card-name <strong>",{html:s.card.safeName()}," card-limits",a],function(e){e.cardIcon.become({library:s.library}),n&&(e.cardTarget=this._swapInteractiveElement(e.cardTarget,{button:this.thenYield("#chooseLibraryCard")}),this._classify(e.cardTarget,"halo")),s.card.isExpired()?(t.excise(e,"cardLimits").extract(),this._classify(e.root,"circ-option-card-auth"),e.verifyButton=this._element({parentNode:e.flex,label:"library-card.verify",classes:"shibui-button",button:this._yieldToCardVerification.bind(this,s.card,!0)})):(this._declassify(e.root,"circ-option-card-auth"),e.cardLimits.become(s.card));var r=this.assignments.bestCirc;r&&r.card&&r.card!=s.card&&r.action!=s.action&&r.library==s.library&&t.try(r.card,"counts.loan")<t.try(r.card,"limits.loan")&&(e.explainer=this._element({tag:"p",parentNode:e.root,classes:"circ-option-explainer",label:"circ-base.option-card.not-best",substitutions:{FORMAT:this.assignments.title.format,CARD_NAME:r.card.safeName()}})),this._classify(e.root,"tappy",n),this._classify(e.root,"emph",!!i)}.bind(this)))}return e.construct("option-card-auth",this._circOption(["flex"," card-none {circ-base.option-card.card-none}"," card-add .shibui-button {circ-base.option-card.card-add}",{button:this.thenYield("interview/authenticate/card",{inline:!0,library:s.library,callback:this._exitRetry.bind(this)})}],function(e){this._classify(e.root,"circ-option-card-auth")}.bind(this)))},n._circOptionPossessionSummary=function(e,i){var s=this.assignments.library,n=t.try(this._circChoices(),"card");if(s&&n)return e.construct("option-possession-summary",this._circOption(["flex .circ-option-possession-summary"," card-target .circ-option-flex","  card-icon",o,"  card-name <strong>",{html:n.safeName()}," library-logo",r],function(e){e.cardIcon.become({library:s}),e.libraryLogo.become(s)}.bind(this),i))},n._circOption=function(e,i,s){var n=t.flatten(["circ-option",t.select(e,function(e){return"string"==typeof e?" "+e:e})]),r=this._build.apply(this,n);return"function"==typeof i?i(r):"string"!=typeof i||s||(s=i),s&&this._classify(r.root,s),r.root},n._circConfirmControls=function(e){var t=this._circChoices();if(t.card)return e.construct("confirm-controls",this._build("circ-controls"," .circ-confirm-button .shibui-button",{html:this._circPhrase("confirm-button"),
button:this._executeAction.bind(this,e)}).root)},n._chooseCircOption=function(e){this.yield("interview/circ/prepare-title",{title:this.assignments.title,userCirc:e})},n._selectableLibraries=function(){if(this.assignments.library)return[this.assignments.library];var e=APP.libraries.includingNow(APP.libraries.withCards());e.push(t.try(this.assignments,"userCirc.library")),e.push(t.try(this.assignments,"bestCirc.library"));var i=t.try(this.assignments,"key");return i&&(e.push(APP.libraries.find({baseKey:i})),e.push(t.try(APP.patron.cards.find({advantageKey:i}),"library"))),t.unique(t.compact(e))},n._selectableCards=function(){var e=this._circChoices();if(e)return this.assignments.cardId&&e.card?[e.card]:t.try(e,"library.cards()")},n._yieldToCardVerification=function(e,t){var i=this.assignments.possession||this.assignments.loan||this.assignments.hold;this.yield("interview/authenticate/card",{inline:!0,intent:t?"verify":void 0,card:e||this._circChoices().card,possession:i,origination:APP.router.route.path,callback:this._exitRetry.bind(this)})},n._contextualLibraryList=function(){for(var e=APP.router.route;e=e.ancestor;)if(t.try(e.list,"params.source"))return e.list},n._onServiceFailure=function(e){var i=e.response.upstream||{},s=i.userExplanation||"";if("offline"==e.failure)return this._errorWithExits("circ.error.offline");if("timeout"==e.failure||"upstream_timeout"==e.response.result)return this._handleServiceTimeout();if(this._.attempts=(this._.attempts||0)+1,"unauthorized"==e.response.result){var n=this._circChoices().card;n&&n.setExpiry(t.epochMilliseconds()),this._yieldToCardVerification(n,!1)}else s.match(/server took too long to respond.$/)?this._errorWithExits("circ.error.library-auth-timeout"):"PatronCardFailedAuthentication"==i.errorCode&&s?this._errorWithYield("#libraryErrorMessage",{message:s}):this._handleServiceError(e,i)||this._unknownServiceError(e,i)},n._handleServiceError=function(e,t){},n._unknownServiceError=function(e,t){APP.journal.warn("[CIRC] unrecognized service error:",e),APP.err("sentry-circ-failure",{errorCode:t.errorCode,errorSource:[e.failure,e.status].join(" -- "),explanation:t.userExplanation,details:e}).sendToSage(),t.userExplanation?this._errorWithYield("#explainErrorWithMessage",{message:t.userExplanation,errorExits:["retry","browse","shelf"]}):this._errorWithExits("circ.error.unrecognized")},n._handleServiceTimeout=function(){this._syncAndCheckSuccessFailingWith(this._errorWithExits.bind(this,"circ.error.timeout",void 0))},n._syncAndCheckSuccessFailingWith=function(e){var t=function(){if(!this.assignments.title||!this._checkSuccess())return e()}.bind(this);APP.patron.sync.commence({freshness:0,syncJourneys:!1,syncTags:!1,onSuccess:t,onFailure:e})},n._checkSuccess=function(){return!1},n._errorWithExits=function(e,t){return this._errorWithYield("#explainError",{error:e,errorExits:t||["retry","browse","shelf"]})},n._errorWithYield=function(e,t){return this.boundary(),this.yield(e,t),!0},n._onExecutionComplete=function(e,i){i&&this.assign(i);var s=function(i){t.try(i,"tag")&&this.assign({tag:i.tag}),this.boundary(),this.yield(e)}.bind(this);return"function"!=typeof t.try(this.owner,"checkRelevance")?s():void this.owner.checkRelevance("tutorial/suggest-notifications",{action:this._circChoices().action},function(t,i){t?(this.boundary(),i(this._onExecutionComplete.bind(this,e))):s()}.bind(this))},n._constructExit=function(e,i,s){var n=t.try(i,"name")||i;return"string"==typeof i&&(i=this._lookupExit(i)),i?(i.label=i.label||"circ-exit."+n,e.construct("exit-"+n,this._circOption(["action",{button:i.action,label:i.label}],i.builder,"circ-exit-option"+(s?" emph":"")))):APP.journal.warn("[CIRC] no such exit",n)},n._lookupExit=function(e){var t={name:e};return"back"==e?t.action=this._exitBack.bind(this,void 0):"hold"==e?t.action=this._exitPlaceHold.bind(this):"browse"==e?t.action=this._exitBrowse.bind(this):"shelf"==e?t.action=this._exitShelf.bind(this):"library"==e?t.action=this._exitLibrary.bind(this):"journey"==e?t.action=this._exitJourney.bind(this):"similar-titles"==e?(t.action=this._exitSimilarTitles.bind(this),t.label="list.source.similar"):"manage-cards"==e?(t.action=this._exitManageCards.bind(this),t.label="menu.library.response.manage-cards"):"retry"==e?t.action=this._exitRetry.bind(this):"open"==e&&(t.label="dot-dot-dot",t.action=APP.noop,t.builder=this._buildExitOpen.bind(this)),t},n._buildExitOpen=function(e){var i=this.assignments.loan||this.assignments.possession;if(i&&"loan"==i.type){var s=i.fulfiller.defaultFulfillmentType(),n="action.loan.open."+(s||i.title.format||"bifocal");return i.fulfiller.fulfillments.length<=1&&"bifocal"==s&&(n="action.loan.open."+(i.title.format||"bifocal")),this._textify(e.action,n),void this._buttonify(e.action,this.thenYield("interview/circ/fulfill-loan",{action:"fulfill",psnLongKey:"loan-"+i.psnKey,parameters:{fftType:s}}))}var r=this.assignments.title,o=this.assignments.library||t.try(this._circChoices(),"library")||APP.library;r.fulfiller(o).use(function(t,i){i.hasSample()?(this._textify(e.action,"action.sample."+r.format),this._buttonify(e.action,function(e){i.open({offlinePromptTarget:e.target,prenavigate:this._exitBack.bind(this)})}.bind(this))):t.isIdeal||t.isBroken?this._classify(e.root,"hide"):i.reuse()},this)},n._exitBack=function(e){!t.among(typeof e,"function","string")&&this.yieldBack(t.try(this,"_returningAssignments()"))||(APP.nav.back()||("library"==APP.router.realm?this.assignments.title?APP.nav.go(this.assignments.title.path(this._contextualLibraryList())):APP.nav.go("library"):"shelf"==APP.router.realm?APP.nav.go("shelf"):APP.nav.go("")),"function"==typeof e?e():"string"==typeof e&&APP.nav.go(e))},n._exitPlaceHold=function(){var e=this.assignments;if("loan"==t.try(e,"possession.type"))this.yield("interview/circ/hold-loan",{title:e.title,psnLongKey:"loan-"+e.possession.psnKey});else{var i=t.absorb(e.userCirc||e.bestCirc,{});if(!i.holding&&(i.holding=t.try(e.possession,"holding()"),!i.holding))return APP.journal.warn("[CIRC] unable to find holding to place hold");i.holding.isAvailable=!1,i.holding.isHoldable=!0,this.yield("interview/circ/prepare-title",{title:e.title,userCirc:t.absorb({action:"hold"},t.absorb(i,{}))})}},n._exitBrowse=function(){this._exitBack(t.among(APP.router.realm,"library","search")?null:"library")},n._exitLibrary=function(){this._exitBack(APP.library.path())},n._exitShelf=function(){"shelf"==APP.router.realm?APP.nav.go("shelf"):(this._exitBack("shelf"),APP.nav.go("shelf"))},n._exitJourney=function(){this._exitBack(this.assignments.title.journey().path())},n._exitSimilarTitles=function(){var e=this.assignments.title.titleId,t=APP.library.catalog.lists.produce("similar-"+e);this._exitBack(t.path())},n._exitManageCards=function(){this._exitBack("interview/configure/cards")},n._exitRetry=function(e){this.boundary(),this.yield(this.commence(),e)},n._exitSupport=function(e){this.yield("interview/feedback/support?category=problem",{titleInstance:t.try(e,"titleInstance")||this.assignments.title,errorMessage:t.try(e,"errorMessage")||void 0,callback:this._exitBack.bind(this)})},s}),define("app/views/interviews/circ/interview-circ-borrow-title",["require","common","app/views/interviews/circ/interview-circ-base","app/views/library/title-journey-preview","app/views/core/lucky-day-shamrock"],function(e){var t=e("common"),i=e("app/views/interviews/circ/interview-circ-base"),s=i.new(),n=s.prototype,r=e("app/views/library/title-journey-preview"),o=e("app/views/core/lucky-day-shamrock");return n.PREFIXES=t.flatten(["circ-borrow-title",i.prototype.PREFIXES]),n.commence=function(){return this.assignments.loan?"#completeBorrow":"#confirmBorrow"},n.commentate=function(e,t){var s=this.assignments.loan;return"outcome"==e&&s?this._textify(t,{html:this._circPhrase({label:"commentary.outcome",substitutions:{EXPIRY_DATE:s.expireTime}})}):i.prototype.commentate.call(this,e,t)},n._circChoices=function(){return this.assignments.userCirc||this.assignments.bestCirc},n._confirmBorrow=function(e){e.markAsRewritable(e.name),this._circOptionLibrary(e),this._circOptionCard(e),this._circOptionPeriod(e),this._circWarnings(e),this._circConfirmControls(e)},n._cancelHolds=function(e){e.characterize({status:"complete",semaphores:{sayings:"square"}}),e.say({html:this._circPhrase("cancel-holds.prompt.1")}),e.say({html:this._circPhrase("cancel-holds.prompt.2")}),e.answer({html:this._circPhrase("cancel-holds.action"),next:"#confirmCancelHolds"}).emphasize(),e.answer({label:"mascot.skip",next:"#completeBorrow"})},n._confirmCancelHolds=function(e){e.say({html:this._circPhrase("cancel-holds.processing")}),e.spin(),this._defer(this.thenYield("#completeBorrow"),2e3)},n._completeBorrow=function(e){e.characterize({status:"complete"});this.assignments.title.format;if(this.assignments.tag){var t=this.assignments.tag.find({"title.titleId":this.assignments.title.titleId});t&&(e.construct("tag-journey",new r),e.dom.tagJourney.becomeActs([t]))}this._constructExit(e,"open",!0),this._constructExit(e,"browse"),this._constructExit(e,"shelf")},n._circOptionPeriod=function(e){var i=this._circChoices(),s=this.assignments.title.format;if("lucky-day"!=i.action||i.card){var n=t.try(i.card,"lendingPeriods."+s)||{},r=n.preference;if("lucky-day"!=i.action||!n.luckyDay)return e.construct("option-period",this._circOption(["flex"," period-label",{html:this._circPhrase("option-period")}],function(e){if(!i.card)return this._textify(e.periodLabel,{label:"title-availability.available",substitutions:{COPIES_AVAILABLE:i.holding.copiesAvailable,COPIES_OWNED:i.holding.copiesOwned}});var t;n.options.length>1&&(t=this.thenYield("#chooseLendingPeriod")),e.periodValue=this._element({button:t,tag:t?void 0:"strong",parentNode:e.flex,classes:"circ-option-period-value",label:"units."+r[1],substitutions:{N:r[0]}})}.bind(this),"emph tappy"))}},n._circWarnings=function(e){var i=this._circChoices(),s=this.assignments.title;if(delete this.assignments.replacingHold,"lucky-day"==i.action)return e.construct("option-lucky-day",this._circOption([],function(e){e.shamrock=new o(e.root,{title:s,holding:i.holding,library:i.library,list:this._contextualLibraryList(),label:"lucky-day.circ-warning"});var n=s.format,r=t.try(i.card,"lendingPeriods."+n)||{};r.luckyDay&&this._element({tag:"p",parentNode:e.root,label:"circ-borrow-title.option-period.lucky-day",substitutionTags:!0,substitutions:{PERIOD:this._phrase({label:"units."+r.luckyDay[1],substitutions:{N:r.luckyDay[0]}})}});var a=APP.patron.holds.find({"title.titleId":s.titleId,"card.cardId":t.try(i.card,"cardId")});if(a){var l="circ.warning.lucky-day-for-hold-not-replacing";(!t.isList(r.luckyDay)||r.luckyDay[0]>=r.preference[0])&&(l="circ.warning.lucky-day-for-hold-replacing",this.assign({replacingHold:a})),this._element({tag:"p",parentNode:e.root,label:l})}}.bind(this),"emph"))},n._chooseLendingPeriod=function(e){e.characterize({semaphores:{sayings:"square"}}),e.say({label:"circ-borrow-title.choose-period.intro",substitutions:{FORMAT:this.assignments.title.format}});var i=this._circChoices(),s=this.assignments.title.format,n=i.card.lendingPeriods[s];t.each(n.options.slice(0).reverse(),function(r){var o=r.join()==t.try(n,"preference.join()");e.construct("option-"+r.join("-"),this._circOption(["lending-period",{button:function(){i.card.setLendingPeriodPreference(s,r),this.yield(this.commence())}.bind(this),label:"units."+r[1],substitutions:{N:r[0]},"aria-current":""+o}," indicator",{icon:"star-indicator",skip:!o,access:"visual"}],"tappy"))},this)},n._executeAction=function(e){e.access("inert"),e.characterize({status:"pending"});var i=this._circChoices(),s=this._contextualLibraryList();APP.sentry.borrowTitle(i.card,this.assignments.title,this._onActionExecuted.bind(this),this._onServiceFailure.bind(this),{reportingContext:t.try(s,"params.reportingContext()")})},n._onActionExecuted=function(e){APP.scribe.record("loan:borrow",{"title:id":e.title.titleId,hold:"hold"==t.try(this.assignments,"possession.type")});var i=t.excise(this.assignments,"replacingHold");i&&(APP.sentry.cancelHold(i),APP.events.dispatch("hold:satisfied",{item:e}));var s="#completeBorrow",n={loan:e};this._onExecutionComplete(s,n)},n._handleServiceError=function(e,i){var s=["hold","browse","retry"],n=["browse","manage-cards","retry"];return"PatronExceededCheckoutLimit"==i.errorCode?this._errorWithExits("circ.error.card-at-loan-limit",s):"PatronExceededChurningLimit"==i.errorCode?this._errorWithExits("circ.error.card-at-churn-limit",s):"PatronExceededCostPerCircCheckoutLimit"==i.errorCode?this._errorWithExits("circ.error.card-at-cpc-limit",s):"CostPerCircNoBudget"==i.errorCode?this._errorWithExits("circ.error.cpc-has-no-budget",s):"PatronTypeRestrictedFromTitle"==i.errorCode?this._errorWithExits("circ.error.restricted-title",n):"TitleNoLongerAvailable"==i.errorCode?(this._syncAndCheckSuccessFailingWith(this._errorWithExits.bind(this,"circ.error.no-copies-available-for-loan",s)),!0):"CostPerCircAvailabilityFastLaneOnly"==i.errorCode?this._errorWithExits("circ.error.cpc-unavailable-except-for-fast-lane",s):"CheckoutNotAllowedForVisitor"==i.errorCode?this._errorWithExits("circ.error.reciprocal-loan-disallowed",n):"PatronExceededLuckyDayLimit"==i.errorCode?this._errorWithExits("circ.error.card-at-lucky-day-limit",n):"LuckyDayCheckoutPreventedForNotifiedHold"==i.errorCode?(APP.err("lucky-day-loan-disallowed-because-hold-ready",{title:this.assignments.title,errorCode:i.errorCode,explanation:i.userExplanation,details:e}).sendToSage().present(),this._errorWithExits("circ.error.lucky-day-loan-disallowed",n)):"CheckoutForLuckyDayNotAllowedForSimpleLoginAndGuest"==i.errorCode?this._errorWithExits("circ.error.lucky-day-loan-disallowed",n):"CheckoutNotWithinRenewalWindow"==i.errorCode?(this._syncAndCheckSuccessFailingWith(this._errorWithExits.bind(this,"circ.error.cannot-renew-yet",["shelf","similar-titles"])),!0):"CheckoutPreventedForLuckyDayNotifiedHold"==i.errorCode?(this._syncAndCheckSuccessFailingWith(function(){if(this._.attempts<3){var s=this._circChoices(),n=APP.patron.holds.find({"title.titleId":t.try(this.assignments.title,"titleId"),"card.cardId":t.try(s.card,"cardId")});if(n&&n.isAvailable)return this._executeAction(t.last(this.episodes))}this._unknownServiceError(e,i)}.bind(this)),!0):void 0},n._checkSuccess=function(){var e=APP.patron.loans.find({"title.titleId":this.assignments.title.titleId});return!!e&&(this._onActionExecuted(e),!0)},n._exitRetry=function(e){this.boundary(),e=t.absorb(e,{title:this.assignments.title}),this.yield("interview/circ/prepare-title",e)},s}),define("app/views/interviews/circ/interview-circ-hold-title",["require","common","app/views/interviews/circ/interview-circ-base","app/views/components/common/wait-list-summary"],function(e){var t=e("common"),i=e("app/views/interviews/circ/interview-circ-base"),s=i.new(),n=s.prototype,r=e("app/views/components/common/wait-list-summary");return n.PREFIXES=t.flatten(["circ-hold-title",i.prototype.PREFIXES]),n.commence=function(){return this.assignments.hold?"#completeHold":"#confirmHold"},n.commentate=function(e,t){if("outcome"==e&&this.assignments.hold){var s=this.assignments.hold.holding();return this._textify(t,{html:this._circPhrase({label:"commentary.outcome",substitutions:{LINE_POSITION:s.position}})})}return i.prototype.commentate.call(this,e,t)},n._circChoices=function(){return this.assignments.userCirc||this.assignments.bestCirc},n._confirmHold=function(e){e.markAsRewritable(e.name),this._circOptionLibrary(e),this._circOptionCard(e),this._circOptionWaitListSummary(e,"emph"),this._circConfirmControls(e)},n._completeHold=function(e){e.characterize({status:"complete"}),this._constructExit(e,"open",!0),this._constructExit(e,"browse"),this._constructExit(e,"similar-titles"),this._constructExit(e,"shelf")},n._circOptionWaitListSummary=function(e,t){var i=this._circChoices();return e.construct("option-wait-summary",this._circOption(["estimate <strong>"],function(e){this._textify(e.estimate,i.holding.estimatedWaitInWords("short-sentence")),e.explainer=this._element({parentNode:e.root,classes:"circ-option-explainer"});var t=i.holding._hold();i.card&&(t=t||APP.patron.holds.find({"title.titleId":this.assignments.title.titleId,"card.cardId":i.card.cardId}));var s=new r;s.become(this.assignments.title,i.holding,{hold:t})&&(e.waitListSummary=s,e.waitListSummary.impart(e.explainer))}.bind(this),t))},n._executeAction=function(e){e.characterize({status:"pending"}),e.access("inert");var i=this._circChoices(),s=this._contextualLibraryList();APP.sentry.holdTitle(i.card,this.assignments.title,this._onActionExecuted.bind(this),this._onServiceFailure.bind(this),{reportingContext:t.try(s,"params.reportingContext()")})},n._onActionExecuted=function(e){APP.scribe.record("hold:place",{"title:id":e.title.titleId}),this._onExecutionComplete("#completeHold",{hold:e})},n._handleServiceError=function(e,t){var i=["browse","manage-cards","retry"],s=["browse","shelf"];return"PatronExceededHoldLimit"==t.errorCode?this._errorWithExits("circ.error.card-at-hold-limit",i):"PatronTypeRestrictedFromTitle"==t.errorCode?this._errorWithExits("circ.error.restricted-title",i):"TitleCannotBePlacedOnHold"==t.errorCode?this._errorWithExits("circ.error.unowned-title",s):"HoldNotAllowedForVisitor"==t.errorCode?this._errorWithExits("circ.error.reciprocal-hold-disallowed",i):"HoldNotWithinRenewalWindow"==t.errorCode?(this._syncAndCheckSuccessFailingWith(this._errorWithExits.bind(this,"circ.error.cannot-hold-yet",["shelf","similar-titles"])),!0):void 0},n._checkSuccess=function(){var e=APP.patron.holds.find({"title.titleId":this.assignments.title.titleId});return!!e&&(this._onActionExecuted(e),!0)},n._exitRetry=function(e){this.boundary(),e=t.absorb(e,{title:this.assignments.title}),this.yield("interview/circ/prepare-title",e)},s}),define("app/views/interviews/circ/interview-circ-open-extra",["require","common","app/views/interviews/circ/interview-circ-base","app/views/components/library/library-logo","app/views/account/library-card-icon"],function(e){var t=e("common"),i=e("app/views/interviews/circ/interview-circ-base"),s=i.new(),n=s.prototype,r=e("app/views/components/library/library-logo"),o=e("app/views/account/library-card-icon");return n.PREFIXES=t.flatten(["circ-open-extra",i.prototype.PREFIXES]),n.commence=function(){return this.assignments.providerId||this.assignments.reserveId?"#prepareExtra":"#extraNotFound"},n._configure=function(e,s){var n=t.compact([t.excise(e,"providerId"),t.excise(s,"providerId")])[0];if(APP.patron.extras.find({psnKey:n})?e.psnLongKey="extra-"+n:e.providerId=n,e.psnLongKey||s.psnLongKey)return i.prototype._configure.apply(this,arguments),void(this.assignments.reserveId=t.try(this.assignments.title,"reserveId"));var r={action:"open"};r.library=e.library||t.try(e,"card.library")||APP.library,r.cardId=t.try(e,"card.cardId")||t.try(r.library,"card().cardId"),this.assign(r)},n._prepareExtra=function(e){e.spin(),this.assignments.library.catalog.extras.use(function(e,t){if(e.isBroken&&!APP.network.reachable)return this._errorWithExits("circ.error.offline");if(e.isBroken)return this._errorWithExits("circ.error.unrecognized");if(!e.isIdeal)return t.reuse();var i=this.assignments.providerId||this.assignments.reserveId;this.assign({extra:t.find(i)}),this.assignments.extra&&this.assignments.possession?this.yield("#fulfillOpen"):this.assignments.extra?this.yield("#confirmOpen"):(APP.journal.debug("[INTERVIEW-CIRC-OPEN-EXTRA] 404",this.assignments),this.yield("#extraNotFound"))},this)},n._extraNotFound=function(e){e.characterize({status:"error",mascot:"failure"}),e.say({html:this._circPhrase("404")}),e.answer({done:this._exitBack.bind(this)})},n._confirmOpen=function(e){this._becomeStage(this.assignments.extra),e.markAsRewritable(e.name),e.construct("option-extra-description",this._circOption(["extra-description",{html:this.assignments.extra.description}])),this._circOptionCard(e,"emph"),this._circConfirmControls(e)},n._fulfillOpen=function(e){if(this._becomeStage(this.assignments.extra),APP.network.reachable||t.excise(this.assignments,"tryWhenOffline")){e.spin();var i=this.assignments.possession.fulfiller;i.fulfill(i.fulfillments[0],this._onFulfillExecuted.bind(this),this._onServiceFailure.bind(this))}else e.markAsRewritable(),e.say("action.explanation.offline"),e.response("mascot.persevere",this.thenYield("#fulfillOpen",{tryWhenOffline:!0}),"emph")},n._selectableCards=function(){return t.try(this.assignments.library,"cards()")},n._circOptionCard=function(e,i){var s=this.assignments.library;if(s){var n=t.try(this._circChoices(),"card");if(n){var a=this._selectableCards().length>1;return e.construct("option-possession-summary",this._circOption(["flex .circ-option-possession-summary"," card-target .circ-option-flex","  card-icon",o,"  card-name <strong>",{html:n.safeName()}," library-logo",{construct:r,skip:n.isExpired()}],function(e){e.cardIcon.become({library:s}),a&&(e.cardTarget=this._swapInteractiveElement(e.cardTarget,{button:this.thenYield("#chooseLibraryCard")}),this._classify(e.cardTarget,"halo")),n.isExpired()?(this._classify(e.root,"circ-option-card-auth"),e.verifyButton=this._element({parentNode:e.flex,label:"library-card.verify",classes:"shibui-button",button:this._yieldToCardVerification.bind(this,n,!0)})):(this._declassify(e.root,"circ-option-card-auth"),e.libraryLogo.become(s)),this._classify(e.root,"tappy",a),this._classify(e.root,"emph",i)}.bind(this)))}return e.construct("option-card-auth",this._circOption(["flex"," card-none {circ-base.option-card.card-none}"," card-add .shibui-button {circ-base.option-card.card-add}",{button:this.thenYield("interview/authenticate/card",{inline:!0,library:s,callback:this._exitRetry.bind(this)})}],function(e){this._classify(e.root,"circ-option-card-auth"),this._classify(e.root,"emph",!!i)}.bind(this)))}},n._chooseCircOption=function(e){e.card&&(e.cardId=e.card.cardId),this.assign(e),this.yield(this.commence())},n._executeAction=function(e){e.characterize({status:"pending"}),e.access("inert"),APP.sentry.getNTCCode(this._circChoices().card,this._onActionExecuted.bind(this),this._onServiceFailure.bind(this))},n._onActionExecuted=function(e){APP.scribe.record("extra:open",{"provider:slug":this.assignments.providerId});var i=t.parameterizeURL([APP.constants.NTC_SITE_URI,this.assignments.library.key(),this.assignments.providerId].join("/"),{code:e});this._openExternalURL(i)},n._checkSuccess=function(){if(this.assignments.possession)return!1;if(!this.assignments.extra)return!1;var e=APP.patron.extras.find({"title.reserveId":this.assignments.extra.reserveId,"library.websiteId":this.assignments.extra.library.websiteId});return e&&this._onActionExecuted(),!!e},n._onFulfillExecuted=function(e,t){this._openExternalURL(t)},n._openExternalURL=function(e){var t=APP.shell.openURL(e,{inExternalApp:!0,sameWindow:"prevent"});t?this._defer("exit",this._exitBack.bind(this),1e3):(APP.arena.splash(!0),this._defer("exit",this._exitBack.bind(this,function(){APP.shell.openURL(e)}),500),this._defer("oops",function(){APP.arena.splash(!1)},3e3))},n._setupStage=function(e){this.stageDOM=this._build("interview-circ-extra-stage",{parentNode:e}," flex","  hero","   limelight",{graphic:"limelight"},"   shadow","    icon <figure>","  carousel <ul>"),APP.events.scrollable(this.stageDOM.carousel,"x"),this.assignments.extra&&this._becomeStage(this.assignments.extra)},n._becomeStage=function(e){if(this.stageDOM&&e!=this._.stageExtra){this._.stageExtra=e,this._textify(this.stageDOM.icon),this._createAssetImage(e,e.icon,{parentNode:this.stageDOM.icon}),e.colorize(this.stageDOM.icon),this._textify(this.stageDOM.carousel),t.each(e.assets,function(t){var i=this._element({tag:"li",parentNode:this.stageDOM.carousel});this._createAssetImage(e,t,{parentNode:i})},this);var i=t.elementClosest(this.stageDOM.root,".screen-title-circ");i&&this._classify(i,"has-extra")}},n._createAssetImage=function(e,i,s){var n=e.optimizedAssetURL(i);if(n){var r=t.safe(i.caption||i.title||e.name||"");r=r||this._phrase("extras.unnamed");var o=this._element(t.absorb(s,{tag:"img",alt:r}));return APP.imageDirector.enqueue(o,n),o}},s}),define("app/views/interviews/circ/interview-circ-fulfill-loan",["require","common","app/views/interviews/circ/interview-circ-base","app/models/items/title-fulfiller"],function(e){var t=e("common"),i=e("app/views/interviews/circ/interview-circ-base"),s=i.new(),n=s.prototype,r=e("app/models/items/title-fulfiller");return n.PREFIXES=t.flatten(["circ-fulfill-loan",i.prototype.PREFIXES]),n.commence=function(){return this.assignments.possession?this.assignments.fulfillmentChoice?"#executeFulfillment":"#chooseFulfillment":"#missingLoan"},n.commentate=function(e,t){var s,n=this.assignments.fulfillmentChoice;n&&n.isDownloadable&&"action"==e?s=this._circPhrase("commentary.action.downloading"):n&&"action"==e?s=this._circPhrase("commentary.action.executing"):n&&n.isDownloadable&&"outcome"==e?(s=this._phrase({label:"fulfillment-type.name."+n.fulfillmentType,okIfMissing:!0}),s=this._circPhrase({label:"commentary.outcome.downloaded",substitutions:{FULFILLMENT_FORMAT:s}})):n&&"outcome"==e&&(s=this._circPhrase("commentary.outcome.executed")),s?this._textify(t,{html:s}):i.prototype.commentate.call(this,e,t)},n._configure=function(e,s){i.prototype._configure.apply(this,arguments),(s.fftType||s.fftSubtype)&&t.each(r.knownFulfillments(),function(e){(s.fftType&&e.fulfillmentType==s.fftType||s.fftSubtype&&e.fulfillmentSubtype==s.fftSubtype)&&(this.assign({fulfillmentChoice:e,auto:!0}),t.breakIteration())},this)},n._missingLoan=function(e){e.characterize({status:"error",mascot:"failure"}),e.say({html:this._circPhrase("404")}),e.answer({done:this._exitBack.bind(this)})},n._chooseFulfillment=function(e){e.markAsRewritable(e.name),e.characterize({status:"speech"});var i=this._eligibleFulfillments(),s=(this.assignments.possession,t.select(i,function(e){if(e.isLockedIn)return e})[0]);if(e.construct("primary-options",this._element({classes:"circ-fulfill-loan-primary-options"})),!s||s.isPrimary){var n=e.construct("secondary-expando",this._circOption(["{circ-fulfill.options.link}",{button:function(){n.parentNode.removeChild(n)}}]));this._classify(n,"circ-fulfill-loan-secondary-expando")}e.construct("secondary-options",this._element({classes:"circ-fulfill-loan-secondary-options"})),t.each(i,function(t){var i="fulfillment-type.name."+t.fulfillmentType,n="fulfillment-subtype.description."+t.fulfillmentSubtype,r=e.dom.secondaryOptions,o={};if(t.isPrimary&&(i="circ-fulfill.sup."+t.fulfillmentType,n="circ-fulfill.sub."+t.fulfillmentType,r=e.dom.primaryOptions),t.isFulfillable){t.isLockedOut?n="fulfillment-subtype.locked-out":o.button=this.thenYield("#executeFulfillment",{fulfillmentChoice:t});var a;(!s&&t.isPrimary||s&&"kindle"==s.fulfillmentType&&t.isPrimary||s&&s.fulfillmentType==t.fulfillmentType)&&(a="emph"),r.appendChild(this._circOption(["fulfill-loan",o," fulfill-loan-info","  fulfill-loan-sup-type <h2>",{label:i},"  fulfill-loan-sub-type .circ-option-explainer",{label:n}," fulfill-loan-drm-badge",{html:"DRM",skip:!t.hasDRM}],a))}},this),s?e.say({label:"circ-fulfill.options.locked-in",substitutions:{TYPE:this._phrase("fulfillment-type.name."+s.fulfillmentType)}}):e.dom.secondaryOptions.childNodes.length?e.say("circ-fulfill.options.lock-in"):e.say("circ-fulfill.options.none")},n._executeFulfillment=function(e){this.boundary(),e.markAsRewritable();var i=this.assignments.possession,s=this.assignments.fulfillmentChoice,n={fftType:s.fulfillmentType};return"bifocal"==n.fftType&&i.fulfiller.isOpenableRightNow(n)?(APP.summoner.daemons.fulfillmentChoices.choose(this.assignments.title,"bifocal"),this._exitBack(i.fulfiller.open.bind(i.fulfiller,n))):void(APP.network.reachable||t.excise(this.assignments,"tryWhenOffline")?(e.spin(),i.fulfiller.fulfill(s,this._onActionExecuted.bind(this),this._onServiceFailure.bind(this))):(e.say("action.explanation.offline"),e.answer({label:"mascot.persevere",yield:"#executeFulfillment",assign:{tryWhenOffline:!0}}).emphasize()))},n._completeFulfillment=function(e){e.markAsRewritable(),e.characterize({status:"complete",mascot:"academy"});var t,i=this.assignments.fulfillmentChoice.fulfillmentType,s="circ-fulfill.fulfillment."+i+".success",n=this._phrase({label:s,okIfMissing:!0});if(n)t=e.say({html:n});else for(var r=1;r<5&&(n=this._phrase({label:s+"."+r,okIfMissing:!0}),n);++r)t=e.say({html:n});t?e.answer({done:this._exitBack.bind(this)}):(this.yield("#spin"),this._defer("exit",this._exitBack.bind(this),750))},n._spin=function(e){this.boundary(),e.spin()},n._onActionExecuted=function(e,t){e.isMemorable&&this.assignments.rememberChoice!==!1&&APP.summoner.daemons.fulfillmentChoices.choose(this.assignments.title,e.fulfillmentType);var i=APP.shell.openURL(t,{inExternalApp:e.useExternalApp,sameWindow:e.isDownloadable?"force":"prevent"});i?this._defer("execution",function(){this._onExecutionComplete("#completeFulfillment")}.bind(this),1e3):(APP.arena.splash(!0),this._defer("exit",this._exitBack.bind(this,function(){APP.shell.openURL(t)}),500),this._defer("oops",function(){this._errorWithExits("circ.error.fulfillment-failure",["retry","shelf"]),APP.arena.splash(!1)}.bind(this),3e3))},n._handleServiceError=function(e,t){if("CheckoutNotFound"==t.errorCode)return this.assignments.possession.remove(),this.yield("#missingLoan"),!0},n._eligibleFulfillments=function(){var e=[],i=this.assignments.possession,s=t.try(this.assignments.title,"format");if(!i||!s)return e;var n=!1,o=!1;return t.each(r.knownFulfillments(),function(r){if(t.among(s,r.formats)){r=t.clone(r),r.isFulfillable=i.fulfiller.isFulfillable(r.fulfillmentSubtype),r.isLockedIn=i.fulfiller.isLockedIn(r.fulfillmentSubtype),r.isPrimary=!(!r.isFulfillable||!r.isMemorable),n=n||r.isPrimary,o=o||r.isLockedIn;for(var a=0,l=e.length;a<l;++a)if(e[a].fulfillmentType==r.fulfillmentType){if(e[a].isFulfillable||!r.isFulfillable)return;return void(e[a]=r)}("kindle"!=r.fulfillmentType||r.isFulfillable||!i.library||i.library.promotesKindle)&&e.push(r)}},this),t.each(e,function(e){n||(e.isPrimary="media-do"==e.fulfillmentType&&e.isFulfillable),o&&(e.isLockedOut=!e.isLockedIn&&"bifocal"!=e.fulfillmentType)}),e},n._returningAssignments=function(){return{fulfillmentChoice:this.assignments.fulfillmentChoice}},s}),define("app/views/interviews/circ/interview-circ-renew-loan",["require","common","app/views/interviews/circ/interview-circ-borrow-title"],function(e){var t=e("common"),i=e("app/views/interviews/circ/interview-circ-borrow-title"),s=i.new(),n=s.prototype;return n.PREFIXES=t.flatten(["circ-renew-loan",i.prototype.PREFIXES]),n.commence=function(){return"#analyzeHolding"},n._circChoices=n._possessionCircChoices,n._analyzeHolding=function(e){e.spin();var i={},s=this.assignments.possession,n=t.try(s,"holding()");return s&&"loan"==s.type&&n?void n.use(function(e){if(s.isWithinRenewalWindow())if(s.isLuckyDayLoan)i.error="circ.error.cannot-renew-lucky-day",i.errorExits=["hold","shelf"],this.yield("#explainError",i);else{if(!n.hasPeopleWaiting()||!n.isHoldable)return n.hasPeopleWaiting()&&(i.unlikely=!0),this.yield("#confirmRenewal",i);this.yield("#peopleWaiting")}else this.yield("#notRenewableYet")},this):this.yield("#loanNotFound")},n._loanNotFound=function(e){e.characterize({status:"error",mascot:"failure"}),e.say({html:this._circPhrase("404")}),e.answer({done:this._exitBack.bind(this)})},n._notRenewableYet=function(e){e.characterize({status:"error",mascot:"failure"});var i={},s=this.assignments.possession;if(!s.isWithinRenewalWindow()){var n=s.renewableTime-t.epochMilliseconds(),r=864e5;i.DAYS=Math.max(1,Math.round(n/r))}e.say({label:"circ.error.cannot-renew-yet",substitutions:i}),this._constructExit(e,"shelf",!0),this._constructExit(e,"similar-titles")},n._peopleWaiting=function(e){e.characterize({status:"error",mascot:"failure"}),e.say("circ.warning.cannot-renew-because-holds"),this._constructExit(e,"hold",!0),this._constructExit(e,{label:"mascot.persevere",action:this.thenYield("#confirmRenewal")}),this._constructExit(e,"shelf");
},n._confirmRenewal=function(e){e.markAsRewritable(e.name),this.assignments.unlikely&&(e.characterize({status:"failure",semaphores:{sayings:"square"}}),e.say("circ.warning.cannot-renew")),this._circOptionPossessionSummary(e),this._circOptionPeriod(e),this._circConfirmControls(e)},n._completeRenewal=function(e){e.characterize({status:"complete"}),this._constructExit(e,"shelf",!0),this._constructExit(e,"open"),this._constructExit(e,"similar-titles")},n._executeAction=function(e){e.characterize({status:"pending"}),e.access("inert"),APP.sentry.renewLoan(this.assignments.possession,this._onActionExecuted.bind(this),this._onServiceFailure.bind(this))},n._onActionExecuted=function(e){APP.scribe.record("loan:renew",{"title:id":e.title.titleId}),this._onExecutionComplete("#completeRenewal",{loan:e})},n._handleServiceError=function(e,s){if("CheckoutNotWithinRenewalWindow"==s.errorCode||"HoldNotWithinRenewalWindow"==s.errorCode)return this._errorWithYield("#notRenewableYet");if("HoldsPreventRenewal"==s.errorCode)return this._errorWithYield("#explainError",{error:"circ.error.cannot-renew-because-holds",errorExits:["hold","shelf"]});if("LuckyDayCheckoutCannotBeRenewed"==s.errorCode)return this._errorWithYield("#explainError",{error:"circ.error.cannot-renew-lucky-day",errorExits:["hold","shelf"]});if("RenewalFailed"==s.errorCode){var n={error:"circ.error.cannot-renew",errorExits:["hold","shelf"]};return t.try(this.assignments.possession,"holding().isHoldable")&&(n.error+="-but-holdable"),this._errorWithYield("#explainError",n)}return i.prototype._handleServiceError.call(this,e,s)},n._checkSuccess=function(){var e=APP.patron.loans.find({"title.titleId":this.title.titleId});return!(!e||e.expireTime==this._.oldExpireTime)},n._exitRetry=function(e){this.boundary(),this.yield(this.commence(),e)},s}),define("app/views/interviews/circ/interview-circ-return-loan",["require","common","app/views/interviews/circ/interview-circ-base","app/views/about/flower-fountain"],function(e){var t=e("common"),i=e("app/views/interviews/circ/interview-circ-base"),s=i.new(),n=s.prototype,r=e("app/views/about/flower-fountain");return n.PREFIXES=t.flatten(["circ-return-loan",i.prototype.PREFIXES]),n.AMAZON_SHELF_URL="https://www.amazon.com/hz/mycd/digital-console/contentlist/booksAll/dateDsc/",n.commence=function(){var e=this.assignments.possession;return e&&"loan"==e.type?e.fulfiller.isLockedIn("kindle")?"#kindleLocked":e.isWithinReturnWindow()?"#confirmReturn":"#notYetReturnable":"#loanNotFound"},n.commentate=function(e,t){return"outcome"==e&&this.assignments.fulfillmentChoice?this._textify(t,{html:this._circPhrase({label:"commentary.action.check"})}):i.prototype.commentate.call(this,e,t)},n._configure=function(e,s){if(i.prototype._configure.call(this,e,s),t.try(s,"expiring")){var n=this._considerAlternatives(this.assignments.possession);n&&this.assign({alternativeAction:n})}},n._considerAlternatives=function(e){var e=this.assignments.possession,i=(e.journey.progress||0)>.9;if(!i&&!e.isLuckyDayLoan&&e.isWithinRenewalWindow()){var s=t.select(e.card.holds(),function(t){if(t.title.titleId==e.title.titleId)return t});if(!s.length)return e.holding().numberOfHoldsByOthers()?"hold":"renew"}},n._loanNotFound=function(e){e.characterize({status:"error",mascot:"failure"}),e.say("circ-return-loan.404"),e.answer({done:this._exitBack.bind(this)})},n._notYetReturnable=function(e){e.characterize({status:"error",mascot:"failure"}),e.say("circ.error.cannot-return-yet"),e.answer({done:this._exitBack.bind(this)})},n._kindleLocked=function(e){e.characterize({status:"speech",mascot:"academy"}),e.say({label:"circ-return-loan.kindle-locked.1"}),e.say({label:"circ-return-loan.kindle-locked.2"}).querySelector("a").removeAttribute("href"),e.answer({label:"circ-return-loan.kindle-locked.action",yield:"interview/circ/fulfill-loan",assign:{action:"fulfill",psnLongKey:"loan-"+this.assignments.possession.psnKey,parameters:{fftType:"kindle"},rememberChoice:!1,callback:"#postKindle"}}).emphasize()},n._postKindle=function(e){var i=t.try(this.assignments.possession,"psnKey");if(!i||!APP.patron.loans.find({psnKey:i}))return this._exitBack();this.boundary(),e.characterize({status:"complete",semaphores:{sayings:"square"}});var s="circ-return-loan.kindle-locked.post-fulfill";e.say(s),this._constructExit(e,{label:s+".yes",action:this._pretendLoanReturned.bind(this)},"emph"),this._constructExit(e,{label:s+".no",action:this._resetAndOpenHelp.bind(this)}),this._constructExit(e,{label:"mascot.skip",action:this._exitBack.bind(this)})},n._confirmReturn=function(e){e.markAsRewritable(e.name);var t=this.assignments.alternativeAction;if(t){e.characterize({status:"speech",semaphores:{sayings:"square"}});var i={label:"circ-return-loan.alternative."+t,enliven:{}};i.enliven["#"+t]=this.thenYield("interview/circ/"+t+"-loan",{action:t,psnLongKey:"loan-"+this.assignments.possession.psnKey}),e.say(i)}this._circOptionPossessionSummary(e),this._circOptionDueDate(e,"emph"),this._circConfirmControls(e)},n._completeReturn=function(e){e.characterize({status:"complete"}),this._constructExit(e,"shelf",!0),this._constructExit(e,"journey"),this._constructExit(e,"similar-titles")},n._circOptionDueDate=function(e,t){var i=this.assignments.possession;return e.construct("option-returning",this._circOption(["flex"," expiry-date",{label:"circ-return-loan.expiry-info",substitutions:{EXPIRY_DATE:i.expireTime}}," expiry-distance",{html:i.distanceInTimeToExpiry()}],t))},n._executeAction=function(e){e.characterize({status:"pending"}),e.access("inert"),APP.sentry.returnLoan(this.assignments.possession,this._onActionExecuted.bind(this),this._onServiceFailure.bind(this))},n._onActionExecuted=function(){APP.scribe.record("loan:return",{"title:id":this.assignments.title.titleId}),this._onExecutionComplete("#completeReturn")},n._handleServiceError=function(e,t){if("CannotEarlyReturnWhenFulfilledOnKindle"==t.errorCode)return this.yield("#kindleLocked"),!0},n._checkSuccess=function(){var e=APP.patron.loans.find({"title.titleId":this.title.titleId});return!e&&(this._onActionExecuted(),!0)},n._lookupExit=function(e){return"renew-loan"==e?{label:"action.loan.renew",action:this.thenYield("interview/circ/renew-loan",{title:this.assignments.title,psnLongKey:"loan-"+this.assignments.possession.psnKey})}:i.prototype._lookupExit.apply(this,arguments)},n._pretendLoanReturned=function(){APP.patron.sync.ignorables.push({checkoutId:this.assignments.possession.checkoutId}),this.assignments.possession.remove(),this._exitBack()},n._resetAndOpenHelp=function(){this._defer(this.thenYield("#kindleLocked"),1e3),APP.shell.openURL(APP.constants.URLS["help:kindle-returns"])},n._setupStage=function(e){this._build("interview-circ-return-stage",{parentNode:e}," limelight",{graphic:"limelight"}," bouquet",{button:this._giveFlowers.bind(this),html:"💐",access:"visual","data-halo-states":"focus"})},n._giveFlowers=function(e){new r(e.tappedElement),this.access(e.tappedElement.parentNode,"inert")},s}),define("app/views/interviews/circ/interview-circ-hold-loan",["require","common","app/views/interviews/circ/interview-circ-hold-title"],function(e){var t=e("common"),i=e("app/views/interviews/circ/interview-circ-hold-title"),s=i.new(),n=s.prototype;return n.PREFIXES=t.flatten(["circ-hold-loan",i.prototype.PREFIXES]),n._circChoices=n._possessionCircChoices,n._completeHold=function(e){e.characterize({status:"complete"}),this._constructExit(e,"shelf",!0),this._constructExit(e,"return-loan"),this._constructExit(e,"similar-titles")},n._lookupExit=function(e){return"return-loan"==e?{label:"circ-return-loan.screen",action:this.thenYield("interview/circ/return-loan",{title:this.assignments.title,psnLongKey:"loan-"+this.assignments.possession.psnKey})}:i.prototype._lookupExit.apply(this,arguments)},n._exitRetry=function(e){this.boundary(),this.yield(this.commence(),e)},s}),define("app/views/interviews/circ/interview-circ-borrow-hold",["require","common","app/views/interviews/circ/interview-circ-borrow-title"],function(e){var t=e("common"),i=e("app/views/interviews/circ/interview-circ-borrow-title"),s=i.new(),n=s.prototype;return n.PREFIXES=t.flatten(["circ-borrow-hold",i.prototype.PREFIXES]),n.commence=function(){var e=this.assignments.possession;return e&&"hold"==e.type?"#confirmBorrow":"#holdNotFound"},n._circChoices=n._possessionCircChoices,n._confirmBorrow=function(e){e.markAsRewritable(e.name),e.characterize({status:"speech",semaphores:{sayings:"square"}}),e.say({label:"circ-hold-borrow.advice",enliven:{"#redeliver-hold":this.thenYield("interview/circ/redeliver-hold",{action:"redeliver",psnLongKey:"hold-"+this.assignments.possession.psnKey})}}),this._circOptionLibrary(e),this._circOptionCard(e),this._circOptionPeriod(e),this._circWarnings(e),this._circConfirmControls(e)},n._holdNotFound=function(e){e.characterize({status:"error",mascot:"failure"}),e.say("circ-borrow-hold.404"),e.answer({done:this._exitBack.bind(this)})},n._completeBorrow=function(e){e.characterize({status:"complete"}),this._constructExit(e,"open",!0),this._constructExit(e,"shelf")},n._exitRetry=function(e){this.boundary(),this.yield(this.commence(),e)},s}),define("shibui/src/components/form-slider",["require","common","./form-control","gala","shibui/src/haptics"],function(e){var t=e("common"),i=e("./form-control"),s=i.new(),n=s.prototype,r=e("gala"),o=e("shibui/src/haptics");return n.THUMB_PX=30,n.value=function(){return parseFloat(this._prepare().control.value)||0},n.setValue=function(e){var i=this._prepare().control,s=i.value;i.value=Math.round(e/this.options.step)*this.options.step;var n=parseFloat(i.value);return n===s||t.try(this._.grip,"captured")||this._defer("update",this._updateDisplayOfValue.bind(this),20),n},n.setValueAsPercentage=function(e){var t=this.options||{},i=Math.max(0,Math.min(1,e)),s=t.min+(t.max-t.min)*i,n=this.value(),r=this.setValue(s);return r!==n&&this._changeOfPercentage(100*i),r},n.changeScale=function(e){var i=function(t){"number"==typeof e[t]?this._attr(this.dom.control,t,e[t]):e[t]=parseFloat(this._attr(this.dom.control,t)||0)}.bind(this);if(t.each(["min","max","step"],i),this._textify(this.dom.steps),(e.max-e.min)/e.step<=50)for(var s=e.min;s<=e.max;s+=e.step)this._element({classes:"shibui-form-slider-step",parentNode:this.dom.steps});t.absorb(e,this.options),"number"==typeof e.value?this.setValue(e.value):this._defer("update",this._updateDisplayOfValue.bind(this))},n._expandOptions=function(e){return e=i.prototype._expandOptions.call(this,t.absorb(e,{min:0,max:100,step:1,haptics:!0})),"number"!=typeof e.value&&(e.value=e.min),e},n._layout=function(e){i.prototype._layout.apply(this,arguments);var s=t.absorb(this.options.control,{});s.tag="input",s.id=!0,s.attributes=t.absorb(s.attributes,{}),s.attributes.type="range",s.classes=s.classes||"halo",this._classify(e.root,"shibui-form-slider"),this._build("",{extending:e,element:e.core,extensionClass:"shibui-form-slider"}," range","  control",s,"  track",{id:!0,access:"visual"},"   above","   below","    needle","   steps"),this._attr(e.control,"data-halo-delegate",e.track.id),this.changeScale(this.options)},n._listen=function(e,t){i.prototype._listen.apply(this,arguments),this._handle("input",t.control),this.options.gripAxis?(e.grip={start:r.on(t.control,"touchstart",this._onGripStart.bind(this)),move:r.on(t.control,"touchmove",this._onGripMove.bind(this)),end:r.on(t.control,"touchend",this._onGripEnd.bind(this)),cancel:r.on(t.control,"touchcancel",this._onGripCancel.bind(this))},r.setTouchAction(t.control,"pan-"+this.options.gripAxis)):r.setTouchAction(t.control,"manipulation"),this.options.haptics&&o.prepare()},n._changeOfPercentage=function(e){this.options.haptics&&(e%100?o.select():o.impact("light")),this._defer(this._dispatchFieldEvent.bind(this,"change:immediate"))},n._onInputControl=function(e){this._changeOfPercentage(this._updateDisplayOfValue())},n._onChangeControl=function(e){this._defer("update",this._updateDisplayOfValue.bind(this)),i.prototype._onChangeControl.apply(this,arguments)},n._updateDisplayOfValue=function(){var e=this.value(),t=(e-this.options.min)/(this.options.max-this.options.min);this._updateDisplayToPercentage(t)},n._updateDisplayToPercentage=function(e){this._defer("update");var i=this.value();e*=100,t.prefixProperty(this.dom.below.style,"transform","translate3d("+(e-100)+"%,0,0)");var s=Math.ceil(this.dom.needle.offsetWidth/this.dom.below.offsetWidth*50);this.options.separateMinAndMax&&(this._classify(this.dom.root,"is-min",0===e),this._classify(this.dom.root,"is-max",100===e),s*=e%100?1:2);for(var n=0,r=this.dom.steps.children,o=this.options.min;o<=this.options.max;o+=this.options.step){var a=r[n],l=(o-this.options.min)/(this.options.max-this.options.min)*100;l+=.05*(l-50);var c=Math.abs(l-e);this._classify(a,"is-above",o>i),this._classify(a,"is-adjacent",c<s+5),this._classify(a,"is-within",c<s),n+=1}return e},n._fieldEventData=function(){return{field:this,value:this.value(),validity:this._.validity,control:this.dom.control}},n._onGripStart=function(e){var t=this._.grip={originalValue:this.value()};r.stop(e),this._gripAddEvent(t,e),this._gripApplyToAxis(t)},n._onGripMove=function(e){this._.grip&&(r.stop(e),this._gripAddEvent(this._.grip,e),this._gripApplyToAxis(this._.grip))},n._onGripEnd=function(e){this._.grip&&(r.stop(e),this._updateDisplayOfValue(),this._defer("announce",this._dispatchFieldEvent.bind(this,"change")),delete this._.grip)},n._onGripCancel=function(e){this._.grip&&(this.value()!=this._.grip.originalValue&&(this.setValue(this._.grip.originalValue),this._defer("announce",this._dispatchFieldEvent.bind(this,"change"))),delete this._.grip)},n._gripAddEvent=function(e,t){var i=t.touches[0].pageX-window.pageXOffset,s=t.touches[0].pageY-window.pageYOffset;e.rect||(e.rect=this.dom.track.getBoundingClientRect()),i-=e.rect.left,s-=e.rect.top,"number"!=typeof e.xStart&&(e.xStart=i,e.yStart=s),e.x=i,e.y=s,e.xPercent=Math.max(0,Math.min(1,i/e.rect.width)),e.yPercent=Math.max(0,Math.min(1,s/e.rect.height))},n._gripApplyToAxis=function(e){var t=e[this.options.gripAxis+"Percent"];this.setValueAsPercentage(t),this._updateDisplayToPercentage(t)},s}),define("app/views/components/interviews/constructs/hold-suspension-slider",["require","common","shibui/src/view","shibui/src/components/form-slider"],function(e){var t=e("common"),i=e("shibui/src/view"),s=i.new(),n=s.prototype,r=e("shibui/src/components/form-slider");return n.SLIDER_MIN=0,n.SLIDER_MAX=31,n.MAXES=[60,90,180],n.MAX_KEY="hold:suspension:max",n.$init=function(e){this.options=t.absorb(e,{}),this.options.parentNode&&this.impart(t.excise(this.options,"parentNode"))},n.value=function(){return this._prepare(),this.dom.slider.value()},n.setValue=function(e){this._prepare(),this._.appliedMax=e>=this.SLIDER_MAX?e:null,this.dom.slider.setValue(Math.min(e,this.SLIDER_MAX)),this._updateIndicator(e),this._defer(this._positionFingerprint.bind(this),100)},n._layout=function(e){this._build("hold-suspension-slider",{extending:e}," indicator"," slider",{construct:r,with:t.absorb({gripAxis:"x",min:0,max:this.SLIDER_MAX,separateMinAndMax:!0},t.absorb(this.options,{}))})},n._listen=function(e,t){this._handle("form:field:change:immediate",t.slider),this._handle("form:field:change",t.slider),this._handle("form:field:blur",t.slider)},n._onFormFieldChangeImmediateSlider=function(e){var t=this._trueDays(e.m.value);this.dom.indicator.setAttribute("aria-live","assertive"),this._updateIndicator(t),this._interactionOccurred(),this._dispatch("hold:suspension:days:change:immediate",{days:t})},n._onFormFieldChangeSlider=function(e){this._onFormFieldChangeImmediateSlider(e),this.dom.slider.hasFocus?this._.queueChange=!0:this._announceChange(e.m.value)},n._onFormFieldBlurSlider=function(e){this._.queueChange&&(delete this._.queueChange,this._announceChange(e.m.value))},n._announceChange=function(e){this._dispatch("hold:suspension:days:change",{days:this._trueDays(e)})},n._interactionOccurred=function(){s._hasInteracted||(s._hasInteracted=!0,this._classify(this.dom.fingerprint,"hide"))},n._updateIndicator=function(e){var t={substitutions:{}};e?(t.label=this.options.labels+".indicator.duration",e>=this.SLIDER_MAX&&(t.enliven={"#duration":this._pickMaxDays.bind(this)}),t.substitutions.DURATION=this._phrase({label:"units.days",substitutions:{N:e}})):t.label=this.options.labels+".indicator.active",this._updateExplanation(e),this._textify(this.dom.indicator,t);var i=this.dom.indicator.querySelector("a[href]");i&&t.enliven?this._classify(i,"pop"):i&&(i.removeAttribute("href"),i.setAttribute("aria-disabled","true"))},n._updateExplanation=function(e){return this.explained?void this._defer("explain",this._updateExplanationNow.bind(this,e),500):(this.explained=!0,this._updateExplanationNow(e))},n._updateExplanationNow=function(e){this.dom.slider.explain(t.try(this.options,"explainer()",e)||{label:this.options.labels+".advice",substitutions:{REDELIVERY_DATE:t.epochMilliseconds()+24*e*60*60*1e3}})},n._maxDays=function(){return this._.appliedMax||APP.patron.choice(this.MAX_KEY)||t.last(this.MAXES)},n._trueDays=function(e){return e==this.SLIDER_MAX?this._maxDays():e},n._pickMaxDays=function(e){APP.arena.popover(e.target).choices(function(e){t.each(this.MAXES,function(t){e.choice({label:"units.days",substitutions:{N:t},classes:t==this._.appliedMax?"innate":null,button:this._saveMaxDays.bind(this,t)})},this)}.bind(this))},n._saveMaxDays=function(e){this._interactionOccurred(),APP.patron.choose(this.MAX_KEY,e),this.setValue(e),this._announceChange(this.SLIDER_MAX)},n._positionFingerprint=function(){if(!s._hasInteracted){this.dom.fingerprint=this.dom.fingerprint||this._element({graphic:"fingerprint",parentNode:this.dom.root,classes:"hold-suspension-slider-fingerprint",access:"visual"});var e=this.dom.fingerprint.getBoundingClientRect(),t=this.dom.slider.dom.needle.getBoundingClientRect();this.dom.fingerprint.style.setProperty("left",t.left-e.left+(t.width-e.width)/2+"px"),this.dom.fingerprint.style.setProperty("top",t.top-e.top+(t.height-e.height)/2+"px")}},s}),define("app/views/interviews/circ/interview-circ-suspend-hold",["require","common","app/views/interviews/circ/interview-circ-base","app/views/components/interviews/constructs/hold-suspension-slider"],function(e){var t=e("common"),i=e("app/views/interviews/circ/interview-circ-base"),s=i.new(),n=s.prototype,r=e("app/views/components/interviews/constructs/hold-suspension-slider");return n.PREFIXES=t.flatten(["circ-suspend-hold",i.prototype.PREFIXES]),n.SLIDER_LABELS="circ-suspend",n.DEFAULT_DAYS_TO_SUSPEND=7,n.commence=function(){var e=this.assignments.possession;return e&&"hold"==e.type?"#confirmSuspension":"#missingHold"},n.commentate=function(e,t){var s;return"outcome"==e&&this.assignments.daysToSuspendHold?s=this._circPhrase({label:"commentary.outcome",substitutions:{DAYS:this.assignments.daysToSuspendHold}}):"outcome"==e&&(s=this._circPhrase("commentary.outcome.unsuspend")),s?this._textify(t,{html:s}):i.prototype.commentate.call(this,e,t)},n._configure=function(e,t){if(i.prototype._configure.call(this,e,t),"number"!=typeof this.assignments.daysToSuspendHold){var s=this.assignments.possession;s&&"hold"==s.type&&this.assign({daysToSuspendHold:Math.ceil(s.suspendedDaysRemaining())||this.DEFAULT_DAYS_TO_SUSPEND})}},n._missingHold=function(e){e.characterize({status:"error",mascot:"failure"}),e.say("circ-borrow-hold.404"),e.answer({done:this._exitBack.bind(this)})},n._confirmSuspension=function(e){e.markAsRewritable(e.name),this._circOptionPossessionSummary(e),this._circOptionSuspensionDuration(e,"emph"),this._circConfirmControls(e)},n._completeSuspension=function(e){e.characterize({status:"complete"}),this._constructExit(e,"shelf",!0),this._constructExit(e,"similar-titles")},n._circOptionSuspensionDuration=function(e,t){return e.construct("option-duration",this._circOption(["duration"],function(t){t.slider=new r({parentNode:t.duration,labels:this.SLIDER_LABELS,required:!0}),t.slider.setValue(this.assignments.daysToSuspendHold),t.slider.on("hold:suspension:days:change",function(e){this.assign({daysToSuspendHold:e.m.days})}.bind(this)),"circ-suspend"==this.SLIDER_LABELS&&t.slider.on("hold:suspension:days:change:immediate",function(t){var i=!!t.m.days;i!==this.assignments.isSuspending&&(this.assign({isSuspending:i}),this._textify(e.dom.confirmControls.querySelector(".shibui-button"),"circ-suspend-hold.confirm-button"+(i?"":".unsuspend")))}.bind(this))}.bind(this),t))},n._executeAction=function(e){e.characterize({status:"pending"}),e.access("inert"),APP.sentry.updateHold(this.assignments.possession,{daysToSuspendHolds:this.assignments.daysToSuspendHold},this._onActionExecuted.bind(this),this._onServiceFailure.bind(this))},n._onActionExecuted=function(){APP.scribe.record("hold:suspend",{"title:id":this.assignments.title.titleId,duration:this.assignments.daysToSuspendHold}),this._onExecutionComplete("#completeSuspension")},n._checkSuccess=function(){return!1},s}),define("app/views/interviews/circ/interview-circ-redeliver-hold",["require","common","app/views/interviews/circ/interview-circ-suspend-hold"],function(e){var t=e("common"),i=e("app/views/interviews/circ/interview-circ-suspend-hold"),s=i.new(),n=s.prototype;return n.PREFIXES=t.flatten(["circ-redeliver-hold",i.prototype.PREFIXES]),n.SLIDER_LABELS="circ-redeliver",s}),define("app/views/interviews/circ/interview-circ-cancel-hold",["require","common","app/views/interviews/circ/interview-circ-base"],function(e){var t=e("common"),i=e("app/views/interviews/circ/interview-circ-base"),s=i.new(),n=s.prototype;return n.PREFIXES=t.flatten(["circ-cancel-hold",i.prototype.PREFIXES]),n.commence=function(){var e=this.assignments.possession;return e&&"hold"==e.type?"#confirmCancel":"#missingHold"},n._missingHold=function(e){e.characterize({status:"error",mascot:"failure"}),e.say("circ-borrow-hold.404"),e.answer({done:this._exitBack.bind(this)})},n._confirmCancel=function(e){e.markAsRewritable(e.name),this._circOptionPossessionSummary(e),this._circOptionHoldPlaced(e,"emph"),this._circConfirmControls(e)},n._completeCancel=function(e){e.characterize({status:"complete"}),this._constructExit(e,"shelf",!0),this._constructExit(e,"similar-titles")},n._circOptionHoldPlaced=function(e,t){return e.construct("option-placed",this._circOption(["flex"," placed {hold.created}"," placed-date <strong>",{html:this._phrase({relativeDate:this.assignments.possession.createTime})}],t))},n._executeAction=function(e){e.characterize({status:"pending"}),e.access("inert"),APP.sentry.cancelHold(this.assignments.possession,this._onActionExecuted.bind(this),this._onServiceFailure.bind(this))},n._onActionExecuted=function(){APP.scribe.record("hold:cancel",{"title:id":this.assignments.title.titleId}),this._onExecutionComplete("#completeCancel")},n._checkSuccess=function(){var e=APP.patron.holds.find({"title.titleId":this.title.titleId});return!e&&(this._onActionExecuted(),!0)},s}),define("shibui/src/components/form-switch-radio",["require","common","./form-switch"],function(e){var t=e("common"),i=e("./form-switch"),s=i.new(),n=s.prototype;return n._expandOptions=function(e){return e.attributes=t.absorb({type:"radio"},e.attributes||{}),i.prototype._expandOptions.call(this,e)},n._layout=function(e){i.prototype._layout.apply(this,arguments),this._classify(e.root,"shibui-form-switch-radio")},s}),define("shibui/src/components/form-radio-tower",["require","common","./form-field","./form-switch-radio"],function(e){var t=e("common"),i=e("./form-field"),s=i.new(),n=s.prototype,r=e("./form-switch-radio");return n.value=function(){var e;return t.each(this.dom.root.children,function(i){var s=i._view;s&&!s.isOff()&&(e=s.value(),t.breakIteration())},this),this._.memoValue=e},n.setValue=function(e){t.each(this.dom.root.children,function(t){var i=t._view;if(i){var s=i.value()==e;i.switch(s),s&&(this._.memoValue=e)}},this)},n._layout=function(e){this._build("shibui-form-radio-tower",{extending:e});var i=this._generateIdAttribute("form-radio-tower");t.each(this.options.radios,function(t,s){t.name=i,t.parentNode=e.root;var n=new r(t);n.on("form:field:change",this._onFormFieldChangeRadio.bind(this)),n.on("form:field:tap",this._onFormFieldTapRadio.bind(this))},this)},n._onFormFieldChangeRadio=function(e){this._dispatchFieldEvent("change",{value:this.value()})},n._onFormFieldTapRadio=function(e){this._.memoValue==this.value()&&this._dispatchFieldEvent("repeat",{value:this.value()})},s}),define("app/views/interviews/configure/interview-configure-accessibility",["require","common","app/views/components/interviews/interview","app/views/core/block-strap","shibui/src/components/form-radio-tower","shibui/src/components/form-switch-toggle"],function(e){var t=(e("common"),e("app/views/components/interviews/interview")),i=t.new(),s=i.prototype,n=e("app/views/core/block-strap"),r=e("shibui/src/components/form-radio-tower"),o=e("shibui/src/components/form-switch-toggle");return s.commence=function(e){return"#configureAccessibility"},s._configureAccessibility=function(e){e.say("configure-accessibility.intro"),e.construct("strap-effects",new n),e.dom.strapEffects.configure({text:"configure-accessibility.head.effects"}),e.construct("toggle-color-variation",new o({label:"configure-accessibility.color-variation.label",explanation:"configure-accessibility.color-variation.explain"})),e.dom.toggleColorVariation.switch(!!APP.patron.choice("aide:reduce:color-variation")),e.dom.toggleColorVariation.on("form:field:change",this._onFormFieldChangeColorVariation.bind(this)),e.construct("toggle-text-variation",new o({label:"configure-accessibility.text-variation.label",explanation:"configure-accessibility.text-variation.explain"})),e.dom.toggleTextVariation.switch(!!APP.patron.choice("aide:reduce:text-variation")),e.dom.toggleTextVariation.on("form:field:change",this._onFormFieldChangeTextVariation.bind(this)),e.construct("toggle-motion",new o({label:"configure-accessibility.motion.label",explanation:"configure-accessibility.motion.explain"})),e.dom.toggleMotion.switch(!!APP.patron.choice("aide:reduce:motion")),e.dom.toggleMotion.on("form:field:change",this._onFormFieldChangeMotion.bind(this)),APP.shell.has("ui:haptics")&&(e.construct("toggle-haptics",new o({label:"configure-accessibility.haptics.label",explanation:"configure-accessibility.haptics.explain"})),e.dom.toggleHaptics.switch(!!APP.patron.choice("aide:reduce:haptics")),e.dom.toggleHaptics.on("form:field:change",this._onFormFieldChangeHaptics.bind(this))),APP.shell.info.platform&&(e.construct("strap-orientation",new n),e.dom.strapOrientation.configure({text:"configure-accessibility.head.orientation"}),e.construct("radio-orientation-locking",new r({radios:[{value:"smart",label:"configure-accessibility.orientation.smart.label",explanation:"configure-accessibility.orientation.smart.explain"},{value:"auto",label:"configure-accessibility.orientation.system.label",explanation:"configure-accessibility.orientation.system.explain"}]})),e.dom.radioOrientationLocking.setValue(APP.patron.choice("aide:orientation:locking")||"smart"),e.dom.radioOrientationLocking.on("form:field:change",this._onFormFieldChangeOrientationLocking.bind(this))),e.construct("strap-shortcuts",new n),e.dom.strapShortcuts.configure({text:"configure-accessibility.head.shortcuts"}),e.say("configure-accessibility.shortcuts.explain"),e.construct("mural",this._build("accessibility-mural",{access:"visual"}," keyboard","  shift-key",{html:"Shift",wrapper:"span"},"  plus",{html:"+"},"  punct-key",{html:"?<br/>/"}).root),APP.imageDirector.mural(e.dom.mural,"menu-desktop",{classes:"accessibility-mural-graphic"})},s._onFormFieldChangeColorVariation=function(e){APP.patron.choose("aide:reduce:color-variation",e.m.on)},s._onFormFieldChangeTextVariation=function(e){APP.patron.choose("aide:reduce:text-variation",e.m.on)},s._onFormFieldChangeMotion=function(e){APP.patron.choose("aide:reduce:motion",e.m.on)},s._onFormFieldChangeHaptics=function(e){APP.patron.choose("aide:reduce:haptics",e.m.on)},s._onFormFieldChangeOrientationLocking=function(e){var t="smart"==e.m.value?null:e.m.value;APP.patron.choose("aide:orientation:locking",t)},i}),define("app/views/popovers/popover-library-editor",["require","common","shibui/src/view","app/views/account/library-colors","shibui/src/components/form-input"],function(e){var t=e("common"),i=e("shibui/src/view"),s=i.new(),n=s.prototype,r=e("app/views/account/library-colors"),o=e("shibui/src/components/form-input");return n.become=function(e){return this.library=e,this._.cursor=1,this},n.present=function(e){return APP.arena.popover(e).form(this._buildPopover.bind(this))},n._buildPopover=function(e,i){this.dom=e._build("library-editor",{element:i}," name-form",{tag:"form",parentNode:i,attributes:{method:"GET",action:"#"}}," color-palette"," color-preview",{button:this._flipColors.bind(this)}),i.setAttribute("data-popover-arrow-color","none"),e._formify(this.dom.nameForm,this._onFormSubmit.bind(this)),this._.closeHandler=APP.events.on("popover:close",this._onFormSubmit.bind(this)),this.dom.nameInput=new o({form:this.dom.root,parentNode:this.dom.nameForm,lines:1,value:this.library.rawName(),placeholder:{html:this.library._.name},attributes:{maxlength:Math.max(32,Math.floor(1.2*this.library._.name.length)),"aria-label":this._phrase("a11y.library-editor.rename")}}),this.dom.nameInput.on("form:field:focus",function(){e.reposition()}),this.dom.wells=[];var s=[t.try(this.library,"_.userAssignedColors[0].hex"),t.try(this.library,"_.userAssignedColors[1].hex")];return t.each(this._generateColorPalette(),function(e,t){var i=["library-editor-color-well"];e==s[0]&&i.push("is-chosen-0"),e==s[1]&&(i.push("is-chosen-1"),i.push("is-cursor"));var n=this._element({button:this._onChooseColor.bind(this,e),parentNode:this.dom.colorPalette,classes:i.join(" "),spoken:{label:"a11y.library-editor.color",substitutions:{N:t+1}},attributes:{style:"color:"+e}});this.dom.wells.push(n)},this),this.dom.libraryColors=new r(this.dom.colorPreview),this.dom.libraryColors.size=804,this.dom.libraryColors.become(this.library),this._onFormSubmit.bind(this)},n._generateColorPalette=function(){for(var e=[],i=0;i<8;++i)e.push(t.hsluvToHex([45*i,80,70]));for(var i=0;i<8;++i)e.push(t.hsluvToHex([45*i+20,90,50]));for(var i=0;i<8;++i)e.push(t.hsluvToHex([45*i+10,100,30]));return e.push("#631A35"),e.push("#A61C49"),e.push("#29CFC3"),e.push("#DDCC88"),e.push("#F9A61F"),e.push(t.hsluvToHex([0,0,60])),e.push(t.hsluvToHex([0,0,30])),e.push(t.hsluvToHex([0,0,10])),e},n._onChooseColor=function(e,i){for(var s=[t.try(this.library,"_.userAssignedColors[0].hex"),t.try(this.library,"_.userAssignedColors[1].hex")],n=t.compact([t.try(this.library,"_.colors[0].hex"),t.try(this.library,"_.colors[1].hex")]);n.length<2;)n.push(this.library.DEFAULT_COLORS[n.length].hex);if(s[0]==e)s[1]?s[0]=n[0]:s=[],APP.arena._declassify(i.target,"is-chosen-0"),APP.arena._declassify(i.target,"is-chosen-1"),this._.cursor=0;else if(s[1]==e)s[0]?s[1]=n[1]:s=[],APP.arena._declassify(i.target,"is-chosen-0"),APP.arena._declassify(i.target,"is-chosen-1"),this._.cursor=1;else{s[this._.cursor]=e;var r=(this._.cursor+1)%2;s[r]||(s[r]=n[r]),t.batonClass(i.target,"is-chosen-"+this._.cursor,this.dom.root),this._.cursor=r}var o=this.dom.root.querySelector(".is-chosen-"+this._.cursor);if(t.batonClass(o,"is-cursor",this.dom.root),s.length){var a=this.library._.userAssignedColors=[];t.each(s,function(e){a.push({hex:e,rgb:t.hexToRGB(e)})})}else delete this.library._.userAssignedColors;this._announceColors()},n._flipColors=function(e){var i=[t.try(this.library,"_.userAssignedColors[0].hex"),t.try(this.library,"_.userAssignedColors[1].hex")];i[0]||(i=[t.try(this.library,"_.colors[0].hex"),t.try(this.library,"_.colors[1].hex")]);var s=this.library._.userAssignedColors=[];t.each(i.reverse(),function(e){s.push({hex:e,rgb:t.hexToRGB(e)})}),this._announceColors()},n._announceColors=function(){var e=APP.libraries.paintColors();APP.events.dispatch("library:colors",{library:this.library,colors:e})},n._onFormSubmit=function(e){if(this.dom.nameInput.validate()){
APP.events.off(this._.closeHandler),this.dom.libraryColors&&(this.dom.libraryColors.extract(),delete this.dom.libraryColors);var t=this.dom.nameInput.value().trim();t&&t!=this.library._.name?this.library._.userAssignedName=t:delete this.library._.userAssignedName,APP.libraries.save(),APP.arena.popover().close()}},s}),define("app/views/interviews/configure/interview-configure-cards",["require","common","app/views/components/interviews/interview","app/views/account/library-card-icon","app/views/account/library-cards-list","app/views/dialogs/dialog-library-picker","app/views/popovers/popover-library-editor"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("app/views/account/library-card-icon"),o=e("app/views/account/library-cards-list"),a=e("app/views/dialogs/dialog-library-picker"),l=e("app/views/popovers/popover-library-editor");return n.commence=function(e){return!this.assignments.library&&this.parameters?{path:"interview/locate-library/resolve",parameters:this.parameters,callback:!0}:(this.assignments.library||this.assign({library:APP.library}),this.assignments.library?"#listLibraryCards":"#missingArgs")},n._configure=function(e,t){this.parameters=this._extractLibraryParameters(e,t)},n._listLibraryCards=function(e){e.dom.librarySelector=e.answer({html:this.assignments.library.safeName(),button:this._onTapLibrarySelector.bind(this,e),indicator:{}}).emphasize("modal"),e.dom.librarySelectorIcon=new r(e.dom.librarySelector.dom.indicator),this.access(e.dom.librarySelector.dom.indicator,"visual"),e.construct("intro",this._element({tag:"p"})),e.construct("library-cards-list",new o),e.dom.libraryCardsList.configure({compact:!0,activatable:!0,verifiable:!0,editable:!0}),e.construct("library-personalize-button",this._element({label:"configure-cards.personalize",button:this._onTapPersonalize.bind(this),classes:"list-library-cards-personalize-button"})),this._element({parentNode:e.dom.libraryPersonalizeButton,graphic:"library-personalize"}),e.construct("library-card-add-button",this._element({button:this._yieldToAuthInterview.bind(this),label:"configure-cards.add-card",spoken:"library-cards.add-card",classes:"list-library-cards-add-button shibui-button"})),this.handlers._onEpisodeRefresh=e.on("interview:episode:refresh",this._refreshList.bind(this,e)),this.handlers._onLibraryUpdateAll=APP.router.route.on("library:update:all",this.refresh.bind(this)),this.handlers._onCardUpdateAll=APP.router.route.on("card:update:all",this.refresh.bind(this)),this.handlers._onLibraryColors=APP.events.on("library:colors",this._onLibraryColors.bind(this,e))},n._refreshList=function(e){var i=this.assignments.library,s={HERE:0,ELSE:0};t.each(APP.patron.cards.all,function(e){s[e.library.websiteId==i.websiteId?"HERE":"ELSE"]+=1}),this._textify(e.dom.intro,{label:"library-cards.intro",substitutions:s}),e.dom.librarySelector.label({html:this.assignments.library.safeName()}),e.dom.librarySelectorIcon.become({library:this.assignments.library,card:this.assignments.library.card()});var n=t.try(i,"cards()")||[];e.dom.libraryCardsList.become(n),this._onLibraryColors(e)},n._onTapLibrarySelector=function(e,t){APP.haptics.select();var i=[],s=APP.libraries.includingNow(APP.libraries.withCards());s.length&&i.push({strap:{text:"menu.library.heading"},libraries:APP.libraries.byOldestCard(s),actions:{addLibrary:!0},options:{indicator:!0}});var n=APP.libraries.excludingNow(APP.libraries.recent());n.length&&i.push({strap:{text:"library-autocomplete.recent"},libraries:n,actions:{clearRecent:!0}});var r=new a;r.become(i),r.handle({"summary:library:select":this._onSummaryLibrarySelect.bind(this,r,e)}),r.present()},n._onSummaryLibrarySelect=function(e,i,s){APP.events.stop(s),APP.haptics.select(),t.try(e,"shade.minimize()"),this.assign({library:s.m.library}),this.refresh()},n._onTapPersonalize=function(e){var t=new l;t.become(this.assignments.library),t.present(e.target)},n._onLibraryColors=function(e){APP.libraries.paintColors(this.assignments.library,e.dom.libraryPersonalizeButton)},n._yieldToAuthInterview=function(){if(t.try(this.assignments.library,"baseKey")){var e=this.assignments.library.cards();this.yield("interview/authenticate/card",{intent:e.length?"login":void 0,library:this.assignments.library,origination:APP.router.route.path})}else this.yield("interview/locate-library/search")},s}),define("app/views/interviews/configure/interview-configure-downloads",["require","common","app/views/components/interviews/interview","shibui/src/components/form-radio-tower","shibui/src/components/form-switch-toggle"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("shibui/src/components/form-radio-tower"),o=e("shibui/src/components/form-switch-toggle");return n.commence=function(e){return"#changeDownloadRules"},n._changeDownloadRules=function(e){e.say("dld.intro");var i=[];if(t.each(APP.auditor.autoDownloadRules(),this._autoDownloadRuleToOption.bind(this,e,i)),e.construct("auto-download-radio",new r({radios:i})),e.dom.autoDownloadRadio.on("form:field:change",this._onFormFieldChangeAutoDownloadRadio.bind(this)),e.construct("auto-download-exclusions",this._element({classes:"dld-exclusions"})),this._updateFormatExclusions(e),APP.network.isPrecise){e.divider();var s="wifi"==APP.auditor.downloadQueueRule;e.construct("wifi-toggle",new o({label:"dld.wifi-toggle.label",explanation:"dld.wifi-toggle.explanation",isOn:s})),e.dom.wifiToggle.on("form:field:change",this._onFormFieldChangeWifiToggle.bind(this))}},n._autoDownloadRuleToOption=function(e,t,i){var s={};s.value=i[0],s.label={label:"dld.radio-label."+i[0]},s.explanation={label:"dld.radio-explanation."+i[0]},s.isOn=i[0]==APP.auditor.autoDownloadRule[0],"byte-limited"==i[0]&&(this._.byteLimit=i[1],s.label.substitutions={BYTES_LIMIT:this._phrase({label:"units.megabytes",substitutions:{N:i[1]}})},s.label.enliven={"#bytes":this._onTapAutoDownloadBytes.bind(this,e)}),t.push(s)},n._applyAutoDownloadRule=function(e){var t=[e];"byte-limited"==e&&t.push(this._.byteLimit),APP.auditor.setAutoDownloadRule(t)},n._onTapAutoDownloadBytes=function(e,i){var s=i.target;APP.arena.popover(s).choices(function(i){t.each(APP.auditor.AUTO_DOWNLOAD_MEGABYTE_LIMITS,function(t){i.choice({label:"units.megabytes",substitutions:{N:t},classes:t==this._.byteLimit?"innate":null,button:this._onTapAutoDownloadByteChoice.bind(this,e,s,t)})},this)}.bind(this))},n._onTapAutoDownloadByteChoice=function(e,t,i){var s="byte-limited";this._.byteLimit=i,this._textify(t,{label:"units.megabytes",substitutions:{N:i}}),e.dom.autoDownloadRadio.setValue(s),this._applyAutoDownloadRule(s)},n._onFormFieldChangeAutoDownloadRadio=function(e){this._applyAutoDownloadRule(e.m.value)},n._updateFormatExclusions=function(e){var i={};"kindle"==APP.summoner.daemons.fulfillmentChoices.preference("book")&&(i.books="kindle");var s=JSON.stringify(this._.formatExclusions),n=JSON.stringify(i);s!==n&&(this._.formatExclusions=i,this._textify(e.dom.autoDownloadExclusions),t.each(this._.formatExclusions,function(t,i){this._element({parentNode:e.dom.autoDownloadExclusions,classes:"dld-radio-label",label:["dld.auto-download.exclusions","dld.auto-download.excluded."+t]}),this._element({parentNode:e.dom.autoDownloadExclusions,classes:"shibui-form-field-explanation",label:"dld.auto-download.excluded.reason."+t,substitutions:{TYPE:i}})},this))},n._onFormFieldChangeWifiToggle=function(e){var t=e.m.on?"wifi":"go";APP.auditor.setDownloadQueueRule(t)},s}),define("app/views/interviews/configure/interview-configure-fulfillment",["require","common","app/views/components/interviews/interview"],function(e){var t=(e("common"),e("app/views/components/interviews/interview")),i=t.new(),s=i.prototype;return s.commence=function(e){return"#presentChoice"},s._presentChoice=function(e){e.say("circ-fulfill.explanation.preference"),e.construct("decider",this._decideWidget(e))},s._decideWidget=function(e){var t=this._build("circ-fulfill-loan .circ-fulfill-loan-global"," primary-options","  bifocal .circ-option","   .circ-option-fulfill-loan",{button:this.thenYield("#makeChoice",{choice:"bifocal"})},"    .circ-option-fulfill-loan-info","     .circ-option-fulfill-loan-sup-type {circ-fulfill.sup.bifocal}","     .circ-option-fulfill-loan-sub-type .circ-option-explainer {circ-fulfill.sub.bifocal}","    .circ-option-fulfill-indicator",{graphic:"star-indicator",access:"visual"},"  kindle .circ-option","   .circ-option-fulfill-loan",{button:this.thenYield("#makeChoice",{choice:"kindle"})},"    .circ-option-fulfill-loan-info","     .circ-option-fulfill-loan-sup-type {circ-fulfill.sup.kindle}","     .circ-option-fulfill-loan-sub-type .circ-option-explainer {circ-fulfill.sub.kindle}","    .circ-option-fulfill-indicator",{graphic:"star-indicator",access:"visual"}," secondary-options","  reset .circ-option","   .circ-option-fulfill-loan",{button:this.thenYield("#makeChoice",{choice:void 0})},"    .circ-option-fulfill-loan-info {circ-fulfill.clear}","    .circ-option-fulfill-indicator",{graphic:"star-indicator",access:"visual"});return this._updateDecisionStatus(t),e.on("interview:episode:refresh",this._updateDecisionStatus.bind(this,t)),t.root},s._updateDecisionStatus=function(e){var t=APP.summoner.daemons.fulfillmentChoices.preference();this._attr(e.bifocal,"aria-selected","bifocal"==t||null),this._attr(e.kindle,"aria-selected","kindle"==t||null),this._attr(e.reset,"aria-selected",!t||null)},s._makeChoice=function(e){var t=0;if("kindle"==this.assignments.choice){var i=APP.summoner.daemons.fulfillmentChoices;t=i.countDownloadsFulfillableAs("kindle")}t?(e.markAsRewritable(),e.say({label:"circ-fulfill.download-wipe-warning",substitutions:{DOWNLOADS:t}}),e.answer({label:"circ-fulfill.download-wipe-confirm",yield:"#commitChoice"}).emphasize("danger")):this._commitChoice(e)},s._commitChoice=function(e){e.markAsRewritable(e.name);var t=this.assignments.choice;APP.summoner.daemons.fulfillmentChoices.prefer("book",t),e.say("circ-fulfill.outcome.preference."+t),e.answer({done:"MENU"})},i}),define("app/views/interviews/configure/interview-configure-language",["require","common","app/views/components/interviews/interview"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype;return n.commence=function(e){if(this.assignments.systemLanguage)return"#offerSystemLanguage";var i=APP.shell.capability("diagnostics:platform-settings");return t.among("app-language",i)?"#nativeInstructions":"#chooseLanguage"},n._listen=function(e,t){return e.onAppLanguagePrompt=APP.events.on("app:language:prompt",this._onAppLanguagePrompt.bind(this)),i.prototype._listen.apply(this,arguments)},n._nativeInstructions=function(e){"iOS"==APP.shell.info.platform?e.say("language.change.ios"):"Android"==APP.shell.info.platform?e.say("language.change.android"):e.say("language.change.native"),e.answer({label:"notifications.repair.response.push.settings",button:this._openSettingsApp.bind(this)}).emphasize()},n._openSettingsApp=function(){this._defer("settings-app",function(){APP.shell.transmit({name:"diagnostics:platform-settings",settings:"app-language"})},100)},n._chooseLanguage=function(e){e.say("language.change.caveat"),e.say("language.change.override"),e.construct("language-list",this._element({tag:"ul",classes:"language-list"}));var i=function(e){return e.match(/^en/)},s=t.select(SPARK.locale.available,function(e){if(i(e))return e}),n=SPARK.locale.negotiate(SPARK.locale.userAgentTags,s)[0]||"en-US",r=[];t.each(SPARK.locale.available,function(e){if(i(e)){if(i(SPARK.locale.tag))return;if(e!=n)return}else if(e==SPARK.locale.tag)return;r.push([e,this._phrase("language.locale."+e)])},this),r.sort(function(e,t){return i(e[0])?-1:i(t[0])?1:e[1].localeCompare(t[1])}),t.each(r,function(t){var s=t[0],n=t[1],r=APP.constants.LANGUAGE_ENDONYMS[s];i(s)&&(r=this._phrase("configure-language.english")),this._build("language-list-item <li>",{parentNode:e.dom.languageList}," button",{button:this.thenYield("#confirmLanguage",{localeTag:s})},"  endonym <span>",{html:r,labeling:"button"},"  exonym <span>",{html:n,describing:"button"})},this)},n._confirmLanguage=function(e){e.markAsRewritable(e.name);var t=this._phrase("language.locale."+this.assignments.localeTag);e.say({label:"language.change.confirm",substitutions:{LOCALE_NAME:t}}),e.answer({label:"mascot.yes",yield:"#commitLanguage"}).emphasize(),e.answer({label:"mascot.no",yield:"#chooseLanguage"})},n._offerSystemLanguage=function(e){e.markAsRewritable();var t=APP.constants.LANGUAGE_ENDONYMS,i=t[this.assignments.sparkLanguage],s=t[this.assignments.systemLanguage];e.say({label:"configure-language.offer-system-language",substitutions:{CURRENT_LANGUAGE:i,SYSTEM_LANGUAGE:s}}),e.answer({html:i,yield:"BACK"}),e.answer({html:s,yield:"#commitLanguage",assign:{localeTag:this.assignments.systemLanguage}}).emphasize()},n._commitLanguage=function(e){e.spin();var t=this.assignments.localeTag,i=this.assignments.relaunchPath;APP.summoner.daemons.userLanguage.changeLanguageAndRelaunch(t,i)},n._onAppLanguagePrompt=function(e){this.assignments.systemLanguage||this.isInDocument()&&"true"!=this._attr("aria-hidden")&&(APP.events.stop(e),this.yield("#commitLanguage",{localeTag:e.m.systemLanguage}))},s}),define("app/views/interviews/configure/interview-configure-navigation",["require","common","app/views/components/interviews/interview","shibui/src/components/form-radio-tower","shibui/src/components/form-switch-toggle","app/views/core/block-strap"],function(e){var t=(e("common"),e("app/views/components/interviews/interview")),i=t.new(),s=i.prototype,n=e("shibui/src/components/form-radio-tower"),r=e("shibui/src/components/form-switch-toggle"),o=e("app/views/core/block-strap");return s.commence=function(e){return"#customizeNavigation"},s._customizeNavigation=function(e){if(e.say("settings.navigation.overview"),e.construct("strap-now",new o),e.dom.strapNow.configure({text:"settings.navigation.now-bar"}),e.construct("radio-now",new n({radios:[{value:"always",label:"settings.navigation.now-bar.always",explanation:"settings.navigation.now-bar.always.explanation"},{value:"scrolled",label:"settings.navigation.now-bar.scrolled",explanation:"settings.navigation.now-bar.scrolled.explanation"},{value:"shelf",label:"settings.navigation.now-bar.shelf",explanation:"settings.navigation.now-bar.shelf.explanation"}]})),e.dom.radioNow.setValue(APP.patron.choice("navigation:reading-now")||"always"),e.dom.radioNow.on("form:field:change",this._onFormFieldChangeReadingNow.bind(this)),SPARK.locale.isEnglish&&(e.construct("strap-nav",new o),e.dom.strapNav.configure({text:"settings.navigation.nav-bar"}),e.construct("toggle-nav-labels",new r({label:"settings.navigation.nav-bar.icon-labels",explanation:"settings.navigation.nav-bar.icon-labels.explanation"})),e.dom.toggleNavLabels.switch(!!APP.patron.choice("navigation:labels")),e.dom.toggleNavLabels.on("form:field:change",this._onFormFieldChangeFooterLabels.bind(this))),this._isJoystickModeAllowed()){e.construct("strap-joystick",new o),e.dom.strapJoystick.configure({text:"settings.navigation.compact"}),e.construct("disclaimer",this._element({tag:"p",label:"settings.navigation.compact.disclaimer",classes:"settings-disclaimer-experimental"})),e.construct("radio-joystick",new n({radios:[{value:"enable",label:"settings.navigation.compact.enable",explanation:"settings.navigation.compact.enable.explanation"},{value:"swipe",label:"settings.navigation.compact.swipe",explanation:"settings.navigation.compact.swipe.explanation"},{value:"disable",label:"settings.navigation.compact.disable",explanation:"settings.navigation.compact.disable.explanation"}]}));var t=APP.patron.choice("navigation:compact")||"disable";e.dom.radioJoystick.setValue(t),e.dom.radioJoystick.on("form:field:change",this._onFormFieldChangeCompactNavigation.bind(this))}},s._onFormFieldChangeReadingNow=function(e){APP.patron.choose("navigation:reading-now",e.m.value)},s._onFormFieldChangeFooterLabels=function(e){APP.patron.choose("navigation:labels",e.m.on)},s._onFormFieldChangeCompactNavigation=function(e){APP.patron.choose("navigation:compact",e.m.value)},s._isJoystickModeAllowed=function(){var e=APP.patron.choice("navigation:compact");return!(!e||"disable"==e)||(!!APP.flags.isOn("joystick")||(window.screen.width<=430||window.screen.height<=430))},i}),define("app/views/components/interviews/constructs/notification-toggle",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.become=function(e,t){var i=this._prepare();this._textify(i.name,"notification."+e),this._textify(i.description,"notification."+e+".description"),this.category=e,this._assignLevel(t),APP.events.off(this._.subscribeHandler),this._.subscribeHandler=APP.events.on("notifier:subscribe:"+this.category,this._onSubscribeCategory.bind(this))},n.applyLabels=function(e,i){for(var s=this._prepare(),n=2;n>=0;--n){var r=e[n];if(r){if("string"==typeof r&&(r={label:r}),i.visualLabels){s.labels=s.labels||this._element({parentNode:s.root,pos:"prepend",classes:"notification-toggle-labels",access:"visual"});var o=o||s.labels;o=s["label"+n]=this._element({parentNode:o,classes:"notification-toggle-label notification-toggle-label-"+n}),s["label-text"+n]=this._element(t.absorb(r,{tag:"span",parentNode:o,classes:"notification-toggle-label-text"}))}else{t.excise(s,"label"+n),t.excise(s,"label-text"+n);var a=t.excise(s,"labels");t.try(a,"parentNode.removeChild()",a)}var l=this._phrase({label:"a11y."+r.label,okIfMissing:!0})||this._phrase(r);this._attr(s["stop"+n],"aria-label",l)}}},n._layout=function(e){this._build("notification-toggle",{extending:e,role:"radiogroup"}," field","  name",{role:"text"},"  subway","   subway-line","   subway-scope","    stop-0 .notification-toggle-subway-stop",{button:this._onTapStop.bind(this,0),role:"radio"},"     tick1",{graphic:"tick"},"    stop-1 .notification-toggle-subway-stop",{button:this._onTapStop.bind(this,1),role:"radio"},"     tick1",{graphic:"tick"},"    stop-2 .notification-toggle-subway-stop",{button:this._onTapStop.bind(this,2),role:"radio"},"     tick1",{graphic:"tick"}," description .app-field-explanation <p>",{describing:"name"})},n._activateStop=function(e){e.classList.contains("active")||(t.batonClass(e,"active",e.parentNode),t.batonClass(e.previousSibling,"pre-active",e.parentNode),t.each([this.dom.stop0,this.dom.stop1,this.dom.stop2],function(t){this._attr(t,"aria-checked",""+(t==e))},this))},n._onTapStop=function(e){this._assignLevel(e)&&(this._levelChanged(),APP.haptics.select())},n._assignLevel=function(e){return this.level!==e&&(this.level=e,this._activateStop(this.dom["stop"+e]),!0)},n._levelChanged=function(){var e={category:this.category,level:this.level};this._dispatch("change",e,!0)&&this._subscribeAtCurrentLevel()},n._subscribeAtCurrentLevel=function(){var e=this.category,i=this.level;APP.journal.debug("[NOTIF-TOGGLE] %s: %s",e,i),APP.notifier.subscribe(e,i),t.each(APP.notifier.notifications.ARCHETYPES,function(t){t.delegate==e&&(APP.journal.debug("[NOTIF-TOGGLE] + %s: %s",t.category,i),APP.notifier.subscribe(t.category,i))},this)},n._onSubscribeCategory=function(e){return this.isInDocument()?void(this.level!==e.m.level&&this._assignLevel(e.m.level)):APP.events.off(this._.subscribeHandler)},s}),define("app/views/interviews/configure/interview-configure-notifications",["require","common","app/views/components/interviews/interview","app/views/components/interviews/constructs/notification-toggle","shibui/src/components/form-radio-tower","shibui/src/components/form-input-email-address"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("app/views/components/interviews/constructs/notification-toggle"),o=e("shibui/src/components/form-radio-tower"),a=e("shibui/src/components/form-input-email-address");return n.commence=function(e){return"#prepareNotifications"},n._prepareNotifications=function(e){e.spin(),APP.summoner.daemons.notifierRepair.diagnoseNotifier(function(e,t){this.yield("#respondToDiagnosis",{state:e,diagnosis:t})}.bind(this))},n._respondToDiagnosis=function(e){e.markAsRewritable(!0);var t=this.assignments.diagnosis;return"request-permission"==t.action?APP.notifier.requestPermission(this.thenYield("#prepareNotifications")):"repair-push"==t.action?this.yield("#repairPushNotifications"):"repair-email"==t.action?this.yield("#repairEmailNotifications"):"invalid-email"==t.action?(APP.patron.choose("patron:email:address",""),this.yield("#repairEmailNotifications")):("recommend-configuration"==t.action&&APP.notifier.markAsConfigured(),void this.yield("#manageNotifications"))},n._manageNotifications=function(e){e.markAsRewritable(e.name),e.say("notifications.manage.intro");var i,s=this.assignments.state,n=s.service.provider&&"email"!=s.service.provider;t.each(APP.notifier.notifications.ARCHETYPES,function(o){if(!o.delegate&&"SYSTEM"!=o.level){var a={visualLabels:!i};i&&i!=o.groupId&&e.divider(),i=o.groupId;var l=0;t.each(s.subscriptions,function(e,i){e.indexOf(o.category)<0||(l=i,t.breakIteration())});var c=e.construct("toggle-"+o.category,new r);c.become(o.category,l),c.applyLabels(["notifications.label.ignore","notifications.label.shelf","notifications.label."+(n?"push":"email")],a)}},this),e.divider(),e.construct("terms-glossary",this._termsGlossary()),APP.haptics.prepare()},n._termsGlossary=function(){var e=this.assignments.state,i=this._element({tag:"ul",classes:"notif-terms-list"}),s={substitutions:{EMAIL_ADDRESS:t.safe(t.try(e,"service.credentials.emailAddress"))},enliven:{"#change-email":this.thenYield("#repairEmailNotifications"),"#platform-settings":this._openSettingsApp.bind(this)}},n="notifications.manage.about-shelf",r=this._element({tag:"li",parentNode:i});return this._element(t.absorb(s,{tag:"p",parentNode:r,label:n})),this._element({graphic:"notif-provider-shelf",parentNode:r,access:"inert"}),e.pushability.possible&&(n="notifications.manage.about-push","granted"!=e.pushability.permit&&(n+=".fix"),r=this._element({tag:"li",parentNode:i}),this._element(t.absorb(s,{tag:"p",parentNode:r,label:n})),this._element({graphic:"notif-provider-push",parentNode:r,access:"inert"})),e.service.provider&&"email"!=e.service.provider||(n="notifications.manage.about-email",e.service.provider||(n+=".fix"),r=this._element({tag:"li",parentNode:i}),this._element(t.absorb(s,{tag:"p",parentNode:r,label:n})),this._element({graphic:"notif-provider-email",parentNode:r,access:"inert"})),i},n._repairPushNotifications=function(e){e.say("notifications.repair.push"),e.construct("radio-repair",new o({radios:[{value:"push",label:"notifications.repair.response.push",explanation:"notifications.repair.push.settings"},{value:"email",label:"notifications.repair.response.email",explanation:"configure-notifications.repair.email.explain"},{value:"none",label:"notifications.repair.response.none",explanation:"configure-notifications.repair.none.explain"}]})),e.dom.radioRepair.setValue("push"),e.response("mascot.next",function(){var t=e.dom.radioRepair.value();"push"==t?this._openSettingsApp():"email"==t?this.yield("#repairEmailNotifications"):this._doNotSendNotifications()}.bind(this),"emph")},n._repairEmailNotifications=function(e){e.say("notifications.repair.email"),e.construct("hold-email-field",new a({explanation:"email-address.age-disclaimer",value:APP.patron.emailAddress()}));var t=function(){if(this._isEpisodeValid(e)){var t=e.dom.holdEmailField.value();APP.patron.choose("patron:email:address",t),t?this._assignEmailAddress(t):this._doNotSendNotifications()}}.bind(this);e.dom.holdEmailField.on("form:field:submit",t),e.response("mascot.next",t,"emph")},n._openSettingsApp=function(){var e=t.try(this,"assignments.state.pushability.permit");this._defer("platform-settings",function(){APP.shell.transmit({name:"diagnostics:platform-settings",settings:"app-notifications"})},100);var i=APP.router.route.on("msg:client:view:foreground",function(){APP.router.route.off(i),APP.summoner.daemons.notifierRepair.diagnoseNotifier(function(t,i){t.pushability.permit!=e&&this.yield("#respondToDiagnosis",{state:t,diagnosis:i})}.bind(this))}.bind(this))},n._assignEmailAddress=function(e){APP.notifier.setServiceProvider("email",{emailAddress:e,name:APP.patron.name()}),this.yield("#prepareNotifications")},n._doNotSendNotifications=function(){APP.notifier.setServiceProvider(null),this.yield("#prepareNotifications")},s}),define("app/models/items/hold-template",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.$init=function(){this.emailAddress=null,this.daysToSuspendHolds=null,this._.callbacks={}},s.delta=function(e){var i=[];return t.each(e,this._diffHold.bind(this,i)),i},s.conform=function(e,t){this._.callbacks=t,this._.conformQueue=e.slice(0),this._continueConformingHolds()},s.cancel=function(){this._.callbacks={},this._.conformQueue=[],t.try(this._.activeRequest,"abort()")},s._diffHold=function(e,t){(this._diffEmailAddress(t)||this._diffDaysToSuspendHold(t))&&e.push(t)},s._diffEmailAddress=function(e){return null!==this.emailAddress&&this.emailAddress!==e.emailAddress},s._diffDaysToSuspendHold=function(e){if(null===this.daysToSuspendHolds)return!1;var t=e.isSuspended();if(0===this.daysToSuspendHolds&&!t)return!1;if(this.daysToSuspendHolds>0&&t){var i=e.suspendedDaysRemaining();return Math.round(i)!=this.daysToSuspendHolds}return!0},s._conformHold=function(e){var t=this._onConformedHold.bind(this),i=this._onConformFailure.bind(this);this._.activeRequest=APP.sentry.updateHold(e,this,t,i)},s._onConformedHold=function(e){this._.callbacks.conformed&&this._.callbacks.conformed(e),this._continueConformingHolds()},s._continueConformingHolds=function(){this._.conformQueue.length?this._conformHold(this._.conformQueue.shift()):(delete this._.conformQueue,this._.callbacks.complete&&this._.callbacks.complete())},s._onConformFailure=function(e){delete this._.conformQueue,this._.callbacks.failure&&this._.callbacks.failure(e)},i}),define("app/views/interviews/configure/interview-configure-suspend-holds",["require","common","app/views/components/interviews/interview","app/models/items/hold-template","app/views/components/interviews/constructs/hold-suspension-slider"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("app/models/items/hold-template"),o=e("app/views/components/interviews/constructs/hold-suspension-slider");return n.commence=function(e){return"#suspendHolds"},n._configure=function(){this._.holdTemplate=new r,this._.holdTemplate.daysToSuspendHolds=this._holdDaysInitialValue()},n._suspendHolds=function(e){e.say("sus.intro"),e.construct("slider",new o({labels:"circ-suspend",explainer:this._explainComparison.bind(this)})),e.dom.slider.setValue(this._.holdTemplate.daysToSuspendHolds),e.dom.slider.on("hold:suspension:days:change",this._onDaysChange.bind(this,e)),e.answer({label:"sus.update.button",yield:"#updateHolds"}).emphasize()},n._onDaysChange=function(e,t){this._.holdTemplate.daysToSuspendHolds=t.m.days},n._explainComparison=function(e){return this._.holdTemplate.daysToSuspendHolds=e,{label:"sus.compare."+this._holdSubstitutionSuffix(),substitutions:this._holdsSubstitutions()}},n._updateHolds=function(e){e.dom.progress=e.say({label:"sus.updating."+this._holdSubstitutionSuffix(),substitutions:this._holdsSubstitutions()}),e.spin(),this._.holdTemplate.conform(APP.patron.holds.all,{conformed:this._onHoldsProgress.bind(this,e),complete:this.thenYield("#holdsUpdated"),failure:this.thenYield("#holdsFailed")}),e.answer({label:"cancel",yield:"#cancelUpdates"}).emphasize("danger")},n._onHoldsProgress=function(e,t){e.markAsRewritable(),APP.scribe.record("hold:suspend",{"title:id":t.title.titleId,duration:this._.holdTemplate.daysToSuspendHolds}),this._textify(e.dom.progress,{label:"sus.updating."+this._holdSubstitutionSuffix(),substitutions:this._holdsSubstitutions()})},n._holdsUpdated=function(e){e.markAsRewritable(),e.say({label:"sus.updated."+this._holdSubstitutionSuffix(),substitutions:this._holdsSubstitutions()}),e.answer({done:!0})},n._holdsFailed=function(e){e.markAsRewritable(),e.say({label:"sus.update-failed",substitutions:this._holdsSubstitutions()}),e.answer({done:!0})},n._cancelUpdates=function(e){e.markAsRewritable(),e.say("configure-suspend-holds.updates-canceled"),this._.holdTemplate.cancel(),e.answer({done:!0})},n._holdDaysInitialValue=function(){var e=1/0;return t.each(APP.patron.holds.all,function(t){var i=t.suspendedDaysRemaining();i&&i<e&&(e=i)}),isFinite(e)?e:0},n._holdSubstitutionSuffix=function(){return this._.holdTemplate.daysToSuspendHolds?"days":"active"},n._holdsSubstitutions=function(){var e=APP.patron.holds.all,t=this._.holdTemplate.delta(e),i=this._.holdTemplate.daysToSuspendHolds;return{HOLDS_TOTAL:e.length,HOLDS_DIFF:t.length,HOLDS_SAME:e.length-t.length,DAYS:i||void 0}},s}),define("app/views/interviews/configure/interview-configure-unsubscribe",["require","common","app/views/components/interviews/interview"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype;return n.commence=function(e){return this.parameters.email&&this.assignments.identifiers?"#areYouSure":"#missingArgs"},n._configure=function(e,i){var s=t.absorb(i,t.absorb(e,{}));this.parameters={email:s.email||s.emailAddress},s.puid?(this.parameters.puid=s.puid,this.assign({identifiers:{puid:this.parameters.puid}})):s.chips&&(this.parameters.chips=s.chips,this.assign({identifiers:{chips:this.parameters.chips.split(",")}}))},n._areYouSure=function(e){e.say({label:"unsubscribe.are-you-sure.1",substitutions:{EMAIL_ADDRESS:t.safe(this.parameters.email)}}),e.say("unsubscribe.are-you-sure.2"),e.say("unsubscribe.are-you-sure.3"),e.answer({label:"unsubscribe.are-you-sure.yes",yield:"#confirmUnsubscribe"}).emphasize(),e.answer({label:"unsubscribe.are-you-sure.no",link:"/"})},n._confirmUnsubscribe=function(e){e.spin(),APP.sentry.notifyingEmailUnsubscribe(this.parameters.email,this.assignments.identifiers,this.thenYield("#successUnsubscribe"),this.thenYield("#failureUnsubscribe"))},n._successUnsubscribe=function(e){e.say("unsubscribe.confirm.success"),e.response("mascot.next","/","emph")},n._failureUnsubscribe=function(e){e.say("unsubscribe.confirm.failure"),e.answer({label:"mascot.retry",yield:"#confirmUnsubscribe"}).emphasize(),e.answer({label:"interview.feedback-help",link:"interview/feedback/support?category=question"})},n._missingArgs=function(e){e.say("unsubscribe.missing-arguments"),e.response("interview.feedback-help","interview/feedback/support?category=question")},s}),define("app/views/interviews/configure/interview-configure-history-migrate",["require","common","app/views/components/interviews/interview","app/views/account/library-card-icon","app/views/account/library-cards-list"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("app/views/account/library-card-icon"),o=e("app/views/account/library-cards-list");return n.commence=function(e){return APP.patron.activities.isRecordingPaused()?"#resumeRecording":APP.patron.cards.all.length?"#evaluateCards":"#noCards"},n._resumeRecording=function(e){e.say("history-migrate.activity-recording-paused"),e.response("action.activities.resume-recording",this._resumeActivityRecordingAndContinue.bind(this),"emph")},n._evaluateCards=function(e){e.spin(),APP.summoner.daemons.historyMigration.evaluateCards(APP.patron.cards.all,{counts:!0},function(e){e.expired.length||e.eligible.length?this.yield("#listCards",{cards:e}):this.yield("#ineligibleCards",{cards:e})}.bind(this))},n._listCards=function(e){e.markAsRewritable(e.name);var t=this.assignments.cards;t.expired.length&&(1==APP.patron.cards.all.length?(e.say("history-migrate.verify.simple"),e.construct("cards-list",new o),e.dom.cardsList.configure({verifiable:!0}),e.dom.cardsList.become(APP.patron.cards.all)):e.say({label:"history-migrate.verify.complex",
enliven:{"#verify-cards":"interview/authenticate/verify-cards"}}));var i=t.noLibraryHistory.concat(t.noCardHistory);i.length&&e.say({label:"history-migrate.ineligible",substitutions:{CARD_COUNT:i.length},enliven:{"#ineligible-cards":this.thenYield("#ineligibleCards")}}),t.eligible.length&&(e.say({label:"history-migrate.eligible",substitutions:{CARD_COUNT:t.eligible.length}}),e.construct("eligible-cards",this._cardList(t.eligible)),e.response("history-migrate.eligible.recover",this._recoverHistoryForCards.bind(this,t.eligible),"emph"))},n._ineligibleCards=function(e){var t=this.assignments.cards;t.noLibraryHistory.length&&(e.say({label:"history-migrate.ineligible.for-library",substitutions:{CARD_COUNT:t.noLibraryHistory.length}}),e.construct("no-library-history-cards",this._cardList(t.noLibraryHistory))),t.noCardHistory.length&&(e.say({label:"history-migrate.ineligible.for-card",substitutions:{CARD_COUNT:t.noCardHistory.length}}),e.construct("no-card-history-cards",this._cardList(t.noCardHistory)),e.response("history-migrate.response.enable-for-cards","#enableHistories"))},n._noCards=function(e){APP.library?(e.say("history-migrate.no-cards"),e.response("menu.library.response.manage-cards",APP.nav.go.bind(APP.nav,"interview/configure/cards"),"emph")):(e.say("history-migrate.no-library"),e.response("menu.library.response.add-library",APP.nav.go.bind(APP.nav,"interview/welcome"),"emph"))},n._enableHistories=function(e){e.spin();var t=this.assignments.cards.noCardHistory;APP.sentry.permitHistoryForCards(t,"allow",this.thenYield("#syncAfterEnablingHistories",{permitted:!0,cards:null}),this.thenYield("#syncAfterEnablingHistories",{permitted:!1,cards:null}))},n._syncAfterEnablingHistories=function(e){e.spin(),APP.patron.sync.commence({freshness:0,onSuccess:this.thenYield("#afterResync"),onFailure:this.thenYield("#afterResync",{permitted:!1})})},n._afterResync=function(e){t.excise(this.assignments,"permitted")?e.say("history-migrate.enable-for-cards.success"):e.say("history-migrate.enable-for-cards.failure"),e.response("mascot.next","#evaluateCards","emph")},n._cardList=function(e){var i=this._element({tag:"ul",classes:"history-migrate-cards"});return t.each(e,function(e){if(e){var t=this._build("history-migrate-card <li>",{parentNode:i}," icon",r," name",{html:e.safeName()}," status {history-migrate.card-status.count}",{substitutions:{N:e.thunderHistoryCount}});t.icon.become({card:e})}},this),i},n._resumeActivityRecordingAndContinue=function(){APP.patron.activities.resumeRecording(),this._refreshOnDismiss(),this.yield("#evaluateCards")},n._recoverHistoryForCards=function(e){APP.summoner.daemons.historyMigration.pollAllCards({mode:"manual",cards:this.assignments.cards}),APP.nav.go("shelf/timeline")},n._refreshOnDismiss=function(){if(this.owner&&!this.handlers._onShadeInvisible&&!this.handlers._onInterviewShadeOwner){var e=function(){this.handlers._onShadeInvisible=this.owner.shade.on("shade:invisible",this._refreshTimeline.bind(this))}.bind(this);this.owner.shade?e():this.handlers._onInterviewShadeOwner=this.owner.on("interview:shade",e)}},n._refreshTimeline=function(){APP.journal.debug("[INTERVIEW-CONFIGURE-HISTORY-MIGRATE] refresh timeline!"),APP.router.route.focus()},s}),define("app/views/core/tag-name-input",["require","common","shibui/src/components/form-input"],function(e){var t=e("common"),i=e("shibui/src/components/form-input"),s=i.new(),n=s.prototype;return n.become=function(e){this.tag=e},n.setValue=function(){var e=i.prototype.setValue.apply(this,arguments);return this.handlers.onSubmitForm&&this.validate(),e},n._expandOptions=function(e){return i.prototype._expandOptions.call(this,t.absorb(e,{placeholder:"tag.name.input.placeholder",required:!0,lines:1,attributes:{autocapitalize:"off",autocorrect:"off"}}))},n._layout=function(){i.prototype._layout.apply(this,arguments),this._classify(this.dom.root,"tag-name-input"),this.dom.overflowPane=this._element({parentNode:this.dom.rim,classes:"tag-name-input-overflow-pane"})},n._onInputControl=function(e){this.validate(),this._dispatchFieldEvent("change:immediate")},n._checkValidity=function(){i.prototype._checkValidity.call(this);var e=this.value(),t=APP.patron.tags.tagNameInvalidities(e,{tag:this.tag});return t.usedBy?this._attr(this.dom.control,"data-validation","tag-name-used"):"tag-name-used"==this._attr(this.dom.control,"data-validation")&&this._attr(this.dom.control,"data-validation",null),t.overflow?(this._attr(this.dom.control,"data-validation","tag-name-overflow"),this._showOverflowPane()):"tag-name-overflow"==this._attr(this.dom.control,"data-validation")&&(this._attr(this.dom.control,"data-validation",null),this._hideOverflowPane()),!t},n._showOverflowPane=function(){this._classify(this.dom.root,"is-invalid-overflow")},n._hideOverflowPane=function(){this._declassify(this.dom.root,"is-invalid-overflow")},s}),define("app/views/interviews/configure/interview-configure-tag-name",["require","common","app/views/components/interviews/interview","app/views/core/tag-line","app/views/core/tag-name-input","shibui/src/components/form-input"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("app/views/core/tag-line"),o=e("app/views/core/tag-name-input"),a=e("shibui/src/components/form-input");return n.commence=function(e){return"regular"==this.assignments.behavior&&this.assign({behavior:!1}),this.assignments.tag?"#renamingTag":t.among(this.assignments.behavior,"notify-me","wish-list-sync")?"#creatingTagForBehavior":this.assignments.behavior===!1?"#creatingTagInTutorial":"#creatingTag"},n._configure=function(e){this.assignments.title&&!this.assignments.library&&APP.journal.warn("[INTERVIEW-CONFIGURE-TAG-NAME] assigned title, but no library"),"undefined"==typeof this.assignments.chooseBehavior&&this.assign({chooseBehavior:"undefined"==typeof this.assignments.tag&&"undefined"==typeof this.assignments.behavior})},n._renamingTag=function(e){e.say("configure-tag-name.rename");var t=this._buildTagNameForm();e.construct("tag-name-form",t.root),this._textify(t.submit,"tag.name.update"),!this.assignments.callback&&this._listenForDismiss(this.handlers,t)&&(this._classify(t.controls,"squish"),this._classify(t.submit,"squish"),this._declassify(t.submit,"shibui-button halo"),this._attr(t.submit,"tabindex",-1))},n._creatingTag=function(e){e.say("configure-tag-name.create"),e.construct("tag-name-form",this._buildTagNameForm().root)},n._creatingTagInTutorial=function(e){e.say("configure-tag-name.tutorial"),e.construct("tag-name-form",this._buildTagNameForm().root)},n._creatingTagForBehavior=function(e){e.say("configure-tag-name."+this.assignments.behavior);var t=this._buildTagNameForm();e.construct("tag-name-form",t.root)},n._buildTagNameForm=function(){var e=this._element({tag:"form",action:"#"}),i=this.assignments.behavior||t.try(this.assignments.tag,"behavior.key"),s=!!APP.patron.tags.suggestTagNamesForBehavior(i).length,n=this._build("configure-tag-name",{element:e}," name-section","  suggestions",{skip:!s},"   suggestions-tag-line",r,"  name-input",{construct:o,with:{form:e,autofocus:"autofocus",explanation:"configure-tag-name.name-input.explain"+(s?"-with-suggestions":"")}}," description-section","  description-input",{construct:a,with:{form:e,placeholder:{label:"tag.name.description.placeholder"},attributes:{maxlength:240},explanation:"tag.name.description.explanation"}}," controls","  behavior-name",{skip:"undefined"==typeof this.assignments.behavior,label:this.assignments.behavior?"tag.behavior.smart."+this.assignments.behavior:"tag.behavior.regular"},"  submit .shibui-button <button> {tag.name.create}",{type:"submit"});if(this.assignments.tag){var l=this.assignments.tag.description||"";n.nameInput.become(this.assignments.tag),n.nameInput.setValue(this.assignments.tag.name),n.descriptionInput.setValue(l),this._.committed={name:this.assignments.tag.name,desc:l}}return s&&(n.suggestionsTagLine.configure({suggestions:!0,headless:!0}),n.suggestionsTagLine.suggest(i)),this._textify(n.behavior),n.nameInput.on("form:field:focus",this._onNameOrDescriptionInputFocus.bind(this,n)),n.descriptionInput.on("form:field:focus",this._onNameOrDescriptionInputFocus.bind(this,n)),this.handlers.onSubmit=APP.events.on(n.root,"submit",this._onSubmitForm.bind(this,n)),this.handlers.onSubmit=APP.events.on(n.root,"invalid",this._onInvalidForm.bind(this,n),{capture:!0}),s&&(this.handlers.onSuggestionTap=n.suggestionsTagLine.on("suggestion:tap",this._onSuggestionTap.bind(this,n))),APP.haptics.prepare(),n},n._onNameOrDescriptionInputFocus=function(e,i){APP.shell.has("device:soft-keyboard")&&(this._classify(e.root,"has-soft-keyboard"),t.try(this.owner,"shade")&&(this.owner.shade.grow(),this._defer(function(){this.owner.shade.scrollTo(i.target.offsetTop-32)}.bind(this),300)))},n._onSuggestionTap=function(e,t){e.nameInput.setValue(t.m.suggestion),APP.haptics.select()},n._onSubmitForm=function(e,t){APP.events.stop(t),this._commitChanges(e)},n._onInvalidForm=function(e){return this._focusFirstInvalidity(e.root)},n._commitChanges=function(e){if(e.root.checkValidity()){var i=e.nameInput.value(),s=e.descriptionInput.value(),n=this._.committed||{};if(i!=n.name||s!=n.desc)if(this.assignments.tag)this.assignments.tag.rename(i,s);else if(i){this.assign({tag:APP.patron.tags.produce({name:i})}),this.assignments.tag.behave(this.assignments.behavior||null),this.assignments.tag.rename(i,s);var r=this.assignments.title,o=this.assignments.library;r&&o&&!t.among(this.assignments.tag,r.tags.all)&&this.assignments.tag.addToTitle(r,o)}this._.committed={name:i,desc:s},this.assignments.chooseBehavior?this.yield("interview/configure/tag-smarts",{tag:this.assignments.tag}):this.yieldBack({tag:this.assignments.tag,title:this.assignments.title,library:this.assignments.library,name:t.try(this.assignments.tag,"name")})}},n._listenForDismiss=function(e,t){if(this.owner){var i=function(){e._onShadeInvisible=this.owner.shade.on("shade:invisible",this._commitChanges.bind(this,t))}.bind(this);return this.owner.shade?i():e._onInterviewShadeOwner=this.owner.on("interview:shade",i),!0}return APP.journal.warn("[INTERVIEW-CONFIGURE-TAG-NAME] no owner"),!1},s}),define("app/views/interviews/configure/interview-configure-tag-smarts",["require","common","app/views/components/interviews/interview","shibui/src/components/form-radio-tower"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("shibui/src/components/form-radio-tower");return n.commence=function(e){return this._listenForDismiss(this.handlers),this.assignments.tag?"#chooseSmarts":"#missingArgs"},n._listenForDismiss=function(e){if(this.owner){var t=function(){e._onShadeInvisible=this.owner.shade.on("shade:invisible",this._commitChanges.bind(this))}.bind(this);this.owner.shade?t():e._onInterviewShadeOwner=this.owner.on("interview:shade",t)}else APP.journal.warn("[INTERVIEW-CONFIGURE-TAG-SMARTS] no owner")},n._chooseSmarts=function(e){e.say("tag.choose-smarts.intro");var i=this._element({tag:"form",action:"#"}),s=this._build("tag-behaviors",{element:i}," radio-tower",{construct:r,with:{form:i,radios:this._tagBehaviorOptions()}}," submit .shibui-button <button> {tag.name.update}",{type:"submit",skip:!this.assignments.callback});s.radioTower.setValue(t.try(this.assignments.tag.behavior,"key")||"regular"),s.radioTower.on("form:field:change",function(e){this.assign({behavior:e.m.value})}.bind(this)),s.submit||s.radioTower.on("form:field:repeat",function(e){this._onSubmitForm(s)}.bind(this)),this.handlers.onSubmit=APP.events.on(i,"submit",this._onSubmitForm.bind(this,s)),e.construct("form",i),e.answer({done:!0})},n._tagBehaviorOptions=function(){var e=[];return e.push({value:"regular",classes:"tag-behaviors-radio-option tag-behaviors-radio-option-regular",label:"tag.behavior.regular",explanation:"tag.behavior.regular.details"}),t.each(APP.patron.tags.BEHAVIORS,function(i){var s=new i,n=s.attachability(this.assignments.tag),r=t.try(n,"usedBy");if(n===!0||r){var o={value:s.key,classes:"tag-behaviors-radio-option tag-behaviors-radio-option-"+s.key,label:"tag.behavior.smart."+s.key,explanation:"tag.behavior.smart."+s.key+".details"};r&&(o.disabled=!0,o.explanation={label:[o.explanation,"tag.behavior.used.details"],substitutions:{TAG_NAME:r.niceName()}}),e.push(o)}},this),e},n._onSubmitForm=function(e,i){APP.events.stop(i),this._commitChanges(),this.yieldBack({tag:this.assignments.tag,behaviorKey:t.try(this.assignments.tag.behavior,"key"),behavior:this.assignments.tag.behavior})},n._commitChanges=function(){var e=this.assignments;if(e.behavior&&"regular"!=e.behavior){if(t.try(e.tag.behavior,"key")==e.behavior)return;e.tag.behave(e.behavior),APP.patron.tags.save()}else if("regular"==e.behavior){if(!e.tag.behavior)return;e.tag.behave(),APP.patron.tags.save()}},s}),define("app/views/interviews/configure/interview-configure-tag-borrowed-import",["require","common","app/views/components/interviews/interview"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype;return n.commence=function(e){return this.assignments.tag&&this.assignments.importables?"#offerToImport":"#missingArgs"},n._offerToImport=function(e){e.markAsRewritable(),e.characterize({semaphores:{appearance:"prompt","appearance-prompt-type":"tags"}}),e.say({label:"configure-tag-borrowed-import.prompt",substitutions:{COUNT:this.assignments.importables.length}}),e.answer({label:"configure-tag-borrowed-import.agree",yield:"#importFromActivities"}),e.answer({label:"mascot.no",button:this._declineToImport.bind(this)}).compact()},n._importFromActivities=function(e){e.characterize({semaphores:{appearance:"prompt","appearance-prompt-type":"tags"}}),e.spin(),t.each(this.assignments.importables,function(e){this.assignments.tag.addToTitle(e.title,e.library,{createTime:e.createTime})},this),this.assignments.tag.behavior.markAllActivitiesImported(),this._defer(this.thenYieldBack(),1e3)},n._declineToImport=function(){this.assignments.tag.behavior.markAllActivitiesImported(),this.yieldBack()},s}),define("app/views/interviews/configure/interview-configure-kindle-shill",["require","common","app/views/components/interviews/interview"],function(e){var t=(e("common"),e("app/views/components/interviews/interview")),i=t.new(),s=i.prototype;return s.commence=function(e){return"#offerKindleFeatures"},s._offerKindleFeatures=function(e){e.say("kindle-features.intro"),e.response("kindle-features.intro.response.yes",this.thenYield("#applyFulfillmentPreference",{preference:"kindle"})),e.response("mascot.skip",this._dismiss.bind(this),"emph")},s._applyFulfillmentPreference=function(e){if("kindle"==this.assignments.preference){var t=APP.summoner.daemons.fulfillmentChoices;this.assign({downloadCount:t.countDownloadsFulfillableAs("kindle")})}this.assignments.downloadCount?(e.say({label:"circ-fulfill.download-wipe-warning",substitutions:{DOWNLOADS:this.assignments.downloadCount}}),e.response("circ-fulfill.download-wipe-confirm","#commitFulfillmentPreference","emph")):this._commitFulfillmentPreference(e)},s._commitFulfillmentPreference=function(e){APP.summoner.daemons.fulfillmentChoices.prefer("book",this.assignments.preference),e.say("kindle-features.summary"),e.response("kindle-features.summary.response.dismiss",this._dismiss.bind(this),"emph")},s._dismiss=function(){APP.patron.dismiss("announcements:kindle-features"),this.yieldBack()},i}),define("app/views/interviews/feedback/interview-feedback-help",["require","common","app/views/components/interviews/interview","app/views/support/help-search-form","app/views/support/robot-answer","app/views/core/block-strap"],function(e){var t=(e("common"),e("app/views/components/interviews/interview")),i=t.new(),s=i.prototype,n=e("app/views/support/help-search-form"),r=e("app/views/support/robot-answer");e("app/views/core/block-strap");return s.commence=function(e){return"#helpMenu"},s._helpMenu=function(e){e.construct("help-search-form",new n(this)),e.dom.helpSearchForm.on("quick-tip",function(e){this.assign(e.m),this.yield("#quickTip")}.bind(this))},s._quickTip=function(e){e.markAsRewritable(e.name),this.assignments.tip&&e.construct("robot-answer",new r(this.assignments.tip.tip,this.assignments.tip.attachments)),this.assignments.continuation&&e.construct("robot-continuation",this.assignments.continuation)},i}),define("app/views/interviews/feedback/interview-feedback-library",["require","common","app/views/components/interviews/interview","app/views/components/locate-library/library-branch-details"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("app/views/components/locate-library/library-branch-details");return n.commence=function(e){return this.assignments.library?"#contactDetails":APP.library?"#missingArgs":{path:"interview/welcome"}},n._configure=function(e,i){this.assign({library:e.library||APP.library}),this.assign({branch:e.branch||t.try(this.assignments,"library.branch")})},n._contactDetails=function(e){if(e.markAsRewritable(e.name),e.say("authenticate.help.library"),this.assignments.library&&this.assignments.branch&&(e.construct("branch-details",new r),e.dom.branchDetails.become(this.assignments.library,this.assignments.branch,{map:"directions",colors:!0,names:["branch"],links:["home","help","email","phone"]})),this.assignments.library){var i={key:this.assignments.library.baseKey};i.key||(i.websiteId=this.assignments.library.websiteId),e.answer({label:"authenticate.help.action.branches-map",link:t.parameterizeURL("interview/locate-library/branches",i)}).emphasize()}},s}),define("app/views/support/rating-quiz",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.MIN_RATING=0,n.MAX_RATING=5,n.CORRECTION_DELAY_MS=300,n.getRating=function(){return this._.rating||0},n.getGlyph=function(e){"undefined"==typeof e&&(e=this._.rating);var i=t.element({classes:"rating-quiz-glyph rating-quiz-glyph-"+e,html:""+e});return i},n.setGuides=function(e,t){this._prepare(),this.dom.guideMin=this._element({parentNode:this.dom.guides,classes:"rating-quiz-guide-min",label:e}),this.dom.guideMax=this._element({parentNode:this.dom.guides,classes:"rating-quiz-guide-max",label:t})},n._layout=function(e){this._build("rating-quiz .is-demoing",{extending:e}," guides"," row","  radios","  glyphs");for(var t=this.MIN_RATING;t<=this.MAX_RATING;++t){var i=this._element({tag:"input",type:"radio",name:"rating-quiz",value:t,parentNode:e.radios,classes:"rating-quiz-radio rating-quiz-radio-"+t+" halo","data-halo-states":"focus","aria-label":""+t});APP.events.on(i,"change",this._onChangeRadio.bind(this,i,t)),e.glyphs.appendChild(this.getGlyph(t))}},n._listen=function(e,t){e.contact=APP.events.onContact(this.dom.root,{start:this._onContactStart.bind(this),move:this._onContactMove.bind(this),end:this._onContactEnd.bind(this),cancel:this._onContactCancel.bind(this)})},n._onContactStart=function(e){this.handlers.contact.capture(),this._deselect(),this._declassify(this.dom.root,"is-demoing"),this._classify(this.dom.root,"is-pointer"),this._.contact={rect:this.dom.glyphs.getBoundingClientRect()},this._onContactMove(e),clearTimeout(this._.timer)},n._onContactMove=function(e){if(this._.contact){APP.events.stop(e);var t=e.pageX-this._.contact.rect.left;if(t<-100)return this._onContactCancel();var i=Math.max(0,Math.min(.999,t/this._.contact.rect.width)),s=this.MAX_RATING-this.MIN_RATING+1,n=Math.floor(i*s);n!=this._.contact.rating&&(this._deselect(),this._.contact.rating=n,this._.contact.radio=this.dom.radios.children[n],this._classify(this._.contact.radio,"is-selected"),this._classify(this.dom.glyphs.children[n],"is-selected"))}},n._onContactEnd=function(e){this._.contact&&("number"==typeof this._.contact.rating&&this._onSelectedRating(this._.contact.radio,this._.contact.rating),this._.contact=null)},n._onContactCancel=function(e){this._deselect(),this._.contact=null,"undefined"==typeof this._.rating&&this._classify(this.dom.root,"is-demoing")},n._onChangeRadio=function(e,t){e.checked&&(this._declassify(this.dom.root,"is-demoing"),this._declassify(this.dom.root,"is-pointer"),this._onSelectedRating(e,t))},n._onSelectedRating=function(e,t){this._deselect(),this._.radio=e,this._.radio.checked=!0,this._.rating=t,this._classify(this._.radio,"is-selected"),this._classify(this.dom.glyphs.children[this._.rating],"is-selected");var i={rating:this._.rating,glyph:this.getGlyph(this._.rating)};this._defer("dispatch",this._dispatch.bind(this,"rating:choice",i),this.CORRECTION_DELAY_MS)},n._deselect=function(){var e=this._.rating;this._.contact&&"number"==typeof this._.contact.rating&&(e=this._.contact.rating),"number"==typeof e&&(this._declassify(this.dom.radios.children[e],"is-selected"),this._declassify(this.dom.glyphs.children[e],"is-selected"))},s}),define("app/views/support/rating-quiz-nps",["require","common","./rating-quiz"],function(e){var t=e("common"),i=e("./rating-quiz"),s=i.new(),n=s.prototype;return n.MAX_RATING=10,n.RATING_GLYPHS="images/rating-sprites.png",n.getGlyph=function(e){"undefined"==typeof e&&(e=this._.rating);var i=t.element({classes:"rating-quiz-glyph rating-quiz-glyph-"+e});return this._.imagePath=this._.imagePath||APP.constants.fileURL(this.RATING_GLYPHS),i.style.backgroundImage="url("+this._.imagePath+")",i},n._layout=function(e){i.prototype._layout.apply(this,arguments),this._classify(e.root,"rating-quiz-nps")},s}),define("app/views/interviews/feedback/interview-feedback-survey",["require","common","app/views/components/interviews/interview","shibui/src/components/form-input","app/views/support/rating-quiz-nps"],function(e){var t=(e("common"),e("app/views/components/interviews/interview")),i=t.new(),s=i.prototype,n=e("shibui/src/components/form-input"),r=e("app/views/support/rating-quiz-nps");return s.commence=function(e){return"#questionOne"},s._questionOne=function(e){e.say("fdb.survey.greeting"),e.say("fdb.survey.question.1"),e.construct("rating",new r),e.dom.rating.setGuides("fdb.survey.min","fdb.survey.max"),e.answer({next:"#questionTwo"}).emphasize().with(function(t){t.extract(),e.dom.rating.on("rating:choice",function(e){this.assign({npsRating:e.m.rating,npsGlyph:e.m.glyph}),t.impart()}.bind(this))}.bind(this))},s._questionTwo=function(e){var t=this._calculateGrade(),i=e.say("fdb.survey.question.2."+t);e.construct("comment-field",new n({lines:5,maxlength:500,showLimit:!0,required:!0,classes:"fdb-survey-comment",attributes:{"aria-label":this._phrase("fdb.survey.question.2.a11y-label")}})),e.dom.commentField.dom.root.appendChild(this.assignments.npsGlyph),this._classify(this.assignments.npsGlyph,"fdb-survey-comment-glyph"),e.answer({label:"mascot.skip",yield:"#submitWithoutReplyInfo"}).compact().with(function(t){e.dom.commentField.on("form:field:validity",function(e){t.classify("hide",!!e.m.validity)}.bind(this))}),e.answer({label:"mascot.next",button:this._validateQuestionTwo.bind(this,e)}).emphasize().compact(),e.on("interview:episode:refresh",function(){var t=this._calculateGrade();this._textify(i,"fdb.survey.question.2."+t);var s=e.dom.root.querySelector("fdb-survey-comment-glyph");s&&s.parentNode.removeChild(s),e.dom.commentField.dom.root.appendChild(this.assignments.npsGlyph),this._classify(this.assignments.npsGlyph,"fdb-survey-comment-glyph")}.bind(this))},s._validateQuestionTwo=function(e){if(this._isEpisodeValid(e))if(this.assign({comment:e.dom.commentField.value().trim()}),this.assignments.npsRating<8){var t={category:"rating",submission:this._prepareSubmission(),callback:"#askForPermissionToReply"};this.yield("interview/feedback/helpful-robots",t)}else this.yield("#askForPermissionToReply")},s._submitWithoutReplyInfo=function(e){e.spin(),APP.sage.submit("rating",this._prepareSubmission(),this.thenYield("#followUp"),this.thenYield("#onSurveySubmissionFailure"))},s._askForPermissionToReply=function(e){var t={category:"rating",submission:this._prepareSubmission(),callback:"#followUp"};if(t.submission.patronMessage){var i=this._calculateGrade();e.say("fdb.survey.reply."+i),e.answer({label:"fdb.survey.reply.yes",yield:"interview/feedback/submit-to-sage",assign:t}).emphasize().compact(),e.answer({label:"fdb.survey.reply.no",yield:"#submitWithoutReplyInfo"})}else this.yield("#submitWithoutReplyInfo")},s._followUp=function(e){var t=this._calculateGrade(),i=APP.shell.capability("feedback:store");"high"==t&&i?(e.say({label:"fdb.survey.review.prompt",substitutions:{STORE_NAME:i.replace(/\s/g,"&nbsp;")}}),e.answer({label:"mascot.skip",yield:"#declineReview"}).compact(),e.answer({label:"fdb.survey.review.yes",yield:"#leaveAReview"}).emphasize()):(e.say("fdb.survey.farewell."+t),e.answer({done:"MENU"}))},s._onSurveySubmissionFailure=function(e){e.say("fdb.submit-to-sage.submission.failure"),e.answer({label:"mascot.retry",yield:"#submitWithoutReplyInfo"})},s._leaveAReview=function(e){APP.shell.transmit("feedback:store:review"),this._defer("episode",this.thenYield("#leftReview"),1250)},s._leftReview=function(e){e.say("fdb.survey.review.accepted"),e.answer({done:"MENU"})},s._declineReview=function(e){e.say("fdb.survey.review.declined"),e.answer({done:"MENU"})},s._calculateGrade=function(){return this.assignments.npsRating>=9?"high":this.assignments.npsRating>=5?"middle":"low"},s._prepareSubmission=function(){var e={};return e.appRating=this.assignments.npsRating,e.patronName=null,e.patronEmailAddress=null,e.patronMessage=this.assignments.comment,this.assignments.provisionalSageId&&"-"!=this.assignments.provisionalSageId&&(e.id=this.assignments.provisionalSageId),this.assignments.robotRating&&(e.helpfulRobotsRating=this.assignments.robotRating),e},i}),define("app/views/interviews/feedback/interview-feedback-beta",["require","common","app/views/components/interviews/interview","shibui/src/components/form-input"],function(e){var t=(e("common"),e("app/views/components/interviews/interview")),i=t.new(),s=i.prototype,n=e("shibui/src/components/form-input");return s.commence=function(e){return"#enterFeedback"},s._enterFeedback=function(e){e.say("beta-feedback.intro"),e.construct("message-field",new n({lines:5,maxlength:500,showLimit:!0,required:!0,attributes:{"aria-label":"Enter your feedback"}})),e.answer({next:this._submitSupportRequest.bind(this,e)}).emphasize()},s._submitSupportRequest=function(e){this._isEpisodeValid(e)&&this.yield("interview/feedback/submit-to-sage",{category:"reaction",submission:{patronMessage:e.dom.messageField.value(),reactionStimulus:"beta-appraisal"},preview:!0})},i}),define("app/views/support/title-selector",["require","common","app/views/core/partial","app/views/core/cover-box"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/core/cover-box");return n.getTitle=function(){return this._.title},n.setTitle=function(e){this._.title=e,this._updateTitle()},n.setAlternatives=function(e){this._.alternatives=[],this._.title&&this._.alternatives.push(this._.title),t.each(e,function(e){this._.title&&this._.title.titleId==e.titleId||this._.alternatives.push(e)},this),this._updateAlternatives()},n._layout=function(){this.dom=this._build("title-selector"," cover",r," title"," authors"," other-button {widget.title-selector.other}",{button:!0}),this._updateTitle(),this._updateAlternatives()},n._updateTitle=function(){this.dom&&this._.title&&this._.title.use(function(e,t){this.dom.cover.become(t),t.title?this._textify(this.dom.title,{html:t.titleWithoutOrphans()}):(t.reuse(),this._textify(this.dom.title,"ellipsis"));var i=t.attribution();i?this._textify(this.dom.authors,{html:i}):(t.reuse(),this._textify(this.dom.authors,"ellipsis"))},this)},n._updateAlternatives=function(){this.dom&&this._classify(this.dom.root,"has-alternatives",!!(this._.alternatives&&this._.alternatives.length>1))},n._onTapOtherButton=function(e){APP.arena.popover(e.target).choices(function(e){t.each(this._.alternatives,function(t){e.choice({html:t.title,button:this._onTapAlternativeTitle.bind(this,t)})},this)}.bind(this))},n._onTapAlternativeTitle=function(e){this.setTitle(e)},s}),define("app/views/interviews/feedback/interview-feedback-support",["require","common","app/views/components/interviews/interview","shibui/src/components/form-input","shibui/src/components/form-switch-toggle","shibui/src/components/form-radio-tower","app/views/support/title-selector"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("shibui/src/components/form-input"),o=e("shibui/src/components/form-switch-toggle"),a=e("shibui/src/components/form-radio-tower"),l=e("app/views/support/title-selector");return n.IDEAL_MESSAGE_MIN=50,n.commence=function(e){var i=t.try(this.assignments,"category");return"problem"==i?"#flowForProblem":"question"==i?"#flowForQuestion":"idea"==i?"#flowForIdea":"#askForCategory"},n._configure=function(e,t){this.parameters={category:e.category||t.category},this.assignments.category=this.parameters.category,this.assignments.draftMessage=this.assignments.draftMessage||""},n._askForCategory=function(e){e.say("fdb.support.intro"),e.answer({label:"fdb.support.category.problem",yield:"#flowForProblem",assign:{category:"problem"}}).emphasize(),e.answer({label:"fdb.support.category.question",yield:"#flowForQuestion",assign:{category:"question"}}),e.answer({label:"fdb.support.category.idea",yield:"#flowForIdea",assign:{category:"idea"}}).stack()},n._flowForProblem=function(e){e.say("fdb.support.problem.intro"),e.construct("message-field",new r({lines:7,maxlength:1e3,showLimit:!0,required:!0,value:this.assignments.draftMessage,attributes:{"aria-label":this._phrase("fdb.support.problem.a11y-label")}})),this.assignments.errorMessage||e.construct("toggle-error",new o({label:"fdb.support.problem.check-error"})),this.assignments.titleInstance||!APP.title&&!APP.patron.loans.all.length||e.construct("toggle-title",new o({label:"fdb.support.problem.check-title"})),e.answer({next:this._validateMessage.bind(this,e)}).emphasize()},n._flowForQuestion=function(e){e.say("fdb.support.question.intro"),e.construct("message-field",new r({lines:7,maxlength:1e3,showLimit:!0,required:!0,value:this.assignments.draftMessage,attributes:{"aria-label":this._phrase("fdb.support.question.a11y-label")}})),this.assignments.titleInstance||!APP.title&&!APP.patron.loans.all.length||e.construct("toggle-title",new o({label:"fdb.support.question.check-title"})),e.answer({next:this._validateMessage.bind(this,e)}).emphasize()},n._flowForIdea=function(e){e.say("fdb.support.idea.intro"),e.construct("message-field",new r({lines:7,maxlength:500,showLimit:!0,required:!0,value:this.assignments.draftMessage,attributes:{"aria-label":this._phrase("fdb.support.idea.a11y-label")},explanation:{label:"fdb.support.idea.recommend-a-title"}})),e.answer({next:this._validateMessage.bind(this,e)}).emphasize()},n._validateMessage=function(e){this._isEpisodeValid(e)&&this._decideNextEpisode({patronMessage:e.dom.messageField.value(),hasError:!(!t.try(e.dom,"toggleError.isOn()")&&!this.assignments.errorMessage),hasTitle:!(!t.try(e.dom,"toggleTitle.isOn()")&&!this.assignments.titleInstance)})},n._decideNextEpisode=function(e){return e&&this.assign(e),this.assignments.patronMessage.length<this.IDEAL_MESSAGE_MIN&&!this.assignments.allowShortMessage?this.yield("#suggestLongerMessage"):t.among(this.assignments.category,"problem","question")&&!this.assignments.provisionalSageId?this.yield("interview/feedback/helpful-robots",{category:this.assignments.category,submission:this._prepareSubmission(),ignoreIntents:this.assignments.ignoreIntents,followUp:!0,callback:"#afterHelpfulRobots"}):this.assignments.hasError&&!this.assignments.errorMessage?this.yield("#askIfRecentErrorMessage"):!this.assignments.hasTitle||this.assignments.titleInstance||this.assignments.titleName?void this.yield("interview/feedback/submit-to-sage",{category:this.assignments.category,submission:this._prepareSubmission(),preview:!0,callback:this.assignments.callback
}):this.yield("#selectTitle")},n._suggestLongerMessage=function(e){e.say("fdb.support.message-short"),e.answer({label:"fdb.support.message-short.allow",button:this._decideNextEpisode.bind(this,{allowShortMessage:!0})}),e.answer({label:"fdb.support.message-short.revise",button:function(){this.yield(this.commence())}.bind(this)}).emphasize()},n._afterHelpfulRobots=function(e){if(e.markAsRewritable(),t.excise(this.assignments,"looping"))return this.recommence();this.assignments.looping=!0;var i=t.excise(this.assignments,"satisfied"),s=t.excise(this.assignments,"reviseMessage");if(i){var n=function(){};APP.sage.submit("satisfaction",this._prepareSubmission(),n,n),this.yieldBack()||APP.nav.go("interview")}else s?this.recommence():this._decideNextEpisode()},n._askIfRecentErrorMessage=function(e){var t=APP.sage.history(300,"error")[0];t&&t.errorHumanReadable&&!t.reportedToSupport?(e.say("fdb.support.problem.recent-error"),e.construct("error-output",this._element({html:t.errorHumanReadable,classes:"fdb-recent-error"})),e.answer({label:"mascot.yes",button:function(){t.reportedToSupport=!0;var e=t.errorMessage+(t.sageId?"\n\nSage ID: "+t.sageId:"");this._decideNextEpisode({errorMessage:e})}.bind(this)}).compact(),e.answer({label:"mascot.no",yield:"#askForErrorMessage"})):(e.markAsRewritable(),this.yield("#askForErrorMessage"))},n._askForErrorMessage=function(e){e.say("fdb.support.problem.prompt-error"),e.construct("error-field",new r({lines:4,maxlength:1e3,showLimit:!0,required:!0})),e.answer({label:"fdb.support.problem.forgot-error",button:this._decideNextEpisode.bind(this,{errorMessage:"[I Don't Recall]"})}).with(function(t){e.dom.errorField.on("form:field:validity",function(e){t.classify("hide",!!e.m.validity)}.bind(this))}.bind(this)),e.answer({next:function(){this._isEpisodeValid(e)&&this._decideNextEpisode({errorMessage:e.dom.errorField.value()})}.bind(this)}).emphasize()},n._selectTitle=function(e){var i=[];t.each(APP.patron.loans.all,function(e){i.push(e.title)});var s=APP.title||i[0];return s?(e.say("fdb.support."+this.assignments.category+".title-prompt"),e.construct("title-selector",new l),e.dom.titleSelector.setTitle(s),e.dom.titleSelector.setAlternatives(i),e.answer({label:"mascot.yes",button:function(){var t=e.dom.titleSelector.getTitle();this._decideNextEpisode({titleInstance:t})}.bind(this)}).compact(),void e.answer({label:"mascot.no",yield:"#enterTitle"})):(e.markAsRewritable(),this.yield("#enterTitle"))},n._enterTitle=function(e){e.say("fdb.support.enter-title.title"),e.construct("title-field",new r({lines:1,maxlength:200,required:!0,placeholder:"fdb.support.enter-title.title.placeholder"})),e.construct("creator-field",new r({lines:1,maxlength:200,placeholder:"fdb.support.enter-title.creator.placeholder"})),e.construct("radio-format",new a({radios:[{value:"book",label:"feedback-support.title-format.book"},{value:"audiobook",label:"feedback-support.title-format.audiobook"},{value:"magazine",label:"feedback-support.title-format.magazine"}]})),e.dom.radioFormat.setValue("book"),e.answer({next:function(){this._isEpisodeValid(e)&&this._decideNextEpisode({titleInstance:void 0,titleFormat:e.dom.radioFormat.value(),titleName:e.dom.titleField.value(),titleCreator:e.dom.creatorField.value()})}.bind(this)}).emphasize().compact()},n._prepareSubmission=function(){var e={},t=this.assignments;if(e.patronMessage=t.patronMessage,t.errorMessage&&(e.errorSource="[Patron]",e.errorMessage=t.errorMessage),t.titleInstance){e.submissionContext={title:t.titleInstance};var i={"title.titleId":t.titleInstance.titleId},s=APP.patron.loans.find(i)||APP.patron.magazines.find(i);s&&(e.submissionContext[s.type]=s)}else t.titleFormat&&(e.titleName=t.titleName,e.titleCreator=t.titleCreator,e.titleFormat=t.titleFormat);return t.provisionalSageId&&"-"!=t.provisionalSageId&&(e.id=t.provisionalSageId),"number"==typeof t.robotRating&&(e.helpfulRobotsRating=t.robotRating),e},s}),define("app/views/interviews/feedback/interview-feedback-helpful-robots",["require","common","app/views/components/interviews/interview","app/views/support/robot-answer","app/views/support/rating-quiz"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("app/views/support/robot-answer"),o=e("app/views/support/rating-quiz");return n.commence=function(e){return this.assignments.submission?"#fetchAnswer":"#missingArgs"},n.yieldBack=function(e){var s=t.absorb(e,{provisionalSageId:this.assignments.provisionalSageId,robotTip:this.assignments.robotTip,robotAttachment:this.assignments.robotAttachment,robotRating:this.assignments.robotRating});return i.prototype.yieldBack.call(this,s)},n._fetchAnswer=function(e){e.spin(),this.assign({provisionalSageId:"-"}),APP.sage.analyze(this.assignments.category,this.assignments.submission,this._processAnswer.bind(this,e),this.thenYieldBack())},n._processAnswer=function(e,i){try{var s=JSON.parse(i);if(!s.id)throw"Invalid Sage response: "+i;if(this.assign({provisionalSageId:s.id}),s.intent&&this.assignments.ignoreIntents&&this.assignments.ignoreIntents.indexOf(s.intent)>=0)throw"Ignoring Quick Tip intent: "+s.intent;var n,r;if(t.each(s.resources,function(e){"quick-tip"==e.type?n=e:(!r||e.rank<r.rank)&&"academy-lesson"!=e.type&&(r=e)}),!n)throw"Quick Tip not found in Sage response: "+i;this.assign({robotTip:n,robotAttachment:r})}catch(e){return APP.journal.debug("[HELPFUL-ROBOTS] error:",e),this.yieldBack()}this.yield("#presentAnswer")},n._presentAnswer=function(e){e.say("fdb.robots.intro"),e.construct("robot-answer",new r(this.assignments.robotTip,this.assignments.robotAttachment)),e.construct("robot-rate-intro",this._element({tag:"p",classes:"fdb-robots-rate",label:"fdb.robots.rate"})),e.construct("robot-rate-quiz",new o),e.dom.robotRateQuiz.on("rating:choice",this._onRating.bind(this,e)),e.dom.skipOrNext=e.answer({label:"mascot.skip",button:this._skipOrCommitRating.bind(this)}).compact()},n._onRating=function(e,t){this.assign({robotRating:t.m.rating}),e.dom.skipOrNext.label("mascot.next").emphasize()},n._skipOrCommitRating=function(){this.assignments.followUp&&this.assignments.robotRating>=2?this.yield("#followUp"):this.yieldBack()},n._followUp=function(e){var t=this.assignments.robotRating>=4?"good":"ok";e.say("fdb.robots.rated-"+t),e.answer({label:"fdb.robots.response.continue",yield:"BACK"}).emphasize("ok"==t),e.answer({label:"fdb.robots.response.revise",yield:"BACK",assign:{reviseMessage:!0}}),e.answer({label:"fdb.robots.response.satisfied",yield:"BACK",assign:{satisfied:!0}}).emphasize("good"==t)},s}),define("app/views/interviews/feedback/interview-feedback-present-error",["require","common","app/views/components/interviews/interview","app/views/support/technical-output"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("app/views/support/technical-output");return n.commence=function(e){return this.assignments.error?"#describeError":"#missingArgs"},n._describeError=function(e){e.say({html:this.assignments.error.explanation()}),APP.flags.isOn("inspect-errors")&&e.response({html:"👀"},"#showTechnicalDetails"),e.response("error.action.report",this._reportError.bind(this)),e.response("error.action.relaunch",function(){APP.relaunch()},"emph")},n._showTechnicalDetails=function(e){var i={};t.each(this.assignments.error,function(e,t){if("errorSource"==e&&t&&t.match(/\n/))i.errorStack=t.split("\n");else if("errorData"==e)try{JSON.stringify(t),i.errorData=t}catch(e){i.errorData="<unserializable>"}else e.match(/^error[A-Z]/)&&(i[e]=t)});try{i=JSON.stringify(i,null,3)}catch(e){i="Cannot stringify error data. See console for details."}e.say("error.technical-details.intro"),e.construct("error-data",new r),e.dom.errorData.become(i)},n._reportError=function(){APP.interviews.go("interview/feedback/report-error",{error:this.assignments.error})},s}),define("app/views/interviews/feedback/interview-feedback-report-error",["require","common","app/views/components/interviews/interview","shibui/src/components/form-input"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("shibui/src/components/form-input");return n.commence=function(e){return this.assignments.error?"#reportError":"#missingArgs"},n._reportError=function(e){e.say("error.support-request.intro"),e.construct("supportRequestField",new r({lines:3,maxlength:1e3,showLimit:!0,required:!0})),e.response("mascot.next",this._prepareSupportRequest.bind(this,e),"emph")},n._prepareSupportRequest=function(e){if(this._isEpisodeValid(e)){var i=this.assignments.error,s={};s.patronMessage=e.dom.supportRequestField.value(),s.errorSource=i.errorSource||"user-supplied",s.errorMessage=i.errorMessage,s.errorHumanReadable=i.errorHumanReadable,s.errorData=t.absorb(i.errorData,{}),i.sageId&&(s.errorData.sageId=i.sageId),i.reportedToSupport=!0,this.yield("interview/feedback/submit-to-sage",{category:"problem",submission:s,preview:!0,callback:this.assignments.callback})}},s}),define("app/views/support/sage-preview",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.become=function(e,i){this._textify(this.dom.subject,{label:"fdb.submit-to-sage.subject",substitutions:{CATEGORY:e}});var s=i.patronEmailAddress;i.patronName&&s?s=i.patronName+" ("+s+")":i.patronName&&(s=i.patronName),this._textify(this.dom.from,{html:t.safe(s||"...")}),this._textify(this.dom.context);var n=i.titleName||t.try(i,"submissionContext.title.title"),r=i.titleCreator||t.try(i,"submissionContext.title.attribution()"),o=i.titleFormat||t.try(i,"submissionContext.title.format");n&&this._element({tag:"p",parentNode:this.dom.context,label:"fdb.submit-to-sage.preview.context.title",substitutions:{FORMAT:o,TITLE:t.safe(n),CREATOR:t.safe(r)}}),i.errorMessage&&this._element({tag:"p",parentNode:this.dom.context,label:"fdb.submit-to-sage.preview.context.error",substitutions:{ERROR_MESSAGE:t.safe(i.errorMessage)}}),this._classify(this.dom.root,"has-context",!!this.dom.context.innerHTML),this._textify(this.dom.body,{html:t.safe(i.patronMessage)})},n._layout=function(e){this._build("sage-preview",{extending:e}," table <table>","  subject-row <tr>","   subject-head <th> {fdb.submit-to-sage.preview.subject}","   subject <td>","  from-row <tr>","   from-head <th> {fdb.submit-to-sage.preview.from}","   from <td>","  context-row <tr>","   context-head <th> {fdb.submit-to-sage.preview.context}","   context <td>"," body")},s}),define("app/views/interviews/feedback/interview-feedback-submit-to-sage",["require","common","app/views/components/interviews/interview","shibui/src/components/form-input","shibui/src/components/form-input-email-address","app/views/support/sage-preview"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("shibui/src/components/form-input"),o=e("shibui/src/components/form-input-email-address"),a=e("app/views/support/sage-preview");return n.commence=function(e){return this.assignments.submission?"#gatherContactInfo":"#missingArgs"},n._gatherContactInfo=function(e){this.assign({submittedAt:null}),e.say("fdb.submit-to-sage.ask-for-name"),e.construct("name-field",new r({lines:1,maxlength:72,placeholder:"patron-name.placeholder",value:(APP.patron.name()||"").trim(),required:!0})),e.say("fdb.submit-to-sage.ask-for-email-address"),e.construct("email-field",new o({value:APP.patron.emailAddress(),maxlength:72,required:!0}));var t;this.assignments.preview?(t=this._validateContactInfo.bind(this,e,"#previewSubmission"),e.answer({next:t}).emphasize()):(t=this._validateContactInfo.bind(this,e,"#sendSubmission"),e.answer({label:"mascot.send",button:t}).emphasize()),e.dom.nameField.on("form:field:submit",t),e.dom.emailField.on("form:field:submit",t)},n._validateContactInfo=function(e,t){if(this._isEpisodeValid(e)){var i=this.assignments.submission;i.patronName=e.dom.nameField.value(),i.patronEmailAddress=e.dom.emailField.value(),this.yield(t)}},n._previewSubmission=function(e){e.markAsRewritable(e.name),this.assignments.submittedAt?e.say({label:"fdb.submit-to-sage.review-submission",substitutions:{SUBMISSION_TIME:this.assignments.submittedAt}}):e.say("fdb.submit-to-sage.preview-submission"),e.construct("sage-preview",new a),e.dom.sagePreview.become(this.assignments.category,this.assignments.submission),this.assignments.submittedAt||e.answer({label:"mascot.send",yield:"#sendSubmission"}).emphasize()},n._sendSubmission=function(e){e.spin();var t=this.assignments.submission;t.patronName&&APP.patron.choose("patron:name",t.patronName),t.patronEmailAddress&&!APP.patron.choice("patron:email:address")&&APP.patron.choose("patron:email:address",t.patronEmailAddress),APP.sage.submit(this.assignments.category,t,this.thenYield("#submissionSuccess"),this.thenYield("#submissionFailure"))},n._submissionSuccess=function(e){this.assign({submittedAt:t.epochMilliseconds()}),e.say("fdb.submit-to-sage.submission.success"),e.answer({done:!0})},n._submissionFailure=function(e){e.say("fdb.submit-to-sage.submission.failure"),e.answer({label:"mascot.retry",yield:"#gatherContactInfo"})},s}),define("app/views/interviews/status/interview-status-merged",["require","common","app/views/components/interviews/interview"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype;return n.commence=function(e){var i=this.assignments.library;return i?t.among(i.status,"Terminated","Deleted")?{path:"interview/status/shelved",assignments:this.assignments}:"Merged"!=i.status?i.path():"#explainStatus":{path:"interview/locate-library/resolve",parameters:this.parameters,callback:!0}},n._configure=function(e,t){this.parameters=this._extractLibraryParameters(e,t)},n._explainStatus=function(e){var t=this.assignments.library;t.mergerMessage?(e.say("library-status.merger.explanation-from-library"),e.say({label:"quotation",substitutions:{QUOTE:t.mergerMessage}})):e.say({label:"library-status.merger.explanation-default",substitutions:{LIBRARY_NAME:t.safeName()}}),e.say("library-status.merger.cards-warning");var i="library/"+t.mergerLibraryKey;e.response("library-status.merger.continue",this._continueToNewLibrary.bind(this,i),"emph")},n._removeCardsForLibrary=function(e){APP.journal.debug("[LIBRARY-STATUS] remove all cards for library",e),t.each(e.cards(),function(e){APP.sentry.unlinkCard(e)})},n._continueToNewLibrary=function(e){this._removeCardsForLibrary(this.assignments.library),APP.libraries.removeItem(this.assignments.library),APP.nav.go(e)},s}),define("app/views/interviews/status/interview-status-shelved",["require","common","app/views/interviews/status/interview-status-merged","app/views/components/library/summary-list-of-libraries"],function(e){var t=e("common"),i=e("app/views/interviews/status/interview-status-merged"),s=i.new(),n=s.prototype,r=e("app/views/components/library/summary-list-of-libraries");return n.commence=function(e){var i=this.assignments.library;return i?"Merged"==i.status?{path:"interview/status/merged",assignments:this.assignments}:t.among(i.status,"Terminated","Deleted")?"#explainStatus":i.path():{path:"interview/locate-library/resolve",parameters:this.parameters,callback:!0}},n._explainStatus=function(e){var t=this.assignments.library;e.say({label:"library-status.shelved.apology",substitutions:{LIBRARY_NAME:t.safeName()}}),e.say("library-status.shelved.mission"),e.say("library-status.shelved.go-to-site"),t.urls.home&&e.answer({label:"library-status.shelved.go-to-site.response",button:APP.shell.bindOpenURL(t.urls.home)}),e.answer({label:"mascot.next",yield:"#suggestOtherLibraries"}).emphasize()},n._suggestOtherLibraries=function(e){e.say("library-status.shelved.other-libraries");var i=APP.libraries.withCards();t.excise(i,this.assignments.library),i.length&&(e.construct("library-list",new r),e.dom.libraryList.become([{libraries:i}]),e.dom.libraryList.on("summary:library:select",function(e){APP.events.stop(e),this._continueToNewLibrary(e.m.library.path())}.bind(this))),e.answer({label:"library-status.shelved.other-libraries.response",yield:"interview/locate-library/map",assign:{callback:this._returningFromMap.bind(this)}}).emphasize()},n._returningFromMap=function(e){this.yield("interview/locate-library/resolve",{parameters:e,callback:function(e){this._continueToNewLibrary(e.library.path())}.bind(this)})},s}),define("app/views/interviews/reset/interview-reset-chip-data",["require","common","app/views/components/interviews/interview","shibui/src/components/form-input"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("shibui/src/components/form-input");return n.commence=function(e){return APP.investigator.isChipMissingFromBank()?"#explainDataLoss":"#noDataLost"},n._configure=function(e,t){this.assign({activitiesCount:APP.patron.activities.all.length})},n._explainDataLoss=function(e){e.say({html:["Your library cards, loans, holds, and tags were not found","on your device, but they have not been completely removed."].join(" ")}),e.say({html:["If you intended to remove all your old data, you can","<strong>erase</strong> the rest of it and continue.","Otherwise, we’ll try to ","<strong>recover</strong> as much as possible."].join(" ")}),e.response({html:"Erase Data"},"interview/reset/libby"),e.response({html:"Recover Data"},"#recoverData","emph"),APP.events.dispatch("investigate:record",{what:"offering to recover or erase chip data",where:"InterviewResetChipData#_explainDataLoss",why:"INV-BANK002 INV-BANK002-G"})},n._recoverData=function(e){e.spin(),APP.investigator.recoverChipToBank(),t.try(APP.auditor,"setAutoDownloadRule()","nothing"),APP.sentry.acquireChip(function(){APP.patron.sync.commence({freshness:0,syncJourneys:!1,onSuccess:this.thenYield("#syncSuccess"),onFailure:this.thenYield("#syncFailure")})}.bind(this),this.thenYield("#syncFailure"))},n._syncSuccess=function(e){APP.router.waypoints.interview.splice(0),APP.router.waypoints.interview.push(APP.router.route.waypoint),e.say({html:"Most of your data has been recovered."}),APP.investigator._saveToLocalStorage("forgotten-credentials");var i=APP.libraries,s=APP.library||i.withCards()[0]||i.all[0],n=t.epochMilliseconds();t.each(i.all,function(e,t){e.activatedAt=e.activatedAt||n-(1e3*t+1)}),s&&(s.activatedAt=n,i.now(s)),i.save(),e.say({html:["If you think you know what might have caused your data","to go missing, please contact our Support team."].join(" ")}),e.response("interview.feedback-support","#writeSupportRequest"),e.response("mascot.next",this._exitPath(),"emph"),APP.events.dispatch("investigate:record",{what:"recovered chip data from local storage",where:"InterviewResetChipData#_syncSuccess",why:"INV-BANK002 INV-BANK002-H",counts:{libraries:APP.libraries.all.length,cards:APP.patron.cards.all.length,loans:APP.patron.loans.all.length,holds:APP.patron.holds.all.length}})},n._syncFailure=function(e){e.say({html:["Sorry, that didn’t work. There may be problems connecting to","the network, or a problem with our systems."].join(" ")}),e.response("interview.feedback-support","#writeSupportRequest"),e.response("mascot.retry","#recoverData","emph")},n._writeSupportRequest=function(e){e.say("authenticate.intro.support-request"),e.construct("support-request-field",new r({lines:3,maxlength:1e3,showLimit:!0,required:!0,"aria-label":this._phrase("fdb.support.problem.a11y-label")})),e.response("mascot.next",this._submitSupportRequest.bind(this,e),"emph")},n._submitSupportRequest=function(e){if(this._isEpisodeValid(e)){var t={};t.patronMessage=[e.dom.supportRequestField.value(),"Context: data loss detected on launch"].join("\n\n").trim(),this.yield("interview/feedback/submit-to-sage",{category:"problem",submission:t,preview:!0,callback:function(){APP.nav.go("interview/menu"),APP.nav.go(this._exitPath())}.bind(this)})}},n._noDataLost=function(e){e.say({html:"You do not appear to have lost any data."}),e.response("mascot.next","/","emph")},n._exitPath=function(){try{APP.library=APP.library||t.try(APP.patron,"cards.all[0].library")||(APP.libraries.withCards()||APP.libraries.all||[])[0]}catch(e){}return t.try(APP.library,"path()")||"shelf"},s}),define("app/views/interviews/reset/interview-reset-steps",["require","common","app/views/components/interviews/interview","app/views/components/tags/tag-plank"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("app/views/components/tags/tag-plank");return n.commence=function(e){return"#resetStepIntent"},n.continue=function(){var e=["Intent"],i=this._.visited=this._.visited||[];if((t.among("LoansAndHolds",i)||APP.patron.loans.all.length||APP.patron.holds.all.length)&&e.push("LoansAndHolds"),(t.among("Luggages",i)||this._findLuggages().length)&&e.push("Luggages"),(t.among("Activities",i)||this._findActivities())&&e.push("Activities"),t.among("Tags",i))e.push("Tags");else{var s=APP.patron.tags.all,n=0;t.each(s,function(e){n+=e.totalTaggings}),n>1&&e.push("Tags")}var r=t.last(this.episodes||[]),o=(t.try(r,"name")||"").replace(/^resetStep/,""),a=e.indexOf(o);if(a>=0){var l=e[a+1];l&&i.push(l),this.yield("#resetStep"+(l||"Confirmation"))}else this.yield("#resetStepIntent")},n._resetStepIntent=function(e){e.say({html:["There are various ways you can erase your data in the app.","What are you trying to achieve?"].join(" ")}),e.answer({html:"Manage Library Cards",yield:"#resetStepCards"}).explanation({html:"I want to sign out of my library, without deleting other data."}),e.answer({html:"Step-By-Step Reset",button:this.continue.bind(this)}).explanation({html:"I want to reset Libby, deleting all of its data on my device."})},n._resetStepCards=function(e){e.say({html:[].join(" ")}),e.construct("cards-list",this._element({tag:"ul",classes:"interview-erasable-list reset-step-cards-list"})),t.each(APP.patron.cards.all,function(t){var i=this._build("interview-erasable-item <li>",{parentNode:e.dom.cardsList}," portrayal","  title <strong>","  subtitle <span>"," button",{button:APP.noop},"  icon",{graphic:"trash"});this._buttonify(i.button,function(e){this._classify(i.root,"is-erased")}.bind(this))},this),e.response("mascot.done",this.thenYieldBack(),"emph")},n._resetStepLoansAndHolds=function(e){e.markAsRewritable(e.name);var i=APP.patron.loans.all,s=APP.patron.holds.all;if(i.length||s.length){e.say({html:["There are currently",i.length+" loans and",s.length+" holds on your cards."].join(" ")});var n={};t.each(t.compact([i.length?"loans":null,s.length?"holds":null]),function(t){n[t]=this._build("reset-step-possessions-section .reset-step-"+t+"-section"," head <h2>",{label:"shelf.nav."+t}," list .interview-erasable-list <ul>"),e.construct(t+"-list",n[t].root)},this),t.each(i.concat(s),function(e){var t=this._build("interview-erasable-item <li>",{parentNode:n[e.type+"s"].list}," portrayal","  title <strong>",{html:e.title.titleWithoutOrphans()},"  subtitle <span>",{label:"format."+e.title.format,wrapper:!1}," button .shibui-button",{button:APP.noop,html:{loan:"Return",hold:"Cancel"}[e.type]});this._buttonify(t.button,function(e){this._classify(t.root,"is-erased")}.bind(this))},this)}else e.say({html:["There are no longer any loans or holds on your cards."].join(" ")});e.response("mascot.continue",this.continue.bind(this),"emph")},n._resetStepLuggages=function(e){e.markAsRewritable(e.name);var i=this._findLuggages();i.length?(e.say({html:["These titles are downloaded to your device.","Delete each download to continue resetting the app."].join(" ")}),e.construct("luggages-list",this._element({tag:"ul",classes:"interview-erasable-list reset-step-luggages-list"})),t.each(i,function(t){var i=this._build("interview-erasable-item <li>",{parentNode:e.dom.luggagesList}," portrayal","  title <strong>","  subtitle <span>"," button",{button:APP.noop},"  icon",{graphic:"trash"});t.title.use(function(e,t){this._textify(i.title,{html:t.titleWithoutOrphans()}),this._textify(i.subtitle,{label:"format."+t.format,wrapper:!1}),this._buttonify(i.button,function(e){this._classify(i.root,"is-erased")}.bind(this))},this)},this)):e.say({html:["There are no longer any titles downloaded to your device."].join(" ")}),e.response("mascot.continue",this.continue.bind(this),"emph")},n._resetStepActivities=function(e){e.markAsRewritable(e.name);var i=this._findActivities();i?(e.say({html:["Most timeline records are stored only on your device.","Delete each type of activity to continue resetting the app."].join(" ")}),e.construct("activities-list",this._element({tag:"ul",classes:"interview-erasable-list reset-step-activities-list"})),t.each(i,function(t,i){var s=this._build("interview-erasable-item <li>",{parentNode:e.dom.activitiesList}," portrayal","  title <strong>",{label:"filter.act-"+t,wrapper:!1},"  subtitle <span>",{html:i.length+" records"}," button",{button:APP.noop},"  icon",{graphic:"trash"});this._buttonify(s.button,function(e){this._classify(s.root,"is-erased")}.bind(this))},this)):e.say({html:["There are no longer any timeline records stored on your device."].join(" ")}),e.response("mascot.continue",this.continue.bind(this),"emph")},n._resetStepTags=function(e){e.spin(),APP.patron.tags.use(function(i,s){e.rewrite(e.name,function(){e.markAsRewritable(e.name);var i=0;t.each(s.all,function(e){i+=e.totalTaggings}),e.say({html:["Be aware that",s.all.length+" tags with",i+" titles will be permanently deleted,",'unless you have <a href="#">copied them to another device</a>.'].join(" "),enliven:{}}),e.construct("tags-list",this._element({tag:"ul",classes:"reset-step-tags-list"})),t.each(s.all,function(t){var i=this._element({tag:"li",parentNode:e.dom.tagsList}),s=new r(i);s.become(t,{titles:[]})},this),e.response({html:"OK, I Understand"},this.continue.bind(this),"emph")}.bind(this))}.bind(this))},n._resetStepConfirmation=function(e){e.markAsRewritable(e.name),e.say({html:["This will delete all your Libby settings","and any remaining Libby data on this device.","The app will start again as a blank slate.","Are you ready?"].join(" ")}),e.response({html:"Yes, Reset Everything"},this.thenYieldBack(),"emph")},n._findLuggages=function(){return t.select(APP.titles.luggages.all,function(e){var i=e.status();if(!i.isStreamed&&t.try(i,"bytes.downloaded"))return e})},n._findActivities=function(){var e={loans:APP.patron.activities.collate({act:"loans"}),holds:APP.patron.activities.collate({act:"holds"}),renewals:APP.patron.activities.collate({act:"renewals"}),returns:APP.patron.activities.collate({act:"returns"})};if(e.loans.length||e.holds.length||e.renewals.length||e.returns.length)return e},s}),define("app/views/interviews/reset/interview-reset-libby",["require","common","app/views/components/interviews/interview"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype;return n.commence=function(e){return"#warnAboutReset"},n._warnAboutReset=function(e){e.say("reset-app.warning"),APP.patron.loans.all.length>0&&(e.say("reset-app.loans.intro"),e.construct("list-loans",this._listLoans()),e.say("reset-app.loans.outro"));var t,i=this._countTaggings();i&&(t=e.say({label:"reset-app.tags",substitutions:{TAG_COUNT:APP.patron.tags.all.length,TAGGING_COUNT:i}})),APP.patron.activities.all.length&&(t?t.innerHTML+=" "+this._phrase("reset-app.activity"):t=e.say("reset-app.activity")),e.answer({label:"reset-app.confirm",yield:"#confirmedReset",assign:{confirmation:!0}}).emphasize("danger")},n._confirmedReset=function(e){return this.assignments.confirmation?(APP.semaphore.set("client","unloading"),APP.arena.splash(!0),void this._commenceAppReset()):APP.nav.go("")},n._listLoans=function(){var e=this._element({tag:"ul",classes:"reset-app-loans-list"});return t.each(APP.patron.loans.all,function(i){var s=i.title.title;s.length>60&&(s=s.substring(0,60)+"&hellip;");var n=t.try(i.luggage(),"status().bytes.downloaded");n&&(s=this._phrase({label:"reset-app.title-size",substitutions:{TITLE:s,MB:n}})),this._element({tag:"li",parentNode:e,html:s})},this),e},n._countTaggings=function(){var e=0;if(t.each(APP.patron.tags.all,function(t){e+=t.totalTaggings}),0!=e)return e},n._commenceAppReset=function(){APP.scribe.record("app:reset"),APP.titles.now(null),APP.shell.transmit("bank:wipe:all"),APP.shell.transmit("roster:wipe:all"),APP.shell.transmit("cookies:wipe:all"),window.localStorage&&localStorage.clear(),setTimeout(this._completeAppReset.bind(this),1e3)},n._completeAppReset=function(){var e=function(){location.href="/"};APP.sentry.destroyChip(e,e)},s}),define("app/views/interviews/tutorial/interview-tutorial-what-are-tags",["require","common","app/views/components/interviews/interview"],function(e){var t=(e("common"),e("app/views/components/interviews/interview")),i=t.new(),s=i.prototype;return s.BANK_KEY_DISMISSAL="tutorial:what-are-tags",s.commence=function(e){return"#explainTags"},s._explainTags=function(e){e.characterize({mascot:"academy",semaphores:{appearance:"prompt","appearance-prompt-type":"feature"}}),e.say("tutorial-what-are-tags.explain.1"),e.say("tutorial-what-are-tags.explain.2"),e.answer({label:"mascot.show-me-how",button:this._onTapShowMe.bind(this)}).compact()},s._onTapShowMe=function(e){APP.library&&APP.patron.dismiss(this.BANK_KEY_DISMISSAL),APP.interviews.dialog("tutorial/creating-tags",{title:this.assignments.title,library:this.assignments.library}).present()},i}),define("app/views/components/common/demo-lasso",["require","common","app/views/core/partial"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype;return n.encircle=function(e,i,s,n,r){if(t.isInDOM(e)){"number"!=typeof i&&(i=0),"number"!=typeof s&&(s=i);var o=this.dom.noose;this._declassify(o,"is-stroking"),o.style.removeProperty("top"),o.style.removeProperty("left");var a=e.getBoundingClientRect(),l=o.getBoundingClientRect(),c={x:a.left-l.left-i,y:a.top-l.top-s,w:a.width+2*i,h:a.height+2*s};"number"==typeof n&&(c.x+=n),"number"==typeof r&&(c.y+=r);var h=parseFloat(o.getAttribute("width")),u=parseFloat(o.getAttribute("height"));if(o.style.setProperty("top",c.y+"px"),o.style.setProperty("left",c.x+"px"),o.setAttribute("width",c.w),o.setAttribute("height",c.h),this._.lastCircle&&this._.lastCircle.x==c.x&&this._.lastCircle.y==c.y&&this._.lastCircle.w==c.w&&this._.lastCircle.h==c.h)return this._classify(o,"is-stroking");this._.lastCircle=c;var p=o.querySelector("path"),d=p.getAttribute("d"),m=c.w/h,f=c.h/u;o.setAttribute("viewBox","0 0 "+c.w+" "+c.h);var g=d.replace(/([\d\.]+),([\d\.]+)/g,function(e,t,i){return t=parseFloat(t),t-=h/2,t*=m,t+=c.w/2,i=parseFloat(i),i-=u/2,i*=f,i+=c.h/2,[t,i].join(",")});p.setAttribute("d",g);for(var b=p.getTotalLength(),v=o.querySelectorAll("use"),y=0;y<v.length;++y)v[y].setAttribute("xlink:href","#"+p.id),v[y].style.setProperty("transition","initial"),v[y].style.setProperty("stroke-dashoffset",b+"px"),v[y].style.setProperty("stroke-dasharray",b+"px"),this._defer("stroking",function(){this.style.setProperty("stroke-dashoffset",0),this.style.setProperty("transition","stroke-dashoffset 1s ease-in-out")}.bind(v[y]),200);this._defer("vis",this._classify.bind(this,o,"is-stroking",!0))}},n._layout=function(e){this._build("demo-lasso",{extending:e,access:"visual"}," noose",{graphic:"encircle"})},s}),define("app/views/interviews/tutorial/interview-tutorial-creating-tags",["require","common","app/views/components/interviews/interview","app/views/core/title-tile","app/views/components/common/demo-lasso","app/views/library/title-journey-preview"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("app/views/core/title-tile"),o=e("app/views/components/common/demo-lasso"),a=e("app/views/library/title-journey-preview");return n.commence=function(e){return APP.library?this.assignments.tag?"#afterTagCreation":this.assignments.library&&this.assignments.title?{path:"interview/configure/tag-name",assignments:{behavior:"regular",title:this.assignments.title,library:this.assignments.library,
callback:!0}}:"#findSuitableTitle":"#addLibrary"},n._addLibrary=function(e){e.characterize({mascot:"academy"}),e.say("tutorial-creating-tags.no-active-library"),e.response("menu.library.response.add-library",APP.nav.go.bind(APP.nav,"interview/welcome"),"emph")},n._findSuitableTitle=function(e){e.characterize({mascot:"academy"}),e.spin();var i=APP.library.catalog.lists.produce("everything/books,audiobooks/sort-mostpopular-site");i.freshen(0,24,function(e,i){if(!i.length)return this.yield("#noSuitableTitle");var s=t.shuffle(i.slice());t.each(t.shuffle(i),function(e){return e.possession()?s.length<=1?t.breakIteration(this.yield("#noSuitableTitle")):t.excise(s,e):(this.assignments.title&&t.breakIteration(),void e.tags.use(function(i,n){if(!this.assignments.title){if(!i.isIdeal)return n.reuse();t.excise(s,e),(!s.length||n.all&&!n.all.length)&&this.yield("#titleTile",{title:e})}},this))},this)}.bind(this))},n._noSuitableTitle=function(e){e.characterize({mascot:"failure"}),e.say("tutorial-creating-tags.no-suitable-title"),e.response("menu.library.response.add-library",APP.nav.go.bind(APP.nav,"interview/locate-library/search"),"emph")},n._titleTile=function(e){e.characterize({mascot:"academy"}),e.say("tutorial-creating-tags.title-tile-intro"),e.construct("title-tile",new r),e.construct("lasso",new o);var i=this.assignments.title,s=APP.library;e.dom.titleTile.on("refresh",function(){if(e.dom.titleTile.isInDocument()){var n=e.dom.titleTile.dom.root.querySelector(".tag-button");if(n){var r=e.dom.titleTile.dom.root.querySelectorAll("*");t.each(r,function(e){e!=n&&this._isInteractiveElement(e)&&(e.classList.contains("title-tile-action")?e.removeAttribute("href"):this.access(e,"inert"))},this),this.access(n,"normal"),this._buttonify(n,this.thenYield("interview/configure/tag-name",{behavior:"regular",title:i,library:s,callback:"#afterTagCreation"})),this._defer("lasso",function(){e.dom.lasso.encircle(n,10,10,-10)},500)}}}.bind(this)),e.dom.titleTile.become(i,{provenance:"shelf",library:s})},n._afterTagCreation=function(e){e.characterize({mascot:"academy"});var t=this.assignments.tag.find({"title.titleId":this.assignments.title.titleId});t&&(e.construct("tag-journey",new a),e.dom.tagJourney.becomeActs([t])),e.say("tutorial-creating-tags.confirmation.2"),e.say("tutorial-creating-tags.confirmation.3"),e.response("mascot.done",this.thenYieldBack(),"emph")},s}),define("app/views/interviews/tutorial/interview-tutorial-suggest-notifications",["require","common","app/views/components/interviews/interview"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype;return n.BANK_KEY_ACK="notifier:suggest:ack",n.ACK_TTL_MS=864e5,n.commence=function(e){return this.assignments.psnType?"#suggestNotifications":"#missingArgs"},n.checkRelevance=function(e){var i=APP.bank.get(this.BANK_KEY_ACK)||0,s=(parseFloat(i)||0)+this.ACK_TTL_MS;return s>t.epochMilliseconds()?e(!1):(this.assign({psnType:this._determinePsnType()}),this.assignments.psnType?void APP.summoner.daemons.notifierRepair.diagnoseNotifier(function(t,i){e(!(!i||!i.action))}.bind(this)):e(!1))},n._suggestNotifications=function(e){e.say("circ.prompt.notifications."+this.assignments.psnType),e.answer({label:"circ.prompt.notifications.yes",button:this._answerYes.bind(this)}).emphasize(),e.answer({label:"circ.prompt.notifications.never",button:this._answerNever.bind(this)}),e.answer({label:"circ.prompt.notifications.later",button:this._answerLater.bind(this)})},n._answerYes=function(){this._afterAnswer(),t.each(APP.notifier.notifications.ARCHETYPES,function(e){"circulation"==e.groupId&&APP.notifier.subscribe(e.category,2)}),APP.interviews.dialog("configure/notifications").present()},n._answerNever=function(){this._afterAnswer(),APP.notifier.setServiceProvider(null,{})},n._answerLater=function(){this._afterAnswer()},n._afterAnswer=function(){APP.bank.set(this.BANK_KEY_ACK,t.epochMilliseconds()),this.yieldBack()},n._determinePsnType=function(){var e=this.assignments.action||t.try(APP.router,"route.args.action");return{borrow:"loan","lucky-day":"loan",renew:"loan",hold:"hold",suspend:"hold",redeliver:"hold"}[e]},s}),define("app/views/interviews/tutorial/interview-tutorial-title-language",["require","common","app/views/components/interviews/interview","app/views/core/cover-box","app/views/library/circ-pill"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("app/views/core/cover-box"),o=e("app/views/library/circ-pill");return s.RECENT_CODES=[],n.BANK_KEY="patron:title:languages",n.MAX_TITLES=10,n.checkRelevance=function(e){var i=t.try(this.assignments,"title.languages");if(!t.isList(i)||!i.length)return APP.journal.warn("[INTERVIEW-TUTORIAL-TITLE-LANGUAGE] no languages found for title",t.try(this.assignments,"title")),e(!1);for(var n=0,r=i.length;n<r;++n){var o=this._shortCode(t.try(i[n],"id"));if(o&&t.among(o,s.RECENT_CODES))return e(!1)}this._.knownLanguages={};var a=t.epochSeconds()-7776e3;t.each(APP.bank.get(this.BANK_KEY),function(e,t){t>a&&(this._.knownLanguages[e]=t)},this),this._.knownLanguages[this._shortCode(SPARK.locale.tag)]=t.epochSeconds();for(var n=0,r=i.length;n<r;++n){var o=this._shortCode(t.try(i[n],"id"));if(o&&this._.knownLanguages[o])return this._rememberLanguage(o),e(!1)}e(!0)},n.commence=function(e){return this.boundary(),"#confirmLanguage"},n._configure=function(e,t){e.library||this.assign({library:APP.library})},n._confirmLanguage=function(e){var i={};i.LANGUAGES=t.select(this._namesOfLanguages(this.assignments.title.languages),function(e){return"<strong>"+e+"</strong>"}),e.say({label:"tutorial-title-language.confirm-language",substitutions:i}),e.answer({label:"tutorial-title-language.confirm-language.yes",button:this._passTitle.bind(this)}).emphasize(),e.answer({label:"tutorial-title-language.confirm-language.no",yield:"#findAnotherTitle"})},n._findAnotherTitle=function(e){t.try(this,"owner.shade.options")&&(this.owner.shade.options.constrainToContentHeight=!1),e.spin();var i=this.assignments.library,s=this.assignments.title,n=encodeURIComponent(s.title||""),r=encodeURIComponent(t.try(s.authors(),"[0].name")||""),o=t.select(this._.knownLanguages,function(e){return encodeURIComponent(e)});if(!n||!r||!o.length)return this.yield("#noMatchingTitles");var a=["search","title-"+n,"creator-"+r,"language-"+o.join(","),"facets-false","override"];i.allowDeepSearch&&a.splice(4,0,"scope-deep");var l=i.catalog.lists.make(a.join("/"));l.freshen(0,this.MAX_TITLES,function(e,s){this.assign({list:i.catalog.lists.make(a.slice(0,-1).join("/")),listTotalTitles:e.totalTitles}),e.totalTitles>this.MAX_TITLES?this.yield("#navigateToList"):s.length?this.yield("#listMatchingTitles",{titles:s}):(t.excise(a,a[1]),e=i.catalog.lists.make(a.join("/")),e.freshen(0,this.MAX_TITLES,function(e,t){this.assign({list:i.catalog.lists.make(a.slice(0,-1).join("/")),listTotalTitles:e.totalTitles}),e.totalTitles>this.MAX_TITLES?this.yield("#navigateToList"):t.length?this.yield("#listMatchingTitles",{titles:t}):this.yield("#noMatchingTitles")}.bind(this),this.thenYield("#failureMatchingTitles")))}.bind(this),this.thenYield("#failureMatchingTitles"))},n._listMatchingTitles=function(e){1==this.assignments.titles.length?e.say("tutorial-title-language.list-matching-titles.one"):e.say("tutorial-title-language.list-matching-titles.some"),e.construct("titles-list",this._element({classes:"tutorial-title-language-match-list"})),t.each(this.assignments.titles,function(i){var s=this._namesOfLanguages(i.languages),n=this._build("tutorial-title-language-match",{parentNode:e.dom.titlesList}," cover",r," details","  title <h3>",{html:i.titleWithoutOrphans()},"  languages {tutorial-title-language.match-languages}",{substitutions:{LANGUAGES:s}},"  pill",o);n.cover.become(i,{button:function(){APP.nav.back(),APP.nav.go(i.path(this.assignments.list))}.bind(this)}),n.pill.become(i,{library:this.assignments.library,list:this.assignments.list}),n.pill.on("action:commence",function(i){this._isEpisodeCurrent(e)&&"notify-me"!=t.try(i,"m.action")&&APP.nav.back()}.bind(this)),n.pill.on("action:complete",function(s){this._isEpisodeCurrent(e)&&"notify-me"==t.try(s,"m.action")&&(e.markAsRewritable(),this.yield("#taggedWithNotifyMe",{tagged:i}))}.bind(this))},this)},n._navigateToList=function(e){e.say({label:"tutorial-title-language.navigate-to-list",substitutions:{TITLE_COUNT:this.assignments.listTotalTitles}});var i={AUTHOR_NAME:t.try(this.assignments.title.authors(),"[0].name"),LANGUAGES:this._namesOfLanguages()};e.answer({label:"tutorial-title-language.list-link",button:function(){APP.nav.back(),APP.nav.go(this.assignments.list.path())}.bind(this)}).explanation({label:"tutorial-title-language.list-link.explanation",substitutions:i})},n._noMatchingTitles=function(e){e.say({label:"tutorial-title-language.no-matching-titles",substitutions:{LANGUAGES:this._namesOfLanguages()}}),e.answer({done:!0,assign:{exception:"title-language-unknown-to-user"}})},n._failureMatchingTitles=function(e){e.say({label:"tutorial-title-language.failure-matching-titles"}),e.answer({label:"mascot.retry",yield:"#findAnotherTitle"}).emphasize(),e.answer({done:!0,assign:{exception:"title-language-unknown-to-user"}})},n._taggedWithNotifyMe=function(e){var t=this.assignments.tagged.languages;e.say({label:"tutorial-title-language.tagged-with-notify-me",substitutions:{LANGUAGES:this._namesOfLanguages(t)}}),e.answer({done:!0,assign:{exception:"title-language-unknown-to-user"}})},n._passTitle=function(){var e=t.try(this.assignments.title,"languages[0].id");this._rememberLanguage(e),this.yieldBack()},n._rememberLanguage=function(e){var i=this._shortCode(e);i&&(this._.knownLanguages[i]=t.epochSeconds(),APP.bank.set(this.BANK_KEY,this._.knownLanguages))},n._shortCode=function(e){if(e)return e.replace(/[^\w].*$/,"")},n._namesOfLanguages=function(e){return e=e||this._.knownLanguages,t.select(e,function(e){return"string"==typeof e&&(e={id:e}),e&&e.name?e.name:e&&e.id?this._phrase({label:"language.code-"+e.id,okIfMissing:!0}):void 0},this)},s}),define("app/views/components/interviews/constructs/tutorial-notify-me-tag-planks",["require","common","app/views/core/partial","app/views/components/tags/tag-plank"],function(e){var t=e("common"),i=e("app/views/core/partial"),s=i.new(),n=s.prototype,r=e("app/views/components/tags/tag-plank");return n.become=function(e){this.purpose=t.try(e,"purpose")||"notify-me-unowned",this.titleId=t.try(e,"titleId"),this.limit=e.limit||3,this._textify(this._prepare().list);var i=APP.patron.tags.filter({"behavior.key":"notify-me"});if("expanded"==t.try(e,"mode"))t.each(i,this._addPlank.bind(this)),this._fillAlternative("create");else{var s=APP.patron.tags.suggestTagForPurpose(this.purpose,{stub:!0});this._addPlank(s),t.excise(i,s),i.length?this._fillAlternative("choose"):this._fillAlternative("create")}},n._layout=function(e){this._build("tutorial-notify-me-tag-planks",{extending:e}," list <ul>"," alternative",{button:function(){},"data-halo-states":"focus"})},n._fillAlternative=function(e){var t=this._prepare(),i="tutorial-notify-me-tag-planks.alternative",s="tag-add";"create"==e?this._buttonify(t.alternative,function(){this._dispatch("select",{alternative:"create"})}.bind(this)):(this._buttonify(t.alternative,function(){this._dispatch("select",{alternative:"choose"})}.bind(this)),i+=".choose",s="tag-list"),this._textify(t.alternative),t.altLabel=this._element({label:i,parentNode:t.alternative,classes:"tutorial-notify-me-tag-planks-alt-label"}),t.altIcon=this._element({graphic:s,parentNode:t.alternative,access:"visual",classes:"tutorial-notify-me-tag-planks-alt-icon"})},n._addPlank=function(e){var t=this._prepare(),i=this._element({tag:"li",parentNode:t.list}),s=this._element({button:this._onTapPlank.bind(this,e),parentNode:i,"data-halo-states":"focus"});this._classify(s,"is-stub",!e.collation);var n={};e.collation||(n.countGraphic="tag-add");var o=new r(s);o.become(e,n);var a=t.list.children.length;return t["tagRow"+a]=i,t["tagButton"+a]=s,t["tagPlank"+a]=o,o},n._onTapPlank=function(e,i){var s={stub:!e.collation};if(!e.collation){var n=e.description;e=APP.patron.tags.produce({name:e.name}),e.description=n||e.description,e.behave("notify-me")}this._dispatch("select",t.absorb({tag:e},s))},s}),define("app/views/components/interviews/constructs/tutorial-notify-me-explainer",["require","common","app/views/core/partial"],function(e){var t=(e("common"),e("app/views/core/partial")),i=t.new(),s=i.prototype;return s.become=function(e){var t=this._prepare();this._textify(t.text,e),this._defer(this._declassify.bind(this,t.bell,"hide"),60)},s._layout=function(e){this._build("tutorial-notify-me-explainer",{extending:e}," bell",{graphic:"notify-me-bell",access:"visual",classes:"hide"}," text <p>")},i}),define("app/views/interviews/tutorial/interview-tutorial-title-unowned-notify-me",["require","common","app/views/components/interviews/interview","app/views/components/interviews/constructs/tutorial-notify-me-tag-planks","app/views/components/interviews/constructs/tutorial-notify-me-explainer","app/views/components/interviews/constructs/notification-toggle"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("app/views/components/interviews/constructs/tutorial-notify-me-tag-planks"),o=e("app/views/components/interviews/constructs/tutorial-notify-me-explainer"),a=e("app/views/components/interviews/constructs/notification-toggle");return n.PURPOSE="notify-me-unowned",n.PREFIX="tutorial-title-unowned-notify-me",n.NOTIFICATION_CATEGORIES=["notify-me-title","notify-me-author","notify-me-series"],n.commence=function(e){return"#checkLanguage"},n._checkLanguage=function(e){e.spin(),this.owner.checkRelevance("tutorial/title-language",{title:this.assignments.title},function(e,t){return e?void t(this.thenYield("#introduceNotifyMe")):this.yield("#introduceNotifyMe")}.bind(this))},n._introduceNotifyMe=function(e){return"title-language-unknown-to-user"==this.assignments.exception?this.owner&&this.owner.shade?this.owner.shade.minimize():this.yieldBack():(e.say(this.PREFIX+".intro"),e.construct("planks",new r),e.dom.planks.on("select",this._onTagPlanksSelect.bind(this)),e.dom.planks.become({titleId:this.assignments.title.titleId,purpose:this.PURPOSE}),e.construct("explainer",new o),void e.dom.explainer.become(this.PREFIX+".explainer"))},n._chooseFromAllNotifyMeTags=function(e){e.construct("planks",new r),e.dom.planks.on("select",this._onTagPlanksSelect.bind(this)),e.dom.planks.become({titleId:this.assignments.title.titleId,purpose:this.PURPOSE,mode:"expanded"})},n._afterTagApplied=function(e){if(this.boundary(),e.spin(),APP.bank.set("tags:purpose:"+this.PURPOSE+":uuid",t.try(this.assignments.tag,"uuid")),this.assignments.isStub){for(var i=[];;){var s=this._phrase({label:this.PREFIX+".applied."+i.length,okIfMissing:!0});if(!s)break;i.push(s)}i.length&&this.assign({afterwords:i})}var n=!!this.assignments.afterwords;this._isNotificationsInNeedOfRepair(function(e){n=n||e,this._isNotificationsConfiguredForRemote(function(e){return n=n||!e,!n&&e?this.yieldBack():void this.yield("#tutorialAfterword")}.bind(this))}.bind(this))},n._tutorialAfterword=function(e){var i=this.assignments.notificationRepair,s=this.assignments.notificationSettings;if(this.assignments.afterwords&&(t.each(this.assignments.afterwords,e.say.bind(e)),i||s?e.divider():e.response("mascot.done",this.thenYieldBack(),"emph")),i)e.say("tutorial-title-unowned-notify-me.ntf-repair"),e.response("interview.configure-notifications",APP.nav.go.bind(APP.nav,"interview/configure/notifications"),"emph");else if(s){e.say("tutorial-title-unowned-notify-me.ntf-adjust");var n=["notifications.label.ignore","notifications.label.shelf","notifications.label."+(s.pushy?"push":"email")];t.each(s.levels,function(t,i){var s=e.construct("ntf-"+t[0],new a);s.become(t[0],t[1]),s.applyLabels(n,{visualLabels:!i})}),e.response("mascot.done",this._onTapDone.bind(this),"emph")}},n._onTagPlanksSelect=function(e){e.m.tag?(this.assign({tag:e.m.tag,isStub:!!e.m.stub}),this.assignments.tag.addToTitle(this.assignments.title,this.assignments.library),this.yield("#afterTagApplied")):"choose"==e.m.alternative?this.yield("#chooseFromAllNotifyMeTags"):this.yield("interview/configure/tag-name",{title:this.assignments.title,library:this.assignments.library,behavior:"notify-me",callback:this.thenYield("#afterTagApplied")})},n._onTapDone=function(){this._saveNotificationLevels(),this.yieldBack()},n._isNotificationsInNeedOfRepair=function(e){APP.summoner.daemons.notifierRepair.diagnoseNotifier(function(t,i){i.action&&this.assign({notificationRepair:i.action}),e(!!this.assignments.notificationRepair)}.bind(this))},n._isNotificationsConfiguredForRemote=function(e){APP.notifier.subscriptions(function(i){var s={},n=!1;s.pushy=i.service.provider&&"email"!=i.service.provider,s.levels=[],t.each(i.subscriptions,function(e,i){t.each(e,function(e){var t=this.NOTIFICATION_CATEGORIES.indexOf(e);if(!(t<0)){var r=i==APP.bank.get(this.PREFIX+":notif:"+e);i<2&&!r&&(n=!0),s.levels[t]=[e,i]}},this)},this),n&&(s.levels=t.compact(s.levels),this.assign({notificationSettings:s})),e(!this.assignments.notificationSettings)}.bind(this))},n._saveNotificationLevels=function(){APP.notifier.subscriptions(function(e){t.each(e.subscriptions,function(e,i){t.each(e,function(e){var t=this.NOTIFICATION_CATEGORIES.indexOf(e);t<0||APP.bank.set(this.PREFIX+":notif:"+e,i<2?i:void 0)},this)},this)}.bind(this))},s}),define("app/views/interviews/tutorial/interview-tutorial-title-subscribe",["require","common","app/views/interviews/tutorial/interview-tutorial-title-unowned-notify-me","app/views/dialogs/dialog-tag-add","app/views/components/tags/tag-plank","app/views/popovers/popover-offline"],function(e){var t=e("common"),i=e("app/views/interviews/tutorial/interview-tutorial-title-unowned-notify-me"),s=i.new(),n=s.prototype,r=e("app/views/dialogs/dialog-tag-add"),o=e("app/views/components/tags/tag-plank"),a=e("app/views/popovers/popover-offline");return n.PURPOSE="notify-me-subscribe",n.PREFIX="tutorial-title-subscribe",n.NOTIFICATION_CATEGORIES=["notify-me-series"],n.commence=function(e){return APP.patron.magazines.isSubscribed(this.assignments.title)?"#promptToUnsubscribe":t.try(this.assignments.title,"series.isPeriodical")===!1?"#promptAsSpecial":"#promptToSubscribe"},n._promptAsSpecial=function(e){var t=this.assignments.title,i=this.assignments.library;e.say({label:"title.magazine.special.disclaimer",substitutions:{TITLE:t.titleWithoutOrphans()},enliven:{"#series-path":!1}}),e.say(this.PREFIX+".special"),e.response("mascot.next",function(){(new r).become(t,i).present()},"emph")},n._promptToSubscribe=n._introduceNotifyMe,n._promptToUnsubscribe=function(e){e.say(this.PREFIX+".unsubscribe"),e.construct("unsubscribe-controls",this._build("tutorial-title-unsubscribe"," button .shibui-button",{button:this._performUnsubscribeIfOnline.bind(this,e),label:this.PREFIX+".unsubscribe.action"}).root)},n._performUnsubscribeIfOnline=function(e,t){(new a).attempt(this._performUnsubscribe.bind(this,e),t.target)},n._performUnsubscribe=function(e){var t=e.dom.unsubscribeControls;t&&t.parentNode&&(t.parentNode.removeChild(t),e.spin()),this._defer("unsubscribe-request",function(){APP.patron.magazines.unsubscribe(this.assignments.title,this.thenYield("#youHaveUnsubscribed"),this.thenYield("#failedToUnsubscribe"))}.bind(this),300)},n._youHaveUnsubscribed=function(e){var i=0;t.each(this.assignments.unsubscribe,function(){i++}),e.say({label:"tutorial-title-subscribe.unsubscribed",substitutions:{TITLE:this.assignments.title.title,TAG_COUNT:i}}),e.construct("unsub-list",this._element({classes:"tutorial-title-unsubscribe-list tutorial-notify-me-tag-planks"})),t.each(this.assignments.unsubscribe,function(t,i){var s=APP.patron.tags.find({uuid:t});s&&new o(e.dom.unsubList).become(s,{titles:i})},this),e.response("mascot.done",this.thenYieldBack(),"emph")},n._failedToUnsubscribe=function(e){e.say(this.PREFIX+".unsubscribe.failure"),e.response("mascot.retry","#performUnsubscribe","emph")},s}),define("app/views/interviews/tutorial/interview-tutorial-title-unowned",["require","common","app/views/components/interviews/interview"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype;return n.commence=function(e){return"#explainWhatUnownedMeans"},n._explainWhatUnownedMeans=function(e){var i={LIBRARY_NAME:t.try(this.assignments.library,"safeName()")};e.say({label:"tutorial-title-unowned.explanation.1",substitutions:i}),e.say({label:"tutorial-title-unowned.explanation.2",substitutions:i})},s}),define("app/views/interviews/tutorial/interview-tutorial-browser-download",["require","common","app/views/components/interviews/interview"],function(e){var t=(e("common"),e("app/views/components/interviews/interview")),i=t.new(),s=i.prototype;return s.commence=function(e){return"#recommendNativeApps"},s._recommendNativeApps=function(e){e.characterize({mascot:"academy"}),e.say("tutorial-browser-download.explanation.1"),e.construct("store-badges",this._build("recommend-native-app-badges"," apple <img>",{src:APP.constants.filePath("images/app-store-badge-apple.svg")}," google <img>",{src:APP.constants.filePath("images/app-store-badge-google.svg")}).root)},i}),define("app/views/interviews/tutorial/interview-tutorial-deep-search-libraries",["require","common","app/views/components/interviews/interview"],function(e){var t=(e("common"),e("app/views/components/interviews/interview")),i=t.new(),s=i.prototype;return s.commence=function(e){return"#explainDeepSearch"},s._explainDeepSearch=function(e){e.characterize({mascot:"academy",semaphores:{appearance:"prompt","appearance-prompt-type":"feature"}}),e.say("tutorial-deep-search-libraries.1"),e.say("tutorial-deep-search-libraries.2"),e.answer({label:"mascot.ok",button:this._onTapOK.bind(this)}).emphasize().compact()},s._onTapOK=function(){APP.patron.dismiss("tutorial:deep-search-libraries"),this.yieldBack()},i}),define("app/views/interviews/tutorial/interview-tutorial-filter-cloud-editor",["require","common","app/views/components/interviews/interview"],function(e){var t=(e("common"),e("app/views/components/interviews/interview")),i=t.new(),s=i.prototype;return s.commence=function(e){return"#explainEditor"},s._explainEditor=function(e){e.characterize({mascot:"academy",semaphores:{appearance:"prompt","appearance-prompt-type":"feature"}}),this._element({graphic:"filter-cloud-editor",parentNode:e.say("tutorial-filter-cloud-editor.1"),pos:"prepend"}),e.say("tutorial-filter-cloud-editor.2"),e.say("tutorial-filter-cloud-editor.3"),e.answer({label:"mascot.ok",button:this._onTapOK.bind(this)}).emphasize().compact(),e.divider()},s._onTapOK=function(){APP.patron.dismiss("tutorial:filter-cloud-editor"),this.yieldBack()},i}),define("app/views/interviews/tutorial/interview-tutorial-kindle-returns",["require","common","app/views/components/interviews/interview","shibui/src/components/form-switch-toggle"],function(e){var t=(e("common"),e("app/views/components/interviews/interview")),i=t.new(),s=i.prototype,n=e("shibui/src/components/form-switch-toggle");return s.commence=function(e){return"#viaAmazon"},s._viaAmazon=function(e){e.say(["tutorial.kindle-returns.1","tutorial.kindle-returns.2"]),e.response("tutorial.kindle-returns.accept",this._fulfillWith.bind(this,e,"kindle"),"emph"),e.response("tutorial.kindle-returns.learn-more",APP.shell.bindOpenURL(APP.constants.URLS["help:kindle-returns"])),e.divider(),e.construct("toggle-dismiss",new n({label:"tutorial.kindle-returns.toggle.dismiss",classes:"is-right-aligned"}))},s._fulfillWith=function(e,t,i){e.dom.toggleDismiss.isOn()&&APP.patron.dismiss("tutorial:kindle-returns"),this.yieldBack({fulfillmentType:t,exitTarget:i.tappedElement})},i}),define("app/views/interviews/tutorial/interview-tutorial-footer-tags",["require","common","app/views/components/interviews/interview","shibui/src/components/form-switch-toggle"],function(e){var t=(e("common"),e("app/views/components/interviews/interview")),i=t.new(),s=i.prototype,n=e("shibui/src/components/form-switch-toggle");return s.commence=function(e){return"#thingsHaveMoved"},s._thingsHaveMoved=function(e){e.characterize({mascot:"academy"}),e.say("tutorial-footer-tags.instructions"),SPARK.locale.isEnglish&&(e.construct("toggle-nav-labels",new n({label:"settings.navigation.nav-bar.icon-labels",classes:"is-right-aligned"})),e.dom.toggleNavLabels.switch(!!APP.patron.choice("navigation:labels")),e.dom.toggleNavLabels.on("form:field:change",function(e){APP.patron.choose("navigation:labels",e.m.on)}))},i}),define("app/views/interviews/tutorial/interview-tutorial-notice-actions",["require","common","app/views/components/interviews/interview"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype;return n.commence=function(e){return this.assignments.notice?"#actionsForNotice":"#missingArgs"},n._actionsForNotice=function(e){var i=this.assignments.notice;e.construct("actions",this._element({tag:"ul",classes:"tutorial-notice-actions-list"})),t.each(i.actions||[{}],function(t,s){"view-journey"!=t.id&&this._element({button:function(){APP.notifier.performNotificationAction(i,t.id)}.bind(this),parentNode:this._element({tag:"li",parentNode:e.dom.actions}),label:i.labelAction(t.id).label})},this);var s=this._vanishTimeInWords();e.answer({label:s?"notice-actions.pin":"notice-actions.unpin",button:this._onTapPinNotice.bind(this)}).indicator({icon:s?"notif-pin":"notif-unpin"}).explanation({label:s?"notice-actions.pin.explanation":"notice-actions.unpin.explanation",substitutions:{VANISH_TIME:s?s:this._secondsToTimeInWords(this.assignments.notice.VANISH_DELAY_MS/1e3)}}).emphasize("turquoise"),e.answer({label:"notice-actions.dismiss",button:this._onTapDismissNotice.bind(this)}).indicator({icon:"notif-dismiss"}).explanation({label:"notice-actions.dismiss.explanation"}).emphasize("danger").stack()},n._onTapPinNotice=function(e){this.assignments.notice.toggleVanishing(),this.yieldBack()},n._onTapDismissNotice=function(e){this.assignments.notice.dismiss(),this.yieldBack()},n._vanishTimeInWords=function(){var e=this.assignments.notice.vanishAt;if("number"==typeof e){var i=Math.max(0,(e-t.epochMilliseconds())/1e3);return this._secondsToTimeInWords(i)}},n._secondsToTimeInWords=function(e){var i={label:"units.minutes"},s=t.secondsToUnits(e);return s.weeks&&(s.days+=7*s.weeks),s.days&&(s.hours+=24*s.days),s.hours?(s.minutes>30&&(s.hours+=1),i.label="units.hours",i.substitutions={N:s.hours}):s.minutes&&(s.seconds>30&&(s.minutes+=1),i.substitutions={N:s.minutes}),this._phrase(i)},s}),define("app/views/interviews/version/interview-version-features",["require","common","app/views/components/interviews/interview"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype;return n.commence=function(e){return"#"+APP.versionValet.LATEST_FEATURES_VERSION},n._configure=function(e,t){this.assignments.library=e.library||APP.library,this.parameters={next:t.next||this.assignments.next}},n["_16.0.0"]=function(e){e.spin();var t=this._exit.bind(this,this.parameters.next),i=APP.nav.go.bind(APP.nav,this.parameters.next||"");if(!APP.patron.cards.all.length)return t();if(!APP.network.reachable)return i();var s=APP.libraries.includingNow(APP.libraries.withCards()),n=function(){var e=s.shift();return e?void e.catalog.facets.freshen(function(t){var i=t.find({category:"format",value:"magazine"})[0];return i&&i.totalTitles?void this.yield("#16.0.0-magazines",{library:e}):n()}.bind(this),n):t()}.bind(this);n()},n["_16.0.0-magazines"]=function(e){this._classify(e.dom.root,"interview-version-features episode-dewey16_0_0"),e.say("version-features.16.intro");var t=this._build("version-feature"," figure",{access:"visual"},"  graphic",{graphic:"feature-one-tap-magazines"}," info","  head <strong> {version-features.16.one-tap-magazines.head}","  lede {version-features.16.one-tap-magazines.explain}");e.construct("feature-1",t.root),t=this._build("version-feature"," figure",{access:"visual"},"  graphic",{graphic:"feature-magazine-rack"}," info","  head <strong> {version-features.16.magazine-rack.head}","  lede {version-features.16.magazine-rack.explain}"),e.construct("feature-2",t.root),t=this._build("version-feature"," figure",{access:"visual"},"  graphic",{graphic:"feature-newsstand"}," info","  head <strong> {version-features.16.newsstand.head}","  lede {version-features.16.newsstand.explain}"),e.construct("feature-3",t.root),e.construct("newsstand-button",this._element({button:this._exit.bind(this,this.assignments.library.path("newsstand")),classes:"shibui-button",label:"version-features.16.newsstand.exit"})),e.construct("skip-button",this._element({button:this._exit.bind(this,this.parameters.next),classes:"version-features-exit",label:"mascot.skip"}))},n["_11.0.0"]=function(e){this._classify(e.dom.root,"interview-version-features episode-dewey11_0_0"),e.say("version-features.11.intro");var t=this._build("version-feature"," figure",{access:"visual"},"  graphic",{graphic:"feature-accessibility"}," info","  head <strong> {version-features.11.assistive-tech.head}","  lede {version-features.11.assistive-tech.explain}");e.construct("feature-1",t.root),t=this._build("version-feature"," figure",{access:"visual"},"  graphic",{graphic:"footer-menu-hamburger"}," info","  head <strong> {version-features.11.new-menu.head}","  lede {version-features.11.new-menu.explain}"),e.construct("feature-2",t.root),this._defer("lasso",this._lassoGraphic.bind(this,t.graphic),1e3),t=this._build("version-feature"," figure",{access:"visual"},"  graphic",{graphic:"feature-settings"}," info","  head <strong> {version-features.11.accessibility-features.head}","  lede {version-features.11.accessibility-features.explain}"),e.construct("feature-3",t.root),e.construct("continue-button",this._element({button:this._exit.bind(this,this.parameters.next),classes:"shibui-button",label:"version-features.continue"}))},n._lassoGraphic=function(e){if(t.isInDOM(e)){var i=this._element({icon:"encircle",parentNode:e.parentNode,classes:"version-feature-lasso"}),s={x:-6,y:-10,w:60,h:60},n=parseFloat(i.getAttribute("width")),r=parseFloat(i.getAttribute("height")),o=i.querySelector("path"),a=o.getAttribute("d"),l=s.w/n,c=s.h/r;i.style.setProperty("top",s.y+"px"),i.style.setProperty("left",s.x+"px"),i.setAttribute("width",s.w),i.setAttribute("height",s.h),i.setAttribute("viewBox","0 0 "+s.w+" "+s.h);var h=a.replace(/([\d\.]+),([\d\.]+)/g,function(e,t,i){return t=parseFloat(t),t-=n/2,t*=l,t+=s.w/2,i=parseFloat(i),i-=r/2,i*=c,i+=s.h/2,[t,i].join(",")});o.setAttribute("d",h);for(var u=o.getTotalLength(),p=i.querySelectorAll("use"),d=0;d<p.length;++d)p[d].setAttribute("xlink:href","#"+o.id),p[d].style.setProperty("transition","initial"),p[d].style.setProperty("stroke-dashoffset",u+"px"),p[d].style.setProperty("stroke-dasharray",u+"px"),setTimeout(function(){this.style.setProperty("stroke-dashoffset",0),this.style.setProperty("transition","stroke-dashoffset 1s ease-in-out 1s")}.bind(p[d]),200)}},n._exit=function(e){APP.versionValet.acknowledgeLatestFeatures(),APP.nav.go(e||"")},s}),define("app/views/interviews/version/interview-version-locale",["require","common","app/views/components/interviews/interview"],function(e){var t=(e("common"),e("app/views/components/interviews/interview")),i=t.new(),s=i.prototype;return s.commence=function(e){return"en-US"==SPARK.locale.tag?"shelf":"#greetNewLocale"},s._greetNewLocale=function(e){var t=APP.constants.LANGUAGE_ENDONYMS[SPARK.locale.tag];e.say({label:"version-locale.greet.1",substitutions:{LANGUAGE:t}}),e.say({label:"version-locale.greet.2",enliven:{"#configure-language":function(){var e={relaunchPath:"/"};APP.interviews.dialog("interview/configure/language",e).present()}}}),e.say({label:"version-locale.greet.3"}),e.answer({label:"version-locale.answer.revert-to-english",yield:"#revertToEnglish"}),e.answer({
html:t,button:this._continueToShelf.bind(this)}).emphasize(),e.construct("language-icon",this._element({graphic:"answer-contact",access:"visual",classes:"version-locale-language-icon"}))},s._continueToShelf=function(){APP.summoner.daemons.userLanguage.isUsingNewLocale=!1,APP.bank.set("app:i18n:delta",SPARK.locale.available),APP.nav.go("shelf")},s._revertToEnglish=function(e){e.say("version-locale.revert-to-english.1"),e.say("version-locale.revert-to-english.2"),e.answer({label:"version-locale.revert-to-english.relaunch",yield:"#commitToEnglish"}).emphasize()},s._commitToEnglish=function(e){e.spin(),APP.summoner.daemons.userLanguage.changeLanguageAndRelaunch("en-US","/")},i}),define("app/views/interviews/version/interview-version-upgrade",["require","common","app/views/components/interviews/interview","app/views/account/chip-code-input","app/views/about/flower-fountain"],function(e){var t=e("common"),i=e("app/views/components/interviews/interview"),s=i.new(),n=s.prototype,r=e("app/views/account/chip-code-input"),o=e("app/views/about/flower-fountain");return n.MAPPINGS={"update-required.generic":{episode:"#required"},"update-recommended.generic":{episode:"#recommended"},"incompatible.generic":{episode:"#incompatible"},"discontinued.generic":{episode:"#discontinued"},"discontinued.uwp":{episode:"#discontinueUWP"},"discontinued.kitkat":{episode:"#discontinueKitKat"},"discontinued.dst-root":{episode:"#discontinueDSTRoot"}},n.commence=function(e){var i=t.try(this.MAPPINGS[this.assignments.reason],"episode");return i?(this._sendReasonData(this.assignments.reason),i):"shelf"},n._required=function(e){e.say("app.version.update-required.generic.1"),e.say("app.version.update-required.generic.2"),e.answer({label:"app.version.exit.update."+this._appStoreType(),yield:"#exitToAppStore"}).emphasize(),APP.versionValet.entrap(this.assignments.reason)},n._recommended=function(e){e.say("app.version.update-recommended.generic.1"),e.say("app.version.update-recommended.generic.2"),e.answer({label:"app.version.exit.update."+this._appStoreType(),yield:"#exitToAppStore"}).emphasize(),e.answer({label:"app.version.exit.ask-later",link:"/"})},n._incompatible=function(e){e.say("app.version.incompatible.generic.1"),e.say("app.version.incompatible.generic.2");var t="https://browsehappy.com/?locale="+SPARK.locale.tag;e.answer({label:"app.version.exit.learn",yield:"#exitToURL",assign:{url:t}}).emphasize(),APP.versionValet.entrap(this.assignments.reason)},n._discontinued=function(e){e.say("app.version.discontinued.generic.1"),e.say("app.version.discontinued.generic.2"),this._episodeAnswerContinueInBrowser(e),APP.versionValet.entrap(this.assignments.reason)},n._discontinueUWP=function(e){e.say("app.version.discontinued.uwp.1"),e.say("app.version.discontinued.uwp.2"),this._episodeAnswerContinueInBrowser(e),APP.versionValet.entrap(this.assignments.reason)},n._discontinueKitKat=function(e){e.say("app.version.discontinued.kitkat.1"),e.say("app.version.discontinued.kitkat.2"),this._episodeAnswerContinueInBrowser(e),APP.versionValet.entrap(this.assignments.reason)},n._discontinueDSTRoot=function(e){e.say("app.version.discontinued.dst-root.1"),e.say("app.version.discontinued.dst-root.2"),e.say("app.version.discontinued.dst-root.3"),e.answer({label:"interview.configure-code-get",yield:"#enterCode"}).emphasize(),e.answer({label:"app.version.exit.ignore",button:this._escapeTrap.bind(this)}),APP.versionValet.entrap(this.assignments.reason)},n._enterCode=function(e){e.say("app.version.enter-setup-code");var t=e.construct("chip-code-input",new r);t.on("chip-code:bless",this.thenYield("#culDeSac")),t.configure({role:"primary"})},n._episodeAnswerContinueInBrowser=function(e,t){var i="#exitToURL",s=APP.constants.ROOT_URI;APP.patron.cards.all.length?(i="#exitToURLWithBlessing",s+="/interview/version/transfer"):t&&(s+="/interview/version/farewell?eol="+t),e.answer({label:"app.version.exit.browser",yield:i,assign:{url:s}}).emphasize()},n._exitToAppStore=function(e){var t=this._appStoreType();this.assign({url:APP.constants.URLS["upgrade:"+t]}),this._sendExitData("#exitToAppStore",{store:t}),this._exitToURL(e)},n._exitToURLWithBlessing=function(e){e.spin(),APP.sentry.get("auth/recovery/blessing",{},function(e){var i=this.assignments.url,s={blessing:e.blessing};this.yield("#exitToURL",{url:t.parameterizeURL(i,s)})}.bind(this),this.thenYield("#exitToURL")),this._sendExitData("#exitToURLWithBlessing",{url:this.assignments.url})},n._exitToURL=function(e,t){e.markAsRewritable();var i=this.assignments.url||APP.constants.ROOT_URI;APP.shell.openURL(i),this._sendExitData("#exitToURL",{url:i}),this._defer("close",this.thenYield("#culDeSac"),2e3)},n._culDeSac=function(e){e.construct("bouquet",this._element({html:"💐",classes:"version-upgrade-cul-de-sac-bouquet",button:function(e){new o(e.target),this.access(e.target,{disabled:!0}),APP.flags.override(APP.versionValet.OVERRIDE_FLAG,void 0)}.bind(this)})),e.construct("thanks",this._element({tag:"p",classes:"version-upgrade-cul-de-sac-thanks",label:"app.version.cul-de-sac.thanks"}))},n._appStoreType=function(){return{iOS:"apple",Android:"google"}[t.try(APP,"shell.info.platform")||"iOS"]},n._escapeTrap=function(){APP.versionValet.entrap(null),APP.nav.go(t.excise(APP.versionValet,"next")||"/")},n._sendReasonData=function(e){this._.sentReasonData||(APP.events.dispatch("investigate:record",t.absorb(this.options,{what:"upgrade prompt -- "+e,where:"interview/version/upgrade"})),this._.sentReasonData=!0)},n._sendExitData=function(e,i){this._.sentExitData||(i=t.absorb(i,{reason:this.assignments.reason}),APP.events.dispatch("investigate:record",t.absorb(i,{what:"upgrade choice -"+e,where:"interview/version/upgrade"})),this._.sentExitData=!0)},s}),define("app/views/interviews/version/interview-version-transfer",["require","common","app/views/components/interviews/interview","app/views/account/library-cards-list"],function(e){var t=(e("common"),e("app/views/components/interviews/interview")),i=t.new(),s=i.prototype;e("app/views/account/library-cards-list");return s.commence=function(e){return APP.patron.cards.all.length?"shelf":this.assignments.blessing?"#askPermission":"/"},s._configure=function(e,t){this.assign({blessing:e.blessing||t.blessing})},s._askPermission=function(e){e.say("app.version.transfer.permission"),e.answer({label:"mascot.yes",yield:"interview/authenticate/transfer",assign:{realm:APP.router.realm,blessing:this.assignments.blessing,callback:this._transferCallback.bind(this)}}).emphasize(),e.answer({label:"mascot.no",yield:"#permissionRefused"})},s._permissionRefused=function(){APP.nav.go("/"),APP.events.dispatch("investigate:record",{what:"upgrade transfer skipped",where:"InterviewVersionTransfer#permissionRefused"})},s._transferCallback=function(e){e.library?(APP.nav.go(e.library.path()),APP.events.dispatch("investigate:record",{what:"upgrade transfer complete",where:"InterviewVersionTransfer#transferComplete",cards:APP.patron.cards.all.length,loans:APP.patron.loans.all.length,holds:APP.patron.holds.all.length})):(APP.nav.go("/"),APP.events.dispatch("investigate:record",{what:"upgrade transfer failed",where:"InterviewVersionTransfer#transferFailure"}))},i}),define("app/views/interviews/version/interview-version-farewell",["require","common","app/views/components/interviews/interview"],function(e){var t=(e("common"),e("app/views/components/interviews/interview")),i=t.new(),s=i.prototype;return s.commence=function(e){return this.assignments.eol?"#bookmarkThisPage":"shelf"},s._configure=function(e,t){this.assignments.eol=t.eol},s._bookmarkThisPage=function(e){e.say("version-farewell.welcome"),e.say("version-farewell.bookmark"),e.answer({next:"#uninstallTheApp"}).emphasize()},s._uninstallTheApp=function(e){e.say("version-farewell.uninstall"),e.answer({label:"mascot.ok",link:"shelf"}).emphasize()},i}),define("app/views/interviews/interview-test",["require","common","app/views/components/interviews/interview"],function(e){var t=(e("common"),e("app/views/components/interviews/interview")),i=t.new(),s=i.prototype;return s.commence=function(e){return"#beginTest"},s._beginTest=function(e){e.say({html:"Let’s start the interview test."}),e.response({html:"#1: Assignment"},"#1assignment","emph"),e.response({html:"#2: Yield To Resolve"},"#2yieldToResolve","emph"),e.response({html:"#3: Yield To Robots"},"#3yieldToRobots","emph"),e.response({html:"#4: Resolve, Then Exit"},"#4resolveThenExit","emph")},s._1assignment=function(e){e.say({html:"Try passing an assignment."}),e.response({html:"Assign Cake"},this.thenYield("#assignedCake",{cake:"Lamingtons"}),"emph")},s._assignedCake=function(e){e.say({html:"Was the cake assigned?"}),this.assignments.cake?e.say({html:"Yes. <strong>"+this.assignments.cake+"</strong>."}):e.say({html:"No."}),e.response({html:"List of Tests"},"#beginTest","emph")},s._2yieldToResolve=function(e){e.say({html:"Try yielding to locate-library/resolve..."}),e.response({html:"Resolve libbyacademy"},this.thenYield("interview/locate-library/resolve",{parameters:{key:"libbyacademy"},callback:"#resolvedLibrary"}),"emph")},s._resolvedLibrary=function(e){e.say({html:"Did the library get resolved?"}),this.assignments.library?e.say({html:"Yes. <strong>"+this.assignments.library.safeName()+"</strong>."}):e.say({html:"No."}),e.response({html:"List of Tests"},"#beginTest","emph")},s._3yieldToRobots=function(e){e.say({html:"Try yielding to feedback/helpful-robots..."}),e.response({html:"Ask Helpful Robots"},this.thenYield("interview/feedback/helpful-robots",{category:"problem",submission:{},followUp:!1,callback:"#afterHelpfulRobots"}))},s._afterHelpfulRobots=function(e){e.say({html:"Successfully returned from helpful robots."}),e.say({html:"Robot rating: "+this.assignments.robotRating}),e.say({html:"Try going back to the first episode!"})},s._4resolveThenExit=function(e){e.say({html:"This button should exit to shelf immediately after resolving a library."}),e.response({html:"Resolve & Exit"},this.thenYield("interview/locate-library/resolve",{parameters:{key:"libbyacademy"},callback:"shelf"}),"emph")},i}),define("app/base/bosses/interviews",["require","common","app/views/dialogs/dialog-interview","app/views/interviews/interview-welcome","app/views/interviews/interview-menu","app/views/interviews/interview-ensure","app/views/interviews/authenticate/interview-authenticate-card","app/views/interviews/authenticate/interview-authenticate-verify-cards","app/views/interviews/authenticate/interview-authenticate-help","app/views/interviews/authenticate/interview-authenticate-back-up","app/views/interviews/authenticate/interview-authenticate-setup-code","app/views/interviews/authenticate/interview-authenticate-recover","app/views/interviews/authenticate/interview-authenticate-transfer","app/views/interviews/about/interview-about-legal","app/views/interviews/about/interview-about-technical","app/views/interviews/about/interview-about-whats-new","app/views/interviews/about/interview-about-updating","app/views/interviews/lectern/interview-lectern-updating","app/views/interviews/lectern/interview-lectern-error","app/views/interviews/locate-library/interview-locate-library-guess","app/views/interviews/locate-library/interview-locate-library-search","app/views/interviews/locate-library/interview-locate-library-map","app/views/interviews/locate-library/interview-locate-library-branches","app/views/interviews/locate-library/interview-locate-library-resolve","app/views/interviews/circ/interview-circ-prepare-title","app/views/interviews/circ/interview-circ-borrow-title","app/views/interviews/circ/interview-circ-hold-title","app/views/interviews/circ/interview-circ-open-extra","app/views/interviews/circ/interview-circ-fulfill-loan","app/views/interviews/circ/interview-circ-renew-loan","app/views/interviews/circ/interview-circ-return-loan","app/views/interviews/circ/interview-circ-hold-loan","app/views/interviews/circ/interview-circ-borrow-hold","app/views/interviews/circ/interview-circ-redeliver-hold","app/views/interviews/circ/interview-circ-suspend-hold","app/views/interviews/circ/interview-circ-cancel-hold","app/views/interviews/configure/interview-configure-accessibility","app/views/interviews/configure/interview-configure-cards","app/views/interviews/configure/interview-configure-downloads","app/views/interviews/configure/interview-configure-fulfillment","app/views/interviews/configure/interview-configure-language","app/views/interviews/configure/interview-configure-navigation","app/views/interviews/configure/interview-configure-notifications","app/views/interviews/configure/interview-configure-suspend-holds","app/views/interviews/configure/interview-configure-unsubscribe","app/views/interviews/configure/interview-configure-history-migrate","app/views/interviews/configure/interview-configure-tag-name","app/views/interviews/configure/interview-configure-tag-smarts","app/views/interviews/configure/interview-configure-tag-borrowed-import","app/views/interviews/configure/interview-configure-kindle-shill","app/views/interviews/feedback/interview-feedback-help","app/views/interviews/feedback/interview-feedback-library","app/views/interviews/feedback/interview-feedback-survey","app/views/interviews/feedback/interview-feedback-beta","app/views/interviews/feedback/interview-feedback-support","app/views/interviews/feedback/interview-feedback-helpful-robots","app/views/interviews/feedback/interview-feedback-present-error","app/views/interviews/feedback/interview-feedback-report-error","app/views/interviews/feedback/interview-feedback-submit-to-sage","app/views/interviews/status/interview-status-merged","app/views/interviews/status/interview-status-shelved","app/views/interviews/reset/interview-reset-chip-data","app/views/interviews/reset/interview-reset-steps","app/views/interviews/reset/interview-reset-libby","app/views/interviews/tutorial/interview-tutorial-what-are-tags","app/views/interviews/tutorial/interview-tutorial-creating-tags","app/views/interviews/tutorial/interview-tutorial-suggest-notifications","app/views/interviews/tutorial/interview-tutorial-title-language","app/views/interviews/tutorial/interview-tutorial-title-subscribe","app/views/interviews/tutorial/interview-tutorial-title-unowned","app/views/interviews/tutorial/interview-tutorial-title-unowned-notify-me","app/views/interviews/tutorial/interview-tutorial-browser-download","app/views/interviews/tutorial/interview-tutorial-deep-search-libraries","app/views/interviews/tutorial/interview-tutorial-filter-cloud-editor","app/views/interviews/tutorial/interview-tutorial-kindle-returns","app/views/interviews/tutorial/interview-tutorial-footer-tags","app/views/interviews/tutorial/interview-tutorial-notice-actions","app/views/interviews/version/interview-version-features","app/views/interviews/version/interview-version-locale","app/views/interviews/version/interview-version-upgrade","app/views/interviews/version/interview-version-transfer","app/views/interviews/version/interview-version-farewell","app/views/interviews/interview-test"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("app/views/dialogs/dialog-interview");return s.DIRECTORY={welcome:{root:function(){return!t.try(APP.router.waypoints,"interview.length")},footer:!1,view:e("app/views/interviews/interview-welcome")},menu:{root:!0,view:e("app/views/interviews/interview-menu")},ensure:{root:function(e,t){return!t.assignments.origination},realm:function(e,t){return e.waypoint.configure({origination:t.assignments.origination}),"transient"},view:e("app/views/interviews/interview-ensure")},authenticate:{card:{realm:function(e,t){return t.parameters.origination?(e.waypoint.configure({origination:t.parameters.origination}),"transient"):"interview"},view:e("app/views/interviews/authenticate/interview-authenticate-card")},"verify-cards":{view:e("app/views/interviews/authenticate/interview-authenticate-verify-cards")},help:{realm:function(e,t){return t.parameters.origination?(e.waypoint.configure({origination:t.parameters.origination}),"transient"):"interview"},view:e("app/views/interviews/authenticate/interview-authenticate-help")},"back-up":{view:e("app/views/interviews/authenticate/interview-authenticate-back-up")},"setup-code":{view:e("app/views/interviews/authenticate/interview-authenticate-setup-code")},recover:{view:e("app/views/interviews/authenticate/interview-authenticate-recover"),footer:!1},transfer:{view:e("app/views/interviews/authenticate/interview-authenticate-transfer"),footer:!1}},about:{legal:{view:e("app/views/interviews/about/interview-about-legal")},technical:{view:e("app/views/interviews/about/interview-about-technical")},"whats-new":{view:e("app/views/interviews/about/interview-about-whats-new")},updating:{view:e("app/views/interviews/about/interview-about-updating")}},lectern:{updating:{view:e("app/views/interviews/lectern/interview-lectern-updating")},error:{view:e("app/views/interviews/lectern/interview-lectern-error")}},"locate-library":{guess:{footer:!1,view:e("app/views/interviews/locate-library/interview-locate-library-guess")},search:{footer:!1,view:e("app/views/interviews/locate-library/interview-locate-library-search")},map:{footer:!1,view:e("app/views/interviews/locate-library/interview-locate-library-map")},branches:{footer:!1,view:e("app/views/interviews/locate-library/interview-locate-library-branches")},resolve:{root:function(e,t){return"transient"==(t.parameters.realm||APP.router.realm||"transient")},footer:function(e,t){return"transient"!=(t.parameters.realm||APP.router.realm||"transient")},realm:function(e,t){return t.parameters.realm||APP.router.realm||"transient"},view:e("app/views/interviews/locate-library/interview-locate-library-resolve")}},circ:{"prepare-title":{view:e("app/views/interviews/circ/interview-circ-prepare-title")},"borrow-title":{view:e("app/views/interviews/circ/interview-circ-borrow-title")},"hold-title":{view:e("app/views/interviews/circ/interview-circ-hold-title")},"open-extra":{view:e("app/views/interviews/circ/interview-circ-open-extra")},"fulfill-loan":{view:e("app/views/interviews/circ/interview-circ-fulfill-loan")},"renew-loan":{view:e("app/views/interviews/circ/interview-circ-renew-loan")},"return-loan":{view:e("app/views/interviews/circ/interview-circ-return-loan")},"hold-loan":{view:e("app/views/interviews/circ/interview-circ-hold-loan")},"borrow-hold":{view:e("app/views/interviews/circ/interview-circ-borrow-hold")},"redeliver-hold":{view:e("app/views/interviews/circ/interview-circ-redeliver-hold")},"suspend-hold":{view:e("app/views/interviews/circ/interview-circ-suspend-hold")},"cancel-hold":{view:e("app/views/interviews/circ/interview-circ-cancel-hold")}},configure:{accessibility:{view:e("app/views/interviews/configure/interview-configure-accessibility")},cards:{view:e("app/views/interviews/configure/interview-configure-cards")},downloads:{view:e("app/views/interviews/configure/interview-configure-downloads")},fulfillment:{view:e("app/views/interviews/configure/interview-configure-fulfillment")},language:{view:e("app/views/interviews/configure/interview-configure-language")},navigation:{view:e("app/views/interviews/configure/interview-configure-navigation")},notifications:{view:e("app/views/interviews/configure/interview-configure-notifications")},"suspend-holds":{view:e("app/views/interviews/configure/interview-configure-suspend-holds")},unsubscribe:{realm:"transient",view:e("app/views/interviews/configure/interview-configure-unsubscribe")},"history-migrate":{view:e("app/views/interviews/configure/interview-configure-history-migrate")},"tag-name":{view:e("app/views/interviews/configure/interview-configure-tag-name")},"tag-smarts":{view:e("app/views/interviews/configure/interview-configure-tag-smarts")},"tag-borrowed-import":{view:e("app/views/interviews/configure/interview-configure-tag-borrowed-import")},"kindle-shill":{view:e("app/views/interviews/configure/interview-configure-kindle-shill")}},feedback:{help:{view:e("app/views/interviews/feedback/interview-feedback-help")},library:{view:e("app/views/interviews/feedback/interview-feedback-library")},survey:{view:e("app/views/interviews/feedback/interview-feedback-survey")},beta:{view:e("app/views/interviews/feedback/interview-feedback-beta")},support:{view:e("app/views/interviews/feedback/interview-feedback-support")},"helpful-robots":{view:e("app/views/interviews/feedback/interview-feedback-helpful-robots")},"present-error":{view:e("app/views/interviews/feedback/interview-feedback-present-error")},"report-error":{view:e("app/views/interviews/feedback/interview-feedback-report-error")},"submit-to-sage":{view:e("app/views/interviews/feedback/interview-feedback-submit-to-sage")}},status:{merged:{realm:"status",root:!0,view:e("app/views/interviews/status/interview-status-merged")},shelved:{realm:"status",root:!0,view:e("app/views/interviews/status/interview-status-shelved")}},reset:{"chip-data":{root:!0,footer:!1,view:e("app/views/interviews/reset/interview-reset-chip-data")},steps:{view:e("app/views/interviews/reset/interview-reset-steps")},libby:{view:e("app/views/interviews/reset/interview-reset-libby")}},tutorial:{"what-are-tags":{view:e("app/views/interviews/tutorial/interview-tutorial-what-are-tags")},"creating-tags":{view:e("app/views/interviews/tutorial/interview-tutorial-creating-tags")},"suggest-notifications":{view:e("app/views/interviews/tutorial/interview-tutorial-suggest-notifications")},"title-language":{view:e("app/views/interviews/tutorial/interview-tutorial-title-language")},"title-subscribe":{view:e("app/views/interviews/tutorial/interview-tutorial-title-subscribe")},"title-unowned":{view:e("app/views/interviews/tutorial/interview-tutorial-title-unowned")},"title-unowned-notify-me":{view:e("app/views/interviews/tutorial/interview-tutorial-title-unowned-notify-me")},"browser-download":{view:e("app/views/interviews/tutorial/interview-tutorial-browser-download")},"deep-search-libraries":{view:e("app/views/interviews/tutorial/interview-tutorial-deep-search-libraries")},"filter-cloud-editor":{view:e("app/views/interviews/tutorial/interview-tutorial-filter-cloud-editor")},"kindle-returns":{view:e("app/views/interviews/tutorial/interview-tutorial-kindle-returns")},"footer-tags":{view:e("app/views/interviews/tutorial/interview-tutorial-footer-tags")},"notice-actions":{view:e("app/views/interviews/tutorial/interview-tutorial-notice-actions")}},version:{features:{realm:"transient",root:!0,footer:!1,label:"app.version.new-features",view:e("app/views/interviews/version/interview-version-features")},locale:{realm:"transient",root:!0,footer:!1,label:"app.version.new-locales",view:e("app/views/interviews/version/interview-version-locale")},upgrade:{realm:"transient",root:!0,footer:!1,label:function(e,t){return"app.version."+t.assignments.reason+".title"},view:e("app/views/interviews/version/interview-version-upgrade")},transfer:{realm:"transient",root:!0,footer:!1,label:"app.version.transfer-cards",view:e("app/views/interviews/version/interview-version-transfer")},farewell:{realm:"transient",root:!0,footer:!1,view:e("app/views/interviews/version/interview-version-farewell")}},test:{root:!0,view:e("app/views/interviews/interview-test")}},s.lookup=function(e){for(var t=this.DIRECTORY,i=e.split("/");i.length;)if(t=t[i.shift()],!t)return;if(t.view)return t},s.go=function(e,i,s){var n=this.path(e,s);return this.nextAssignments=t.absorb(i,{}),APP.nav.go(n)},s.path=function(e,i){0!==e.indexOf("interview/")&&APP.journal.warn('[INTERVIEWS] missing "interview/" path prefix?',arguments);var s=e.replace(/[^#]*/,""),n=e.replace(/#.*/,"");return t.parameterizeURL(n,i)+s},s.dialog=function(e,t,i){return(new n).become(e,t,i)},i}),define("app/base/traces/a11y",["require","common","gala"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("gala");return s.attach=function(e){this.handlers={},this.handlers.focus=n.on(document,"focusin",this._onElementFocus.bind(this),!0),document.documentElement.classList.add("trace-a11y")},s.detach=function(e){n.off(this.handlers.focus),document.documentElement.classList.remove("trace-a11y")},s.toggleHalos=function(){document.documentElement.classList.toggle("a11y-debug-halos")},s.toggleSpoken=function(){document.documentElement.classList.toggle("a11y-debug-spoken")},s._onElementFocus=function(e){var t=e.target;if(t){var i=this._ariaForTarget(t);i?i.document?console.log("[A11Y] focus => entered document"):i.label&&i.description?console.log('[A11Y] focus: "%s" ... "%s"',i.label,i.description):i.label?console.log('[A11Y] focus: "%s"',i.label):i.description&&APP.journal.warn('[A11Y] focus: missing label, but has description: "%s"',i.description,t):APP.journal.warn("[A11Y] focus not found",t,document.activeElement)}},s._ariaForTarget=function(e,i){if(e===document)return{document:!0};if(t.isElement(e)){var s,n,r={};if(r.label=e.getAttribute("aria-label"),r.label||(s=e.getAttribute("aria-labelledby"))&&(n=document.getElementById(s))&&(r.label=this._ariaForTarget(n).label),!r.label){r.label=[];var o=function(e){return t.isElement(e)?void(e.getAttribute("aria-hidden")&&!t.try(i,"desc")||t.each(e.childNodes,o)):r.label.push(e.nodeValue)};o(e),r.label=r.label.join(" ")}return r.label||(n=e.querySelector("img[alt]"))&&(r.label=n.getAttribute("alt")),r.label||t.try(i,"okIfMissing")||(r.label="missing-label: "+e.className),(s=e.getAttribute("aria-describedby"))&&(n=document.getElementById(s))&&(r.description=this._ariaForTarget(n,{okIfMissing:!0,desc:!0}).label),r.label&&(r.label=r.label.replace(/\s+/g," ")),r.description&&(r.description=r.description.replace(/\s+/g," ")),r}},i}),define("app/base/traces/phrasebook",["require","common","shibui/src/phrasebook"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype,n=e("shibui/src/phrasebook");return s.attach=function(e){var i=this.templates={};t.each(n.TEMPLATES,function(e,t){var s=this._keyHead(e);i[s]=i[s]||{},i[s][e]=0}.bind(this));var r=this._.superText=n.text;n.text=function(o,a,l){var c=n._normalizeLabel(o),h=s._keyHead(c),u=i[h]||{},p=u[c];"number"!=typeof p?(t.try(l,"okIfMissing")||APP.journal.warn("[PHRASEBOOK] unrecognized label:",h,c),i[h]=i[h]||{},i[h][c]=1):i[h][c]+=1;var d=r.call(n,o,a,l);return"string"==typeof d&&t.try(e,"transformations")&&!o.match(/^path\./)&&t.each(e.transformations,function(e){d=s._transformText(d,e)}),d}},s.detach=function(e){this._.superText&&(n.text=this._.superText),this.templates={}},s.audit=function(){t.each(this.templates,function(e,i){if("language"!=e&&"country"!=e&&"subjects"!=e){var s=!1;t.each(i,function(t,i){i||(s||(console.groupCollapsed(e),s=!0),console.log(t))}),s&&(s=!1,console.groupEnd(e))}},this)},s.locale=function(e){return localStorage.removeItem("SPARK:locale"),SPARK.locale.determine(),e&&SPARK.locale.tag!=e&&(localStorage.setItem("SPARK:locale",e),SPARK.locale.determine()),setTimeout(APP.relaunch.bind(APP),500),SPARK.locale.tag},s._keyHead=function(e){var t=e.split(".");return t.length>1?t[0]:"GLOBAL"},s._transformText=function(e,t){var i="_";if("enclose"==t)return"✓"+e+"✓";if("accent"==t||"emoji"==t){var s={accent:["À","Â","Ç","Ê","Ï","Ô","Š","Ý","á","ç","ê","ñ","ß","Д","Ж","Й","ф","Ю","诶","伊","艾","屁","维","プ"],emoji:["🥰","🤯","🥳","🤪","🤓","🎃","👩🏽","🧓🏾","👩‍👩‍👧‍👧","👖","🌏","🍪","🦜","🦚","🦔","🐝","🌚","🌀","💮","〽️","💠","⚜️","🀄️"]}[t];return e.replace(new RegExp(i,"g"),function(){return s[Math.floor(Math.random()*s.length)]})}if(parseFloat(t)){var n=parseFloat(t),r=e;try{var o=(new DOMParser).parseFromString(e,"text/html");r=o.body.textContent||r}catch(e){}var a=Math.round(n*r.length-r.length);if(a<0&&r==e)return e.slice(0,a);for(;a>0;)e+=i,a-=i.length;return e}return"string"==typeof t?e.split(i).join(t):e},i}),define("app/base/traces/ghost-authentication",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.attach=function(e){APP.events.off(this.handlers),this.handlers={onAuthFormsResult:APP.events.on("auth:forms:result",this._onAuthFormsResult)}},s.detach=function(e){APP.events.off(this.handlers)},s._onAuthFormsResult=function(e){var i=e.m.result;if(i.ghost){i.ghost.displayName=i.ghost.displayName||"Authenticate As Ghost",i.ghost.isGhost=!0,i.forms=i.forms||[];var s=!1;t.each(i.forms,function(e){e.ilsName==i.ghost.ilsName&&(e.displayName=e.displayName||i.ghost.displayName,e.isGhost=!0,s=!0,t.breakIteration())}),s||i.forms.push(i.ghost)}},i}),define("app/base/traces/notifier",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.TEMPLATES={"hold-borrowed":"Your hold at {{ libraryName }} has been borrowed for you automatically.","hold-lapsed":"Your hold at {{ libraryName }} has lapsed because it wasn’t borrowed in time.","hold-lapsing":"Your hold at {{ libraryName }} will lapse if you don’t borrow it soon.","hold-ready":"Your hold at {{ libraryName }} is ready for you to borrow!","hold-rescheduled":"Your hold has lapsed. We’ll try to deliver this {{ titleFormat }} one more time when the next person returns it.","loan-expired":"Your loan at {{ libraryName }} was returned automatically on its due date.","loan-expiring":"Your loan at {{ libraryName }} will be returned in a few days."},s.SUBTITLES={"hold-lapsing":"Hold running out","hold-rescheduled":"Delivering again later","loan-expired":"Returned","loan-expiring":"Due soon"},s.schedule=function(e,i,s){"number"!=typeof s&&(s=3);var n=new Date(t.epochMilliseconds()+1e3*s),r=t.try(APP.library,"websiteId");if(!r)return"ERROR: no active library";var o=APP.library.card(),a=t.try(o,"puid");if(!a)return"ERROR: no active card for this library";APP.titles.produce({titleId:i}).use(function(t,i){return i.title&&i.cover.color?void this._scheduleForTitle(i,e,r,a,n):i.reuse()},this);var l=["PUSH SCHEDULED. category: "+e,"titleId: "+i,"websiteId: "+r,"puid: "+a,"at: "+this._timeAndDate(n)].join(", ");return APP.journal.debug("[NOTIFIER]",l),l},s.dismiss=function(){for(var e=APP.notifier.notifications,t=e.all.length;e.all[0];)e.all[0].dismiss(),e.all[0].remove();var i="DISMISS ALL. count:"+t;return APP.journal.debug("[NOTIFIER]",i),i},s._scheduleForTitle=function(e,i,s,n,r){var o=t.capitalize(i).replace(/-/g," "),a={name:"notifier:schedule",dest:"shell",notification:{ms:this._millisecondsUntil(r),id:[o.split(" ")[0],n,e.titleId].join("-"),category:i,title:e.title,subtitle:this.SUBTITLES[i]||o,body:this._interpolateTemplate(i,e)},supplement:{websiteId:s,puid:n,titleId:e.titleId,titleFormat:e.format,coverImageURL:e.cover.url,coverColor:e.cover.color}};APP.shell.transmit(a)},s._interpolateTemplate=function(e,t){return this.TEMPLATES[e].replace(/{{ libraryName }}/,APP.library.safeName()).replace(/{{ titleFormat }}/,t.format)},s._millisecondsUntil=function(e){return Math.max(0,e.getTime()-t.epochMilliseconds())},s._timeAndDate=function(e){var i=t.timestampToUnits(e);return i.seconds=e.getSeconds(),[i.hours+":"+(i.minutes<10?"0":"")+i.minutes+":"+(i.seconds<10?"0":"")+i.seconds,i.date,i.monthName].join(" ").trim()},i}),define("app/base/traces/scribe-recordings",["require","common"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.attach=function(e){this.handlers&&APP.events.off(this.handlers),this.handlers={},this.handlers.record=APP.events.on("scribe:activity:record",this._onScribeActivityRecord.bind(this)),APP.scribe.isDispatchingRecordEvents=!0},s.detach=function(e){APP.events.off(this.handlers)},s._onScribeActivityRecord=function(e){var i=['📜 "%s" %s "%s" at "%s"',t.try(e,"m.activity.name"),"navigation:view"==t.try(e,"m.activity.name")?"to":"on",t.try(e,"m.view.title"),t.try(e,"m.view.path")],s=t.try(e,"m.activity.properties");s&&!t.isEmpty(s)&&i.push(s),APP.journal.info.apply(APP.journal,i)},i}),define("app/base/bosses/tracer",["require","common","app/base/traces/a11y","app/base/traces/phrasebook","app/base/traces/ghost-authentication","app/base/traces/notifier","app/base/traces/scribe-recordings"],function(e){var t=e("common"),i=t.Class.new(),s=i.prototype;return s.BANK_KEY_TRACES="testing:traces",s.TRACE_CLASSES=[e("app/base/traces/a11y"),e("app/base/traces/phrasebook"),e("app/base/traces/ghost-authentication"),e("app/base/traces/notifier"),e("app/base/traces/scribe-recordings")],
s.$init=function(){var e=APP.bank.get(this.BANK_KEY_TRACES)||{};t.each(e,function(e,t){this.attach.apply(this,[e].concat(t))},this),this._attachAutomaticTracesForEnvironment(),APP.events.on("debug:command",this._onDebugCommand.bind(this))},s.install=function(e){var t=this._shiftArguments(arguments);if(this._attachTrace(e,t)){var i=APP.bank.get(this.BANK_KEY_TRACES)||{};return i[e]=t,APP.bank.set(this.BANK_KEY_TRACES,i),"Installed: "+e}return"Error installing trace -- "+e},s.uninstall=function(e){var i=APP.bank.get(this.BANK_KEY_TRACES)||{};delete i[e];var s=!1;return t.each(i,function(){s=!0}),s||(i=void 0),APP.bank.set(this.BANK_KEY_TRACES,i),this.detach.apply(this,arguments),"Uninstalled: "+e},s.attach=function(e){var t=this._shiftArguments(arguments);return this.detach(e),this._attachTrace(e,t)?"Attached: "+e:"Error attaching trace -- "+e},s.detach=function(e){var t=this._shiftArguments(arguments);this[e]&&"function"==typeof this[e].detach&&this[e].detach.apply(this[e],t)},s.reset=function(){APP.bank.set(this.BANK_KEY_TRACES),APP.relaunch()},s._attachTrace=function(t,i){try{var s=e("app/base/traces/"+t);return this[t]=new s,"function"==typeof this[t].attach&&this[t].attach.apply(this[t],i),this[t]}catch(e){}},s._shiftArguments=function(e){return Array.prototype.slice.call(e,1)},s._attachAutomaticTracesForEnvironment=function(){var e={}[APP.constants.ENV];t.each(e,function(e){this[e]||this._attachTrace(e)},this)},s._onDebugCommand=function(e){if(!e.m.output){var t,i=(e.m.command||"").trim();(t=i.match(/^trace[:\s]+reset/i))?(e.m.output="[TRACER] reset all traces",this.reset()):(t=i.match(/^trace lote (on|off)\s*$/i))?"on"==t[1]?(e.m.output='[TRACER] enabling "phrasebook" with enclose transformations...',this.install("phrasebook",{transformations:["enclose"]}),APP.relaunch()):"off"==t[1]&&(e.m.output='[TRACER] disabling "phrasebook"...',this.uninstall("phrasebook"),APP.relaunch()):(t=i.match(/^trace[:\s]+([\w-]+)/i))&&(e.m.output="[TRACER] "+this.install(t[1]))}},i}),define("app/base/app",["require","common","app/base/version","app/base/constants","app/base/journal","app/base/shell/shell-chooser","app/base/err","app/base/flags","app/base/routing/historian","app/base/routing/router","app/base/routing/nav","app/base/server","app/base/services/services","app/base/bosses/investigator","app/base/bosses/network","app/base/bosses/version-valet","app/base/rosters/auditor","app/base/rosters/updater","app/models/collations/libraries","app/models/collations/titles","app/models/collations/journeys","app/base/bosses/patron","app/base/bosses/shelf-analyst","app/base/bosses/notifier","app/base/bosses/image-director","app/base/bosses/cover-guru","app/base/bosses/keyboard-focus","app/base/bosses/geolocator","app/base/bosses/summoner","app/base/bosses/sage","app/base/bosses/scribe","app/base/bosses/sentry","app/base/bosses/stasher","app/base/bosses/aide","app/base/bosses/orient","app/base/bosses/display-area","shibui/src/haptics","app/views/core/arena","app/base/bosses/lectern","app/base/bosses/interviews","shibui/src/phrasebook","app/base/bosses/tracer","gala"],function(require){var C=require("common"),CLASS=C.Class.new(),PROTO=CLASS.prototype,Version=require("app/base/version"),Constants=require("app/base/constants"),Journal=require("app/base/journal"),ShellChooser=require("app/base/shell/shell-chooser"),Err=require("app/base/err"),Flags=require("app/base/flags"),Historian=require("app/base/routing/historian"),Router=require("app/base/routing/router"),Nav=require("app/base/routing/nav"),Server=require("app/base/server"),Services=require("app/base/services/services"),Investigator=require("app/base/bosses/investigator"),Network=require("app/base/bosses/network"),VersionValet=require("app/base/bosses/version-valet"),Auditor=require("app/base/rosters/auditor"),Updater=require("app/base/rosters/updater"),Libraries=require("app/models/collations/libraries"),Titles=require("app/models/collations/titles"),Journeys=require("app/models/collations/journeys"),Patron=require("app/base/bosses/patron"),ShelfAnalyst=require("app/base/bosses/shelf-analyst"),Notifier=require("app/base/bosses/notifier"),ImageDirector=require("app/base/bosses/image-director"),CoverGuru=require("app/base/bosses/cover-guru"),KeyboardFocus=require("app/base/bosses/keyboard-focus"),Geolocator=require("app/base/bosses/geolocator"),Summoner=require("app/base/bosses/summoner"),Sage=require("app/base/bosses/sage"),Scribe=require("app/base/bosses/scribe"),Sentry=require("app/base/bosses/sentry"),Stasher=require("app/base/bosses/stasher"),Aide=require("app/base/bosses/aide"),Orient=require("app/base/bosses/orient"),DisplayArea=require("app/base/bosses/display-area"),Haptics=require("shibui/src/haptics"),Arena=require("app/views/core/arena"),Lectern=require("app/base/bosses/lectern"),Interviews=require("app/base/bosses/interviews"),Phrasebook=require("shibui/src/phrasebook"),Tracer=require("app/base/bosses/tracer");return PROTO.events=require("gala"),PROTO.client={name:"dewey",info:{spec:24}},PROTO.noop=function(){},PROTO.start=function(){var e=document.querySelector("#SPARK-style-canary");return e&&e.offsetWidth?SPARK.onResourceError(e):(e&&e.parentNode.removeChild(e),this._redirectForSomeReason()?SPARK.handleReady():(window.onerror=this._onAppError.bind(this),this.semaphore=C.DataClass.semaphore(document.documentElement),this.freshHorizon=0,this._preparePhrasebook(),void this._prepareBosses()))},PROTO.refresh=function(e){"ready"==this.semaphore.get("client")&&(this.freshHorizon=C.epochMilliseconds(),this.events.dispatch("app:refresh",{realms:e},!0)&&APP.router.rebuild(e))},PROTO.relaunch=function(e){C.try(this.shell,"transmit()","audioproxy:pause"),C.try(this.lectern,"close()"),this.semaphore.set("client","unloading"),this.arena.splash(!0),C.defer(this,"relaunch",function(){e=e||location.pathname.replace(/^\//,""),localStorage.setItem("SPARK:relaunch:path",e),location.href="/"}.bind(this),750)},PROTO.err=function(e,t){return new Err(e,t)},PROTO.$=function(cmd,outputCallback){"function"!=typeof outputCallback&&(outputCallback=function(e){APP.journal.info("[$] <=",e)});var match;if(match=cmd.match(/^error:?\s*(.*)/i)){var errorText=match[1].trim()||"Test error";throw outputCallback("THROWING: "+errorText),errorText}if(match=cmd.match(/^(re|relaunch)$/i))outputCallback("RELAUNCH"),this.nav.go("interview/menu"),this.relaunch();else if(match=cmd.match(/^(diag|diagnostics)$/i))this.shell.has("debug:diagnostics-option")?(outputCallback("SHELL DIAGNOSTICS"),this.shell.transmit("diagnostics:show")):outputCallback("NO SUCH CAPABILITY: debug:diagnostics-option");else if(match=cmd.match(/^(dark|bright)$/i))outputCallback("LIGHTING: "+cmd),this.aide.setLighting(cmd.toLowerCase());else if(match=cmd.match(/^meet$/))outputCallback("MEET"),this.nav.go("interview/welcome");else if("setup-code"==cmd)APP.sentry.get("chip/clone/code",{role:"primary"},function(e){outputCallback(e.code)},function(){outputCallback("SETUP-CODE: failure")});else{var evtData={command:cmd,output:""};if(this.events.dispatch("debug:command",evtData),evtData.output)outputCallback(evtData.output);else try{outputCallback(eval(cmd))}catch(e){APP.journal.warn("[$] EVAL ERROR:",e),outputCallback("UNKNOWN COMMAND")}}},PROTO._onAppError=function(e,t,i,s,n){var r={errorMessage:e};if(n&&n.stack?r.errorSource=n.stack:!r.source&&t&&(r.errorSource=t+(i?":"+i:"")),"ready"==this.semaphore.get("client"))this.err("unexpected-problem",r).sendToSage().present();else{if(window.location.href.match(/dv.io/))throw n;setTimeout(this._onLaunchError.bind(this,r),2e3)}},PROTO._onLaunchError=function(e){"ready"==this.semaphore.get("client")?(this._revealClientContext(),this.err("launch-failure",e).sendToSage().present()):SPARK.onScriptError(e.errorMessage,e.errorSource)},PROTO._preparePhrasebook=function(){Phrasebook.initialize(SPARK.locale.tag,SPARK.locale.translations)},PROTO._prepareBosses=function(){this._boss("investigator",new Investigator),this._boss("constants",new Constants),this._boss("journal",new Journal),this.client.info.version=new Version,this.client.info.version.assign(this.constants.VERSION_NUMBER),this._boss("server",new Server),this._boss("services",new Services),this._boss("network",new Network),this._boss("historian",new Historian),this._boss("router",new Router),this._boss("nav",new Nav),this._boss("shell",ShellChooser.select()),this.shell.start(this._onShellStarted.bind(this))},PROTO._onShellStarted=function(e){this.shell.transmit("client:view:reveal"),this._boss("bank",e),this._boss("flags",new Flags),this._boss("summoner",new Summoner),this._boss("sage",new Sage),this._boss("scribe",new Scribe),this._boss("sentry",new Sentry),this._boss("stasher",new Stasher),this._boss("aide",new Aide),this._boss("orient",new Orient),this._boss("displayArea",new DisplayArea(this.shell)),this._boss("notifier",new Notifier),this._boss("libraries",new Libraries,function(e){e.load()}),this._boss("titles",new Titles,function(e){e.load()}),this._boss("journeys",new Journeys,function(e){e.load()}),this._boss("patron",new Patron,function(e){e.load()}),this._boss("shelfAnalyst",new ShelfAnalyst),this._boss("versionValet",new VersionValet),this._boss("auditor",new Auditor),this._boss("updater",new Updater),this._boss("imageDirector",new ImageDirector),this._boss("coverGuru",new CoverGuru),this._boss("keyboardFocus",new KeyboardFocus),this._boss("geolocator",new Geolocator),this._boss("haptics",Haptics.attach(this.shell)),this._boss("interviews",new Interviews),this._boss("tracer",new Tracer),this._boss("arena",new Arena,function(e){e.impart(document.body)}),this._boss("lectern",new Lectern),this.sentry.identity&&this.sentry.acquireChip(),this.libraries.restore(),this.titles.restore(),this.router.start(),this.shell.releaseBacklog(),setTimeout(this._announceReady.bind(this),0)},PROTO._announceReady=function(){this.events.dispatch("environment:ready"),this.shell.transmit("environment:ready"),APP.events.on("msg:environment:ready?",this.shell.transmit.bind(this.shell,"environment:ready")),this.scribe.record("app:ready"),this._revealClientContext()},PROTO._revealClientContext=function(){var e=function(){this.events.off(t),clearTimeout(i),this.semaphore.set("client","ready"),this.arena.splash(!1)}.bind(this),t=this.events.on("router:navigate",function(){clearTimeout(i),i=setTimeout(e,400)}),i=setTimeout(e,200)},PROTO._redirectForSomeReason=function(){if(navigator.userAgent.match(/Chrome\/30\..*Dewey/))return location.href=APP.constants.STATUS_URI+"/news/kitkat","sunset:kitkat";try{Intl.getCanonicalLocales("en-us")}catch(e){return location.href=APP.constants.STATUS_URI+"/news/kitkat","sunset:kitkat"}},PROTO._boss=function(e,t,i){this[e]=t,"function"==typeof i&&i(t),APP.events.dispatch("app:boss:"+e,t)},CLASS}),require(["app/base/app"],function(e){window.require=require,window.APP=new e,window.onload=APP.start.bind(APP);var t=document.readyState;"complete"!=t&&"loaded"!=t&&"interactive"!=t||(window.onload(),window.onload=null)}),define("app",["app/main"],function(e){return e}),define("app/main",function(){})}();